var cC=Object.defineProperty;var uC=(l,o,u)=>o in l?cC(l,o,{enumerable:!0,configurable:!0,writable:!0,value:u}):l[o]=u;var Ft=(l,o,u)=>(uC(l,typeof o!="symbol"?o+"":o,u),u);(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const g of document.querySelectorAll('link[rel="modulepreload"]'))m(g);new MutationObserver(g=>{for(const b of g)if(b.type==="childList")for(const M of b.addedNodes)M.tagName==="LINK"&&M.rel==="modulepreload"&&m(M)}).observe(document,{childList:!0,subtree:!0});function u(g){const b={};return g.integrity&&(b.integrity=g.integrity),g.referrerPolicy&&(b.referrerPolicy=g.referrerPolicy),g.crossOrigin==="use-credentials"?b.credentials="include":g.crossOrigin==="anonymous"?b.credentials="omit":b.credentials="same-origin",b}function m(g){if(g.ep)return;g.ep=!0;const b=u(g);fetch(g.href,b)}})();function Cs(){}const $0=l=>l;function hC(l,o){for(const u in o)l[u]=o[u];return l}function XT(l){return l()}function G1(){return Object.create(null)}function yh(l){l.forEach(XT)}function $_(l){return typeof l=="function"}function Y_(l,o){return l!=l?o==o:l!==o||l&&typeof l=="object"||typeof l=="function"}function dC(l){return Object.keys(l).length===0}function W1(l,o,u,m){if(l){const g=KT(l,o,u,m);return l[0](g)}}function KT(l,o,u,m){return l[1]&&m?hC(u.ctx.slice(),l[1](m(o))):u.ctx}function q1(l,o,u,m){if(l[2]&&m){const g=l[2](m(u));if(o.dirty===void 0)return g;if(typeof g=="object"){const b=[],M=Math.max(o.dirty.length,g.length);for(let A=0;A<M;A+=1)b[A]=o.dirty[A]|g[A];return b}return o.dirty|g}return o.dirty}function H1(l,o,u,m,g,b){if(g){const M=KT(o,u,m,b);l.p(M,g)}}function Z1(l){if(l.ctx.length>32){const o=[],u=l.ctx.length/32;for(let m=0;m<u;m++)o[m]=-1;return o}return-1}const JT=typeof window<"u";let eM=JT?()=>window.performance.now():()=>Date.now(),Y0=JT?l=>requestAnimationFrame(l):Cs;const oh=new Set;function tM(l){oh.forEach(o=>{o.c(l)||(oh.delete(o),o.f())}),oh.size!==0&&Y0(tM)}function iM(l){let o;return oh.size===0&&Y0(tM),{promise:new Promise(u=>{oh.add(o={c:l,f:u})}),abort(){oh.delete(o)}}}const fC=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function Vi(l,o){l.appendChild(o)}function nM(l){if(!l)return document;const o=l.getRootNode?l.getRootNode():l.ownerDocument;return o&&o.host?o:l.ownerDocument}function pC(l){const o=on("style");return o.textContent="/* empty */",mC(nM(l),o),o.sheet}function mC(l,o){return Vi(l.head||l,o),o.sheet}function Po(l,o,u){l.insertBefore(o,u||null)}function hs(l){l.parentNode&&l.parentNode.removeChild(l)}function _C(l,o){for(let u=0;u<l.length;u+=1)l[u]&&l[u].d(o)}function on(l){return document.createElement(l)}function gC(l){return document.createTextNode(l)}function Lr(){return gC(" ")}function If(l,o,u,m){return l.addEventListener(o,u,m),()=>l.removeEventListener(o,u,m)}function Sn(l,o,u){u==null?l.removeAttribute(o):l.getAttribute(o)!==u&&l.setAttribute(o,u)}function eh(l,o,u){const m=o.toLowerCase();m in l?l[m]=typeof l[m]=="boolean"&&u===""?!0:u:o in l?l[o]=typeof l[o]=="boolean"&&u===""?!0:u:Sn(l,o,u)}function yC(l){return Array.from(l.childNodes)}function $1(l,o,u,m){u==null?l.style.removeProperty(o):l.style.setProperty(o,u,"")}let Km;function xC(){if(Km===void 0){Km=!1;try{typeof window<"u"&&window.parent&&window.parent.document}catch{Km=!0}}return Km}function vC(l,o){getComputedStyle(l).position==="static"&&(l.style.position="relative");const m=on("iframe");m.setAttribute("style","display: block; position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; border: 0; opacity: 0; pointer-events: none; z-index: -1;"),m.setAttribute("aria-hidden","true"),m.tabIndex=-1;const g=xC();let b;return g?(m.src="data:text/html,<script>onresize=function(){parent.postMessage(0,'*')}<\/script>",b=If(window,"message",M=>{M.source===m.contentWindow&&o()})):(m.src="about:blank",m.onload=()=>{b=If(m.contentWindow,"resize",o),o()}),Vi(l,m),()=>{(g||b&&m.contentWindow)&&b(),hs(m)}}function bC(l,o,u){l.classList.toggle(o,!!u)}function wC(l,o,{bubbles:u=!1,cancelable:m=!1}={}){return new CustomEvent(l,{detail:o,bubbles:u,cancelable:m})}const C_=new Map;let P_=0;function TC(l){let o=5381,u=l.length;for(;u--;)o=(o<<5)-o^l.charCodeAt(u);return o>>>0}function MC(l,o){const u={stylesheet:pC(o),rules:{}};return C_.set(l,u),u}function rM(l,o,u,m,g,b,M,A=0){const r=16.666/m;let k=`{
`;for(let de=0;de<=1;de+=r){const ve=o+(u-o)*b(de);k+=de*100+`%{${M(ve,1-ve)}}
`}const F=k+`100% {${M(u,1-u)}}
}`,N=`__svelte_${TC(F)}_${A}`,W=nM(l),{stylesheet:Q,rules:te}=C_.get(W)||MC(W,l);te[N]||(te[N]=!0,Q.insertRule(`@keyframes ${N} ${F}`,Q.cssRules.length));const ce=l.style.animation||"";return l.style.animation=`${ce?`${ce}, `:""}${N} ${m}ms linear ${g}ms 1 both`,P_+=1,N}function T0(l,o){const u=(l.style.animation||"").split(", "),m=u.filter(o?b=>b.indexOf(o)<0:b=>b.indexOf("__svelte")===-1),g=u.length-m.length;g&&(l.style.animation=m.join(", "),P_-=g,P_||SC())}function SC(){Y0(()=>{P_||(C_.forEach(l=>{const{ownerNode:o}=l.stylesheet;o&&hs(o)}),C_.clear())})}let Cf;function bf(l){Cf=l}function EC(){if(!Cf)throw new Error("Function called outside component initialization");return Cf}function Q0(l){EC().$$.on_mount.push(l)}const sh=[],ls=[];let ah=[];const M0=[],AC=Promise.resolve();let S0=!1;function IC(){S0||(S0=!0,AC.then(sM))}function da(l){ah.push(l)}function ef(l){M0.push(l)}const e0=new Set;let th=0;function sM(){if(th!==0)return;const l=Cf;do{try{for(;th<sh.length;){const o=sh[th];th++,bf(o),CC(o.$$)}}catch(o){throw sh.length=0,th=0,o}for(bf(null),sh.length=0,th=0;ls.length;)ls.pop()();for(let o=0;o<ah.length;o+=1){const u=ah[o];e0.has(u)||(e0.add(u),u())}ah.length=0}while(sh.length);for(;M0.length;)M0.pop()();S0=!1,e0.clear(),bf(l)}function CC(l){if(l.fragment!==null){l.update(),yh(l.before_update);const o=l.dirty;l.dirty=[-1],l.fragment&&l.fragment.p(l.ctx,o),l.after_update.forEach(da)}}function PC(l){const o=[],u=[];ah.forEach(m=>l.indexOf(m)===-1?o.push(m):u.push(m)),u.forEach(m=>m()),ah=o}let tf;function oM(){return tf||(tf=Promise.resolve(),tf.then(()=>{tf=null})),tf}function D_(l,o,u){l.dispatchEvent(wC(`${o?"intro":"outro"}${u}`))}const y_=new Set;let nl;function aM(){nl={r:0,c:[],p:nl}}function lM(){nl.r||yh(nl.c),nl=nl.p}function Ps(l,o){l&&l.i&&(y_.delete(l),l.i(o))}function lo(l,o,u,m){if(l&&l.o){if(y_.has(l))return;y_.add(l),nl.c.push(()=>{y_.delete(l),m&&(u&&l.d(1),m())}),l.o(o)}else m&&m()}const cM={duration:0};function uM(l,o,u){const m={direction:"in"};let g=o(l,u,m),b=!1,M,A,r=0;function k(){M&&T0(l,M)}function F(){const{delay:W=0,duration:Q=300,easing:te=$0,tick:ce=Cs,css:de}=g||cM;de&&(M=rM(l,0,1,Q,W,te,de,r++)),ce(0,1);const ve=eM()+W,Te=ve+Q;A&&A.abort(),b=!0,da(()=>D_(l,!0,"start")),A=iM(Ee=>{if(b){if(Ee>=Te)return ce(1,0),D_(l,!0,"end"),k(),b=!1;if(Ee>=ve){const Me=te((Ee-ve)/Q);ce(Me,1-Me)}}return b})}let N=!1;return{start(){N||(N=!0,T0(l),$_(g)?(g=g(m),oM().then(F)):F())},invalidate(){N=!1},end(){b&&(k(),b=!1)}}}function hM(l,o,u){const m={direction:"out"};let g=o(l,u,m),b=!0,M;const A=nl;A.r+=1;let r;function k(){const{delay:F=0,duration:N=300,easing:W=$0,tick:Q=Cs,css:te}=g||cM;te&&(M=rM(l,1,0,N,F,W,te));const ce=eM()+F,de=ce+N;da(()=>D_(l,!1,"start")),"inert"in l&&(r=l.inert,l.inert=!0),iM(ve=>{if(b){if(ve>=de)return Q(0,1),D_(l,!1,"end"),--A.r||yh(A.c),!1;if(ve>=ce){const Te=W((ve-ce)/N);Q(1-Te,Te)}}return b})}return $_(g)?oM().then(()=>{g=g(m),k()}):k(),{end(F){F&&"inert"in l&&(l.inert=r),F&&g.tick&&g.tick(1,0),b&&(M&&T0(l,M),b=!1)}}}function Y1(l){return(l==null?void 0:l.length)!==void 0?l:Array.from(l)}function nf(l,o,u){const m=l.$$.props[o];m!==void 0&&(l.$$.bound[m]=u,u(l.$$.ctx[m]))}function wf(l){l&&l.c()}function lh(l,o,u){const{fragment:m,after_update:g}=l.$$;m&&m.m(o,u),da(()=>{const b=l.$$.on_mount.map(XT).filter($_);l.$$.on_destroy?l.$$.on_destroy.push(...b):yh(b),l.$$.on_mount=[]}),g.forEach(da)}function ch(l,o){const u=l.$$;u.fragment!==null&&(PC(u.after_update),yh(u.on_destroy),u.fragment&&u.fragment.d(o),u.on_destroy=u.fragment=null,u.ctx=[])}function DC(l,o){l.$$.dirty[0]===-1&&(sh.push(l),IC(),l.$$.dirty.fill(0)),l.$$.dirty[o/31|0]|=1<<o%31}function Q_(l,o,u,m,g,b,M=null,A=[-1]){const r=Cf;bf(l);const k=l.$$={fragment:null,ctx:[],props:b,update:Cs,not_equal:g,bound:G1(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(o.context||(r?r.$$.context:[])),callbacks:G1(),dirty:A,skip_bound:!1,root:o.target||r.$$.root};M&&M(k.root);let F=!1;if(k.ctx=u?u(l,o.props||{},(N,W,...Q)=>{const te=Q.length?Q[0]:W;return k.ctx&&g(k.ctx[N],k.ctx[N]=te)&&(!k.skip_bound&&k.bound[N]&&k.bound[N](te),F&&DC(l,N)),W}):[],k.update(),F=!0,yh(k.before_update),k.fragment=m?m(k.ctx):!1,o.target){if(o.hydrate){const N=yC(o.target);k.fragment&&k.fragment.l(N),N.forEach(hs)}else k.fragment&&k.fragment.c();o.intro&&Ps(l.$$.fragment),lh(l,o.target,o.anchor),sM()}bf(r)}class X_{constructor(){Ft(this,"$$");Ft(this,"$$set")}$destroy(){ch(this,1),this.$destroy=Cs}$on(o,u){if(!$_(u))return Cs;const m=this.$$.callbacks[o]||(this.$$.callbacks[o]=[]);return m.push(u),()=>{const g=m.indexOf(u);g!==-1&&m.splice(g,1)}}$set(o){this.$$set&&!dC(o)&&(this.$$.skip_bound=!0,this.$$set(o),this.$$.skip_bound=!1)}}const kC="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(kC);const{window:dM}=fC,RC=l=>({}),Q1=l=>({}),zC=l=>({}),X1=l=>({});function LC(l){let o,u,m,g,b,M,A,r,k;da(l[21]);const F=l[20].background,N=W1(F,l,l[19],X1),W=l[20].foreground,Q=W1(W,l,l[19],Q1);return{c(){o=on("svelte-scroller-outer"),u=on("svelte-scroller-background-container"),m=on("svelte-scroller-background"),N&&N.c(),b=Lr(),M=on("svelte-scroller-foreground"),Q&&Q.c(),eh(m,"class","svelte-xdbafy"),eh(u,"class","background-container svelte-xdbafy"),eh(u,"style",g=""+(l[5]+l[4])),eh(M,"class","svelte-xdbafy"),eh(o,"class","svelte-xdbafy")},m(te,ce){Po(te,o,ce),Vi(o,u),Vi(u,m),N&&N.m(m,null),l[22](m),Vi(o,b),Vi(o,M),Q&&Q.m(M,null),l[23](M),l[24](o),A=!0,r||(k=If(dM,"resize",l[21]),r=!0)},p(te,ce){N&&N.p&&(!A||ce[0]&524288)&&H1(N,F,te,te[19],A?q1(F,te[19],ce,zC):Z1(te[19]),X1),(!A||ce[0]&48&&g!==(g=""+(te[5]+te[4])))&&eh(u,"style",g),Q&&Q.p&&(!A||ce[0]&524288)&&H1(Q,W,te,te[19],A?q1(W,te[19],ce,RC):Z1(te[19]),Q1)},i(te){A||(Ps(N,te),Ps(Q,te),A=!0)},o(te){lo(N,te),lo(Q,te),A=!1},d(te){te&&hs(o),N&&N.d(te),l[22](null),Q&&Q.d(te),l[23](null),l[24](null),r=!1,k()}}}const Eo=[];let k_;if(typeof window<"u"){const l=()=>Eo.forEach(o=>o());window.addEventListener("scroll",l),window.addEventListener("resize",l)}if(typeof IntersectionObserver<"u"){const l=new Map,o=new IntersectionObserver((u,m)=>{u.forEach(g=>{const b=l.get(g.target),M=Eo.indexOf(b);g.isIntersecting?M===-1&&Eo.push(b):(b(),M!==-1&&Eo.splice(M,1))})},{rootMargin:"400px 0px"});k_={add:({outer:u,update:m})=>{const{top:g,bottom:b}=u.getBoundingClientRect();g<window.innerHeight&&b>0&&Eo.push(m),l.set(u,m),o.observe(u)},remove:({outer:u,update:m})=>{const g=Eo.indexOf(m);g!==-1&&Eo.splice(g,1),l.delete(u),o.unobserve(u)}}}else k_={add:({update:l})=>{Eo.push(l)},remove:({update:l})=>{const o=Eo.indexOf(l);o!==-1&&Eo.splice(o,1)}};function OC(l,o,u){let m,g,b,M,A,{$$slots:r={},$$scope:k}=o,{top:F=0}=o,{bottom:N=1}=o,{threshold:W=.5}=o,{query:Q="section"}=o,{parallax:te=!1}=o,{index:ce=0}=o,{count:de=0}=o,{offset:ve=0}=o,{progress:Te=0}=o,{visible:Ee=!1}=o,Me,Ie,qe,Ve,nt,lt=0,ht,st=0,Ot=1;Q0(()=>{nt=Ie.querySelectorAll(Q),u(7,de=nt.length),oi();const Bt={outer:Me,update:oi};return k_.add(Bt),()=>k_.remove(Bt)});function oi(){if(!Ie)return;const Bt=Me.getBoundingClientRect();Ve=Bt.left,u(18,Ot=Bt.right-Ve);const fi=Ie.getBoundingClientRect(),Cn=qe.getBoundingClientRect();u(10,Ee=fi.top<lt&&fi.bottom>0);const _n=fi.bottom-fi.top,Kt=Cn.bottom-Cn.top,gn=g-m;u(9,Te=(m-fi.top)/(_n-gn)),Te<=0?(u(17,st=0),u(16,ht=!1)):Te>=1?(u(17,st=te?_n-Kt:_n-gn),u(16,ht=!1)):(u(17,st=te?Math.round(m-Te*(Kt-gn)):m),u(16,ht=!0));for(let ji=0;ji<nt.length;ji++){const On=nt[ji],{top:Zn}=On.getBoundingClientRect(),pr=nt[ji+1],Vt=pr?pr.getBoundingClientRect().top:fi.bottom;if(u(8,ve=(b-Zn)/(Vt-Zn)),Vt>=b){u(6,ce=ji);break}}}function ii(){u(0,lt=dM.innerHeight)}function Xe(Bt){ls[Bt?"unshift":"push"](()=>{qe=Bt,u(3,qe)})}function wt(Bt){ls[Bt?"unshift":"push"](()=>{Ie=Bt,u(2,Ie)})}function di(Bt){ls[Bt?"unshift":"push"](()=>{Me=Bt,u(1,Me)})}return l.$$set=Bt=>{"top"in Bt&&u(11,F=Bt.top),"bottom"in Bt&&u(12,N=Bt.bottom),"threshold"in Bt&&u(13,W=Bt.threshold),"query"in Bt&&u(14,Q=Bt.query),"parallax"in Bt&&u(15,te=Bt.parallax),"index"in Bt&&u(6,ce=Bt.index),"count"in Bt&&u(7,de=Bt.count),"offset"in Bt&&u(8,ve=Bt.offset),"progress"in Bt&&u(9,Te=Bt.progress),"visible"in Bt&&u(10,Ee=Bt.visible),"$$scope"in Bt&&u(19,k=Bt.$$scope)},l.$$.update=()=>{l.$$.dirty[0]&2049&&(m=Math.round(F*lt)),l.$$.dirty[0]&4097&&(g=Math.round(N*lt)),l.$$.dirty[0]&8193&&(b=Math.round(W*lt)),l.$$.dirty[0]&47104&&oi(),l.$$.dirty[0]&196608&&u(5,M=`
		position: ${ht?"fixed":"absolute"};
		top: 0;
		transform: translate(0, ${st}px);
		z-index: 1;
	`),l.$$.dirty[0]&327680&&u(4,A=ht?`width:${Ot}px;`:"")},[lt,Me,Ie,qe,A,M,ce,de,ve,Te,Ee,F,N,W,Q,te,ht,st,Ot,k,r,ii,Xe,wt,di]}class FC extends X_{constructor(o){super(),Q_(this,o,OC,LC,Y_,{top:11,bottom:12,threshold:13,query:14,parallax:15,index:6,count:7,offset:8,progress:9,visible:10},null,[-1,-1])}}var BC=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function NC(l){return l&&l.__esModule&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l}var fM={exports:{}};(function(l,o){var u={};(function(m,g){l.exports=g()})(BC,function(){var m,g,b;function M(r,k){if(!m)m=k;else if(!g)g=k;else{var F="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+m+")(sharedChunk); ("+g+")(sharedChunk); self.onerror = null;",N={};m(N),b=k(N),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(b.workerUrl=window.URL.createObjectURL(new Blob([F],{type:"text/javascript"})))}}M(["exports"],function(r){var k="3.4.0";let F;const N={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(F==null){const t=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{F=u.API_URL_REGEX!=null?new RegExp(u.API_URL_REGEX):t}catch{F=t}}return F},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!N.API_URL)return null;try{const t=new URL(N.API_URL);return t.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":t.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"};function W(t){return N.API_URL_REGEX.test(t)}function Q(t){return t.indexOf("mapbox:")===0}function te(t){return N.API_CDN_URL_REGEX.test(t)}function ce(t){return N.API_SPRITE_REGEX.test(t)}function de(t){return N.API_STYLE_REGEX.test(t)&&!ce(t)}const ve={create:"create",load:"load",fullLoad:"fullLoad"};function Te(t){const e=t.name.split("?")[0];return te(e)&&e.includes("mapbox-gl.js")?"javascript":te(e)&&e.includes("mapbox-gl.css")?"css":function(i){return N.API_FONTS_REGEX.test(i)}(e)?"fontRange":ce(e)?"sprite":de(e)?"style":function(i){return N.API_TILEJSON_REGEX.test(i)}(e)?"tilejson":"other"}function Ee(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Me={},Ie={};Object.defineProperty(Ie,"__esModule",{value:!0}),Ie.setMatrixArrayType=function(t){Ie.ARRAY_TYPE=Ve=t},Ie.toRadian=function(t){return t*lt},Ie.equals=function(t,e){return Math.abs(t-e)<=qe*Math.max(1,Math.abs(t),Math.abs(e))},Ie.RANDOM=Ie.ARRAY_TYPE=Ie.EPSILON=void 0;var qe=1e-6;Ie.EPSILON=qe;var Ve=typeof Float32Array<"u"?Float32Array:Array;Ie.ARRAY_TYPE=Ve;var nt=Math.random;Ie.RANDOM=nt;var lt=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var ht={};function st(t){return st=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},st(t)}Object.defineProperty(ht,"__esModule",{value:!0}),ht.create=function(){var t=new Ot.ARRAY_TYPE(4);return Ot.ARRAY_TYPE!=Float32Array&&(t[1]=0,t[2]=0),t[0]=1,t[3]=1,t},ht.clone=function(t){var e=new Ot.ARRAY_TYPE(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},ht.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},ht.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},ht.fromValues=function(t,e,i,s){var c=new Ot.ARRAY_TYPE(4);return c[0]=t,c[1]=e,c[2]=i,c[3]=s,c},ht.set=function(t,e,i,s,c){return t[0]=e,t[1]=i,t[2]=s,t[3]=c,t},ht.transpose=function(t,e){if(t===e){var i=e[1];t[1]=e[2],t[2]=i}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t},ht.invert=function(t,e){var i=e[0],s=e[1],c=e[2],h=e[3],p=i*h-c*s;return p?(t[0]=h*(p=1/p),t[1]=-s*p,t[2]=-c*p,t[3]=i*p,t):null},ht.adjoint=function(t,e){var i=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=i,t},ht.determinant=function(t){return t[0]*t[3]-t[2]*t[1]},ht.multiply=ii,ht.rotate=function(t,e,i){var s=e[0],c=e[1],h=e[2],p=e[3],y=Math.sin(i),v=Math.cos(i);return t[0]=s*v+h*y,t[1]=c*v+p*y,t[2]=s*-y+h*v,t[3]=c*-y+p*v,t},ht.scale=function(t,e,i){var s=e[1],c=e[2],h=e[3],p=i[0],y=i[1];return t[0]=e[0]*p,t[1]=s*p,t[2]=c*y,t[3]=h*y,t},ht.fromRotation=function(t,e){var i=Math.sin(e),s=Math.cos(e);return t[0]=s,t[1]=i,t[2]=-i,t[3]=s,t},ht.fromScaling=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t},ht.str=function(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},ht.frob=function(t){return Math.hypot(t[0],t[1],t[2],t[3])},ht.LDU=function(t,e,i,s){return t[2]=s[2]/s[0],i[0]=s[0],i[1]=s[1],i[3]=s[3]-t[2]*i[1],[t,e,i]},ht.add=function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t},ht.subtract=Xe,ht.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},ht.equals=function(t,e){var i=t[0],s=t[1],c=t[2],h=t[3],p=e[0],y=e[1],v=e[2],T=e[3];return Math.abs(i-p)<=Ot.EPSILON*Math.max(1,Math.abs(i),Math.abs(p))&&Math.abs(s-y)<=Ot.EPSILON*Math.max(1,Math.abs(s),Math.abs(y))&&Math.abs(c-v)<=Ot.EPSILON*Math.max(1,Math.abs(c),Math.abs(v))&&Math.abs(h-T)<=Ot.EPSILON*Math.max(1,Math.abs(h),Math.abs(T))},ht.multiplyScalar=function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t},ht.multiplyScalarAndAdd=function(t,e,i,s){return t[0]=e[0]+i[0]*s,t[1]=e[1]+i[1]*s,t[2]=e[2]+i[2]*s,t[3]=e[3]+i[3]*s,t},ht.sub=ht.mul=void 0;var Ot=function(t,e){if(t&&t.__esModule)return t;if(t===null||st(t)!=="object"&&typeof t!="function")return{default:t};var i=oi(void 0);if(i&&i.has(t))return i.get(t);var s={},c=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var h in t)if(h!=="default"&&Object.prototype.hasOwnProperty.call(t,h)){var p=c?Object.getOwnPropertyDescriptor(t,h):null;p&&(p.get||p.set)?Object.defineProperty(s,h,p):s[h]=t[h]}return s.default=t,i&&i.set(t,s),s}(Ie);function oi(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,i=new WeakMap;return(oi=function(s){return s?i:e})(t)}function ii(t,e,i){var s=e[0],c=e[1],h=e[2],p=e[3],y=i[0],v=i[1],T=i[2],E=i[3];return t[0]=s*y+h*v,t[1]=c*y+p*v,t[2]=s*T+h*E,t[3]=c*T+p*E,t}function Xe(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t}ht.mul=ii,ht.sub=Xe;var wt={};function di(t){return di=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},di(t)}Object.defineProperty(wt,"__esModule",{value:!0}),wt.create=function(){var t=new Bt.ARRAY_TYPE(6);return Bt.ARRAY_TYPE!=Float32Array&&(t[1]=0,t[2]=0,t[4]=0,t[5]=0),t[0]=1,t[3]=1,t},wt.clone=function(t){var e=new Bt.ARRAY_TYPE(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},wt.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},wt.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},wt.fromValues=function(t,e,i,s,c,h){var p=new Bt.ARRAY_TYPE(6);return p[0]=t,p[1]=e,p[2]=i,p[3]=s,p[4]=c,p[5]=h,p},wt.set=function(t,e,i,s,c,h,p){return t[0]=e,t[1]=i,t[2]=s,t[3]=c,t[4]=h,t[5]=p,t},wt.invert=function(t,e){var i=e[0],s=e[1],c=e[2],h=e[3],p=e[4],y=e[5],v=i*h-s*c;return v?(t[0]=h*(v=1/v),t[1]=-s*v,t[2]=-c*v,t[3]=i*v,t[4]=(c*y-h*p)*v,t[5]=(s*p-i*y)*v,t):null},wt.determinant=function(t){return t[0]*t[3]-t[1]*t[2]},wt.multiply=Cn,wt.rotate=function(t,e,i){var s=e[0],c=e[1],h=e[2],p=e[3],y=e[4],v=e[5],T=Math.sin(i),E=Math.cos(i);return t[0]=s*E+h*T,t[1]=c*E+p*T,t[2]=s*-T+h*E,t[3]=c*-T+p*E,t[4]=y,t[5]=v,t},wt.scale=function(t,e,i){var s=e[1],c=e[2],h=e[3],p=e[4],y=e[5],v=i[0],T=i[1];return t[0]=e[0]*v,t[1]=s*v,t[2]=c*T,t[3]=h*T,t[4]=p,t[5]=y,t},wt.translate=function(t,e,i){var s=e[0],c=e[1],h=e[2],p=e[3],y=e[4],v=e[5],T=i[0],E=i[1];return t[0]=s,t[1]=c,t[2]=h,t[3]=p,t[4]=s*T+h*E+y,t[5]=c*T+p*E+v,t},wt.fromRotation=function(t,e){var i=Math.sin(e),s=Math.cos(e);return t[0]=s,t[1]=i,t[2]=-i,t[3]=s,t[4]=0,t[5]=0,t},wt.fromScaling=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t[4]=0,t[5]=0,t},wt.fromTranslation=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=e[0],t[5]=e[1],t},wt.str=function(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"},wt.frob=function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],1)},wt.add=function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t[4]=e[4]+i[4],t[5]=e[5]+i[5],t},wt.subtract=_n,wt.multiplyScalar=function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*i,t[5]=e[5]*i,t},wt.multiplyScalarAndAdd=function(t,e,i,s){return t[0]=e[0]+i[0]*s,t[1]=e[1]+i[1]*s,t[2]=e[2]+i[2]*s,t[3]=e[3]+i[3]*s,t[4]=e[4]+i[4]*s,t[5]=e[5]+i[5]*s,t},wt.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]},wt.equals=function(t,e){var i=t[0],s=t[1],c=t[2],h=t[3],p=t[4],y=t[5],v=e[0],T=e[1],E=e[2],I=e[3],P=e[4],R=e[5];return Math.abs(i-v)<=Bt.EPSILON*Math.max(1,Math.abs(i),Math.abs(v))&&Math.abs(s-T)<=Bt.EPSILON*Math.max(1,Math.abs(s),Math.abs(T))&&Math.abs(c-E)<=Bt.EPSILON*Math.max(1,Math.abs(c),Math.abs(E))&&Math.abs(h-I)<=Bt.EPSILON*Math.max(1,Math.abs(h),Math.abs(I))&&Math.abs(p-P)<=Bt.EPSILON*Math.max(1,Math.abs(p),Math.abs(P))&&Math.abs(y-R)<=Bt.EPSILON*Math.max(1,Math.abs(y),Math.abs(R))},wt.sub=wt.mul=void 0;var Bt=function(t,e){if(t&&t.__esModule)return t;if(t===null||di(t)!=="object"&&typeof t!="function")return{default:t};var i=fi(void 0);if(i&&i.has(t))return i.get(t);var s={},c=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var h in t)if(h!=="default"&&Object.prototype.hasOwnProperty.call(t,h)){var p=c?Object.getOwnPropertyDescriptor(t,h):null;p&&(p.get||p.set)?Object.defineProperty(s,h,p):s[h]=t[h]}return s.default=t,i&&i.set(t,s),s}(Ie);function fi(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,i=new WeakMap;return(fi=function(s){return s?i:e})(t)}function Cn(t,e,i){var s=e[0],c=e[1],h=e[2],p=e[3],y=e[4],v=e[5],T=i[0],E=i[1],I=i[2],P=i[3],R=i[4],L=i[5];return t[0]=s*T+h*E,t[1]=c*T+p*E,t[2]=s*I+h*P,t[3]=c*I+p*P,t[4]=s*R+h*L+y,t[5]=c*R+p*L+v,t}function _n(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t[4]=e[4]-i[4],t[5]=e[5]-i[5],t}wt.mul=Cn,wt.sub=_n;var Kt={};function gn(t){return gn=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},gn(t)}Object.defineProperty(Kt,"__esModule",{value:!0}),Kt.create=function(){var t=new ji.ARRAY_TYPE(9);return ji.ARRAY_TYPE!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t},Kt.fromMat4=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},Kt.clone=function(t){var e=new ji.ARRAY_TYPE(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},Kt.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},Kt.fromValues=function(t,e,i,s,c,h,p,y,v){var T=new ji.ARRAY_TYPE(9);return T[0]=t,T[1]=e,T[2]=i,T[3]=s,T[4]=c,T[5]=h,T[6]=p,T[7]=y,T[8]=v,T},Kt.set=function(t,e,i,s,c,h,p,y,v,T){return t[0]=e,t[1]=i,t[2]=s,t[3]=c,t[4]=h,t[5]=p,t[6]=y,t[7]=v,t[8]=T,t},Kt.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},Kt.transpose=function(t,e){if(t===e){var i=e[1],s=e[2],c=e[5];t[1]=e[3],t[2]=e[6],t[3]=i,t[5]=e[7],t[6]=s,t[7]=c}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},Kt.invert=function(t,e){var i=e[0],s=e[1],c=e[2],h=e[3],p=e[4],y=e[5],v=e[6],T=e[7],E=e[8],I=E*p-y*T,P=-E*h+y*v,R=T*h-p*v,L=i*I+s*P+c*R;return L?(t[0]=I*(L=1/L),t[1]=(-E*s+c*T)*L,t[2]=(y*s-c*p)*L,t[3]=P*L,t[4]=(E*i-c*v)*L,t[5]=(-y*i+c*h)*L,t[6]=R*L,t[7]=(-T*i+s*v)*L,t[8]=(p*i-s*h)*L,t):null},Kt.adjoint=function(t,e){var i=e[0],s=e[1],c=e[2],h=e[3],p=e[4],y=e[5],v=e[6],T=e[7],E=e[8];return t[0]=p*E-y*T,t[1]=c*T-s*E,t[2]=s*y-c*p,t[3]=y*v-h*E,t[4]=i*E-c*v,t[5]=c*h-i*y,t[6]=h*T-p*v,t[7]=s*v-i*T,t[8]=i*p-s*h,t},Kt.determinant=function(t){var e=t[3],i=t[4],s=t[5],c=t[6],h=t[7],p=t[8];return t[0]*(p*i-s*h)+t[1]*(-p*e+s*c)+t[2]*(h*e-i*c)},Kt.multiply=Zn,Kt.translate=function(t,e,i){var s=e[0],c=e[1],h=e[2],p=e[3],y=e[4],v=e[5],T=e[6],E=e[7],I=e[8],P=i[0],R=i[1];return t[0]=s,t[1]=c,t[2]=h,t[3]=p,t[4]=y,t[5]=v,t[6]=P*s+R*p+T,t[7]=P*c+R*y+E,t[8]=P*h+R*v+I,t},Kt.rotate=function(t,e,i){var s=e[0],c=e[1],h=e[2],p=e[3],y=e[4],v=e[5],T=e[6],E=e[7],I=e[8],P=Math.sin(i),R=Math.cos(i);return t[0]=R*s+P*p,t[1]=R*c+P*y,t[2]=R*h+P*v,t[3]=R*p-P*s,t[4]=R*y-P*c,t[5]=R*v-P*h,t[6]=T,t[7]=E,t[8]=I,t},Kt.scale=function(t,e,i){var s=i[0],c=i[1];return t[0]=s*e[0],t[1]=s*e[1],t[2]=s*e[2],t[3]=c*e[3],t[4]=c*e[4],t[5]=c*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},Kt.fromTranslation=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t},Kt.fromRotation=function(t,e){var i=Math.sin(e),s=Math.cos(e);return t[0]=s,t[1]=i,t[2]=0,t[3]=-i,t[4]=s,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},Kt.fromScaling=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},Kt.fromMat2d=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t},Kt.fromQuat=function(t,e){var i=e[0],s=e[1],c=e[2],h=e[3],p=i+i,y=s+s,v=c+c,T=i*p,E=s*p,I=s*y,P=c*p,R=c*y,L=c*v,B=h*p,j=h*y,G=h*v;return t[0]=1-I-L,t[3]=E-G,t[6]=P+j,t[1]=E+G,t[4]=1-T-L,t[7]=R-B,t[2]=P-j,t[5]=R+B,t[8]=1-T-I,t},Kt.normalFromMat4=function(t,e){var i=e[0],s=e[1],c=e[2],h=e[3],p=e[4],y=e[5],v=e[6],T=e[7],E=e[8],I=e[9],P=e[10],R=e[11],L=e[12],B=e[13],j=e[14],G=e[15],X=i*y-s*p,ie=i*v-c*p,J=i*T-h*p,he=s*v-c*y,re=s*T-h*y,pe=c*T-h*v,_e=E*B-I*L,Se=E*j-P*L,Le=E*G-R*L,Ce=I*j-P*B,Be=I*G-R*B,Fe=P*G-R*j,Oe=X*Fe-ie*Be+J*Ce+he*Le-re*Se+pe*_e;return Oe?(t[0]=(y*Fe-v*Be+T*Ce)*(Oe=1/Oe),t[1]=(v*Le-p*Fe-T*Se)*Oe,t[2]=(p*Be-y*Le+T*_e)*Oe,t[3]=(c*Be-s*Fe-h*Ce)*Oe,t[4]=(i*Fe-c*Le+h*Se)*Oe,t[5]=(s*Le-i*Be-h*_e)*Oe,t[6]=(B*pe-j*re+G*he)*Oe,t[7]=(j*J-L*pe-G*ie)*Oe,t[8]=(L*re-B*J+G*X)*Oe,t):null},Kt.projection=function(t,e,i){return t[0]=2/e,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/i,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t},Kt.str=function(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"},Kt.frob=function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},Kt.add=function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t[4]=e[4]+i[4],t[5]=e[5]+i[5],t[6]=e[6]+i[6],t[7]=e[7]+i[7],t[8]=e[8]+i[8],t},Kt.subtract=pr,Kt.multiplyScalar=function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*i,t},Kt.multiplyScalarAndAdd=function(t,e,i,s){return t[0]=e[0]+i[0]*s,t[1]=e[1]+i[1]*s,t[2]=e[2]+i[2]*s,t[3]=e[3]+i[3]*s,t[4]=e[4]+i[4]*s,t[5]=e[5]+i[5]*s,t[6]=e[6]+i[6]*s,t[7]=e[7]+i[7]*s,t[8]=e[8]+i[8]*s,t},Kt.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]},Kt.equals=function(t,e){var i=t[0],s=t[1],c=t[2],h=t[3],p=t[4],y=t[5],v=t[6],T=t[7],E=t[8],I=e[0],P=e[1],R=e[2],L=e[3],B=e[4],j=e[5],G=e[6],X=e[7],ie=e[8];return Math.abs(i-I)<=ji.EPSILON*Math.max(1,Math.abs(i),Math.abs(I))&&Math.abs(s-P)<=ji.EPSILON*Math.max(1,Math.abs(s),Math.abs(P))&&Math.abs(c-R)<=ji.EPSILON*Math.max(1,Math.abs(c),Math.abs(R))&&Math.abs(h-L)<=ji.EPSILON*Math.max(1,Math.abs(h),Math.abs(L))&&Math.abs(p-B)<=ji.EPSILON*Math.max(1,Math.abs(p),Math.abs(B))&&Math.abs(y-j)<=ji.EPSILON*Math.max(1,Math.abs(y),Math.abs(j))&&Math.abs(v-G)<=ji.EPSILON*Math.max(1,Math.abs(v),Math.abs(G))&&Math.abs(T-X)<=ji.EPSILON*Math.max(1,Math.abs(T),Math.abs(X))&&Math.abs(E-ie)<=ji.EPSILON*Math.max(1,Math.abs(E),Math.abs(ie))},Kt.sub=Kt.mul=void 0;var ji=function(t,e){if(t&&t.__esModule)return t;if(t===null||gn(t)!=="object"&&typeof t!="function")return{default:t};var i=On(void 0);if(i&&i.has(t))return i.get(t);var s={},c=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var h in t)if(h!=="default"&&Object.prototype.hasOwnProperty.call(t,h)){var p=c?Object.getOwnPropertyDescriptor(t,h):null;p&&(p.get||p.set)?Object.defineProperty(s,h,p):s[h]=t[h]}return s.default=t,i&&i.set(t,s),s}(Ie);function On(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,i=new WeakMap;return(On=function(s){return s?i:e})(t)}function Zn(t,e,i){var s=e[0],c=e[1],h=e[2],p=e[3],y=e[4],v=e[5],T=e[6],E=e[7],I=e[8],P=i[0],R=i[1],L=i[2],B=i[3],j=i[4],G=i[5],X=i[6],ie=i[7],J=i[8];return t[0]=P*s+R*p+L*T,t[1]=P*c+R*y+L*E,t[2]=P*h+R*v+L*I,t[3]=B*s+j*p+G*T,t[4]=B*c+j*y+G*E,t[5]=B*h+j*v+G*I,t[6]=X*s+ie*p+J*T,t[7]=X*c+ie*y+J*E,t[8]=X*h+ie*v+J*I,t}function pr(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t[4]=e[4]-i[4],t[5]=e[5]-i[5],t[6]=e[6]-i[6],t[7]=e[7]-i[7],t[8]=e[8]-i[8],t}Kt.mul=Zn,Kt.sub=pr;var Vt={};function Wt(t){return Wt=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Wt(t)}Object.defineProperty(Vt,"__esModule",{value:!0}),Vt.create=function(){var t=new Ht.ARRAY_TYPE(16);return Ht.ARRAY_TYPE!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t},Vt.clone=function(t){var e=new Ht.ARRAY_TYPE(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},Vt.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},Vt.fromValues=function(t,e,i,s,c,h,p,y,v,T,E,I,P,R,L,B){var j=new Ht.ARRAY_TYPE(16);return j[0]=t,j[1]=e,j[2]=i,j[3]=s,j[4]=c,j[5]=h,j[6]=p,j[7]=y,j[8]=v,j[9]=T,j[10]=E,j[11]=I,j[12]=P,j[13]=R,j[14]=L,j[15]=B,j},Vt.set=function(t,e,i,s,c,h,p,y,v,T,E,I,P,R,L,B,j){return t[0]=e,t[1]=i,t[2]=s,t[3]=c,t[4]=h,t[5]=p,t[6]=y,t[7]=v,t[8]=T,t[9]=E,t[10]=I,t[11]=P,t[12]=R,t[13]=L,t[14]=B,t[15]=j,t},Vt.identity=Tt,Vt.transpose=function(t,e){if(t===e){var i=e[1],s=e[2],c=e[3],h=e[6],p=e[7],y=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=i,t[6]=e[9],t[7]=e[13],t[8]=s,t[9]=h,t[11]=e[14],t[12]=c,t[13]=p,t[14]=y}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t},Vt.invert=function(t,e){var i=e[0],s=e[1],c=e[2],h=e[3],p=e[4],y=e[5],v=e[6],T=e[7],E=e[8],I=e[9],P=e[10],R=e[11],L=e[12],B=e[13],j=e[14],G=e[15],X=i*y-s*p,ie=i*v-c*p,J=i*T-h*p,he=s*v-c*y,re=s*T-h*y,pe=c*T-h*v,_e=E*B-I*L,Se=E*j-P*L,Le=E*G-R*L,Ce=I*j-P*B,Be=I*G-R*B,Fe=P*G-R*j,Oe=X*Fe-ie*Be+J*Ce+he*Le-re*Se+pe*_e;return Oe?(t[0]=(y*Fe-v*Be+T*Ce)*(Oe=1/Oe),t[1]=(c*Be-s*Fe-h*Ce)*Oe,t[2]=(B*pe-j*re+G*he)*Oe,t[3]=(P*re-I*pe-R*he)*Oe,t[4]=(v*Le-p*Fe-T*Se)*Oe,t[5]=(i*Fe-c*Le+h*Se)*Oe,t[6]=(j*J-L*pe-G*ie)*Oe,t[7]=(E*pe-P*J+R*ie)*Oe,t[8]=(p*Be-y*Le+T*_e)*Oe,t[9]=(s*Le-i*Be-h*_e)*Oe,t[10]=(L*re-B*J+G*X)*Oe,t[11]=(I*J-E*re-R*X)*Oe,t[12]=(y*Se-p*Ce-v*_e)*Oe,t[13]=(i*Ce-s*Se+c*_e)*Oe,t[14]=(B*ie-L*he-j*X)*Oe,t[15]=(E*he-I*ie+P*X)*Oe,t):null},Vt.adjoint=function(t,e){var i=e[0],s=e[1],c=e[2],h=e[3],p=e[4],y=e[5],v=e[6],T=e[7],E=e[8],I=e[9],P=e[10],R=e[11],L=e[12],B=e[13],j=e[14],G=e[15];return t[0]=y*(P*G-R*j)-I*(v*G-T*j)+B*(v*R-T*P),t[1]=-(s*(P*G-R*j)-I*(c*G-h*j)+B*(c*R-h*P)),t[2]=s*(v*G-T*j)-y*(c*G-h*j)+B*(c*T-h*v),t[3]=-(s*(v*R-T*P)-y*(c*R-h*P)+I*(c*T-h*v)),t[4]=-(p*(P*G-R*j)-E*(v*G-T*j)+L*(v*R-T*P)),t[5]=i*(P*G-R*j)-E*(c*G-h*j)+L*(c*R-h*P),t[6]=-(i*(v*G-T*j)-p*(c*G-h*j)+L*(c*T-h*v)),t[7]=i*(v*R-T*P)-p*(c*R-h*P)+E*(c*T-h*v),t[8]=p*(I*G-R*B)-E*(y*G-T*B)+L*(y*R-T*I),t[9]=-(i*(I*G-R*B)-E*(s*G-h*B)+L*(s*R-h*I)),t[10]=i*(y*G-T*B)-p*(s*G-h*B)+L*(s*T-h*y),t[11]=-(i*(y*R-T*I)-p*(s*R-h*I)+E*(s*T-h*y)),t[12]=-(p*(I*j-P*B)-E*(y*j-v*B)+L*(y*P-v*I)),t[13]=i*(I*j-P*B)-E*(s*j-c*B)+L*(s*P-c*I),t[14]=-(i*(y*j-v*B)-p*(s*j-c*B)+L*(s*v-c*y)),t[15]=i*(y*P-v*I)-p*(s*P-c*I)+E*(s*v-c*y),t},Vt.determinant=function(t){var e=t[0],i=t[1],s=t[2],c=t[3],h=t[4],p=t[5],y=t[6],v=t[7],T=t[8],E=t[9],I=t[10],P=t[11],R=t[12],L=t[13],B=t[14],j=t[15];return(e*p-i*h)*(I*j-P*B)-(e*y-s*h)*(E*j-P*L)+(e*v-c*h)*(E*B-I*L)+(i*y-s*p)*(T*j-P*R)-(i*v-c*p)*(T*B-I*R)+(s*v-c*y)*(T*L-E*R)},Vt.multiply=Fn,Vt.translate=function(t,e,i){var s,c,h,p,y,v,T,E,I,P,R,L,B=i[0],j=i[1],G=i[2];return e===t?(t[12]=e[0]*B+e[4]*j+e[8]*G+e[12],t[13]=e[1]*B+e[5]*j+e[9]*G+e[13],t[14]=e[2]*B+e[6]*j+e[10]*G+e[14],t[15]=e[3]*B+e[7]*j+e[11]*G+e[15]):(c=e[1],h=e[2],p=e[3],y=e[4],v=e[5],T=e[6],E=e[7],I=e[8],P=e[9],R=e[10],L=e[11],t[0]=s=e[0],t[1]=c,t[2]=h,t[3]=p,t[4]=y,t[5]=v,t[6]=T,t[7]=E,t[8]=I,t[9]=P,t[10]=R,t[11]=L,t[12]=s*B+y*j+I*G+e[12],t[13]=c*B+v*j+P*G+e[13],t[14]=h*B+T*j+R*G+e[14],t[15]=p*B+E*j+L*G+e[15]),t},Vt.scale=function(t,e,i){var s=i[0],c=i[1],h=i[2];return t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t[3]=e[3]*s,t[4]=e[4]*c,t[5]=e[5]*c,t[6]=e[6]*c,t[7]=e[7]*c,t[8]=e[8]*h,t[9]=e[9]*h,t[10]=e[10]*h,t[11]=e[11]*h,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},Vt.rotate=function(t,e,i,s){var c,h,p,y,v,T,E,I,P,R,L,B,j,G,X,ie,J,he,re,pe,_e,Se,Le,Ce,Be=s[0],Fe=s[1],Oe=s[2],Ze=Math.hypot(Be,Fe,Oe);return Ze<Ht.EPSILON?null:(Be*=Ze=1/Ze,Fe*=Ze,Oe*=Ze,c=Math.sin(i),h=Math.cos(i),v=e[1],T=e[2],E=e[3],P=e[5],R=e[6],L=e[7],j=e[9],G=e[10],X=e[11],ie=Be*Be*(p=1-h)+h,re=Be*Fe*p-Oe*c,pe=Fe*Fe*p+h,_e=Oe*Fe*p+Be*c,Se=Be*Oe*p+Fe*c,Le=Fe*Oe*p-Be*c,Ce=Oe*Oe*p+h,t[0]=(y=e[0])*ie+(I=e[4])*(J=Fe*Be*p+Oe*c)+(B=e[8])*(he=Oe*Be*p-Fe*c),t[1]=v*ie+P*J+j*he,t[2]=T*ie+R*J+G*he,t[3]=E*ie+L*J+X*he,t[4]=y*re+I*pe+B*_e,t[5]=v*re+P*pe+j*_e,t[6]=T*re+R*pe+G*_e,t[7]=E*re+L*pe+X*_e,t[8]=y*Se+I*Le+B*Ce,t[9]=v*Se+P*Le+j*Ce,t[10]=T*Se+R*Le+G*Ce,t[11]=E*Se+L*Le+X*Ce,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)},Vt.rotateX=function(t,e,i){var s=Math.sin(i),c=Math.cos(i),h=e[4],p=e[5],y=e[6],v=e[7],T=e[8],E=e[9],I=e[10],P=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=h*c+T*s,t[5]=p*c+E*s,t[6]=y*c+I*s,t[7]=v*c+P*s,t[8]=T*c-h*s,t[9]=E*c-p*s,t[10]=I*c-y*s,t[11]=P*c-v*s,t},Vt.rotateY=function(t,e,i){var s=Math.sin(i),c=Math.cos(i),h=e[0],p=e[1],y=e[2],v=e[3],T=e[8],E=e[9],I=e[10],P=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=h*c-T*s,t[1]=p*c-E*s,t[2]=y*c-I*s,t[3]=v*c-P*s,t[8]=h*s+T*c,t[9]=p*s+E*c,t[10]=y*s+I*c,t[11]=v*s+P*c,t},Vt.rotateZ=function(t,e,i){var s=Math.sin(i),c=Math.cos(i),h=e[0],p=e[1],y=e[2],v=e[3],T=e[4],E=e[5],I=e[6],P=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=h*c+T*s,t[1]=p*c+E*s,t[2]=y*c+I*s,t[3]=v*c+P*s,t[4]=T*c-h*s,t[5]=E*c-p*s,t[6]=I*c-y*s,t[7]=P*c-v*s,t},Vt.fromTranslation=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t},Vt.fromScaling=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Vt.fromRotation=function(t,e,i){var s,c,h,p=i[0],y=i[1],v=i[2],T=Math.hypot(p,y,v);return T<Ht.EPSILON?null:(p*=T=1/T,y*=T,v*=T,s=Math.sin(e),c=Math.cos(e),t[0]=p*p*(h=1-c)+c,t[1]=y*p*h+v*s,t[2]=v*p*h-y*s,t[3]=0,t[4]=p*y*h-v*s,t[5]=y*y*h+c,t[6]=v*y*h+p*s,t[7]=0,t[8]=p*v*h+y*s,t[9]=y*v*h-p*s,t[10]=v*v*h+c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)},Vt.fromXRotation=function(t,e){var i=Math.sin(e),s=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=s,t[6]=i,t[7]=0,t[8]=0,t[9]=-i,t[10]=s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Vt.fromYRotation=function(t,e){var i=Math.sin(e),s=Math.cos(e);return t[0]=s,t[1]=0,t[2]=-i,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=i,t[9]=0,t[10]=s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Vt.fromZRotation=function(t,e){var i=Math.sin(e),s=Math.cos(e);return t[0]=s,t[1]=i,t[2]=0,t[3]=0,t[4]=-i,t[5]=s,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Vt.fromRotationTranslation=Zi,Vt.fromQuat2=function(t,e){var i=new Ht.ARRAY_TYPE(3),s=-e[0],c=-e[1],h=-e[2],p=e[3],y=e[4],v=e[5],T=e[6],E=e[7],I=s*s+c*c+h*h+p*p;return I>0?(i[0]=2*(y*p+E*s+v*h-T*c)/I,i[1]=2*(v*p+E*c+T*s-y*h)/I,i[2]=2*(T*p+E*h+y*c-v*s)/I):(i[0]=2*(y*p+E*s+v*h-T*c),i[1]=2*(v*p+E*c+T*s-y*h),i[2]=2*(T*p+E*h+y*c-v*s)),Zi(t,e,i),t},Vt.getTranslation=function(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t},Vt.getScaling=ir,Vt.getRotation=function(t,e){var i=new Ht.ARRAY_TYPE(3);ir(i,e);var s=1/i[0],c=1/i[1],h=1/i[2],p=e[0]*s,y=e[1]*c,v=e[2]*h,T=e[4]*s,E=e[5]*c,I=e[6]*h,P=e[8]*s,R=e[9]*c,L=e[10]*h,B=p+E+L,j=0;return B>0?(j=2*Math.sqrt(B+1),t[3]=.25*j,t[0]=(I-R)/j,t[1]=(P-v)/j,t[2]=(y-T)/j):p>E&&p>L?(j=2*Math.sqrt(1+p-E-L),t[3]=(I-R)/j,t[0]=.25*j,t[1]=(y+T)/j,t[2]=(P+v)/j):E>L?(j=2*Math.sqrt(1+E-p-L),t[3]=(P-v)/j,t[0]=(y+T)/j,t[1]=.25*j,t[2]=(I+R)/j):(j=2*Math.sqrt(1+L-p-E),t[3]=(y-T)/j,t[0]=(P+v)/j,t[1]=(I+R)/j,t[2]=.25*j),t},Vt.fromRotationTranslationScale=function(t,e,i,s){var c=e[0],h=e[1],p=e[2],y=e[3],v=c+c,T=h+h,E=p+p,I=c*v,P=c*T,R=c*E,L=h*T,B=h*E,j=p*E,G=y*v,X=y*T,ie=y*E,J=s[0],he=s[1],re=s[2];return t[0]=(1-(L+j))*J,t[1]=(P+ie)*J,t[2]=(R-X)*J,t[3]=0,t[4]=(P-ie)*he,t[5]=(1-(I+j))*he,t[6]=(B+G)*he,t[7]=0,t[8]=(R+X)*re,t[9]=(B-G)*re,t[10]=(1-(I+L))*re,t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1,t},Vt.fromRotationTranslationScaleOrigin=function(t,e,i,s,c){var h=e[0],p=e[1],y=e[2],v=e[3],T=h+h,E=p+p,I=y+y,P=h*T,R=h*E,L=h*I,B=p*E,j=p*I,G=y*I,X=v*T,ie=v*E,J=v*I,he=s[0],re=s[1],pe=s[2],_e=c[0],Se=c[1],Le=c[2],Ce=(1-(B+G))*he,Be=(R+J)*he,Fe=(L-ie)*he,Oe=(R-J)*re,Ze=(1-(P+G))*re,We=(j+X)*re,Je=(L+ie)*pe,Qe=(j-X)*pe,Ne=(1-(P+B))*pe;return t[0]=Ce,t[1]=Be,t[2]=Fe,t[3]=0,t[4]=Oe,t[5]=Ze,t[6]=We,t[7]=0,t[8]=Je,t[9]=Qe,t[10]=Ne,t[11]=0,t[12]=i[0]+_e-(Ce*_e+Oe*Se+Je*Le),t[13]=i[1]+Se-(Be*_e+Ze*Se+Qe*Le),t[14]=i[2]+Le-(Fe*_e+We*Se+Ne*Le),t[15]=1,t},Vt.fromQuat=function(t,e){var i=e[0],s=e[1],c=e[2],h=e[3],p=i+i,y=s+s,v=c+c,T=i*p,E=s*p,I=s*y,P=c*p,R=c*y,L=c*v,B=h*p,j=h*y,G=h*v;return t[0]=1-I-L,t[1]=E+G,t[2]=P-j,t[3]=0,t[4]=E-G,t[5]=1-T-L,t[6]=R+B,t[7]=0,t[8]=P+j,t[9]=R-B,t[10]=1-T-I,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},Vt.frustum=function(t,e,i,s,c,h,p){var y=1/(i-e),v=1/(c-s),T=1/(h-p);return t[0]=2*h*y,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*h*v,t[6]=0,t[7]=0,t[8]=(i+e)*y,t[9]=(c+s)*v,t[10]=(p+h)*T,t[11]=-1,t[12]=0,t[13]=0,t[14]=p*h*2*T,t[15]=0,t},Vt.perspectiveNO=$n,Vt.perspectiveZO=function(t,e,i,s,c){var h,p=1/Math.tan(e/2);return t[0]=p/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=p,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,c!=null&&c!==1/0?(t[10]=c*(h=1/(s-c)),t[14]=c*s*h):(t[10]=-1,t[14]=-s),t},Vt.perspectiveFromFieldOfView=function(t,e,i,s){var c=Math.tan(e.upDegrees*Math.PI/180),h=Math.tan(e.downDegrees*Math.PI/180),p=Math.tan(e.leftDegrees*Math.PI/180),y=Math.tan(e.rightDegrees*Math.PI/180),v=2/(p+y),T=2/(c+h);return t[0]=v,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=T,t[6]=0,t[7]=0,t[8]=-(p-y)*v*.5,t[9]=(c-h)*T*.5,t[10]=s/(i-s),t[11]=-1,t[12]=0,t[13]=0,t[14]=s*i/(i-s),t[15]=0,t},Vt.orthoNO=un,Vt.orthoZO=function(t,e,i,s,c,h,p){var y=1/(e-i),v=1/(s-c),T=1/(h-p);return t[0]=-2*y,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*v,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=T,t[11]=0,t[12]=(e+i)*y,t[13]=(c+s)*v,t[14]=h*T,t[15]=1,t},Vt.lookAt=function(t,e,i,s){var c,h,p,y,v,T,E,I,P,R,L=e[0],B=e[1],j=e[2],G=s[0],X=s[1],ie=s[2],J=i[0],he=i[1],re=i[2];return Math.abs(L-J)<Ht.EPSILON&&Math.abs(B-he)<Ht.EPSILON&&Math.abs(j-re)<Ht.EPSILON?Tt(t):(E=L-J,I=B-he,P=j-re,c=X*(P*=R=1/Math.hypot(E,I,P))-ie*(I*=R),h=ie*(E*=R)-G*P,p=G*I-X*E,(R=Math.hypot(c,h,p))?(c*=R=1/R,h*=R,p*=R):(c=0,h=0,p=0),y=I*p-P*h,v=P*c-E*p,T=E*h-I*c,(R=Math.hypot(y,v,T))?(y*=R=1/R,v*=R,T*=R):(y=0,v=0,T=0),t[0]=c,t[1]=y,t[2]=E,t[3]=0,t[4]=h,t[5]=v,t[6]=I,t[7]=0,t[8]=p,t[9]=T,t[10]=P,t[11]=0,t[12]=-(c*L+h*B+p*j),t[13]=-(y*L+v*B+T*j),t[14]=-(E*L+I*B+P*j),t[15]=1,t)},Vt.targetTo=function(t,e,i,s){var c=e[0],h=e[1],p=e[2],y=s[0],v=s[1],T=s[2],E=c-i[0],I=h-i[1],P=p-i[2],R=E*E+I*I+P*P;R>0&&(E*=R=1/Math.sqrt(R),I*=R,P*=R);var L=v*P-T*I,B=T*E-y*P,j=y*I-v*E;return(R=L*L+B*B+j*j)>0&&(L*=R=1/Math.sqrt(R),B*=R,j*=R),t[0]=L,t[1]=B,t[2]=j,t[3]=0,t[4]=I*j-P*B,t[5]=P*L-E*j,t[6]=E*B-I*L,t[7]=0,t[8]=E,t[9]=I,t[10]=P,t[11]=0,t[12]=c,t[13]=h,t[14]=p,t[15]=1,t},Vt.str=function(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"},Vt.frob=function(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])},Vt.add=function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t[4]=e[4]+i[4],t[5]=e[5]+i[5],t[6]=e[6]+i[6],t[7]=e[7]+i[7],t[8]=e[8]+i[8],t[9]=e[9]+i[9],t[10]=e[10]+i[10],t[11]=e[11]+i[11],t[12]=e[12]+i[12],t[13]=e[13]+i[13],t[14]=e[14]+i[14],t[15]=e[15]+i[15],t},Vt.subtract=Do,Vt.multiplyScalar=function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*i,t[9]=e[9]*i,t[10]=e[10]*i,t[11]=e[11]*i,t[12]=e[12]*i,t[13]=e[13]*i,t[14]=e[14]*i,t[15]=e[15]*i,t},Vt.multiplyScalarAndAdd=function(t,e,i,s){return t[0]=e[0]+i[0]*s,t[1]=e[1]+i[1]*s,t[2]=e[2]+i[2]*s,t[3]=e[3]+i[3]*s,t[4]=e[4]+i[4]*s,t[5]=e[5]+i[5]*s,t[6]=e[6]+i[6]*s,t[7]=e[7]+i[7]*s,t[8]=e[8]+i[8]*s,t[9]=e[9]+i[9]*s,t[10]=e[10]+i[10]*s,t[11]=e[11]+i[11]*s,t[12]=e[12]+i[12]*s,t[13]=e[13]+i[13]*s,t[14]=e[14]+i[14]*s,t[15]=e[15]+i[15]*s,t},Vt.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]},Vt.equals=function(t,e){var i=t[0],s=t[1],c=t[2],h=t[3],p=t[4],y=t[5],v=t[6],T=t[7],E=t[8],I=t[9],P=t[10],R=t[11],L=t[12],B=t[13],j=t[14],G=t[15],X=e[0],ie=e[1],J=e[2],he=e[3],re=e[4],pe=e[5],_e=e[6],Se=e[7],Le=e[8],Ce=e[9],Be=e[10],Fe=e[11],Oe=e[12],Ze=e[13],We=e[14],Je=e[15];return Math.abs(i-X)<=Ht.EPSILON*Math.max(1,Math.abs(i),Math.abs(X))&&Math.abs(s-ie)<=Ht.EPSILON*Math.max(1,Math.abs(s),Math.abs(ie))&&Math.abs(c-J)<=Ht.EPSILON*Math.max(1,Math.abs(c),Math.abs(J))&&Math.abs(h-he)<=Ht.EPSILON*Math.max(1,Math.abs(h),Math.abs(he))&&Math.abs(p-re)<=Ht.EPSILON*Math.max(1,Math.abs(p),Math.abs(re))&&Math.abs(y-pe)<=Ht.EPSILON*Math.max(1,Math.abs(y),Math.abs(pe))&&Math.abs(v-_e)<=Ht.EPSILON*Math.max(1,Math.abs(v),Math.abs(_e))&&Math.abs(T-Se)<=Ht.EPSILON*Math.max(1,Math.abs(T),Math.abs(Se))&&Math.abs(E-Le)<=Ht.EPSILON*Math.max(1,Math.abs(E),Math.abs(Le))&&Math.abs(I-Ce)<=Ht.EPSILON*Math.max(1,Math.abs(I),Math.abs(Ce))&&Math.abs(P-Be)<=Ht.EPSILON*Math.max(1,Math.abs(P),Math.abs(Be))&&Math.abs(R-Fe)<=Ht.EPSILON*Math.max(1,Math.abs(R),Math.abs(Fe))&&Math.abs(L-Oe)<=Ht.EPSILON*Math.max(1,Math.abs(L),Math.abs(Oe))&&Math.abs(B-Ze)<=Ht.EPSILON*Math.max(1,Math.abs(B),Math.abs(Ze))&&Math.abs(j-We)<=Ht.EPSILON*Math.max(1,Math.abs(j),Math.abs(We))&&Math.abs(G-Je)<=Ht.EPSILON*Math.max(1,Math.abs(G),Math.abs(Je))},Vt.sub=Vt.mul=Vt.ortho=Vt.perspective=void 0;var Ht=function(t,e){if(t&&t.__esModule)return t;if(t===null||Wt(t)!=="object"&&typeof t!="function")return{default:t};var i=Ui(void 0);if(i&&i.has(t))return i.get(t);var s={},c=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var h in t)if(h!=="default"&&Object.prototype.hasOwnProperty.call(t,h)){var p=c?Object.getOwnPropertyDescriptor(t,h):null;p&&(p.get||p.set)?Object.defineProperty(s,h,p):s[h]=t[h]}return s.default=t,i&&i.set(t,s),s}(Ie);function Ui(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,i=new WeakMap;return(Ui=function(s){return s?i:e})(t)}function Tt(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Fn(t,e,i){var s=e[0],c=e[1],h=e[2],p=e[3],y=e[4],v=e[5],T=e[6],E=e[7],I=e[8],P=e[9],R=e[10],L=e[11],B=e[12],j=e[13],G=e[14],X=e[15],ie=i[0],J=i[1],he=i[2],re=i[3];return t[0]=ie*s+J*y+he*I+re*B,t[1]=ie*c+J*v+he*P+re*j,t[2]=ie*h+J*T+he*R+re*G,t[3]=ie*p+J*E+he*L+re*X,t[4]=(ie=i[4])*s+(J=i[5])*y+(he=i[6])*I+(re=i[7])*B,t[5]=ie*c+J*v+he*P+re*j,t[6]=ie*h+J*T+he*R+re*G,t[7]=ie*p+J*E+he*L+re*X,t[8]=(ie=i[8])*s+(J=i[9])*y+(he=i[10])*I+(re=i[11])*B,t[9]=ie*c+J*v+he*P+re*j,t[10]=ie*h+J*T+he*R+re*G,t[11]=ie*p+J*E+he*L+re*X,t[12]=(ie=i[12])*s+(J=i[13])*y+(he=i[14])*I+(re=i[15])*B,t[13]=ie*c+J*v+he*P+re*j,t[14]=ie*h+J*T+he*R+re*G,t[15]=ie*p+J*E+he*L+re*X,t}function Zi(t,e,i){var s=e[0],c=e[1],h=e[2],p=e[3],y=s+s,v=c+c,T=h+h,E=s*y,I=s*v,P=s*T,R=c*v,L=c*T,B=h*T,j=p*y,G=p*v,X=p*T;return t[0]=1-(R+B),t[1]=I+X,t[2]=P-G,t[3]=0,t[4]=I-X,t[5]=1-(E+B),t[6]=L+j,t[7]=0,t[8]=P+G,t[9]=L-j,t[10]=1-(E+R),t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1,t}function ir(t,e){var i=e[4],s=e[5],c=e[6],h=e[8],p=e[9],y=e[10];return t[0]=Math.hypot(e[0],e[1],e[2]),t[1]=Math.hypot(i,s,c),t[2]=Math.hypot(h,p,y),t}function $n(t,e,i,s,c){var h,p=1/Math.tan(e/2);return t[0]=p/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=p,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,c!=null&&c!==1/0?(t[10]=(c+s)*(h=1/(s-c)),t[14]=2*c*s*h):(t[10]=-1,t[14]=-2*s),t}function un(t,e,i,s,c,h,p){var y=1/(e-i),v=1/(s-c),T=1/(h-p);return t[0]=-2*y,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*v,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*T,t[11]=0,t[12]=(e+i)*y,t[13]=(c+s)*v,t[14]=(p+h)*T,t[15]=1,t}function Do(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t[4]=e[4]-i[4],t[5]=e[5]-i[5],t[6]=e[6]-i[6],t[7]=e[7]-i[7],t[8]=e[8]-i[8],t[9]=e[9]-i[9],t[10]=e[10]-i[10],t[11]=e[11]-i[11],t[12]=e[12]-i[12],t[13]=e[13]-i[13],t[14]=e[14]-i[14],t[15]=e[15]-i[15],t}Vt.perspective=$n,Vt.ortho=un,Vt.mul=Fn,Vt.sub=Do;var Qt={},Zt={};function dl(t){return dl=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},dl(t)}Object.defineProperty(Zt,"__esModule",{value:!0}),Zt.create=ne,Zt.clone=function(t){var e=new Kr.ARRAY_TYPE(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},Zt.length=ue,Zt.fromValues=function(t,e,i){var s=new Kr.ARRAY_TYPE(3);return s[0]=t,s[1]=e,s[2]=i,s},Zt.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},Zt.set=function(t,e,i,s){return t[0]=e,t[1]=i,t[2]=s,t},Zt.add=function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t},Zt.subtract=be,Zt.multiply=$e,Zt.divide=Ke,Zt.ceil=function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t},Zt.floor=function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t},Zt.min=function(t,e,i){return t[0]=Math.min(e[0],i[0]),t[1]=Math.min(e[1],i[1]),t[2]=Math.min(e[2],i[2]),t},Zt.max=function(t,e,i){return t[0]=Math.max(e[0],i[0]),t[1]=Math.max(e[1],i[1]),t[2]=Math.max(e[2],i[2]),t},Zt.round=function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t},Zt.scale=function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t},Zt.scaleAndAdd=function(t,e,i,s){return t[0]=e[0]+i[0]*s,t[1]=e[1]+i[1]*s,t[2]=e[2]+i[2]*s,t},Zt.distance=ot,Zt.squaredDistance=Dt,Zt.squaredLength=He,Zt.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},Zt.inverse=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t},Zt.normalize=function(t,e){var i=e[0],s=e[1],c=e[2],h=i*i+s*s+c*c;return h>0&&(h=1/Math.sqrt(h)),t[0]=e[0]*h,t[1]=e[1]*h,t[2]=e[2]*h,t},Zt.dot=St,Zt.cross=function(t,e,i){var s=e[0],c=e[1],h=e[2],p=i[0],y=i[1],v=i[2];return t[0]=c*v-h*y,t[1]=h*p-s*v,t[2]=s*y-c*p,t},Zt.lerp=function(t,e,i,s){var c=e[0],h=e[1],p=e[2];return t[0]=c+s*(i[0]-c),t[1]=h+s*(i[1]-h),t[2]=p+s*(i[2]-p),t},Zt.hermite=function(t,e,i,s,c,h){var p=h*h,y=p*(2*h-3)+1,v=p*(h-2)+h,T=p*(h-1),E=p*(3-2*h);return t[0]=e[0]*y+i[0]*v+s[0]*T+c[0]*E,t[1]=e[1]*y+i[1]*v+s[1]*T+c[1]*E,t[2]=e[2]*y+i[2]*v+s[2]*T+c[2]*E,t},Zt.bezier=function(t,e,i,s,c,h){var p=1-h,y=p*p,v=h*h,T=y*p,E=3*h*y,I=3*v*p,P=v*h;return t[0]=e[0]*T+i[0]*E+s[0]*I+c[0]*P,t[1]=e[1]*T+i[1]*E+s[1]*I+c[1]*P,t[2]=e[2]*T+i[2]*E+s[2]*I+c[2]*P,t},Zt.random=function(t,e){e=e||1;var i=2*Kr.RANDOM()*Math.PI,s=2*Kr.RANDOM()-1,c=Math.sqrt(1-s*s)*e;return t[0]=Math.cos(i)*c,t[1]=Math.sin(i)*c,t[2]=s*e,t},Zt.transformMat4=function(t,e,i){var s=e[0],c=e[1],h=e[2],p=i[3]*s+i[7]*c+i[11]*h+i[15];return t[0]=(i[0]*s+i[4]*c+i[8]*h+i[12])/(p=p||1),t[1]=(i[1]*s+i[5]*c+i[9]*h+i[13])/p,t[2]=(i[2]*s+i[6]*c+i[10]*h+i[14])/p,t},Zt.transformMat3=function(t,e,i){var s=e[0],c=e[1],h=e[2];return t[0]=s*i[0]+c*i[3]+h*i[6],t[1]=s*i[1]+c*i[4]+h*i[7],t[2]=s*i[2]+c*i[5]+h*i[8],t},Zt.transformQuat=function(t,e,i){var s=i[0],c=i[1],h=i[2],p=e[0],y=e[1],v=e[2],T=c*v-h*y,E=h*p-s*v,I=s*y-c*p,P=c*I-h*E,R=h*T-s*I,L=s*E-c*T,B=2*i[3];return E*=B,I*=B,R*=2,L*=2,t[0]=p+(T*=B)+(P*=2),t[1]=y+E+R,t[2]=v+I+L,t},Zt.rotateX=function(t,e,i,s){var c=[],h=[];return c[0]=e[0]-i[0],c[1]=e[1]-i[1],c[2]=e[2]-i[2],h[0]=c[0],h[1]=c[1]*Math.cos(s)-c[2]*Math.sin(s),h[2]=c[1]*Math.sin(s)+c[2]*Math.cos(s),t[0]=h[0]+i[0],t[1]=h[1]+i[1],t[2]=h[2]+i[2],t},Zt.rotateY=function(t,e,i,s){var c=[],h=[];return c[0]=e[0]-i[0],c[1]=e[1]-i[1],c[2]=e[2]-i[2],h[0]=c[2]*Math.sin(s)+c[0]*Math.cos(s),h[1]=c[1],h[2]=c[2]*Math.cos(s)-c[0]*Math.sin(s),t[0]=h[0]+i[0],t[1]=h[1]+i[1],t[2]=h[2]+i[2],t},Zt.rotateZ=function(t,e,i,s){var c=[],h=[];return c[0]=e[0]-i[0],c[1]=e[1]-i[1],c[2]=e[2]-i[2],h[0]=c[0]*Math.cos(s)-c[1]*Math.sin(s),h[1]=c[0]*Math.sin(s)+c[1]*Math.cos(s),h[2]=c[2],t[0]=h[0]+i[0],t[1]=h[1]+i[1],t[2]=h[2]+i[2],t},Zt.angle=function(t,e){var i=t[0],s=t[1],c=t[2],h=e[0],p=e[1],y=e[2],v=Math.sqrt(i*i+s*s+c*c)*Math.sqrt(h*h+p*p+y*y),T=v&&St(t,e)/v;return Math.acos(Math.min(Math.max(T,-1),1))},Zt.zero=function(t){return t[0]=0,t[1]=0,t[2]=0,t},Zt.str=function(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"},Zt.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]},Zt.equals=function(t,e){var i=t[0],s=t[1],c=t[2],h=e[0],p=e[1],y=e[2];return Math.abs(i-h)<=Kr.EPSILON*Math.max(1,Math.abs(i),Math.abs(h))&&Math.abs(s-p)<=Kr.EPSILON*Math.max(1,Math.abs(s),Math.abs(p))&&Math.abs(c-y)<=Kr.EPSILON*Math.max(1,Math.abs(c),Math.abs(y))},Zt.forEach=Zt.sqrLen=Zt.len=Zt.sqrDist=Zt.dist=Zt.div=Zt.mul=Zt.sub=void 0;var Kr=function(t,e){if(t&&t.__esModule)return t;if(t===null||dl(t)!=="object"&&typeof t!="function")return{default:t};var i=rt(void 0);if(i&&i.has(t))return i.get(t);var s={},c=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var h in t)if(h!=="default"&&Object.prototype.hasOwnProperty.call(t,h)){var p=c?Object.getOwnPropertyDescriptor(t,h):null;p&&(p.get||p.set)?Object.defineProperty(s,h,p):s[h]=t[h]}return s.default=t,i&&i.set(t,s),s}(Ie);function rt(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,i=new WeakMap;return(rt=function(s){return s?i:e})(t)}function ne(){var t=new Kr.ARRAY_TYPE(3);return Kr.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function ue(t){return Math.hypot(t[0],t[1],t[2])}function be(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function $e(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t[2]=e[2]*i[2],t}function Ke(t,e,i){return t[0]=e[0]/i[0],t[1]=e[1]/i[1],t[2]=e[2]/i[2],t}function ot(t,e){return Math.hypot(e[0]-t[0],e[1]-t[1],e[2]-t[2])}function Dt(t,e){var i=e[0]-t[0],s=e[1]-t[1],c=e[2]-t[2];return i*i+s*s+c*c}function He(t){var e=t[0],i=t[1],s=t[2];return e*e+i*i+s*s}function St(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}Zt.sub=be,Zt.mul=$e,Zt.div=Ke,Zt.dist=ot,Zt.sqrDist=Dt,Zt.len=ue,Zt.sqrLen=He;var Ct,Lt=(Ct=ne(),function(t,e,i,s,c,h){var p,y;for(e||(e=3),i||(i=0),y=s?Math.min(s*e+i,t.length):t.length,p=i;p<y;p+=e)Ct[0]=t[p],Ct[1]=t[p+1],Ct[2]=t[p+2],c(Ct,Ct,h),t[p]=Ct[0],t[p+1]=Ct[1],t[p+2]=Ct[2];return t});Zt.forEach=Lt;var yt={};function $i(t){return $i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},$i(t)}Object.defineProperty(yt,"__esModule",{value:!0}),yt.create=Li,yt.clone=function(t){var e=new zi.ARRAY_TYPE(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},yt.fromValues=function(t,e,i,s){var c=new zi.ARRAY_TYPE(4);return c[0]=t,c[1]=e,c[2]=i,c[3]=s,c},yt.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},yt.set=function(t,e,i,s,c){return t[0]=e,t[1]=i,t[2]=s,t[3]=c,t},yt.add=function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t},yt.subtract=Oi,yt.multiply=Yi,yt.divide=yn,yt.ceil=function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t},yt.floor=function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t},yt.min=function(t,e,i){return t[0]=Math.min(e[0],i[0]),t[1]=Math.min(e[1],i[1]),t[2]=Math.min(e[2],i[2]),t[3]=Math.min(e[3],i[3]),t},yt.max=function(t,e,i){return t[0]=Math.max(e[0],i[0]),t[1]=Math.max(e[1],i[1]),t[2]=Math.max(e[2],i[2]),t[3]=Math.max(e[3],i[3]),t},yt.round=function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t},yt.scale=function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t},yt.scaleAndAdd=function(t,e,i,s){return t[0]=e[0]+i[0]*s,t[1]=e[1]+i[1]*s,t[2]=e[2]+i[2]*s,t[3]=e[3]+i[3]*s,t},yt.distance=nr,yt.squaredDistance=ln,yt.length=Cr,yt.squaredLength=wr,yt.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},yt.inverse=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t},yt.normalize=function(t,e){var i=e[0],s=e[1],c=e[2],h=e[3],p=i*i+s*s+c*c+h*h;return p>0&&(p=1/Math.sqrt(p)),t[0]=i*p,t[1]=s*p,t[2]=c*p,t[3]=h*p,t},yt.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},yt.cross=function(t,e,i,s){var c=i[0]*s[1]-i[1]*s[0],h=i[0]*s[2]-i[2]*s[0],p=i[0]*s[3]-i[3]*s[0],y=i[1]*s[2]-i[2]*s[1],v=i[1]*s[3]-i[3]*s[1],T=i[2]*s[3]-i[3]*s[2],E=e[0],I=e[1],P=e[2],R=e[3];return t[0]=I*T-P*v+R*y,t[1]=-E*T+P*p-R*h,t[2]=E*v-I*p+R*c,t[3]=-E*y+I*h-P*c,t},yt.lerp=function(t,e,i,s){var c=e[0],h=e[1],p=e[2],y=e[3];return t[0]=c+s*(i[0]-c),t[1]=h+s*(i[1]-h),t[2]=p+s*(i[2]-p),t[3]=y+s*(i[3]-y),t},yt.random=function(t,e){var i,s,c,h,p,y;e=e||1;do p=(i=2*zi.RANDOM()-1)*i+(s=2*zi.RANDOM()-1)*s;while(p>=1);do y=(c=2*zi.RANDOM()-1)*c+(h=2*zi.RANDOM()-1)*h;while(y>=1);var v=Math.sqrt((1-p)/y);return t[0]=e*i,t[1]=e*s,t[2]=e*c*v,t[3]=e*h*v,t},yt.transformMat4=function(t,e,i){var s=e[0],c=e[1],h=e[2],p=e[3];return t[0]=i[0]*s+i[4]*c+i[8]*h+i[12]*p,t[1]=i[1]*s+i[5]*c+i[9]*h+i[13]*p,t[2]=i[2]*s+i[6]*c+i[10]*h+i[14]*p,t[3]=i[3]*s+i[7]*c+i[11]*h+i[15]*p,t},yt.transformQuat=function(t,e,i){var s=e[0],c=e[1],h=e[2],p=i[0],y=i[1],v=i[2],T=i[3],E=T*s+y*h-v*c,I=T*c+v*s-p*h,P=T*h+p*c-y*s,R=-p*s-y*c-v*h;return t[0]=E*T+R*-p+I*-v-P*-y,t[1]=I*T+R*-y+P*-p-E*-v,t[2]=P*T+R*-v+E*-y-I*-p,t[3]=e[3],t},yt.zero=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t},yt.str=function(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},yt.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]},yt.equals=function(t,e){var i=t[0],s=t[1],c=t[2],h=t[3],p=e[0],y=e[1],v=e[2],T=e[3];return Math.abs(i-p)<=zi.EPSILON*Math.max(1,Math.abs(i),Math.abs(p))&&Math.abs(s-y)<=zi.EPSILON*Math.max(1,Math.abs(s),Math.abs(y))&&Math.abs(c-v)<=zi.EPSILON*Math.max(1,Math.abs(c),Math.abs(v))&&Math.abs(h-T)<=zi.EPSILON*Math.max(1,Math.abs(h),Math.abs(T))},yt.forEach=yt.sqrLen=yt.len=yt.sqrDist=yt.dist=yt.div=yt.mul=yt.sub=void 0;var zi=function(t,e){if(t&&t.__esModule)return t;if(t===null||$i(t)!=="object"&&typeof t!="function")return{default:t};var i=qi(void 0);if(i&&i.has(t))return i.get(t);var s={},c=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var h in t)if(h!=="default"&&Object.prototype.hasOwnProperty.call(t,h)){var p=c?Object.getOwnPropertyDescriptor(t,h):null;p&&(p.get||p.set)?Object.defineProperty(s,h,p):s[h]=t[h]}return s.default=t,i&&i.set(t,s),s}(Ie);function qi(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,i=new WeakMap;return(qi=function(s){return s?i:e})(t)}function Li(){var t=new zi.ARRAY_TYPE(4);return zi.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function Oi(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t}function Yi(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t[2]=e[2]*i[2],t[3]=e[3]*i[3],t}function yn(t,e,i){return t[0]=e[0]/i[0],t[1]=e[1]/i[1],t[2]=e[2]/i[2],t[3]=e[3]/i[3],t}function nr(t,e){return Math.hypot(e[0]-t[0],e[1]-t[1],e[2]-t[2],e[3]-t[3])}function ln(t,e){var i=e[0]-t[0],s=e[1]-t[1],c=e[2]-t[2],h=e[3]-t[3];return i*i+s*s+c*c+h*h}function Cr(t){return Math.hypot(t[0],t[1],t[2],t[3])}function wr(t){var e=t[0],i=t[1],s=t[2],c=t[3];return e*e+i*i+s*s+c*c}yt.sub=Oi,yt.mul=Yi,yt.div=yn,yt.dist=nr,yt.sqrDist=ln,yt.len=Cr,yt.sqrLen=wr;var ds=function(){var t=Li();return function(e,i,s,c,h,p){var y,v;for(i||(i=4),s||(s=0),v=c?Math.min(c*i+s,e.length):e.length,y=s;y<v;y+=i)t[0]=e[y],t[1]=e[y+1],t[2]=e[y+2],t[3]=e[y+3],h(t,t,p),e[y]=t[0],e[y+1]=t[1],e[y+2]=t[2],e[y+3]=t[3];return e}}();function Un(t){return Un=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Un(t)}yt.forEach=ds,Object.defineProperty(Qt,"__esModule",{value:!0}),Qt.create=mt,Qt.identity=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},Qt.setAxisAngle=_t,Qt.getAxisAngle=function(t,e){var i=2*Math.acos(e[3]),s=Math.sin(i/2);return s>vn.EPSILON?(t[0]=e[0]/s,t[1]=e[1]/s,t[2]=e[2]/s):(t[0]=1,t[1]=0,t[2]=0),i},Qt.getAngle=function(t,e){var i=Qi(t,e);return Math.acos(2*i*i-1)},Qt.multiply=ut,Qt.rotateX=function(t,e,i){i*=.5;var s=e[0],c=e[1],h=e[2],p=e[3],y=Math.sin(i),v=Math.cos(i);return t[0]=s*v+p*y,t[1]=c*v+h*y,t[2]=h*v-c*y,t[3]=p*v-s*y,t},Qt.rotateY=function(t,e,i){i*=.5;var s=e[0],c=e[1],h=e[2],p=e[3],y=Math.sin(i),v=Math.cos(i);return t[0]=s*v-h*y,t[1]=c*v+p*y,t[2]=h*v+s*y,t[3]=p*v-c*y,t},Qt.rotateZ=function(t,e,i){i*=.5;var s=e[0],c=e[1],h=e[2],p=e[3],y=Math.sin(i),v=Math.cos(i);return t[0]=s*v+c*y,t[1]=c*v-s*y,t[2]=h*v+p*y,t[3]=p*v-h*y,t},Qt.calculateW=function(t,e){var i=e[0],s=e[1],c=e[2];return t[0]=i,t[1]=s,t[2]=c,t[3]=Math.sqrt(Math.abs(1-i*i-s*s-c*c)),t},Qt.exp=xt,Qt.ln=dt,Qt.pow=function(t,e,i){return dt(t,e),Rt(t,t,i),xt(t,t),t},Qt.slerp=Xt,Qt.random=function(t){var e=vn.RANDOM(),i=vn.RANDOM(),s=vn.RANDOM(),c=Math.sqrt(1-e),h=Math.sqrt(e);return t[0]=c*Math.sin(2*Math.PI*i),t[1]=c*Math.cos(2*Math.PI*i),t[2]=h*Math.sin(2*Math.PI*s),t[3]=h*Math.cos(2*Math.PI*s),t},Qt.invert=function(t,e){var i=e[0],s=e[1],c=e[2],h=e[3],p=i*i+s*s+c*c+h*h,y=p?1/p:0;return t[0]=-i*y,t[1]=-s*y,t[2]=-c*y,t[3]=h*y,t},Qt.conjugate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},Qt.fromMat3=wi,Qt.fromEuler=function(t,e,i,s){var c=.5*Math.PI/180;e*=c,i*=c,s*=c;var h=Math.sin(e),p=Math.cos(e),y=Math.sin(i),v=Math.cos(i),T=Math.sin(s),E=Math.cos(s);return t[0]=h*v*E-p*y*T,t[1]=p*y*E+h*v*T,t[2]=p*v*T-h*y*E,t[3]=p*v*E+h*y*T,t},Qt.str=function(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"},Qt.setAxes=Qt.sqlerp=Qt.rotationTo=Qt.equals=Qt.exactEquals=Qt.normalize=Qt.sqrLen=Qt.squaredLength=Qt.len=Qt.length=Qt.lerp=Qt.dot=Qt.scale=Qt.mul=Qt.add=Qt.set=Qt.copy=Qt.fromValues=Qt.clone=void 0;var vn=at(Ie),je=at(Kt),Ge=at(Zt),et=at(yt);function ct(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,i=new WeakMap;return(ct=function(s){return s?i:e})(t)}function at(t,e){if(t&&t.__esModule)return t;if(t===null||Un(t)!=="object"&&typeof t!="function")return{default:t};var i=ct(e);if(i&&i.has(t))return i.get(t);var s={},c=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var h in t)if(h!=="default"&&Object.prototype.hasOwnProperty.call(t,h)){var p=c?Object.getOwnPropertyDescriptor(t,h):null;p&&(p.get||p.set)?Object.defineProperty(s,h,p):s[h]=t[h]}return s.default=t,i&&i.set(t,s),s}function mt(){var t=new vn.ARRAY_TYPE(4);return vn.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function _t(t,e,i){i*=.5;var s=Math.sin(i);return t[0]=s*e[0],t[1]=s*e[1],t[2]=s*e[2],t[3]=Math.cos(i),t}function ut(t,e,i){var s=e[0],c=e[1],h=e[2],p=e[3],y=i[0],v=i[1],T=i[2],E=i[3];return t[0]=s*E+p*y+c*T-h*v,t[1]=c*E+p*v+h*y-s*T,t[2]=h*E+p*T+s*v-c*y,t[3]=p*E-s*y-c*v-h*T,t}function xt(t,e){var i=e[0],s=e[1],c=e[2],h=e[3],p=Math.sqrt(i*i+s*s+c*c),y=Math.exp(h),v=p>0?y*Math.sin(p)/p:0;return t[0]=i*v,t[1]=s*v,t[2]=c*v,t[3]=y*Math.cos(p),t}function dt(t,e){var i=e[0],s=e[1],c=e[2],h=e[3],p=Math.sqrt(i*i+s*s+c*c),y=p>0?Math.atan2(p,h)/p:0;return t[0]=i*y,t[1]=s*y,t[2]=c*y,t[3]=.5*Math.log(i*i+s*s+c*c+h*h),t}function Xt(t,e,i,s){var c,h,p,y,v,T=e[0],E=e[1],I=e[2],P=e[3],R=i[0],L=i[1],B=i[2],j=i[3];return(h=T*R+E*L+I*B+P*j)<0&&(h=-h,R=-R,L=-L,B=-B,j=-j),1-h>vn.EPSILON?(c=Math.acos(h),p=Math.sin(c),y=Math.sin((1-s)*c)/p,v=Math.sin(s*c)/p):(y=1-s,v=s),t[0]=y*T+v*R,t[1]=y*E+v*L,t[2]=y*I+v*B,t[3]=y*P+v*j,t}function wi(t,e){var i,s=e[0]+e[4]+e[8];if(s>0)i=Math.sqrt(s+1),t[3]=.5*i,t[0]=(e[5]-e[7])*(i=.5/i),t[1]=(e[6]-e[2])*i,t[2]=(e[1]-e[3])*i;else{var c=0;e[4]>e[0]&&(c=1),e[8]>e[3*c+c]&&(c=2);var h=(c+1)%3,p=(c+2)%3;i=Math.sqrt(e[3*c+c]-e[3*h+h]-e[3*p+p]+1),t[c]=.5*i,t[3]=(e[3*h+p]-e[3*p+h])*(i=.5/i),t[h]=(e[3*h+c]+e[3*c+h])*i,t[p]=(e[3*p+c]+e[3*c+p])*i}return t}Qt.clone=et.clone,Qt.fromValues=et.fromValues,Qt.copy=et.copy,Qt.set=et.set,Qt.add=et.add,Qt.mul=ut;var Rt=et.scale;Qt.scale=Rt;var Qi=et.dot;Qt.dot=Qi,Qt.lerp=et.lerp;var bn=et.length;Qt.length=bn,Qt.len=bn;var tn=et.squaredLength;Qt.squaredLength=tn,Qt.sqrLen=tn;var Pn=et.normalize;Qt.normalize=Pn,Qt.exactEquals=et.exactEquals,Qt.equals=et.equals;var En,Ai,Hr,fs=(En=Ge.create(),Ai=Ge.fromValues(1,0,0),Hr=Ge.fromValues(0,1,0),function(t,e,i){var s=Ge.dot(e,i);return s<-.999999?(Ge.cross(En,Ai,e),Ge.len(En)<1e-6&&Ge.cross(En,Hr,e),Ge.normalize(En,En),_t(t,En,Math.PI),t):s>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(Ge.cross(En,e,i),t[0]=En[0],t[1]=En[1],t[2]=En[2],t[3]=1+s,Pn(t,t))});Qt.rotationTo=fs;var lr,ko,fl=(lr=mt(),ko=mt(),function(t,e,i,s,c,h){return Xt(lr,e,c,h),Xt(ko,i,s,h),Xt(t,lr,ko,2*h*(1-h)),t});Qt.sqlerp=fl;var Pr,rg=(Pr=je.create(),function(t,e,i,s){return Pr[0]=i[0],Pr[3]=i[1],Pr[6]=i[2],Pr[1]=s[0],Pr[4]=s[1],Pr[7]=s[2],Pr[2]=-e[0],Pr[5]=-e[1],Pr[8]=-e[2],Pn(t,wi(t,Pr))});Qt.setAxes=rg;var yi={};function xh(t){return xh=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},xh(t)}Object.defineProperty(yi,"__esModule",{value:!0}),yi.create=function(){var t=new Dr.ARRAY_TYPE(8);return Dr.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0),t[3]=1,t},yi.clone=function(t){var e=new Dr.ARRAY_TYPE(8);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e},yi.fromValues=function(t,e,i,s,c,h,p,y){var v=new Dr.ARRAY_TYPE(8);return v[0]=t,v[1]=e,v[2]=i,v[3]=s,v[4]=c,v[5]=h,v[6]=p,v[7]=y,v},yi.fromRotationTranslationValues=function(t,e,i,s,c,h,p){var y=new Dr.ARRAY_TYPE(8);y[0]=t,y[1]=e,y[2]=i,y[3]=s;var v=.5*c,T=.5*h,E=.5*p;return y[4]=v*s+T*i-E*e,y[5]=T*s+E*t-v*i,y[6]=E*s+v*e-T*t,y[7]=-v*t-T*e-E*i,y},yi.fromRotationTranslation=Hf,yi.fromTranslation=function(t,e){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=.5*e[0],t[5]=.5*e[1],t[6]=.5*e[2],t[7]=0,t},yi.fromRotation=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},yi.fromMat4=function(t,e){var i=Ws.create();Wf.getRotation(i,e);var s=new Dr.ARRAY_TYPE(3);return Wf.getTranslation(s,e),Hf(t,i,s),t},yi.copy=Zf,yi.identity=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t},yi.set=function(t,e,i,s,c,h,p,y,v){return t[0]=e,t[1]=i,t[2]=s,t[3]=c,t[4]=h,t[5]=p,t[6]=y,t[7]=v,t},yi.getDual=function(t,e){return t[0]=e[4],t[1]=e[5],t[2]=e[6],t[3]=e[7],t},yi.setDual=function(t,e){return t[4]=e[0],t[5]=e[1],t[6]=e[2],t[7]=e[3],t},yi.getTranslation=function(t,e){var i=e[4],s=e[5],c=e[6],h=e[7],p=-e[0],y=-e[1],v=-e[2],T=e[3];return t[0]=2*(i*T+h*p+s*v-c*y),t[1]=2*(s*T+h*y+c*p-i*v),t[2]=2*(c*T+h*v+i*y-s*p),t},yi.translate=function(t,e,i){var s=e[0],c=e[1],h=e[2],p=e[3],y=.5*i[0],v=.5*i[1],T=.5*i[2],E=e[4],I=e[5],P=e[6],R=e[7];return t[0]=s,t[1]=c,t[2]=h,t[3]=p,t[4]=p*y+c*T-h*v+E,t[5]=p*v+h*y-s*T+I,t[6]=p*T+s*v-c*y+P,t[7]=-s*y-c*v-h*T+R,t},yi.rotateX=function(t,e,i){var s=-e[0],c=-e[1],h=-e[2],p=e[3],y=e[4],v=e[5],T=e[6],E=e[7],I=y*p+E*s+v*h-T*c,P=v*p+E*c+T*s-y*h,R=T*p+E*h+y*c-v*s,L=E*p-y*s-v*c-T*h;return Ws.rotateX(t,e,i),t[4]=I*(p=t[3])+L*(s=t[0])+P*(h=t[2])-R*(c=t[1]),t[5]=P*p+L*c+R*s-I*h,t[6]=R*p+L*h+I*c-P*s,t[7]=L*p-I*s-P*c-R*h,t},yi.rotateY=function(t,e,i){var s=-e[0],c=-e[1],h=-e[2],p=e[3],y=e[4],v=e[5],T=e[6],E=e[7],I=y*p+E*s+v*h-T*c,P=v*p+E*c+T*s-y*h,R=T*p+E*h+y*c-v*s,L=E*p-y*s-v*c-T*h;return Ws.rotateY(t,e,i),t[4]=I*(p=t[3])+L*(s=t[0])+P*(h=t[2])-R*(c=t[1]),t[5]=P*p+L*c+R*s-I*h,t[6]=R*p+L*h+I*c-P*s,t[7]=L*p-I*s-P*c-R*h,t},yi.rotateZ=function(t,e,i){var s=-e[0],c=-e[1],h=-e[2],p=e[3],y=e[4],v=e[5],T=e[6],E=e[7],I=y*p+E*s+v*h-T*c,P=v*p+E*c+T*s-y*h,R=T*p+E*h+y*c-v*s,L=E*p-y*s-v*c-T*h;return Ws.rotateZ(t,e,i),t[4]=I*(p=t[3])+L*(s=t[0])+P*(h=t[2])-R*(c=t[1]),t[5]=P*p+L*c+R*s-I*h,t[6]=R*p+L*h+I*c-P*s,t[7]=L*p-I*s-P*c-R*h,t},yi.rotateByQuatAppend=function(t,e,i){var s=i[0],c=i[1],h=i[2],p=i[3],y=e[0],v=e[1],T=e[2],E=e[3];return t[0]=y*p+E*s+v*h-T*c,t[1]=v*p+E*c+T*s-y*h,t[2]=T*p+E*h+y*c-v*s,t[3]=E*p-y*s-v*c-T*h,t[4]=(y=e[4])*p+(E=e[7])*s+(v=e[5])*h-(T=e[6])*c,t[5]=v*p+E*c+T*s-y*h,t[6]=T*p+E*h+y*c-v*s,t[7]=E*p-y*s-v*c-T*h,t},yi.rotateByQuatPrepend=function(t,e,i){var s=e[0],c=e[1],h=e[2],p=e[3],y=i[0],v=i[1],T=i[2],E=i[3];return t[0]=s*E+p*y+c*T-h*v,t[1]=c*E+p*v+h*y-s*T,t[2]=h*E+p*T+s*v-c*y,t[3]=p*E-s*y-c*v-h*T,t[4]=s*(E=i[7])+p*(y=i[4])+c*(T=i[6])-h*(v=i[5]),t[5]=c*E+p*v+h*y-s*T,t[6]=h*E+p*T+s*v-c*y,t[7]=p*E-s*y-c*v-h*T,t},yi.rotateAroundAxis=function(t,e,i,s){if(Math.abs(s)<Dr.EPSILON)return Zf(t,e);var c=Math.hypot(i[0],i[1],i[2]);s*=.5;var h=Math.sin(s),p=h*i[0]/c,y=h*i[1]/c,v=h*i[2]/c,T=Math.cos(s),E=e[0],I=e[1],P=e[2],R=e[3];t[0]=E*T+R*p+I*v-P*y,t[1]=I*T+R*y+P*p-E*v,t[2]=P*T+R*v+E*y-I*p,t[3]=R*T-E*p-I*y-P*v;var L=e[4],B=e[5],j=e[6],G=e[7];return t[4]=L*T+G*p+B*v-j*y,t[5]=B*T+G*y+j*p-L*v,t[6]=j*T+G*v+L*y-B*p,t[7]=G*T-L*p-B*y-j*v,t},yi.add=function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t[4]=e[4]+i[4],t[5]=e[5]+i[5],t[6]=e[6]+i[6],t[7]=e[7]+i[7],t},yi.multiply=$f,yi.scale=function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t},yi.lerp=function(t,e,i,s){var c=1-s;return Yf(e,i)<0&&(s=-s),t[0]=e[0]*c+i[0]*s,t[1]=e[1]*c+i[1]*s,t[2]=e[2]*c+i[2]*s,t[3]=e[3]*c+i[3]*s,t[4]=e[4]*c+i[4]*s,t[5]=e[5]*c+i[5]*s,t[6]=e[6]*c+i[6]*s,t[7]=e[7]*c+i[7]*s,t},yi.invert=function(t,e){var i=kc(e);return t[0]=-e[0]/i,t[1]=-e[1]/i,t[2]=-e[2]/i,t[3]=e[3]/i,t[4]=-e[4]/i,t[5]=-e[5]/i,t[6]=-e[6]/i,t[7]=e[7]/i,t},yi.conjugate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=e[7],t},yi.normalize=function(t,e){var i=kc(e);if(i>0){i=Math.sqrt(i);var s=e[0]/i,c=e[1]/i,h=e[2]/i,p=e[3]/i,y=e[4],v=e[5],T=e[6],E=e[7],I=s*y+c*v+h*T+p*E;t[0]=s,t[1]=c,t[2]=h,t[3]=p,t[4]=(y-s*I)/i,t[5]=(v-c*I)/i,t[6]=(T-h*I)/i,t[7]=(E-p*I)/i}return t},yi.str=function(t){return"quat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+")"},yi.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]},yi.equals=function(t,e){var i=t[0],s=t[1],c=t[2],h=t[3],p=t[4],y=t[5],v=t[6],T=t[7],E=e[0],I=e[1],P=e[2],R=e[3],L=e[4],B=e[5],j=e[6],G=e[7];return Math.abs(i-E)<=Dr.EPSILON*Math.max(1,Math.abs(i),Math.abs(E))&&Math.abs(s-I)<=Dr.EPSILON*Math.max(1,Math.abs(s),Math.abs(I))&&Math.abs(c-P)<=Dr.EPSILON*Math.max(1,Math.abs(c),Math.abs(P))&&Math.abs(h-R)<=Dr.EPSILON*Math.max(1,Math.abs(h),Math.abs(R))&&Math.abs(p-L)<=Dr.EPSILON*Math.max(1,Math.abs(p),Math.abs(L))&&Math.abs(y-B)<=Dr.EPSILON*Math.max(1,Math.abs(y),Math.abs(B))&&Math.abs(v-j)<=Dr.EPSILON*Math.max(1,Math.abs(v),Math.abs(j))&&Math.abs(T-G)<=Dr.EPSILON*Math.max(1,Math.abs(T),Math.abs(G))},yi.sqrLen=yi.squaredLength=yi.len=yi.length=yi.dot=yi.mul=yi.setReal=yi.getReal=void 0;var Dr=vh(Ie),Ws=vh(Qt),Wf=vh(Vt);function qf(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,i=new WeakMap;return(qf=function(s){return s?i:e})(t)}function vh(t,e){if(t&&t.__esModule)return t;if(t===null||xh(t)!=="object"&&typeof t!="function")return{default:t};var i=qf(e);if(i&&i.has(t))return i.get(t);var s={},c=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var h in t)if(h!=="default"&&Object.prototype.hasOwnProperty.call(t,h)){var p=c?Object.getOwnPropertyDescriptor(t,h):null;p&&(p.get||p.set)?Object.defineProperty(s,h,p):s[h]=t[h]}return s.default=t,i&&i.set(t,s),s}function Hf(t,e,i){var s=.5*i[0],c=.5*i[1],h=.5*i[2],p=e[0],y=e[1],v=e[2],T=e[3];return t[0]=p,t[1]=y,t[2]=v,t[3]=T,t[4]=s*T+c*v-h*y,t[5]=c*T+h*p-s*v,t[6]=h*T+s*y-c*p,t[7]=-s*p-c*y-h*v,t}function Zf(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t}function $f(t,e,i){var s=e[0],c=e[1],h=e[2],p=e[3],y=i[4],v=i[5],T=i[6],E=i[7],I=e[4],P=e[5],R=e[6],L=e[7],B=i[0],j=i[1],G=i[2],X=i[3];return t[0]=s*X+p*B+c*G-h*j,t[1]=c*X+p*j+h*B-s*G,t[2]=h*X+p*G+s*j-c*B,t[3]=p*X-s*B-c*j-h*G,t[4]=s*E+p*y+c*T-h*v+I*X+L*B+P*G-R*j,t[5]=c*E+p*v+h*y-s*T+P*X+L*j+R*B-I*G,t[6]=h*E+p*T+s*v-c*y+R*X+L*G+I*j-P*B,t[7]=p*E-s*y-c*v-h*T+L*X-I*B-P*j-R*G,t}yi.getReal=Ws.copy,yi.setReal=Ws.copy,yi.mul=$f;var Yf=Ws.dot;yi.dot=Yf;var Qf=Ws.length;yi.length=Qf,yi.len=Qf;var kc=Ws.squaredLength;yi.squaredLength=kc,yi.sqrLen=kc;var ai={};function bh(t){return bh=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},bh(t)}Object.defineProperty(ai,"__esModule",{value:!0}),ai.create=Kf,ai.clone=function(t){var e=new Ro.ARRAY_TYPE(2);return e[0]=t[0],e[1]=t[1],e},ai.fromValues=function(t,e){var i=new Ro.ARRAY_TYPE(2);return i[0]=t,i[1]=e,i},ai.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t},ai.set=function(t,e,i){return t[0]=e,t[1]=i,t},ai.add=function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t},ai.subtract=Jf,ai.multiply=ep,ai.divide=tp,ai.ceil=function(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t},ai.floor=function(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t},ai.min=function(t,e,i){return t[0]=Math.min(e[0],i[0]),t[1]=Math.min(e[1],i[1]),t},ai.max=function(t,e,i){return t[0]=Math.max(e[0],i[0]),t[1]=Math.max(e[1],i[1]),t},ai.round=function(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t},ai.scale=function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t},ai.scaleAndAdd=function(t,e,i,s){return t[0]=e[0]+i[0]*s,t[1]=e[1]+i[1]*s,t},ai.distance=ip,ai.squaredDistance=np,ai.length=rp,ai.squaredLength=Rc,ai.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t},ai.inverse=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t},ai.normalize=function(t,e){var i=e[0],s=e[1],c=i*i+s*s;return c>0&&(c=1/Math.sqrt(c)),t[0]=e[0]*c,t[1]=e[1]*c,t},ai.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]},ai.cross=function(t,e,i){var s=e[0]*i[1]-e[1]*i[0];return t[0]=t[1]=0,t[2]=s,t},ai.lerp=function(t,e,i,s){var c=e[0],h=e[1];return t[0]=c+s*(i[0]-c),t[1]=h+s*(i[1]-h),t},ai.random=function(t,e){e=e||1;var i=2*Ro.RANDOM()*Math.PI;return t[0]=Math.cos(i)*e,t[1]=Math.sin(i)*e,t},ai.transformMat2=function(t,e,i){var s=e[0],c=e[1];return t[0]=i[0]*s+i[2]*c,t[1]=i[1]*s+i[3]*c,t},ai.transformMat2d=function(t,e,i){var s=e[0],c=e[1];return t[0]=i[0]*s+i[2]*c+i[4],t[1]=i[1]*s+i[3]*c+i[5],t},ai.transformMat3=function(t,e,i){var s=e[0],c=e[1];return t[0]=i[0]*s+i[3]*c+i[6],t[1]=i[1]*s+i[4]*c+i[7],t},ai.transformMat4=function(t,e,i){var s=e[0],c=e[1];return t[0]=i[0]*s+i[4]*c+i[12],t[1]=i[1]*s+i[5]*c+i[13],t},ai.rotate=function(t,e,i,s){var c=e[0]-i[0],h=e[1]-i[1],p=Math.sin(s),y=Math.cos(s);return t[0]=c*y-h*p+i[0],t[1]=c*p+h*y+i[1],t},ai.angle=function(t,e){var i=t[0],s=t[1],c=e[0],h=e[1],p=Math.sqrt(i*i+s*s)*Math.sqrt(c*c+h*h);return Math.acos(Math.min(Math.max(p&&(i*c+s*h)/p,-1),1))},ai.zero=function(t){return t[0]=0,t[1]=0,t},ai.str=function(t){return"vec2("+t[0]+", "+t[1]+")"},ai.exactEquals=function(t,e){return t[0]===e[0]&&t[1]===e[1]},ai.equals=function(t,e){var i=t[0],s=t[1],c=e[0],h=e[1];return Math.abs(i-c)<=Ro.EPSILON*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(s-h)<=Ro.EPSILON*Math.max(1,Math.abs(s),Math.abs(h))},ai.forEach=ai.sqrLen=ai.sqrDist=ai.dist=ai.div=ai.mul=ai.sub=ai.len=void 0;var Ro=function(t,e){if(t&&t.__esModule)return t;if(t===null||bh(t)!=="object"&&typeof t!="function")return{default:t};var i=Xf(void 0);if(i&&i.has(t))return i.get(t);var s={},c=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var h in t)if(h!=="default"&&Object.prototype.hasOwnProperty.call(t,h)){var p=c?Object.getOwnPropertyDescriptor(t,h):null;p&&(p.get||p.set)?Object.defineProperty(s,h,p):s[h]=t[h]}return s.default=t,i&&i.set(t,s),s}(Ie);function Xf(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,i=new WeakMap;return(Xf=function(s){return s?i:e})(t)}function Kf(){var t=new Ro.ARRAY_TYPE(2);return Ro.ARRAY_TYPE!=Float32Array&&(t[0]=0,t[1]=0),t}function Jf(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t}function ep(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t}function tp(t,e,i){return t[0]=e[0]/i[0],t[1]=e[1]/i[1],t}function ip(t,e){return Math.hypot(e[0]-t[0],e[1]-t[1])}function np(t,e){var i=e[0]-t[0],s=e[1]-t[1];return i*i+s*s}function rp(t){return Math.hypot(t[0],t[1])}function Rc(t){var e=t[0],i=t[1];return e*e+i*i}ai.len=rp,ai.sub=Jf,ai.mul=ep,ai.div=tp,ai.dist=ip,ai.sqrDist=np,ai.sqrLen=Rc;var sg=function(){var t=Kf();return function(e,i,s,c,h,p){var y,v;for(i||(i=2),s||(s=0),v=c?Math.min(c*i+s,e.length):e.length,y=s;y<v;y+=i)t[0]=e[y],t[1]=e[y+1],h(t,t,p),e[y]=t[0],e[y+1]=t[1];return e}}();function zc(t){return zc=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},zc(t)}ai.forEach=sg,Object.defineProperty(Me,"__esModule",{value:!0}),r.aa=Me.vec4=r.Q=Me.vec3=Me.vec2=Me.quat2=r.bl=Me.quat=r.a9=Me.mat4=r.ct=Me.mat3=Me.mat2d=r.b7=Me.mat2=Me.glMatrix=void 0;var og=Ds(Ie);Me.glMatrix=og;var ag=Ds(ht);r.b7=Me.mat2=ag;var lg=Ds(wt);Me.mat2d=lg;var jt=Ds(Kt);r.ct=Me.mat3=jt;var wh=Ds(Vt);r.a9=Me.mat4=wh;var ei=Ds(Qt);r.bl=Me.quat=ei;var Lc=Ds(yi);Me.quat2=Lc;var pi=Ds(ai);Me.vec2=pi;var Th=Ds(Zt);r.Q=Me.vec3=Th;var Mh=Ds(yt);function Yt(t){if(typeof WeakMap!="function")return null;var e=new WeakMap,i=new WeakMap;return(Yt=function(s){return s?i:e})(t)}function Ds(t,e){if(t&&t.__esModule)return t;if(t===null||zc(t)!=="object"&&typeof t!="function")return{default:t};var i=Yt(e);if(i&&i.has(t))return i.get(t);var s={},c=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var h in t)if(h!=="default"&&Object.prototype.hasOwnProperty.call(t,h)){var p=c?Object.getOwnPropertyDescriptor(t,h):null;p&&(p.get||p.set)?Object.defineProperty(s,h,p):s[h]=t[h]}return s.default=t,i&&i.set(t,s),s}r.aa=Me.vec4=Mh;var cg=zo;function zo(t,e,i,s){this.cx=3*t,this.bx=3*(i-t)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(s-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=t,this.p1y=e,this.p2x=i,this.p2y=s}zo.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(t,e){if(e===void 0&&(e=1e-6),t<0)return 0;if(t>1)return 1;for(var i=t,s=0;s<8;s++){var c=this.sampleCurveX(i)-t;if(Math.abs(c)<e)return i;var h=this.sampleCurveDerivativeX(i);if(Math.abs(h)<1e-6)break;i-=c/h}var p=0,y=1;for(i=t,s=0;s<20&&(c=this.sampleCurveX(i),!(Math.abs(c-t)<e));s++)t>c?p=i:y=i,i=.5*(y-p)+p;return i},solve:function(t,e){return this.sampleCurveY(this.solveCurveX(t,e))}};var sp=Ee(cg),Oc=ps;function ps(t,e){this.x=t,this.y=e}ps.prototype={clone:function(){return new ps(this.x,this.y)},add:function(t){return this.clone()._add(t)},sub:function(t){return this.clone()._sub(t)},multByPoint:function(t){return this.clone()._multByPoint(t)},divByPoint:function(t){return this.clone()._divByPoint(t)},mult:function(t){return this.clone()._mult(t)},div:function(t){return this.clone()._div(t)},rotate:function(t){return this.clone()._rotate(t)},rotateAround:function(t,e){return this.clone()._rotateAround(t,e)},matMult:function(t){return this.clone()._matMult(t)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var e=t.x-this.x,i=t.y-this.y;return e*e+i*i},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},_matMult:function(t){var e=t[2]*this.x+t[3]*this.y;return this.x=t[0]*this.x+t[1]*this.y,this.y=e,this},_add:function(t){return this.x+=t.x,this.y+=t.y,this},_sub:function(t){return this.x-=t.x,this.y-=t.y,this},_mult:function(t){return this.x*=t,this.y*=t,this},_div:function(t){return this.x/=t,this.y/=t,this},_multByPoint:function(t){return this.x*=t.x,this.y*=t.y,this},_divByPoint:function(t){return this.x/=t.x,this.y/=t.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var t=this.y;return this.y=this.x,this.x=-t,this},_rotate:function(t){var e=Math.cos(t),i=Math.sin(t),s=i*this.x+e*this.y;return this.x=e*this.x-i*this.y,this.y=s,this},_rotateAround:function(t,e){var i=Math.cos(t),s=Math.sin(t),c=e.y+s*(this.x-e.x)+i*(this.y-e.y);return this.x=e.x+i*(this.x-e.x)-s*(this.y-e.y),this.y=c,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},ps.convert=function(t){return t instanceof ps?t:Array.isArray(t)?new ps(t[0],t[1]):t};var ft=Ee(Oc);const Sh=Math.PI/180,Eh=180/Math.PI;function Si(t){return t*Sh}function kr(t){return t*Eh}const op=[[0,0],[1,0],[1,1],[0,1]];function Fc(t){if(t<=0)return 0;if(t>=1)return 1;const e=t*t,i=e*t;return 4*(t<.5?i:3*(t-e)+i-.75)}function ap(t,e,i,s){const c=new sp(t,e,i,s);return function(h){return c.solve(h)}}const ms=ap(.25,.1,.25,1);function xi(t,e,i){return Math.min(i,Math.max(e,t))}function pl(t,e,i){return(i=xi((i-t)/(e-t),0,1))*i*(3-2*i)}function qs(t,e,i){const s=i-e,c=((t-e)%s+s)%s+e;return c===e?i:c}function Ah(t,e,i){if(!t.length)return i(null,[]);let s=t.length;const c=new Array(t.length);let h=null;t.forEach((p,y)=>{e(p,(v,T)=>{v&&(h=v),c[y]=T,--s==0&&i(h,c)})})}function Jr(t,...e){for(const i of e)for(const s in i)t[s]=i[s];return t}let lp=1;function Di(){return lp++}function Bc(){return function t(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,t)}()}function Ih(t){return t<=1?1:Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))}function cp(t){return!!t&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(t)}function Ch(t,e){t.forEach(i=>{e[i]&&(e[i]=e[i].bind(e))})}function Lo(t,e){return t.indexOf(e,t.length-e.length)!==-1}function pa(t,e,i){const s={};for(const c in t)s[c]=e.call(this,t[c],c,t);return s}function ml(t,e,i){const s={};for(const c in t)e.call(this,t[c],c,t)&&(s[c]=t[c]);return s}function Hs(t){return Array.isArray(t)?t.map(Hs):typeof t=="object"&&t?pa(t,Hs):t}const Ph={};function wn(t){Ph[t]||(typeof console<"u"&&console.warn(t),Ph[t]=!0)}function ho(t,e,i){return(i.y-t.y)*(e.x-t.x)>(e.y-t.y)*(i.x-t.x)}function _l(t){let e=0;for(let i,s,c=0,h=t.length,p=h-1;c<h;p=c++)i=t[c],s=t[p],e+=(s.x-i.x)*(i.y+s.y);return e}function gl([t,e,i]){const s=Si(e+90),c=Si(i);return{x:t*Math.cos(s)*Math.sin(c),y:t*Math.sin(s)*Math.sin(c),z:t*Math.cos(c),azimuthal:e,polar:i}}function Zs(){return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope}function Zr(t){const e={};if(t.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(i,s,c,h)=>{const p=c||h;return e[s]=!p||p.toLowerCase(),""}),e["max-age"]){const i=parseInt(e["max-age"],10);isNaN(i)?delete e["max-age"]:e["max-age"]=i}return e}let Nc,Vc,Uc,yl,fo,ma,jc=null;function Dh(t){try{const e=self[t];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}}function Oo(t,e){return[t[4*e],t[4*e+1],t[4*e+2],t[4*e+3]]}function Fo(t,e,i,s){for(;e<i;){const c=e+i>>1;t[c]<s?e=c+1:i=c}return e}function kh(t,e,i,s){for(;e<i;){const c=e+i>>1;t[c]<=s?e=c+1:i=c}return e}function _s(t){return t>0?1/(1.001-t):1+t}function up(t){return t>0?1-1/(1.001-t):-t}function Gc(){return Nc==null&&(Nc=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),Nc}const ks={now:()=>yl!==void 0?yl:performance.now(),setNow(t){yl=t},restoreNow(){yl=void 0},frame(t){const e=requestAnimationFrame(t);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(t,e=0){const{width:i,height:s}=t;fo||(fo=document.createElement("canvas"));const c=fo.getContext("2d",{willReadFrequently:!0});if(!c)throw new Error("failed to create canvas 2d context");return(i>fo.width||s>fo.height)&&(fo.width=i,fo.height=s),c.clearRect(-e,-e,i+2*e,s+2*e),c.drawImage(t,0,0,i,s),c.getImageData(-e,-e,i+2*e,s+2*e)},resolveURL:t=>(Vc||(Vc=document.createElement("a")),Vc.href=t,Vc.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(Uc==null&&(Uc=window.matchMedia("(prefers-reduced-motion: reduce)")),Uc.matches)},hasCanvasFingerprintNoise(){if(ma!==void 0)return ma;if(!Gc())return ma=!1,!1;const t=new OffscreenCanvas(85,1),e=t.getContext("2d",{willReadFrequently:!0});let i=0;for(let c=0;c<t.width;++c)e.fillStyle=`rgba(${i++},${i++},${i++}, 255)`,e.fillRect(c,0,1,1);const s=e.getImageData(0,0,t.width,t.height);i=0;for(let c=0;c<s.data.length;++c)if(c%4!=3&&i++!==s.data[c])return ma=!0,!0;return ma=!1,!1}};function Wc(t,e){const i=t.indexOf("?");if(i<0)return`${t}?${new URLSearchParams(e).toString()}`;const s=new URLSearchParams(t.slice(i));for(const c in e)s.set(c,e[c]);return`${t.slice(0,i)}?${s.toString()}`}function qc(t,e={persistentParams:[]}){const i=t.indexOf("?");if(i<0)return t;const s=new URLSearchParams,c=new URLSearchParams(t.slice(i));for(const p of e.persistentParams){const y=c.get(p);y&&s.set(p,y)}const h=s.toString();return`${t.slice(0,i)}${h.length>0?`?${h}`:""}`}const _a="mapbox-tiles";let Hc=500,hp=50,$s,Zc;function Rh(){try{return caches}catch{}}function ga(){const t=Rh();t&&!$s&&($s=t.open(_a))}let zh=1/0;const Bo={supported:!1,testSupport:function(t){!Lh&&ya&&(dp?pp(t):xl=t)}};let xl,ya,Lh=!1,dp=!1;const fp=typeof self<"u"?self:{};function pp(t){const e=t.createTexture();t.bindTexture(t.TEXTURE_2D,e);try{if(t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,ya),t.isContextLost())return;Bo.supported=!0}catch{}t.deleteTexture(e),Lh=!0}fp.document&&(ya=fp.document.createElement("img"),ya.onload=function(){xl&&pp(xl),xl=null,dp=!0},ya.onerror=function(){Lh=!0,xl=null},ya.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const $c={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze($c);class Yc extends Error{constructor(e,i,s){i===401&&W(s)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=i,this.url=s}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const xa=Zs()?()=>self.worker&&self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,vl=function(t,e){if(!(/^file:/.test(i=t.url)||/^file:/.test(xa())&&!/^\w+:/.test(i))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(s,c){const h=new AbortController,p=new Request(s.url,{method:s.method||"GET",body:s.body,credentials:s.credentials,headers:s.headers,referrer:xa(),referrerPolicy:s.referrerPolicy,signal:h.signal});let y=!1,v=!1;const T=(E=p.url).indexOf("sku=")>0&&W(E);var E;s.type==="json"&&p.headers.set("Accept","application/json");const I=(R,L,B)=>{if(v)return;if(R&&R.message!=="SecurityError"&&wn(R.toString()),L&&B)return P(L);const j=Date.now();fetch(p).then(G=>{if(G.ok){const X=T?G.clone():null;return P(G,X,j)}return c(new Yc(G.statusText,G.status,s.url))}).catch(G=>{G.name!=="AbortError"&&c(new Error(`${G.message} ${s.url}`))})},P=(R,L,B)=>{(s.type==="arrayBuffer"?R.arrayBuffer():s.type==="json"?R.json():R.text()).then(j=>{v||(L&&B&&function(G,X,ie){if(ga(),!$s)return;const J=Zr(X.headers.get("Cache-Control")||"");if(J["no-store"])return;const he={status:X.status,statusText:X.statusText,headers:new Headers};X.headers.forEach((_e,Se)=>he.headers.set(Se,_e)),J["max-age"]&&he.headers.set("Expires",new Date(ie+1e3*J["max-age"]).toUTCString());const re=he.headers.get("Expires");if(!re||new Date(re).getTime()-ie<42e4)return;let pe=qc(G.url,{persistentParams:["language","worldview"]});if(X.status===206){const _e=G.headers.get("Range");if(!_e)return;he.status=200,pe=Wc(pe,{range:_e})}(function(_e,Se){if(Zc===void 0)try{new Response(new ReadableStream),Zc=!0}catch{Zc=!1}Zc?Se(_e.body):_e.blob().then(Se)})(X,_e=>{const Se=new Response(_e,he);ga(),$s&&$s.then(Le=>Le.put(pe,Se)).catch(Le=>wn(Le.message))})}(p,L,B),y=!0,c(null,j,R.headers.get("Cache-Control"),R.headers.get("Expires")))}).catch(j=>{v||c(new Error(j.message))})};return T?function(R,L){if(ga(),!$s)return L(null);$s.then(B=>{let j=qc(R.url,{persistentParams:["language","worldview"]});const G=R.headers.get("Range");G&&(j=Wc(j,{range:G})),B.match(j).then(X=>{const ie=function(J){if(!J)return!1;const he=new Date(J.headers.get("Expires")||0),re=Zr(J.headers.get("Cache-Control")||"");return he>Date.now()&&!re["no-cache"]}(X);B.delete(j),ie&&B.put(j,X.clone()),L(null,X,ie)}).catch(L)}).catch(L)}(p,I):I(null,null),{cancel:()=>{v=!0,y||h.abort()}}}(t,e);if(Zs()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",t,e,void 0,!0)}var i;return function(s,c){const h=new XMLHttpRequest;h.open(s.method||"GET",s.url,!0),s.type==="arrayBuffer"&&(h.responseType="arraybuffer");for(const p in s.headers)h.setRequestHeader(p,s.headers[p]);return s.type==="json"&&(h.responseType="text",h.setRequestHeader("Accept","application/json")),h.withCredentials=s.credentials==="include",h.onerror=()=>{c(new Error(h.statusText))},h.onload=()=>{if((h.status>=200&&h.status<300||h.status===0)&&h.response!==null){let p=h.response;if(s.type==="json")try{p=JSON.parse(h.response)}catch(y){return c(y)}c(null,p,h.getResponseHeader("Cache-Control"),h.getResponseHeader("Expires"))}else c(new Yc(h.statusText,h.status,s.url))},h.send(s.body),{cancel:()=>h.abort()}}(t,e)},bl=function(t,e){return vl(Jr(t,{type:"arrayBuffer"}),e)};function Oh(t){const e=document.createElement("a");return e.href=t,e.protocol===location.protocol&&e.host===location.host}const mp="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let Qc,wl;Qc=[],wl=0;const Fh=function(t,e){if(Bo.supported&&(t.headers||(t.headers={}),t.headers.accept="image/webp,*/*"),wl>=N.MAX_PARALLEL_IMAGE_REQUESTS){const h={requestParameters:t,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return Qc.push(h),h}wl++;let i=!1;const s=()=>{if(!i)for(i=!0,wl--;Qc.length&&wl<N.MAX_PARALLEL_IMAGE_REQUESTS;){const h=Qc.shift(),{requestParameters:p,callback:y,cancelled:v}=h;v||(h.cancel=Fh(p,y).cancel)}},c=bl(t,(h,p,y,v)=>{s(),h?e(h):p&&(self.createImageBitmap?function(T,E){const I=new Blob([new Uint8Array(T)],{type:"image/png"});createImageBitmap(I).then(P=>{E(null,P)}).catch(P=>{E(new Error(`Could not load image because of ${P.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(p,(T,E)=>e(T,E,y,v)):function(T,E){const I=new Image;I.onload=()=>{E(null,I),URL.revokeObjectURL(I.src),I.onload=null,requestAnimationFrame(()=>{I.src=mp})},I.onerror=()=>E(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const P=new Blob([new Uint8Array(T)],{type:"image/png"});I.src=T.byteLength?URL.createObjectURL(P):mp}(p,(T,E)=>e(T,E,y,v)))});return{cancel:()=>{c.cancel(),s()}}},Tl="01",Xc="NO_ACCESS_TOKEN",Bh=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function gs(t){const e=t.match(Bh);if(!e)throw new Error("Unable to parse URL object");return{protocol:e[1],authority:e[2],path:e[3]||"/",params:e[4]?e[4].split("&"):[]}}function va(t){const e=t.params.length?`?${t.params.join("&")}`:"";return`${t.protocol}://${t.authority}${t.path}${e}`}const Ml="mapbox.eventData";function Nh(t){if(!t)return null;const e=t.split(".");if(!e||e.length!==3)return null;try{return JSON.parse(decodeURIComponent(atob(e[1]).split("").map(i=>"%"+("00"+i.charCodeAt(0).toString(16)).slice(-2)).join("")))}catch{return null}}class ba{constructor(e){this.type=e,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(e){const i=Nh(N.ACCESS_TOKEN);let s="";return s=i&&i.u?btoa(encodeURIComponent(i.u).replace(/%([0-9A-F]{2})/g,(c,h)=>String.fromCharCode(+("0x"+h)))):N.ACCESS_TOKEN||"",e?`${Ml}.${e}:${s}`:`${Ml}:${s}`}fetchEventData(){const e=Dh("localStorage"),i=this.getStorageKey(),s=this.getStorageKey("uuid");if(e)try{const c=localStorage.getItem(i);c&&(this.eventData=JSON.parse(c));const h=localStorage.getItem(s);h&&(this.anonId=h)}catch{wn("Unable to read from LocalStorage")}}saveEventData(){const e=Dh("localStorage"),i=this.getStorageKey(),s=this.getStorageKey("uuid"),c=this.anonId;if(e&&c)try{localStorage.setItem(s,c),Object.keys(this.eventData).length>=1&&localStorage.setItem(i,JSON.stringify(this.eventData))}catch{wn("Unable to write to LocalStorage")}}processRequests(e){}postEvent(e,i,s,c){if(!N.EVENTS_URL)return;const h=gs(N.EVENTS_URL);h.params.push(`access_token=${c||N.ACCESS_TOKEN||""}`);const p={event:this.type,created:new Date(e).toISOString()},y=i?Jr(p,i):p,v={url:va(h),headers:{"Content-Type":"text/plain"},body:JSON.stringify([y])};this.pendingRequest=function(T,E){return vl(Jr(T,{method:"POST"}),E)}(v,T=>{this.pendingRequest=null,s(T),this.saveEventData(),this.processRequests(c)})}queueRequest(e,i){this.queue.push(e),this.processRequests(i)}}const Kc=new class extends ba{constructor(t){super("appUserTurnstile"),this._customAccessToken=t}postTurnstileEvent(t,e){N.EVENTS_URL&&N.ACCESS_TOKEN&&Array.isArray(t)&&t.some(i=>Q(i)||W(i))&&this.queueRequest(Date.now(),e)}processRequests(t){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const e=Nh(N.ACCESS_TOKEN),i=e?e.u:N.ACCESS_TOKEN;let s=i!==this.eventData.tokenU;cp(this.anonId)||(this.anonId=Bc(),s=!0);const c=this.queue.shift();if(this.eventData.lastSuccess){const h=new Date(this.eventData.lastSuccess),p=new Date(c),y=(c-this.eventData.lastSuccess)/864e5;s=s||y>=1||y<-1||h.getDate()!==p.getDate()}else s=!0;s?this.postEvent(c,{sdkIdentifier:"mapbox-gl-js",sdkVersion:k,skuId:Tl,"enabled.telemetry":!1,userId:this.anonId},h=>{h||(this.eventData.lastSuccess=c,this.eventData.tokenU=i)},t):this.processRequests()}},Or=Kc.postTurnstileEvent.bind(Kc),po=new class extends ba{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(t,e,i,s){this.skuToken=e,this.errorCb=s,N.EVENTS_URL&&(i||N.ACCESS_TOKEN?this.queueRequest({id:t,timestamp:Date.now()},i):this.errorCb(new Error(Xc)))}processRequests(t){if(this.pendingRequest||this.queue.length===0)return;const{id:e,timestamp:i}=this.queue.shift();e&&this.success[e]||(this.anonId||this.fetchEventData(),cp(this.anonId)||(this.anonId=Bc()),this.postEvent(i,{sdkIdentifier:"mapbox-gl-js",sdkVersion:k,skuId:Tl,skuToken:this.skuToken,userId:this.anonId},s=>{s?this.errorCb(s):e&&(this.success[e]=!0)},t))}remove(){this.errorCb=null}},Fr=po.postMapLoadEvent.bind(po),_p=new class extends ba{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(t){let e=this.mapInstanceIdMap.get(t);return e||(e=Bc(),this.mapInstanceIdMap.set(t,e)),e}getEventId(t){const e=this.eventIdPerMapInstanceMap.get(t)||0;return this.eventIdPerMapInstanceMap.set(t,e+1),e}postStyleLoadEvent(t,e){const{map:i,style:s,importedStyles:c}=e;if(!N.EVENTS_URL||!t&&!N.ACCESS_TOKEN)return;const h=this.getMapInstanceId(i),p={mapInstanceId:h,eventId:this.getEventId(h),style:s};c.length&&(p.importedStyles=c),this.queueRequest({timestamp:Date.now(),payload:p},t)}processRequests(t){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:e,payload:i}=this.queue.shift();this.postEvent(e,i,()=>{},t)}},ug=_p.postStyleLoadEvent.bind(_p),gp=new class extends ba{constructor(){super("gljs.performance")}postPerformanceEvent(t,e){N.EVENTS_URL&&(t||N.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:e},t)}processRequests(t){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:e,performanceData:i}=this.queue.shift(),s=function(c){const h=performance.getEntriesByType("resource"),p=performance.getEntriesByType("mark"),y=function(R){const L={};if(R){for(const B in R)if(B!=="other")for(const j of R[B]){const G=`${B}ResolveRangeMin`,X=`${B}ResolveRangeMax`,ie=`${B}RequestCount`,J=`${B}RequestCachedCount`;L[G]=Math.min(L[G]||1/0,j.startTime),L[X]=Math.max(L[X]||-1/0,j.responseEnd);const he=re=>{L[re]===void 0&&(L[re]=0),++L[re]};j.transferSize!==void 0&&j.transferSize===0&&he(J),he(ie)}}return L}(function(R,L){const B={};if(R)for(const j of R){const G=L(j);B[G]===void 0&&(B[G]=[]),B[G].push(j)}return B}(h,Te)),v=window.devicePixelRatio,T=navigator.connection||navigator.mozConnection||navigator.webkitConnection,E=T?T.effectiveType:void 0,I={counters:[],metadata:[],attributes:[]},P=(R,L,B)=>{B!=null&&R.push({name:L,value:B.toString()})};for(const R in y)P(I.counters,R,y[R]);if(c.interactionRange[0]!==1/0&&c.interactionRange[1]!==-1/0&&(P(I.counters,"interactionRangeMin",c.interactionRange[0]),P(I.counters,"interactionRangeMax",c.interactionRange[1])),p)for(const R of Object.keys(ve)){const L=ve[R],B=p.find(j=>j.name===L);B&&P(I.counters,L,B.startTime)}return P(I.counters,"visibilityHidden",c.visibilityHidden),P(I.attributes,"style",function(R){if(R)for(const L of R){const B=L.name.split("?")[0];if(de(B)){const j=B.split("/").slice(-2);if(j.length===2)return`mapbox://styles/${j[0]}/${j[1]}`}}}(h)),P(I.attributes,"terrainEnabled",c.terrainEnabled?"true":"false"),P(I.attributes,"fogEnabled",c.fogEnabled?"true":"false"),P(I.attributes,"projection",c.projection),P(I.attributes,"zoom",c.zoom),P(I.metadata,"devicePixelRatio",v),P(I.metadata,"connectionEffectiveType",E),P(I.metadata,"navigatorUserAgent",navigator.userAgent),P(I.metadata,"screenWidth",window.screen.width),P(I.metadata,"screenHeight",window.screen.height),P(I.metadata,"windowWidth",window.innerWidth),P(I.metadata,"windowHeight",window.innerHeight),P(I.metadata,"mapWidth",c.width/v),P(I.metadata,"mapHeight",c.height/v),P(I.metadata,"webglRenderer",c.renderer),P(I.metadata,"webglVendor",c.vendor),P(I.metadata,"sdkVersion",k),P(I.metadata,"sdkIdentifier","mapbox-gl-js"),I}(i);for(const c of s.metadata);for(const c of s.counters);for(const c of s.attributes);this.postEvent(e,s,()=>{},t)}},Jc=gp.postPerformanceEvent.bind(gp),eu=new class extends ba{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(t,e,i,s){if(!N.API_URL||!N.SESSION_PATH)return;const c=gs(N.API_URL+N.SESSION_PATH);c.params.push(`sku=${e||""}`),c.params.push(`access_token=${s||N.ACCESS_TOKEN||""}`);const h={url:va(c),headers:{"Content-Type":"text/plain"}};this.pendingRequest=function(p,y){return vl(Jr(p,{method:"GET"}),y)}(h,p=>{this.pendingRequest=null,i(p),this.saveEventData(),this.processRequests(s)})}getSessionAPI(t,e,i,s){this.skuToken=e,this.errorCb=s,N.SESSION_PATH&&N.API_URL&&(i||N.ACCESS_TOKEN?this.queueRequest({id:t,timestamp:Date.now()},i):this.errorCb(new Error(Xc)))}processRequests(t){if(this.pendingRequest||this.queue.length===0)return;const{id:e,timestamp:i}=this.queue.shift();e&&this.success[e]||this.getSession(i,this.skuToken,s=>{s?this.errorCb(s):e&&(this.success[e]=!0)},t)}remove(){this.errorCb=null}},Vh=eu.getSessionAPI.bind(eu),tu=new Set;var Rs={exports:{}},yp={exports:{}};yp.exports=function(t,e){var i,s,c,h,p,y,v,T;for(s=t.length-(i=3&t.length),c=e,p=3432918353,y=461845907,T=0;T<s;)v=255&t.charCodeAt(T)|(255&t.charCodeAt(++T))<<8|(255&t.charCodeAt(++T))<<16|(255&t.charCodeAt(++T))<<24,++T,c=27492+(65535&(h=5*(65535&(c=(c^=v=(65535&(v=(v=(65535&v)*p+(((v>>>16)*p&65535)<<16)&4294967295)<<15|v>>>17))*y+(((v>>>16)*y&65535)<<16)&4294967295)<<13|c>>>19))+((5*(c>>>16)&65535)<<16)&4294967295))+((58964+(h>>>16)&65535)<<16);switch(v=0,i){case 3:v^=(255&t.charCodeAt(T+2))<<16;case 2:v^=(255&t.charCodeAt(T+1))<<8;case 1:c^=v=(65535&(v=(v=(65535&(v^=255&t.charCodeAt(T)))*p+(((v>>>16)*p&65535)<<16)&4294967295)<<15|v>>>17))*y+(((v>>>16)*y&65535)<<16)&4294967295}return c^=t.length,c=2246822507*(65535&(c^=c>>>16))+((2246822507*(c>>>16)&65535)<<16)&4294967295,c=3266489909*(65535&(c^=c>>>13))+((3266489909*(c>>>16)&65535)<<16)&4294967295,(c^=c>>>16)>>>0};var hg=yp.exports,Uh={exports:{}};Uh.exports=function(t,e){for(var i,s=t.length,c=e^s,h=0;s>=4;)i=1540483477*(65535&(i=255&t.charCodeAt(h)|(255&t.charCodeAt(++h))<<8|(255&t.charCodeAt(++h))<<16|(255&t.charCodeAt(++h))<<24))+((1540483477*(i>>>16)&65535)<<16),c=1540483477*(65535&c)+((1540483477*(c>>>16)&65535)<<16)^(i=1540483477*(65535&(i^=i>>>24))+((1540483477*(i>>>16)&65535)<<16)),s-=4,++h;switch(s){case 3:c^=(255&t.charCodeAt(h+2))<<16;case 2:c^=(255&t.charCodeAt(h+1))<<8;case 1:c=1540483477*(65535&(c^=255&t.charCodeAt(h)))+((1540483477*(c>>>16)&65535)<<16)}return c=1540483477*(65535&(c^=c>>>13))+((1540483477*(c>>>16)&65535)<<16),(c^=c>>>15)>>>0};var jh=hg,ys=Uh.exports;Rs.exports=jh,Rs.exports.murmur3=jh,Rs.exports.murmur2=ys;var Sl=Ee(Rs.exports);function Gh(t,e,i){i[t]&&i[t].indexOf(e)!==-1||(i[t]=i[t]||[],i[t].push(e))}function iu(t,e,i){if(i&&i[t]){const s=i[t].indexOf(e);s!==-1&&i[t].splice(s,1)}}class mo{constructor(e,i={}){Jr(this,i),this.type=e}}class nu extends mo{constructor(e,i={}){super("error",Jr({error:e},i))}}class No{on(e,i){return this._listeners=this._listeners||{},Gh(e,i,this._listeners),this}off(e,i){return iu(e,i,this._listeners),iu(e,i,this._oneTimeListeners),this}once(e,i){return i?(this._oneTimeListeners=this._oneTimeListeners||{},Gh(e,i,this._oneTimeListeners),this):new Promise(s=>this.once(e,s))}fire(e,i){typeof e=="string"&&(e=new mo(e,i||{}));const s=e.type;if(this.listens(s)){e.target=this;const c=this._listeners&&this._listeners[s]?this._listeners[s].slice():[];for(const y of c)y.call(this,e);const h=this._oneTimeListeners&&this._oneTimeListeners[s]?this._oneTimeListeners[s].slice():[];for(const y of h)iu(s,y,this._oneTimeListeners),y.call(this,e);const p=this._eventedParent;p&&(Jr(e,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),p.fire(e))}else e instanceof nu&&console.error(e.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,i){return this._eventedParent=e,this._eventedParentData=i,this}}r.z=void 0;var Wh={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function El(t){return(t=Math.round(t))<0?0:t>255?255:t}function ru(t){return El(t[t.length-1]==="%"?parseFloat(t)/100*255:parseInt(t))}function Al(t){return(e=t[t.length-1]==="%"?parseFloat(t)/100:parseFloat(t))<0?0:e>1?1:e;var e}function su(t,e,i){return i<0?i+=1:i>1&&(i-=1),6*i<1?t+(e-t)*i*6:2*i<1?e:3*i<2?t+(e-t)*(2/3-i)*6:t}try{r.z={}.parseCSSColor=function(t){var e,i=t.replace(/ /g,"").toLowerCase();if(i in Wh)return Wh[i].slice();if(i[0]==="#")return i.length===4?(e=parseInt(i.substr(1),16))>=0&&e<=4095?[(3840&e)>>4|(3840&e)>>8,240&e|(240&e)>>4,15&e|(15&e)<<4,1]:null:i.length===7&&(e=parseInt(i.substr(1),16))>=0&&e<=16777215?[(16711680&e)>>16,(65280&e)>>8,255&e,1]:null;var s=i.indexOf("("),c=i.indexOf(")");if(s!==-1&&c+1===i.length){var h=i.substr(0,s),p=i.substr(s+1,c-(s+1)).split(","),y=1;switch(h){case"rgba":if(p.length!==4)return null;y=Al(p.pop());case"rgb":return p.length!==3?null:[ru(p[0]),ru(p[1]),ru(p[2]),y];case"hsla":if(p.length!==4)return null;y=Al(p.pop());case"hsl":if(p.length!==3)return null;var v=(parseFloat(p[0])%360+360)%360/360,T=Al(p[1]),E=Al(p[2]),I=E<=.5?E*(T+1):E+T-E*T,P=2*E-I;return[El(255*su(P,I,v+1/3)),El(255*su(P,I,v)),El(255*su(P,I,v-1/3)),y];default:return null}}return null}}catch{}class Bi{constructor(e,i,s,c=1){this.r=e,this.g=i,this.b=s,this.a=c}static parse(e){if(!e)return;if(e instanceof Bi)return e;if(typeof e!="string")return;const i=r.z(e);return i?new Bi(i[0]/255*i[3],i[1]/255*i[3],i[2]/255*i[3],i[3]):void 0}toString(){const[e,i,s,c]=this.toArray();return`rgba(${Math.round(e)},${Math.round(i)},${Math.round(s)},${c})`}toArray(){const{r:e,g:i,b:s,a:c}=this;return c===0?[0,0,0,0]:[255*e/c,255*i/c,255*s/c,c]}toArray01(){const{r:e,g:i,b:s,a:c}=this;return c===0?[0,0,0,0]:[e/c,i/c,s/c,c]}toArray01Scaled(e){const{r:i,g:s,b:c,a:h}=this;return h===0?[0,0,0]:[i/h*e,s/h*e,c/h*e]}toArray01PremultipliedAlpha(){const{r:e,g:i,b:s,a:c}=this;return[e,i,s,c]}toArray01Linear(){const{r:e,g:i,b:s,a:c}=this;return c===0?[0,0,0,0]:[Math.pow(e/c,2.2),Math.pow(i/c,2.2),Math.pow(s/c,2.2),c]}}function hi(t,e,i){return t*(1-i)+e*i}function Il(t,e,i){return t.map((s,c)=>hi(s,e[c],i))}Bi.black=new Bi(0,0,0,1),Bi.white=new Bi(1,1,1,1),Bi.transparent=new Bi(0,0,0,0),Bi.red=new Bi(1,0,0,1),Bi.blue=new Bi(0,0,1,1);var Cl=Object.freeze({__proto__:null,array:Il,color:function(t,e,i){return new Bi(hi(t.r,e.r,i),hi(t.g,e.g,i),hi(t.b,e.b,i),hi(t.a,e.a,i))},number:hi});function ou(t,...e){for(const i of e)for(const s in i)t[s]=i[s];return t}class xs extends Error{constructor(e,i){super(i),this.message=i,this.key=e}}class _o{constructor(e,i=[]){this.parent=e,this.bindings={};for(const[s,c]of i)this.bindings[s]=c}concat(e){return new _o(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const mi={kind:"null"},bt={kind:"number"},ki={kind:"string"},Ri={kind:"boolean"},$r={kind:"color"},wa={kind:"object"},Ei={kind:"value"},Pl={kind:"collator"},Ta={kind:"formatted"},Ma={kind:"resolvedImage"};function rr(t,e){return{kind:"array",itemType:t,N:e}}function An(t){if(t.kind==="array"){const e=An(t.itemType);return typeof t.N=="number"?`array<${e}, ${t.N}>`:t.itemType.kind==="value"?"array":`array<${e}>`}return t.kind}const xp=[mi,bt,ki,Ri,$r,Ta,wa,rr(Ei),Ma];function Dl(t,e){if(e.kind==="error")return null;if(t.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!Dl(t.itemType,e.itemType))&&(typeof t.N!="number"||t.N===e.N))return null}else{if(t.kind===e.kind)return null;if(t.kind==="value"){for(const i of xp)if(!Dl(i,e))return null}}return`Expected ${An(t)} but found ${An(e)} instead.`}function kl(t,e){return e.some(i=>i.kind===t.kind)}function Vo(t,e){return e.some(i=>i==="null"?t===null:i==="array"?Array.isArray(t):i==="object"?t&&!Array.isArray(t)&&typeof t=="object":i===typeof t)}class qh{constructor(e,i,s){this.sensitivity=e?i?"variant":"case":i?"accent":"base",this.locale=s,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,i){return this.collator.compare(e,i)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class au{constructor(e,i,s,c,h){this.text=e.normalize?e.normalize():e,this.image=i,this.scale=s,this.fontStack=c,this.textColor=h}}class mr{constructor(e){this.sections=e}static fromString(e){return new mr([new au(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(e=>e.text.length!==0||e.image&&e.image.namePrimary.length!==0)}static factory(e){return e instanceof mr?e:mr.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map(e=>e.text).join("")}serialize(){const e=["format"];for(const i of this.sections){if(i.image){e.push(["image",i.image.namePrimary]);continue}e.push(i.text);const s={};i.fontStack&&(s["text-font"]=["literal",i.fontStack.split(",")]),i.scale&&(s["font-scale"]=i.scale),i.textColor&&(s["text-color"]=["rgba"].concat(i.textColor.toArray())),e.push(s)}return e}}class Yr{constructor(e){this.namePrimary=e.namePrimary,e.nameSecondary&&(this.nameSecondary=e.nameSecondary),this.available=e.available}toString(){return this.nameSecondary?`[${this.namePrimary},${this.nameSecondary}]`:this.namePrimary}static fromString(e,i){return e?new Yr({namePrimary:e,nameSecondary:i,available:!1}):null}serialize(){return this.nameSecondary?["image",this.namePrimary,this.nameSecondary]:["image",this.namePrimary]}}function vp(t,e,i,s){return typeof t=="number"&&t>=0&&t<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof i=="number"&&i>=0&&i<=255?s===void 0||typeof s=="number"&&s>=0&&s<=1?null:`Invalid rgba value [${[t,e,i,s].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof s=="number"?[t,e,i,s]:[t,e,i]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Sa(t){if(t===null||typeof t=="string"||typeof t=="boolean"||typeof t=="number"||t instanceof Bi||t instanceof qh||t instanceof mr||t instanceof Yr)return!0;if(Array.isArray(t)){for(const e of t)if(!Sa(e))return!1;return!0}if(typeof t=="object"){for(const e in t)if(!Sa(t[e]))return!1;return!0}return!1}function jn(t){if(t===null)return mi;if(typeof t=="string")return ki;if(typeof t=="boolean")return Ri;if(typeof t=="number")return bt;if(t instanceof Bi)return $r;if(t instanceof qh)return Pl;if(t instanceof mr)return Ta;if(t instanceof Yr)return Ma;if(Array.isArray(t)){const e=t.length;let i;for(const s of t){const c=jn(s);if(i){if(i===c)continue;i=Ei;break}i=c}return rr(i||Ei,e)}return wa}function es(t){const e=typeof t;return t===null?"":e==="string"||e==="number"||e==="boolean"?String(t):t instanceof Bi||t instanceof mr||t instanceof Yr?t.toString():JSON.stringify(t)}class zs{constructor(e,i){this.type=e,this.value=i}static parse(e,i){if(e.length!==2)return i.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!Sa(e[1]))return i.error("invalid value");const s=e[1];let c=jn(s);const h=i.expectedType;return c.kind!=="array"||c.N!==0||!h||h.kind!=="array"||typeof h.N=="number"&&h.N!==0||(c=h),new zs(c,s)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Bi?["rgba"].concat(this.value.toArray()):this.value instanceof mr?this.value.serialize():this.value}}class Yn{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const lu={string:ki,number:bt,boolean:Ri,object:wa};class vs{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");let s,c=1;const h=e[0];if(h==="array"){let y,v;if(e.length>2){const T=e[1];if(typeof T!="string"||!(T in lu)||T==="object")return i.error('The item type argument of "array" must be one of string, number, boolean',1);y=lu[T],c++}else y=Ei;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return i.error('The length argument to "array" must be a positive integer literal',2);v=e[2],c++}s=rr(y,v)}else s=lu[h];const p=[];for(;c<e.length;c++){const y=i.parse(e[c],c,Ei);if(!y)return null;p.push(y)}return new vs(s,p)}evaluate(e){for(let i=0;i<this.args.length;i++){const s=this.args[i].evaluate(e);if(!Dl(this.type,jn(s)))return s;if(i===this.args.length-1)throw new Yn(`Expected value to be of type ${An(this.type)}, but found ${An(jn(s))} instead.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=this.type,i=[e.kind];if(e.kind==="array"){const s=e.itemType;if(s.kind==="string"||s.kind==="number"||s.kind==="boolean"){i.push(s.kind);const c=e.N;(typeof c=="number"||this.args.length>1)&&i.push(c)}}return i.concat(this.args.map(s=>s.serialize()))}}class Rl{constructor(e){this.type=Ta,this.sections=e}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const s=e[1];if(!Array.isArray(s)&&typeof s=="object")return i.error("First argument must be an image or text section.");const c=[];let h=!1;for(let p=1;p<=e.length-1;++p){const y=e[p];if(h&&typeof y=="object"&&!Array.isArray(y)){h=!1;let v=null;if(y["font-scale"]&&(v=i.parse(y["font-scale"],1,bt),!v))return null;let T=null;if(y["text-font"]&&(T=i.parse(y["text-font"],1,rr(ki)),!T))return null;let E=null;if(y["text-color"]&&(E=i.parse(y["text-color"],1,$r),!E))return null;const I=c[c.length-1];I.scale=v,I.font=T,I.textColor=E}else{const v=i.parse(e[p],1,Ei);if(!v)return null;const T=v.type.kind;if(T!=="string"&&T!=="value"&&T!=="null"&&T!=="resolvedImage")return i.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");h=!0,c.push({content:v,scale:null,font:null,textColor:null})}}return new Rl(c)}evaluate(e){return new mr(this.sections.map(i=>{const s=i.content.evaluate(e);return jn(s)===Ma?new au("",s,null,null,null):new au(es(s),null,i.scale?i.scale.evaluate(e):null,i.font?i.font.evaluate(e).join(","):null,i.textColor?i.textColor.evaluate(e):null)}))}eachChild(e){for(const i of this.sections)e(i.content),i.scale&&e(i.scale),i.font&&e(i.font),i.textColor&&e(i.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const i of this.sections){e.push(i.content.serialize());const s={};i.scale&&(s["font-scale"]=i.scale.serialize()),i.font&&(s["text-font"]=i.font.serialize()),i.textColor&&(s["text-color"]=i.textColor.serialize()),e.push(s)}return e}}class Ea{constructor(e,i){this.type=Ma,this.inputPrimary=e,this.inputSecondary=i}static parse(e,i){if(e.length<2)return i.error("Expected two or more arguments.");const s=i.parse(e[1],1,ki);if(!s)return i.error("No image name provided.");if(e.length===2)return new Ea(s);const c=i.parse(e[2],1,ki);return c?new Ea(s,c):i.error("Secondary image variant is not a string.")}evaluate(e){const i=Yr.fromString(this.inputPrimary.evaluate(e),this.inputSecondary?this.inputSecondary.evaluate(e):void 0);return i&&e.availableImages&&(i.available=e.availableImages.indexOf(i.namePrimary)>-1,i.nameSecondary&&i.available&&e.availableImages&&(i.available=e.availableImages.indexOf(i.nameSecondary)>-1)),i}eachChild(e){e(this.inputPrimary),this.inputSecondary&&e(this.inputSecondary)}outputDefined(){return!1}serialize(){return this.inputSecondary?["image",this.inputPrimary.serialize(),this.inputSecondary.serialize()]:["image",this.inputPrimary.serialize()]}}function go(t){return t instanceof Number?"number":t instanceof String?"string":t instanceof Boolean?"boolean":Array.isArray(t)?"array":t===null?"null":typeof t}const dg={"to-boolean":Ri,"to-color":$r,"to-number":bt,"to-string":ki};class Ys{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const s=e[0],c=[];let h=mi;if(s==="to-array"){if(!Array.isArray(e[1]))return null;const p=e[1].length;if(i.expectedType){if(i.expectedType.kind!=="array")return i.error(`Expected ${i.expectedType.kind} but found array.`);h=rr(i.expectedType.itemType,p)}else{if(!(p>0&&Sa(e[1][0])))return null;h=rr(jn(e[1][0]),p)}for(let y=0;y<p;y++){const v=e[1][y];let T;if(go(v)==="array")T=i.parse(v,void 0,h.itemType);else{const E=go(v);if(E!==h.itemType.kind)return i.error(`Expected ${h.itemType.kind} but found ${E}.`);T=i.registry.literal.parse(["literal",v===void 0?null:v],i)}if(!T)return null;c.push(T)}}else{if((s==="to-boolean"||s==="to-string")&&e.length!==2)return i.error("Expected one argument.");h=dg[s];for(let p=1;p<e.length;p++){const y=i.parse(e[p],p,Ei);if(!y)return null;c.push(y)}}return new Ys(h,c)}evaluate(e){if(this.type.kind==="boolean")return!!this.args[0].evaluate(e);if(this.type.kind==="color"){let i,s;for(const c of this.args){if(i=c.evaluate(e),s=null,i instanceof Bi)return i;if(typeof i=="string"){const h=e.parseColor(i);if(h)return h}else if(Array.isArray(i)&&(s=i.length<3||i.length>4?`Invalid rbga value ${JSON.stringify(i)}: expected an array containing either three or four numeric values.`:vp(i[0],i[1],i[2],i[3]),!s))return new Bi(i[0]/255,i[1]/255,i[2]/255,i[3])}throw new Yn(s||`Could not parse color from value '${typeof i=="string"?i:String(JSON.stringify(i))}'`)}if(this.type.kind==="number"){let i=null;for(const s of this.args){if(i=s.evaluate(e),i===null)return 0;const c=Number(i);if(!isNaN(c))return c}throw new Yn(`Could not convert ${JSON.stringify(i)} to number.`)}return this.type.kind==="formatted"?mr.fromString(es(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?Yr.fromString(es(this.args[0].evaluate(e))):this.type.kind==="array"?this.args.map(i=>i.evaluate(e)):es(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if(this.type.kind==="formatted")return new Rl([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new Ea(this.args[0]).serialize();const e=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild(i=>{e.push(i.serialize())}),e}}const fg=["Unknown","Point","LineString","Polygon"];class Hh{constructor(e,i){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=i}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?fg[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,i=this.featureDistanceData.scale,{x:s,y:c}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(s*i-e[0])+this.featureDistanceData.bearing[1]*(c*i-e[1])}return 0}parseColor(e){let i=this._parseColorCache[e];return i||(i=this._parseColorCache[e]=Bi.parse(e)),i}getConfig(e){return this.options?this.options.get(e):null}}class Br{constructor(e,i,s,c,h){this.name=e,this.type=i,this._evaluate=s,this.args=c,this._overloadIndex=h}evaluate(e){if(!this._evaluate){const i=Br.definitions[this.name];this._evaluate=Array.isArray(i)?i[2]:i.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,i){const s=e[0],c=Br.definitions[s];if(!c)return i.error(`Unknown expression "${s}". If you wanted a literal array, use ["literal", [...]].`,0);const h=Array.isArray(c)?c[0]:c.type,p=Array.isArray(c)?[[c[1],c[2]]]:c.overloads,y=[];let v=null,T=-1;for(const[E,I]of p){if(Array.isArray(E)&&E.length!==e.length-1)continue;y.push(E),T++,v=new gu(i.registry,i.path,null,i.scope,void 0,i._scope,i.options);const P=[];let R=!1;for(let L=1;L<e.length;L++){const B=e[L],j=Array.isArray(E)?E[L-1]:E.type,G=v.parse(B,1+P.length,j);if(!G){R=!0;break}P.push(G)}if(!R)if(Array.isArray(E)&&E.length!==P.length)v.error(`Expected ${E.length} arguments, but found ${P.length} instead.`);else{for(let L=0;L<P.length;L++){const B=Array.isArray(E)?E[L]:E.type,j=P[L];v.concat(L+1).checkSubtype(B,j.type)}if(v.errors.length===0)return new Br(s,h,I,P,T)}}if(y.length===1)i.errors.push(...v.errors);else{const E=(y.length?y:p.map(([P])=>P)).map(pg).join(" | "),I=[];for(let P=1;P<e.length;P++){const R=i.parse(e[P],1+I.length);if(!R)return null;I.push(An(R.type))}i.error(`Expected arguments of type ${E}, but found (${I.join(", ")}) instead.`)}return null}static register(e,i){Br.definitions=i;for(const s in i)e[s]=Br}}function pg(t){return Array.isArray(t)?`(${t.map(An).join(", ")})`:`(${An(t.type)}...)`}class zl{constructor(e,i,s){this.type=Pl,this.locale=s,this.caseSensitive=e,this.diacriticSensitive=i}static parse(e,i){if(e.length!==2)return i.error("Expected one argument.");const s=e[1];if(typeof s!="object"||Array.isArray(s))return i.error("Collator options argument must be an object.");const c=i.parse(s["case-sensitive"]!==void 0&&s["case-sensitive"],1,Ri);if(!c)return null;const h=i.parse(s["diacritic-sensitive"]!==void 0&&s["diacritic-sensitive"],1,Ri);if(!h)return null;let p=null;return s.locale&&(p=i.parse(s.locale,1,ki),!p)?null:new zl(c,h,p)}evaluate(e){return new qh(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}var Zh={exports:{}};Zh.exports=function(){function t(s,c,h,p,y){for(;p>h;){if(p-h>600){var v=p-h+1,T=c-h+1,E=Math.log(v),I=.5*Math.exp(2*E/3),P=.5*Math.sqrt(E*I*(v-I)/v)*(T-v/2<0?-1:1);t(s,c,Math.max(h,Math.floor(c-T*I/v+P)),Math.min(p,Math.floor(c+(v-T)*I/v+P)),y)}var R=s[c],L=h,B=p;for(e(s,h,c),y(s[p],R)>0&&e(s,h,p);L<B;){for(e(s,L,B),L++,B--;y(s[L],R)<0;)L++;for(;y(s[B],R)>0;)B--}y(s[h],R)===0?e(s,h,B):e(s,++B,p),B<=c&&(h=B+1),c<=B&&(p=B-1)}}function e(s,c,h){var p=s[c];s[c]=s[h],s[h]=p}function i(s,c){return s<c?-1:s>c?1:0}return function(s,c,h,p,y){t(s,c,h||0,p||s.length-1,y||i)}}();var bp=Ee(Zh.exports);function mg(t){let e=0;for(let i,s,c=0,h=t.length,p=h-1;c<h;p=c++)i=t[c],s=t[p],e+=(s.x-i.x)*(i.y+s.y);return e}function Ll(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.max(t[2],e[0]),t[3]=Math.max(t[3],e[1])}function Ol(t,e){return!(t[0]<=e[0]||t[2]>=e[2]||t[1]<=e[1]||t[3]>=e[3])}function _g(t,e,i){const s=t[0]-e[0],c=t[1]-e[1],h=t[0]-i[0],p=t[1]-i[1];return s*p-h*c==0&&s*h<=0&&c*p<=0}function Uo(t,e,i=!1){let s=!1;for(let y=0,v=e.length;y<v;y++){const T=e[y];for(let E=0,I=T.length,P=I-1;E<I;P=E++){const R=T[P],L=T[E];if(_g(t,R,L))return i;(h=R)[1]>(c=t)[1]!=(p=L)[1]>c[1]&&c[0]<(p[0]-h[0])*(c[1]-h[1])/(p[1]-h[1])+h[0]&&(s=!s)}}var c,h,p;return s}function $h(t,e,i,s){const c=s[0]-i[0],h=s[1]-i[1],p=(t[0]-i[0])*h-c*(t[1]-i[1]),y=(e[0]-i[0])*h-c*(e[1]-i[1]);return p>0&&y<0||p<0&&y>0}function Aa(t,e,i,s){return(c=[s[0]-i[0],s[1]-i[1]])[0]*(h=[e[0]-t[0],e[1]-t[1]])[1]-c[1]*h[0]!=0&&!(!$h(t,e,i,s)||!$h(i,s,t,e));var c,h}const yo=8192;function gg(t,e){const i=(180+t[0])/360,s=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t[1]*Math.PI/360)))/360,c=Math.pow(2,e.z);return[Math.round(i*c*yo),Math.round(s*c*yo)]}function yg(t,e){for(let i=0;i<e.length;i++)if(Uo(t,e[i]))return!0;return!1}function Yh(t,e,i){for(const s of i)for(let c=0,h=s.length,p=h-1;c<h;p=c++)if(Aa(t,e,s[p],s[c]))return!0;return!1}function cu(t,e){for(let i=0;i<t.length;++i)if(!Uo(t[i],e))return!1;for(let i=0;i<t.length-1;++i)if(Yh(t[i],t[i+1],e))return!1;return!0}function wp(t,e){for(let i=0;i<e.length;i++)if(cu(t,e[i]))return!0;return!1}function Qh(t,e,i){const s=[];for(let c=0;c<t.length;c++){const h=[];for(let p=0;p<t[c].length;p++){const y=gg(t[c][p],i);Ll(e,y),h.push(y)}s.push(h)}return s}function Fl(t,e,i){const s=[];for(let c=0;c<t.length;c++){const h=Qh(t[c],e,i);s.push(h)}return s}function Xh(t,e,i,s){if(t[0]<i[0]||t[0]>i[2]){const c=.5*s;let h=t[0]-i[0]>c?-s:i[0]-t[0]>c?s:0;h===0&&(h=t[0]-i[2]>c?-s:i[2]-t[0]>c?s:0),t[0]+=h}Ll(e,t)}function Bl(t,e,i,s){const c=Math.pow(2,s.z)*yo,h=[s.x*yo,s.y*yo],p=[];if(!t)return p;for(const y of t)for(const v of y){const T=[v.x+h[0],v.y+h[1]];Xh(T,e,i,c),p.push(T)}return p}function Kh(t,e,i,s){const c=Math.pow(2,s.z)*yo,h=[s.x*yo,s.y*yo],p=[];if(!t)return p;for(const v of t){const T=[];for(const E of v){const I=[E.x+h[0],E.y+h[1]];Ll(e,I),T.push(I)}p.push(T)}if(e[2]-e[0]<=c/2){(y=e)[0]=y[1]=1/0,y[2]=y[3]=-1/0;for(const v of p)for(const T of v)Xh(T,e,i,c)}var y;return p}class jo{constructor(e,i){this.type=Ri,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(Sa(e[1])){const s=e[1];if(s.type==="FeatureCollection")for(let c=0;c<s.features.length;++c){const h=s.features[c].geometry.type;if(h==="Polygon"||h==="MultiPolygon")return new jo(s,s.features[c].geometry)}else if(s.type==="Feature"){const c=s.geometry.type;if(c==="Polygon"||c==="MultiPolygon")return new jo(s,s.geometry)}else if(s.type==="Polygon"||s.type==="MultiPolygon")return new jo(s,s)}return i.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return function(i,s){const c=[1/0,1/0,-1/0,-1/0],h=[1/0,1/0,-1/0,-1/0],p=i.canonicalID();if(!p)return!1;if(s.type==="Polygon"){const y=Qh(s.coordinates,h,p),v=Bl(i.geometry(),c,h,p);if(!Ol(c,h))return!1;for(const T of v)if(!Uo(T,y))return!1}if(s.type==="MultiPolygon"){const y=Fl(s.coordinates,h,p),v=Bl(i.geometry(),c,h,p);if(!Ol(c,h))return!1;for(const T of v)if(!yg(T,y))return!1}return!0}(e,this.geometries);if(e.geometryType()==="LineString")return function(i,s){const c=[1/0,1/0,-1/0,-1/0],h=[1/0,1/0,-1/0,-1/0],p=i.canonicalID();if(!p)return!1;if(s.type==="Polygon"){const y=Qh(s.coordinates,h,p),v=Kh(i.geometry(),c,h,p);if(!Ol(c,h))return!1;for(const T of v)if(!cu(T,y))return!1}if(s.type==="MultiPolygon"){const y=Fl(s.coordinates,h,p),v=Kh(i.geometry(),c,h,p);if(!Ol(c,h))return!1;for(const T of v)if(!wp(T,y))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}var Tp={exports:{}};(function(t,e){t.exports=function(){var i={kilometers:1,miles:.621371192237334,nauticalmiles:.5399568034557235,meters:1e3,metres:1e3,yards:1093.6132983377079,feet:3280.839895013123,inches:39370.078740157485},s=1/298.257223563,c=s*(2-s),h=Math.PI/180,p=function(I,P){if(I===void 0)throw new Error("No latitude given.");if(P&&!i[P])throw new Error("Unknown unit "+P+". Use one of: "+Object.keys(i).join(", "));var R=6378.137*h*(P?i[P]:1),L=Math.cos(I*h),B=1/(1-c*(1-L*L)),j=Math.sqrt(B);this.kx=R*j*L,this.ky=R*j*B*(1-c)},y={units:{configurable:!0}};function v(I,P){return I[0]===P[0]&&I[1]===P[1]}function T(I,P,R){var L=E(P[0]-I[0]);return[I[0]+L*R,I[1]+(P[1]-I[1])*R]}function E(I){for(;I<-180;)I+=360;for(;I>180;)I-=360;return I}return p.fromTile=function(I,P,R){var L=Math.PI*(1-2*(I+.5)/Math.pow(2,P)),B=Math.atan(.5*(Math.exp(L)-Math.exp(-L)))/h;return new p(B,R)},y.units.get=function(){return i},p.prototype.distance=function(I,P){var R=E(I[0]-P[0])*this.kx,L=(I[1]-P[1])*this.ky;return Math.sqrt(R*R+L*L)},p.prototype.bearing=function(I,P){var R=E(P[0]-I[0])*this.kx;return Math.atan2(R,(P[1]-I[1])*this.ky)/h},p.prototype.destination=function(I,P,R){var L=R*h;return this.offset(I,Math.sin(L)*P,Math.cos(L)*P)},p.prototype.offset=function(I,P,R){return[I[0]+P/this.kx,I[1]+R/this.ky]},p.prototype.lineDistance=function(I){for(var P=0,R=0;R<I.length-1;R++)P+=this.distance(I[R],I[R+1]);return P},p.prototype.area=function(I){for(var P=0,R=0;R<I.length;R++)for(var L=I[R],B=0,j=L.length,G=j-1;B<j;G=B++)P+=E(L[B][0]-L[G][0])*(L[B][1]+L[G][1])*(R?-1:1);return Math.abs(P)/2*this.kx*this.ky},p.prototype.along=function(I,P){var R=0;if(P<=0)return I[0];for(var L=0;L<I.length-1;L++){var B=I[L],j=I[L+1],G=this.distance(B,j);if((R+=G)>P)return T(B,j,(P-(R-G))/G)}return I[I.length-1]},p.prototype.pointToSegmentDistance=function(I,P,R){var L=P[0],B=P[1],j=E(R[0]-L)*this.kx,G=(R[1]-B)*this.ky,X=0;return j===0&&G===0||((X=(E(I[0]-L)*this.kx*j+(I[1]-B)*this.ky*G)/(j*j+G*G))>1?(L=R[0],B=R[1]):X>0&&(L+=j/this.kx*X,B+=G/this.ky*X)),j=E(I[0]-L)*this.kx,G=(I[1]-B)*this.ky,Math.sqrt(j*j+G*G)},p.prototype.pointOnLine=function(I,P){for(var R,L,B,j,G=1/0,X=0;X<I.length-1;X++){var ie=I[X][0],J=I[X][1],he=E(I[X+1][0]-ie)*this.kx,re=(I[X+1][1]-J)*this.ky,pe=0;he===0&&re===0||((pe=(E(P[0]-ie)*this.kx*he+(P[1]-J)*this.ky*re)/(he*he+re*re))>1?(ie=I[X+1][0],J=I[X+1][1]):pe>0&&(ie+=he/this.kx*pe,J+=re/this.ky*pe));var _e=(he=E(P[0]-ie)*this.kx)*he+(re=(P[1]-J)*this.ky)*re;_e<G&&(G=_e,R=ie,L=J,B=X,j=pe)}return{point:[R,L],index:B,t:Math.max(0,Math.min(1,j))}},p.prototype.lineSlice=function(I,P,R){var L=this.pointOnLine(R,I),B=this.pointOnLine(R,P);if(L.index>B.index||L.index===B.index&&L.t>B.t){var j=L;L=B,B=j}var G=[L.point],X=L.index+1,ie=B.index;!v(R[X],G[0])&&X<=ie&&G.push(R[X]);for(var J=X+1;J<=ie;J++)G.push(R[J]);return v(R[ie],B.point)||G.push(B.point),G},p.prototype.lineSliceAlong=function(I,P,R){for(var L=0,B=[],j=0;j<R.length-1;j++){var G=R[j],X=R[j+1],ie=this.distance(G,X);if((L+=ie)>I&&B.length===0&&B.push(T(G,X,(I-(L-ie))/ie)),L>=P)return B.push(T(G,X,(P-(L-ie))/ie)),B;L>I&&B.push(X)}return B},p.prototype.bufferPoint=function(I,P){var R=P/this.ky,L=P/this.kx;return[I[0]-L,I[1]-R,I[0]+L,I[1]+R]},p.prototype.bufferBBox=function(I,P){var R=P/this.ky,L=P/this.kx;return[I[0]-L,I[1]-R,I[2]+L,I[3]+R]},p.prototype.insideBBox=function(I,P){return E(I[0]-P[0])>=0&&E(I[0]-P[2])<=0&&I[1]>=P[1]&&I[1]<=P[3]},Object.defineProperties(p,y),p}()})(Tp);var Nl=Ee(Tp.exports),uu={exports:{}};(function(t,e){t.exports=function(){var i=function(c,h){if(c===void 0&&(c=[]),h===void 0&&(h=s),this.data=c,this.length=this.data.length,this.compare=h,this.length>0)for(var p=(this.length>>1)-1;p>=0;p--)this._down(p)};function s(c,h){return c<h?-1:c>h?1:0}return i.prototype.push=function(c){this.data.push(c),this.length++,this._up(this.length-1)},i.prototype.pop=function(){if(this.length!==0){var c=this.data[0],h=this.data.pop();return this.length--,this.length>0&&(this.data[0]=h,this._down(0)),c}},i.prototype.peek=function(){return this.data[0]},i.prototype._up=function(c){for(var h=this.data,p=this.compare,y=h[c];c>0;){var v=c-1>>1,T=h[v];if(p(y,T)>=0)break;h[c]=T,c=v}h[c]=y},i.prototype._down=function(c){for(var h=this.data,p=this.compare,y=this.length>>1,v=h[c];c<y;){var T=1+(c<<1),E=h[T],I=T+1;if(I<this.length&&p(h[I],E)<0&&(T=I,E=h[I]),p(E,v)>=0)break;h[c]=E,c=T}h[c]=v},i}()})(uu);var hu=Ee(uu.exports),pt=8192;function Go(t,e){return e.dist-t.dist}const Jh=100,ed=50;function Mp(t){const e=[1/0,1/0,-1/0,-1/0];if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}function du(t){return t[1]-t[0]+1}function Qs(t,e){const i=t[1]>=t[0]&&t[1]<e;return i||console.warn("Distance Expression: Index is out of range"),i}function fu(t,e){if(t[0]>t[1])return[null,null];const i=du(t);if(e){if(i===2)return[t,null];const s=Math.floor(i/2);return[[t[0],t[0]+s],[t[0]+s,t[1]]]}{if(i===1)return[t,null];const s=Math.floor(i/2)-1;return[[t[0],t[0]+s],[t[0]+s+1,t[1]]]}}function Xs(t,e){const i=[1/0,1/0,-1/0,-1/0];if(!Qs(e,t.length))return i;for(let s=e[0];s<=e[1];++s)Ll(i,t[s]);return i}function pu(t){const e=[1/0,1/0,-1/0,-1/0];for(let i=0;i<t.length;++i)for(let s=0;s<t[i].length;++s)Ll(e,t[i][s]);return e}function Ia(t,e,i){if(Mp(t)||Mp(e))return NaN;let s=0,c=0;return t[2]<e[0]&&(s=e[0]-t[2]),t[0]>e[2]&&(s=t[0]-e[2]),t[1]>e[3]&&(c=t[1]-e[3]),t[3]<e[1]&&(c=e[1]-t[3]),i.distance([0,0],[s,c])}function xg(t){return 360*t-180}function vg(t){return 360/Math.PI*Math.atan(Math.exp((180-360*t)*Math.PI/180))-90}function td(t,e){const i=Math.pow(2,e.z),s=(t.y/pt+e.y)/i;return[xg((t.x/pt+e.x)/i),vg(s)]}function bg(t,e){const i=[];for(let s=0;s<t.length;++s)i.push(td(t[s],e));return i}function Sp(t,e,i){const s=i.pointOnLine(e,t).point;return i.distance(t,s)}function Ep(t,e,i,s,c){const h=i.slice(s[0],s[1]+1);let p=1/0;for(let y=e[0];y<=e[1];++y)if((p=Math.min(p,Sp(t[y],h,c)))===0)return 0;return p}function id(t,e,i,s,c){const h=Math.min(c.pointToSegmentDistance(t,i,s),c.pointToSegmentDistance(e,i,s)),p=Math.min(c.pointToSegmentDistance(i,t,e),c.pointToSegmentDistance(s,t,e));return Math.min(h,p)}function Ca(t,e,i,s,c){if(!Qs(e,t.length)||!Qs(s,i.length))return NaN;let h=1/0;for(let p=e[0];p<e[1];++p)for(let y=s[0];y<s[1];++y){if(Aa(t[p],t[p+1],i[y],i[y+1]))return 0;h=Math.min(h,id(t[p],t[p+1],i[y],i[y+1],c))}return h}function Ap(t,e,i,s,c){if(!Qs(e,t.length)||!Qs(s,i.length))return NaN;let h=1/0;for(let p=e[0];p<=e[1];++p)for(let y=s[0];y<=s[1];++y)if((h=Math.min(h,c.distance(t[p],i[y])))===0)return h;return h}function Ip(t,e,i){if(Uo(t,e,!0))return 0;let s=1/0;for(const c of e){const h=c.length;if(h<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(c[0]!==c[h-1]&&(s=Math.min(s,i.pointToSegmentDistance(t,c[h-1],c[0])))===0||(s=Math.min(s,Sp(t,c,i)))===0)return s}return s}function mu(t,e,i,s){if(!Qs(e,t.length))return NaN;for(let h=e[0];h<=e[1];++h)if(Uo(t[h],i,!0))return 0;let c=1/0;for(let h=e[0];h<e[1];++h)for(const p of i)for(let y=0,v=p.length,T=v-1;y<v;T=y++){if(Aa(t[h],t[h+1],p[T],p[y]))return 0;c=Math.min(c,id(t[h],t[h+1],p[T],p[y],s))}return c}function Cp(t,e){for(const i of t)for(let s=0;s<=i.length-1;++s)if(Uo(i[s],e,!0))return!0;return!1}function wg(t,e,i,s=1/0){const c=pu(t),h=pu(e);if(s!==1/0&&Ia(c,h,i)>=s)return s;if(Ol(c,h)){if(Cp(t,e))return 0}else if(Cp(e,t))return 0;let p=s;for(const y of t)for(let v=0,T=y.length,E=T-1;v<T;E=v++)for(const I of e)for(let P=0,R=I.length,L=R-1;P<R;L=P++){if(Aa(y[E],y[v],I[L],I[P]))return 0;p=Math.min(p,id(y[E],y[v],I[L],I[P],i))}return p}function bs(t,e,i,s,c,h,p){if(h===null||p===null)return;const y=Ia(Xs(s,h),Xs(c,p),i);y<e&&t.push({dist:y,range1:h,range2:p})}function Pp(t,e,i,s,c=1/0){let h=Math.min(s.distance(t[0],i[0][0]),c);if(h===0)return h;const p=new hu([{dist:0,range1:[0,t.length-1],range2:[0,0]}],Go),y=e?ed:Jh,v=pu(i);for(;p.length;){const T=p.pop();if(T.dist>=h)continue;const E=T.range1;if(du(E)<=y){if(!Qs(E,t.length))return NaN;if(e){const I=mu(t,E,i,s);if((h=Math.min(h,I))===0)return h}else for(let I=E[0];I<=E[1];++I){const P=Ip(t[I],i,s);if((h=Math.min(h,P))===0)return h}}else{const I=fu(E,e);if(I[0]!==null){const P=Ia(Xs(t,I[0]),v,s);P<h&&p.push({dist:P,range1:I[0],range2:[0,0]})}if(I[1]!==null){const P=Ia(Xs(t,I[1]),v,s);P<h&&p.push({dist:P,range1:I[1],range2:[0,0]})}}}return h}function Wo(t,e,i,s,c,h=1/0){let p=Math.min(h,c.distance(t[0],i[0]));if(p===0)return p;const y=new hu([{dist:0,range1:[0,t.length-1],range2:[0,i.length-1]}],Go),v=e?ed:Jh,T=s?ed:Jh;for(;y.length;){const E=y.pop();if(E.dist>=p)continue;const I=E.range1,P=E.range2;if(du(I)<=v&&du(P)<=T){if(!Qs(I,t.length)||!Qs(P,i.length))return NaN;if(e&&s?p=Math.min(p,Ca(t,I,i,P,c)):e||s?e&&!s?p=Math.min(p,Ep(i,P,t,I,c)):!e&&s&&(p=Math.min(p,Ep(t,I,i,P,c))):p=Math.min(p,Ap(t,I,i,P,c)),p===0)return p}else{const R=fu(I,e),L=fu(P,s);bs(y,p,c,t,i,R[0],L[0]),bs(y,p,c,t,i,R[0],L[1]),bs(y,p,c,t,i,R[1],L[0]),bs(y,p,c,t,i,R[1],L[1])}}return p}function nd(t,e,i,s,c=1/0){let h=c;const p=Xs(t,[0,t.length-1]);for(const y of i)if(!(h!==1/0&&Ia(p,Xs(y,[0,y.length-1]),s)>=h)&&(h=Math.min(h,Wo(t,e,y,!0,s,h)),h===0))return h;return h}function _u(t,e,i,s,c=1/0){let h=c;const p=Xs(t,[0,t.length-1]);for(const y of i){if(h!==1/0&&Ia(p,pu(y),s)>=h)continue;const v=Pp(t,e,y,s,h);if(isNaN(v))return v;if((h=Math.min(h,v))===0)return h}return h}function rd(t){return t==="Point"||t==="MultiPoint"||t==="LineString"||t==="MultiLineString"||t==="Polygon"||t==="MultiPolygon"}class qo{constructor(e,i){this.type=bt,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if(Sa(e[1])){const s=e[1];if(s.type==="FeatureCollection"){for(let c=0;c<s.features.length;++c)if(rd(s.features[c].geometry.type))return new qo(s,s.features[c].geometry)}else if(s.type==="Feature"){if(rd(s.geometry.type))return new qo(s,s.geometry)}else if(rd(s.type))return new qo(s,s)}return i.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){const i=e.geometry(),s=e.canonicalID();if(i!=null&&s!=null){if(e.geometryType()==="Point")return function(c,h,p){const y=[];for(const T of c)for(const E of T)y.push(td(E,h));const v=new Nl(y[0][1],"meters");return p.type==="Point"||p.type==="MultiPoint"||p.type==="LineString"?Wo(y,!1,p.type==="Point"?[p.coordinates]:p.coordinates,p.type==="LineString",v):p.type==="MultiLineString"?nd(y,!1,p.coordinates,v):p.type==="Polygon"||p.type==="MultiPolygon"?_u(y,!1,p.type==="Polygon"?[p.coordinates]:p.coordinates,v):null}(i,s,this.geometries);if(e.geometryType()==="LineString")return function(c,h,p){const y=[];for(const T of c){const E=[];for(const I of T)E.push(td(I,h));y.push(E)}const v=new Nl(y[0][0][1],"meters");if(p.type==="Point"||p.type==="MultiPoint"||p.type==="LineString")return nd(p.type==="Point"?[p.coordinates]:p.coordinates,p.type==="LineString",y,v);if(p.type==="MultiLineString"){let T=1/0;for(let E=0;E<p.coordinates.length;E++){const I=nd(p.coordinates[E],!0,y,v,T);if(isNaN(I))return I;if((T=Math.min(T,I))===0)return T}return T}if(p.type==="Polygon"||p.type==="MultiPolygon"){let T=1/0;for(let E=0;E<y.length;E++){const I=_u(y[E],!0,p.type==="Polygon"?[p.coordinates]:p.coordinates,v,T);if(isNaN(I))return I;if((T=Math.min(T,I))===0)return T}return T}return null}(i,s,this.geometries);if(e.geometryType()==="Polygon")return function(c,h,p){const y=[];for(const T of function(E,I){const P=E.length;if(P<=1)return[E];const R=[];let L,B;for(let j=0;j<P;j++){const G=mg(E[j]);G!==0&&(E[j].area=Math.abs(G),B===void 0&&(B=G<0),B===G<0?(L&&R.push(L),L=[E[j]]):L.push(E[j]))}return L&&R.push(L),R}(c)){const E=[];for(let I=0;I<T.length;++I)E.push(bg(T[I],h));y.push(E)}const v=new Nl(y[0][0][0][1],"meters");if(p.type==="Point"||p.type==="MultiPoint"||p.type==="LineString")return _u(p.type==="Point"?[p.coordinates]:p.coordinates,p.type==="LineString",y,v);if(p.type==="MultiLineString"){let T=1/0;for(let E=0;E<p.coordinates.length;E++){const I=_u(p.coordinates[E],!0,y,v,T);if(isNaN(I))return I;if((T=Math.min(T,I))===0)return T}return T}return p.type==="Polygon"||p.type==="MultiPolygon"?function(T,E,I){let P=1/0;for(const R of T)for(const L of E){const B=wg(R,L,I,P);if(isNaN(B))return B;if((P=Math.min(P,B))===0)return P}return P}(p.type==="Polygon"?[p.coordinates]:p.coordinates,y,v):null}(i,s,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function sd(t,e){switch(t){case"string":return es(e);case"number":return+e;case"boolean":return!!e;case"color":return Bi.parse(e);case"formatted":return mr.fromString(es(e));case"resolvedImage":return Yr.fromString(es(e))}return e}function od(t,e,i,s){return s!==void 0&&(t=s*Math.round(t/s)),e!==void 0&&t<e&&(t=e),i!==void 0&&t>i&&(t=i),t}class xo{constructor(e,i,s){this.type=e,this.key=i,this.scope=s}static parse(e,i){let s=i.expectedType;if(s==null&&(s=Ei),e.length<2||e.length>3)return i.error("Invalid number of arguments for 'config' expression.");const c=i.parse(e[1],1);if(!(c instanceof zs))return i.error("Key name of 'config' expression must be a string literal.");if(e.length>=3){const h=i.parse(e[2],2);return h instanceof zs?new xo(s,es(c.value),es(h.value)):i.error("Scope of 'config' expression must be a string literal.")}return new xo(s,es(c.value))}evaluate(e){const i=[this.key,this.scope,e.scope].filter(Boolean).join(""),s=e.getConfig(i);if(!s)return null;const{type:c,value:h,values:p,minValue:y,maxValue:v,stepValue:T}=s,E=s.default.evaluate(e);let I=E;if(h){const P=e.scope;e.scope=(P||"").split("").slice(1).join(""),I=h.evaluate(e),e.scope=P}return c&&(I=sd(c,I)),I===void 0||y===void 0&&v===void 0&&T===void 0||(typeof I=="number"?I=od(I,y,v,T):Array.isArray(I)&&(I=I.map(P=>typeof P=="number"?od(P,y,v,T):P))),h!==void 0&&I!==void 0&&p&&!p.includes(I)&&(I=E,c&&(I=sd(c,I))),(c&&c!==this.type||I!==void 0&&jn(I)!==this.type)&&(I=sd(this.type.kind,I)),I}eachChild(){}outputDefined(){return!1}serialize(){const e=["config",this.key];return this.scope&&e.concat(this.key),e}}function vo(t){if(t instanceof Br&&(t.name==="get"&&t.args.length===1||t.name==="feature-state"||t.name==="has"&&t.args.length===1||t.name==="properties"||t.name==="geometry-type"||t.name==="id"||/^filter-/.test(t.name))||t instanceof jo||t instanceof qo)return!1;let e=!0;return t.eachChild(i=>{e&&!vo(i)&&(e=!1)}),e}function Vl(t){if(t instanceof Br&&t.name==="feature-state")return!1;let e=!0;return t.eachChild(i=>{e&&!Vl(i)&&(e=!1)}),e}function Ul(t){if(t instanceof xo)return!1;let e=!0;return t.eachChild(i=>{e&&!Ul(i)&&(e=!1)}),e}function jl(t,e){if(t instanceof Br&&e.indexOf(t.name)>=0)return!1;let i=!0;return t.eachChild(s=>{i&&!jl(s,e)&&(i=!1)}),i}class Qr{constructor(e,i){this.type=i.type,this.name=e,this.boundExpression=i}static parse(e,i){if(e.length!==2||typeof e[1]!="string")return i.error("'var' expression requires exactly one string literal argument.");const s=e[1];return i.scope.has(s)?new Qr(s,i.scope.get(s)):i.error(`Unknown variable "${s}". Make sure "${s}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class gu{constructor(e,i=[],s,c=new _o,h=[],p,y){this.registry=e,this.path=i,this.key=i.map(v=>`[${v}]`).join(""),this.scope=c,this.errors=h,this.expectedType=s,this._scope=p,this.options=y}parse(e,i,s,c,h={}){return i||s?this.concat(i,s,c)._parse(e,h):this._parse(e,h)}_parse(e,i){function s(c,h,p){return p==="assert"?new vs(h,[c]):p==="coerce"?new Ys(h,[c]):c}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const c=typeof e[0]=="string"?this.registry[e[0]]:void 0;if(c){let h=c.parse(e,this);if(!h)return null;if(this.expectedType){const p=this.expectedType,y=h.type;if(p.kind!=="string"&&p.kind!=="number"&&p.kind!=="boolean"&&p.kind!=="object"&&p.kind!=="array"||y.kind!=="value")if(p.kind!=="color"&&p.kind!=="formatted"&&p.kind!=="resolvedImage"||y.kind!=="value"&&y.kind!=="string"){if(this.checkSubtype(p,y))return null}else h=s(h,p,i.typeAnnotation||"coerce");else h=s(h,p,i.typeAnnotation||"assert")}if(!(h instanceof zs)&&h.type.kind!=="resolvedImage"&&yu(h)){const p=new Hh(this._scope,this.options);try{h=new zs(h.type,h.evaluate(p))}catch(y){return this.error(y.message),null}}return h}return Ys.parse(["to-array",e],this)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,i,s){const c=typeof e=="number"?this.path.concat(e):this.path,h=s?this.scope.concat(s):this.scope;return new gu(this.registry,c,i||null,h,this.errors,this._scope,this.options)}error(e,...i){const s=`${this.key}${i.map(c=>`[${c}]`).join("")}`;this.errors.push(new xs(s,e))}checkSubtype(e,i){const s=Dl(e,i);return s&&this.error(s),s}}function yu(t){if(t instanceof Qr)return yu(t.boundExpression);if(t instanceof Br&&t.name==="error"||t instanceof zl||t instanceof jo||t instanceof qo||t instanceof xo)return!1;const e=t instanceof Ys||t instanceof vs;let i=!0;return t.eachChild(s=>{i=e?i&&yu(s):i&&s instanceof zs}),!!i&&vo(t)&&jl(t,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function xu(t,e){const i=t.length-1;let s,c,h=0,p=i,y=0;for(;h<=p;)if(y=Math.floor((h+p)/2),s=t[y],c=t[y+1],s<=e){if(y===i||e<c)return y;h=y+1}else{if(!(s>e))throw new Yn("Input is not a number.");p=y-1}return 0}class Gl{constructor(e,i,s){this.type=e,this.input=i,this.labels=[],this.outputs=[];for(const[c,h]of s)this.labels.push(c),this.outputs.push(h)}static parse(e,i){if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return i.error("Expected an even number of arguments.");const s=i.parse(e[1],1,bt);if(!s)return null;const c=[];let h=null;i.expectedType&&i.expectedType.kind!=="value"&&(h=i.expectedType);for(let p=1;p<e.length;p+=2){const y=p===1?-1/0:e[p],v=e[p+1],T=p,E=p+1;if(typeof y!="number")return i.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',T);if(c.length&&c[c.length-1][0]>=y)return i.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',T);const I=i.parse(v,E,h);if(!I)return null;h=h||I.type,c.push([y,I])}return new Gl(h,s,c)}evaluate(e){const i=this.labels,s=this.outputs;if(i.length===1)return s[0].evaluate(e);const c=this.input.evaluate(e);if(c<=i[0])return s[0].evaluate(e);const h=i.length;return c>=i[h-1]?s[h-1].evaluate(e):s[xu(i,c)].evaluate(e)}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){const e=["step",this.input.serialize()];for(let i=0;i<this.labels.length;i++)i>0&&e.push(this.labels[i]),e.push(this.outputs[i].serialize());return e}}const Dp=.95047,kp=1.08883,vu=4/29,Ho=6/29,Rp=3*Ho*Ho,zp=Ho*Ho*Ho,Tg=Math.PI/180,Lp=180/Math.PI;function Pa(t){return t>zp?Math.pow(t,1/3):t/Rp+vu}function ad(t){return t>Ho?t*t*t:Rp*(t-vu)}function ld(t){return 255*(t<=.0031308?12.92*t:1.055*Math.pow(t,1/2.4)-.055)}function cd(t){return(t/=255)<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4)}function Op(t){const e=cd(t.r),i=cd(t.g),s=cd(t.b),c=Pa((.4124564*e+.3575761*i+.1804375*s)/Dp),h=Pa((.2126729*e+.7151522*i+.072175*s)/1);return{l:116*h-16,a:500*(c-h),b:200*(h-Pa((.0193339*e+.119192*i+.9503041*s)/kp)),alpha:t.a}}function Fp(t){let e=(t.l+16)/116,i=isNaN(t.a)?e:e+t.a/500,s=isNaN(t.b)?e:e-t.b/200;return e=1*ad(e),i=Dp*ad(i),s=kp*ad(s),new Bi(ld(3.2404542*i-1.5371385*e-.4985314*s),ld(-.969266*i+1.8760108*e+.041556*s),ld(.0556434*i-.2040259*e+1.0572252*s),t.alpha)}function bu(t,e,i){const s=e-t;return t+i*(s>180||s<-180?s-360*Math.round(s/360):s)}const bo={forward:Op,reverse:Fp,interpolate:function(t,e,i){return{l:hi(t.l,e.l,i),a:hi(t.a,e.a,i),b:hi(t.b,e.b,i),alpha:hi(t.alpha,e.alpha,i)}}},_r={forward:function(t){const{l:e,a:i,b:s}=Op(t),c=Math.atan2(s,i)*Lp;return{h:c<0?c+360:c,c:Math.sqrt(i*i+s*s),l:e,alpha:t.a}},reverse:function(t){const e=t.h*Tg,i=t.c;return Fp({l:t.l,a:Math.cos(e)*i,b:Math.sin(e)*i,alpha:t.alpha})},interpolate:function(t,e,i){return{h:bu(t.h,e.h,i),c:hi(t.c,e.c,i),l:hi(t.l,e.l,i),alpha:hi(t.alpha,e.alpha,i)}}};var Wl=Object.freeze({__proto__:null,hcl:_r,lab:bo});class Xr{constructor(e,i,s,c,h){this.type=e,this.operator=i,this.interpolation=s,this.input=c,this.labels=[],this.outputs=[];for(const[p,y]of h)this.labels.push(p),this.outputs.push(y)}static interpolationFactor(e,i,s,c){let h=0;if(e.name==="exponential")h=ud(i,e.base,s,c);else if(e.name==="linear")h=ud(i,1,s,c);else if(e.name==="cubic-bezier"){const p=e.controlPoints;h=new sp(p[0],p[1],p[2],p[3]).solve(ud(i,1,s,c))}return h}static parse(e,i){let[s,c,h,...p]=e;if(!Array.isArray(c)||c.length===0)return i.error("Expected an interpolation type expression.",1);if(c[0]==="linear")c={name:"linear"};else if(c[0]==="exponential"){const T=c[1];if(typeof T!="number")return i.error("Exponential interpolation requires a numeric base.",1,1);c={name:"exponential",base:T}}else{if(c[0]!=="cubic-bezier")return i.error(`Unknown interpolation type ${String(c[0])}`,1,0);{const T=c.slice(1);if(T.length!==4||T.some(E=>typeof E!="number"||E<0||E>1))return i.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);c={name:"cubic-bezier",controlPoints:T}}}if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return i.error("Expected an even number of arguments.");if(h=i.parse(h,2,bt),!h)return null;const y=[];let v=null;s==="interpolate-hcl"||s==="interpolate-lab"?v=$r:i.expectedType&&i.expectedType.kind!=="value"&&(v=i.expectedType);for(let T=0;T<p.length;T+=2){const E=p[T],I=p[T+1],P=T+3,R=T+4;if(typeof E!="number")return i.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',P);if(y.length&&y[y.length-1][0]>=E)return i.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',P);const L=i.parse(I,R,v);if(!L)return null;v=v||L.type,y.push([E,L])}return v.kind==="number"||v.kind==="color"||v.kind==="array"&&v.itemType.kind==="number"&&typeof v.N=="number"?new Xr(v,s,c,h,y):i.error(`Type ${An(v)} is not interpolatable.`)}evaluate(e){const i=this.labels,s=this.outputs;if(i.length===1)return s[0].evaluate(e);const c=this.input.evaluate(e);if(c<=i[0])return s[0].evaluate(e);const h=i.length;if(c>=i[h-1])return s[h-1].evaluate(e);const p=xu(i,c),y=Xr.interpolationFactor(this.interpolation,c,i[p],i[p+1]),v=s[p].evaluate(e),T=s[p+1].evaluate(e);return this.operator==="interpolate"?Cl[this.type.kind.toLowerCase()](v,T,y):this.operator==="interpolate-hcl"?_r.reverse(_r.interpolate(_r.forward(v),_r.forward(T),y)):bo.reverse(bo.interpolate(bo.forward(v),bo.forward(T),y))}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const i=[this.operator,e,this.input.serialize()];for(let s=0;s<this.labels.length;s++)i.push(this.labels[s],this.outputs[s].serialize());return i}}function ud(t,e,i,s){const c=s-i,h=t-i;return c===0?0:e===1?h/c:(Math.pow(e,h)-1)/(Math.pow(e,c)-1)}class wu{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expectected at least one argument.");let s=null;const c=i.expectedType;c&&c.kind!=="value"&&(s=c);const h=[];for(const y of e.slice(1)){const v=i.parse(y,1+h.length,s,void 0,{typeAnnotation:"omit"});if(!v)return null;s=s||v.type,h.push(v)}const p=c&&h.some(y=>Dl(c,y.type));return new wu(p?Ei:s,h)}evaluate(e){let i,s=null,c=0;for(const h of this.args){if(c++,s=h.evaluate(e),s&&s instanceof Yr&&!s.available&&(i||(i=s),s=null,c===this.args.length))return i;if(s!==null)break}return s}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=["coalesce"];return this.eachChild(i=>{e.push(i.serialize())}),e}}class Tu{constructor(e,i){this.type=i.type,this.bindings=[].concat(e),this.result=i}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const i of this.bindings)e(i[1]);e(this.result)}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const s=[];for(let h=1;h<e.length-1;h+=2){const p=e[h];if(typeof p!="string")return i.error(`Expected string, but found ${typeof p} instead.`,h);if(/[^a-zA-Z0-9_]/.test(p))return i.error("Variable names must contain only alphanumeric characters or '_'.",h);const y=i.parse(e[h+1],h+1);if(!y)return null;s.push([p,y])}const c=i.parse(e[e.length-1],e.length-1,i.expectedType,s);return c?new Tu(s,c):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[i,s]of this.bindings)e.push(i,s.serialize());return e.push(this.result.serialize()),e}}class ql{constructor(e,i,s){this.type=e,this.index=i,this.input=s}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const s=i.parse(e[1],1,bt),c=i.parse(e[2],2,rr(i.expectedType||Ei));return s&&c?new ql(c.type.itemType,s,c):null}evaluate(e){const i=this.index.evaluate(e),s=this.input.evaluate(e);if(i<0)throw new Yn(`Array index out of bounds: ${i} < 0.`);if(i>=s.length)throw new Yn(`Array index out of bounds: ${i} > ${s.length-1}.`);if(i!==Math.floor(i))throw new Yn(`Array index must be an integer, but found ${i} instead.`);return s[i]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class hd{constructor(e,i){this.type=Ri,this.needle=e,this.haystack=i}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const s=i.parse(e[1],1,Ei),c=i.parse(e[2],2,Ei);return s&&c?kl(s.type,[Ri,ki,bt,mi,Ei])?new hd(s,c):i.error(`Expected first argument to be of type boolean, string, number or null, but found ${An(s.type)} instead`):null}evaluate(e){const i=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(s==null)return!1;if(!Vo(i,["boolean","string","number","null"]))throw new Yn(`Expected first argument to be of type boolean, string, number or null, but found ${An(jn(i))} instead.`);if(!Vo(s,["string","array"]))throw new Yn(`Expected second argument to be of type array or string, but found ${An(jn(s))} instead.`);return s.indexOf(i)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class Da{constructor(e,i,s){this.type=bt,this.needle=e,this.haystack=i,this.fromIndex=s}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const s=i.parse(e[1],1,Ei),c=i.parse(e[2],2,Ei);if(!s||!c)return null;if(!kl(s.type,[Ri,ki,bt,mi,Ei]))return i.error(`Expected first argument to be of type boolean, string, number or null, but found ${An(s.type)} instead`);if(e.length===4){const h=i.parse(e[3],3,bt);return h?new Da(s,c,h):null}return new Da(s,c)}evaluate(e){const i=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(!Vo(i,["boolean","string","number","null"]))throw new Yn(`Expected first argument to be of type boolean, string, number or null, but found ${An(jn(i))} instead.`);if(!Vo(s,["string","array"]))throw new Yn(`Expected second argument to be of type array or string, but found ${An(jn(s))} instead.`);if(this.fromIndex){const c=this.fromIndex.evaluate(e);return s.indexOf(i,c)}return s.indexOf(i)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class dd{constructor(e,i,s,c,h,p){this.inputType=e,this.type=i,this.input=s,this.cases=c,this.outputs=h,this.otherwise=p}static parse(e,i){if(e.length<5)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return i.error("Expected an even number of arguments.");let s,c;i.expectedType&&i.expectedType.kind!=="value"&&(c=i.expectedType);const h={},p=[];for(let T=2;T<e.length-1;T+=2){let E=e[T];const I=e[T+1];Array.isArray(E)||(E=[E]);const P=i.concat(T);if(E.length===0)return P.error("Expected at least one branch label.");for(const L of E){if(typeof L!="number"&&typeof L!="string")return P.error("Branch labels must be numbers or strings.");if(typeof L=="number"&&Math.abs(L)>Number.MAX_SAFE_INTEGER)return P.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof L=="number"&&Math.floor(L)!==L)return P.error("Numeric branch labels must be integer values.");if(s){if(P.checkSubtype(s,jn(L)))return null}else s=jn(L);if(h[String(L)]!==void 0)return P.error("Branch labels must be unique.");h[String(L)]=p.length}const R=i.parse(I,T,c);if(!R)return null;c=c||R.type,p.push(R)}const y=i.parse(e[1],1,Ei);if(!y)return null;const v=i.parse(e[e.length-1],e.length-1,c);return v?y.type.kind!=="value"&&i.concat(1).checkSubtype(s,y.type)?null:new dd(s,c,y,h,p,v):null}evaluate(e){const i=this.input.evaluate(e);return(jn(i)===this.inputType&&this.outputs[this.cases[i]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],i=Object.keys(this.cases).sort(),s=[],c={};for(const p of i){const y=c[this.cases[p]];y===void 0?(c[this.cases[p]]=s.length,s.push([this.cases[p],[p]])):s[y][1].push(p)}const h=p=>this.inputType.kind==="number"?Number(p):p;for(const[p,y]of s)e.push(y.length===1?h(y[0]):y.map(h)),e.push(this.outputs[p].serialize());return e.push(this.otherwise.serialize()),e}}class fd{constructor(e,i,s){this.type=e,this.branches=i,this.otherwise=s}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return i.error("Expected an odd number of arguments.");let s;i.expectedType&&i.expectedType.kind!=="value"&&(s=i.expectedType);const c=[];for(let p=1;p<e.length-1;p+=2){const y=i.parse(e[p],p,Ri);if(!y)return null;const v=i.parse(e[p+1],p+1,s);if(!v)return null;c.push([y,v]),s=s||v.type}const h=i.parse(e[e.length-1],e.length-1,s);return h?new fd(s,c,h):null}evaluate(e){for(const[i,s]of this.branches)if(i.evaluate(e))return s.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[i,s]of this.branches)e(i),e(s);e(this.otherwise)}outputDefined(){return this.branches.every(([e,i])=>i.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild(i=>{e.push(i.serialize())}),e}}class ka{constructor(e,i,s,c){this.type=e,this.input=i,this.beginIndex=s,this.endIndex=c}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const s=i.parse(e[1],1,Ei),c=i.parse(e[2],2,bt);if(!s||!c)return null;if(!kl(s.type,[rr(Ei),ki,Ei]))return i.error(`Expected first argument to be of type array or string, but found ${An(s.type)} instead`);if(e.length===4){const h=i.parse(e[3],3,bt);return h?new ka(s.type,s,c,h):null}return new ka(s.type,s,c)}evaluate(e){const i=this.input.evaluate(e),s=this.beginIndex.evaluate(e);if(!Vo(i,["string","array"]))throw new Yn(`Expected first argument to be of type array or string, but found ${An(jn(i))} instead.`);if(this.endIndex){const c=this.endIndex.evaluate(e);return i.slice(s,c)}return i.slice(s)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function Bp(t,e){return t==="=="||t==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function pd(t,e,i,s){return s.compare(e,i)===0}function Zo(t,e,i){const s=t!=="=="&&t!=="!=";return class pM{constructor(h,p,y){this.type=Ri,this.lhs=h,this.rhs=p,this.collator=y,this.hasUntypedArgument=h.type.kind==="value"||p.type.kind==="value"}static parse(h,p){if(h.length!==3&&h.length!==4)return p.error("Expected two or three arguments.");const y=h[0];let v=p.parse(h[1],1,Ei);if(!v)return null;if(!Bp(y,v.type))return p.concat(1).error(`"${y}" comparisons are not supported for type '${An(v.type)}'.`);let T=p.parse(h[2],2,Ei);if(!T)return null;if(!Bp(y,T.type))return p.concat(2).error(`"${y}" comparisons are not supported for type '${An(T.type)}'.`);if(v.type.kind!==T.type.kind&&v.type.kind!=="value"&&T.type.kind!=="value")return p.error(`Cannot compare types '${An(v.type)}' and '${An(T.type)}'.`);s&&(v.type.kind==="value"&&T.type.kind!=="value"?v=new vs(T.type,[v]):v.type.kind!=="value"&&T.type.kind==="value"&&(T=new vs(v.type,[T])));let E=null;if(h.length===4){if(v.type.kind!=="string"&&T.type.kind!=="string"&&v.type.kind!=="value"&&T.type.kind!=="value")return p.error("Cannot use collator to compare non-string types.");if(E=p.parse(h[3],3,Pl),!E)return null}return new pM(v,T,E)}evaluate(h){const p=this.lhs.evaluate(h),y=this.rhs.evaluate(h);if(s&&this.hasUntypedArgument){const v=jn(p),T=jn(y);if(v.kind!==T.kind||v.kind!=="string"&&v.kind!=="number")throw new Yn(`Expected arguments for "${t}" to be (string, string) or (number, number), but found (${v.kind}, ${T.kind}) instead.`)}if(this.collator&&!s&&this.hasUntypedArgument){const v=jn(p),T=jn(y);if(v.kind!=="string"||T.kind!=="string")return e(h,p,y)}return this.collator?i(h,p,y,this.collator.evaluate(h)):e(h,p,y)}eachChild(h){h(this.lhs),h(this.rhs),this.collator&&h(this.collator)}outputDefined(){return!0}serialize(){const h=[t];return this.eachChild(p=>{h.push(p.serialize())}),h}}}const Mg=Zo("==",function(t,e,i){return e===i},pd),md=Zo("!=",function(t,e,i){return e!==i},function(t,e,i,s){return!pd(0,e,i,s)}),Mu=Zo("<",function(t,e,i){return e<i},function(t,e,i,s){return s.compare(e,i)<0}),Np=Zo(">",function(t,e,i){return e>i},function(t,e,i,s){return s.compare(e,i)>0}),Sg=Zo("<=",function(t,e,i){return e<=i},function(t,e,i,s){return s.compare(e,i)<=0}),Vp=Zo(">=",function(t,e,i){return e>=i},function(t,e,i,s){return s.compare(e,i)>=0});class _d{constructor(e,i,s,c,h,p){this.type=ki,this.number=e,this.locale=i,this.currency=s,this.unit=c,this.minFractionDigits=h,this.maxFractionDigits=p}static parse(e,i){if(e.length!==3)return i.error("Expected two arguments.");const s=i.parse(e[1],1,bt);if(!s)return null;const c=e[2];if(typeof c!="object"||Array.isArray(c))return i.error("NumberFormat options argument must be an object.");let h=null;if(c.locale&&(h=i.parse(c.locale,1,ki),!h))return null;let p=null;if(c.currency&&(p=i.parse(c.currency,1,ki),!p))return null;let y=null;if(c.unit&&(y=i.parse(c.unit,1,ki),!y))return null;let v=null;if(c["min-fraction-digits"]&&(v=i.parse(c["min-fraction-digits"],1,bt),!v))return null;let T=null;return c["max-fraction-digits"]&&(T=i.parse(c["max-fraction-digits"],1,bt),!T)?null:new _d(s,h,p,y,v,T)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class Hl{constructor(e){this.type=bt,this.input=e}static parse(e,i){if(e.length!==2)return i.error(`Expected 1 argument, but found ${e.length-1} instead.`);const s=i.parse(e[1],1);return s?s.type.kind!=="array"&&s.type.kind!=="string"&&s.type.kind!=="value"?i.error(`Expected argument of type string or array, but found ${An(s.type)} instead.`):new Hl(s):null}evaluate(e){const i=this.input.evaluate(e);if(typeof i=="string"||Array.isArray(i))return i.length;throw new Yn(`Expected value to be of type string or array, but found ${An(jn(i))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild(i=>{e.push(i.serialize())}),e}}function Up(t){return function(){t=1831565813+(t|=0)|0;let e=Math.imul(t^t>>>15,1|t);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}const Ra={"==":Mg,"!=":md,">":Np,"<":Mu,">=":Vp,"<=":Sg,array:vs,at:ql,boolean:vs,case:fd,coalesce:wu,collator:zl,format:Rl,image:Ea,in:hd,"index-of":Da,interpolate:Xr,"interpolate-hcl":Xr,"interpolate-lab":Xr,length:Hl,let:Tu,literal:zs,match:dd,number:vs,"number-format":_d,object:vs,slice:ka,step:Gl,string:vs,"to-boolean":Ys,"to-color":Ys,"to-number":Ys,"to-string":Ys,var:Qr,within:jo,distance:qo,config:xo};function jp(t,[e,i,s,c]){e=e.evaluate(t),i=i.evaluate(t),s=s.evaluate(t);const h=c?c.evaluate(t):1,p=vp(e,i,s,h);if(p)throw new Yn(p);return new Bi(e/255*h,i/255*h,s/255*h,h)}function Gp(t,[e,i,s,c]){e=e.evaluate(t),i=i.evaluate(t),s=s.evaluate(t);const h=c?c.evaluate(t):1,p=function(T,E,I,P){return typeof T=="number"&&T>=0&&T<=360?typeof E=="number"&&E>=0&&E<=100&&typeof I=="number"&&I>=0&&I<=100?P===void 0||typeof P=="number"&&P>=0&&P<=1?null:`Invalid hsla value [${[T,E,I,P].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof P=="number"?[T,E,I,P]:[T,E,I]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof P=="number"?[T,E,I,P]:[T,E,I]).join(", ")}]: 'h' must be between 0 and 360.`}(e,i,s,h);if(p)throw new Yn(p);const y=`hsla(${e}, ${i}%, ${s}%, ${h})`,v=Bi.parse(y);if(!v)throw new Yn(`Failed to parse HSLA color: ${y}`);return v}function gd(t,e){return t in e}function yd(t,e){const i=e[t];return i===void 0?null:i}function $o(t){return{type:t}}function Wp(t){return{result:"success",value:t}}function Yo(t){return{result:"error",value:t}}function qp(t,e){return!!t&&!!t.parameters&&t.parameters.indexOf(e)>-1}function Su(t){return t["property-type"]==="data-driven"}function Hp(t){return qp(t.expression,"measure-light")}function Zp(t){return qp(t.expression,"zoom")}function za(t){return!!t.expression&&t.expression.interpolated}function xd(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}function Eg(t){return t}function Zl(t,e){const i=e.type==="color",s=t.stops&&typeof t.stops[0][0]=="object",c=s||!(s||t.property!==void 0),h=t.type||(za(e)?"exponential":"interval");if(i&&((t=ou({},t)).stops&&(t.stops=t.stops.map(T=>[T[0],Bi.parse(T[1])])),t.default=Bi.parse(t.default?t.default:e.default)),t.colorSpace&&t.colorSpace!=="rgb"&&!Wl[t.colorSpace])throw new Error(`Unknown color space: ${t.colorSpace}`);let p,y,v;if(h==="exponential")p=vd;else if(h==="interval")p=Ag;else if(h==="categorical"){p=$p,y=Object.create(null);for(const T of t.stops)y[T[0]]=T[1];v=typeof t.stops[0][0]}else{if(h!=="identity")throw new Error(`Unknown function type "${h}"`);p=Yp}if(s){const T={},E=[];for(let R=0;R<t.stops.length;R++){const L=t.stops[R],B=L[0].zoom;T[B]===void 0&&(T[B]={zoom:B,type:t.type,property:t.property,default:t.default,stops:[]},E.push(B)),T[B].stops.push([L[0].value,L[1]])}const I=[];for(const R of E)I.push([T[R].zoom,Zl(T[R],e)]);const P={name:"linear"};return{kind:"composite",interpolationType:P,interpolationFactor:Xr.interpolationFactor.bind(void 0,P),zoomStops:I.map(R=>R[0]),evaluate:({zoom:R},L)=>vd({stops:I,base:t.base},e,R).evaluate(R,L)}}if(c){const T=h==="exponential"?{name:"exponential",base:t.base!==void 0?t.base:1}:null;return{kind:"camera",interpolationType:T,interpolationFactor:Xr.interpolationFactor.bind(void 0,T),zoomStops:t.stops.map(E=>E[0]),evaluate:({zoom:E})=>p(t,e,E,y,v)}}return{kind:"source",evaluate(T,E){const I=E&&E.properties?E.properties[t.property]:void 0;return I===void 0?$l(t.default,e.default):p(t,e,I,y,v)}}}function $l(t,e,i){return t!==void 0?t:e!==void 0?e:i!==void 0?i:void 0}function $p(t,e,i,s,c){return $l(typeof i===c?s[i]:void 0,t.default,e.default)}function Ag(t,e,i){if(go(i)!=="number")return $l(t.default,e.default);const s=t.stops.length;if(s===1||i<=t.stops[0][0])return t.stops[0][1];if(i>=t.stops[s-1][0])return t.stops[s-1][1];const c=xu(t.stops.map(h=>h[0]),i);return t.stops[c][1]}function vd(t,e,i){const s=t.base!==void 0?t.base:1;if(go(i)!=="number")return $l(t.default,e.default);const c=t.stops.length;if(c===1||i<=t.stops[0][0])return t.stops[0][1];if(i>=t.stops[c-1][0])return t.stops[c-1][1];const h=xu(t.stops.map(E=>E[0]),i),p=function(E,I,P,R){const L=R-P,B=E-P;return L===0?0:I===1?B/L:(Math.pow(I,B)-1)/(Math.pow(I,L)-1)}(i,s,t.stops[h][0],t.stops[h+1][0]),y=t.stops[h][1],v=t.stops[h+1][1];let T=Cl[e.type]||Eg;if(t.colorSpace&&t.colorSpace!=="rgb"){const E=Wl[t.colorSpace];T=(I,P)=>E.reverse(E.interpolate(E.forward(I),E.forward(P),p))}return typeof y.evaluate=="function"?{evaluate(...E){const I=y.evaluate.apply(void 0,E),P=v.evaluate.apply(void 0,E);if(I!==void 0&&P!==void 0)return T(I,P,p)}}:T(y,v,p)}function Yp(t,e,i){return e.type==="color"?i=Bi.parse(i):e.type==="formatted"?i=mr.fromString(i.toString()):e.type==="resolvedImage"?i=Yr.fromString(i.toString()):go(i)===e.type||e.type==="enum"&&e.values[i]||(i=void 0),$l(i,t.default,e.default)}Br.register(Ra,{error:[{kind:"error"},[ki],(t,[e])=>{throw new Yn(e.evaluate(t))}],typeof:[ki,[Ei],(t,[e])=>An(jn(e.evaluate(t)))],"to-rgba":[rr(bt,4),[$r],(t,[e])=>e.evaluate(t).toArray()],rgb:[$r,[bt,bt,bt],jp],rgba:[$r,[bt,bt,bt,bt],jp],hsl:[$r,[bt,bt,bt],Gp],hsla:[$r,[bt,bt,bt,bt],Gp],has:{type:Ri,overloads:[[[ki],(t,[e])=>gd(e.evaluate(t),t.properties())],[[ki,wa],(t,[e,i])=>gd(e.evaluate(t),i.evaluate(t))]]},get:{type:Ei,overloads:[[[ki],(t,[e])=>yd(e.evaluate(t),t.properties())],[[ki,wa],(t,[e,i])=>yd(e.evaluate(t),i.evaluate(t))]]},"feature-state":[Ei,[ki],(t,[e])=>yd(e.evaluate(t),t.featureState||{})],properties:[wa,[],t=>t.properties()],"geometry-type":[ki,[],t=>t.geometryType()],id:[Ei,[],t=>t.id()],zoom:[bt,[],t=>t.globals.zoom],pitch:[bt,[],t=>t.globals.pitch||0],"distance-from-center":[bt,[],t=>t.distanceFromCenter()],"measure-light":[bt,[ki],(t,[e])=>t.measureLight(e.evaluate(t))],"heatmap-density":[bt,[],t=>t.globals.heatmapDensity||0],"line-progress":[bt,[],t=>t.globals.lineProgress||0],"raster-value":[bt,[],t=>t.globals.rasterValue||0],"raster-particle-speed":[bt,[],t=>t.globals.rasterParticleSpeed||0],"sky-radial-progress":[bt,[],t=>t.globals.skyRadialProgress||0],accumulated:[Ei,[],t=>t.globals.accumulated===void 0?null:t.globals.accumulated],"+":[bt,$o(bt),(t,e)=>{let i=0;for(const s of e)i+=s.evaluate(t);return i}],"*":[bt,$o(bt),(t,e)=>{let i=1;for(const s of e)i*=s.evaluate(t);return i}],"-":{type:bt,overloads:[[[bt,bt],(t,[e,i])=>e.evaluate(t)-i.evaluate(t)],[[bt],(t,[e])=>-e.evaluate(t)]]},"/":[bt,[bt,bt],(t,[e,i])=>e.evaluate(t)/i.evaluate(t)],"%":[bt,[bt,bt],(t,[e,i])=>e.evaluate(t)%i.evaluate(t)],ln2:[bt,[],()=>Math.LN2],pi:[bt,[],()=>Math.PI],e:[bt,[],()=>Math.E],"^":[bt,[bt,bt],(t,[e,i])=>Math.pow(e.evaluate(t),i.evaluate(t))],sqrt:[bt,[bt],(t,[e])=>Math.sqrt(e.evaluate(t))],log10:[bt,[bt],(t,[e])=>Math.log(e.evaluate(t))/Math.LN10],ln:[bt,[bt],(t,[e])=>Math.log(e.evaluate(t))],log2:[bt,[bt],(t,[e])=>Math.log(e.evaluate(t))/Math.LN2],sin:[bt,[bt],(t,[e])=>Math.sin(e.evaluate(t))],cos:[bt,[bt],(t,[e])=>Math.cos(e.evaluate(t))],tan:[bt,[bt],(t,[e])=>Math.tan(e.evaluate(t))],asin:[bt,[bt],(t,[e])=>Math.asin(e.evaluate(t))],acos:[bt,[bt],(t,[e])=>Math.acos(e.evaluate(t))],atan:[bt,[bt],(t,[e])=>Math.atan(e.evaluate(t))],min:[bt,$o(bt),(t,e)=>Math.min(...e.map(i=>i.evaluate(t)))],max:[bt,$o(bt),(t,e)=>Math.max(...e.map(i=>i.evaluate(t)))],abs:[bt,[bt],(t,[e])=>Math.abs(e.evaluate(t))],round:[bt,[bt],(t,[e])=>{const i=e.evaluate(t);return i<0?-Math.round(-i):Math.round(i)}],floor:[bt,[bt],(t,[e])=>Math.floor(e.evaluate(t))],ceil:[bt,[bt],(t,[e])=>Math.ceil(e.evaluate(t))],"filter-==":[Ri,[ki,Ei],(t,[e,i])=>t.properties()[e.value]===i.value],"filter-id-==":[Ri,[Ei],(t,[e])=>t.id()===e.value],"filter-type-==":[Ri,[ki],(t,[e])=>t.geometryType()===e.value],"filter-<":[Ri,[ki,Ei],(t,[e,i])=>{const s=t.properties()[e.value],c=i.value;return typeof s==typeof c&&s<c}],"filter-id-<":[Ri,[Ei],(t,[e])=>{const i=t.id(),s=e.value;return typeof i==typeof s&&i<s}],"filter->":[Ri,[ki,Ei],(t,[e,i])=>{const s=t.properties()[e.value],c=i.value;return typeof s==typeof c&&s>c}],"filter-id->":[Ri,[Ei],(t,[e])=>{const i=t.id(),s=e.value;return typeof i==typeof s&&i>s}],"filter-<=":[Ri,[ki,Ei],(t,[e,i])=>{const s=t.properties()[e.value],c=i.value;return typeof s==typeof c&&s<=c}],"filter-id-<=":[Ri,[Ei],(t,[e])=>{const i=t.id(),s=e.value;return typeof i==typeof s&&i<=s}],"filter->=":[Ri,[ki,Ei],(t,[e,i])=>{const s=t.properties()[e.value],c=i.value;return typeof s==typeof c&&s>=c}],"filter-id->=":[Ri,[Ei],(t,[e])=>{const i=t.id(),s=e.value;return typeof i==typeof s&&i>=s}],"filter-has":[Ri,[Ei],(t,[e])=>e.value in t.properties()],"filter-has-id":[Ri,[],t=>t.id()!==null&&t.id()!==void 0],"filter-type-in":[Ri,[rr(ki)],(t,[e])=>e.value.indexOf(t.geometryType())>=0],"filter-id-in":[Ri,[rr(Ei)],(t,[e])=>e.value.indexOf(t.id())>=0],"filter-in-small":[Ri,[ki,rr(Ei)],(t,[e,i])=>i.value.indexOf(t.properties()[e.value])>=0],"filter-in-large":[Ri,[ki,rr(Ei)],(t,[e,i])=>function(s,c,h,p){for(;h<=p;){const y=h+p>>1;if(c[y]===s)return!0;c[y]>s?p=y-1:h=y+1}return!1}(t.properties()[e.value],i.value,0,i.value.length-1)],all:{type:Ri,overloads:[[[Ri,Ri],(t,[e,i])=>e.evaluate(t)&&i.evaluate(t)],[$o(Ri),(t,e)=>{for(const i of e)if(!i.evaluate(t))return!1;return!0}]]},any:{type:Ri,overloads:[[[Ri,Ri],(t,[e,i])=>e.evaluate(t)||i.evaluate(t)],[$o(Ri),(t,e)=>{for(const i of e)if(i.evaluate(t))return!0;return!1}]]},"!":[Ri,[Ri],(t,[e])=>!e.evaluate(t)],"is-supported-script":[Ri,[ki],(t,[e])=>{const i=t.globals&&t.globals.isSupportedScript;return!i||i(e.evaluate(t))}],upcase:[ki,[ki],(t,[e])=>e.evaluate(t).toUpperCase()],downcase:[ki,[ki],(t,[e])=>e.evaluate(t).toLowerCase()],concat:[ki,$o(Ei),(t,e)=>e.map(i=>es(i.evaluate(t))).join("")],"resolved-locale":[ki,[Pl],(t,[e])=>e.evaluate(t).resolvedLocale()],random:[bt,[bt,bt,Ei],(t,e)=>{const[i,s,c]=e.map(p=>p.evaluate(t));if(i>s||i===s)return i;let h;if(typeof c=="string")h=function(p){let y=0;if(p.length===0)return y;for(let v=0;v<p.length;v++)y=(y<<5)-y+p.charCodeAt(v),y|=0;return y}(c);else{if(typeof c!="number")throw new Yn(`Invalid seed input: ${c}`);h=c}return i+Up(h)()*(s-i)}]});class Eu{constructor(e,i,s,c){this.expression=e,this._warningHistory={},this._evaluator=new Hh(s,c),this._defaultValue=i?function(h){return h.type==="color"&&(xd(h.default)||Array.isArray(h.default))?new Bi(0,0,0,0):h.type==="color"?Bi.parse(h.default)||null:h.default===void 0?null:h.default}(i):null,this._enumValues=i&&i.type==="enum"?i.values:null}evaluateWithoutErrorHandling(e,i,s,c,h,p,y,v){return this._evaluator.globals=e,this._evaluator.feature=i,this._evaluator.featureState=s,this._evaluator.canonical=c||null,this._evaluator.availableImages=h||null,this._evaluator.formattedSection=p,this._evaluator.featureTileCoord=y||null,this._evaluator.featureDistanceData=v||null,this.expression.evaluate(this._evaluator)}evaluate(e,i,s,c,h,p,y,v){this._evaluator.globals=e,this._evaluator.feature=i||null,this._evaluator.featureState=s||null,this._evaluator.canonical=c||null,this._evaluator.availableImages=h||null,this._evaluator.formattedSection=p||null,this._evaluator.featureTileCoord=y||null,this._evaluator.featureDistanceData=v||null;try{const T=this.expression.evaluate(this._evaluator);if(T==null||typeof T=="number"&&T!=T)return this._defaultValue;if(this._enumValues&&!(T in this._enumValues))throw new Yn(`Expected value to be one of ${Object.keys(this._enumValues).map(E=>JSON.stringify(E)).join(", ")}, but found ${JSON.stringify(T)} instead.`);return T}catch(T){return this._warningHistory[T.message]||(this._warningHistory[T.message]=!0,typeof console<"u"&&console.warn(T.message)),this._defaultValue}}}function Au(t){return Array.isArray(t)&&t.length>0&&typeof t[0]=="string"&&t[0]in Ra}function La(t,e,i,s){const c=new gu(Ra,[],e?function(p){const y={color:$r,string:ki,number:bt,enum:ki,boolean:Ri,formatted:Ta,resolvedImage:Ma};return p.type==="array"?rr(y[p.value]||Ei,p.length):y[p.type]}(e):void 0,void 0,void 0,i,s),h=c.parse(t,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return h?Wp(new Eu(h,e,i,s)):Yo(c.errors)}class Yl{constructor(e,i,s){this.kind=e,this._styleExpression=i,this.isLightConstant=s,this.isStateDependent=e!=="constant"&&!Vl(i.expression),this.isConfigDependent=!Ul(i.expression)}evaluateWithoutErrorHandling(e,i,s,c,h,p){return this._styleExpression.evaluateWithoutErrorHandling(e,i,s,c,h,p)}evaluate(e,i,s,c,h,p){return this._styleExpression.evaluate(e,i,s,c,h,p)}}class Ql{constructor(e,i,s,c,h){this.kind=e,this.zoomStops=s,this._styleExpression=i,this.isStateDependent=e!=="camera"&&!Vl(i.expression),this.isLightConstant=h,this.isConfigDependent=!Ul(i.expression),this.interpolationType=c}evaluateWithoutErrorHandling(e,i,s,c,h,p){return this._styleExpression.evaluateWithoutErrorHandling(e,i,s,c,h,p)}evaluate(e,i,s,c,h,p){return this._styleExpression.evaluate(e,i,s,c,h,p)}interpolationFactor(e,i,s){return this.interpolationType?Xr.interpolationFactor(this.interpolationType,e,i,s):0}}function Qp(t,e,i,s){if((t=La(t,e,i,s)).result==="error")return t;const c=t.value.expression,h=vo(c);if(!h&&!Su(e))return Yo([new xs("","data expressions not supported")]);const p=jl(c,["zoom","pitch","distance-from-center"]);if(!p&&!Zp(e))return Yo([new xs("","zoom expressions not supported")]);const y=jl(c,["measure-light"]);if(!y&&!Hp(e))return Yo([new xs("","measure-light expression not supported")]);const v=e.expression&&e.expression.relaxZoomRestriction,T=Iu(c);return T||p||v?T instanceof xs?Yo([T]):T instanceof Xr&&!za(e)?Yo([new xs("",'"interpolate" expressions cannot be used with this property')]):Wp(T?new Ql(h?"camera":"composite",t.value,T.labels,T instanceof Xr?T.interpolation:void 0,y):new Yl(h?"constant":"source",t.value,y)):Yo([new xs("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class Xl{constructor(e,i){this._parameters=e,this._specification=i,ou(this,Zl(this._parameters,this._specification))}static deserialize(e){return new Xl(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function Iu(t){let e=null;if(t instanceof Tu)e=Iu(t.result);else if(t instanceof wu){for(const i of t.args)if(e=Iu(i),e)break}else(t instanceof Gl||t instanceof Xr)&&t.input instanceof Br&&t.input.name==="zoom"&&(e=t);return e instanceof xs||t.eachChild(i=>{const s=Iu(i);s instanceof xs?e=s:e&&s&&e!==s&&(e=new xs("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}var Xp=Ls,wo=3;function Ls(t,e,i){var s=this.cells=[];if(t instanceof ArrayBuffer){this.arrayBuffer=t;var c=new Int32Array(this.arrayBuffer);t=c[0],this.d=(e=c[1])+2*(i=c[2]);for(var h=0;h<this.d*this.d;h++){var p=c[wo+h],y=c[wo+h+1];s.push(p===y?null:c.subarray(p,y))}var v=c[wo+s.length+1];this.keys=c.subarray(c[wo+s.length],v),this.bboxes=c.subarray(v),this.insert=this._insertReadonly}else{this.d=e+2*i;for(var T=0;T<this.d*this.d;T++)s.push([]);this.keys=[],this.bboxes=[]}this.n=e,this.extent=t,this.padding=i,this.scale=e/t,this.uid=0;var E=i/e*t;this.min=-E,this.max=t+E}Ls.prototype.insert=function(t,e,i,s,c){this._forEachCell(e,i,s,c,this._insertCell,this.uid++),this.keys.push(t),this.bboxes.push(e),this.bboxes.push(i),this.bboxes.push(s),this.bboxes.push(c)},Ls.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},Ls.prototype._insertCell=function(t,e,i,s,c,h){this.cells[c].push(h)},Ls.prototype.query=function(t,e,i,s,c){var h=this.min,p=this.max;if(t<=h&&e<=h&&p<=i&&p<=s&&!c)return Array.prototype.slice.call(this.keys);var y=[];return this._forEachCell(t,e,i,s,this._queryCell,y,{},c),y},Ls.prototype._queryCell=function(t,e,i,s,c,h,p,y){var v=this.cells[c];if(v!==null)for(var T=this.keys,E=this.bboxes,I=0;I<v.length;I++){var P=v[I];if(p[P]===void 0){var R=4*P;(y?y(E[R+0],E[R+1],E[R+2],E[R+3]):t<=E[R+2]&&e<=E[R+3]&&i>=E[R+0]&&s>=E[R+1])?(p[P]=!0,h.push(T[P])):p[P]=!1}}},Ls.prototype._forEachCell=function(t,e,i,s,c,h,p,y){for(var v=this._convertToCellCoord(t),T=this._convertToCellCoord(e),E=this._convertToCellCoord(i),I=this._convertToCellCoord(s),P=v;P<=E;P++)for(var R=T;R<=I;R++){var L=this.d*R+P;if((!y||y(this._convertFromCellCoord(P),this._convertFromCellCoord(R),this._convertFromCellCoord(P+1),this._convertFromCellCoord(R+1)))&&c.call(this,t,e,i,s,L,h,p,y))return}},Ls.prototype._convertFromCellCoord=function(t){return(t-this.padding)/this.scale},Ls.prototype._convertToCellCoord=function(t){return Math.max(0,Math.min(this.d-1,Math.floor(t*this.scale)+this.padding))},Ls.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var t=this.cells,e=wo+this.cells.length+1+1,i=0,s=0;s<this.cells.length;s++)i+=this.cells[s].length;var c=new Int32Array(e+i+this.keys.length+this.bboxes.length);c[0]=this.extent,c[1]=this.n,c[2]=this.padding;for(var h=e,p=0;p<t.length;p++){var y=t[p];c[wo+p]=h,c.set(y,h),h+=y.length}return c[wo+t.length]=h,c.set(this.keys,h),c[wo+t.length+1]=h+=this.keys.length,c.set(this.bboxes,h),h+=this.bboxes.length,c.buffer};var Oa=Ee(Xp);const Cu={};function Mt(t,e,i={}){Object.defineProperty(t,"_classRegistryKey",{value:e,writeable:!1}),Cu[e]={klass:t,omit:i.omit||[]}}Mt(Object,"Object"),Oa.serialize=function(t,e){const i=t.toArrayBuffer();return e&&e.add(i),{buffer:i}},Oa.deserialize=function(t){return new Oa(t.buffer)},Object.defineProperty(Oa,"name",{value:"Grid"}),Mt(Oa,"Grid"),Mt(Bi,"Color"),Mt(Error,"Error"),Mt(mr,"Formatted"),Mt(au,"FormattedSection"),Mt(Yc,"AJAXError"),Mt(Yr,"ResolvedImage"),Mt(Xl,"StylePropertyFunction"),Mt(Eu,"StyleExpression",{omit:["_evaluator"]}),Mt(Ql,"ZoomDependentExpression"),Mt(Yl,"ZoomConstantExpression"),Mt(Br,"CompoundExpression",{omit:["_evaluate"]});for(const t in Ra)Cu[Ra[t]._classRegistryKey]||Mt(Ra[t],`Expression${t}`);function Kp(t){return t&&typeof ArrayBuffer<"u"&&(t instanceof ArrayBuffer||t.constructor&&t.constructor.name==="ArrayBuffer")}function Jp(t){return self.ImageBitmap&&t instanceof ImageBitmap}function Kl(t,e){if(t==null||typeof t=="boolean"||typeof t=="number"||typeof t=="string"||t instanceof Boolean||t instanceof Number||t instanceof String||t instanceof Date||t instanceof RegExp)return t;if(Kp(t)||Jp(t))return e&&e.add(t),t;if(ArrayBuffer.isView(t)){const i=t;return e&&e.add(i.buffer),i}if(t instanceof ImageData)return e&&e.add(t.data.buffer),t;if(Array.isArray(t)){const i=[];for(const s of t)i.push(Kl(s,e));return i}if(t instanceof Map){const i={$name:"Map"};for(const[s,c]of t.entries())i[s]=Kl(c);return i}if(typeof t=="object"){const i=t.constructor,s=i._classRegistryKey;if(!s)throw new Error(`can't serialize object of unregistered class ${s}`);const c=i.serialize?i.serialize(t,e):{};if(!i.serialize){for(const h in t)t.hasOwnProperty(h)&&(Cu[s].omit.indexOf(h)>=0||(c[h]=Kl(t[h],e)));t instanceof Error&&(c.message=t.message)}if(c.$name)throw new Error("$name property is reserved for worker serialization logic.");return s!=="Object"&&(c.$name=s),c}throw new Error("can't serialize object of type "+typeof t)}function d(t){if(t==null||typeof t=="boolean"||typeof t=="number"||typeof t=="string"||t instanceof Boolean||t instanceof Number||t instanceof String||t instanceof Date||t instanceof RegExp||Kp(t)||Jp(t)||ArrayBuffer.isView(t)||t instanceof ImageData)return t;if(Array.isArray(t))return t.map(d);if(typeof t=="object"){const e=t.$name||"Object";if(e==="Map"){const c=new Map;for(const h of Object.keys(t))h!=="$name"&&c.set(h,d(t[h]));return c}const{klass:i}=Cu[e];if(!i)throw new Error(`can't deserialize unregistered class ${e}`);if(i.deserialize)return i.deserialize(t);const s=Object.create(i.prototype);for(const c of Object.keys(t))c!=="$name"&&(s[c]=d(t[c]));return s}throw new Error("can't deserialize object of type "+typeof t)}const n={"Latin-1 Supplement":t=>t>=128&&t<=255,Arabic:t=>t>=1536&&t<=1791,"Arabic Supplement":t=>t>=1872&&t<=1919,"Arabic Extended-A":t=>t>=2208&&t<=2303,"Hangul Jamo":t=>t>=4352&&t<=4607,"Unified Canadian Aboriginal Syllabics":t=>t>=5120&&t<=5759,Khmer:t=>t>=6016&&t<=6143,"Unified Canadian Aboriginal Syllabics Extended":t=>t>=6320&&t<=6399,"General Punctuation":t=>t>=8192&&t<=8303,"Letterlike Symbols":t=>t>=8448&&t<=8527,"Number Forms":t=>t>=8528&&t<=8591,"Miscellaneous Technical":t=>t>=8960&&t<=9215,"Control Pictures":t=>t>=9216&&t<=9279,"Optical Character Recognition":t=>t>=9280&&t<=9311,"Enclosed Alphanumerics":t=>t>=9312&&t<=9471,"Geometric Shapes":t=>t>=9632&&t<=9727,"Miscellaneous Symbols":t=>t>=9728&&t<=9983,"Miscellaneous Symbols and Arrows":t=>t>=11008&&t<=11263,"CJK Radicals Supplement":t=>t>=11904&&t<=12031,"Kangxi Radicals":t=>t>=12032&&t<=12255,"Ideographic Description Characters":t=>t>=12272&&t<=12287,"CJK Symbols and Punctuation":t=>t>=12288&&t<=12351,Hiragana:t=>t>=12352&&t<=12447,Katakana:t=>t>=12448&&t<=12543,Bopomofo:t=>t>=12544&&t<=12591,"Hangul Compatibility Jamo":t=>t>=12592&&t<=12687,Kanbun:t=>t>=12688&&t<=12703,"Bopomofo Extended":t=>t>=12704&&t<=12735,"CJK Strokes":t=>t>=12736&&t<=12783,"Katakana Phonetic Extensions":t=>t>=12784&&t<=12799,"Enclosed CJK Letters and Months":t=>t>=12800&&t<=13055,"CJK Compatibility":t=>t>=13056&&t<=13311,"CJK Unified Ideographs Extension A":t=>t>=13312&&t<=19903,"Yijing Hexagram Symbols":t=>t>=19904&&t<=19967,"CJK Unified Ideographs":t=>t>=19968&&t<=40959,"Yi Syllables":t=>t>=40960&&t<=42127,"Yi Radicals":t=>t>=42128&&t<=42191,"Hangul Jamo Extended-A":t=>t>=43360&&t<=43391,"Hangul Syllables":t=>t>=44032&&t<=55215,"Hangul Jamo Extended-B":t=>t>=55216&&t<=55295,"Private Use Area":t=>t>=57344&&t<=63743,"CJK Compatibility Ideographs":t=>t>=63744&&t<=64255,"Arabic Presentation Forms-A":t=>t>=64336&&t<=65023,"Vertical Forms":t=>t>=65040&&t<=65055,"CJK Compatibility Forms":t=>t>=65072&&t<=65103,"Small Form Variants":t=>t>=65104&&t<=65135,"Arabic Presentation Forms-B":t=>t>=65136&&t<=65279,"Halfwidth and Fullwidth Forms":t=>t>=65280&&t<=65519,"CJK Unified Ideographs Extension B":t=>t>=131072&&t<=173791};function a(t){for(const e of t)if(x(e.charCodeAt(0)))return!0;return!1}function f(t){for(const e of t)if(!_(e.charCodeAt(0)))return!1;return!0}function _(t){return!(n.Arabic(t)||n["Arabic Supplement"](t)||n["Arabic Extended-A"](t)||n["Arabic Presentation Forms-A"](t)||n["Arabic Presentation Forms-B"](t))}function x(t){return!(t!==746&&t!==747&&(t<4352||!(n["Bopomofo Extended"](t)||n.Bopomofo(t)||n["CJK Compatibility Forms"](t)&&!(t>=65097&&t<=65103)||n["CJK Compatibility Ideographs"](t)||n["CJK Compatibility"](t)||n["CJK Radicals Supplement"](t)||n["CJK Strokes"](t)||!(!n["CJK Symbols and Punctuation"](t)||t>=12296&&t<=12305||t>=12308&&t<=12319||t===12336)||n["CJK Unified Ideographs Extension A"](t)||n["CJK Unified Ideographs"](t)||n["Enclosed CJK Letters and Months"](t)||n["Hangul Compatibility Jamo"](t)||n["Hangul Jamo Extended-A"](t)||n["Hangul Jamo Extended-B"](t)||n["Hangul Jamo"](t)||n["Hangul Syllables"](t)||n.Hiragana(t)||n["Ideographic Description Characters"](t)||n.Kanbun(t)||n["Kangxi Radicals"](t)||n["Katakana Phonetic Extensions"](t)||n.Katakana(t)&&t!==12540||!(!n["Halfwidth and Fullwidth Forms"](t)||t===65288||t===65289||t===65293||t>=65306&&t<=65310||t===65339||t===65341||t===65343||t>=65371&&t<=65503||t===65507||t>=65512&&t<=65519)||!(!n["Small Form Variants"](t)||t>=65112&&t<=65118||t>=65123&&t<=65126)||n["Unified Canadian Aboriginal Syllabics"](t)||n["Unified Canadian Aboriginal Syllabics Extended"](t)||n["Vertical Forms"](t)||n["Yijing Hexagram Symbols"](t)||n["Yi Syllables"](t)||n["Yi Radicals"](t))))}function w(t){return!(x(t)||function(e){return!!(n["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||n["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||n["Letterlike Symbols"](e)||n["Number Forms"](e)||n["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||n["Control Pictures"](e)&&e!==9251||n["Optical Character Recognition"](e)||n["Enclosed Alphanumerics"](e)||n["Geometric Shapes"](e)||n["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||n["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||n["CJK Symbols and Punctuation"](e)||n.Katakana(e)||n["Private Use Area"](e)||n["CJK Compatibility Forms"](e)||n["Small Form Variants"](e)||n["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)}(t))}function S(t){return t>=1424&&t<=2303||n["Arabic Presentation Forms-A"](t)||n["Arabic Presentation Forms-B"](t)}function C(t,e){return!(!e&&S(t)||t>=2304&&t<=3583||t>=3840&&t<=4255||n.Khmer(t))}function D(t){for(const e of t)if(S(e.charCodeAt(0)))return!0;return!1}const z="deferred",O="loading",V="loaded";let U=null,H="unavailable",q=null;const Z=function(t){t&&typeof t=="string"&&t.indexOf("NetworkError")>-1&&(H="error"),U&&U(t)};function $(){K.fire(new mo("pluginStateChange",{pluginStatus:H,pluginURL:q}))}const K=new No,oe=function(){return H},se=function(){if(H!==z||!q)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");H=O,$(),q&&bl({url:q},t=>{t?Z(t):(H=V,$())})},le={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>H===V||le.applyArabicShaping!=null,isLoading:()=>H===O,setState(t){H=t.pluginStatus,q=t.pluginURL},isParsed:()=>le.applyArabicShaping!=null&&le.processBidirectionalText!=null&&le.processStyledBidirectionalText!=null,getPluginURL:()=>q};class Y{constructor(e,i){this.zoom=e,i?(this.now=i.now,this.fadeDuration=i.fadeDuration,this.transition=i.transition,this.pitch=i.pitch,this.brightness=i.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return function(i,s){for(const c of i)if(!C(c.charCodeAt(0),s))return!1;return!0}(e,le.isLoaded())}}class ee{constructor(e,i,s,c){this.property=e,this.value=i,this.expression=function(h,p,y,v){if(xd(h))return new Xl(h,p);if(Au(h)||Array.isArray(h)&&h.length>0){const T=Qp(h,p,y,v);if(T.result==="error")throw new Error(T.value.map(E=>`${E.key}: ${E.message}`).join(", "));return T.value}{let T=h;return typeof h=="string"&&p.type==="color"&&(T=Bi.parse(h)),{kind:"constant",isConfigDependent:!1,evaluate:()=>T}}}(i===void 0?e.specification.default:i,e.specification,s,c)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,i,s){return this.property.possiblyEvaluate(this,e,i,s)}}class me{constructor(e,i,s){this.property=e,this.value=new ee(e,void 0,i,s)}transitioned(e,i){return new xe(this.property,this.value,i,Jr({},e.transition,this.transition),e.now)}untransitioned(){return new xe(this.property,this.value,null,{},0)}}class fe{constructor(e,i,s){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=i,this._options=s,this.isConfigDependent=!1}getValue(e){return Hs(this._values[e].value.value)}setValue(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new me(this._values[e].property,this._scope,this._options)),this._values[e].value=new ee(this._values[e].property,i===null?void 0:Hs(i),this._scope,this._options),this.isConfigDependent=this.isConfigDependent||this._values[e].value.expression.isConfigDependent}setTransitionOrValue(e,i){i&&(this._options=i);const s=this._properties.properties;if(e)for(const c in e){const h=e[c];if(Lo(c,"-transition")){const p=c.slice(0,-11);s[p]&&this.setTransition(p,h)}else s[c]&&this.setValue(c,h)}}getTransition(e){return Hs(this._values[e].transition)}setTransition(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new me(this._values[e].property)),this._values[e].transition=Hs(i)||void 0}serialize(){const e={};for(const i of Object.keys(this._values)){const s=this.getValue(i);s!==void 0&&(e[i]=s);const c=this.getTransition(i);c!==void 0&&(e[`${i}-transition`]=c)}return e}transitioned(e,i){const s=new ke(this._properties);for(const c of Object.keys(this._values))s._values[c]=this._values[c].transitioned(e,i._values[c]);return s}untransitioned(){const e=new ke(this._properties);for(const i of Object.keys(this._values))e._values[i]=this._values[i].untransitioned();return e}}class xe{constructor(e,i,s,c,h){const p=c.delay||0,y=c.duration||0;h=h||0,this.property=e,this.value=i,this.begin=h+p,this.end=this.begin+y,e.specification.transition&&(c.delay||c.duration)&&(this.prior=s)}possiblyEvaluate(e,i,s){const c=e.now||0,h=this.value.possiblyEvaluate(e,i,s),p=this.prior;if(p){if(c>this.end)return this.prior=null,h;if(this.value.isDataDriven())return this.prior=null,h;if(c<this.begin)return p.possiblyEvaluate(e,i,s);{const y=(c-this.begin)/(this.end-this.begin);return this.property.interpolate(p.possiblyEvaluate(e,i,s),h,Fc(y))}}return h}}class ke{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,i,s){const c=new ze(this._properties);for(const h of Object.keys(this._values))c._values[h]=this._values[h].possiblyEvaluate(e,i,s);return c}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class ye{constructor(e,i,s){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=i,this._options=s,this.isConfigDependent=!1}getValue(e){return Hs(this._values[e].value)}setValue(e,i){this._values[e]=new ee(this._values[e].property,i===null?void 0:Hs(i),this._scope,this._options),this.isConfigDependent=this.isConfigDependent||this._values[e].expression.isConfigDependent}serialize(){const e={};for(const i of Object.keys(this._values)){const s=this.getValue(i);s!==void 0&&(e[i]=s)}return e}possiblyEvaluate(e,i,s){const c=new ze(this._properties);for(const h of Object.keys(this._values))c._values[h]=this._values[h].possiblyEvaluate(e,i,s);return c}}class Pe{constructor(e,i,s){this.property=e,this.value=i,this.parameters=s}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,i,s,c){return this.property.evaluate(this.value,this.parameters,e,i,s,c)}}class ze{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class ge{constructor(e){this.specification=e}possiblyEvaluate(e,i){return e.expression.evaluate(i)}interpolate(e,i,s){const c=Cl[this.specification.type];return c?c(e,i,s):e}}class Ae{constructor(e,i){this.specification=e,this.overrides=i}possiblyEvaluate(e,i,s,c){return new Pe(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(i,null,{},s,c)}:e.expression,i)}interpolate(e,i,s){if(e.value.kind!=="constant"||i.value.kind!=="constant")return e;if(e.value.value===void 0||i.value.value===void 0)return new Pe(this,{kind:"constant",value:void 0},e.parameters);const c=Cl[this.specification.type];return c?new Pe(this,{kind:"constant",value:c(e.value.value,i.value.value,s)},e.parameters):e}evaluate(e,i,s,c,h,p){return e.kind==="constant"?e.value:e.evaluate(i,s,c,h,p)}}class Ye{constructor(e){this.specification=e}possiblyEvaluate(e,i,s,c){return!!e.expression.evaluate(i,null,{},s,c)}interpolate(){return!1}}class we{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const i=new Y(0,{});for(const s in e){const c=e[s];c.specification.overridable&&this.overridableProperties.push(s);const h=this.defaultPropertyValues[s]=new ee(c,void 0),p=this.defaultTransitionablePropertyValues[s]=new me(c);this.defaultTransitioningPropertyValues[s]=p.untransitioned(),this.defaultPossiblyEvaluatedValues[s]=h.possiblyEvaluate(i)}}}function De(t){return t instanceof Number||t instanceof String||t instanceof Boolean?t.valueOf():t}function Re(t){if(Array.isArray(t))return t.map(Re);if(t instanceof Object&&!(t instanceof Number||t instanceof String||t instanceof Boolean)){const e={};for(const i in t)e[i]=Re(t[i]);return e}return De(t)}Mt(Ae,"DataDrivenProperty"),Mt(ge,"DataConstantProperty"),Mt(Ye,"ColorRampProperty");var ae=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"camera":{"type":"camera"},"imports":{"type":"array","value":"import"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"expression":{},"property-type":"data-constant"},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"required":true,"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","private":true,"default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","private":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"raster-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-particle-count":{"type":"number","default":512,"minimum":1,"property-type":"data-constant"},"raster-particle-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-particle-speed"]},"property-type":"color-ramp"},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1,"property-type":"data-constant"},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1,"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"expression":{},"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"model-front-cutoff":{"type":"array","private":true,"value":"number","property-type":"data-constant","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');function Ue(t){if(t===!0||t===!1)return!0;if(!Array.isArray(t)||t.length===0)return!1;switch(t[0]){case"has":return t.length>=2&&t[1]!=="$id"&&t[1]!=="$type";case"in":return t.length>=3&&(typeof t[1]!="string"||Array.isArray(t[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return t.length!==3||Array.isArray(t[1])||Array.isArray(t[2]);case"any":case"all":for(const e of t.slice(1))if(!Ue(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function gt(t,e="fill"){if(t==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Ue(t)||(t=Ti(t));const i=t;let s=!0;try{s=function(T){if(!Pt(T))return T;let E=Re(T);return zt(E),E=Et(E),E}(i)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(i,null,2)}
        `)}const c=ae[`filter_${e}`],h=La(s,c);let p=null;if(h.result==="error")throw new Error(h.value.map(T=>`${T.key}: ${T.message}`).join(", "));p=(T,E,I)=>h.value.evaluate(T,E,{},I);let y=null,v=null;if(s!==i){const T=La(i,c);if(T.result==="error")throw new Error(T.value.map(E=>`${E.key}: ${E.message}`).join(", "));y=(E,I,P,R,L)=>T.value.evaluate(E,I,{},P,void 0,void 0,R,L),v=!vo(T.value.expression)}return{filter:p,dynamicFilter:y||void 0,needGeometry:Jt(s),needFeature:!!v}}function Et(t){if(!Array.isArray(t))return t;const e=function(i){if(Ut.has(i[0])){for(let s=1;s<i.length;s++)if(Pt(i[s]))return!0}return i}(t);return e===!0?e:e.map(i=>Et(i))}function zt(t){let e=!1;const i=[];if(t[0]==="case"){for(let s=1;s<t.length-1;s+=2)e=e||Pt(t[s]),i.push(t[s+1]);i.push(t[t.length-1])}else if(t[0]==="match"){e=e||Pt(t[1]);for(let s=2;s<t.length-1;s+=2)i.push(t[s+1]);i.push(t[t.length-1])}else if(t[0]==="step"){e=e||Pt(t[1]);for(let s=1;s<t.length-1;s+=2)i.push(t[s+1])}e&&(t.length=0,t.push("any",...i));for(let s=1;s<t.length;s++)zt(t[s])}function Pt(t){if(!Array.isArray(t))return!1;if((e=t[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let i=1;i<t.length;i++)if(Pt(t[i]))return!0;return!1}const Ut=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function vi(t,e){return t<e?-1:t>e?1:0}function Jt(t){if(!Array.isArray(t))return!1;if(t[0]==="within"||t[0]==="distance")return!0;for(let e=1;e<t.length;e++)if(Jt(t[e]))return!0;return!1}function Ti(t){if(!t)return!0;const e=t[0];return t.length<=1?e!=="any":e==="=="?bi(t[1],t[2],"=="):e==="!="?Gn(bi(t[1],t[2],"==")):e==="<"||e===">"||e==="<="||e===">="?bi(t[1],t[2],e):e==="any"?(i=t.slice(1),["any"].concat(i.map(Ti))):e==="all"?["all"].concat(t.slice(1).map(Ti)):e==="none"?["all"].concat(t.slice(1).map(Ti).map(Gn)):e==="in"?hn(t[1],t.slice(2)):e==="!in"?Gn(hn(t[1],t.slice(2))):e==="has"?Ni(t[1]):e!=="!has"||Gn(Ni(t[1]));var i}function bi(t,e,i){switch(t){case"$type":return[`filter-type-${i}`,e];case"$id":return[`filter-id-${i}`,e];default:return[`filter-${i}`,t,e]}}function hn(t,e){if(e.length===0)return!1;switch(t){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(i=>typeof i!=typeof e[0])?["filter-in-large",t,["literal",e.sort(vi)]]:["filter-in-small",t,["literal",e]]}}function Ni(t){switch(t){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",t]}}function Gn(t){return["!",t]}const Dn="";function Xi(t,e){return e?`${t}${Dn}${e}`:t}const Gi="-transition",li=new Set(["fill","line","background","hillshade","raster"]);class ui extends No{constructor(e,i,s,c){if(super(),this.id=e.id,this.fqid=Xi(this.id,s),this.type=e.type,this.scope=s,this.options=c,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.isConfigDependent=!1,e.type!=="custom"&&(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type!=="background"&&e.type!=="sky"&&e.type!=="slot"&&(this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter),e.slot&&(this.slot=e.slot),i.layout&&(this._unevaluatedLayout=new ye(i.layout,this.scope,c),this.isConfigDependent=this.isConfigDependent||this._unevaluatedLayout.isConfigDependent),i.paint)){this._transitionablePaint=new fe(i.paint,this.scope,c);for(const h in e.paint)this.setPaintProperty(h,e.paint[h]);for(const h in e.layout)this.setLayoutProperty(h,e.layout[h]);this.isConfigDependent=this.isConfigDependent||this._transitionablePaint.isConfigDependent,this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new ze(i.paint)}}onAdd(e){}onRemove(e){}isDraped(e){return li.has(this.type)}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,i){if(this.type==="custom"&&e==="visibility")return void(this.visibility=i);const s=this._unevaluatedLayout;s._properties.properties[e]&&(s.setValue(e,i),this.isConfigDependent=this.isConfigDependent||s.isConfigDependent,e==="visibility"&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0})}getPaintProperty(e){return Lo(e,Gi)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,i){const s=this._transitionablePaint,c=s._properties.properties;if(Lo(e,Gi)){const I=e.slice(0,-11);return c[I]&&s.setTransition(I,i||void 0),!1}if(!c[e])return!1;const h=s._values[e],p=h.value.isDataDriven(),y=h.value;s.setValue(e,i),this.isConfigDependent=this.isConfigDependent||s.isConfigDependent,this._handleSpecialPaintPropertyUpdate(e);const v=s._values[e].value,T=v.isDataDriven(),E=Lo(e,"pattern")||e==="line-dasharray";return T||p||E||this._handleOverridablePaintPropertyUpdate(e,y,v)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,i){return null}_handleOverridablePaintPropertyUpdate(e,i,s){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,i){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,i)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,i)}serialize(){return ml({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(e,i)=>!(e===void 0||i==="layout"&&!Object.keys(e).length||i==="paint"&&!Object.keys(e).length))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}isStateDependent(){for(const e in this.paint._values){const i=this.paint.get(e);if(i instanceof Pe&&Su(i.property.specification)&&(i.value.kind==="source"||i.value.kind==="composite")&&i.value.isStateDependent)return!0}return!1}compileFilter(){this._filterCompiled||(this._featureFilter=gt(this.filter),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&(e.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(e){}queryIntersectsFeature(e,i,s,c,h,p,y,v,T){}queryIntersectsMatchingFeature(e,i,s,c){}}const rn={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Ki{constructor(e,i){this._structArray=e,this._pos1=i*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class _i{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(e,i){return e._trim(),i&&(e.isTransferred=!0,i.add(e.arrayBuffer)),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const i=Object.create(this.prototype);return i.arrayBuffer=e.arrayBuffer,i.length=e.length,i.capacity=e.arrayBuffer.byteLength/i.bytesPerElement,i._refreshViews(),i}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const i=this.uint8;this._refreshViews(),i&&this.uint8.set(i)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function ni(t,e=1){let i=0,s=0;return{members:t.map(c=>{const h=rn[c.type].BYTES_PER_ELEMENT,p=i=Rr(i,Math.max(e,h)),y=c.components||1;return s=Math.max(s,h),i+=h*y,{name:c.name,type:c.type,components:y,offset:p}}),size:Rr(i,Math.max(s,e)),alignment:e}}function Rr(t,e){return Math.ceil(t/e)*e}class gr extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i){const s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){const c=2*e;return this.int16[c+0]=i,this.int16[c+1]=s,e}}gr.prototype.bytesPerElement=4,Mt(gr,"StructArrayLayout2i4");class Qn extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s){const c=this.length;return this.resize(c+1),this.emplace(c,e,i,s)}emplace(e,i,s,c){const h=3*e;return this.int16[h+0]=i,this.int16[h+1]=s,this.int16[h+2]=c,e}}Qn.prototype.bytesPerElement=6,Mt(Qn,"StructArrayLayout3i6");class yr extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,c){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,c)}emplace(e,i,s,c,h){const p=4*e;return this.int16[p+0]=i,this.int16[p+1]=s,this.int16[p+2]=c,this.int16[p+3]=h,e}}yr.prototype.bytesPerElement=8,Mt(yr,"StructArrayLayout4i8");class zr extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,c,h){const p=this.length;return this.resize(p+1),this.emplace(p,e,i,s,c,h)}emplace(e,i,s,c,h,p){const y=5*e;return this.int16[y+0]=i,this.int16[y+1]=s,this.int16[y+2]=c,this.int16[y+3]=h,this.int16[y+4]=p,e}}zr.prototype.bytesPerElement=10,Mt(zr,"StructArrayLayout5i10");class Tr extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,c,h,p,y){const v=this.length;return this.resize(v+1),this.emplace(v,e,i,s,c,h,p,y)}emplace(e,i,s,c,h,p,y,v){const T=6*e,E=12*e,I=3*e;return this.int16[T+0]=i,this.int16[T+1]=s,this.uint8[E+4]=c,this.uint8[E+5]=h,this.uint8[E+6]=p,this.uint8[E+7]=y,this.float32[I+2]=v,e}}Tr.prototype.bytesPerElement=12,Mt(Tr,"StructArrayLayout2i4ub1f12");class Xn extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,c){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,c)}emplace(e,i,s,c,h){const p=4*e;return this.float32[p+0]=i,this.float32[p+1]=s,this.float32[p+2]=c,this.float32[p+3]=h,e}}Xn.prototype.bytesPerElement=16,Mt(Xn,"StructArrayLayout4f16");class cr extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i){const s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){const c=2*e;return this.float32[c+0]=i,this.float32[c+1]=s,e}}cr.prototype.bytesPerElement=8,Mt(cr,"StructArrayLayout2f8");class ur extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,c,h){const p=this.length;return this.resize(p+1),this.emplace(p,e,i,s,c,h)}emplace(e,i,s,c,h,p){const y=6*e,v=3*e;return this.uint16[y+0]=i,this.uint16[y+1]=s,this.uint16[y+2]=c,this.uint16[y+3]=h,this.float32[v+2]=p,e}}ur.prototype.bytesPerElement=12,Mt(ur,"StructArrayLayout4ui1f12");class Os extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,c){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,c)}emplace(e,i,s,c,h){const p=4*e;return this.uint16[p+0]=i,this.uint16[p+1]=s,this.uint16[p+2]=c,this.uint16[p+3]=h,e}}Os.prototype.bytesPerElement=8,Mt(Os,"StructArrayLayout4ui8");class ws extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,c,h,p){const y=this.length;return this.resize(y+1),this.emplace(y,e,i,s,c,h,p)}emplace(e,i,s,c,h,p,y){const v=6*e;return this.int16[v+0]=i,this.int16[v+1]=s,this.int16[v+2]=c,this.int16[v+3]=h,this.int16[v+4]=p,this.int16[v+5]=y,e}}ws.prototype.bytesPerElement=12,Mt(ws,"StructArrayLayout6i12");class Fs extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,c,h,p,y,v,T,E,I,P){const R=this.length;return this.resize(R+1),this.emplace(R,e,i,s,c,h,p,y,v,T,E,I,P)}emplace(e,i,s,c,h,p,y,v,T,E,I,P,R){const L=12*e;return this.int16[L+0]=i,this.int16[L+1]=s,this.int16[L+2]=c,this.int16[L+3]=h,this.uint16[L+4]=p,this.uint16[L+5]=y,this.uint16[L+6]=v,this.uint16[L+7]=T,this.int16[L+8]=E,this.int16[L+9]=I,this.int16[L+10]=P,this.int16[L+11]=R,e}}Fs.prototype.bytesPerElement=24,Mt(Fs,"StructArrayLayout4i4ui4i24");class Bs extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,c,h,p){const y=this.length;return this.resize(y+1),this.emplace(y,e,i,s,c,h,p)}emplace(e,i,s,c,h,p,y){const v=10*e,T=5*e;return this.int16[v+0]=i,this.int16[v+1]=s,this.int16[v+2]=c,this.float32[T+2]=h,this.float32[T+3]=p,this.float32[T+4]=y,e}}Bs.prototype.bytesPerElement=20,Mt(Bs,"StructArrayLayout3i3f20");class To extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint32[1*e+0]=i,e}}To.prototype.bytesPerElement=4,Mt(To,"StructArrayLayout1ul4");class ts extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i){const s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){const c=2*e;return this.uint16[c+0]=i,this.uint16[c+1]=s,e}}ts.prototype.bytesPerElement=4,Mt(ts,"StructArrayLayout2ui4");class Jl extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,c,h,p,y,v,T,E,I,P,R){const L=this.length;return this.resize(L+1),this.emplace(L,e,i,s,c,h,p,y,v,T,E,I,P,R)}emplace(e,i,s,c,h,p,y,v,T,E,I,P,R,L){const B=20*e,j=10*e;return this.int16[B+0]=i,this.int16[B+1]=s,this.int16[B+2]=c,this.int16[B+3]=h,this.int16[B+4]=p,this.float32[j+3]=y,this.float32[j+4]=v,this.float32[j+5]=T,this.float32[j+6]=E,this.int16[B+14]=I,this.uint32[j+8]=P,this.uint16[B+18]=R,this.uint16[B+19]=L,e}}Jl.prototype.bytesPerElement=40,Mt(Jl,"StructArrayLayout5i4f1i1ul2ui40");class Fa extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,c,h,p,y){const v=this.length;return this.resize(v+1),this.emplace(v,e,i,s,c,h,p,y)}emplace(e,i,s,c,h,p,y,v){const T=8*e;return this.int16[T+0]=i,this.int16[T+1]=s,this.int16[T+2]=c,this.int16[T+4]=h,this.int16[T+5]=p,this.int16[T+6]=y,this.int16[T+7]=v,e}}Fa.prototype.bytesPerElement=16,Mt(Fa,"StructArrayLayout3i2i2i16");class ec extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,c,h){const p=this.length;return this.resize(p+1),this.emplace(p,e,i,s,c,h)}emplace(e,i,s,c,h,p){const y=4*e,v=8*e;return this.float32[y+0]=i,this.float32[y+1]=s,this.float32[y+2]=c,this.int16[v+6]=h,this.int16[v+7]=p,e}}ec.prototype.bytesPerElement=16,Mt(ec,"StructArrayLayout2f1f2i16");class Ks extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,c){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,c)}emplace(e,i,s,c,h){const p=12*e,y=3*e;return this.uint8[p+0]=i,this.uint8[p+1]=s,this.float32[y+1]=c,this.float32[y+2]=h,e}}Ks.prototype.bytesPerElement=12,Mt(Ks,"StructArrayLayout2ub2f12");class Kn extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s){const c=this.length;return this.resize(c+1),this.emplace(c,e,i,s)}emplace(e,i,s,c){const h=3*e;return this.uint16[h+0]=i,this.uint16[h+1]=s,this.uint16[h+2]=c,e}}Kn.prototype.bytesPerElement=6,Mt(Kn,"StructArrayLayout3ui6");class tc extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,s,c,h,p,y,v,T,E,I,P,R,L,B,j,G,X,ie,J,he){const re=this.length;return this.resize(re+1),this.emplace(re,e,i,s,c,h,p,y,v,T,E,I,P,R,L,B,j,G,X,ie,J,he)}emplace(e,i,s,c,h,p,y,v,T,E,I,P,R,L,B,j,G,X,ie,J,he,re){const pe=30*e,_e=15*e,Se=60*e;return this.int16[pe+0]=i,this.int16[pe+1]=s,this.int16[pe+2]=c,this.float32[_e+2]=h,this.float32[_e+3]=p,this.uint16[pe+8]=y,this.uint16[pe+9]=v,this.uint32[_e+5]=T,this.uint32[_e+6]=E,this.uint32[_e+7]=I,this.uint16[pe+16]=P,this.uint16[pe+17]=R,this.uint16[pe+18]=L,this.float32[_e+10]=B,this.float32[_e+11]=j,this.uint8[Se+48]=G,this.uint8[Se+49]=X,this.uint8[Se+50]=ie,this.uint32[_e+13]=J,this.int16[pe+28]=he,this.uint8[Se+58]=re,e}}tc.prototype.bytesPerElement=60,Mt(tc,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class Ig extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,s,c,h,p,y,v,T,E,I,P,R,L,B,j,G,X,ie,J,he,re,pe,_e,Se,Le,Ce,Be,Fe,Oe,Ze,We){const Je=this.length;return this.resize(Je+1),this.emplace(Je,e,i,s,c,h,p,y,v,T,E,I,P,R,L,B,j,G,X,ie,J,he,re,pe,_e,Se,Le,Ce,Be,Fe,Oe,Ze,We)}emplace(e,i,s,c,h,p,y,v,T,E,I,P,R,L,B,j,G,X,ie,J,he,re,pe,_e,Se,Le,Ce,Be,Fe,Oe,Ze,We,Je){const Qe=20*e,Ne=40*e,At=80*e;return this.float32[Qe+0]=i,this.float32[Qe+1]=s,this.int16[Ne+4]=c,this.int16[Ne+5]=h,this.int16[Ne+6]=p,this.int16[Ne+7]=y,this.int16[Ne+8]=v,this.int16[Ne+9]=T,this.int16[Ne+10]=E,this.int16[Ne+11]=I,this.int16[Ne+12]=P,this.uint16[Ne+13]=R,this.uint16[Ne+14]=L,this.uint16[Ne+15]=B,this.uint16[Ne+16]=j,this.uint16[Ne+17]=G,this.uint16[Ne+18]=X,this.uint16[Ne+19]=ie,this.uint16[Ne+20]=J,this.uint16[Ne+21]=he,this.uint16[Ne+22]=re,this.uint16[Ne+23]=pe,this.uint16[Ne+24]=_e,this.uint16[Ne+25]=Se,this.uint16[Ne+26]=Le,this.uint16[Ne+27]=Ce,this.uint32[Qe+14]=Be,this.float32[Qe+15]=Fe,this.float32[Qe+16]=Oe,this.float32[Qe+17]=Ze,this.float32[Qe+18]=We,this.uint8[At+76]=Je,e}}Ig.prototype.bytesPerElement=80,Mt(Ig,"StructArrayLayout2f9i15ui1ul4f1ub80");class bd extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.float32[1*e+0]=i,e}}bd.prototype.bytesPerElement=4,Mt(bd,"StructArrayLayout1f4");class ic extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,c,h){const p=this.length;return this.resize(p+1),this.emplace(p,e,i,s,c,h)}emplace(e,i,s,c,h,p){const y=5*e;return this.float32[y+0]=i,this.float32[y+1]=s,this.float32[y+2]=c,this.float32[y+3]=h,this.float32[y+4]=p,e}}ic.prototype.bytesPerElement=20,Mt(ic,"StructArrayLayout5f20");class Cg extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,c,h,p,y){const v=this.length;return this.resize(v+1),this.emplace(v,e,i,s,c,h,p,y)}emplace(e,i,s,c,h,p,y,v){const T=7*e;return this.float32[T+0]=i,this.float32[T+1]=s,this.float32[T+2]=c,this.float32[T+3]=h,this.float32[T+4]=p,this.float32[T+5]=y,this.float32[T+6]=v,e}}Cg.prototype.bytesPerElement=28,Mt(Cg,"StructArrayLayout7f28");class Pg extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,c){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,s,c)}emplace(e,i,s,c,h){const p=6*e;return this.uint32[3*e+0]=i,this.uint16[p+2]=s,this.uint16[p+3]=c,this.uint16[p+4]=h,e}}Pg.prototype.bytesPerElement=12,Mt(Pg,"StructArrayLayout1ul3ui12");class Dg extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint16[1*e+0]=i,e}}Dg.prototype.bytesPerElement=2,Mt(Dg,"StructArrayLayout1ui2");class nc extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s){const c=this.length;return this.resize(c+1),this.emplace(c,e,i,s)}emplace(e,i,s,c){const h=3*e;return this.float32[h+0]=i,this.float32[h+1]=s,this.float32[h+2]=c,e}}nc.prototype.bytesPerElement=12,Mt(nc,"StructArrayLayout3f12");class kg extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,c,h,p,y,v,T,E,I,P,R,L,B,j){const G=this.length;return this.resize(G+1),this.emplace(G,e,i,s,c,h,p,y,v,T,E,I,P,R,L,B,j)}emplace(e,i,s,c,h,p,y,v,T,E,I,P,R,L,B,j,G){const X=16*e;return this.float32[X+0]=i,this.float32[X+1]=s,this.float32[X+2]=c,this.float32[X+3]=h,this.float32[X+4]=p,this.float32[X+5]=y,this.float32[X+6]=v,this.float32[X+7]=T,this.float32[X+8]=E,this.float32[X+9]=I,this.float32[X+10]=P,this.float32[X+11]=R,this.float32[X+12]=L,this.float32[X+13]=B,this.float32[X+14]=j,this.float32[X+15]=G,e}}kg.prototype.bytesPerElement=64,Mt(kg,"StructArrayLayout16f64");class em extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,c,h,p,y){const v=this.length;return this.resize(v+1),this.emplace(v,e,i,s,c,h,p,y)}emplace(e,i,s,c,h,p,y,v){const T=10*e,E=5*e;return this.uint16[T+0]=i,this.uint16[T+1]=s,this.uint16[T+2]=c,this.uint16[T+3]=h,this.float32[E+2]=p,this.float32[E+3]=y,this.float32[E+4]=v,e}}em.prototype.bytesPerElement=20,Mt(em,"StructArrayLayout4ui3f20");class Rg extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.int16[1*e+0]=i,e}}Rg.prototype.bytesPerElement=2,Mt(Rg,"StructArrayLayout1i2");class zg extends _i{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint8[1*e+0]=i,e}}zg.prototype.bytesPerElement=1,Mt(zg,"StructArrayLayout1ub1");class bx extends Ki{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}bx.prototype.size=40;class wx extends Jl{get(e){return new bx(this,e)}}Mt(wx,"CollisionBoxArray");class Tx extends Ki{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}Tx.prototype.size=60;class Mx extends tc{get(e){return new Tx(this,e)}}Mt(Mx,"PlacedSymbolArray");class Sx extends Ki{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}}Sx.prototype.size=80;class Ex extends Ig{get(e){return new Sx(this,e)}}Mt(Ex,"SymbolInstanceArray");class Ax extends bd{getoffsetX(e){return this.float32[1*e+0]}}Mt(Ax,"GlyphOffsetArray");class Ix extends gr{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}Mt(Ix,"SymbolLineVertexArray");class Cx extends Ki{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}Cx.prototype.size=12;class Px extends Pg{get(e){return new Cx(this,e)}}Mt(Px,"FeatureIndexArray");class Dx extends ts{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}Mt(Dx,"FillExtrusionCentroidArray");const IS=ni([{name:"a_pos",components:2,type:"Int16"}],4),CS=ni([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class kn{constructor(e=[]){this.segments=e}_prepareSegment(e,i,s,c){let h=this.segments[this.segments.length-1];return e>kn.MAX_VERTEX_ARRAY_LENGTH&&wn(`Max vertices per segment is ${kn.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!h||h.vertexLength+e>kn.MAX_VERTEX_ARRAY_LENGTH||h.sortKey!==c)&&(h={vertexOffset:i,primitiveOffset:s,vertexLength:0,primitiveLength:0},c!==void 0&&(h.sortKey=c),this.segments.push(h)),h}prepareSegment(e,i,s,c){return this._prepareSegment(e,i.length,s.length,c)}get(){return this.segments}destroy(){for(const e of this.segments)for(const i in e.vaos)e.vaos[i].destroy()}static simpleSegment(e,i,s,c){return new kn([{vertexOffset:e,primitiveOffset:i,vertexLength:s,primitiveLength:c,vaos:{},sortKey:0}])}}function kx(t,e){return 256*(t=xi(Math.floor(t),0,255))+xi(Math.floor(e),0,255)}kn.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Mt(kn,"SegmentVector");const PS=ni([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),DS=ni([{name:"a_dash",components:4,type:"Uint16"}]);class wd{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,i,s,c){this.ids.push(Rx(e)),this.positions.push(i,s,c)}eachPosition(e,i){const s=Rx(e);let c=0,h=this.ids.length-1;for(;c<h;){const p=c+h>>1;this.ids[p]>=s?h=p:c=p+1}for(;this.ids[c]===s;)i(this.positions[3*c],this.positions[3*c+1],this.positions[3*c+2]),c++}static serialize(e,i){const s=new Float64Array(e.ids),c=new Uint32Array(e.positions);return Lg(s,c,0,s.length-1),i&&(i.add(s.buffer),i.add(c.buffer)),{ids:s,positions:c}}static deserialize(e){const i=new wd;let s;i.ids=e.ids,i.positions=e.positions;for(const c of i.ids)c!==s&&i.uniqueIds.push(c),s=c;return i.indexed=!0,i}}function Rx(t){const e=+t;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:Sl(String(t))}function Lg(t,e,i,s){for(;i<s;){const c=t[i+s>>1];let h=i-1,p=s+1;for(;;){do h++;while(t[h]<c);do p--;while(t[p]>c);if(h>=p)break;tm(t,h,p),tm(e,3*h,3*p),tm(e,3*h+1,3*p+1),tm(e,3*h+2,3*p+2)}p-i<s-p?(Lg(t,e,i,p),i=p+1):(Lg(t,e,p+1,s),s=p)}}function tm(t,e,i){const s=t[e];t[e]=t[i],t[i]=s}Mt(wd,"FeaturePositionMap");class Qo{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,i){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,i),this.initialized=!0),!!this.location}set(e,i,s){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class im extends Qo{constructor(e){super(e),this.current=0}set(e,i,s){this.fetchUniformLocation(e,i)&&this.current!==s&&(this.current=s,this.gl.uniform1i(this.location,s))}}class Nr extends Qo{constructor(e){super(e),this.current=0}set(e,i,s){this.fetchUniformLocation(e,i)&&this.current!==s&&(this.current=s,this.gl.uniform1f(this.location,s))}}class Ba extends Qo{constructor(e){super(e),this.current=[0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]||(this.current=s,this.gl.uniform2f(this.location,s[0],s[1])))}}class Og extends Qo{constructor(e){super(e),this.current=[0,0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]||(this.current=s,this.gl.uniform3f(this.location,s[0],s[1],s[2])))}}class zx extends Qo{constructor(e){super(e),this.current=[0,0,0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]&&s[3]===this.current[3]||(this.current=s,this.gl.uniform4f(this.location,s[0],s[1],s[2],s[3])))}}class Lx extends Qo{constructor(e){super(e),this.current=Bi.transparent}set(e,i,s){this.fetchUniformLocation(e,i)&&(s.r===this.current.r&&s.g===this.current.g&&s.b===this.current.b&&s.a===this.current.a||(this.current=s,this.gl.uniform4f(this.location,s.r,s.g,s.b,s.a)))}}const kS=new Float32Array(16);class Td extends Qo{constructor(e){super(e),this.current=kS}set(e,i,s){if(this.fetchUniformLocation(e,i)){if(s[12]!==this.current[12]||s[0]!==this.current[0])return this.current=s,void this.gl.uniformMatrix4fv(this.location,!1,s);for(let c=1;c<16;c++)if(s[c]!==this.current[c]){this.current=s,this.gl.uniformMatrix4fv(this.location,!1,s);break}}}}const RS=new Float32Array(9),zS=new Float32Array(4);class Fg extends Qo{constructor(e){super(e),this.current=zS}set(e,i,s){if(this.fetchUniformLocation(e,i)){for(let c=0;c<4;c++)if(s[c]!==this.current[c]){this.current=s,this.gl.uniformMatrix2fv(this.location,!1,s);break}}}}function Bg(t){return[kx(255*t.r,255*t.g),kx(255*t.b,255*t.a)]}class Md{constructor(e,i,s){this.value=e,this.uniformNames=i.map(c=>`u_${c}`),this.type=s}setUniform(e,i,s,c,h){i.set(e,h,c.constantOr(this.value))}getBinding(e,i){return this.type==="color"?new Lx(e):new Nr(e)}}class Pu{constructor(e,i){this.uniformNames=i.map(s=>`u_${s}`),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(e){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br)}setUniform(e,i,s,c,h){const p=h==="u_pattern"||h==="u_dash"?this.pattern:h==="u_pixel_ratio"?this.pixelRatio:null;p&&i.set(e,h,p)}getBinding(e,i){return i==="u_pattern"||i==="u_dash"?new zx(e):new Nr(e)}}class Xo{constructor(e,i,s,c){this.expression=e,this.type=s,this.maxValue=0,this.paintVertexAttributes=i.map(h=>({name:`a_${h}`,type:"Float32",components:s==="color"?2:1,offset:0})),this.paintVertexArray=new c}populatePaintArray(e,i,s,c,h,p,y){const v=this.paintVertexArray.length,T=this.expression.evaluate(new Y(0,{brightness:p}),i,{},h,c,y);this.paintVertexArray.resize(e),this._setPaintValue(v,e,T)}updatePaintArray(e,i,s,c,h,p,y){const v=this.expression.evaluate({zoom:0,brightness:y},s,c,void 0,h);this._setPaintValue(e,i,v)}_setPaintValue(e,i,s){if(this.type==="color"){const c=Bg(s);for(let h=e;h<i;h++)this.paintVertexArray.emplace(h,c[0],c[1])}else{for(let c=e;c<i;c++)this.paintVertexArray.emplace(c,s);this.maxValue=Math.max(this.maxValue,Math.abs(s))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class Js{constructor(e,i,s,c,h,p){this.expression=e,this.uniformNames=i.map(y=>`u_${y}_t`),this.type=s,this.useIntegerZoom=c,this.zoom=h,this.maxValue=0,this.paintVertexAttributes=i.map(y=>({name:`a_${y}`,type:"Float32",components:s==="color"?4:2,offset:0})),this.paintVertexArray=new p}populatePaintArray(e,i,s,c,h,p,y){const v=this.expression.evaluate(new Y(this.zoom,{brightness:p}),i,{},h,c,y),T=this.expression.evaluate(new Y(this.zoom+1,{brightness:p}),i,{},h,c,y),E=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(E,e,v,T)}updatePaintArray(e,i,s,c,h,p,y){const v=this.expression.evaluate({zoom:this.zoom,brightness:y},s,c,void 0,h),T=this.expression.evaluate({zoom:this.zoom+1,brightness:y},s,c,void 0,h);this._setPaintValue(e,i,v,T)}_setPaintValue(e,i,s,c){if(this.type==="color"){const h=Bg(s),p=Bg(c);for(let y=e;y<i;y++)this.paintVertexArray.emplace(y,h[0],h[1],p[0],p[1])}else{for(let h=e;h<i;h++)this.paintVertexArray.emplace(h,s,c);this.maxValue=Math.max(this.maxValue,Math.abs(s),Math.abs(c))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,i,s,c,h){const p=this.useIntegerZoom?Math.floor(s.zoom):s.zoom,y=xi(this.expression.interpolationFactor(p,this.zoom,this.zoom+1),0,1);i.set(e,h,y)}getBinding(e,i){return new Nr(e)}}class Na{constructor(e,i,s,c,h){this.expression=e,this.layerId=h,this.paintVertexAttributes=(s==="array"?DS:PS).members;for(let p=0;p<i.length;++p);this.paintVertexArray=new c}populatePaintArray(e,i,s){const c=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(c,e,i.patterns&&i.patterns[this.layerId],s)}updatePaintArray(e,i,s,c,h,p,y){this._setPaintValues(e,i,s.patterns&&s.patterns[this.layerId],p)}_setPaintValues(e,i,s,c){if(!c||!s)return;const h=c[s];if(!h)return;const{tl:p,br:y,pixelRatio:v}=h;for(let T=e;T<i;T++)this.paintVertexArray.emplace(T,p[0],p[1],y[0],y[1],v)}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class rc{constructor(e,i,s=()=>!0){this.binders={},this._buffers=[];const c=[];for(const h in e.paint._values){const p=e.paint.get(h);if(!s(h)||!(p instanceof Pe&&Su(p.property.specification)))continue;const y=OS(h,e.type),v=p.value,T=p.property.specification.type,E=!!p.property.useIntegerZoom,I=h==="line-dasharray"||h.endsWith("pattern"),P=h==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant";if(v.kind!=="constant"||P)if(v.kind==="source"||P||I){const R=Ox(h,T,"source");this.binders[h]=I?new Na(v,y,T,R,e.id):new Xo(v,y,T,R),c.push(`/a_${h}`)}else{const R=Ox(h,T,"composite");this.binders[h]=new Js(v,y,T,E,i,R),c.push(`/z_${h}`)}else this.binders[h]=I?new Pu(v.value,y):new Md(v.value,y,T),c.push(`/u_${h}`)}this.cacheKey=c.sort().join("")}getMaxValue(e){const i=this.binders[e];return i instanceof Xo||i instanceof Js?i.maxValue:0}populatePaintArrays(e,i,s,c,h,p,y){for(const v in this.binders){const T=this.binders[v];(T instanceof Xo||T instanceof Js||T instanceof Na)&&T.populatePaintArray(e,i,s,c,h,p,y)}}setConstantPatternPositions(e){for(const i in this.binders){const s=this.binders[i];s instanceof Pu&&s.setConstantPatternPositions(e)}}updatePaintArrays(e,i,s,c,h,p,y,v){let T=!1;const E=Object.keys(e),I=E.length!==0,P=I?E:i.uniqueIds;for(const R in this.binders){const L=this.binders[R];if((L instanceof Xo||L instanceof Js||L instanceof Na)&&(L.expression.isStateDependent===!0||L.expression.isLightConstant===!1)){const B=h.paint.get(R);L.expression=B.value;for(const j of P){const G=e[j.toString()];i.eachPosition(j,(X,ie,J)=>{const he=c.feature(X);L.updatePaintArray(ie,J,he,G,p,y,v)})}if(!I)for(const j of s.uniqueIds){const G=e[j.toString()];s.eachPosition(j,(X,ie,J)=>{const he=c.feature(X);L.updatePaintArray(ie,J,he,G,p,y,v)})}T=!0}}return T}defines(){const e=[];for(const i in this.binders){const s=this.binders[i];(s instanceof Md||s instanceof Pu)&&e.push(...s.uniformNames.map(c=>`#define HAS_UNIFORM_${c}`))}return e}getBinderAttributes(){const e=[];for(const i in this.binders){const s=this.binders[i];if(s instanceof Xo||s instanceof Js||s instanceof Na)for(let c=0;c<s.paintVertexAttributes.length;c++)e.push(s.paintVertexAttributes[c].name)}return e}getBinderUniforms(){const e=[];for(const i in this.binders){const s=this.binders[i];if(s instanceof Md||s instanceof Pu||s instanceof Js)for(const c of s.uniformNames)e.push(c)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){const i=[];for(const s in this.binders){const c=this.binders[s];if(c instanceof Md||c instanceof Pu||c instanceof Js)for(const h of c.uniformNames)i.push({name:h,property:s,binding:c.getBinding(e,h)})}return i}setUniforms(e,i,s,c,h){for(const{name:p,property:y,binding:v}of s)this.binders[y].setUniform(e,v,h,c.get(y),p)}updatePaintBuffers(){this._buffers=[];for(const e in this.binders){const i=this.binders[e];(i instanceof Xo||i instanceof Js||i instanceof Na)&&i.paintVertexBuffer&&this._buffers.push(i.paintVertexBuffer)}}upload(e){for(const i in this.binders){const s=this.binders[i];(s instanceof Xo||s instanceof Js||s instanceof Na)&&s.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const i=this.binders[e];(i instanceof Xo||i instanceof Js||i instanceof Na)&&i.destroy()}}}class Va{constructor(e,i,s=()=>!0){this.programConfigurations={};for(const c of e)this.programConfigurations[c.id]=new rc(c,i,s);this.needsUpload=!1,this._featureMap=new wd,this._featureMapWithoutIds=new wd,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,i,s,c,h,p,y,v){for(const T in this.programConfigurations)this.programConfigurations[T].populatePaintArrays(e,i,c,h,p,y,v);i.id!==void 0?this._featureMap.add(i.id,s,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,s,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,i,s,c,h,p){for(const y of s)this.needsUpload=this.programConfigurations[y.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,i,y,c,h,p||0)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const i in this.programConfigurations)this.programConfigurations[i].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}const LS={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function OS(t,e){return LS[t]||[t.replace(`${e}-`,"").replace(/-/g,"_")]}const FS={"line-pattern":{source:ur,composite:ur},"fill-pattern":{source:ur,composite:ur},"fill-extrusion-pattern":{source:ur,composite:ur},"line-dasharray":{source:Os,composite:Os}},BS={color:{source:cr,composite:Xn},number:{source:bd,composite:cr}};function Ox(t,e,i){const s=FS[t];return s&&s[i]||BS[e][i]}Mt(Md,"ConstantBinder"),Mt(Pu,"PatternConstantBinder"),Mt(Xo,"SourceExpressionBinder"),Mt(Na,"PatternCompositeBinder"),Mt(Js,"CompositeExpressionBinder"),Mt(rc,"ProgramConfiguration",{omit:["_buffers"]}),Mt(Va,"ProgramConfigurationSet");const Vr=pt/Math.PI/2,Ng=5,Fx=6,NS=16383,Du=64,Vg=[Du,32,16],Ns=-Vr,Vs=Vr;function ku(t,e,i,s=Vr){return i=Si(i),[t*Math.sin(i)*s,-e*s,t*Math.cos(i)*s]}function sc(t,e,i){return ku(Math.cos(Si(t)),Math.sin(Si(t)),e,i)}const Ru=63710088e-1,Ug=2*Math.PI*Ru;class Ii{constructor(e,i){if(isNaN(e)||isNaN(i))throw new Error(`Invalid LngLat object: (${e}, ${i})`);if(this.lng=+e,this.lat=+i,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Ii(qs(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const i=Math.PI/180,s=this.lat*i,c=e.lat*i,h=Math.sin(s)*Math.sin(c)+Math.cos(s)*Math.cos(c)*Math.cos((e.lng-this.lng)*i);return Ru*Math.acos(Math.min(h,1))}toBounds(e=0){const i=360*e/40075017,s=i/Math.cos(Math.PI/180*this.lat);return new Ua({lng:this.lng-s,lat:this.lat-i},{lng:this.lng+s,lat:this.lat+i})}toEcef(e){return sc(this.lat,this.lng,Vr+e*Vr/Ru)}static convert(e){if(e instanceof Ii)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new Ii(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new Ii(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class Ua{constructor(e,i){if(e)if(i)this.setSouthWest(e).setNorthEast(i);else if(e.length===4){const s=e;this.setSouthWest([s[0],s[1]]).setNorthEast([s[2],s[3]])}else{const s=e;this.setSouthWest(s[0]).setNorthEast(s[1])}}setNorthEast(e){return this._ne=e instanceof Ii?new Ii(e.lng,e.lat):Ii.convert(e),this}setSouthWest(e){return this._sw=e instanceof Ii?new Ii(e.lng,e.lat):Ii.convert(e),this}extend(e){const i=this._sw,s=this._ne;let c,h;if(e instanceof Ii)c=e,h=e;else{if(!(e instanceof Ua))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(Ua.convert(e)):this.extend(Ii.convert(e)):typeof e=="object"&&e!==null&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(Ii.convert(e)):this;if(c=e._sw,h=e._ne,!c||!h)return this}return i||s?(i.lng=Math.min(c.lng,i.lng),i.lat=Math.min(c.lat,i.lat),s.lng=Math.max(h.lng,s.lng),s.lat=Math.max(h.lat,s.lat)):(this._sw=new Ii(c.lng,c.lat),this._ne=new Ii(h.lng,h.lat)),this}getCenter(){return new Ii((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Ii(this.getWest(),this.getNorth())}getSouthEast(){return new Ii(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:i,lat:s}=Ii.convert(e);let c=this._sw.lng<=i&&i<=this._ne.lng;return this._sw.lng>this._ne.lng&&(c=this._sw.lng>=i&&i>=this._ne.lng),this._sw.lat<=s&&s<=this._ne.lat&&c}static convert(e){return!e||e instanceof Ua?e:new Ua(e)}}var Bx={};(function(t,e){(function(i){function s(h,p,y){var v=c(256*h,256*(p=Math.pow(2,y)-p-1),y),T=c(256*(h+1),256*(p+1),y);return v[0]+","+v[1]+","+T[0]+","+T[1]}function c(h,p,y){var v=2*Math.PI*6378137/256/Math.pow(2,y);return[h*v-2*Math.PI*6378137/2,p*v-2*Math.PI*6378137/2]}i.getURL=function(h,p,y,v,T,E){return E=E||{},h+"?"+["bbox="+s(y,v,T),"format="+(E.format||"image/png"),"service="+(E.service||"WMS"),"version="+(E.version||"1.1.1"),"request="+(E.request||"GetMap"),"srs="+(E.srs||"EPSG:3857"),"width="+(E.width||256),"height="+(E.height||256),"layers="+p].join("&")},i.getTileBBox=s,i.getMercCoords=c,Object.defineProperty(i,"__esModule",{value:!0})})(e)})(0,Bx);var VS=Bx;class oc{constructor(e,i,s){this.z=e,this.x=i,this.y=s,this.key=Sd(0,e,e,i,s)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}url(e,i){const s=VS.getTileBBox(this.x,this.y,this.z),c=function(h,p,y){let v,T="";for(let E=h;E>0;E--)v=1<<E-1,T+=(p&v?1:0)+(y&v?2:0);return T}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(i==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",c).replace("{bbox-epsg-3857}",s)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Nx{constructor(e,i){this.wrap=e,this.canonical=i,this.key=Sd(e,i.z,i.z,i.x,i.y)}}class Mr{constructor(e,i,s,c,h){this.overscaledZ=e,this.wrap=i,this.canonical=new oc(s,+c,+h),this.key=i===0&&e===s?this.canonical.key:Sd(i,e,s,c,h)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){const i=this.canonical.z-e;return e>this.canonical.z?new Mr(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new Mr(e,this.wrap,e,this.canonical.x>>i,this.canonical.y>>i)}calculateScaledKey(e,i=!0){if(this.overscaledZ===e&&i)return this.key;if(e>this.canonical.z)return Sd(this.wrap*+i,e,this.canonical.z,this.canonical.x,this.canonical.y);{const s=this.canonical.z-e;return Sd(this.wrap*+i,e,e,this.canonical.x>>s,this.canonical.y>>s)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;const i=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>i&&e.canonical.y===this.canonical.y>>i}children(e){if(this.overscaledZ>=e)return[new Mr(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const i=this.canonical.z+1,s=2*this.canonical.x,c=2*this.canonical.y;return[new Mr(i,this.wrap,i,s,c),new Mr(i,this.wrap,i,s+1,c),new Mr(i,this.wrap,i,s,c+1),new Mr(i,this.wrap,i,s+1,c+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new Mr(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new Mr(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Nx(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function Sd(t,e,i,s,c){const h=1<<Math.min(i,22);let p=h*(c%h)+s%h;return t&&i<22&&(p+=h*h*((t<0?-2*t-1:2*t)%(1<<2*(22-i)))),16*(32*p+i)+(e-i)}const US=[t=>{let e=t.canonical.x-1,i=t.wrap;return e<0&&(e=(1<<t.canonical.z)-1,i--),new Mr(t.overscaledZ,i,t.canonical.z,e,t.canonical.y)},t=>{let e=t.canonical.x+1,i=t.wrap;return e===1<<t.canonical.z&&(e=0,i++),new Mr(t.overscaledZ,i,t.canonical.z,e,t.canonical.y)},t=>new Mr(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,(t.canonical.y===0?1<<t.canonical.z:t.canonical.y)-1),t=>new Mr(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y===(1<<t.canonical.z)-1?0:t.canonical.y+1)];Mt(oc,"CanonicalTileID"),Mt(Mr,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const jS=0,GS=25.5;function jg(t){return Ug*Math.cos(t*Math.PI/180)}function ja(t){return(180+t)/360}function Ko(t){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t*Math.PI/360)))/360}function Ur(t,e){return t/jg(e)}function is(t){return 360*t-180}function xr(t){return 360/Math.PI*Math.atan(Math.exp((180-360*t)*Math.PI/180))-90}function Vx(t,e){return t*jg(xr(e))}const Rn=85.051129;function Ux(t){return Math.cos(Si(xi(t,-Rn,Rn)))}function ac(t,e){const i=xi(e,jS,GS),s=Math.pow(2,i);return Ux(t)*Ug/(512*s)}function jx(t){return 1/Math.cos(t*Math.PI/180)}function nm(t,e=0){const i=Math.exp(Math.PI*(1-(t.y+e/pt)/(1<<t.z)*2));return 80150034*i/(i*i+1)/pt/(1<<t.z)}class Sr{constructor(e,i,s=0){this.x=+e,this.y=+i,this.z=+s}static fromLngLat(e,i=0){const s=Ii.convert(e);return new Sr(ja(s.lng),Ko(s.lat),Ur(i,s.lat))}toLngLat(){return new Ii(is(this.x),xr(this.y))}toAltitude(){return Vx(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/Ug*jx(xr(this.y))}}function Gg(t,e,i,s,c,h,p,y,v){const T=(e+s)/2,E=(i+c)/2,I=new ft(T,E);y(I),function(P,R,L,B,j,G){const X=L-j,ie=B-G;return Math.abs((B-R)*X-(L-P)*ie)/Math.hypot(X,ie)}(I.x,I.y,h.x,h.y,p.x,p.y)>=v?(Gg(t,e,i,T,E,h,I,y,v),Gg(t,T,E,s,c,I,p,y,v)):t.push(p)}function Gx(t,e,i){let s=t[0],c=s.x,h=s.y;e(s);const p=[s];for(let y=1;y<t.length;y++){const v=t[y],{x:T,y:E}=v;e(v),Gg(p,c,h,T,E,s,v,e,i),c=T,h=E,s=v}return p}function Wg(t,e,i,s){if(s(e,i)){const c=e.add(i)._mult(.5);Wg(t,e,c,s),Wg(t,c,i,s)}else t.push(i)}function WS(t,e){let i=t[0];const s=[i];for(let c=1;c<t.length;c++){const h=t[c];Wg(s,i,h,e),i=h}return s}const qg=Math.pow(2,14)-1,Wx=-qg-1;function qS(t,e){const i=Math.round(t.x*e),s=Math.round(t.y*e);return t.x=xi(i,Wx,qg),t.y=xi(s,Wx,qg),(i<t.x||i>t.x+1||s<t.y||s>t.y+1)&&wn("Geometry exceeds allowed extent, reduce your vector tile buffer size"),t}function Jo(t,e,i){const s=t.loadGeometry(),c=t.extent,h=pt/c;if(e&&i&&i.projection.isReprojectedInTileSpace){const p=1<<e.z,{scale:y,x:v,y:T,projection:E}=i,I=P=>{const R=is((e.x+P.x/c)/p),L=xr((e.y+P.y/c)/p),B=E.project(R,L);P.x=(B.x*y-v)*c,P.y=(B.y*y-T)*c};for(let P=0;P<s.length;P++)if(t.type!==1)s[P]=Gx(s[P],I,1);else{const R=[];for(const L of s[P])L.x<0||L.x>=c||L.y<0||L.y>=c||(I(L),R.push(L));s[P]=R}}for(const p of s)for(const y of p)qS(y,h);return s}function Ga(t,e){return{type:t.type,id:t.id,properties:t.properties,geometry:e?Jo(t):[]}}function rm(t,e,i,s,c){t.emplaceBack(2*e+(s+1)/2,2*i+(c+1)/2)}function sm(t,e,i){t.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}class Hg{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new gr,this.indexArray=new Kn,this.segments=new kn,this.programConfigurations=new Va(e.layers,e.zoom),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id)}populate(e,i,s,c){const h=this.layers[0],p=[];let y=null;h.type==="circle"&&(y=h.layout.get("circle-sort-key"));for(const{feature:T,id:E,index:I,sourceLayerIndex:P}of e){const R=this.layers[0]._featureFilter.needGeometry,L=Ga(T,R);if(!this.layers[0]._featureFilter.filter(new Y(this.zoom),L,s))continue;const B=y?y.evaluate(L,{},s):void 0,j={id:E,properties:T.properties,type:T.type,sourceLayerIndex:P,index:I,geometry:R?L.geometry:Jo(T,s,c),patterns:{},sortKey:B};p.push(j)}y&&p.sort((T,E)=>T.sortKey-E.sortKey);let v=null;c.projection.name==="globe"&&(this.globeExtVertexArray=new ws,v=c.projection);for(const T of p){const{geometry:E,index:I,sourceLayerIndex:P}=T,R=e[I].feature;this.addFeature(T,E,I,i.availableImages,s,v,i.brightness),i.featureIndex.insert(R,E,I,P,this.index)}}update(e,i,s,c,h){const p=Object.keys(e).length!==0;p&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(e,i,p?this.stateDependentLayers:this.layers,s,c,h)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,IS.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,CS.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(e,i,s,c,h,p,y){for(const v of i)for(const T of v){const E=T.x,I=T.y;if(E<0||E>=pt||I<0||I>=pt)continue;if(p){const L=p.projectTilePoint(E,I,h),B=p.upVector(h,E,I),j=this.globeExtVertexArray;sm(j,L,B),sm(j,L,B),sm(j,L,B),sm(j,L,B)}const P=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),R=P.vertexLength;rm(this.layoutVertexArray,E,I,-1,-1),rm(this.layoutVertexArray,E,I,1,-1),rm(this.layoutVertexArray,E,I,1,1),rm(this.layoutVertexArray,E,I,-1,1),this.indexArray.emplaceBack(R,R+1,R+2),this.indexArray.emplaceBack(R,R+2,R+3),P.vertexLength+=4,P.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,{},c,h,y)}}function Zg(t,e){for(let i=0;i<t.length;i++)if(lc(e,t[i]))return!0;for(let i=0;i<e.length;i++)if(lc(t,e[i]))return!0;return!!$g(t,e)}function HS(t,e,i){return!!lc(t,e)||!!Yg(e,t,i)}function qx(t,e){if(t.length===1)return Zx(e,t[0]);for(let i=0;i<e.length;i++){const s=e[i];for(let c=0;c<s.length;c++)if(lc(t,s[c]))return!0}for(let i=0;i<t.length;i++)if(Zx(e,t[i]))return!0;for(let i=0;i<e.length;i++)if($g(t,e[i]))return!0;return!1}function ZS(t,e,i){if(t.length>1){if($g(t,e))return!0;for(let s=0;s<e.length;s++)if(Yg(e[s],t,i))return!0}for(let s=0;s<t.length;s++)if(Yg(t[s],e,i))return!0;return!1}function $g(t,e){if(t.length===0||e.length===0)return!1;for(let i=0;i<t.length-1;i++){const s=t[i],c=t[i+1];for(let h=0;h<e.length-1;h++)if($S(s,c,e[h],e[h+1]))return!0}return!1}function $S(t,e,i,s){return ho(t,i,s)!==ho(e,i,s)&&ho(t,e,i)!==ho(t,e,s)}function Yg(t,e,i){const s=i*i;if(e.length===1)return t.distSqr(e[0])<s;for(let c=1;c<e.length;c++)if(Hx(t,e[c-1],e[c])<s)return!0;return!1}function Hx(t,e,i){const s=e.distSqr(i);if(s===0)return t.distSqr(e);const c=((t.x-e.x)*(i.x-e.x)+(t.y-e.y)*(i.y-e.y))/s;return t.distSqr(c<0?e:c>1?i:i.sub(e)._mult(c)._add(e))}function Zx(t,e){let i,s,c,h=!1;for(let p=0;p<t.length;p++){i=t[p];for(let y=0,v=i.length-1;y<i.length;v=y++)s=i[y],c=i[v],s.y>e.y!=c.y>e.y&&e.x<(c.x-s.x)*(e.y-s.y)/(c.y-s.y)+s.x&&(h=!h)}return h}function lc(t,e){let i=!1;for(let s=0,c=t.length-1;s<t.length;c=s++){const h=t[s],p=t[c];h.y>e.y!=p.y>e.y&&e.x<(p.x-h.x)*(e.y-h.y)/(p.y-h.y)+h.x&&(i=!i)}return i}function $x(t,e,i,s,c){for(const p of t)if(e<=p.x&&i<=p.y&&s>=p.x&&c>=p.y)return!0;const h=[new ft(e,i),new ft(e,c),new ft(s,c),new ft(s,i)];if(t.length>2){for(const p of h)if(lc(t,p))return!0}for(let p=0;p<t.length-1;p++)if(YS(t[p],t[p+1],h))return!0;return!1}function YS(t,e,i){const s=i[0],c=i[2];if(t.x<s.x&&e.x<s.x||t.x>c.x&&e.x>c.x||t.y<s.y&&e.y<s.y||t.y>c.y&&e.y>c.y)return!1;const h=ho(t,e,i[0]);return h!==ho(t,e,i[1])||h!==ho(t,e,i[2])||h!==ho(t,e,i[3])}function zu(t,e,i,s,c,h){let p=e.y-t.y,y=t.x-e.x;if(h=h||0){const v=p*p+y*y;if(v===0)return!0;const T=Math.sqrt(v);p/=T,y/=T}return!((i.x-t.x)*p+(i.y-t.y)*y-h<0||(s.x-t.x)*p+(s.y-t.y)*y-h<0||(c.x-t.x)*p+(c.y-t.y)*y-h<0)}function Qg(t,e,i,s,c,h,p){return!(zu(t,e,s,c,h,p)||zu(e,i,s,c,h,p)||zu(i,t,s,c,h,p)||zu(s,c,t,e,i,p)||zu(c,h,t,e,i,p)||zu(h,s,t,e,i,p))}function Lu(t,e,i){const s=e.paint.get(t).value;return s.kind==="constant"?s.value:i.programConfigurations.get(e.id).getMaxValue(t)}function om(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function Yx(t,e,i,s,c){if(!e[0]&&!e[1])return t;const h=ft.convert(e)._mult(c);i==="viewport"&&h._rotate(-s);const p=[];for(let y=0;y<t.length;y++)p.push(t[y].sub(h));return p}function Qx(t,e,i,s){const c=ft.convert(t)._mult(s);return e==="viewport"&&c._rotate(-i),c}Mt(Hg,"CircleBucket",{omit:["layers"]});const QS=new we({"circle-sort-key":new Ae(ae.layout_circle["circle-sort-key"]),visibility:new ge(ae.layout_circle.visibility)});var XS={paint:new we({"circle-radius":new Ae(ae.paint_circle["circle-radius"]),"circle-color":new Ae(ae.paint_circle["circle-color"]),"circle-blur":new Ae(ae.paint_circle["circle-blur"]),"circle-opacity":new Ae(ae.paint_circle["circle-opacity"]),"circle-translate":new ge(ae.paint_circle["circle-translate"]),"circle-translate-anchor":new ge(ae.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new ge(ae.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new ge(ae.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Ae(ae.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Ae(ae.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Ae(ae.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new ge(ae.paint_circle["circle-emissive-strength"])}),layout:QS};class Xg{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,s){const c=r.Q.dot(i,this.dir);if(Math.abs(c)<1e-6)return!1;const h=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1]+(e[2]-this.pos[2])*i[2])/c;return s[0]=this.pos[0]+this.dir[0]*h,s[1]=this.pos[1]+this.dir[1]*h,s[2]=this.pos[2]+this.dir[2]*h,!0}closestPointOnSphere(e,i,s){if(r.Q.equals(this.pos,e)||i===0)return s[0]=s[1]=s[2]=0,!1;const[c,h,p]=this.dir,y=this.pos[0]-e[0],v=this.pos[1]-e[1],T=this.pos[2]-e[2],E=c*c+h*h+p*p,I=2*(y*c+v*h+T*p),P=I*I-4*E*(y*y+v*v+T*T-i*i);if(P<0){const R=Math.max(-I/2,0),L=y+c*R,B=v+h*R,j=T+p*R,G=Math.hypot(L,B,j);return s[0]=L*i/G,s[1]=B*i/G,s[2]=j*i/G,!1}{const R=(-I-Math.sqrt(P))/(2*E);if(R<0){const L=Math.hypot(y,v,T);return s[0]=y*i/L,s[1]=v*i/L,s[2]=T*i/L,!1}return s[0]=y+c*R,s[1]=v+h*R,s[2]=T+p*R,!0}}}class Kg{constructor(e,i,s,c,h){this.TL=e,this.TR=i,this.BR=s,this.BL=c,this.horizon=h}static fromInvProjectionMatrix(e,i,s){const c=[-1,1,1],h=[1,1,1],p=[1,-1,1],y=[-1,-1,1],v=r.Q.transformMat4(c,c,e),T=r.Q.transformMat4(h,h,e),E=r.Q.transformMat4(p,p,e),I=r.Q.transformMat4(y,y,e);return new Kg(v,T,E,I,i/s)}}function Ed(t,e,i){let s=1/0,c=-1/0;const h=[];for(const p of t){r.Q.sub(h,p,e);const y=r.Q.dot(h,i);s=Math.min(s,y),c=Math.max(c,y)}return[s,c]}function Xx(t,e){let i=!0;for(let s=0;s<t.planes.length;s++){const c=t.planes[s];let h=0;for(let p=0;p<e.length;p++)h+=r.Q.dot(c,e[p])+c[3]>=0;if(h===0)return 0;h!==e.length&&(i=!1)}return i?2:1}function Kx(t,e){for(const i of t.projections){const s=Ed(e,t.points[0],i.axis);if(i.projection[1]<s[0]||i.projection[0]>s[1])return 0}return 1}function Jx(t,e){let i=0;const s=[0,0,0,0];for(let c=0;c<t.length;c++)s[0]=t[c][0],s[1]=t[c][1],s[2]=t[c][2],s[3]=1,r.aa.dot(s,e)>=0&&i++;return i}class Jg{constructor(e,i){this.points=e||new Array(8).fill([0,0,0]),this.planes=i||new Array(6).fill([0,0,0,0]),this.bounds=fn.fromPoints(this.points),this.projections=[],this.frustumEdges=[r.Q.sub([],this.points[2],this.points[3]),r.Q.sub([],this.points[0],this.points[3]),r.Q.sub([],this.points[4],this.points[0]),r.Q.sub([],this.points[5],this.points[1]),r.Q.sub([],this.points[6],this.points[2]),r.Q.sub([],this.points[7],this.points[3])];for(const s of this.frustumEdges){const c=[0,-s[2],s[1]],h=[s[2],0,-s[0]];this.projections.push({axis:c,projection:Ed(this.points,this.points[0],c)}),this.projections.push({axis:h,projection:Ed(this.points,this.points[0],h)})}}static fromInvProjectionMatrix(e,i,s,c){const h=Math.pow(2,s),p=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(T=>{const E=r.aa.transformMat4([],T,e),I=1/E[3]/i*h;return r.aa.mul(E,E,[I,I,c?1/E[3]:I,I])}),y=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(T=>{const E=r.Q.sub([],p[T[0]],p[T[1]]),I=r.Q.sub([],p[T[2]],p[T[1]]),P=r.Q.normalize([],r.Q.cross([],E,I)),R=-r.Q.dot(P,p[T[1]]);return P.concat(R)}),v=[];for(let T=0;T<p.length;T++)v.push([p[T][0],p[T][1],p[T][2]]);return new Jg(v,y)}intersectsPrecise(e,i,s){for(let c=0;c<i.length;c++)if(!Jx(e,i[c]))return 0;for(let c=0;c<this.planes.length;c++)if(!Jx(e,this.planes[c]))return 0;for(const c of s)for(const h of this.frustumEdges){const p=r.Q.cross([],c,h),y=r.Q.length(p);if(y===0)continue;r.Q.scale(p,p,1/y);const v=Ed(this.points,this.points[0],p),T=Ed(e,this.points[0],p);if(v[0]>T[1]||T[0]>v[1])return 0}return 1}}class fn{static fromPoints(e){const i=[1/0,1/0,1/0],s=[-1/0,-1/0,-1/0];for(const c of e)r.Q.min(i,i,c),r.Q.max(s,s,c);return new fn(i,s)}static fromTileIdAndHeight(e,i,s){const c=1<<e.canonical.z,h=e.canonical.x,p=e.canonical.y;return new fn([h/c,p/c,i],[(h+1)/c,(p+1)/c,s])}static applyTransform(e,i){const s=e.getCorners();for(let c=0;c<s.length;++c)r.Q.transformMat4(s[c],s[c],i);return fn.fromPoints(s)}static projectAabbCorners(e,i){const s=e.getCorners();for(let c=0;c<s.length;++c)r.Q.transformMat4(s[c],s[c],i);return s}constructor(e,i){this.min=e,this.max=i,this.center=r.Q.scale([],r.Q.add([],this.min,this.max),.5)}quadrant(e){const i=[e%2==0,e<2],s=r.Q.clone(this.min),c=r.Q.clone(this.max);for(let h=0;h<i.length;h++)s[h]=i[h]?this.min[h]:this.center[h],c[h]=i[h]?this.center[h]:this.max[h];return c[2]=this.max[2],new fn(s,c)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){const e=this.min,i=this.max;return[[e[0],e[1],e[2]],[i[0],e[1],e[2]],[i[0],i[1],e[2]],[e[0],i[1],e[2]],[e[0],e[1],i[2]],[i[0],e[1],i[2]],[i[0],i[1],i[2]],[e[0],i[1],i[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?Xx(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?Xx(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,i){return i||this.intersects(e)?Kx(e,this.getCorners()):0}intersectsPreciseFlat(e,i){return i||this.intersectsFlat(e)?Kx(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let i=0;i<3;++i)if(this.min[i]>e.max[i]||e.min[i]>this.max[i])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e.min[i]),this.max[i]=Math.max(this.max[i],e.max[i])}encapsulatePoint(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e[i]),this.max[i]=Math.max(this.max[i],e[i])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}Mt(fn,"Aabb");const KS=ni([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:am}=KS,JS=ni([{name:"a_pos_3",components:3,type:"Int16"}]);var ev=ni([{name:"a_pos",type:"Int16",components:2}]);function lm(t){return t*Vr/Ru}const eE=[new fn([Ns,Ns,Ns],[Vs,Vs,Vs]),new fn([Ns,Ns,Ns],[0,0,Vs]),new fn([0,Ns,Ns],[Vs,0,Vs]),new fn([Ns,0,Ns],[0,Vs,Vs]),new fn([0,0,Ns],[Vs,Vs,Vs])];function tv(t,e,i,s=!0){const c=r.Q.scale([],t._camera.position,t.worldSize),h=[e,i,1,1];r.aa.transformMat4(h,h,t.pixelMatrixInverse),r.aa.scale(h,h,1/h[3]);const p=r.Q.sub([],h,c),y=r.Q.normalize([],p),v=t.globeMatrix,T=[v[12],v[13],v[14]],E=r.Q.sub([],T,c),I=r.Q.length(E),P=r.Q.normalize([],E),R=t.worldSize/(2*Math.PI),L=r.Q.dot(P,y),B=Math.asin(R/I);if(B<Math.acos(L)){if(!s)return null;const Ce=[],Be=[];r.Q.scale(Ce,y,I/L),r.Q.normalize(Be,r.Q.sub(Be,Ce,E)),r.Q.normalize(y,r.Q.add(y,E,r.Q.scale(y,Be,Math.tan(B)*I)))}const j=[];new Xg(c,y).closestPointOnSphere(T,R,j);const G=r.Q.normalize([],Oo(v,0)),X=r.Q.normalize([],Oo(v,1)),ie=r.Q.normalize([],Oo(v,2)),J=r.Q.dot(G,j),he=r.Q.dot(X,j),re=r.Q.dot(ie,j),pe=kr(Math.asin(-he/R));let _e=kr(Math.atan2(J,re));_e=t.center.lng+function(Ce,Be){const Fe=(Be-Ce+180)%360-180;return Fe<-180?Fe+360:Fe}(t.center.lng,_e);const Se=ja(_e),Le=xi(Ko(pe),0,1);return new Sr(Se,Le)}class tE{constructor(e,i,s){this.a=r.Q.sub([],e,s),this.b=r.Q.sub([],i,s),this.center=s;const c=r.Q.normalize([],this.a),h=r.Q.normalize([],this.b);this.angle=Math.acos(r.Q.dot(c,h))}}function ey(t,e){if(t.angle===0)return null;let i;return i=t.a[e]===0?1/t.angle*.5*Math.PI:1/t.angle*Math.atan(t.b[e]/t.a[e]/Math.sin(t.angle)-1/Math.tan(t.angle)),i<0||i>1?null:function(s,c,h,p){const y=Math.sin(h);return s*(Math.sin((1-p)*h)/y)+c*(Math.sin(p*h)/y)}(t.a[e],t.b[e],t.angle,xi(i,0,1))+t.center[e]}function Mo(t){if(t.z<=1)return eE[t.z+2*t.y+t.x];const e=ty(cm(t));return fn.fromPoints(e)}function ea(t,e,i){return r.Q.scale(t,t,1-i),r.Q.scaleAndAdd(t,t,e,i)}function iv(t,e,i){for(const s of t)r.Q.transformMat4(s,s,e),r.Q.scale(s,s,i)}function nv(t,e,i,s){const c=e/t.worldSize,h=t.globeMatrix;if(i.z<=1){const Se=Mo(i).getCorners();return iv(Se,h,c),fn.fromPoints(Se)}const p=cm(i,s),y=ty(p,Vr+lm(t._tileCoverLift));iv(y,h,c);const v=Number.MAX_VALUE,T=[-v,-v,-v],E=[v,v,v];if(p.contains(t.center)){for(const Ce of y)r.Q.min(E,E,Ce),r.Q.max(T,T,Ce);T[2]=0;const Se=t.point,Le=[Se.x*c,Se.y*c,0];return r.Q.min(E,E,Le),r.Q.max(T,T,Le),new fn(E,T)}if(t._tileCoverLift>0){for(const Se of y)r.Q.min(E,E,Se),r.Q.max(T,T,Se);return new fn(E,T)}const I=[h[12]*c,h[13]*c,h[14]*c],P=p.getCenter(),R=xi(t.center.lat,-Rn,Rn),L=xi(P.lat,-Rn,Rn),B=ja(t.center.lng),j=Ko(R);let G=B-ja(P.lng);const X=j-Ko(L);G>.5?G-=1:G<-.5&&(G+=1);let ie=0;if(Math.abs(G)>Math.abs(X))ie=G>=0?1:3;else{ie=X>=0?0:2;const Se=[h[4]*c,h[5]*c,h[6]*c],Le=-Math.sin(Si(X>=0?p.getSouth():p.getNorth()))*Vr;r.Q.scaleAndAdd(I,I,Se,Le)}const J=y[ie],he=y[(ie+1)%4],re=new tE(J,he,I),pe=[ey(re,0)||J[0],ey(re,1)||J[1],ey(re,2)||J[2]],_e=Wa(t.zoom);if(_e>0){const Se=function({x:Ce,y:Be,z:Fe},Oe,Ze,We,Je){const Qe=1/(1<<Fe);let Ne=Ce*Qe,At=Ne+Qe,vt=Be*Qe,tt=vt+Qe,Gt=0;const kt=(Ne+At)/2-We;return kt>.5?Gt=-1:kt<-.5&&(Gt=1),Ne=((Ne+Gt)*Oe-(We*=Oe))*Ze+We,At=((At+Gt)*Oe-We)*Ze+We,vt=(vt*Oe-(Je*=Oe))*Ze+Je,tt=(tt*Oe-Je)*Ze+Je,[[Ne,tt,0],[At,tt,0],[At,vt,0],[Ne,vt,0]]}(i,e,t._pixelsPerMercatorPixel,B,j);for(let Ce=0;Ce<y.length;Ce++)ea(y[Ce],Se[Ce],_e);const Le=r.Q.add([],Se[ie],Se[(ie+1)%4]);r.Q.scale(Le,Le,.5),ea(pe,Le,_e)}for(const Se of y)r.Q.min(E,E,Se),r.Q.max(T,T,Se);return E[2]=Math.min(J[2],he[2]),r.Q.min(E,E,pe),r.Q.max(T,T,pe),new fn(E,T)}function cm({x:t,y:e,z:i},s=!1){const c=1/(1<<i),h=new Ii(is(t*c),e===(1<<i)-1&&s?-90:xr((e+1)*c)),p=new Ii(is((t+1)*c),e===0&&s?90:xr(e*c));return new Ua(h,p)}function ty(t,e=Vr){const i=Si(t.getNorth()),s=Si(t.getSouth()),c=Math.cos(i),h=Math.cos(s),p=Math.sin(i),y=Math.sin(s),v=t.getWest(),T=t.getEast();return[ku(h,y,v,e),ku(h,y,T,e),ku(c,p,T,e),ku(c,p,v,e)]}function Ad(t,e,i,s){const c=1<<i.z,h=(t/pt+i.x)/c;return sc(xr((e/pt+i.y)/c),is(h),s)}function um({min:t,max:e}){return NS/Math.max(e[0]-t[0],e[1]-t[1],e[2]-t[2])}const rv=new Float64Array(16);function hm(t){const e=um(t),i=r.a9.fromScaling(rv,[e,e,e]);return r.a9.translate(i,i,r.Q.negate([],t.min))}function iy(t){const e=r.a9.fromTranslation(rv,t.min),i=1/um(t);return r.a9.scale(e,e,[i,i,i])}function ny(t){const e=pt/(2*Math.PI);return t/(2*Math.PI)/e}function sv(t,e){return pt/(512*Math.pow(2,t))*um(Mo(e))}function ov(t,e,i,s,c){const h=ny(i),p=[t,e,-i/(2*Math.PI)],y=r.a9.identity(new Float64Array(16));return r.a9.translate(y,y,p),r.a9.scale(y,y,[h,h,h]),r.a9.rotateX(y,y,Si(-c)),r.a9.rotateY(y,y,Si(-s)),y}function Wa(t){return pl(Ng,Fx,t)}function av(t,e){const i=sc(e.lat,e.lng),s=function(h){const p=sc(h._center.lat,h._center.lng),y=r.Q.fromValues(0,1,0);let v=r.Q.cross([],y,p);const T=r.a9.fromRotation([],-h.angle,p);v=r.Q.transformMat4(v,v,T),r.a9.fromRotation(T,-h._pitch,v);const E=r.Q.normalize([],p);return r.Q.scale(E,E,lm(h.cameraToCenterDistance/h.pixelsPerMeter)),r.Q.transformMat4(E,E,T),r.Q.add([],p,E)}(t),c=r.Q.subtract([],s,i);return r.Q.angle(c,i)}function ry(t,e){return av(t,e)>Math.PI/2*1.01}const lv=Si(85),iE=Math.cos(lv),nE=Math.sin(lv),rE=r.a9.create(),cv=t=>{const e=[];return t.paint.get("circle-pitch-alignment")==="map"&&e.push("PITCH_WITH_MAP"),t.paint.get("circle-pitch-scale")==="map"&&e.push("SCALE_WITH_MAP"),e};function uv(t,e,i,s,c,h,p,y,v){if(h&&t.queryGeometry.isAboveHorizon)return!1;h&&(v*=t.pixelToTileUnitsFactor);const T=t.tileID.canonical,E=i.projection.upVectorScale(T,i.center.lat,i.worldSize).metersToTile;for(const I of e)for(const P of I){const R=P.add(y),L=c&&i.elevation?i.elevation.exaggeration()*c.getElevationAt(R.x,R.y,!0):0,B=i.projection.projectTilePoint(R.x,R.y,T);if(L>0){const ie=i.projection.upVector(T,R.x,R.y);B.x+=ie[0]*E*L,B.y+=ie[1]*E*L,B.z+=ie[2]*E*L}const j=h?R:sE(B.x,B.y,B.z,s),G=h?t.tilespaceRays.map(ie=>aE(ie,L)):t.queryGeometry.screenGeometry,X=r.aa.transformMat4([],[B.x,B.y,B.z,1],s);if(!p&&h?v*=X[3]/i.cameraToCenterDistance:p&&!h&&(v*=i.cameraToCenterDistance/X[3]),h){const ie=xr((P.y/pt+T.y)/(1<<T.z));v/=i.projection.pixelsPerMeter(ie,1)/Ur(1,ie)}if(HS(G,j,v))return!0}return!1}function sE(t,e,i,s){const c=r.aa.transformMat4([],[t,e,i,1],s);return new ft(c[0]/c[3],c[1]/c[3])}const hv=r.Q.fromValues(0,0,0),oE=r.Q.fromValues(0,0,1);function aE(t,e){const i=r.Q.create();return hv[2]=e,t.intersectsPlane(hv,oE,i),new ft(i[0],i[1])}class dv extends Hg{}function fv(t,{width:e,height:i},s,c){if(c){if(c instanceof Uint8ClampedArray)c=new Uint8Array(c.buffer);else if(c.length!==e*i*s)throw new RangeError("mismatched image size")}else c=new Uint8Array(e*i*s);return t.width=e,t.height=i,t.data=c,t}function pv(t,e,i){const{width:s,height:c}=e;s===t.width&&c===t.height||(sy(t,e,{x:0,y:0},{x:0,y:0},{width:Math.min(t.width,s),height:Math.min(t.height,c)},i),t.width=s,t.height=c,t.data=e.data)}function sy(t,e,i,s,c,h,p){if(c.width===0||c.height===0)return e;if(c.width>t.width||c.height>t.height||i.x>t.width-c.width||i.y>t.height-c.height)throw new RangeError("out of range source coordinates for image copy");if(c.width>e.width||c.height>e.height||s.x>e.width-c.width||s.y>e.height-c.height)throw new RangeError("out of range destination coordinates for image copy");const y=t.data,v=e.data,T=h===4&&p;for(let E=0;E<c.height;E++){const I=((i.y+E)*t.width+i.x)*h,P=((s.y+E)*e.width+s.x)*h;if(T)for(let R=0;R<c.width;R++){const L=I+R*h+3,B=P+R*h;v[B+0]=255,v[B+1]=255,v[B+2]=255,v[B+3]=y[L]}else for(let R=0;R<c.width*h;R++)v[P+R]=y[I+R]}return e}Mt(dv,"HeatmapBucket",{omit:["layers"]});class qa{constructor(e,i){fv(this,e,1,i)}resize(e){pv(this,new qa(e),1)}clone(){return new qa({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,s,c,h){sy(e,i,s,c,h,1)}}class Ts{constructor(e,i){fv(this,e,4,i)}resize(e){pv(this,new Ts(e),4)}replace(e,i){i?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new Ts({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,s,c,h,p){sy(e,i,s,c,h,4,p)}}class mv{constructor(e,i){this.width=e.width,this.height=e.height,this.data=i instanceof Uint8Array?new Float32Array(i.buffer):i}}Mt(qa,"AlphaImage"),Mt(Ts,"RGBAImage");const lE=new we({visibility:new ge(ae.layout_heatmap.visibility)});var cE={paint:new we({"heatmap-radius":new Ae(ae.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Ae(ae.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new ge(ae.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Ye(ae.paint_heatmap["heatmap-color"]),"heatmap-opacity":new ge(ae.paint_heatmap["heatmap-opacity"])}),layout:lE};function Id(t){const e={},i=t.resolution||256,s=t.clips?t.clips.length:1,c=t.image||new Ts({width:i,height:s}),h=(p,y,v)=>{e[t.evaluationKey]=v;const T=t.expression.evaluate(e);T&&(c.data[p+y+0]=Math.floor(255*T.r/T.a),c.data[p+y+1]=Math.floor(255*T.g/T.a),c.data[p+y+2]=Math.floor(255*T.b/T.a),c.data[p+y+3]=Math.floor(255*T.a))};if(t.clips)for(let p=0,y=0;p<s;++p,y+=4*i)for(let v=0,T=0;v<i;v++,T+=4){const E=v/(i-1),{start:I,end:P}=t.clips[p];h(y,T,I*(1-E)+P*E)}else for(let p=0,y=0;p<i;p++,y+=4)h(0,y,p/(i-1));return c}const uE=new we({visibility:new ge(ae.layout_hillshade.visibility)});var hE={paint:new we({"hillshade-illumination-direction":new ge(ae.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new ge(ae.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new ge(ae.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new ge(ae.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new ge(ae.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new ge(ae.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new ge(ae.paint_hillshade["hillshade-emissive-strength"])}),layout:uE};const dE=ni([{name:"a_pos",components:2,type:"Int16"}],4),{members:fE}=dE;var oy={exports:{}};function dm(t,e,i){i=i||2;var s,c,h,p,y,v,T,E=e&&e.length,I=E?e[0]*i:t.length,P=_v(t,0,I,i,!0),R=[];if(!P||P.next===P.prev)return R;if(E&&(P=function(B,j,G,X){var ie,J,he,re=[];for(ie=0,J=j.length;ie<J;ie++)(he=_v(B,j[ie]*X,ie<J-1?j[ie+1]*X:B.length,X,!1))===he.next&&(he.steiner=!0),re.push(bE(he));for(re.sort(yE),ie=0;ie<re.length;ie++)G=xE(re[ie],G);return G}(t,e,P,i)),t.length>80*i){s=h=t[0],c=p=t[1];for(var L=i;L<I;L+=i)(y=t[L])<s&&(s=y),(v=t[L+1])<c&&(c=v),y>h&&(h=y),v>p&&(p=v);T=(T=Math.max(h-s,p-c))!==0?32767/T:0}return Cd(P,R,i,s,c,T,0),R}function _v(t,e,i,s,c){var h,p;if(c===cy(t,e,i,s)>0)for(h=e;h<i;h+=s)p=xv(h,t[h],t[h+1],p);else for(h=i-s;h>=e;h-=s)p=xv(h,t[h],t[h+1],p);return p&&fm(p,p.next)&&(Dd(p),p=p.next),p}function cc(t,e){if(!t)return t;e||(e=t);var i,s=t;do if(i=!1,s.steiner||!fm(s,s.next)&&Hn(s.prev,s,s.next)!==0)s=s.next;else{if(Dd(s),(s=e=s.prev)===s.next)break;i=!0}while(i||s!==e);return e}function Cd(t,e,i,s,c,h,p){if(t){!p&&h&&function(E,I,P,R){var L=E;do L.z===0&&(L.z=ay(L.x,L.y,I,P,R)),L.prevZ=L.prev,L.nextZ=L.next,L=L.next;while(L!==E);L.prevZ.nextZ=null,L.prevZ=null,function(B){var j,G,X,ie,J,he,re,pe,_e=1;do{for(G=B,B=null,J=null,he=0;G;){for(he++,X=G,re=0,j=0;j<_e&&(re++,X=X.nextZ);j++);for(pe=_e;re>0||pe>0&&X;)re!==0&&(pe===0||!X||G.z<=X.z)?(ie=G,G=G.nextZ,re--):(ie=X,X=X.nextZ,pe--),J?J.nextZ=ie:B=ie,ie.prevZ=J,J=ie;G=X}J.nextZ=null,_e*=2}while(he>1)}(L)}(t,s,c,h);for(var y,v,T=t;t.prev!==t.next;)if(y=t.prev,v=t.next,h?mE(t,s,c,h):pE(t))e.push(y.i/i|0),e.push(t.i/i|0),e.push(v.i/i|0),Dd(t),t=v.next,T=v.next;else if((t=v)===T){p?p===1?Cd(t=_E(cc(t),e,i),e,i,s,c,h,2):p===2&&gE(t,e,i,s,c,h):Cd(cc(t),e,i,s,c,h,1);break}}}function pE(t){var e=t.prev,i=t,s=t.next;if(Hn(e,i,s)>=0)return!1;for(var c=e.x,h=i.x,p=s.x,y=e.y,v=i.y,T=s.y,E=c<h?c<p?c:p:h<p?h:p,I=y<v?y<T?y:T:v<T?v:T,P=c>h?c>p?c:p:h>p?h:p,R=y>v?y>T?y:T:v>T?v:T,L=s.next;L!==e;){if(L.x>=E&&L.x<=P&&L.y>=I&&L.y<=R&&Ou(c,y,h,v,p,T,L.x,L.y)&&Hn(L.prev,L,L.next)>=0)return!1;L=L.next}return!0}function mE(t,e,i,s){var c=t.prev,h=t,p=t.next;if(Hn(c,h,p)>=0)return!1;for(var y=c.x,v=h.x,T=p.x,E=c.y,I=h.y,P=p.y,R=y<v?y<T?y:T:v<T?v:T,L=E<I?E<P?E:P:I<P?I:P,B=y>v?y>T?y:T:v>T?v:T,j=E>I?E>P?E:P:I>P?I:P,G=ay(R,L,e,i,s),X=ay(B,j,e,i,s),ie=t.prevZ,J=t.nextZ;ie&&ie.z>=G&&J&&J.z<=X;){if(ie.x>=R&&ie.x<=B&&ie.y>=L&&ie.y<=j&&ie!==c&&ie!==p&&Ou(y,E,v,I,T,P,ie.x,ie.y)&&Hn(ie.prev,ie,ie.next)>=0||(ie=ie.prevZ,J.x>=R&&J.x<=B&&J.y>=L&&J.y<=j&&J!==c&&J!==p&&Ou(y,E,v,I,T,P,J.x,J.y)&&Hn(J.prev,J,J.next)>=0))return!1;J=J.nextZ}for(;ie&&ie.z>=G;){if(ie.x>=R&&ie.x<=B&&ie.y>=L&&ie.y<=j&&ie!==c&&ie!==p&&Ou(y,E,v,I,T,P,ie.x,ie.y)&&Hn(ie.prev,ie,ie.next)>=0)return!1;ie=ie.prevZ}for(;J&&J.z<=X;){if(J.x>=R&&J.x<=B&&J.y>=L&&J.y<=j&&J!==c&&J!==p&&Ou(y,E,v,I,T,P,J.x,J.y)&&Hn(J.prev,J,J.next)>=0)return!1;J=J.nextZ}return!0}function _E(t,e,i){var s=t;do{var c=s.prev,h=s.next.next;!fm(c,h)&&gv(c,s,s.next,h)&&Pd(c,h)&&Pd(h,c)&&(e.push(c.i/i|0),e.push(s.i/i|0),e.push(h.i/i|0),Dd(s),Dd(s.next),s=t=h),s=s.next}while(s!==t);return cc(s)}function gE(t,e,i,s,c,h){var p=t;do{for(var y=p.next.next;y!==p.prev;){if(p.i!==y.i&&wE(p,y)){var v=yv(p,y);return p=cc(p,p.next),v=cc(v,v.next),Cd(p,e,i,s,c,h,0),void Cd(v,e,i,s,c,h,0)}y=y.next}p=p.next}while(p!==t)}function yE(t,e){return t.x-e.x}function xE(t,e){var i=function(c,h){var p,y=h,v=c.x,T=c.y,E=-1/0;do{if(T<=y.y&&T>=y.next.y&&y.next.y!==y.y){var I=y.x+(T-y.y)*(y.next.x-y.x)/(y.next.y-y.y);if(I<=v&&I>E&&(E=I,p=y.x<y.next.x?y:y.next,I===v))return p}y=y.next}while(y!==h);if(!p)return null;var P,R=p,L=p.x,B=p.y,j=1/0;y=p;do v>=y.x&&y.x>=L&&v!==y.x&&Ou(T<B?v:E,T,L,B,T<B?E:v,T,y.x,y.y)&&(P=Math.abs(T-y.y)/(v-y.x),Pd(y,c)&&(P<j||P===j&&(y.x>p.x||y.x===p.x&&vE(p,y)))&&(p=y,j=P)),y=y.next;while(y!==R);return p}(t,e);if(!i)return e;var s=yv(i,t);return cc(s,s.next),cc(i,i.next)}function vE(t,e){return Hn(t.prev,t,e.prev)<0&&Hn(e.next,t,t.next)<0}function ay(t,e,i,s,c){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-i)*c|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-s)*c|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function bE(t){var e=t,i=t;do(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next;while(e!==t);return i}function Ou(t,e,i,s,c,h,p,y){return(c-p)*(e-y)>=(t-p)*(h-y)&&(t-p)*(s-y)>=(i-p)*(e-y)&&(i-p)*(h-y)>=(c-p)*(s-y)}function wE(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(i,s){var c=i;do{if(c.i!==i.i&&c.next.i!==i.i&&c.i!==s.i&&c.next.i!==s.i&&gv(c,c.next,i,s))return!0;c=c.next}while(c!==i);return!1}(t,e)&&(Pd(t,e)&&Pd(e,t)&&function(i,s){var c=i,h=!1,p=(i.x+s.x)/2,y=(i.y+s.y)/2;do c.y>y!=c.next.y>y&&c.next.y!==c.y&&p<(c.next.x-c.x)*(y-c.y)/(c.next.y-c.y)+c.x&&(h=!h),c=c.next;while(c!==i);return h}(t,e)&&(Hn(t.prev,t,e.prev)||Hn(t,e.prev,e))||fm(t,e)&&Hn(t.prev,t,t.next)>0&&Hn(e.prev,e,e.next)>0)}function Hn(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function fm(t,e){return t.x===e.x&&t.y===e.y}function gv(t,e,i,s){var c=mm(Hn(t,e,i)),h=mm(Hn(t,e,s)),p=mm(Hn(i,s,t)),y=mm(Hn(i,s,e));return c!==h&&p!==y||!(c!==0||!pm(t,i,e))||!(h!==0||!pm(t,s,e))||!(p!==0||!pm(i,t,s))||!(y!==0||!pm(i,e,s))}function pm(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function mm(t){return t>0?1:t<0?-1:0}function Pd(t,e){return Hn(t.prev,t,t.next)<0?Hn(t,e,t.next)>=0&&Hn(t,t.prev,e)>=0:Hn(t,e,t.prev)<0||Hn(t,t.next,e)<0}function yv(t,e){var i=new ly(t.i,t.x,t.y),s=new ly(e.i,e.x,e.y),c=t.next,h=e.prev;return t.next=e,e.prev=t,i.next=c,c.prev=i,s.next=i,i.prev=s,h.next=s,s.prev=h,s}function xv(t,e,i,s){var c=new ly(t,e,i);return s?(c.next=s.next,c.prev=s,s.next.prev=c,s.next=c):(c.prev=c,c.next=c),c}function Dd(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function ly(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function cy(t,e,i,s){for(var c=0,h=e,p=i-s;h<i;h+=s)c+=(t[p]-t[h])*(t[h+1]+t[p+1]),p=h;return c}oy.exports=dm,oy.exports.default=dm,dm.deviation=function(t,e,i,s){var c=e&&e.length,h=Math.abs(cy(t,0,c?e[0]*i:t.length,i));if(c)for(var p=0,y=e.length;p<y;p++)h-=Math.abs(cy(t,e[p]*i,p<y-1?e[p+1]*i:t.length,i));var v=0;for(p=0;p<s.length;p+=3){var T=s[p]*i,E=s[p+1]*i,I=s[p+2]*i;v+=Math.abs((t[T]-t[I])*(t[E+1]-t[T+1])-(t[T]-t[E])*(t[I+1]-t[T+1]))}return h===0&&v===0?0:Math.abs((v-h)/h)},dm.flatten=function(t){for(var e=t[0][0].length,i={vertices:[],holes:[],dimensions:e},s=0,c=0;c<t.length;c++){for(var h=0;h<t[c].length;h++)for(var p=0;p<e;p++)i.vertices.push(t[c][h][p]);c>0&&i.holes.push(s+=t[c-1].length)}return i};var _m=Ee(oy.exports);function uy(t,e){const i=t.length;if(i<=1)return[t];const s=[];let c,h;for(let p=0;p<i;p++){const y=_l(t[p]);y!==0&&(t[p].area=Math.abs(y),h===void 0&&(h=y<0),h===y<0?(c&&s.push(c),c=[t[p]]):c.push(t[p]))}if(c&&s.push(c),e>1)for(let p=0;p<s.length;p++)s[p].length<=e||(bp(s[p],e,1,s[p].length-1,TE),s[p]=s[p].slice(0,e));return s}function TE(t,e){return e.area-t.area}function hy(t,e,i){const s=i.patternDependencies;let c=!1;for(const h of e){const p=h.paint.get(`${t}-pattern`);p.isConstant()||(c=!0);const y=p.constantOr(null);y&&(c=!0,s[y]=!0)}return c}function dy(t,e,i,s,c){const h=c.patternDependencies;for(const p of e){const y=p.paint.get(`${t}-pattern`).value;if(y.kind!=="constant"){let v=y.evaluate({zoom:s},i,{},c.availableImages);v=v&&v.name?v.name:v,h[v]=!0,i.patterns[p.id]=v}}return i}class fy{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new gr,this.indexArray=new Kn,this.indexArray2=new ts,this.programConfigurations=new Va(e.layers,e.zoom),this.segments=new kn,this.segments2=new kn,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.projection=e.projection}populate(e,i,s,c){this.hasPattern=hy("fill",this.layers,i);const h=this.layers[0].layout.get("fill-sort-key"),p=[];for(const{feature:y,id:v,index:T,sourceLayerIndex:E}of e){const I=this.layers[0]._featureFilter.needGeometry,P=Ga(y,I);if(!this.layers[0]._featureFilter.filter(new Y(this.zoom),P,s))continue;const R=h?h.evaluate(P,{},s,i.availableImages):void 0,L={id:v,properties:y.properties,type:y.type,sourceLayerIndex:E,index:T,geometry:I?P.geometry:Jo(y,s,c),patterns:{},sortKey:R};p.push(L)}h&&p.sort((y,v)=>y.sortKey-v.sortKey);for(const y of p){const{geometry:v,index:T,sourceLayerIndex:E}=y;if(this.hasPattern){const I=dy("fill",this.layers,y,this.zoom,i);this.patternFeatures.push(I)}else this.addFeature(y,v,T,s,{},i.availableImages,i.brightness);i.featureIndex.insert(e[T].feature,v,T,E,this.index)}}update(e,i,s,c,h){const p=Object.keys(e).length!==0;p&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(e,i,p?this.stateDependentLayers:this.layers,s,c,h)}addFeatures(e,i,s,c,h,p){for(const y of this.patternFeatures)this.addFeature(y,y.geometry,y.index,i,s,c,p)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,fE),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.indexBuffer2=e.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(e,i,s,c,h,p=[],y){for(const v of uy(i,500)){let T=0;for(const B of v)T+=B.length;const E=this.segments.prepareSegment(T,this.layoutVertexArray,this.indexArray),I=E.vertexLength,P=[],R=[];for(const B of v){if(B.length===0)continue;B!==v[0]&&R.push(P.length/2);const j=this.segments2.prepareSegment(B.length,this.layoutVertexArray,this.indexArray2),G=j.vertexLength;this.layoutVertexArray.emplaceBack(B[0].x,B[0].y),this.indexArray2.emplaceBack(G+B.length-1,G),P.push(B[0].x),P.push(B[0].y);for(let X=1;X<B.length;X++)this.layoutVertexArray.emplaceBack(B[X].x,B[X].y),this.indexArray2.emplaceBack(G+X-1,G+X),P.push(B[X].x),P.push(B[X].y);j.vertexLength+=B.length,j.primitiveLength+=B.length}const L=_m(P,R);for(let B=0;B<L.length;B+=3)this.indexArray.emplaceBack(I+L[B],I+L[B+1],I+L[B+2]);E.vertexLength+=T,E.primitiveLength+=L.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,h,p,c,y)}}Mt(fy,"FillBucket",{omit:["layers","patternFeatures"]});const ME=new we({"fill-sort-key":new Ae(ae.layout_fill["fill-sort-key"]),visibility:new ge(ae.layout_fill.visibility)});var SE={paint:new we({"fill-antialias":new ge(ae.paint_fill["fill-antialias"]),"fill-opacity":new Ae(ae.paint_fill["fill-opacity"]),"fill-color":new Ae(ae.paint_fill["fill-color"]),"fill-outline-color":new Ae(ae.paint_fill["fill-outline-color"]),"fill-translate":new ge(ae.paint_fill["fill-translate"]),"fill-translate-anchor":new ge(ae.paint_fill["fill-translate-anchor"]),"fill-pattern":new Ae(ae.paint_fill["fill-pattern"]),"fill-emissive-strength":new ge(ae.paint_fill["fill-emissive-strength"])}),layout:ME};const EE=ni([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),AE=ni([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),IE=ni([{name:"a_centroid_pos",components:2,type:"Uint16"}]),CE=ni([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),PE=ni([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:DE}=EE;var gm={},kE=Oc,vv=Fu;function Fu(t,e,i,s,c){this.properties={},this.extent=i,this.type=0,this._pbf=t,this._geometry=-1,this._keys=s,this._values=c,t.readFields(RE,this,e)}function RE(t,e,i){t==1?e.id=i.readVarint():t==2?function(s,c){for(var h=s.readVarint()+s.pos;s.pos<h;){var p=c._keys[s.readVarint()],y=c._values[s.readVarint()];c.properties[p]=y}}(i,e):t==3?e.type=i.readVarint():t==4&&(e._geometry=i.pos)}function zE(t){for(var e,i,s=0,c=0,h=t.length,p=h-1;c<h;p=c++)s+=((i=t[p]).x-(e=t[c]).x)*(e.y+i.y);return s}Fu.types=["Unknown","Point","LineString","Polygon"],Fu.prototype.loadGeometry=function(){var t=this._pbf;t.pos=this._geometry;for(var e,i=t.readVarint()+t.pos,s=1,c=0,h=0,p=0,y=[];t.pos<i;){if(c<=0){var v=t.readVarint();s=7&v,c=v>>3}if(c--,s===1||s===2)h+=t.readSVarint(),p+=t.readSVarint(),s===1&&(e&&y.push(e),e=[]),e.push(new kE(h,p));else{if(s!==7)throw new Error("unknown command "+s);e&&e.push(e[0].clone())}}return e&&y.push(e),y},Fu.prototype.bbox=function(){var t=this._pbf;t.pos=this._geometry;for(var e=t.readVarint()+t.pos,i=1,s=0,c=0,h=0,p=1/0,y=-1/0,v=1/0,T=-1/0;t.pos<e;){if(s<=0){var E=t.readVarint();i=7&E,s=E>>3}if(s--,i===1||i===2)(c+=t.readSVarint())<p&&(p=c),c>y&&(y=c),(h+=t.readSVarint())<v&&(v=h),h>T&&(T=h);else if(i!==7)throw new Error("unknown command "+i)}return[p,v,y,T]},Fu.prototype.toGeoJSON=function(t,e,i){var s,c,h=this.extent*Math.pow(2,i),p=this.extent*t,y=this.extent*e,v=this.loadGeometry(),T=Fu.types[this.type];function E(R){for(var L=0;L<R.length;L++){var B=R[L];R[L]=[360*(B.x+p)/h-180,360/Math.PI*Math.atan(Math.exp((180-360*(B.y+y)/h)*Math.PI/180))-90]}}switch(this.type){case 1:var I=[];for(s=0;s<v.length;s++)I[s]=v[s][0];E(v=I);break;case 2:for(s=0;s<v.length;s++)E(v[s]);break;case 3:for(v=function(R){var L=R.length;if(L<=1)return[R];for(var B,j,G=[],X=0;X<L;X++){var ie=zE(R[X]);ie!==0&&(j===void 0&&(j=ie<0),j===ie<0?(B&&G.push(B),B=[R[X]]):B.push(R[X]))}return B&&G.push(B),G}(v),s=0;s<v.length;s++)for(c=0;c<v[s].length;c++)E(v[s][c])}v.length===1?v=v[0]:T="Multi"+T;var P={type:"Feature",geometry:{type:T,coordinates:v},properties:this.properties};return"id"in this&&(P.id=this.id),P};var LE=vv,bv=wv;function wv(t,e){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=t,this._keys=[],this._values=[],this._features=[],t.readFields(OE,this,e),this.length=this._features.length}function OE(t,e,i){t===15?e.version=i.readVarint():t===1?e.name=i.readString():t===5?e.extent=i.readVarint():t===2?e._features.push(i.pos):t===3?e._keys.push(i.readString()):t===4&&e._values.push(function(s){for(var c=null,h=s.readVarint()+s.pos;s.pos<h;){var p=s.readVarint()>>3;c=p===1?s.readString():p===2?s.readFloat():p===3?s.readDouble():p===4?s.readVarint64():p===5?s.readVarint():p===6?s.readSVarint():p===7?s.readBoolean():null}return c}(i))}wv.prototype.feature=function(t){if(t<0||t>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[t];var e=this._pbf.readVarint()+this._pbf.pos;return new LE(this._pbf,e,this.extent,this._keys,this._values)};var FE=bv;function BE(t,e,i){if(t===3){var s=new FE(i,i.readVarint()+i.pos);s.length&&(e[s.name]=s)}}var py=gm.VectorTile=function(t,e){this.layers=t.readFields(BE,{},e)},ym=gm.VectorTileFeature=vv;function xm(t,e,i,s){const c=[],h=s===0?(p,y,v,T,E,I)=>{p.push(new ft(I,v+(I-y)/(T-y)*(E-v)))}:(p,y,v,T,E,I)=>{p.push(new ft(y+(I-v)/(E-v)*(T-y),I))};for(const p of t){const y=[];for(const v of p){if(v.length<=2)continue;const T=[];for(let P=0;P<v.length-1;P++){const R=v[P].x,L=v[P].y,B=v[P+1].x,j=v[P+1].y,G=s===0?R:L,X=s===0?B:j;G<e?X>e&&h(T,R,L,B,j,e):G>i?X<i&&h(T,R,L,B,j,i):T.push(v[P]),X<e&&G>=e&&h(T,R,L,B,j,e),X>i&&G<=i&&h(T,R,L,B,j,i)}let E=v[v.length-1];const I=s===0?E.x:E.y;I>=e&&I<=i&&T.push(E),T.length&&(E=T[T.length-1],T[0].x===E.x&&T[0].y===E.y||T.push(T[0]),y.push(T))}y.length&&c.push(y)}return c}function vm(t,e){return t.x-e.x||t.y-e.y}function Tv(t,e){return vm(t.min,e.min)===0&&vm(t.max,e.max)===0}function Mv(t,e){return!(t.min.x>e.max.x||t.max.x<e.min.x||t.min.y>e.max.y||t.max.y<e.min.y)}function Sv(t,e,i){const s=1/pt,c=1/(1<<i.canonical.z),h=(e.x*s+i.canonical.x)*c+i.wrap,p=(e.y*s+i.canonical.y)*c;return{min:new ft((t.x*s+i.canonical.x)*c+i.wrap,(t.y*s+i.canonical.y)*c),max:new ft(h,p)}}function NE(t,e,i){const s=1<<i.canonical.z,c=((e.x-i.wrap)*s-i.canonical.x)*pt,h=(e.y*s-i.canonical.y)*pt;return{min:new ft(((t.x-i.wrap)*s-i.canonical.x)*pt,(t.y*s-i.canonical.y)*pt),max:new ft(c,h)}}function Ev(t,e,i,s,c,h,p){const y=t.indices,v=t.vertices,T=[];for(let E=s;E<s+c;E+=3){const I=e[i[E+0]+h],P=e[i[E+1]+h],R=e[i[E+2]+h],L=Math.min(I.x,P.x,R.x),B=Math.max(I.x,P.x,R.x),j=Math.min(I.y,P.y,R.y),G=Math.max(I.y,P.y,R.y);T.length=0,t.grid.query(new ft(L,j),new ft(B,G),T);for(let X=0;X<T.length;X++){const ie=T[X];if(Qg(v[y[3*ie+0]],v[y[3*ie+1]],v[y[3*ie+2]],I,P,R,p))return!0}}return!1}function Av(t,e,i,s){if(!t||!i)return!1;let c=t.vertices;if(!e.canonical.equals(s.canonical)||e.wrap!==s.wrap){if(i.vertices.length<t.vertices.length)return Av(i,s,t,e);const h=e.canonical,p=s.canonical,y=Math.pow(2,p.z-h.z);c=t.vertices.map(v=>new ft((v.x+h.x*pt)*y-p.x*pt,(v.y+h.y*pt)*y-p.y*pt))}return Ev(i,c,t.indices,0,t.indices.length,0,0)}gm.VectorTileLayer=bv;class Iv{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,i){const s=this.toIdx(e,i);return{min:this.minimums[s],max:this.maximums[s]}}isLeaf(e,i){return this.leaves[this.toIdx(e,i)]}toIdx(e,i){return i*this.size+e}}function Cv(t,e,i,s){let c=0,h=Number.MAX_VALUE;for(let p=0;p<3;p++)if(Math.abs(s[p])<1e-15){if(i[p]<t[p]||i[p]>e[p])return null}else{const y=1/s[p];let v=(t[p]-i[p])*y,T=(e[p]-i[p])*y;if(v>T){const E=v;v=T,T=E}if(v>c&&(c=v),T<h&&(h=T),c>h)return null}return c}function Pv(t,e,i,s,c,h,p,y,v,T,E){const I=s-t,P=c-e,R=h-i,L=p-t,B=y-e,j=v-i,G=E[1]*j-E[2]*B,X=E[2]*L-E[0]*j,ie=E[0]*B-E[1]*L,J=I*G+P*X+R*ie;if(Math.abs(J)<1e-15)return null;const he=1/J,re=T[0]-t,pe=T[1]-e,_e=T[2]-i,Se=(re*G+pe*X+_e*ie)*he;if(Se<0||Se>1)return null;const Le=pe*R-_e*P,Ce=_e*I-re*R,Be=re*P-pe*I,Fe=(E[0]*Le+E[1]*Ce+E[2]*Be)*he;return Fe<0||Se+Fe>1?null:(L*Le+B*Ce+j*Be)*he}function Dv(t,e,i){return(t-e)/(i-e)}function kv(t,e,i,s,c,h,p,y,v){const T=1<<i,E=h-s,I=p-c,P=(t+1)/T*E+s,R=(e+0)/T*I+c,L=(e+1)/T*I+c;y[0]=(t+0)/T*E+s,y[1]=R,v[0]=P,v[1]=L}class Rv{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const i=function(h){const p=Math.ceil(Math.log2(h.dim/8)),y=[];let v=Math.ceil(Math.pow(2,p));const T=1/v,E=(R,L,B,j,G)=>{const X=j?1:0,ie=(R+1)*B-X,J=L*B,he=(L+1)*B-X;G[0]=R*B,G[1]=J,G[2]=ie,G[3]=he};let I=new Iv(v);const P=[];for(let R=0;R<v*v;R++){E(R%v,Math.floor(R/v),T,!1,P);const L=Ha(P[0],P[1],h),B=Ha(P[2],P[1],h),j=Ha(P[2],P[3],h),G=Ha(P[0],P[3],h);I.minimums.push(Math.min(L,B,j,G)),I.maximums.push(Math.max(L,B,j,G)),I.leaves.push(1)}for(y.push(I),v/=2;v>=1;v/=2){const R=y[y.length-1];I=new Iv(v);for(let L=0;L<v*v;L++){E(L%v,Math.floor(L/v),2,!0,P);const B=R.getElevation(P[0],P[1]),j=R.getElevation(P[2],P[1]),G=R.getElevation(P[2],P[3]),X=R.getElevation(P[0],P[3]),ie=R.isLeaf(P[0],P[1]),J=R.isLeaf(P[2],P[1]),he=R.isLeaf(P[2],P[3]),re=R.isLeaf(P[0],P[3]),pe=Math.min(B.min,j.min,G.min,X.min),_e=Math.max(B.max,j.max,G.max,X.max),Se=ie&&J&&he&&re;I.maximums.push(_e),I.minimums.push(pe),I.leaves.push(_e-pe<=5&&Se?1:0)}y.push(I)}return y}(this.dem),s=i.length-1,c=i[s];this._addNode(c.minimums[0],c.maximums[0],c.leaves[0]),this._construct(i,0,0,s,0)}raycastRoot(e,i,s,c,h,p,y=1){return Cv([e,i,-100],[s,c,this.maximums[0]*y],h,p)}raycast(e,i,s,c,h,p,y=1){if(!this.nodeCount)return null;const v=this.raycastRoot(e,i,s,c,h,p,y);if(v==null)return null;const T=[],E=[],I=[],P=[],R=[{idx:0,t:v,nodex:0,nodey:0,depth:0}];for(;R.length>0;){const{idx:L,t:B,nodex:j,nodey:G,depth:X}=R.pop();if(this.leaves[L]){kv(j,G,X,e,i,s,c,I,P);const J=1<<X,he=(j+0)/J,re=(j+1)/J,pe=(G+0)/J,_e=(G+1)/J,Se=Ha(he,pe,this.dem)*y,Le=Ha(re,pe,this.dem)*y,Ce=Ha(re,_e,this.dem)*y,Be=Ha(he,_e,this.dem)*y,Fe=Pv(I[0],I[1],Se,P[0],I[1],Le,P[0],P[1],Ce,h,p),Oe=Pv(P[0],P[1],Ce,I[0],P[1],Be,I[0],I[1],Se,h,p),Ze=Math.min(Fe!==null?Fe:Number.MAX_VALUE,Oe!==null?Oe:Number.MAX_VALUE);if(Ze!==Number.MAX_VALUE)return Ze;{const We=r.Q.scaleAndAdd([],h,p,B);if(zv(Se,Le,Be,Ce,Dv(We[0],I[0],P[0]),Dv(We[1],I[1],P[1]))>=We[2])return B}continue}let ie=0;for(let J=0;J<this._siblingOffset.length;J++){kv((j<<1)+this._siblingOffset[J][0],(G<<1)+this._siblingOffset[J][1],X+1,e,i,s,c,I,P),I[2]=-100,P[2]=this.maximums[this.childOffsets[L]+J]*y;const he=Cv(I,P,h,p);if(he!=null){const re=he;T[J]=re;let pe=!1;for(let _e=0;_e<ie&&!pe;_e++)re>=T[E[_e]]&&(E.splice(_e,0,J),pe=!0);pe||(E[ie]=J),ie++}}for(let J=0;J<ie;J++){const he=E[J];R.push({idx:this.childOffsets[L]+he,t:T[he],nodex:(j<<1)+this._siblingOffset[he][0],nodey:(G<<1)+this._siblingOffset[he][1],depth:X+1})}}return null}_addNode(e,i,s){return this.minimums.push(e),this.maximums.push(i),this.leaves.push(s),this.childOffsets.push(0),this.nodeCount++}_construct(e,i,s,c,h){if(e[c].isLeaf(i,s)===1)return;this.childOffsets[h]||(this.childOffsets[h]=this.nodeCount);const p=c-1,y=e[p];let v=0,T=0;for(let E=0;E<this._siblingOffset.length;E++){const I=2*i+this._siblingOffset[E][0],P=2*s+this._siblingOffset[E][1],R=y.getElevation(I,P),L=y.isLeaf(I,P),B=this._addNode(R.min,R.max,L);L&&(v|=1<<E),T||(T=B)}for(let E=0;E<this._siblingOffset.length;E++)v&1<<E||this._construct(e,2*i+this._siblingOffset[E][0],2*s+this._siblingOffset[E][1],p,T+E)}}function zv(t,e,i,s,c,h){return hi(hi(t,i,h),hi(e,s,h),c)}function Ha(t,e,i){const s=i.dim,c=xi(t*s-.5,0,s-1),h=xi(e*s-.5,0,s-1),p=Math.floor(c),y=Math.floor(h),v=Math.min(p+1,s-1),T=Math.min(y+1,s-1);return zv(i.get(p,y),i.get(v,y),i.get(p,T),i.get(v,T),c-p,h-y)}const VE={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function UE(t,e,i){return(256*t*256+256*e+i)/10-1e4}function jE(t,e,i){return 256*t+e+i/256-32768}class bm{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,i,s,c=!1){if(this.uid=e,i.height!==i.width)throw new RangeError("DEM tiles must be square");if(s&&s!=="mapbox"&&s!=="terrarium")return wn(`"${s}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=i.height;const h=this.dim=i.height-2,p=new Uint32Array(i.data.buffer);if(this.pixels=new Uint8Array(i.data.buffer),this.floatView=new Float32Array(i.data.buffer),this.borderReady=c,this._modifiedForSources={},!c){for(let v=0;v<h;v++)p[this._idx(-1,v)]=p[this._idx(0,v)],p[this._idx(h,v)]=p[this._idx(h-1,v)],p[this._idx(v,-1)]=p[this._idx(v,0)],p[this._idx(v,h)]=p[this._idx(v,h-1)];p[this._idx(-1,-1)]=p[this._idx(0,0)],p[this._idx(h,-1)]=p[this._idx(h-1,0)],p[this._idx(-1,h)]=p[this._idx(0,h-1)],p[this._idx(h,h)]=p[this._idx(h-1,h-1)]}const y=s==="terrarium"?jE:UE;for(let v=0;v<p.length;++v){const T=4*v;this.floatView[v]=y(this.pixels[T],this.pixels[T+1],this.pixels[T+2])}this._timestamp=ks.now()}_buildQuadTree(){this._tree=new Rv(this)}get(e,i,s=!1){s&&(e=xi(e,-1,this.dim),i=xi(i,-1,this.dim));const c=this._idx(e,i);return this.floatView[c]}set(e,i,s){const c=this._idx(e,i),h=this.floatView[c];return this.floatView[c]=s,s-h}static getUnpackVector(e){return VE[e]}_idx(e,i){if(e<-1||e>=this.dim+1||i<-1||i>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(i+1)*this.stride+(e+1)}static pack(e,i){const s=[0,0,0,0],c=bm.getUnpackVector(i);let h=Math.floor((e+c[3])/c[2]);return s[2]=h%256,h=Math.floor(h/256),s[1]=h%256,h=Math.floor(h/256),s[0]=h,s}getPixels(){return new mv({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,i,s){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let c=i*this.dim,h=i*this.dim+this.dim,p=s*this.dim,y=s*this.dim+this.dim;switch(i){case-1:c=h-1;break;case 1:h=c+1}switch(s){case-1:p=y-1;break;case 1:y=p+1}const v=-i*this.dim,T=-s*this.dim;for(let E=p;E<y;E++)for(let I=c;I<h;I++){const P=4*this._idx(I,E),R=4*this._idx(I+v,E+T);this.pixels[P+0]=e.pixels[R+0],this.pixels[P+1]=e.pixels[R+1],this.pixels[P+2]=e.pixels[R+2],this.pixels[P+3]=e.pixels[R+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}Mt(bm,"DEMData"),Mt(Rv,"DemMinMaxQuadTree",{omit:["dem"]});class Bu{constructor(e,i,s){this._demTile=e,this._dem=this._demTile.dem,this._scale=i,this._offset=s}static create(e,i,s){const c=s||e.findDEMTileFor(i);if(!c||!c.dem)return;const h=c.dem,p=c.tileID,y=1<<i.canonical.z-p.canonical.z;return new Bu(c,h.dim/pt/y,[(i.canonical.x/y-p.canonical.x)*h.dim,(i.canonical.y/y-p.canonical.y)*h.dim])}tileCoordToPixel(e,i){const s=i*this._scale+this._offset[1],c=Math.floor(e*this._scale+this._offset[0]),h=Math.floor(s);return new ft(c,h)}getElevationAt(e,i,s,c){const h=e*this._scale+this._offset[0],p=i*this._scale+this._offset[1],y=Math.floor(h),v=Math.floor(p),T=this._dem;return c=!!c,s?hi(hi(T.get(y,v,c),T.get(y,v+1,c),p-v),hi(T.get(y+1,v,c),T.get(y+1,v+1,c),p-v),h-y):T.get(y,v,c)}getElevationAtPixel(e,i,s){return this._dem.get(e,i,!!s)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*Ur(1,e)*this._dem.stride}}const GE=ym.types,WE=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius"],qE=["fill-extrusion-flood-light-ground-radius"],HE=Math.pow(2,13),ZE=Math.pow(2,15)-1,Lv=new ft(0,1),Za=2147483648;function kd(t,e,i,s,c,h,p,y){t.emplaceBack((e<<1)+p,(i<<1)+h,(Math.floor(s*HE)<<1)+c,Math.round(y))}function wm(t,e,i,s,c,h){t.emplaceBack(e.x,e.y,(i.x<<1)+s,(i.y<<1)+c,h)}function Rd(t,e,i){t.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}class Ov{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class Fv{constructor(){this.centroidXY=new ft(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new ft(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new ft(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new ft(this.max.x-this.min.x,this.max.y-this.min.y)}}class Bv{constructor(){this.acc=new ft(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,i){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=i.x,e.min.y=e.max.y=i.y)}appendEdge(e,i,s){this.accCount++,this.acc._add(i);let c=!!this.borders;i.x<e.min.x?(e.min.x=i.x,c=!0):i.x>e.max.x&&(e.max.x=i.x,c=!0),i.y<e.min.y?(e.min.y=i.y,c=!0):i.y>e.max.y&&(e.max.y=i.y,c=!0),((i.x===0||i.x===pt)&&i.x===s.x)!=((i.y===0||i.y===pt)&&i.y===s.y)&&this.processBorderOverlap(i,s),c&&this.checkBorderIntersection(i,s)}checkBorderIntersection(e,i){i.x<0!=e.x<0&&this.addBorderIntersection(0,hi(i.y,e.y,(0-i.x)/(e.x-i.x))),i.x>pt!=e.x>pt&&this.addBorderIntersection(1,hi(i.y,e.y,(pt-i.x)/(e.x-i.x))),i.y<0!=e.y<0&&this.addBorderIntersection(2,hi(i.x,e.x,(0-i.y)/(e.y-i.y))),i.y>pt!=e.y>pt&&this.addBorderIntersection(3,hi(i.x,e.x,(pt-i.y)/(e.y-i.y)))}addBorderIntersection(e,i){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const s=this.borders[e];i<s[0]&&(s[0]=i),i>s[1]&&(s[1]=i)}processBorderOverlap(e,i){if(e.x===i.x){if(e.y===i.y)return;const s=e.x===0?0:1;this.addBorderIntersection(s,i.y),this.addBorderIntersection(s,e.y)}else{const s=e.y===0?2:3;this.addBorderIntersection(s,i.x),this.addBorderIntersection(s,e.x)}}centroid(){return this.accCount===0?new ft(0,0):new ft(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((e,i)=>e+ +(i[0]!==Number.MAX_VALUE),0):0}}function Nv(t,e){const i=t.add(e)._unit(),s=xi(t.x*i.x+t.y*i.y,-1,1);var c,h,p;return c=Math.acos(s),Math.min(4,Math.max(-4,Math.tan(c)))/4*ZE*((h=t).x*(p=e).y-h.y*p.x<0?-1:1)}const $E=[t=>t.x<0,t=>t.x>pt,t=>t.y<0,t=>t.y>pt];function YE(t,e,i,s){const c=[4];if(s===0)return c;i._mult(s);const h=t.sub(i),p=e.sub(i),y=[t,e,h,p];for(let v=0;v<4;v++)for(const T of y)if($E[v](T)){c.push(v);break}return c}class Vv{constructor(e){this.vertexArray=new zr,this.indexArray=new Kn,this.programConfigurations=new Va(e.layers,e.zoom,i=>qE.includes(i)),this._segments=new kn,this.hiddenByLandmarkVertexArray=new zg,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new kn}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(e,i,s,c=!1){const h=e.length;if(h>2){let p=Math.max(0,this._segments.get().length-1);const y=this._segments._prepareSegment(4*h,this.vertexArray.length,2*this._segmentToGroundQuads[p].length);let v;p!==this._segments.get().length-1&&(p++,this._segmentToGroundQuads[p]=[],this._segmentToRegionTriCounts[p]=[0,0,0,0,0]);{const T=e[0],E=e[1];v=Nv(T.sub(e[h-1])._perp()._unit(),E.sub(T)._perp()._unit())}for(let T=0;T<h;T++){const E=T===h-1?0:T+1,I=e[T],P=e[E],R=e[E===h-1?0:E+1],L=P.sub(I)._perp()._unit(),B=Nv(L,R.sub(P)._perp()._unit()),j=v,G=B;if(my(I,P,i)||c&&Gv(I,i)&&Gv(P,i)){v=B;continue}const X=y.vertexLength;wm(this.vertexArray,I,P,1,1,j),wm(this.vertexArray,I,P,1,0,j),wm(this.vertexArray,I,P,0,1,G),wm(this.vertexArray,I,P,0,0,G),y.vertexLength+=4;const ie=YE(I,P,L,s);for(const J of ie)this._segmentToGroundQuads[p].push({id:X,region:J}),this._segmentToRegionTriCounts[p][J]+=2,y.primitiveLength+=2;v=B}}}prepareBorderSegments(){if(!this.hasData())return;const e=this._segments.get(),i=e.length;for(let s=0;s<i;s++)this._segmentToGroundQuads[s].sort((c,h)=>c.region-h.region);for(let s=0;s<i;s++){const c=this._segmentToGroundQuads[s],h=e[s],p=this._segmentToRegionTriCounts[s];p.reduce((v,T)=>v+T,0);let y=0;for(let v=0;v<=4;v++){const T=p[v];if(T!==0){let E=this.regionSegments[v];E||(E=this.regionSegments[v]=new kn);const I={vertexOffset:h.vertexOffset,primitiveOffset:h.primitiveOffset+y,vertexLength:h.vertexLength,primitiveLength:T};E.get().push(I)}y+=T}for(let v=0;v<c.length;v++){const T=c[v].id;this.indexArray.emplaceBack(T,T+1,T+3),this.indexArray.emplaceBack(T,T+3,T+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,i,s,c,h,p){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,i,s,c,h,p)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,AE.members),this.indexBuffer=e.createIndexBuffer(this.indexArray))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,i,s,c,h,p){this.hasData()&&this.programConfigurations.updatePaintArrays(e,i,s,c,h,p)}updateHiddenByLandmark(e){if(!this.hasData())return;const i=e.groundVertexCount+e.groundVertexArrayOffset;if(e.groundVertexCount===0)return;const s=e.flags&Za?1:0;for(let c=e.groundVertexArrayOffset;c<i;++c)this.hiddenByLandmarkVertexArray.emplace(c,s);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,CE.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){const i=this.regionSegments[e];i&&i.destroy()}}}}class Tm{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new Kn,this.footprintVertices=new gr,this.footprintSegments=[],this.layoutVertexArray=new yr,this.centroidVertexArray=new Dx,this.indexArray=new Kn,this.programConfigurations=new Va(e.layers,e.zoom,i=>WE.includes(i)),this.segments=new kn,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.groundEffect=new Vv(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}populate(e,i,s,c){this.features=[],this.hasPattern=hy("fill-extrusion",this.layers,i),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.tileToMeter=nm(s),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter;for(const{feature:h,id:p,index:y,sourceLayerIndex:v}of e){const T=this.layers[0]._featureFilter.needGeometry,E=Ga(h,T);if(!this.layers[0]._featureFilter.filter(new Y(this.zoom),E,s))continue;const I={id:p,sourceLayerIndex:v,index:y,geometry:T?E.geometry:Jo(h,s,c),properties:h.properties,type:h.type,patterns:{}},P=this.layoutVertexArray.length;this.hasPattern?this.features.push(dy("fill-extrusion",this.layers,I,this.zoom,i)):this.addFeature(I,I.geometry,y,s,{},i.availableImages,c,i.brightness),i.featureIndex.insert(h,I.geometry,y,v,this.index,P)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,i,s,c,h,p){for(const y of this.features){const{geometry:v}=y;this.addFeature(y,v,y.index,i,s,c,h,p)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(e,i,s,c,h){const p=Object.keys(e).length!==0;if(p&&!this.stateDependentLayers.length)return;const y=p?this.stateDependentLayers:this.layers;this.programConfigurations.updatePaintArrays(e,i,y,s,c,h),this.groundEffect.update(e,i,y,s,c,h)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,DE),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,PE.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,IE.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,i,s,c,h,p,y,v){const T=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(e,{})/this.tileToMeter,E=[new ft(0,0),new ft(pt,pt)],I=y.projection,P=I.name==="globe",R=GE[e.type]==="Polygon",L=new Bv;L.centroidDataIndex=this.centroidData.length;const B=new Fv,j=this.layers[0].paint.get("fill-extrusion-base").evaluate(e,{},c)<=0,G=this.layers[0].paint.get("fill-extrusion-height").evaluate(e,{},c);B.height=G,B.vertexArrayOffset=this.layoutVertexArray.length,B.groundVertexArrayOffset=this.groundEffect.vertexArray.length,P&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new ws);const X=uy(i,500);for(let _e=X.length-1;_e>=0;_e--){const Se=X[_e];(Se.length===0||(ie=Se[0]).every(Le=>Le.x<=0)||ie.every(Le=>Le.x>=pt)||ie.every(Le=>Le.y<=0)||ie.every(Le=>Le.y>=pt))&&X.splice(_e,1)}var ie;let J;if(P)J=Zv(X,E,c);else{J=[];for(const _e of X)J.push({polygon:_e,bounds:E})}const he=R?this.edgeRadius:0,re=he>0&&this.zoom<17,pe=(_e,Se)=>{if(_e.length===0)return!1;const Le=_e[_e.length-1];return Se.x===Le.x&&Se.y===Le.y};for(const{polygon:_e,bounds:Se}of J){let Le=0,Ce=0;for(const Ze of _e)R&&!Ze[0].equals(Ze[Ze.length-1])&&Ze.push(Ze[0]),Ce+=R?Ze.length-1:Ze.length;const Be=this.segments.prepareSegment((R?5:4)*Ce,this.layoutVertexArray,this.indexArray);B.footprintSegIdx<0&&(B.footprintSegIdx=this.footprintSegments.length),B.polygonSegIdx<0&&(B.polygonSegIdx=this.polygonSegments.length);const Fe={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Oe=new Ov;if(Oe.vertexOffset=this.footprintVertices.length,Oe.indexOffset=3*this.footprintIndices.length,Oe.ringIndices=[],R){const Ze=[],We=[];Le=Be.vertexLength;for(let Qe=0;Qe<_e.length;Qe++){const Ne=_e[Qe];Ne.length&&Qe!==0&&We.push(Ze.length/2);const At=[];let vt,tt;vt=Ne[1].sub(Ne[0])._perp()._unit(),Oe.ringIndices.push(Ne.length-1);for(let Gt=1;Gt<Ne.length;Gt++){const kt=Ne[Gt],It=Ne[Gt===Ne.length-1?1:Gt+1],it=kt.clone();if(he){tt=It.sub(kt)._perp()._unit();const Nt=vt.add(tt)._unit(),ri=he*Math.min(4,1/(vt.x*Nt.x+vt.y*Nt.y));it.x+=ri*Nt.x,it.y+=ri*Nt.y,it.x=Math.round(it.x),it.y=Math.round(it.y),vt=tt}!j||he!==0&&!re||pe(At,it)||At.push(it),kd(this.layoutVertexArray,it.x,it.y,0,0,1,1,0),Be.vertexLength++,this.footprintVertices.emplaceBack(kt.x,kt.y),Ze.push(kt.x,kt.y),P&&Rd(this.layoutVertexExtArray,I.projectTilePoint(it.x,it.y,c),I.upVector(c,it.x,it.y))}j&&(he===0||re)&&(At.length!==0&&pe(At,At[0])&&At.pop(),this.groundEffect.addData(At,Se,T))}const Je=_m(Ze,We);for(let Qe=0;Qe<Je.length;Qe+=3)this.footprintIndices.emplaceBack(Oe.vertexOffset+Je[Qe+0],Oe.vertexOffset+Je[Qe+1],Oe.vertexOffset+Je[Qe+2]),this.indexArray.emplaceBack(Le+Je[Qe],Le+Je[Qe+2],Le+Je[Qe+1]),Be.primitiveLength++;Oe.indexCount+=Je.length,Oe.vertexCount+=this.footprintVertices.length-Oe.vertexOffset}for(let Ze=0;Ze<_e.length;Ze++){const We=_e[Ze];L.startRing(B,We[0]);let Je=We.length>4&&Wv(We[We.length-2],We[0],We[1]),Qe=he?QE(We[We.length-2],We[0],We[1],he):0;const Ne=[];let At,vt,tt;vt=We[1].sub(We[0])._perp()._unit();let Gt=!0;for(let kt=1,It=0;kt<We.length;kt++){let it=We[kt-1],Nt=We[kt];const ri=We[kt===We.length-1?1:kt+1];if(L.appendEdge(B,Nt,it),my(Nt,it,Se)){he&&(vt=ri.sub(Nt)._perp()._unit(),Gt=!Gt);continue}const $t=Nt.sub(it)._perp(),ci=$t.x/(Math.abs($t.x)+Math.abs($t.y)),si=$t.y>0?1:0,gi=it.dist(Nt);if(It+gi>32768&&(It=0),he){tt=ri.sub(Nt)._perp()._unit();let Ci=jv(it,Nt,ri,Uv(vt,tt),he);isNaN(Ci)&&(Ci=0);const Mi=Nt.sub(it)._unit();it=it.add(Mi.mult(Qe))._round(),Nt=Nt.add(Mi.mult(-Ci))._round(),Qe=Ci,vt=tt,j&&this.zoom>=17&&(pe(Ne,it)||Ne.push(it),pe(Ne,Nt)||Ne.push(Nt))}const qt=Be.vertexLength,Hi=We.length>4&&Wv(it,Nt,ri);let Wi=qv(It,Je,Gt);if(kd(this.layoutVertexArray,it.x,it.y,ci,si,0,0,Wi),kd(this.layoutVertexArray,it.x,it.y,ci,si,0,1,Wi),It+=gi,Wi=qv(It,Hi,!Gt),Je=Hi,kd(this.layoutVertexArray,Nt.x,Nt.y,ci,si,0,0,Wi),kd(this.layoutVertexArray,Nt.x,Nt.y,ci,si,0,1,Wi),Be.vertexLength+=4,this.indexArray.emplaceBack(qt+0,qt+1,qt+2),this.indexArray.emplaceBack(qt+1,qt+3,qt+2),Be.primitiveLength+=2,he){const Ci=Le+(kt===1?We.length-2:kt-2),Mi=kt===1?Le:Ci+1;if(this.indexArray.emplaceBack(qt+1,Ci,qt+3),this.indexArray.emplaceBack(Ci,Mi,qt+3),Be.primitiveLength+=2,At===void 0&&(At=qt),!my(ri,We[kt],Se)){const Pi=kt===We.length-1?At:Be.vertexLength;this.indexArray.emplaceBack(qt+2,qt+3,Pi),this.indexArray.emplaceBack(qt+3,Pi+1,Pi),this.indexArray.emplaceBack(qt+3,Mi,Pi+1),Be.primitiveLength+=3}Gt=!Gt}if(P){const Ci=this.layoutVertexExtArray,Mi=I.projectTilePoint(it.x,it.y,c),Pi=I.projectTilePoint(Nt.x,Nt.y,c),sn=I.upVector(c,it.x,it.y),Ji=I.upVector(c,Nt.x,Nt.y);Rd(Ci,Mi,sn),Rd(Ci,Mi,sn),Rd(Ci,Pi,Ji),Rd(Ci,Pi,Ji)}}R&&(Le+=We.length-1),j&&he&&this.zoom>=17&&(Ne.length!==0&&pe(Ne,Ne[0])&&Ne.pop(),this.groundEffect.addData(Ne,Se,T,he>0))}this.footprintSegments.push(Oe),Fe.triangleCount=this.indexArray.length-Fe.triangleArrayOffset,this.polygonSegments.push(Fe),++B.footprintSegLen,++B.polygonSegLen}if(B.vertexCount=this.layoutVertexArray.length-B.vertexArrayOffset,B.groundVertexCount=this.groundEffect.vertexArray.length-B.groundVertexArrayOffset,B.vertexCount!==0){if(B.centroidXY=L.borders?Lv:this.encodeCentroid(L,B),this.centroidData.push(B),L.borders){this.featuresOnBorder.push(L);const _e=this.featuresOnBorder.length-1;for(let Se=0;Se<L.borders.length;Se++)L.borders[Se][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[Se].push(_e)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,h,p,c,v),this.groundEffect.addPaintPropertiesData(e,s,h,p,c,v),this.maxHeight=Math.max(this.maxHeight,G)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort((i,s)=>this.featuresOnBorder[i].borders[e][0]-this.featuresOnBorder[s].borders[e][0])}splitToSubtiles(){const e=[];for(let y=0;y<this.centroidData.length;y++){const v=this.centroidData[y],T=+(v.min.y+v.max.y>pt),E=2*T+(+(v.min.x+v.max.x>pt)^T);for(let I=0;I<v.polygonSegLen;I++){const P=v.polygonSegIdx+I;e.push({centroidIdx:y,subtile:E,polygonSegmentIdx:P,triangleSegmentIdx:this.polygonSegments[P].triangleSegIdx})}}const i=new Kn;e.sort((y,v)=>y.triangleSegmentIdx===v.triangleSegmentIdx?y.subtile-v.subtile:y.triangleSegmentIdx-v.triangleSegmentIdx);let s=0,c=0,h=0;for(const y of e){if(y.triangleSegmentIdx!==s)break;h++}const p=e.length;for(;c!==e.length;){s=e[c].triangleSegmentIdx;let y=0,v=c,T=c;for(let E=v;E<h&&e[E].subtile===y;E++)T++;for(;v!==h;){const E=e[v];y=E.subtile;const I=this.centroidData[E.centroidIdx].min.clone(),P=this.centroidData[E.centroidIdx].max.clone(),R={vertexOffset:this.segments.segments[s].vertexOffset,primitiveOffset:i.length,vertexLength:this.segments.segments[s].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let L=v;L<T;L++){const B=e[L],j=this.polygonSegments[B.polygonSegmentIdx],G=this.centroidData[B.centroidIdx].min,X=this.centroidData[B.centroidIdx].max,ie=this.indexArray.uint16;for(let J=j.triangleArrayOffset;J<j.triangleArrayOffset+j.triangleCount;J++)i.emplaceBack(ie[3*J],ie[3*J+1],ie[3*J+2]);R.primitiveLength+=j.triangleCount,I.x=Math.min(I.x,G.x),I.y=Math.min(I.y,G.y),P.x=Math.max(P.x,X.x),P.y=Math.max(P.y,X.y)}R.primitiveLength>0&&this.triangleSubSegments.push({segment:R,min:I,max:P}),v=T;for(let L=v;L<h&&e[L].subtile===e[v].subtile;L++)T++}c=h;for(let E=c;E<p&&e[E].triangleSegmentIdx===e[c].triangleSegmentIdx;E++)h++}i._trim(),this.indexArray=i}getVisibleSegments(e,i,s){let c=0,h=0;const p=1<<e.canonical.z;if(i){const B=i.getMinMaxForTile(e);B&&(c=B.min,h=B.max)}h+=this.maxHeight;const y=e.toUnwrapped();let v;const T=[y.canonical.x/p+y.wrap,y.canonical.y/p],E=[(y.canonical.x+1)/p+y.wrap,(y.canonical.y+1)/p],I=new kn,P=(B,j,G)=>[B[0]*(1-G[0])+j[0]*G[0],B[1]*(1-G[1])+j[1]*G[1]],R=[],L=[];for(const B of this.triangleSubSegments){R[0]=B.min.x/pt,R[1]=B.min.y/pt,L[0]=B.max.x/pt,L[1]=B.max.y/pt;const j=P(T,E,R),G=P(T,E,L);if(new fn([j[0],j[1],c],[G[0],G[1],h]).intersectsPrecise(s)===0){v&&(I.segments.push(v),v=void 0);continue}const X=B.segment;v&&v.vertexOffset!==X.vertexOffset&&(I.segments.push(v),v=void 0),v?(v.vertexLength+=X.vertexLength,v.primitiveLength+=X.primitiveLength):v={vertexOffset:X.vertexOffset,primitiveLength:X.primitiveLength,vertexLength:X.vertexLength,primitiveOffset:X.primitiveOffset,sortKey:void 0,vaos:{}}}return v&&I.segments.push(v),I}encodeCentroid(e,i){const s=e.centroid(),c=i.span(),h=Math.min(7,Math.round(c.x*this.tileToMeter/10)),p=Math.min(7,Math.round(c.y*this.tileToMeter/10));return new ft(xi(s.x,1,pt-1)<<3|h,xi(s.y,1,pt-1)<<3|p)}encodeBorderCentroid(e){if(!e.borders)return new ft(0,0);const i=e.borders,s=Number.MAX_VALUE;if(i[0][0]!==s||i[1][0]!==s){const c=i[0][0]!==s?0:1;return new ft(6|(i[0][0]!==s?0:65528),(i[c][0]+i[c][1])/2<<3|6)}{const c=i[2][0]!==s?2:3;return new ft((i[c][0]+i[c][1])/2<<3|6,6|(i[2][0]!==s?0:65528))}}showCentroid(e){const i=this.centroidData[e.centroidDataIndex];i.flags&=Za,i.centroidXY.x=0,i.centroidXY.y=0,this.writeCentroidToBuffer(i)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);const i=e.vertexArrayOffset,s=e.vertexCount+e.vertexArrayOffset,c=e.flags&Za?Lv:e.centroidXY,h=this.centroidVertexArray.geta_centroid_pos0(i);if(this.centroidVertexArray.geta_centroid_pos1(i)!==c.y||h!==c.x){for(let p=i;p<s;++p)this.centroidVertexArray.emplace(p,c.x,c.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const s=i.getReplacementRegionsForTile(e.toUnwrapped());if(function(h,p){if(h.length!==p.length)return!1;for(let y=0;y<h.length;y++)if(h[y].sourceId!==p[y].sourceId||!Tv(h[y],p[y]))return!1;return!0}(this.activeReplacements,s))return;if(this.activeReplacements=s,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(const h of this.centroidData)h.flags&=2147483647;const c=[];for(const h of this.activeReplacements){const p=Math.pow(2,h.footprintTileId.canonical.z-e.canonical.z);for(const y of this.centroidData)if(!(y.flags&Za||h.min.x>y.max.x||y.min.x>h.max.x||h.min.y>y.max.y||y.min.y>h.max.y))for(let v=0;v<y.footprintSegLen;v++){const T=this.footprintSegments[y.footprintSegIdx+v];if(c.length=0,XE(this.footprintVertices,T.vertexOffset,T.vertexCount,h.footprintTileId.canonical,e.canonical,c),Ev(h.footprint,c,this.footprintIndices.uint16,T.indexOffset,T.indexCount,-T.vertexOffset,-p)){y.flags|=Za;break}}}for(const h of this.centroidData)this.writeCentroidToBuffer(h);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,i,s){let c=!1;for(let h=0;h<s.footprintSegLen;h++){const p=this.footprintSegments[s.footprintSegIdx+h];let y=0;for(const v of p.ringIndices){for(let T=y,E=v+y-1;T<v+y;E=T++){const I=this.footprintVertices.int16[2*(T+p.vertexOffset)+0],P=this.footprintVertices.int16[2*(T+p.vertexOffset)+1],R=this.footprintVertices.int16[2*(E+p.vertexOffset)+1];P>i!=R>i&&e<(this.footprintVertices.int16[2*(E+p.vertexOffset)+0]-I)*(i-P)/(R-P)+I&&(c=!c)}y=v}}return c}getHeightAtTileCoord(e,i){let s=Number.NEGATIVE_INFINITY,c=!0;const h=4*(e+pt)*pt+(i+pt);if(this.partLookup.hasOwnProperty(h)){const p=this.partLookup[h];return p?{height:p.height,hidden:!!(p.flags&Za)}:void 0}for(const p of this.centroidData)e>p.max.x||p.min.x>e||i>p.max.y||p.min.y>i||this.footprintContainsPoint(e,i,p)&&p&&p.height>s&&(s=p.height,this.partLookup[h]=p,c=!!(p.flags&Za));if(s!==Number.NEGATIVE_INFINITY)return{height:s,hidden:c};this.partLookup[h]=void 0}}function Uv(t,e){const i=t.add(e)._unit();return t.x*i.x+t.y*i.y}function QE(t,e,i,s){const c=e.sub(t)._perp()._unit(),h=i.sub(e)._perp()._unit();return jv(t,e,i,Uv(c,h),s)}function jv(t,e,i,s,c){const h=Math.sqrt(1-s*s);return Math.min(t.dist(e)/3,e.dist(i)/3,c*h/s)}function my(t,e,i){return t.x<i[0].x&&e.x<i[0].x||t.x>i[1].x&&e.x>i[1].x||t.y<i[0].y&&e.y<i[0].y||t.y>i[1].y&&e.y>i[1].y}function Gv(t,e){return t.x<e[0].x||t.x>e[1].x||t.y<e[0].y||t.y>e[1].y}function Wv(t,e,i){if(t.x<0||t.x>=pt||e.x<0||e.x>=pt||i.x<0||i.x>=pt)return!1;const s=i.sub(e),c=s.perp(),h=t.sub(e);return(s.x*h.x+s.y*h.y)/Math.sqrt((s.x*s.x+s.y*s.y)*(h.x*h.x+h.y*h.y))>-.866&&c.x*h.x+c.y*h.y<0}function qv(t,e,i){const s=e?2|t:-3&t;return i?1|s:-2&s}function Hv(){const t=Math.PI/32,e=Math.tan(t),i=Ru;return i*Math.sqrt(1+2*e*e)-i}function Zv(t,e,i){const s=1<<i.z,c=is(i.x/s),h=is((i.x+1)/s),p=xr(i.y/s),y=xr((i.y+1)/s);return function(v,T,E,I,P=0,R){const L=[];if(!v.length||!E||!I)return L;const B=(re,pe)=>{for(const _e of re)L.push({polygon:_e,bounds:pe})},j=Math.ceil(Math.log2(E)),G=Math.ceil(Math.log2(I)),X=j-G,ie=[];for(let re=0;re<Math.abs(X);re++)ie.push(X>0?0:1);for(let re=0;re<Math.min(j,G);re++)ie.push(0),ie.push(1);let J=v;if(J=xm(J,T[0].y-P,T[1].y+P,1),J=xm(J,T[0].x-P,T[1].x+P,0),!J.length)return L;const he=[];for(ie.length?he.push({polygons:J,bounds:T,depth:0}):B(J,T);he.length;){const re=he.pop(),pe=re.depth,_e=ie[pe],Se=re.bounds[0],Le=re.bounds[1],Ce=_e===0?Se.x:Se.y,Be=_e===0?Le.x:Le.y,Fe=R?R(_e,Ce,Be):.5*(Ce+Be),Oe=xm(re.polygons,Ce-P,Fe+P,_e),Ze=xm(re.polygons,Fe-P,Be+P,_e);if(Oe.length){const We=[Se,new ft(_e===0?Fe:Le.x,_e===1?Fe:Le.y)];ie.length>pe+1?he.push({polygons:Oe,bounds:We,depth:pe+1}):B(Oe,We)}if(Ze.length){const We=[new ft(_e===0?Fe:Se.x,_e===1?Fe:Se.y),Le];ie.length>pe+1?he.push({polygons:Ze,bounds:We,depth:pe+1}):B(Ze,We)}}return L}(t,e,Math.ceil((h-c)/11.25),Math.ceil((p-y)/11.25),1,(v,T,E)=>{if(v===0)return .5*(T+E);{const I=xr((i.y+T/pt)/s);return(Ko(.5*(xr((i.y+E/pt)/s)+I))*s-i.y)*pt}})}function XE(t,e,i,s,c,h){const p=Math.pow(2,s.z-c.z);for(let y=0;y<i;y++){let v=t.int16[2*(y+e)+0],T=t.int16[2*(y+e)+1];v=(v+c.x*pt)*p-s.x*pt,T=(T+c.y*pt)*p-s.y*pt,h.push(new ft(v,T))}}Mt(Tm,"FillExtrusionBucket",{omit:["layers","features"]}),Mt(Fv,"PartData"),Mt(Ov,"FootprintSegment"),Mt(Bv,"BorderCentroidData"),Mt(Vv,"GroundEffect");const KE=new we({visibility:new ge(ae["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new ge(ae["layout_fill-extrusion"]["fill-extrusion-edge-radius"])});var JE={paint:new we({"fill-extrusion-opacity":new ge(ae["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Ae(ae["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new ge(ae["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new ge(ae["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Ae(ae["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Ae(ae["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Ae(ae["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new ge(ae["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new ge(ae["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new ge(ae["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new ge(ae["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new ge(ae["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new ge(ae["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new ge(ae["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new ge(ae["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new Ae(ae["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new Ae(ae["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new ge(ae["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new ge(ae["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new ge(ae["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new ge(ae["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new ge(ae["paint_fill-extrusion"]["fill-extrusion-emissive-strength"])}),layout:KE};class Nu extends ft{constructor(e,i,s){super(e,i),this.z=s}}function zd(t,e){return t.x*e.x+t.y*e.y}function $v(t,e){if(t.length===1){let i=0;const s=e[i++];let c;for(;!c||s.equals(c);)if(c=e[i++],!c)return 1/0;for(;i<e.length;i++){const h=e[i],p=t[0],y=c.sub(s),v=h.sub(s),T=p.sub(s),E=zd(y,y),I=zd(y,v),P=zd(v,v),R=zd(T,y),L=zd(T,v),B=E*P-I*I,j=(P*R-I*L)/B,G=(E*L-I*R)/B,X=s.z*(1-j-G)+c.z*j+h.z*G;if(isFinite(X))return X}return 1/0}{let i=1/0;for(const s of e)i=Math.min(i,s.z);return i}}function Yv(t,e,i,s,c,h,p,y){const v=p*c.getElevationAt(t,e,!0,!0),T=h[0]!==0,E=T?h[1]===0?p*(h[0]/7-450):p*function(I,P,R){const L=Math.floor(P[0]/8),B=Math.floor(P[1]/8),j=10*(P[0]-8*L),G=10*(P[1]-8*B),X=I.getElevationAt(L,B,!0,!0),ie=I.getMeterToDEM(R),J=Math.floor(.5*(j*ie-1)),he=Math.floor(.5*(G*ie-1)),re=I.tileCoordToPixel(L,B),pe=2*J+1,_e=2*he+1,Se=function(Ze,We,Je,Qe,Ne){return[Ze.getElevationAtPixel(We,Je,!0),Ze.getElevationAtPixel(We+Ne,Je,!0),Ze.getElevationAtPixel(We,Je+Ne,!0),Ze.getElevationAtPixel(We+Qe,Je+Ne,!0)]}(I,re.x-J,re.y-he,pe,_e),Le=Math.abs(Se[0]-Se[1]),Ce=Math.abs(Se[2]-Se[3]),Be=Math.abs(Se[0]-Se[2])+Math.abs(Se[1]-Se[3]),Fe=Math.min(.25,.5*ie*(Le+Ce)/pe),Oe=Math.min(.25,.5*ie*Be/_e);return X+Math.max(Fe*j,Oe*G)}(c,h,y):v;return{base:v+(i===0)?-1:i,top:T?Math.max(E+s,v+i+2):v+s}}const eA=ni([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:tA}=eA,iA=ni([{name:"a_packed",components:4,type:"Float32"}]),{members:nA}=iA,rA=ni([{name:"a_pattern_data",components:2,type:"Float32"}]),{members:sA}=rA;class Qv{constructor(e,i){this.width=e,this.height=i,this.nextRow=0,this.image=new qa({width:e,height:i}),this.positions={},this.uploaded=!1}getDash(e,i){const s=this.getKey(e,i);return this.positions[s]}trim(){const e=this.width,i=this.height=Ih(this.nextRow);this.image.resize({width:e,height:i})}getKey(e,i){return e.join(",")+i}getDashRanges(e,i,s){const c=[];let h=e.length%2==1?-e[e.length-1]*s:0,p=e[0]*s,y=!0;c.push({left:h,right:p,isDash:y,zeroLength:e[0]===0});let v=e[0];for(let T=1;T<e.length;T++){y=!y;const E=e[T];h=v*s,v+=E,p=v*s,c.push({left:h,right:p,isDash:y,zeroLength:E===0})}return c}addRoundDash(e,i,s){const c=i/2;for(let h=-s;h<=s;h++){const p=this.width*(this.nextRow+s+h);let y=0,v=e[y];for(let T=0;T<this.width;T++){T/v.right>1&&(v=e[++y]);const E=Math.abs(T-v.left),I=Math.abs(T-v.right),P=Math.min(E,I);let R;const L=h/s*(c+1);if(v.isDash){const B=c-Math.abs(L);R=Math.sqrt(P*P+B*B)}else R=c-Math.sqrt(P*P+L*L);this.image.data[p+T]=Math.max(0,Math.min(255,R+128))}}}addRegularDash(e,i){for(let v=e.length-1;v>=0;--v){const T=e[v],E=e[v+1];T.zeroLength?e.splice(v,1):E&&E.isDash===T.isDash&&(E.left=T.left,e.splice(v,1))}const s=e[0],c=e[e.length-1];s.isDash===c.isDash&&(s.left=c.left-this.width,c.right=s.right+this.width);const h=this.width*this.nextRow;let p=0,y=e[p];for(let v=0;v<this.width;v++){v/y.right>1&&(y=e[++p]);const T=Math.abs(v-y.left),E=Math.abs(v-y.right),I=Math.min(T,E);this.image.data[h+v]=Math.max(0,Math.min(255,(y.isDash?I:-I)+i+128))}}addDash(e,i){const s=this.getKey(e,i);if(this.positions[s])return this.positions[s];const c=i==="round",h=c?7:0,p=2*h+1;if(this.nextRow+p>this.height)return wn("LineAtlas out of space"),null;e.length===0&&e.push(1);let y=0;for(let E=0;E<e.length;E++)e[E]<0&&(wn("Negative value is found in line dasharray, replacing values with 0"),e[E]=0),y+=e[E];if(y!==0){const E=this.width/y,I=this.getDashRanges(e,this.width,E);c?this.addRoundDash(I,E,h):this.addRegularDash(I,i==="square"?.5*E:0)}const v=this.nextRow+h;this.nextRow+=p;const T={tl:[v,h],br:[y,0]};return this.positions[s]=T,T}}Mt(Qv,"LineAtlas");const oA=ym.types,aA=Math.cos(Math.PI/180*37.5),lA=Math.cos(Math.PI/180*5);class _y{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(i=>{this.gradients[i.id]={}}),this.layoutVertexArray=new Tr,this.layoutVertexArray2=new Xn,this.patternVertexArray=new cr,this.indexArray=new Kn,this.programConfigurations=new Va(e.layers,e.zoom),this.segments=new kn,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id)}populate(e,i,s,c){this.hasPattern=hy("line",this.layers,i);const h=this.layers[0].layout.get("line-sort-key"),p=[];for(const{feature:E,id:I,index:P,sourceLayerIndex:R}of e){const L=this.layers[0]._featureFilter.needGeometry,B=Ga(E,L);if(!this.layers[0]._featureFilter.filter(new Y(this.zoom),B,s))continue;const j=h?h.evaluate(B,{},s):void 0,G={id:I,properties:E.properties,type:E.type,sourceLayerIndex:R,index:P,geometry:L?B.geometry:Jo(E,s,c),patterns:{},sortKey:j};p.push(G)}h&&p.sort((E,I)=>E.sortKey-I.sortKey);const{lineAtlas:y,featureIndex:v}=i,T=this.addConstantDashes(y);for(const E of p){const{geometry:I,index:P,sourceLayerIndex:R}=E;if(T&&this.addFeatureDashes(E,y),this.hasPattern){const L=dy("line",this.layers,E,this.zoom,i);this.patternFeatures.push(L)}else this.addFeature(E,I,P,s,y.positions,i.availableImages,i.brightness);v.insert(e[P].feature,I,P,R,this.index)}}addConstantDashes(e){let i=!1;for(const s of this.layers){const c=s.paint.get("line-dasharray").value,h=s.layout.get("line-cap").value;if(c.kind!=="constant"||h.kind!=="constant")i=!0;else{const p=h.value,y=c.value;if(!y)continue;e.addDash(y,p)}}return i}addFeatureDashes(e,i){const s=this.zoom;for(const c of this.layers){const h=c.paint.get("line-dasharray").value,p=c.layout.get("line-cap").value;if(h.kind==="constant"&&p.kind==="constant")continue;let y,v;if(h.kind==="constant"){if(y=h.value,!y)continue}else y=h.evaluate({zoom:s},e);v=p.kind==="constant"?p.value:p.evaluate({zoom:s},e),i.addDash(y,v),e.patterns[c.id]=i.getKey(y,v)}}update(e,i,s,c,h){const p=Object.keys(e).length!==0;p&&!this.stateDependentLayers.length||this.programConfigurations.updatePaintArrays(e,i,p?this.stateDependentLayers:this.layers,s,c,h)}addFeatures(e,i,s,c,h,p){for(const y of this.patternFeatures)this.addFeature(y,y.geometry,y.index,i,s,c,p)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,nA)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,sA)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,tA),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&e.properties.hasOwnProperty("mapbox_clip_start")&&e.properties.hasOwnProperty("mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,i,s,c,h,p,y){const v=this.layers[0].layout,T=v.get("line-join").evaluate(e,{}),E=v.get("line-cap").evaluate(e,{}),I=v.get("line-miter-limit"),P=v.get("line-round-limit");this.lineClips=this.lineFeatureClips(e);for(const R of i)this.addLine(R,e,T,E,I,P);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,h,p,c,y)}addLine(e,i,s,c,h,p){this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0;const y=s==="none";if(this.patternJoinNone=this.hasPattern&&y,this.segmentStart=0,this.segmentPoints=[],this.lineClips){this.lineClipsArray.push(this.lineClips);for(let X=0;X<e.length-1;X++)this.totalDistance+=e[X].dist(e[X+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const v=oA[i.type]==="Polygon";let T=e.length;for(;T>=2&&e[T-1].equals(e[T-2]);)T--;let E=0;for(;E<T-1&&e[E].equals(e[E+1]);)E++;if(T<(v?3:2))return;s==="bevel"&&(h=1.05);const I=this.overscaling<=16?15*pt/(512*this.overscaling):0,P=this.segments.prepareSegment(10*T,this.layoutVertexArray,this.indexArray);let R,L,B,j,G;this.e1=this.e2=-1,v&&(R=e[T-2],G=e[E].sub(R)._unit()._perp());for(let X=E;X<T;X++){if(B=X===T-1?v?e[E+1]:void 0:e[X+1],B&&e[X].equals(B))continue;G&&(j=G),R&&(L=R),R=e[X],G=B?B.sub(R)._unit()._perp():j,j=j||G;const ie=L&&B;let J=ie?s:v||y?"butt":c;const he=j.x*G.x+j.y*G.y;if(y){const Be=function(Fe){if(Fe.patternJoinNone){const Oe=Fe.segmentPoints.length/2,Ze=Fe.lineSoFar-Fe.segmentStart;for(let We=0;We<Oe;++We){const Je=Fe.segmentPoints[2*We+1],Qe=Math.round(Fe.segmentPoints[2*We])+.5+.25*Je;Fe.patternVertexArray.emplaceBack(Qe,Ze),Fe.patternVertexArray.emplaceBack(Qe,Ze)}Fe.segmentPoints=[],Fe.segmentStart=Fe.lineSoFar}Fe.e1=Fe.e2=-1};if(ie&&he<lA){this.updateDistance(L,R),this.addCurrentVertex(R,j,1,1,P),Be(this),this.addCurrentVertex(R,G,-1,-1,P);continue}if(L){if(!B){this.updateDistance(L,R),this.addCurrentVertex(R,j,1,1,P),Be(this);continue}J="miter"}}let re=j.add(G);re.x===0&&re.y===0||re._unit();const pe=re.x*G.x+re.y*G.y,_e=pe!==0?1/pe:1/0,Se=2*Math.sqrt(2-2*pe),Le=pe<aA&&L&&B,Ce=j.x*G.y-j.y*G.x>0;if(Le&&X>E){const Be=R.dist(L);if(Be>2*I){const Fe=R.sub(R.sub(L)._mult(I/Be)._round());this.updateDistance(L,Fe),this.addCurrentVertex(Fe,j,0,0,P),L=Fe}}if(ie&&J==="round"&&(_e<p?J="miter":_e<=2&&(J="fakeround")),J==="miter"&&_e>h&&(J="bevel"),J==="bevel"&&(_e>2&&(J="flipbevel"),_e<h&&(J="miter")),L&&this.updateDistance(L,R),J==="miter")re._mult(_e),this.addCurrentVertex(R,re,0,0,P);else if(J==="flipbevel"){if(_e>100)re=G.mult(-1);else{const Be=_e*j.add(G).mag()/j.sub(G).mag();re._perp()._mult(Be*(Ce?-1:1))}this.addCurrentVertex(R,re,0,0,P),this.addCurrentVertex(R,re.mult(-1),0,0,P)}else if(J==="bevel"||J==="fakeround"){const Be=-Math.sqrt(_e*_e-1),Fe=Ce?Be:0,Oe=Ce?0:Be;if(L&&this.addCurrentVertex(R,j,Fe,Oe,P),J==="fakeround"){const Ze=Math.round(180*Se/Math.PI/20);for(let We=1;We<Ze;We++){let Je=We/Ze;if(Je!==.5){const Ne=Je-.5;Je+=Je*Ne*(Je-1)*((1.0904+he*(he*(3.55645-1.43519*he)-3.2452))*Ne*Ne+(.848013+he*(.215638*he-1.06021)))}const Qe=G.sub(j)._mult(Je)._add(j)._unit()._mult(Ce?-1:1);this.addHalfVertex(R,Qe.x,Qe.y,!1,Ce,0,P)}}B&&this.addCurrentVertex(R,G,-Fe,-Oe,P)}else J==="butt"?this.addCurrentVertex(R,re,0,0,P):J==="square"?(L||this.addCurrentVertex(R,re,-1,-1,P),this.addCurrentVertex(R,re,0,0,P),L&&this.addCurrentVertex(R,re,1,1,P)):J==="round"&&(L&&(this.addCurrentVertex(R,j,0,0,P),this.addCurrentVertex(R,j,1,1,P,!0)),B&&(this.addCurrentVertex(R,G,-1,-1,P,!0),this.addCurrentVertex(R,G,0,0,P)));if(Le&&X<T-1){const Be=R.dist(B);if(Be>2*I){const Fe=R.add(B.sub(R)._mult(I/Be)._round());this.updateDistance(R,Fe),this.addCurrentVertex(Fe,G,0,0,P),R=Fe}}}}addCurrentVertex(e,i,s,c,h,p=!1){const y=i.y*c-i.x,v=-i.y-i.x*c;this.addHalfVertex(e,i.x+i.y*s,i.y-i.x*s,p,!1,s,h),this.addHalfVertex(e,y,v,p,!0,-c,h),this.patternJoinNone&&this.segmentPoints.push(this.lineSoFar-this.segmentStart,s)}addHalfVertex({x:e,y:i},s,c,h,p,y,v){this.layoutVertexArray.emplaceBack((e<<1)+(h?1:0),(i<<1)+(p?1:0),Math.round(63*s)+128,Math.round(63*c)+128,1+(y===0?0:y<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineClips.start,this.lineClips.end);const T=v.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,T),v.primitiveLength++),p?this.e2=T:this.e1=T}updateScaledDistance(){if(this.lineClips){const e=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=e*this.lineClips.start+this.distance}else this.lineSoFar=this.distance}updateDistance(e,i){this.distance+=e.dist(i),this.updateScaledDistance()}}Mt(_y,"LineBucket",{omit:["layers","patternFeatures"]});const cA=new we({"line-cap":new Ae(ae.layout_line["line-cap"]),"line-join":new Ae(ae.layout_line["line-join"]),"line-miter-limit":new ge(ae.layout_line["line-miter-limit"]),"line-round-limit":new ge(ae.layout_line["line-round-limit"]),"line-sort-key":new Ae(ae.layout_line["line-sort-key"]),visibility:new ge(ae.layout_line.visibility)});var Xv={paint:new we({"line-opacity":new Ae(ae.paint_line["line-opacity"]),"line-color":new Ae(ae.paint_line["line-color"]),"line-translate":new ge(ae.paint_line["line-translate"]),"line-translate-anchor":new ge(ae.paint_line["line-translate-anchor"]),"line-width":new Ae(ae.paint_line["line-width"]),"line-gap-width":new Ae(ae.paint_line["line-gap-width"]),"line-offset":new Ae(ae.paint_line["line-offset"]),"line-blur":new Ae(ae.paint_line["line-blur"]),"line-dasharray":new Ae(ae.paint_line["line-dasharray"]),"line-pattern":new Ae(ae.paint_line["line-pattern"]),"line-gradient":new Ye(ae.paint_line["line-gradient"]),"line-trim-offset":new ge(ae.paint_line["line-trim-offset"]),"line-emissive-strength":new ge(ae.paint_line["line-emissive-strength"]),"line-border-width":new Ae(ae.paint_line["line-border-width"]),"line-border-color":new Ae(ae.paint_line["line-border-color"])}),layout:cA};function Kv(t,e,i){return e*(pt/(t.tileSize*Math.pow(2,i-t.tileID.overscaledZ)))}function Jv(t,e){return 1/Kv(t,1,e.tileZoom)}function eb(t,e,i,s){return t.translatePosMatrix(s||e.tileID.projMatrix,e,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"))}const tb=t=>{const e=[];ib(t)&&e.push("RENDER_LINE_DASH"),t.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");const i=t.paint.get("line-trim-offset");i[0]===0&&i[1]===0||e.push("RENDER_LINE_TRIM_OFFSET"),t.paint.get("line-border-width").constantOr(1)!==0&&e.push("RENDER_LINE_BORDER");const s=t.layout.get("line-join").constantOr("miter")==="none",c=!!t.paint.get("line-pattern").constantOr(1);return s&&c&&e.push("LINE_JOIN_NONE"),e};function ib(t){const e=t.paint.get("line-dasharray").value;return e.value||e.kind!=="constant"}const nb=new class extends Ae{possiblyEvaluate(t,e){return e=new Y(Math.floor(e.zoom),{now:e.now,fadeDuration:e.fadeDuration,transition:e.transition}),super.possiblyEvaluate(t,e)}evaluate(t,e,i,s){return e=Jr({},e,{zoom:Math.floor(e.zoom)}),super.evaluate(t,e,i,s)}}(Xv.paint.properties["line-width"].specification);function rb(t,e){return e>0?e+2*t:t}nb.useIntegerZoom=!0;const uA=ni([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),hA=ni([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),dA=ni([{name:"a_projected_pos",components:4,type:"Float32"}],4);ni([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const fA=ni([{name:"a_z_offset",components:1,type:"Float32"}],4),pA=ni([{name:"a_texb",components:2,type:"Uint16"}]),mA=ni([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),_A=ni([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_z_offset",components:1,type:"Float32"}]);ni([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const sb=ni([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),gA=ni([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);ni([{name:"triangle",components:3,type:"Uint16"}]),ni([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),ni([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"}]),ni([{type:"Float32",name:"offsetX"}]),ni([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var vr=24;const eo=128;function gy(t,e){const{expression:i}=e;if(i.kind==="constant")return{kind:"constant",layoutSize:i.evaluate(new Y(t+1))};if(i.kind==="source")return{kind:"source"};{const{zoomStops:s,interpolationType:c}=i;let h=0;for(;h<s.length&&s[h]<=t;)h++;h=Math.max(0,h-1);let p=h;for(;p<s.length&&s[p]<t+1;)p++;p=Math.min(s.length-1,p);const y=s[h],v=s[p];return i.kind==="composite"?{kind:"composite",minZoom:y,maxZoom:v,interpolationType:c}:{kind:"camera",minZoom:y,maxZoom:v,minSize:i.evaluate(new Y(y)),maxSize:i.evaluate(new Y(v)),interpolationType:c}}}function Mm(t,{uSize:e,uSizeT:i},{lowerSize:s,upperSize:c}){return t.kind==="source"?s/eo:t.kind==="composite"?hi(s/eo,c/eo,i):e}function Vu(t,e){let i=0,s=0;if(t.kind==="constant")s=t.layoutSize;else if(t.kind!=="source"){const{interpolationType:c,minZoom:h,maxZoom:p}=t,y=c?xi(Xr.interpolationFactor(c,e,h,p),0,1):0;t.kind==="camera"?s=hi(t.minSize,t.maxSize,y):i=y}return{uSizeT:i,uSize:s}}var yA=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:eo,evaluateSizeForFeature:Mm,evaluateSizeForZoom:Vu,getSizeData:gy});function xA(t,e,i){return t.sections.forEach(s=>{s.text=function(c,h,p){const y=h.layout.get("text-transform").evaluate(p,{});return y==="uppercase"?c=c.toLocaleUpperCase():y==="lowercase"&&(c=c.toLocaleLowerCase()),le.applyArabicShaping&&(c=le.applyArabicShaping(c)),c}(s.text,e,i)}),t}const Ld={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};function vA(t){return t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""}function bA(t){return t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""||t===""}var wA={read:function(t,e,i,s,c){var h,p,y=8*c-s-1,v=(1<<y)-1,T=v>>1,E=-7,I=i?c-1:0,P=i?-1:1,R=t[e+I];for(I+=P,h=R&(1<<-E)-1,R>>=-E,E+=y;E>0;h=256*h+t[e+I],I+=P,E-=8);for(p=h&(1<<-E)-1,h>>=-E,E+=s;E>0;p=256*p+t[e+I],I+=P,E-=8);if(h===0)h=1-T;else{if(h===v)return p?NaN:1/0*(R?-1:1);p+=Math.pow(2,s),h-=T}return(R?-1:1)*p*Math.pow(2,h-s)},write:function(t,e,i,s,c,h){var p,y,v,T=8*h-c-1,E=(1<<T)-1,I=E>>1,P=c===23?Math.pow(2,-24)-Math.pow(2,-77):0,R=s?0:h-1,L=s?1:-1,B=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(y=isNaN(e)?1:0,p=E):(p=Math.floor(Math.log(e)/Math.LN2),e*(v=Math.pow(2,-p))<1&&(p--,v*=2),(e+=p+I>=1?P/v:P*Math.pow(2,1-I))*v>=2&&(p++,v/=2),p+I>=E?(y=0,p=E):p+I>=1?(y=(e*v-1)*Math.pow(2,c),p+=I):(y=e*Math.pow(2,I-1)*Math.pow(2,c),p=0));c>=8;t[i+R]=255&y,R+=L,y/=256,c-=8);for(p=p<<c|y,T+=c;T>0;t[i+R]=255&p,R+=L,p/=256,T-=8);t[i+R-L]|=128*B}},ob=pn,Sm=wA;function pn(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}pn.Varint=0,pn.Fixed64=1,pn.Bytes=2,pn.Fixed32=5;var yy=4294967296,ab=1/yy,lb=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function ta(t){return t.type===pn.Bytes?t.readVarint()+t.pos:t.pos+1}function Uu(t,e,i){return i?4294967296*e+(t>>>0):4294967296*(e>>>0)+(t>>>0)}function cb(t,e,i){var s=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));i.realloc(s);for(var c=i.pos-1;c>=t;c--)i.buf[c+s]=i.buf[c]}function TA(t,e){for(var i=0;i<t.length;i++)e.writeVarint(t[i])}function MA(t,e){for(var i=0;i<t.length;i++)e.writeSVarint(t[i])}function SA(t,e){for(var i=0;i<t.length;i++)e.writeFloat(t[i])}function EA(t,e){for(var i=0;i<t.length;i++)e.writeDouble(t[i])}function AA(t,e){for(var i=0;i<t.length;i++)e.writeBoolean(t[i])}function IA(t,e){for(var i=0;i<t.length;i++)e.writeFixed32(t[i])}function CA(t,e){for(var i=0;i<t.length;i++)e.writeSFixed32(t[i])}function PA(t,e){for(var i=0;i<t.length;i++)e.writeFixed64(t[i])}function DA(t,e){for(var i=0;i<t.length;i++)e.writeSFixed64(t[i])}function Em(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+16777216*t[e+3]}function ju(t,e,i){t[i]=e,t[i+1]=e>>>8,t[i+2]=e>>>16,t[i+3]=e>>>24}function ub(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+(t[e+3]<<24)}pn.prototype={destroy:function(){this.buf=null},readFields:function(t,e,i){for(i=i||this.length;this.pos<i;){var s=this.readVarint(),c=s>>3,h=this.pos;this.type=7&s,t(c,e,this),this.pos===h&&this.skip(s)}return e},readMessage:function(t,e){return this.readFields(t,e,this.readVarint()+this.pos)},readFixed32:function(){var t=Em(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=ub(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=Em(this.buf,this.pos)+Em(this.buf,this.pos+4)*yy;return this.pos+=8,t},readSFixed64:function(){var t=Em(this.buf,this.pos)+ub(this.buf,this.pos+4)*yy;return this.pos+=8,t},readFloat:function(){var t=Sm.read(this.buf,this.pos,!0,23,4);return this.pos+=4,t},readDouble:function(){var t=Sm.read(this.buf,this.pos,!0,52,8);return this.pos+=8,t},readVarint:function(t){var e,i,s=this.buf;return e=127&(i=s[this.pos++]),i<128?e:(e|=(127&(i=s[this.pos++]))<<7,i<128?e:(e|=(127&(i=s[this.pos++]))<<14,i<128?e:(e|=(127&(i=s[this.pos++]))<<21,i<128?e:function(c,h,p){var y,v,T=p.buf;if(y=(112&(v=T[p.pos++]))>>4,v<128||(y|=(127&(v=T[p.pos++]))<<3,v<128)||(y|=(127&(v=T[p.pos++]))<<10,v<128)||(y|=(127&(v=T[p.pos++]))<<17,v<128)||(y|=(127&(v=T[p.pos++]))<<24,v<128)||(y|=(1&(v=T[p.pos++]))<<31,v<128))return Uu(c,y,h);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(i=s[this.pos]))<<28,t,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2==1?(t+1)/-2:t/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=12&&lb?function(i,s,c){return lb.decode(i.subarray(s,c))}(this.buf,e,t):function(i,s,c){for(var h="",p=s;p<c;){var y,v,T,E=i[p],I=null,P=E>239?4:E>223?3:E>191?2:1;if(p+P>c)break;P===1?E<128&&(I=E):P===2?(192&(y=i[p+1]))==128&&(I=(31&E)<<6|63&y)<=127&&(I=null):P===3?(v=i[p+2],(192&(y=i[p+1]))==128&&(192&v)==128&&((I=(15&E)<<12|(63&y)<<6|63&v)<=2047||I>=55296&&I<=57343)&&(I=null)):P===4&&(v=i[p+2],T=i[p+3],(192&(y=i[p+1]))==128&&(192&v)==128&&(192&T)==128&&((I=(15&E)<<18|(63&y)<<12|(63&v)<<6|63&T)<=65535||I>=1114112)&&(I=null)),I===null?(I=65533,P=1):I>65535&&(I-=65536,h+=String.fromCharCode(I>>>10&1023|55296),I=56320|1023&I),h+=String.fromCharCode(I),p+=P}return h}(this.buf,e,t)},readBytes:function(){var t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e},readPackedVarint:function(t,e){if(this.type!==pn.Bytes)return t.push(this.readVarint(e));var i=ta(this);for(t=t||[];this.pos<i;)t.push(this.readVarint(e));return t},readPackedSVarint:function(t){if(this.type!==pn.Bytes)return t.push(this.readSVarint());var e=ta(this);for(t=t||[];this.pos<e;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){if(this.type!==pn.Bytes)return t.push(this.readBoolean());var e=ta(this);for(t=t||[];this.pos<e;)t.push(this.readBoolean());return t},readPackedFloat:function(t){if(this.type!==pn.Bytes)return t.push(this.readFloat());var e=ta(this);for(t=t||[];this.pos<e;)t.push(this.readFloat());return t},readPackedDouble:function(t){if(this.type!==pn.Bytes)return t.push(this.readDouble());var e=ta(this);for(t=t||[];this.pos<e;)t.push(this.readDouble());return t},readPackedFixed32:function(t){if(this.type!==pn.Bytes)return t.push(this.readFixed32());var e=ta(this);for(t=t||[];this.pos<e;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){if(this.type!==pn.Bytes)return t.push(this.readSFixed32());var e=ta(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){if(this.type!==pn.Bytes)return t.push(this.readFixed64());var e=ta(this);for(t=t||[];this.pos<e;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){if(this.type!==pn.Bytes)return t.push(this.readSFixed64());var e=ta(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed64());return t},skip:function(t){var e=7&t;if(e===pn.Varint)for(;this.buf[this.pos++]>127;);else if(e===pn.Bytes)this.pos=this.readVarint()+this.pos;else if(e===pn.Fixed32)this.pos+=4;else{if(e!==pn.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8}},writeTag:function(t,e){this.writeVarint(t<<3|e)},realloc:function(t){for(var e=this.length||16;e<this.pos+t;)e*=2;if(e!==this.length){var i=new Uint8Array(e);i.set(this.buf),this.buf=i,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),ju(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),ju(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),ju(this.buf,-1&t,this.pos),ju(this.buf,Math.floor(t*ab),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),ju(this.buf,-1&t,this.pos),ju(this.buf,Math.floor(t*ab),this.pos+4),this.pos+=8},writeVarint:function(t){(t=+t||0)>268435455||t<0?function(e,i){var s,c;if(e>=0?(s=e%4294967296|0,c=e/4294967296|0):(c=~(-e/4294967296),4294967295^(s=~(-e%4294967296))?s=s+1|0:(s=0,c=c+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");i.realloc(10),function(h,p,y){y.buf[y.pos++]=127&h|128,h>>>=7,y.buf[y.pos++]=127&h|128,h>>>=7,y.buf[y.pos++]=127&h|128,h>>>=7,y.buf[y.pos++]=127&h|128,y.buf[y.pos]=127&(h>>>=7)}(s,0,i),function(h,p){var y=(7&h)<<4;p.buf[p.pos++]|=y|((h>>>=3)?128:0),h&&(p.buf[p.pos++]=127&h|((h>>>=7)?128:0),h&&(p.buf[p.pos++]=127&h|((h>>>=7)?128:0),h&&(p.buf[p.pos++]=127&h|((h>>>=7)?128:0),h&&(p.buf[p.pos++]=127&h|((h>>>=7)?128:0),h&&(p.buf[p.pos++]=127&h)))))}(c,i)}(t,this):(this.realloc(4),this.buf[this.pos++]=127&t|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=t>>>7&127))))},writeSVarint:function(t){this.writeVarint(t<0?2*-t-1:2*t)},writeBoolean:function(t){this.writeVarint(!!t)},writeString:function(t){t=String(t),this.realloc(4*t.length),this.pos++;var e=this.pos;this.pos=function(s,c,h){for(var p,y,v=0;v<c.length;v++){if((p=c.charCodeAt(v))>55295&&p<57344){if(!y){p>56319||v+1===c.length?(s[h++]=239,s[h++]=191,s[h++]=189):y=p;continue}if(p<56320){s[h++]=239,s[h++]=191,s[h++]=189,y=p;continue}p=y-55296<<10|p-56320|65536,y=null}else y&&(s[h++]=239,s[h++]=191,s[h++]=189,y=null);p<128?s[h++]=p:(p<2048?s[h++]=p>>6|192:(p<65536?s[h++]=p>>12|224:(s[h++]=p>>18|240,s[h++]=p>>12&63|128),s[h++]=p>>6&63|128),s[h++]=63&p|128)}return h}(this.buf,t,this.pos);var i=this.pos-e;i>=128&&cb(e,i,this),this.pos=e-1,this.writeVarint(i),this.pos+=i},writeFloat:function(t){this.realloc(4),Sm.write(this.buf,t,this.pos,!0,23,4),this.pos+=4},writeDouble:function(t){this.realloc(8),Sm.write(this.buf,t,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var e=t.length;this.writeVarint(e),this.realloc(e);for(var i=0;i<e;i++)this.buf[this.pos++]=t[i]},writeRawMessage:function(t,e){this.pos++;var i=this.pos;t(e,this);var s=this.pos-i;s>=128&&cb(i,s,this),this.pos=i-1,this.writeVarint(s),this.pos+=s},writeMessage:function(t,e,i){this.writeTag(t,pn.Bytes),this.writeRawMessage(e,i)},writePackedVarint:function(t,e){e.length&&this.writeMessage(t,TA,e)},writePackedSVarint:function(t,e){e.length&&this.writeMessage(t,MA,e)},writePackedBoolean:function(t,e){e.length&&this.writeMessage(t,AA,e)},writePackedFloat:function(t,e){e.length&&this.writeMessage(t,SA,e)},writePackedDouble:function(t,e){e.length&&this.writeMessage(t,EA,e)},writePackedFixed32:function(t,e){e.length&&this.writeMessage(t,IA,e)},writePackedSFixed32:function(t,e){e.length&&this.writeMessage(t,CA,e)},writePackedFixed64:function(t,e){e.length&&this.writeMessage(t,PA,e)},writePackedSFixed64:function(t,e){e.length&&this.writeMessage(t,DA,e)},writeBytesField:function(t,e){this.writeTag(t,pn.Bytes),this.writeBytes(e)},writeFixed32Field:function(t,e){this.writeTag(t,pn.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(t,e){this.writeTag(t,pn.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(t,e){this.writeTag(t,pn.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(t,e){this.writeTag(t,pn.Fixed64),this.writeSFixed64(e)},writeVarintField:function(t,e){this.writeTag(t,pn.Varint),this.writeVarint(e)},writeSVarintField:function(t,e){this.writeTag(t,pn.Varint),this.writeSVarint(e)},writeStringField:function(t,e){this.writeTag(t,pn.Bytes),this.writeString(e)},writeFloatField:function(t,e){this.writeTag(t,pn.Fixed32),this.writeFloat(e)},writeDoubleField:function(t,e){this.writeTag(t,pn.Fixed64),this.writeDouble(e)},writeBooleanField:function(t,e){this.writeVarintField(t,!!e)}};var Gu=Ee(ob);const xy=3;function kA(t,e,i){e.glyphs=[],t===1&&i.readMessage(RA,e)}function RA(t,e,i){if(t===3){const{id:s,bitmap:c,width:h,height:p,left:y,top:v,advance:T}=i.readMessage(zA,{});e.glyphs.push({id:s,bitmap:new qa({width:h+2*xy,height:p+2*xy},c),metrics:{width:h,height:p,left:y,top:v,advance:T}})}else t===4?e.ascender=i.readSVarint():t===5&&(e.descender=i.readSVarint())}function zA(t,e,i){t===1?e.id=i.readVarint():t===2?e.bitmap=i.readBytes():t===3?e.width=i.readVarint():t===4?e.height=i.readVarint():t===5?e.left=i.readSVarint():t===6?e.top=i.readSVarint():t===7&&(e.advance=i.readVarint())}const hb=xy,Ms={horizontal:1,vertical:2,horizontalOnly:3};class Od{constructor(){this.scale=1,this.fontStack="",this.imageName=null}static forText(e,i){const s=new Od;return s.scale=e||1,s.fontStack=i,s}static forImage(e){const i=new Od;return i.imageName=e,i}}class Wu{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,i){const s=new Wu;for(let c=0;c<e.sections.length;c++){const h=e.sections[c];h.image?s.addImageSection(h):s.addTextSection(h,i)}return s}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=function(i,s){let c="";for(let h=0;h<i.length;h++){const p=i.charCodeAt(h+1)||null,y=i.charCodeAt(h-1)||null;c+=!s&&(p&&w(p)&&!Ld[i[h+1]]||y&&w(y)&&!Ld[i[h-1]])||!Ld[i[h]]?i[h]:Ld[i[h]]}return c}(this.text,e)}trim(){let e=0;for(let s=0;s<this.text.length&&Am[this.text.charCodeAt(s)];s++)e++;let i=this.text.length;for(let s=this.text.length-1;s>=0&&s>=e&&Am[this.text.charCodeAt(s)];s--)i--;this.text=this.text.substring(e,i),this.sectionIndex=this.sectionIndex.slice(e,i)}substring(e,i){const s=new Wu;return s.text=this.text.substring(e,i),s.sectionIndex=this.sectionIndex.slice(e,i),s.sections=this.sections,s}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,i)=>Math.max(e,this.sections[i].scale),0)}addTextSection(e,i){this.text+=e.text,this.sections.push(Od.forText(e.scale,e.fontStack||i));const s=this.sections.length-1;for(let c=0;c<e.text.length;++c)this.sectionIndex.push(s)}addImageSection(e){const i=e.image?e.image.namePrimary:"";if(i.length===0)return void wn("Can't add FormattedSection with an empty image.");const s=this.getNextImageSectionCharCode();s?(this.text+=String.fromCodePoint(s),this.sections.push(Od.forImage(i)),this.sectionIndex.push(this.sections.length-1)):wn("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function vy(t,e,i,s,c,h,p,y,v,T,E,I,P,R,L){const B=Wu.fromFeature(t,c);I===Ms.vertical&&B.verticalizePunctuation(P);let j=[];const G=function(re,pe,_e,Se,Le,Ce){if(!re)return[];const Be=[],Fe=function(Je,Qe,Ne,At,vt,tt){let Gt=0;for(let kt=0;kt<Je.length();kt++){const It=Je.getSection(kt);Gt+=db(Je.getCodePoint(kt),It,At,vt,Qe,tt)}return Gt/Math.max(1,Math.ceil(Gt/Ne))}(re,pe,_e,Se,Le,Ce),Oe=re.text.indexOf("")>=0;let Ze=0;for(let Je=0;Je<re.length();Je++){const Qe=re.getSection(Je),Ne=re.getCodePoint(Je);if(Am[Ne]||(Ze+=db(Ne,Qe,Se,Le,pe,Ce)),Je<re.length()-1){const At=!((We=Ne)<11904||!(n["Bopomofo Extended"](We)||n.Bopomofo(We)||n["CJK Compatibility Forms"](We)||n["CJK Compatibility Ideographs"](We)||n["CJK Compatibility"](We)||n["CJK Radicals Supplement"](We)||n["CJK Strokes"](We)||n["CJK Symbols and Punctuation"](We)||n["CJK Unified Ideographs Extension A"](We)||n["CJK Unified Ideographs"](We)||n["Enclosed CJK Letters and Months"](We)||n["Halfwidth and Fullwidth Forms"](We)||n.Hiragana(We)||n["Ideographic Description Characters"](We)||n["Kangxi Radicals"](We)||n["Katakana Phonetic Extensions"](We)||n.Katakana(We)||n["Vertical Forms"](We)||n["Yi Radicals"](We)||n["Yi Syllables"](We)));(LA[Ne]||At||Qe.imageName)&&Be.push(pb(Je+1,Ze,Fe,Be,OA(Ne,re.getCodePoint(Je+1),At&&Oe),!1))}}var We;return mb(pb(re.length(),Ze,Fe,Be,0,!0))}(B,T,h,e,s,R),{processBidirectionalText:X,processStyledBidirectionalText:ie}=le;if(X&&B.sections.length===1){const re=X(B.toString(),G);for(const pe of re){const _e=new Wu;_e.text=pe,_e.sections=B.sections;for(let Se=0;Se<pe.length;Se++)_e.sectionIndex.push(0);j.push(_e)}}else if(ie){const re=ie(B.text,B.sectionIndex,G);for(const pe of re){const _e=new Wu;_e.text=pe[0],_e.sectionIndex=pe[1],_e.sections=B.sections,j.push(_e)}}else j=function(re,pe){const _e=[],Se=re.text;let Le=0;for(const Ce of pe)_e.push(re.substring(Le,Ce)),Le=Ce;return Le<Se.length&&_e.push(re.substring(Le,Se.length)),_e}(B,G);const J=[],he={positionedLines:J,text:B.toString(),top:E[1],bottom:E[1],left:E[0],right:E[0],writingMode:I,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(re,pe,_e,Se,Le,Ce,Be,Fe,Oe,Ze,We,Je){let Qe=0,Ne=0,At=0;const vt=Fe==="right"?1:Fe==="left"?0:.5;let tt=!1;for(const ri of Le){const $t=ri.getSections();for(const ci of $t){if(ci.imageName)continue;const si=pe[ci.fontStack];if(si&&(tt=si.ascender!==void 0&&si.descender!==void 0,!tt))break}if(!tt)break}let Gt=0;for(const ri of Le){ri.trim();const $t=ri.getMaxScale(),ci=($t-1)*vr,si={positionedGlyphs:[],lineOffset:0};re.positionedLines[Gt]=si;const gi=si.positionedGlyphs;let qt=0;if(!ri.length()){Ne+=Ce,++Gt;continue}let Hi=0,Wi=0;for(let Mi=0;Mi<ri.length();Mi++){const Pi=ri.getSection(Mi),sn=ri.getSectionIndex(Mi),Ji=ri.getCodePoint(Mi);let Tn=Pi.scale,xn=null,Er=null,In=null,mn=vr,Wn=0;const hr=!(Oe===Ms.horizontal||!We&&!x(Ji)||We&&(Am[Ji]||(kt=Ji,n.Arabic(kt)||n["Arabic Supplement"](kt)||n["Arabic Extended-A"](kt)||n["Arabic Presentation Forms-A"](kt)||n["Arabic Presentation Forms-B"](kt))));if(Pi.imageName){const dr=Se[Pi.imageName];if(!dr)continue;In=Pi.imageName,re.iconsInText=re.iconsInText||!0,Er=dr.paddedRect;const nn=dr.displaySize;Tn=Tn*vr/Je,xn={width:nn[0],height:nn[1],left:0,top:-hb,advance:hr?nn[1]:nn[0],localGlyph:!1},Wn=tt?-xn.height*Tn:$t*vr-17-nn[1]*Tn,mn=xn.advance;const jr=(hr?nn[0]:nn[1])*Tn-vr*$t;jr>0&&jr>qt&&(qt=jr)}else{const dr=_e[Pi.fontStack];if(!dr)continue;dr[Ji]&&(Er=dr[Ji]);const nn=pe[Pi.fontStack];if(!nn)continue;const jr=nn.glyphs[Ji];if(!jr)continue;if(xn=jr.metrics,mn=Ji!==8203?vr:0,tt){const na=nn.ascender!==void 0?Math.abs(nn.ascender):0,Us=nn.descender!==void 0?Math.abs(nn.descender):0,oo=(na+Us)*Tn;Hi<oo&&(Hi=oo,Wi=(na-Us)/2*Tn),Wn=-na*Tn}else Wn=($t-Tn)*vr-17}hr?(re.verticalizable=!0,gi.push({glyph:Ji,imageName:In,x:Qe,y:Ne+Wn,vertical:hr,scale:Tn,localGlyph:xn.localGlyph,fontStack:Pi.fontStack,sectionIndex:sn,metrics:xn,rect:Er}),Qe+=mn*Tn+Ze):(gi.push({glyph:Ji,imageName:In,x:Qe,y:Ne+Wn,vertical:hr,scale:Tn,localGlyph:xn.localGlyph,fontStack:Pi.fontStack,sectionIndex:sn,metrics:xn,rect:Er}),Qe+=xn.advance*Tn+Ze)}gi.length!==0&&(At=Math.max(Qe-Ze,At),tt?_b(gi,vt,qt,Wi,Ce*$t/2):_b(gi,vt,qt,0,Ce/2)),Qe=0;const Ci=Ce*$t+qt;si.lineOffset=Math.max(qt,ci),Ne+=Ci,++Gt}var kt;const It=Ne,{horizontalAlign:it,verticalAlign:Nt}=by(Be);(function(ri,$t,ci,si,gi,qt){const Hi=($t-ci)*gi,Wi=-qt*si;for(const Ci of ri)for(const Mi of Ci.positionedGlyphs)Mi.x+=Hi,Mi.y+=Wi})(re.positionedLines,vt,it,Nt,At,It),re.top+=-Nt*It,re.bottom=re.top+It,re.left+=-it*At,re.right=re.left+At,re.hasBaseline=tt}(he,e,i,s,j,p,y,v,I,T,P,L),!function(re){for(const pe of re)if(pe.positionedGlyphs.length!==0)return!1;return!0}(J)&&he}const Am={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},LA={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function db(t,e,i,s,c,h){if(e.imageName){const p=s[e.imageName];return p?p.displaySize[0]*e.scale*vr/h+c:0}{const p=i[e.fontStack],y=p&&p.glyphs[t];return y?y.metrics.advance*e.scale+c:0}}function fb(t,e,i,s){const c=Math.pow(t-e,2);return s?t<e?c/2:2*c:c+Math.abs(i)*i}function OA(t,e,i){let s=0;return t===10&&(s-=1e4),i&&(s+=150),t!==40&&t!==65288||(s+=50),e!==41&&e!==65289||(s+=50),s}function pb(t,e,i,s,c,h){let p=null,y=fb(e,i,c,h);for(const v of s){const T=fb(e-v.x,i,c,h)+v.badness;T<=y&&(p=v,y=T)}return{index:t,x:e,priorBreak:p,badness:y}}function mb(t){return t?mb(t.priorBreak).concat(t.index):[]}function by(t){let e=.5,i=.5;switch(t){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(t){case"bottom":case"bottom-right":case"bottom-left":i=1;break;case"top":case"top-right":case"top-left":i=0}return{horizontalAlign:e,verticalAlign:i}}function _b(t,e,i,s,c){if(!(e||i||s||c))return;const h=t.length-1,p=t[h],y=(p.x+p.metrics.advance*p.scale)*e;for(let v=0;v<=h;v++)t[v].x-=y,t[v].y+=i+s+c}function FA(t,e,i,s){const{horizontalAlign:c,verticalAlign:h}=by(s),p=i[0]-t.displaySize[0]*c,y=i[1]-t.displaySize[1]*h;return{imagePrimary:t,imageSecondary:e,top:y,bottom:y+t.displaySize[1],left:p,right:p+t.displaySize[0]}}function gb(t,e,i,s,c,h){const p=t.imagePrimary;let y;if(p.content){const j=p.content,G=p.pixelRatio||1;y=[j[0]/G,j[1]/G,p.displaySize[0]-j[2]/G,p.displaySize[1]-j[3]/G]}const v=e.left*h,T=e.right*h;let E,I,P,R;i==="width"||i==="both"?(R=c[0]+v-s[3],I=c[0]+T+s[1]):(R=c[0]+(v+T-p.displaySize[0])/2,I=R+p.displaySize[0]);const L=e.top*h,B=e.bottom*h;return i==="height"||i==="both"?(E=c[1]+L-s[0],P=c[1]+B+s[2]):(E=c[1]+(L+B-p.displaySize[1])/2,P=E+p.displaySize[1]),{imagePrimary:p,imageSecondary:void 0,top:E,right:I,bottom:P,left:R,collisionPadding:y}}class ia extends ft{constructor(e,i,s,c,h){super(e,i),this.angle=c,this.z=s,h!==void 0&&(this.segment=h)}clone(){return new ia(this.x,this.y,this.z,this.angle,this.segment)}}function yb(t,e,i,s,c){if(e.segment===void 0)return!0;let h=e,p=e.segment+1,y=0;for(;y>-i/2;){if(p--,p<0)return!1;y-=t[p].dist(h),h=t[p]}y+=t[p].dist(t[p+1]),p++;const v=[];let T=0;for(;y<i/2;){const E=t[p],I=t[p+1];if(!I)return!1;let P=t[p-1].angleTo(E)-E.angleTo(I);for(P=Math.abs((P+3*Math.PI)%(2*Math.PI)-Math.PI),v.push({distance:y,angleDelta:P}),T+=P;y-v[0].distance>s;)T-=v.shift().angleDelta;if(T>c)return!1;p++,y+=E.dist(I)}return!0}function xb(t){let e=0;for(let i=0;i<t.length-1;i++)e+=t[i].dist(t[i+1]);return e}function vb(t,e,i){return t?.6*e*i:0}function bb(t,e){return Math.max(t?t.right-t.left:0,e?e.right-e.left:0)}function BA(t,e,i,s,c,h){const p=vb(i,c,h),y=bb(i,s)*h;let v=0;const T=xb(t)/2;for(let E=0;E<t.length-1;E++){const I=t[E],P=t[E+1],R=I.dist(P);if(v+R>T){const L=(T-v)/R,B=hi(I.x,P.x,L),j=hi(I.y,P.y,L),G=new ia(B,j,0,P.angleTo(I),E);return!p||yb(t,G,y,p,e)?G:void 0}v+=R}}function NA(t,e,i,s,c,h,p,y,v){const T=vb(s,h,p),E=bb(s,c),I=E*p,P=t[0].x===0||t[0].x===v||t[0].y===0||t[0].y===v;return e-I<e/4&&(e=I+e/4),wb(t,P?e/2*y%e:(E/2+2*h)*p*y%e,e,T,i,I,P,!1,v)}function wb(t,e,i,s,c,h,p,y,v){const T=h/2,E=xb(t);let I=0,P=e-i,R=[];for(let L=0;L<t.length-1;L++){const B=t[L],j=t[L+1],G=B.dist(j),X=j.angleTo(B);for(;P+i<I+G;){P+=i;const ie=(P-I)/G,J=hi(B.x,j.x,ie),he=hi(B.y,j.y,ie);if(J>=0&&J<v&&he>=0&&he<v&&P-T>=0&&P+T<=E){const re=new ia(J,he,0,X,L);s&&!yb(t,re,h,s,c)||R.push(re)}}I+=G}return y||R.length||p||(R=wb(t,I/2,i,s,c,h,p,!0,v)),R}function Tb(t,e,i,s,c){const h=[];for(let p=0;p<t.length;p++){const y=t[p];let v;for(let T=0;T<y.length-1;T++){let E=y[T],I=y[T+1];E.x<e&&I.x<e||(E.x<e?E=new ft(e,E.y+(e-E.x)/(I.x-E.x)*(I.y-E.y))._round():I.x<e&&(I=new ft(e,E.y+(e-E.x)/(I.x-E.x)*(I.y-E.y))._round()),E.y<i&&I.y<i||(E.y<i?E=new ft(E.x+(i-E.y)/(I.y-E.y)*(I.x-E.x),i)._round():I.y<i&&(I=new ft(E.x+(i-E.y)/(I.y-E.y)*(I.x-E.x),i)._round()),E.x>=s&&I.x>=s||(E.x>=s?E=new ft(s,E.y+(s-E.x)/(I.x-E.x)*(I.y-E.y))._round():I.x>=s&&(I=new ft(s,E.y+(s-E.x)/(I.x-E.x)*(I.y-E.y))._round()),E.y>=c&&I.y>=c||(E.y>=c?E=new ft(E.x+(c-E.y)/(I.y-E.y)*(I.x-E.x),c)._round():I.y>=c&&(I=new ft(E.x+(c-E.y)/(I.y-E.y)*(I.x-E.x),c)._round()),v&&E.equals(v[v.length-1])||(v=[E],h.push(v)),v.push(I)))))}}return h}function Mb(t){let e=0,i=0;for(const p of t)e+=p.w*p.h,i=Math.max(i,p.w);t.sort((p,y)=>y.h-p.h);const s=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),i),h:1/0}];let c=0,h=0;for(const p of t)for(let y=s.length-1;y>=0;y--){const v=s[y];if(!(p.w>v.w||p.h>v.h)){if(p.x=v.x,p.y=v.y,h=Math.max(h,p.y+p.h),c=Math.max(c,p.x+p.w),p.w===v.w&&p.h===v.h){const T=s.pop();y<s.length&&(s[y]=T)}else p.h===v.h?(v.x+=p.w,v.w-=p.w):p.w===v.w?(v.y+=p.h,v.h-=p.h):(s.push({x:v.x+p.w,y:v.y,w:v.w-p.w,h:p.h}),v.y+=p.h,v.h-=p.h);break}}return{w:c,h,fill:e/(c*h)||0}}Mt(ia,"Anchor");const ns=1;class wy{constructor(e,{pixelRatio:i,version:s,stretchX:c,stretchY:h,content:p}){this.paddedRect=e,this.pixelRatio=i,this.stretchX=c,this.stretchY=h,this.content=p,this.version=s}get tl(){return[this.paddedRect.x+ns,this.paddedRect.y+ns]}get br(){return[this.paddedRect.x+this.paddedRect.w-ns,this.paddedRect.y+this.paddedRect.h-ns]}get displaySize(){return[(this.paddedRect.w-2*ns)/this.pixelRatio,(this.paddedRect.h-2*ns)/this.pixelRatio]}}class Sb{constructor(e,i){const s={},c={};this.haveRenderCallbacks=[];const h=[];this.addImages(e,s,h),this.addImages(i,c,h);const{w:p,h:y}=Mb(h),v=new Ts({width:p||1,height:y||1});for(const T in e){const E=e[T],I=s[T].paddedRect;Ts.copy(E.data,v,{x:0,y:0},{x:I.x+ns,y:I.y+ns},E.data,E.sdf)}for(const T in i){const E=i[T],I=c[T].paddedRect,P=I.x+ns,R=I.y+ns,L=E.data.width,B=E.data.height;Ts.copy(E.data,v,{x:0,y:0},{x:P,y:R},E.data),Ts.copy(E.data,v,{x:0,y:B-1},{x:P,y:R-1},{width:L,height:1}),Ts.copy(E.data,v,{x:0,y:0},{x:P,y:R+B},{width:L,height:1}),Ts.copy(E.data,v,{x:L-1,y:0},{x:P-1,y:R},{width:1,height:B}),Ts.copy(E.data,v,{x:0,y:0},{x:P+L,y:R},{width:1,height:B})}this.image=v,this.iconPositions=s,this.patternPositions=c}addImages(e,i,s){for(const c in e){const h=e[c],p={x:0,y:0,w:h.data.width+2*ns,h:h.data.height+2*ns};s.push(p),i[c]=new wy(p,h),h.hasRenderCallback&&this.haveRenderCallbacks.push(c)}}patchUpdatedImages(e,i,s){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(c=>e.hasImage(c,s)),e.dispatchRenderCallbacks(this.haveRenderCallbacks,s);for(const c in e.getUpdatedImages(s))this.patchUpdatedImage(this.iconPositions[c],e.getImage(c,s),i),this.patchUpdatedImage(this.patternPositions[c],e.getImage(c,s),i)}patchUpdatedImage(e,i,s){if(!e||!i||e.version===i.version)return;e.version=i.version;const[c,h]=e.tl,p=!!Object.keys(this.patternPositions).length;s.update(i.data,{useMipmap:p},{x:c,y:h})}}Mt(wy,"ImagePosition"),Mt(Sb,"ImageAtlas");const Fd=1e20;function Eb(t,e,i,s,c,h,p,y,v){for(let T=e;T<e+s;T++)Ab(t,i*h+T,h,c,p,y,v);for(let T=i;T<i+c;T++)Ab(t,T*h+e,1,s,p,y,v)}function Ab(t,e,i,s,c,h,p){h[0]=0,p[0]=-Fd,p[1]=Fd,c[0]=t[e];for(let y=1,v=0,T=0;y<s;y++){c[y]=t[e+y*i];const E=y*y;do{const I=h[v];T=(c[y]-c[I]+E-I*I)/(y-I)/2}while(T<=p[v]&&--v>-1);v++,h[v]=y,p[v]=T,p[v+1]=Fd}for(let y=0,v=0;y<s;y++){for(;p[v+1]<y;)v++;const T=h[v],E=y-T;t[e+y*i]=c[T]+E*E}}const to=2,Ty={none:0,ideographs:1,all:2};class qu{constructor(e,i,s){this.requestManager=e,this.localGlyphMode=i,this.localFontFamily=s,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e,i){this.urls[i]=e}getGlyphs(e,i,s){const c=[],h=this.urls[i]||N.GLYPHS_URL;for(const p in e)for(const y of e[p])c.push({stack:p,id:y});Ah(c,({stack:p,id:y},v)=>{let T=this.entries[p];T||(T=this.entries[p]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let E=T.glyphs[y];if(E!==void 0)return void v(null,{stack:p,id:y,glyph:E});if(E=this._tinySDF(T,p,y),E)return T.glyphs[y]=E,void v(null,{stack:p,id:y,glyph:E});const I=Math.floor(y/256);if(256*I>65535)return void v(new Error("glyphs > 65535 not supported"));if(T.ranges[I])return void v(null,{stack:p,id:y,glyph:E});let P=T.requests[I];P||(P=T.requests[I]=[],qu.loadGlyphRange(p,I,h,this.requestManager,(R,L)=>{if(L){T.ascender=L.ascender,T.descender=L.descender;for(const B in L.glyphs)this._doesCharSupportLocalGlyph(+B)||(T.glyphs[+B]=L.glyphs[+B]);T.ranges[I]=!0}for(const B of P)B(R,L);delete T.requests[I]})),P.push((R,L)=>{R?v(R):L&&v(null,{stack:p,id:y,glyph:L.glyphs[y]||null})})},(p,y)=>{if(p)s(p);else if(y){const v={};for(const{stack:T,id:E,glyph:I}of y)v[T]===void 0&&(v[T]={}),v[T].glyphs===void 0&&(v[T].glyphs={}),v[T].glyphs[E]=I&&{id:I.id,bitmap:I.bitmap.clone(),metrics:I.metrics},v[T].ascender=this.entries[T].ascender,v[T].descender=this.entries[T].descender;s(null,v)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==Ty.none&&(this.localGlyphMode===Ty.all?!!this.localFontFamily:!!this.localFontFamily&&(n["CJK Unified Ideographs"](e)||n["Hangul Syllables"](e)||n.Hiragana(e)||n.Katakana(e)||n["CJK Symbols and Punctuation"](e)||n["CJK Unified Ideographs Extension A"](e)||n["CJK Unified Ideographs Extension B"](e)))}_tinySDF(e,i,s){const c=this.localFontFamily;if(!c||!this._doesCharSupportLocalGlyph(s))return;let h=e.tinySDF;if(!h){let B="400";/bold/i.test(i)?B="900":/medium/i.test(i)?B="500":/light/i.test(i)&&(B="200"),h=e.tinySDF=new qu.TinySDF({fontFamily:c,fontWeight:B,fontSize:24*to,buffer:3*to,radius:8*to}),h.fontWeight=B}if(this.localGlyphs[h.fontWeight][s])return this.localGlyphs[h.fontWeight][s];const p=String.fromCodePoint(s),{data:y,width:v,height:T,glyphWidth:E,glyphHeight:I,glyphLeft:P,glyphTop:R,glyphAdvance:L}=h.draw(p);return this.localGlyphs[h.fontWeight][s]={id:s,bitmap:new qa({width:v,height:T},y),metrics:{width:E/to,height:I/to,left:P/to,top:R/to-27,advance:L/to,localGlyph:!0}}}}qu.loadGlyphRange=function(t,e,i,s,c){const h=256*e,p=h+255,y=s.transformRequest(s.normalizeGlyphsURL(i).replace("{fontstack}",t).replace("{range}",`${h}-${p}`),$c.Glyphs);bl(y,(v,T)=>{if(v)c(v);else if(T){const E={},I=function(P){return new Gu(P).readFields(kA,{})}(T);for(const P of I.glyphs)E[P.id]=P;c(null,{glyphs:E,ascender:I.ascender,descender:I.descender})}})},qu.TinySDF=class{constructor({fontSize:t=24,buffer:e=3,radius:i=8,cutoff:s=.25,fontFamily:c="sans-serif",fontWeight:h="normal",fontStyle:p="normal"}={}){this.buffer=e,this.cutoff=s,this.radius=i;const y=this.size=t+4*e,v=this._createCanvas(y),T=this.ctx=v.getContext("2d",{willReadFrequently:!0});T.font=`${p} ${h} ${t}px ${c}`,T.textBaseline="alphabetic",T.textAlign="left",T.fillStyle="black",this.gridOuter=new Float64Array(y*y),this.gridInner=new Float64Array(y*y),this.f=new Float64Array(y),this.z=new Float64Array(y+1),this.v=new Uint16Array(y)}_createCanvas(t){const e=document.createElement("canvas");return e.width=e.height=t,e}draw(t){const{width:e,actualBoundingBoxAscent:i,actualBoundingBoxDescent:s,actualBoundingBoxLeft:c,actualBoundingBoxRight:h}=this.ctx.measureText(t),p=Math.ceil(i),y=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(h-c))),v=Math.min(this.size-this.buffer,p+Math.ceil(s)),T=y+2*this.buffer,E=v+2*this.buffer,I=Math.max(T*E,0),P=new Uint8ClampedArray(I),R={data:P,width:T,height:E,glyphWidth:y,glyphHeight:v,glyphTop:p,glyphLeft:0,glyphAdvance:e};if(y===0||v===0)return R;const{ctx:L,buffer:B,gridInner:j,gridOuter:G}=this;L.clearRect(B,B,y,v),L.fillText(t,B,B+p);const X=L.getImageData(B,B,y,v);G.fill(Fd,0,I),j.fill(0,0,I);for(let ie=0;ie<v;ie++)for(let J=0;J<y;J++){const he=X.data[4*(ie*y+J)+3]/255;if(he===0)continue;const re=(ie+B)*T+J+B;if(he===1)G[re]=0,j[re]=Fd;else{const pe=.5-he;G[re]=pe>0?pe*pe:0,j[re]=pe<0?pe*pe:0}}Eb(G,0,0,T,E,T,this.f,this.v,this.z),Eb(j,B,B,y,v,T,this.f,this.v,this.z);for(let ie=0;ie<I;ie++){const J=Math.sqrt(G[ie])-Math.sqrt(j[ie]);P[ie]=Math.round(255-255*(J/this.radius+this.cutoff))}return R}};const $a=ns;function Ib(t,e,i,s){const c=[],h=t.imagePrimary,p=h.pixelRatio,y=h.paddedRect.w-2*$a,v=h.paddedRect.h-2*$a,T=t.right-t.left,E=t.bottom-t.top,I=h.stretchX||[[0,y]],P=h.stretchY||[[0,v]],R=(Ce,Be)=>Ce+Be[1]-Be[0],L=I.reduce(R,0),B=P.reduce(R,0),j=y-L,G=v-B;let X=0,ie=L,J=0,he=B,re=0,pe=j,_e=0,Se=G;if(h.content&&s){const Ce=h.content;X=Im(I,0,Ce[0]),J=Im(P,0,Ce[1]),ie=Im(I,Ce[0],Ce[2]),he=Im(P,Ce[1],Ce[3]),re=Ce[0]-X,_e=Ce[1]-J,pe=Ce[2]-Ce[0]-ie,Se=Ce[3]-Ce[1]-he}const Le=(Ce,Be,Fe,Oe)=>{const Ze=Cm(Ce.stretch-X,ie,T,t.left),We=Pm(Ce.fixed-re,pe,Ce.stretch,L),Je=Cm(Be.stretch-J,he,E,t.top),Qe=Pm(Be.fixed-_e,Se,Be.stretch,B),Ne=Cm(Fe.stretch-X,ie,T,t.left),At=Pm(Fe.fixed-re,pe,Fe.stretch,L),vt=Cm(Oe.stretch-J,he,E,t.top),tt=Pm(Oe.fixed-_e,Se,Oe.stretch,B),Gt=new ft(Ze,Je),kt=new ft(Ne,Je),It=new ft(Ne,vt),it=new ft(Ze,vt),Nt=new ft(We/p,Qe/p),ri=new ft(At/p,tt/p),$t=e*Math.PI/180;if($t){const Wi=Math.sin($t),Ci=Math.cos($t),Mi=[Ci,-Wi,Wi,Ci];Gt._matMult(Mi),kt._matMult(Mi),it._matMult(Mi),It._matMult(Mi)}const ci=Ce.stretch+Ce.fixed,si=Fe.stretch+Fe.fixed,gi=Be.stretch+Be.fixed,qt=Oe.stretch+Oe.fixed,Hi=t.imageSecondary;return{tl:Gt,tr:kt,bl:it,br:It,texPrimary:{x:h.paddedRect.x+$a+ci,y:h.paddedRect.y+$a+gi,w:si-ci,h:qt-gi},texSecondary:Hi?{x:Hi.paddedRect.x+$a+ci,y:Hi.paddedRect.y+$a+gi,w:si-ci,h:qt-gi}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Nt,pixelOffsetBR:ri,minFontScaleX:pe/p/T,minFontScaleY:Se/p/E,isSDF:i}};if(s&&(h.stretchX||h.stretchY)){const Ce=Cb(I,j,L),Be=Cb(P,G,B);for(let Fe=0;Fe<Ce.length-1;Fe++){const Oe=Ce[Fe],Ze=Ce[Fe+1];for(let We=0;We<Be.length-1;We++)c.push(Le(Oe,Be[We],Ze,Be[We+1]))}}else c.push(Le({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:y+1},{fixed:0,stretch:v+1}));return c}function Im(t,e,i){let s=0;for(const c of t)s+=Math.max(e,Math.min(i,c[1]))-Math.max(e,Math.min(i,c[0]));return s}function Cb(t,e,i){const s=[{fixed:-$a,stretch:0}];for(const[c,h]of t){const p=s[s.length-1];s.push({fixed:c-p.stretch,stretch:p.stretch}),s.push({fixed:c-p.stretch,stretch:p.stretch+(h-c)})}return s.push({fixed:e+$a,stretch:i}),s}function Cm(t,e,i,s){return t/e*i+s}function Pm(t,e,i,s){return t-e*i/s}function VA(t,e,i,s){const c=e+t.positionedLines[s].lineOffset;return s===0?i+c/2:i+(c+(e+t.positionedLines[s-1].lineOffset))/2}function UA(t,e=1,i=!1){let s=1/0,c=1/0,h=-1/0,p=-1/0;const y=t[0];for(let R=0;R<y.length;R++){const L=y[R];(!R||L.x<s)&&(s=L.x),(!R||L.y<c)&&(c=L.y),(!R||L.x>h)&&(h=L.x),(!R||L.y>p)&&(p=L.y)}const v=Math.min(h-s,p-c);let T=v/2;const E=new hu([],jA);if(v===0)return new ft(s,c);for(let R=s;R<h;R+=v)for(let L=c;L<p;L+=v)E.push(new Hu(R+T,L+T,T,t));let I=function(R){let L=0,B=0,j=0;const G=R[0];for(let X=0,ie=G.length,J=ie-1;X<ie;J=X++){const he=G[X],re=G[J],pe=he.x*re.y-re.x*he.y;B+=(he.x+re.x)*pe,j+=(he.y+re.y)*pe,L+=3*pe}return new Hu(B/L,j/L,0,R)}(t),P=E.length;for(;E.length;){const R=E.pop();(R.d>I.d||!I.d)&&(I=R,i&&console.log("found best %d after %d probes",Math.round(1e4*R.d)/1e4,P)),R.max-I.d<=e||(T=R.h/2,E.push(new Hu(R.p.x-T,R.p.y-T,T,t)),E.push(new Hu(R.p.x+T,R.p.y-T,T,t)),E.push(new Hu(R.p.x-T,R.p.y+T,T,t)),E.push(new Hu(R.p.x+T,R.p.y+T,T,t)),P+=4)}return i&&(console.log(`num probes: ${P}`),console.log(`best distance: ${I.d}`)),I.p}function jA(t,e){return e.max-t.max}class Hu{constructor(e,i,s,c){this.p=new ft(e,i),this.h=s,this.d=function(h,p){let y=!1,v=1/0;for(let T=0;T<p.length;T++){const E=p[T];for(let I=0,P=E.length,R=P-1;I<P;R=I++){const L=E[I],B=E[R];L.y>h.y!=B.y>h.y&&h.x<(B.x-L.x)*(h.y-L.y)/(B.y-L.y)+L.x&&(y=!y),v=Math.min(v,Hx(h,L,B))}}return(y?1:-1)*Math.sqrt(v)}(this.p,c),this.max=this.d+this.h*Math.SQRT2}}const My=Number.POSITIVE_INFINITY,GA=Math.sqrt(2);function Pb(t,[e,i]){let s=0,c=0;if(i===My){e<0&&(e=0);const h=e/GA;switch(t){case"top-right":case"top-left":c=h-7;break;case"bottom-right":case"bottom-left":c=7-h;break;case"bottom":c=7-e;break;case"top":c=e-7}switch(t){case"top-right":case"bottom-right":s=-h;break;case"top-left":case"bottom-left":s=h;break;case"left":s=e;break;case"right":s=-e}}else{switch(e=Math.abs(e),i=Math.abs(i),t){case"top-right":case"top-left":case"top":c=i-7;break;case"bottom-right":case"bottom-left":case"bottom":c=7-i}switch(t){case"top-right":case"bottom-right":case"right":s=-e;break;case"top-left":case"bottom-left":case"left":s=e}}return[s,c]}function Sy(t){switch(t){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function WA(t,e,i,s,c,h,p,y,v,T,E,I,P,R,L){let B=h.textMaxSize.evaluate(e,{},I);B===void 0&&(B=p);const j=t.layers[0].layout,G=j.get("icon-offset").evaluate(e,{},I),X=kb(i.horizontal)||i.vertical,ie=P.name==="globe",J=vr,he=p/J,re=t.tilePixelRatio*B/J,pe=(Ze=t.overscaling,t.zoom>18&&Ze>2&&(Ze>>=1),Math.max(pt/(512*Ze),1)*j.get("symbol-spacing")),_e=j.get("text-padding")*t.tilePixelRatio,Se=j.get("icon-padding")*t.tilePixelRatio,Le=Si(j.get("text-max-angle")),Ce=j.get("text-rotation-alignment")==="map"&&j.get("symbol-placement")!=="point",Be=j.get("icon-rotation-alignment")==="map"&&j.get("symbol-placement")!=="point",Fe=j.get("symbol-placement"),Oe=pe/2;var Ze;const We=j.get("icon-text-fit").evaluate(e,{},I),Je=j.get("icon-text-fit-padding").evaluate(e,{},I),Qe=We!=="none";let Ne;t.hasAnyIconTextFit===!1&&Qe&&(t.hasAnyIconTextFit=!0),s&&Qe&&(t.allowVerticalPlacement&&i.vertical&&(Ne=gb(s,i.vertical,We,Je,G,he)),X&&(s=gb(s,X,We,Je,G,he)));const At=(vt,tt,Gt)=>{if(tt.x<0||tt.x>=pt||tt.y<0||tt.y>=pt)return;let kt=null;if(ie){const{x:It,y:it,z:Nt}=P.projectTilePoint(tt.x,tt.y,Gt);kt={anchor:new ia(It,it,Nt,0,void 0),up:P.upVector(Gt,tt.x,tt.y)}}(function(It,it,Nt,ri,$t,ci,si,gi,qt,Hi,Wi,Ci,Mi,Pi,sn,Ji,Tn,xn,Er,In,mn,Wn,hr,dr,nn,jr,na){const Us=It.addToLineVertexArray(it,ri);let oo,el,tl,fc,z1,L1,O1,F1=0,B1=0,N1=0,V1=0,$y=-1,Yy=-1;const So={};let U1=Sl("");const pc=Nt?Nt.anchor:it,Qy=qt.layout.get("icon-text-fit").evaluate(mn,{},nn)!=="none";let Xy=0,Ky=0;if(qt._unevaluatedLayout.getValue("text-radial-offset")===void 0?[Xy,Ky]=qt.layout.get("text-offset").evaluate(mn,{},nn).map(rs=>rs*vr):(Xy=qt.layout.get("text-radial-offset").evaluate(mn,{},nn)*vr,Ky=My),It.allowVerticalPlacement&&$t.vertical){const rs=$t.vertical;if(sn)L1=Ey(rs),gi&&(O1=Ey(gi));else{const ss=qt.layout.get("text-rotate").evaluate(mn,{},nn)+90;tl=Dm(Hi,pc,it,Wi,Ci,Mi,rs,Pi,ss,Ji),gi&&(fc=Dm(Hi,pc,it,Wi,Ci,Mi,gi,xn,ss))}}if(ci){const rs=qt.layout.get("icon-rotate").evaluate(mn,{},nn),ss=Ib(ci,rs,hr,Qy),Ju=gi?Ib(gi,rs,hr,Qy):void 0;el=Dm(Hi,pc,it,Wi,Ci,Mi,ci,xn,rs),F1=4*ss.length;const j1=It.iconSizeData;let mc=null;j1.kind==="source"?(mc=[eo*qt.layout.get("icon-size").evaluate(mn,{},nn)],mc[0]>Ya&&wn(`${It.layerIds[0]}: Value for "icon-size" is >= ${Bd}. Reduce your "icon-size".`)):j1.kind==="composite"&&(mc=[eo*Wn.compositeIconSizes[0].evaluate(mn,{},nn),eo*Wn.compositeIconSizes[1].evaluate(mn,{},nn)],(mc[0]>Ya||mc[1]>Ya)&&wn(`${It.layerIds[0]}: Value for "icon-size" is >= ${Bd}. Reduce your "icon-size".`)),It.addSymbols(It.icon,ss,mc,In,Er,mn,!1,Nt,it,Us.lineStartIndex,Us.lineLength,-1,dr,nn,jr,na),$y=It.icon.placedSymbolArray.length-1,Ju&&(B1=4*Ju.length,It.addSymbols(It.icon,Ju,mc,In,Er,mn,Ms.vertical,Nt,it,Us.lineStartIndex,Us.lineLength,-1,dr,nn,jr,na),Yy=It.icon.placedSymbolArray.length-1)}for(const rs in $t.horizontal){const ss=$t.horizontal[rs];oo||(U1=Sl(ss.text),sn?z1=Ey(ss):oo=Dm(Hi,pc,it,Wi,Ci,Mi,ss,Pi,qt.layout.get("text-rotate").evaluate(mn,{},nn),Ji));const Ju=ss.positionedLines.length===1;if(N1+=Db(It,Nt,it,ss,si,qt,sn,mn,Ji,Us,$t.vertical?Ms.horizontal:Ms.horizontalOnly,Ju?Object.keys($t.horizontal):[rs],So,$y,Wn,dr,nn,jr),Ju)break}$t.vertical&&(V1+=Db(It,Nt,it,$t.vertical,si,qt,sn,mn,Ji,Us,Ms.vertical,["vertical"],So,Yy,Wn,dr,nn,jr));let il=-1;const Jy=(rs,ss)=>rs?Math.max(rs,ss):ss;il=Jy(z1,il),il=Jy(L1,il),il=Jy(O1,il);const lC=il>-1?1:0;It.glyphOffsetArray.length>=65535&&wn("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),mn.sortKey!==void 0&&It.addToSortKeyRanges(It.symbolInstances.length,mn.sortKey),It.symbolInstances.emplaceBack(it.x,it.y,pc.x,pc.y,pc.z,So.right>=0?So.right:-1,So.center>=0?So.center:-1,So.left>=0?So.left:-1,So.vertical>=0?So.vertical:-1,$y,Yy,U1,oo!==void 0?oo:It.collisionBoxArray.length,oo!==void 0?oo+1:It.collisionBoxArray.length,tl!==void 0?tl:It.collisionBoxArray.length,tl!==void 0?tl+1:It.collisionBoxArray.length,el!==void 0?el:It.collisionBoxArray.length,el!==void 0?el+1:It.collisionBoxArray.length,fc||It.collisionBoxArray.length,fc?fc+1:It.collisionBoxArray.length,Wi,N1,V1,F1,B1,lC,0,Xy,Ky,il,0,Qy?1:0)})(t,tt,kt,vt,i,s,c,Ne,t.layers[0],t.collisionBoxArray,e.index,e.sourceLayerIndex,t.index,_e,Ce,v,0,Se,Be,G,e,h,T,E,I,R,L)};if(Fe==="line")for(const vt of Tb(e.geometry,0,0,pt,pt)){const tt=NA(vt,pe,Le,i.vertical||X,s,J,re,t.overscaling,pt);for(const Gt of tt)X&&qA(t,X.text,Oe,Gt)||At(vt,Gt,I)}else if(Fe==="line-center"){for(const vt of e.geometry)if(vt.length>1){const tt=BA(vt,Le,i.vertical||X,s,J,re);tt&&At(vt,tt,I)}}else if(e.type==="Polygon")for(const vt of uy(e.geometry,0)){const tt=UA(vt,16);At(vt[0],new ia(tt.x,tt.y,0,0,void 0),I)}else if(e.type==="LineString")for(const vt of e.geometry)At(vt,new ia(vt[0].x,vt[0].y,0,0,void 0),I);else if(e.type==="Point")for(const vt of e.geometry)for(const tt of vt)At([tt],new ia(tt.x,tt.y,0,0,void 0),I)}const Bd=255,Ya=Bd*eo;function Db(t,e,i,s,c,h,p,y,v,T,E,I,P,R,L,B,j,G){const X=function(he,re,pe,_e,Se,Le,Ce,Be){const Fe=[];if(re.positionedLines.length===0)return Fe;const Oe=_e.layout.get("text-rotate").evaluate(Le,{})*Math.PI/180,Ze=function(At){const vt=At[0],tt=At[1],Gt=vt*tt;return Gt>0?[vt,-tt]:Gt<0?[-vt,tt]:vt===0?[tt,vt]:[tt,-vt]}(pe);let We=Math.abs(re.top-re.bottom);for(const At of re.positionedLines)We-=At.lineOffset;const Je=re.positionedLines.length,Qe=We/Je;let Ne=re.top-pe[1];for(let At=0;At<Je;++At){const vt=re.positionedLines[At];Ne=VA(re,Qe,Ne,At);for(const tt of vt.positionedGlyphs){if(!tt.rect)continue;const Gt=tt.rect||{};let kt=hb+1,It=!0,it=1,Nt=0;if(tt.imageName){const In=Ce[tt.imageName];if(!In)continue;if(In.sdf){wn("SDF images are not supported in formatted text and will be ignored.");continue}It=!1,it=In.pixelRatio,kt=ns/it}const ri=(Se||Be)&&tt.vertical,$t=tt.metrics.advance*tt.scale/2,ci=tt.metrics,si=tt.rect;if(si===null)continue;Be&&re.verticalizable&&(Nt=tt.imageName?$t-tt.metrics.width*tt.scale/2:0);const gi=Se?[tt.x+$t,tt.y]:[0,0];let qt=[0,0],Hi=[0,0],Wi=!1;Se||(ri?(Hi=[tt.x+$t+Ze[0],tt.y+Ze[1]-Nt],Wi=!0):qt=[tt.x+$t+pe[0],tt.y+pe[1]-Nt]);const Ci=si.w*tt.scale/(it*(tt.localGlyph?to:1)),Mi=si.h*tt.scale/(it*(tt.localGlyph?to:1));let Pi,sn,Ji,Tn;if(ri){const In=tt.y-Ne,mn=new ft(-$t,$t-In),Wn=-Math.PI/2,hr=new ft(...Hi);Pi=new ft(-$t+qt[0],qt[1]),Pi._rotateAround(Wn,mn)._add(hr),Pi.x+=-In+$t,Pi.y-=(ci.left-kt)*tt.scale;const dr=tt.imageName?ci.advance*tt.scale:vr*tt.scale,nn=String.fromCodePoint(tt.glyph);vA(nn)?Pi.x+=(1-kt)*tt.scale:bA(nn)?Pi.x+=dr-ci.height*tt.scale+(-kt-1)*tt.scale:Pi.x+=tt.imageName||ci.width+2*kt===si.w&&ci.height+2*kt===si.h?(dr-Mi)/2:(dr-(ci.height+2*kt)*tt.scale)/2,sn=new ft(Pi.x,Pi.y-Ci),Ji=new ft(Pi.x+Mi,Pi.y),Tn=new ft(Pi.x+Mi,Pi.y-Ci)}else{const In=(ci.left-kt)*tt.scale-$t+qt[0],mn=(-ci.top-kt)*tt.scale+qt[1],Wn=In+Ci,hr=mn+Mi;Pi=new ft(In,mn),sn=new ft(Wn,mn),Ji=new ft(In,hr),Tn=new ft(Wn,hr)}if(Oe){let In;In=Se?new ft(0,0):Wi?new ft(Ze[0],Ze[1]):new ft(pe[0],pe[1]),Pi._rotateAround(Oe,In),sn._rotateAround(Oe,In),Ji._rotateAround(Oe,In),Tn._rotateAround(Oe,In)}const xn=new ft(0,0),Er=new ft(0,0);Fe.push({tl:Pi,tr:sn,bl:Ji,br:Tn,texPrimary:Gt,texSecondary:void 0,writingMode:re.writingMode,glyphOffset:gi,sectionIndex:tt.sectionIndex,isSDF:It,pixelOffsetTL:xn,pixelOffsetBR:Er,minFontScaleX:0,minFontScaleY:0})}}return Fe}(0,s,v,h,p,y,c,t.allowVerticalPlacement),ie=t.textSizeData;let J=null;ie.kind==="source"?(J=[eo*h.layout.get("text-size").evaluate(y,{},j)],J[0]>Ya&&wn(`${t.layerIds[0]}: Value for "text-size" is >= ${Bd}. Reduce your "text-size".`)):ie.kind==="composite"&&(J=[eo*L.compositeTextSizes[0].evaluate(y,{},j),eo*L.compositeTextSizes[1].evaluate(y,{},j)],(J[0]>Ya||J[1]>Ya)&&wn(`${t.layerIds[0]}: Value for "text-size" is >= ${Bd}. Reduce your "text-size".`)),t.addSymbols(t.text,X,J,v,p,y,E,e,i,T.lineStartIndex,T.lineLength,R,B,j,G,!1);for(const he of I)P[he]=t.text.placedSymbolArray.length-1;return 4*X.length}function kb(t){for(const e in t)return t[e];return null}function Dm(t,e,i,s,c,h,p,y,v,T){let E=p.top,I=p.bottom,P=p.left,R=p.right;const L=p.collisionPadding;if(L&&(P-=L[0],E-=L[1],R+=L[2],I+=L[3]),v){const B=new ft(P,E),j=new ft(R,E),G=new ft(P,I),X=new ft(R,I),ie=Si(v);let J=new ft(0,0);T&&(J=new ft(T[0],T[1])),B._rotateAround(ie,J),j._rotateAround(ie,J),G._rotateAround(ie,J),X._rotateAround(ie,J),P=Math.min(B.x,j.x,G.x,X.x),R=Math.max(B.x,j.x,G.x,X.x),E=Math.min(B.y,j.y,G.y,X.y),I=Math.max(B.y,j.y,G.y,X.y)}return t.emplaceBack(e.x,e.y,e.z,i.x,i.y,P,E,R,I,y,s,c,h),t.length-1}function Ey(t){t.collisionPadding&&(t.top-=t.collisionPadding[1],t.bottom+=t.collisionPadding[3]);const e=t.bottom-t.top;return e>0?Math.max(10,e):null}function qA(t,e,i,s){const c=t.compareText;if(e in c){const h=c[e];for(let p=h.length-1;p>=0;p--)if(s.dist(h[p])<i)return!0}else c[e]=[];return c[e].push(s),!1}function Rb(t,e){const i=t.fovAboveCenter,s=t.elevation?t.elevation.getMinElevationBelowMSL()*e:0,c=(t._camera.position[2]*t.worldSize-s)/Math.cos(t._pitch),h=Math.sin(i)*c/Math.sin(Math.max(Math.PI/2-t._pitch-i,.01)),p=Math.sin(t._pitch)*h+c;return Math.min(1.01*p,c*(1/t._horizonShift))}function Nd(t,e){if(!e.isReprojectedInTileSpace)return{scale:1<<t.z,x:t.x,y:t.y,x2:t.x+1,y2:t.y+1,projection:e};const i=Math.pow(2,-t.z),s=t.x*i,c=(t.x+1)*i,h=t.y*i,p=(t.y+1)*i,y=is(s),v=is(c),T=xr(h),E=xr(p),I=e.project(y,T),P=e.project(v,T),R=e.project(v,E),L=e.project(y,E);let B=Math.min(I.x,P.x,R.x,L.x),j=Math.min(I.y,P.y,R.y,L.y),G=Math.max(I.x,P.x,R.x,L.x),X=Math.max(I.y,P.y,R.y,L.y);const ie=i/16;function J(re,pe,_e,Se,Le,Ce){const Be=(_e+Le)/2,Fe=(Se+Ce)/2,Oe=e.project(is(Be),xr(Fe)),Ze=Math.max(0,B-Oe.x,j-Oe.y,Oe.x-G,Oe.y-X);B=Math.min(B,Oe.x),G=Math.max(G,Oe.x),j=Math.min(j,Oe.y),X=Math.max(X,Oe.y),Ze>ie&&(J(re,Oe,_e,Se,Be,Fe),J(Oe,pe,Be,Fe,Le,Ce))}J(I,P,s,h,c,h),J(P,R,c,h,c,p),J(R,L,c,p,s,p),J(L,I,s,p,s,h),B-=ie,j-=ie,G+=ie,X+=ie;const he=1/Math.max(G-B,X-j);return{scale:he,x:B*he,y:j*he,x2:G*he,y2:X*he,projection:e}}function zb(t,{x:e,y:i},s=0){return new ft(((e-s)*t.scale-t.x)*pt,(i*t.scale-t.y)*pt)}const HA=r.a9.identity(new Float32Array(16));class Qa{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,i){return{x:0,y:0,z:0}}unproject(e,i){return new Ii(0,0)}projectTilePoint(e,i,s){return{x:e,y:i,z:0}}locationPoint(e,i,s=!0){return e._coordinatePoint(e.locationCoordinate(i),s)}pixelsPerMeter(e,i){return Ur(1,e)*i}pixelSpaceConversion(e,i,s){return 1}farthestPixelDistance(e){return Rb(e,e.pixelsPerMeter)}pointCoordinate(e,i,s,c){const h=e.horizonLineFromTop(!1),p=new ft(i,Math.max(h,s));return e.rayIntersectionCoordinate(e.pointRayIntersection(p,c))}pointCoordinate3D(e,i,s){const c=new ft(i,s);if(e.elevation)return e.elevation.pointCoordinate(c);{const h=this.pointCoordinate(e,c.x,c.y,0);return[h.x,h.y,h.z]}}isPointAboveHorizon(e,i){if(e.elevation)return!this.pointCoordinate3D(e,i.x,i.y);const s=e.horizonLineFromTop();return i.y<s}createInversionMatrix(e,i){return HA}createTileMatrix(e,i,s){let c,h,p;const y=s.canonical,v=r.a9.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){const T=Nd(y,this);c=1,h=T.x+s.wrap*T.scale,p=T.y,r.a9.scale(v,v,[c/T.scale,c/T.scale,e.pixelsPerMeter/i])}else c=i/e.zoomScale(y.z),h=(y.x+Math.pow(2,y.z)*s.wrap)*c,p=y.y*c;return r.a9.translate(v,v,[h,p,0]),r.a9.scale(v,v,[c/pt,c/pt,1]),v}upVector(e,i,s){return[0,0,1]}upVectorScale(e,i,s){return{metersToTile:1}}}class ZA extends Qa{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];const[i,s]=this.parallels=e.parallels||[29.5,45.5],c=Math.sin(Si(i));this.n=(c+Math.sin(Si(s)))/2,this.c=1+c*(2*this.n-c),this.r0=Math.sqrt(this.c)/this.n}project(e,i){const{n:s,c,r0:h}=this,p=Si(e-this.center[0]),y=Si(i),v=Math.sqrt(c-2*s*Math.sin(y))/s;return{x:v*Math.sin(p*s),y:v*Math.cos(p*s)-h,z:0}}unproject(e,i){const{n:s,c,r0:h}=this,p=h+i;let y=Math.atan2(e,Math.abs(p))*Math.sign(p);p*s<0&&(y-=Math.PI*Math.sign(e)*Math.sign(p));const v=Si(this.center[0])*s;y=qs(y,-Math.PI-v,Math.PI-v);const T=xi(kr(y/s)+this.center[0],-180,180),E=Math.asin(xi((c-(e*e+p*p)*s*s)/(2*s),-1,1)),I=xi(kr(E),-Rn,Rn);return new Ii(T,I)}}const Vd=1.340264,Ud=-.081106,jd=893e-6,Gd=.003796,km=Math.sqrt(3)/2;class $A extends Qa{project(e,i){i=i/180*Math.PI,e=e/180*Math.PI;const s=Math.asin(km*Math.sin(i)),c=s*s,h=c*c*c;return{x:.5*(e*Math.cos(s)/(km*(Vd+3*Ud*c+h*(7*jd+9*Gd*c)))/Math.PI+.5),y:1-.5*(s*(Vd+Ud*c+h*(jd+Gd*c))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let s=i=(2*(1-i)-1)*Math.PI,c=s*s,h=c*c*c;for(let E,I,P,R=0;R<12&&(I=s*(Vd+Ud*c+h*(jd+Gd*c))-i,P=Vd+3*Ud*c+h*(7*jd+9*Gd*c),E=I/P,s=xi(s-E,-Math.PI/3,Math.PI/3),c=s*s,h=c*c*c,!(Math.abs(E)<1e-12));++R);const p=km*e*(Vd+3*Ud*c+h*(7*jd+9*Gd*c))/Math.cos(s),y=Math.asin(Math.sin(s)/km),v=xi(180*p/Math.PI,-180,180),T=xi(180*y/Math.PI,-Rn,Rn);return new Ii(v,T)}}class YA extends Qa{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){return{x:.5+e/360,y:.5-i/360,z:0}}unproject(e,i){const s=360*(e-.5),c=xi(360*(.5-i),-Rn,Rn);return new Ii(s,c)}}const Zu=Math.PI/2;function Rm(t){return Math.tan((Zu+t)/2)}class QA extends Qa{constructor(e){super(e),this.center=e.center||[0,30];const[i,s]=this.parallels=e.parallels||[30,30];let c=Si(i),h=Si(s);this.southernCenter=c+h<0,this.southernCenter&&(c=-c,h=-h);const p=Math.cos(c),y=Rm(c);this.n=c===h?Math.sin(c):Math.log(p/Math.cos(h))/Math.log(Rm(h)/y),this.f=p*Math.pow(Rm(c),this.n)/this.n}project(e,i){i=Si(i),this.southernCenter&&(i=-i),e=Si(e-this.center[0]);const s=1e-6,{n:c,f:h}=this;h>0?i<-Zu+s&&(i=-Zu+s):i>Zu-s&&(i=Zu-s);const p=h/Math.pow(Rm(i),c);let y=p*Math.sin(c*e),v=h-p*Math.cos(c*e);return y=.5*(y/Math.PI+.5),v=.5*(v/Math.PI+.5),{x:y,y:this.southernCenter?v:1-v,z:0}}unproject(e,i){e=(2*e-.5)*Math.PI,this.southernCenter&&(i=1-i),i=(2*(1-i)-.5)*Math.PI;const{n:s,f:c}=this,h=c-i,p=Math.sign(h),y=Math.sign(s)*Math.sqrt(e*e+h*h);let v=Math.atan2(e,Math.abs(h))*p;h*s<0&&(v-=Math.PI*Math.sign(e)*p);const T=xi(kr(v/s)+this.center[0],-180,180),E=xi(kr(2*Math.atan(Math.pow(c/y,1/s))-Zu),-Rn,Rn);return new Ii(T,this.southernCenter?-E:E)}}class Lb extends Qa{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,i){return{x:ja(e),y:Ko(i),z:0}}unproject(e,i){const s=is(e),c=xr(i);return new Ii(s,c)}}const Ob=Si(Rn);class XA extends Qa{project(e,i){const s=(i=Si(i))*i,c=s*s;return{x:.5*((e=Si(e))*(.8707-.131979*s+c*(c*(.003971*s-.001529*c)-.013791))/Math.PI+.5),y:1-.5*(i*(1.007226+s*(.015085+c*(.028874*s-.044475-.005916*c)))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let s=i=(2*(1-i)-1)*Math.PI,c=25,h=0,p=s*s;do{p=s*s;const T=p*p;h=(s*(1.007226+p*(.015085+T*(.028874*p-.044475-.005916*T)))-i)/(1.007226+p*(.045255+T*(.259866*p-.311325-.005916*11*T))),s=xi(s-h,-Ob,Ob)}while(Math.abs(h)>1e-6&&--c>0);p=s*s;const y=xi(kr(e/(.8707+p*(p*(p*p*p*(.003971-.001529*p)-.013791)-.131979))),-180,180),v=kr(s);return new Ii(y,v)}}const Fb=Si(Rn);class KA extends Qa{project(e,i){i=Si(i),e=Si(e);const s=Math.cos(i),c=2/Math.PI,h=Math.acos(s*Math.cos(e/2)),p=Math.sin(h)/h,y=.5*(e*c+2*s*Math.sin(e/2)/p)||0,v=.5*(i+Math.sin(i)/p)||0;return{x:.5*(y/Math.PI+.5),y:1-.5*(v/Math.PI+1),z:0}}unproject(e,i){let s=e=(2*e-.5)*Math.PI,c=i=(2*(1-i)-1)*Math.PI,h=25;const p=1e-6;let y=0,v=0;do{const T=Math.cos(c),E=Math.sin(c),I=2*E*T,P=E*E,R=T*T,L=Math.cos(s/2),B=Math.sin(s/2),j=2*L*B,G=B*B,X=1-R*L*L,ie=X?1/X:0,J=X?Math.acos(T*L)*Math.sqrt(1/X):0,he=.5*(2*J*T*B+2*s/Math.PI)-e,re=.5*(J*E+c)-i,pe=.5*ie*(R*G+J*T*L*P)+1/Math.PI,_e=ie*(j*I/4-J*E*B),Se=.125*ie*(I*B-J*E*R*j),Le=.5*ie*(P*L+J*G*T)+.5,Ce=_e*Se-Le*pe;y=(re*_e-he*Le)/Ce,v=(he*Se-re*pe)/Ce,s=xi(s-y,-Math.PI,Math.PI),c=xi(c-v,-Fb,Fb)}while((Math.abs(y)>p||Math.abs(v)>p)&&--h>0);return new Ii(kr(s),kr(c))}}class Bb extends Qa{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(Si(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){const{scale:s,cosPhi:c}=this;return{x:Si(e)*c*s+.5,y:-Math.sin(Si(i))/c*s+.5,z:0}}unproject(e,i){const{scale:s,cosPhi:c}=this,h=-(i-.5)/s,p=xi(kr((e-.5)/s)/c,-180,180),y=Math.asin(xi(h*c,-1,1)),v=xi(kr(y),-Rn,Rn);return new Ii(p,v)}}class JA extends Lb{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,i,s){const c=Ad(e,i,s),h=hm(Mo(s));return r.Q.transformMat4(c,c,h),{x:c[0],y:c[1],z:c[2]}}locationPoint(e,i){const s=sc(i.lat,i.lng),c=r.Q.normalize([],s),h=e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(i),e._centerAltitude):e._centerAltitude,p=Ur(1,0)*pt*h;r.Q.scaleAndAdd(s,s,c,p);const y=r.a9.identity(new Float64Array(16));return r.a9.multiply(y,e.pixelMatrix,e.globeMatrix),r.Q.transformMat4(s,s,y),new ft(s[0],s[1])}pixelsPerMeter(e,i){return Ur(1,0)*i}pixelSpaceConversion(e,i,s){const c=Ur(1,e)*i,h=hi(Ur(1,45)*i,c,s);return this.pixelsPerMeter(e,i)/h}createTileMatrix(e,i,s){const c=iy(Mo(s.canonical));return r.a9.multiply(new Float64Array(16),e.globeMatrix,c)}createInversionMatrix(e,i){const{center:s}=e,c=hm(Mo(i));return r.a9.rotateY(c,c,Si(s.lng)),r.a9.rotateX(c,c,Si(s.lat)),r.a9.scale(c,c,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(c)}pointCoordinate(e,i,s,c){return tv(e,i,s,!0)||new Sr(0,0)}pointCoordinate3D(e,i,s){const c=this.pointCoordinate(e,i,s,0);return[c.x,c.y,c.z]}isPointAboveHorizon(e,i){return!tv(e,i.x,i.y,!1)}farthestPixelDistance(e){const i=function(c,h){const p=c.cameraToCenterDistance,y=c._centerAltitude*h,v=c._camera,T=c._camera.forward(),E=r.Q.add([],r.Q.scale([],T,-p),[0,0,y]),I=c.worldSize/(2*Math.PI),P=[0,0,-I],R=c.width/c.height,L=Math.tan(c.fovAboveCenter),B=r.Q.scale([],v.up(),L),j=r.Q.scale([],v.right(),L*R),G=r.Q.normalize([],r.Q.add([],r.Q.add([],T,B),j)),X=[];let ie;if(new Xg(E,G).closestPointOnSphere(P,I,X)){const J=r.Q.add([],X,P),he=r.Q.sub([],J,E);ie=Math.cos(c.fovAboveCenter)*r.Q.length(he)}else{const J=r.Q.sub([],E,P),he=r.Q.sub([],P,E);r.Q.normalize(he,he);const re=r.Q.length(J)-I;ie=Math.sqrt(re*(re+2*I));const pe=Math.acos(ie/(I+re))-Math.acos(r.Q.dot(T,he));ie*=Math.cos(pe)}return 1.01*ie}(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),s=Wa(e.zoom);if(s>0){const c=Rb(e,Ur(1,e.center.lat)*e.worldSize),h=e.worldSize/(2*Math.PI),p=Math.max(e.width,e.height)/e.worldSize*Math.PI;return hi(i,c+h*(1-Math.cos(p)),Math.pow(s,10))}return i}upVector(e,i,s){return Ad(i,s,e,1)}upVectorScale(e){return{metersToTile:lm(um(Mo(e)))}}}function Nb(t){const e=t.parallels,i=!!e&&Math.abs(e[0]+e[1])<.01;switch(t.name){case"mercator":return new Lb(t);case"equirectangular":return new YA(t);case"naturalEarth":return new XA(t);case"equalEarth":return new $A(t);case"winkelTripel":return new KA(t);case"albers":return i?new Bb(t):new ZA(t);case"lambertConformalConic":return i?new Bb(t):new QA(t);case"globe":return new JA(t)}throw new Error(`Invalid projection name: ${t.name}`)}const eI=ym.types,tI=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function zm(t,e,i,s,c,h,p,y,v,T,E,I,P){const R=y?Math.min(Ya,Math.round(y[0])):0,L=y?Math.min(Ya,Math.round(y[1])):0;t.emplaceBack(e,i,Math.round(32*s),Math.round(32*c),h,p,(R<<1)+(v?1:0),L,16*T,16*E,256*I,256*P)}function Lm(t,e,i){t.emplaceBack(e,i)}function Om(t,e,i,s,c,h,p){t.emplaceBack(e,i,s,c,h,p)}function Fm(t,e,i,s,c){t.emplaceBack(e,i,s,c),t.emplaceBack(e,i,s,c),t.emplaceBack(e,i,s,c),t.emplaceBack(e,i,s,c)}function iI(t){for(const e of t.sections)if(D(e.text))return!0;return!1}class Ay{constructor(e){this.layoutVertexArray=new Fs,this.indexArray=new Kn,this.programConfigurations=e,this.segments=new kn,this.dynamicLayoutVertexArray=new Xn,this.opacityVertexArray=new To,this.placedSymbolArray=new Mx,this.iconTransitioningVertexArray=new ts,this.globeExtVertexArray=new Bs,this.zOffsetVertexArray=new bd}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}upload(e,i,s,c,h){this.isEmpty()||(s&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,uA.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,i),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,dA.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,tI,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,pA.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,hA.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||h)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,fA.members,!0)),this.opacityVertexBuffer.itemSize=1),(s||c)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}Mt(Ay,"SymbolBuffers");class Iy{constructor(e,i,s){this.layoutVertexArray=new e,this.layoutAttributes=i,this.indexArray=new s,this.segments=new kn,this.collisionVertexArray=new Ks,this.collisionVertexArrayExt=new Xn}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,mA.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,_A.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Mt(Iy,"CollisionBuffers");class Bm{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(p=>p.fqid),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=r.a9.identity([]),this.placementViewportMatrix=r.a9.identity([]);const i=this.layers[0]._unevaluatedLayout._values;this.textSizeData=gy(this.zoom,i["text-size"]),this.iconSizeData=gy(this.zoom,i["icon-size"]);const s=this.layers[0].layout,c=s.get("symbol-sort-key"),h=s.get("symbol-z-order");this.canOverlap=s.get("text-allow-overlap")||s.get("icon-allow-overlap")||s.get("text-ignore-placement")||s.get("icon-ignore-placement"),this.sortFeaturesByKey=h!=="viewport-y"&&c.constantOr(1)!==void 0,this.sortFeaturesByY=(h==="viewport-y"||h==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=s.get("text-writing-mode").map(p=>Ms[p]),this.stateDependentLayerIds=this.layers.filter(p=>p.isStateDependent()).map(p=>p.id),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=s.get("symbol-z-elevate")}createArrays(){this.text=new Ay(new Va(this.layers,this.zoom,e=>/^text/.test(e))),this.icon=new Ay(new Va(this.layers,this.zoom,e=>/^icon/.test(e))),this.glyphOffsetArray=new Ax,this.lineVertexArray=new Ix,this.symbolInstances=new Ex}calculateGlyphDependencies(e,i,s,c,h){for(let p=0;p<e.length;p++){const y=e.codePointAt(p);if(y===void 0)break;if(i[y]=!0,c&&h&&y<=65535){const v=Ld[e.charAt(p)];v&&(i[v.charCodeAt(0)]=!0)}}}populate(e,i,s,c){const h=this.layers[0],p=h.layout,y=this.projection.name==="globe",v=p.get("text-font"),T=p.get("text-field"),E=p.get("icon-image"),I=(T.value.kind!=="constant"||T.value.value instanceof mr&&!T.value.value.isEmpty()||T.value.value.toString().length>0)&&(v.value.kind!=="constant"||v.value.value.length>0),P=E.value.kind!=="constant"||!!E.value.value||Object.keys(E.parameters).length>0,R=p.get("symbol-sort-key");if(this.features=[],!I&&!P)return;const L=i.iconDependencies,B=i.glyphDependencies,j=i.availableImages,G=new Y(this.zoom);for(const{feature:X,id:ie,index:J,sourceLayerIndex:he}of e){const re=h._featureFilter.needGeometry,pe=Ga(X,re);if(!h._featureFilter.filter(G,pe,s))continue;if(re||(pe.geometry=Jo(X,s,c)),y&&X.type!==1&&s.z<=5){const Ce=pe.geometry,Be=.98078528056,Fe=(Oe,Ze)=>{const We=Ad(Oe.x,Oe.y,s,1),Je=Ad(Ze.x,Ze.y,s,1);return r.Q.dot(We,Je)<Be};for(let Oe=0;Oe<Ce.length;Oe++)Ce[Oe]=WS(Ce[Oe],Fe)}let _e,Se;if(I){const Ce=h.getValueAndResolveTokens("text-field",pe,s,j),Be=mr.factory(Ce);iI(Be)&&(this.hasRTLText=!0),(!this.hasRTLText||oe()==="unavailable"||this.hasRTLText&&le.isParsed())&&(_e=xA(Be,h,pe))}if(P){const Ce=h.getValueAndResolveTokens("icon-image",pe,s,j);Se=Ce instanceof Yr?Ce:Yr.fromString(Ce)}if(!_e&&!Se)continue;const Le=this.sortFeaturesByKey?R.evaluate(pe,{},s):void 0;if(this.features.push({id:ie,text:_e,icon:Se,index:J,sourceLayerIndex:he,geometry:pe.geometry,properties:X.properties,type:eI[X.type],sortKey:Le}),Se&&(L[Se.namePrimary]=!0,Se.nameSecondary&&(L[Se.nameSecondary]=!0)),_e){const Ce=v.evaluate(pe,{},s).join(","),Be=p.get("text-rotation-alignment")==="map"&&p.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Ms.vertical)>=0;for(const Fe of _e.sections)if(Fe.image)L[Fe.image.namePrimary]=!0;else{const Oe=a(_e.toString()),Ze=Fe.fontStack||Ce,We=B[Ze]=B[Ze]||{};this.calculateGlyphDependencies(Fe.text,We,Be,this.allowVerticalPlacement,Oe)}}}p.get("symbol-placement")==="line"&&(this.features=function(X){const ie={},J={},he=[];let re=0;function pe(Ce){he.push(X[Ce]),re++}function _e(Ce,Be,Fe){const Oe=J[Ce];return delete J[Ce],J[Be]=Oe,he[Oe].geometry[0].pop(),he[Oe].geometry[0]=he[Oe].geometry[0].concat(Fe[0]),Oe}function Se(Ce,Be,Fe){const Oe=ie[Be];return delete ie[Be],ie[Ce]=Oe,he[Oe].geometry[0].shift(),he[Oe].geometry[0]=Fe[0].concat(he[Oe].geometry[0]),Oe}function Le(Ce,Be,Fe){const Oe=Fe?Be[0][Be[0].length-1]:Be[0][0];return`${Ce}:${Oe.x}:${Oe.y}`}for(let Ce=0;Ce<X.length;Ce++){const Be=X[Ce],Fe=Be.geometry,Oe=Be.text?Be.text.toString():null;if(!Oe){pe(Ce);continue}const Ze=Le(Oe,Fe),We=Le(Oe,Fe,!0);if(Ze in J&&We in ie&&J[Ze]!==ie[We]){const Je=Se(Ze,We,Fe),Qe=_e(Ze,We,he[Je].geometry);delete ie[Ze],delete J[We],J[Le(Oe,he[Qe].geometry,!0)]=Qe,he[Je].geometry=null}else Ze in J?_e(Ze,We,Fe):We in ie?Se(Ze,We,Fe):(pe(Ce),ie[Ze]=re-1,J[We]=re-1)}return he.filter(Ce=>Ce.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((X,ie)=>X.sortKey-ie.sortKey)}update(e,i,s,c,h){const p=Object.keys(e).length!==0;if(p&&!this.stateDependentLayers.length)return;const y=p?this.stateDependentLayers:this.layers;this.text.programConfigurations.updatePaintArrays(e,i,y,s,c,h),this.icon.programConfigurations.updatePaintArrays(e,i,y,s,c,h)}updateZOffset(){const e=(h,p,y)=>{s+=p,s>h.length&&h.resize(s);for(let v=-p;v<0;v++)h.emplace(v+s,y)},i=(h,p,y)=>{c+=p,c>h.length&&h.resize(c);for(let v=-p;v<0;v++)h.emplace(v+c,y)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let s=0,c=0;for(let h=0;h<this.symbolInstances.length;h++){const p=this.symbolInstances.get(h),{numHorizontalGlyphVertices:y,numVerticalGlyphVertices:v,numIconVertices:T}=p,E=p.zOffset,I=T>0;if((y>0||v>0)&&(e(this.text.zOffsetVertexArray,y,E),e(this.text.zOffsetVertexArray,v,E)),I){const{placedIconSymbolIndex:P,verticalPlacedIconSymbolIndex:R}=p;P>=0&&i(this.icon.zOffsetVertexArray,T,E),R>=0&&i(this.icon.zOffsetVertexArray,p.numVerticalIconVertices,E)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=Nb(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,i){const s=this.lineVertexArray.length;if(e.segment!==void 0)for(const{x:c,y:h}of i)this.lineVertexArray.emplaceBack(c,h);return{lineStartIndex:s,lineLength:this.lineVertexArray.length-s}}addSymbols(e,i,s,c,h,p,y,v,T,E,I,P,R,L,B,j){const G=e.indexArray,X=e.layoutVertexArray,ie=e.globeExtVertexArray,J=e.segments.prepareSegment(4*i.length,X,G,this.canOverlap?p.sortKey:void 0),he=this.glyphOffsetArray.length,re=J.vertexLength,pe=this.allowVerticalPlacement&&y===Ms.vertical?Math.PI/2:0,_e=p.text&&p.text.sections;for(let Le=0;Le<i.length;Le++){const{tl:Ce,tr:Be,bl:Fe,br:Oe,texPrimary:Ze,texSecondary:We,pixelOffsetTL:Je,pixelOffsetBR:Qe,minFontScaleX:Ne,minFontScaleY:At,glyphOffset:vt,isSDF:tt,sectionIndex:Gt}=i[Le],kt=J.vertexLength,It=vt[1];if(zm(X,T.x,T.y,Ce.x,It+Ce.y,Ze.x,Ze.y,s,tt,Je.x,Je.y,Ne,At),zm(X,T.x,T.y,Be.x,It+Be.y,Ze.x+Ze.w,Ze.y,s,tt,Qe.x,Je.y,Ne,At),zm(X,T.x,T.y,Fe.x,It+Fe.y,Ze.x,Ze.y+Ze.h,s,tt,Je.x,Qe.y,Ne,At),zm(X,T.x,T.y,Oe.x,It+Oe.y,Ze.x+Ze.w,Ze.y+Ze.h,s,tt,Qe.x,Qe.y,Ne,At),v){const{x:it,y:Nt,z:ri}=v.anchor,[$t,ci,si]=v.up;Om(ie,it,Nt,ri,$t,ci,si),Om(ie,it,Nt,ri,$t,ci,si),Om(ie,it,Nt,ri,$t,ci,si),Om(ie,it,Nt,ri,$t,ci,si),Fm(e.dynamicLayoutVertexArray,it,Nt,ri,pe)}else Fm(e.dynamicLayoutVertexArray,T.x,T.y,T.z,pe);if(j){const it=We||Ze;Lm(e.iconTransitioningVertexArray,it.x,it.y),Lm(e.iconTransitioningVertexArray,it.x+it.w,it.y),Lm(e.iconTransitioningVertexArray,it.x,it.y+it.h),Lm(e.iconTransitioningVertexArray,it.x+it.w,it.y+it.h)}G.emplaceBack(kt,kt+1,kt+2),G.emplaceBack(kt+1,kt+2,kt+3),J.vertexLength+=4,J.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(vt[0]),Le!==i.length-1&&Gt===i[Le+1].sectionIndex||e.programConfigurations.populatePaintArrays(X.length,p,p.index,{},R,L,B,_e&&_e[Gt])}const Se=v?v.anchor:T;e.placedSymbolArray.emplaceBack(Se.x,Se.y,Se.z,T.x,T.y,he,this.glyphOffsetArray.length-he,re,E,I,T.segment,s?s[0]:0,s?s[1]:0,c[0],c[1],y,0,!1,0,P,0)}_commitLayoutVertex(e,i,s,c,h,p,y){e.emplaceBack(i,s,c,h,p,Math.round(y.x),Math.round(y.y))}_addCollisionDebugVertices(e,i,s,c,h,p,y){const v=s.segments.prepareSegment(4,s.layoutVertexArray,s.indexArray),T=v.vertexLength,E=y.tileAnchorX,I=y.tileAnchorY;for(let R=0;R<4;R++)s.collisionVertexArray.emplaceBack(0,0,0,0);this._commitDebugCollisionVertexUpdate(s.collisionVertexArrayExt,i,e.padding,y.zOffset),this._commitLayoutVertex(s.layoutVertexArray,c,h,p,E,I,new ft(e.x1,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,c,h,p,E,I,new ft(e.x2,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,c,h,p,E,I,new ft(e.x2,e.y2)),this._commitLayoutVertex(s.layoutVertexArray,c,h,p,E,I,new ft(e.x1,e.y2)),v.vertexLength+=4;const P=s.indexArray;P.emplaceBack(T,T+1),P.emplaceBack(T+1,T+2),P.emplaceBack(T+2,T+3),P.emplaceBack(T+3,T),v.primitiveLength+=4}_addTextDebugCollisionBoxes(e,i,s,c,h,p){for(let y=c;y<h;y++){const v=s.get(y),T=this.getSymbolInstanceTextSize(e,p,i,y);this._addCollisionDebugVertices(v,T,this.textCollisionBox,v.projectedAnchorX,v.projectedAnchorY,v.projectedAnchorZ,p)}}_addIconDebugCollisionBoxes(e,i,s,c,h,p){for(let y=c;y<h;y++){const v=s.get(y),T=this.getSymbolInstanceIconSize(e,i,p.placedIconSymbolIndex);this._addCollisionDebugVertices(v,T,this.iconCollisionBox,v.projectedAnchorX,v.projectedAnchorY,v.projectedAnchorZ,p)}}generateCollisionDebugBuffers(e,i){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Iy(Fa,sb.members,ts),this.iconCollisionBox=new Iy(Fa,sb.members,ts);const s=Vu(this.iconSizeData,e),c=Vu(this.textSizeData,e);for(let h=0;h<this.symbolInstances.length;h++){const p=this.symbolInstances.get(h);this._addTextDebugCollisionBoxes(c,e,i,p.textBoxStartIndex,p.textBoxEndIndex,p),this._addTextDebugCollisionBoxes(c,e,i,p.verticalTextBoxStartIndex,p.verticalTextBoxEndIndex,p),this._addIconDebugCollisionBoxes(s,e,i,p.iconBoxStartIndex,p.iconBoxEndIndex,p),this._addIconDebugCollisionBoxes(s,e,i,p.verticalIconBoxStartIndex,p.verticalIconBoxEndIndex,p)}}getSymbolInstanceTextSize(e,i,s,c){const h=this.text.placedSymbolArray.get(i.rightJustifiedTextSymbolIndex>=0?i.rightJustifiedTextSymbolIndex:i.centerJustifiedTextSymbolIndex>=0?i.centerJustifiedTextSymbolIndex:i.leftJustifiedTextSymbolIndex>=0?i.leftJustifiedTextSymbolIndex:i.verticalPlacedTextSymbolIndex>=0?i.verticalPlacedTextSymbolIndex:c),p=Mm(this.textSizeData,e,h)/vr;return this.tilePixelRatio*p}getSymbolInstanceIconSize(e,i,s){const c=this.icon.placedSymbolArray.get(s),h=Mm(this.iconSizeData,e,c);return this.tilePixelRatio*h}_commitDebugCollisionVertexUpdate(e,i,s,c){e.emplaceBack(i,-s,-s,c),e.emplaceBack(i,s,-s,c),e.emplaceBack(i,s,s,c),e.emplaceBack(i,-s,s,c)}_updateTextDebugCollisionBoxes(e,i,s,c,h,p){for(let y=c;y<h;y++){const v=s.get(y),T=this.getSymbolInstanceTextSize(e,p,i,y);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,T,v.padding,p.zOffset)}}_updateIconDebugCollisionBoxes(e,i,s,c,h,p){for(let y=c;y<h;y++){const v=s.get(y),T=this.getSymbolInstanceIconSize(e,i,p.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,T,v.padding,p.zOffset)}}updateCollisionDebugBuffers(e,i){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const s=Vu(this.iconSizeData,e),c=Vu(this.textSizeData,e);for(let h=0;h<this.symbolInstances.length;h++){const p=this.symbolInstances.get(h);this._updateTextDebugCollisionBoxes(c,e,i,p.textBoxStartIndex,p.textBoxEndIndex,p),this._updateTextDebugCollisionBoxes(c,e,i,p.verticalTextBoxStartIndex,p.verticalTextBoxEndIndex,p),this._updateIconDebugCollisionBoxes(s,e,i,p.iconBoxStartIndex,p.iconBoxEndIndex,p),this._updateIconDebugCollisionBoxes(s,e,i,p.verticalIconBoxStartIndex,p.verticalIconBoxEndIndex,p)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,i,s,c,h,p,y,v,T){const E={};if(i<s){const{x1:I,y1:P,x2:R,y2:L,padding:B,projectedAnchorX:j,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:ie,tileAnchorY:J,featureIndex:he}=e.get(i);E.textBox={x1:I,y1:P,x2:R,y2:L,padding:B,projectedAnchorX:j,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:ie,tileAnchorY:J},E.textFeatureIndex=he}if(c<h){const{x1:I,y1:P,x2:R,y2:L,padding:B,projectedAnchorX:j,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:ie,tileAnchorY:J,featureIndex:he}=e.get(c);E.verticalTextBox={x1:I,y1:P,x2:R,y2:L,padding:B,projectedAnchorX:j,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:ie,tileAnchorY:J},E.verticalTextFeatureIndex=he}if(p<y){const{x1:I,y1:P,x2:R,y2:L,padding:B,projectedAnchorX:j,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:ie,tileAnchorY:J,featureIndex:he}=e.get(p);E.iconBox={x1:I,y1:P,x2:R,y2:L,padding:B,projectedAnchorX:j,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:ie,tileAnchorY:J},E.iconFeatureIndex=he}if(v<T){const{x1:I,y1:P,x2:R,y2:L,padding:B,projectedAnchorX:j,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:ie,tileAnchorY:J,featureIndex:he}=e.get(v);E.verticalIconBox={x1:I,y1:P,x2:R,y2:L,padding:B,projectedAnchorX:j,projectedAnchorY:G,projectedAnchorZ:X,tileAnchorX:ie,tileAnchorY:J},E.verticalIconFeatureIndex=he}return E}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let i=0;i<this.symbolInstances.length;i++){const s=this.symbolInstances.get(i);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,s.textBoxStartIndex,s.textBoxEndIndex,s.verticalTextBoxStartIndex,s.verticalTextBoxEndIndex,s.iconBoxStartIndex,s.iconBoxEndIndex,s.verticalIconBoxStartIndex,s.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,i){const s=e.placedSymbolArray.get(i),c=s.vertexStartIndex+4*s.numGlyphs;for(let h=s.vertexStartIndex;h<c;h+=4)e.indexArray.emplaceBack(h,h+1,h+2),e.indexArray.emplaceBack(h+1,h+2,h+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const i=Math.sin(e),s=Math.cos(e),c=[],h=[],p=[];for(let y=0;y<this.symbolInstances.length;++y){p.push(y);const v=this.symbolInstances.get(y);c.push(0|Math.round(i*v.tileAnchorX+s*v.tileAnchorY)),h.push(v.featureIndex)}return p.sort((y,v)=>c[y]-c[v]||h[v]-h[y]),p}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((e,i)=>this.symbolInstances.get(i).zOffset-this.symbolInstances.get(e).zOffset)}addToSortKeyRanges(e,i){const s=this.sortKeyRanges[this.sortKeyRanges.length-1];s&&s.sortKey===i?s.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:i,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const i of this.symbolInstanceIndexes){const s=this.symbolInstances.get(i);this.featureSortOrder.push(s.featureIndex);const{rightJustifiedTextSymbolIndex:c,centerJustifiedTextSymbolIndex:h,leftJustifiedTextSymbolIndex:p,verticalPlacedTextSymbolIndex:y,placedIconSymbolIndex:v,verticalPlacedIconSymbolIndex:T}=s;c>=0&&this.addIndicesForPlacedSymbol(this.text,c),h>=0&&h!==c&&this.addIndicesForPlacedSymbol(this.text,h),p>=0&&p!==h&&p!==c&&this.addIndicesForPlacedSymbol(this.text,p),y>=0&&this.addIndicesForPlacedSymbol(this.text,y),v>=0&&this.addIndicesForPlacedSymbol(this.icon,v),T>=0&&this.addIndicesForPlacedSymbol(this.icon,T)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}Mt(Bm,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),Bm.addDynamicAttributes=Fm;const nI=new we({"symbol-placement":new ge(ae.layout_symbol["symbol-placement"]),"symbol-spacing":new ge(ae.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new ge(ae.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Ae(ae.layout_symbol["symbol-sort-key"]),"symbol-z-order":new ge(ae.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new ge(ae.layout_symbol["symbol-z-elevate"]),"icon-allow-overlap":new ge(ae.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new ge(ae.layout_symbol["icon-ignore-placement"]),"icon-optional":new ge(ae.layout_symbol["icon-optional"]),"icon-rotation-alignment":new ge(ae.layout_symbol["icon-rotation-alignment"]),"icon-size":new Ae(ae.layout_symbol["icon-size"]),"icon-text-fit":new Ae(ae.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Ae(ae.layout_symbol["icon-text-fit-padding"]),"icon-image":new Ae(ae.layout_symbol["icon-image"]),"icon-rotate":new Ae(ae.layout_symbol["icon-rotate"]),"icon-padding":new ge(ae.layout_symbol["icon-padding"]),"icon-keep-upright":new ge(ae.layout_symbol["icon-keep-upright"]),"icon-offset":new Ae(ae.layout_symbol["icon-offset"]),"icon-anchor":new Ae(ae.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new ge(ae.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new ge(ae.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new ge(ae.layout_symbol["text-rotation-alignment"]),"text-field":new Ae(ae.layout_symbol["text-field"]),"text-font":new Ae(ae.layout_symbol["text-font"]),"text-size":new Ae(ae.layout_symbol["text-size"]),"text-max-width":new Ae(ae.layout_symbol["text-max-width"]),"text-line-height":new Ae(ae.layout_symbol["text-line-height"]),"text-letter-spacing":new Ae(ae.layout_symbol["text-letter-spacing"]),"text-justify":new Ae(ae.layout_symbol["text-justify"]),"text-radial-offset":new Ae(ae.layout_symbol["text-radial-offset"]),"text-variable-anchor":new ge(ae.layout_symbol["text-variable-anchor"]),"text-anchor":new Ae(ae.layout_symbol["text-anchor"]),"text-max-angle":new ge(ae.layout_symbol["text-max-angle"]),"text-writing-mode":new ge(ae.layout_symbol["text-writing-mode"]),"text-rotate":new Ae(ae.layout_symbol["text-rotate"]),"text-padding":new ge(ae.layout_symbol["text-padding"]),"text-keep-upright":new ge(ae.layout_symbol["text-keep-upright"]),"text-transform":new Ae(ae.layout_symbol["text-transform"]),"text-offset":new Ae(ae.layout_symbol["text-offset"]),"text-allow-overlap":new ge(ae.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new ge(ae.layout_symbol["text-ignore-placement"]),"text-optional":new ge(ae.layout_symbol["text-optional"]),visibility:new ge(ae.layout_symbol.visibility)});var Cy={paint:new we({"icon-opacity":new Ae(ae.paint_symbol["icon-opacity"]),"icon-emissive-strength":new Ae(ae.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new Ae(ae.paint_symbol["text-emissive-strength"]),"icon-color":new Ae(ae.paint_symbol["icon-color"]),"icon-halo-color":new Ae(ae.paint_symbol["icon-halo-color"]),"icon-halo-width":new Ae(ae.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Ae(ae.paint_symbol["icon-halo-blur"]),"icon-translate":new ge(ae.paint_symbol["icon-translate"]),"icon-translate-anchor":new ge(ae.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new Ae(ae.paint_symbol["icon-image-cross-fade"]),"text-opacity":new Ae(ae.paint_symbol["text-opacity"]),"text-color":new Ae(ae.paint_symbol["text-color"],{runtimeType:$r,getOverride:t=>t.textColor,hasOverride:t=>!!t.textColor}),"text-halo-color":new Ae(ae.paint_symbol["text-halo-color"]),"text-halo-width":new Ae(ae.paint_symbol["text-halo-width"]),"text-halo-blur":new Ae(ae.paint_symbol["text-halo-blur"]),"text-translate":new ge(ae.paint_symbol["text-translate"]),"text-translate-anchor":new ge(ae.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new ge(ae.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new ge(ae.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new ge(ae.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new ge(ae.paint_symbol["icon-color-brightness-max"])}),layout:nI};class Vb{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:mi,this.defaultValue=e}evaluate(e){if(e.formattedSection){const i=this.defaultValue.property.overrides;if(i&&i.hasOverride(e.formattedSection))return i.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Mt(Vb,"FormatSectionOverride",{omit:["defaultValue"]});class Nm extends ui{constructor(e,i,s){super(e,Cy,i,s),this._colorAdjustmentMatrix=r.a9.identity([])}recalculate(e,i){super.recalculate(e,i),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const s=this.layout.get("text-writing-mode");if(s){const c=[];for(const h of s)c.indexOf(h)<0&&c.push(h);this.layout._values["text-writing-mode"]=c}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,i,s,c){return this._saturation===e&&this._contrast===i&&this._brightnessMin===s&&this._brightnessMax===c||(this._colorAdjustmentMatrix=function(h,p,y,v){h=up(h),p=_s(p);const T=r.a9.create(),E=h/3,I=1-2*E,P=[I,E,E,0,E,I,E,0,E,E,I,0,0,0,0,1],R=.5-.5*p,L=v-y;return r.a9.multiply(T,[L,0,0,0,0,L,0,0,0,0,L,0,y,y,y,1],[p,0,0,0,0,p,0,0,0,0,p,0,R,R,R,1]),r.a9.multiply(T,T,P),T}(e,i,s,c),this._saturation=e,this._contrast=i,this._brightnessMin=s,this._brightnessMax=c),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,i,s,c){const h=this.layout.get(e).evaluate(i,{},s,c),p=this._unevaluatedLayout._values[e];return p.isDataDriven()||Au(p.value)||!h?h:function(y,v){return v.replace(/{([^{}]+)}/g,(T,E)=>E in y?String(y[E]):"")}(i.properties,h)}createBucket(e){return new Bm(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const e of Cy.paint.overridableProperties){if(!Nm.hasPaintOverride(this.layout,e))continue;const i=this.paint.get(e),s=new Vb(i),c=new Eu(s,i.property.specification,this.scope,this.options);let h=null;h=i.value.kind==="constant"||i.value.kind==="source"?new Yl("source",c):new Ql("composite",c,i.value.zoomStops,i.value._interpolationType),this.paint._values[e]=new Pe(i.property,h,i.parameters)}}_handleOverridablePaintPropertyUpdate(e,i,s){return!(!this.layout||i.isDataDriven()||s.isDataDriven())&&Nm.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,i){const s=e.get("text-field"),c=Cy.paint.properties[i];let h=!1;const p=y=>{for(const v of y)if(c.overrides&&c.overrides.hasOverride(v))return void(h=!0)};if(s.value.kind==="constant"&&s.value.value instanceof mr)p(s.value.value.sections);else if(s.value.kind==="source"){const y=T=>{h||(T instanceof zs&&jn(T.value)===Ta?p(T.value.sections):T instanceof Rl?p(T.sections):T.eachChild(y))},v=s.value;v._styleExpression&&y(v._styleExpression.expression)}return h}getProgramIds(){const e=this.paint.get("icon-opacity").constantOr(1)!==0,i=this.paint.get("text-opacity").constantOr(1)!==0,s=[];return e&&s.push("symbolIcon"),i&&s.push("symbolSDF"),s}getDefaultProgramParams(e,i){return{config:new rc(this,i),overrideFog:!1}}}const rI=new we({visibility:new ge(ae.layout_background.visibility)});var sI={paint:new we({"background-color":new ge(ae.paint_background["background-color"]),"background-pattern":new ge(ae.paint_background["background-pattern"]),"background-opacity":new ge(ae.paint_background["background-opacity"]),"background-emissive-strength":new ge(ae.paint_background["background-emissive-strength"])}),layout:rI};const oI=new we({visibility:new ge(ae.layout_raster.visibility)});var aI={paint:new we({"raster-opacity":new ge(ae.paint_raster["raster-opacity"]),"raster-color":new Ye(ae.paint_raster["raster-color"]),"raster-color-mix":new ge(ae.paint_raster["raster-color-mix"]),"raster-color-range":new ge(ae.paint_raster["raster-color-range"]),"raster-hue-rotate":new ge(ae.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new ge(ae.paint_raster["raster-brightness-min"]),"raster-brightness-max":new ge(ae.paint_raster["raster-brightness-max"]),"raster-saturation":new ge(ae.paint_raster["raster-saturation"]),"raster-contrast":new ge(ae.paint_raster["raster-contrast"]),"raster-resampling":new ge(ae.paint_raster["raster-resampling"]),"raster-fade-duration":new ge(ae.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new ge(ae.paint_raster["raster-emissive-strength"]),"raster-array-band":new ge(ae.paint_raster["raster-array-band"]),"raster-elevation":new ge(ae.paint_raster["raster-elevation"])}),layout:oI},Py=ni([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class Dy{constructor(e,i,s,c){this.context=e,this.format=s,this.texture=e.gl.createTexture(),this.update(i,c)}update(e,i,s){const{width:c,height:h}=e,{context:p}=this,{gl:y}=p;if(y.bindTexture(y.TEXTURE_2D,this.texture),p.pixelStoreUnpackFlipY.set(!1),p.pixelStoreUnpack.set(1),p.pixelStoreUnpackPremultiplyAlpha.set(this.format===y.RGBA&&(!i||i.premultiply!==!1)),s||this.size&&this.size[0]===c&&this.size[1]===h){const{x:v,y:T}=s||{x:0,y:0};if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap)y.texSubImage2D(y.TEXTURE_2D,0,v,T,y.RGBA,y.UNSIGNED_BYTE,e);else{let E=this.format,I=y.UNSIGNED_BYTE;this.format===y.R32F&&(E=y.RED,I=y.FLOAT),y.texSubImage2D(y.TEXTURE_2D,0,v,T,c,h,E,I,e.data)}}else if(this.size=[c,h],e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap){let v=this.format;this.format===y.R8&&(v=y.RED),y.texImage2D(y.TEXTURE_2D,0,this.format,v,y.UNSIGNED_BYTE,e)}else{let v=this.format,T=this.format,E=y.UNSIGNED_BYTE;this.format===y.DEPTH_COMPONENT&&(v=y.DEPTH_COMPONENT16,E=y.UNSIGNED_SHORT),this.format===y.R8&&(T=y.RED),this.format===y.R32F&&(E=y.FLOAT,T=y.RED),y.texImage2D(y.TEXTURE_2D,0,v,c,h,0,T,E,e.data)}this.useMipmap=!!(i&&i.useMipmap),this.useMipmap&&y.generateMipmap(y.TEXTURE_2D)}bind(e,i,s=!1){const{context:c}=this,{gl:h}=c;h.bindTexture(h.TEXTURE_2D,this.texture),e!==this.minFilter&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,e),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,this.useMipmap&&!s?e===h.NEAREST?h.NEAREST_MIPMAP_NEAREST:h.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),i!==this.wrapS&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,i),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,i),this.wrapS=i)}bindExtraParam(e,i,s,c){const{context:h}=this,{gl:p}=h;p.bindTexture(p.TEXTURE_2D,this.texture),i!==this.magFilter&&(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,i),this.magFilter=i),e!==this.minFilter&&(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,this.useMipmap?e===p.NEAREST?p.NEAREST_MIPMAP_NEAREST:p.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),s!==this.wrapS&&(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,s),this.wrapS=s),c!==this.wrapT&&(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,c),this.wrapT=c)}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class Vm{constructor(e,i){this.context=e,this.texture=i}bind(e,i){const{context:s}=this,{gl:c}=s;c.bindTexture(c.TEXTURE_2D,this.texture),e!==this.minFilter&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,e),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,e),this.minFilter=e),i!==this.wrapS&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,i),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,i),this.wrapS=i)}}function Um(t,e,i,s,c,h,p,y){const v=[t,e,1,i,s,1,c,h,1],T=[p,y,1],E=r.ct.adjoint([],v),[I,P,R]=r.Q.transformMat3(T,T,E);return r.ct.multiply(v,v,[I,0,0,0,P,0,0,0,R])}function Ub(t,e,i,s,c,h,p,y){const v=function(T,E,I,P,R,L,B,j){const G=Um(0,0,1,0,1,1,0,1),X=Um(T,E,I,P,R,L,B,j),ie=r.ct.adjoint([],G);return r.ct.multiply(X,X,ie)}(t,e,i,s,c,h,p,y);return[v[2]/v[8]/pt,v[5]/v[8]/pt]}function jm(t){return[t[0],Math.min(Math.max(t[1],-Rn),Rn)]}class jb extends No{constructor(e,i,s,c){super(),this.id=e,this.dispatcher=s,this.coordinates=i.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(c),this.options=i,this._dirty=!1}load(e,i){if(this._loaded=i||!1,this.fire(new mo("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=Fh(this.map._requestManager.transformRequest(this.url,$c.Image),(s,c)=>{this._imageRequest=null,this._loaded=!0,s?this.fire(new nu(s)):c&&(this.image=c instanceof HTMLImageElement?ks.getImageData(c):c,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())})}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Vm(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new mo("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Vm||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let i=e[0][1],s=e[0][1];for(const h of e)h[1]>s&&(s=h[1]),h[1]<i&&(i=h[1]);const c=(s+i)/2;if(c>Rn?this.onNorthPole=!0:c<-Rn&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const h=e.map(Sr.fromLngLat);this.tileID=function(p){let y=1/0,v=1/0,T=-1/0,E=-1/0;for(const B of p)y=Math.min(y,B.x),v=Math.min(v,B.y),T=Math.max(T,B.x),E=Math.max(E,B.y);const I=Math.max(T-y,E-v),P=Math.max(0,Math.floor(-Math.log(I)/Math.LN2)),R=Math.pow(2,P);let L=Math.floor((y+T)/2*R);return L>1&&(L-=1),new oc(P,L,Math.floor((v+E)/2*R))}(h),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new mo("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(const G in this.tiles){const X=this.tiles[G];X.state!=="loaded"&&(X.state="loaded",X.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const i=Nd(new oc(0,0,0),this.map.transform.projection),s=[i.projection.project(this.coordinates[0][0],this.coordinates[0][1]),i.projection.project(this.coordinates[1][0],this.coordinates[1][1]),i.projection.project(this.coordinates[2][0],this.coordinates[2][1]),i.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(G){const X=G[1].x-G[0].x,ie=G[1].y-G[0].y,J=G[2].x-G[1].x,he=G[2].y-G[1].y,re=G[3].x-G[2].x,pe=G[3].y-G[2].y,_e=G[0].x-G[3].x,Se=G[0].y-G[3].y,Le=X*he-J*ie,Ce=J*pe-re*he,Be=re*Se-_e*pe,Fe=_e*ie-X*Se;return Le>0&&Ce>0&&Be>0&&Fe>0||Le<0&&Ce<0&&Be<0&&Fe<0}(s))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const c=Nd(this.tileID,this.map.transform.projection),[h,p,y,v]=this.coordinates.map(G=>{const X=c.projection.project(G[0],G[1]);return zb(c,X)._round()});this.perspectiveTransform=Ub(h.x,h.y,p.x,p.y,y.x,y.y,v.x,v.y);const T=this._boundsArray=new yr;T.emplaceBack(h.x,h.y,0,0),T.emplaceBack(p.x,p.y,pt,0),T.emplaceBack(v.x,v.y,0,pt),T.emplaceBack(y.x,y.y,pt,pt),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(T,Py.members),this.boundsSegments=kn.simpleSegment(0,0,4,2);const E=[],I=[jm((P=this.coordinates)[0]),jm(P[1]),jm(P[2]),jm(P[3])];var P;const[R,L,B,j]=function(G){let X=G[0][0],ie=X,J=G[0][1],he=J;for(let re=1;re<G.length;re++)G[re][0]<X?X=G[re][0]:G[re][0]>ie&&(ie=G[re][0]),G[re][1]<J?J=G[re][1]:G[re][1]>he&&(he=G[re][1]);return[X,J,ie-X,he-J]}(I);{const G=new yr,[X,ie,J,he]=function(Je){let Qe=Je[0].x,Ne=Qe,At=Je[0].y,vt=At;for(let tt=1;tt<Je.length;tt++)Je[tt].x<Qe?Qe=Je[tt].x:Je[tt].x>Ne&&(Ne=Je[tt].x),Je[tt].y<At?At=Je[tt].y:Je[tt].y>vt&&(vt=Je[tt].y);return[Qe,At,Ne-Qe,vt-At]}(s),re=Je=>[(Je.x-X)/J,(Je.y-ie)/he],[pe,_e,Se,Le]=s.map(re),Ce=function(Je,Qe,Ne,At,vt,tt,Gt,kt){const It=Um(0,0,1,0,1,1,0,1),it=Um(Je,Qe,Ne,At,vt,tt,Gt,kt),Nt=r.ct.adjoint([],it);return r.ct.multiply(It,It,Nt)}(pe[0],pe[1],_e[0],_e[1],Se[0],Se[1],Le[0],Le[1]);this.elevatedGlobePerspectiveTransform=Ub(pe[0],pe[1],_e[0],_e[1],Se[0],Se[1],Le[0],Le[1]);const Be=(Je,Qe)=>{E.push(Je.lng);const Ne=Math.round((Je.lng-R)/B*pt),At=Math.round((Je.lat-L)/j*pt),vt=re(Qe),tt=r.Q.transformMat3([],[vt[0],vt[1],1],Ce),Gt=Math.round(tt[0]/tt[2]*pt),kt=Math.round(tt[1]/tt[2]*pt);G.emplaceBack(Ne,At,Gt,kt)},Fe=s[3].x-s[0].x,Oe=s[3].y-s[0].y,Ze=s[2].x-s[1].x,We=s[2].y-s[1].y;for(let Je=0;Je<65;Je++){const Qe=Je/64,Ne=[s[0].x+Qe*Fe,s[0].y+Qe*Oe],At=[s[1].x+Qe*Ze,s[1].y+Qe*We],vt=At[0]-Ne[0],tt=At[1]-Ne[1];for(let Gt=0;Gt<65;Gt++){const kt=Gt/64,It={x:Ne[0]+vt*kt,y:Ne[1]+tt*kt,z:0};Be(i.projection.unproject(It.x,It.y),It)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(G,Py.members)}{this.maxLongitudeTriangleSize=0;let G=[],X=new Kn;const ie=(J,he,re)=>{X.emplaceBack(J,he,re);const pe=E[J],_e=E[he],Se=E[re],Le=Math.min(Math.min(pe,_e),Se),Ce=Math.max(Math.max(pe,_e),Se)-Le;Ce>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=Ce),G.push(Le+Ce/2)};for(let J=0;J<64;J++)for(let he=0;he<64;he++){const re=65*J+he,pe=re+1,_e=re+65,Se=_e+1;ie(re,_e,pe),ie(pe,_e,Se)}[G,X]=function(J,he){const re=Array.from({length:J.length},(Se,Le)=>Le);re.sort((Se,Le)=>J[Se]-J[Le]);const pe=[],_e=new Kn;for(let Se=0;Se<re.length;Se++){const Le=re[Se];pe.push(J[Le]);const Ce=3*Le,Be=Ce+1;_e.emplaceBack(he.uint16[Ce],he.uint16[Be],he.uint16[Be+1])}return[pe,_e]}(G,X),this.elevatedGlobeTrianglesCenterLongitudes=G,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(X)}this.elevatedGlobeSegments=kn.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,B/pt,0,j/pt,0,0,L,R,0])}prepare(){const e=Object.keys(this.tiles).length!==0;if(this.tileID&&!e)return;const i=this.map.painter.context,s=i.gl;!this._dirty||this.texture instanceof Vm||(this.texture?this.texture.update(this.image):(this.texture=new Dy(i,this.image,s.RGBA),this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(i)}loadTile(e,i){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},i(null)):(e.state="errored",i(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){const i=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!i)return null;const s=this.elevatedGlobeTrianglesCenterLongitudes;let c=((E,I)=>E+360*Math.round((I-E)/360))(e+180,s[0]);const h=new kn,p=(E,I)=>{h.segments.push({vertexOffset:0,primitiveOffset:E,vertexLength:i.segments[0].vertexLength,primitiveLength:I,sortKey:void 0,vaos:{}})},y=.51*this.maxLongitudeTriangleSize;if(Math.abs(s[0]-c)<=y){const E=kh(s,0,s.length,c+y);return E===s.length||p(E,Fo(s,E+1,s.length,c+360-y)-E),h}c<s[0]&&(c+=360);const v=Fo(s,0,s.length,c-y);if(v===s.length)return p(0,s.length),h;p(0,v-0);const T=kh(s,v+1,s.length,c+y);return T!==s.length&&p(T,s.length-T),h}}const lI=(Math.pow(256,2)-1)/16907520;class Gb extends ui{constructor(e,i,s){super(e,aI,i,s),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof jb&&(e._source.onNorthPole||e._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;const i=this._transitionablePaint._values["raster-color"].value.expression,[s,c]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(s)&&isNaN(c)||s===this._curRampRange[0]&&c===this._curRampRange[1]||(this.colorRamp=Id({expression:i,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:s,end:c}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[s,c])}}const cI=new we({visibility:new ge(ae["layout_raster-particle"].visibility)});var uI={paint:new we({"raster-particle-array-band":new ge(ae["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new ge(ae["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new Ye(ae["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new ge(ae["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new ge(ae["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new ge(ae["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new ge(ae["paint_raster-particle"]["raster-particle-reset-rate-factor"])}),layout:cI};class Wb extends ui{constructor(e,i,s){super(e,uI,i,s),this._updateColorRamp(),this.lastInvalidatedAt=ks.now()}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){e!=="raster-particle-color"&&e!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),e==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-particle-color"].value.expression,i=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=Id({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:i}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=ks.now()}}class hI extends ui{constructor(e,i){super(e,{},i),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(e){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}const dI=new we({visibility:new ge(ae.layout_sky.visibility)});var fI={paint:new we({"sky-type":new ge(ae.paint_sky["sky-type"]),"sky-atmosphere-sun":new ge(ae.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new ge(ae.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new ge(ae.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new ge(ae.paint_sky["sky-gradient-radius"]),"sky-gradient":new Ye(ae.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new ge(ae.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new ge(ae.paint_sky["sky-atmosphere-color"]),"sky-opacity":new ge(ae.paint_sky["sky-opacity"])}),layout:dI};function ky(t,e,i){const s=[0,0,1],c=r.bl.identity([]);return r.bl.rotateY(c,c,i?-Si(t)+Math.PI:Si(t)),r.bl.rotateX(c,c,-Si(e)),r.Q.transformQuat(s,s,c),r.Q.normalize(s,s)}var pI={paint:new we({})};function qb(t,e){const i=Gm(t.projection,t.zoom,t.width,t.height),s=function(h,p,y,v,T){const E=new Ii(y.lng-180*Xa,y.lat),I=new Ii(y.lng+180*Xa,y.lat),P=h.project(E.lng,E.lat),R=h.project(I.lng,I.lat),L=-Math.atan2(R.y-P.y,R.x-P.x),B=Sr.fromLngLat(y);B.y=xi(B.y,-1+Xa,1-Xa);const j=B.toLngLat(),G=h.project(j.lng,j.lat),X=Sr.fromLngLat(j);X.x+=Xa;const ie=X.toLngLat(),J=h.project(ie.lng,ie.lat),he=$b(J.x-G.x,J.y-G.y,L),re=Sr.fromLngLat(j);re.y+=Xa;const pe=re.toLngLat(),_e=h.project(pe.lng,pe.lat),Se=$b(_e.x-G.x,_e.y-G.y,L),Le=Math.abs(he.x)/Math.abs(Se.y),Ce=r.a9.identity([]);r.a9.rotateZ(Ce,Ce,-L*(1-(T?0:v)));const Be=r.a9.identity([]);return r.a9.scale(Be,Be,[1,1-(1-Le)*v,1]),Be[4]=-Se.x/Se.y*v,r.a9.rotateZ(Be,Be,L),r.a9.multiply(Be,Ce,Be),Be}(t.projection,0,t.center,i,e),c=Hb(t);return r.a9.scale(s,s,[c,c,1]),s}function Hb(t){const e=t.projection,i=Gm(t.projection,t.zoom,t.width,t.height),s=Zb(e,t.center),c=Zb(e,Ii.convert(e.center));return Math.pow(2,s*i+(1-i)*c)}function Gm(t,e,i,s,c=1/0){const h=t.range;if(!h)return 0;const p=Math.min(c,Math.max(i,s)),y=Math.log(p/1024)/Math.LN2;return pl(h[0]+y,h[1]+y,e)}const Xa=1/4e4;function Zb(t,e){const i=xi(e.lat,-Rn,Rn),s=new Ii(e.lng-180*Xa,i),c=new Ii(e.lng+180*Xa,i),h=t.project(s.lng,i),p=t.project(c.lng,i),y=Sr.fromLngLat(s),v=Sr.fromLngLat(c),T=p.x-h.x,E=p.y-h.y,I=v.x-y.x,P=v.y-y.y,R=Math.sqrt((I*I+P*P)/(T*T+E*E));return Math.log(R)/Math.LN2}function $b(t,e,i){const s=Math.cos(i),c=Math.sin(i);return{x:t*s-e*c,y:t*c+e*s}}function Yb(t,e,i){r.a9.identity(t),r.a9.rotateZ(t,t,Si(e[2])),r.a9.rotateX(t,t,Si(e[0])),r.a9.rotateY(t,t,Si(e[1])),r.a9.scale(t,t,i),r.a9.multiply(t,t,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function Wm(t,e,i,s,c,h,p,y){const v=[i[0]-e[0],i[1]-e[1],0],T=[s[0]-e[0],s[1]-e[1],0];if(r.Q.length(v)<1e-12||r.Q.length(T)<1e-12)return r.bl.identity(t);const E=r.Q.cross([],v,T);r.Q.normalize(E,E),r.Q.subtract(T,s,e),v[2]=(h-c)*y,T[2]=(p-c)*y;const I=v;return r.Q.cross(I,v,T),r.Q.normalize(I,I),r.bl.rotationTo(t,E,I)}function Ry(t,e,i=!1){const s=Wa(e.zoom),c=function(h,p,y){const v=p.worldSize,T=[h[12],h[13],h[14]],E=xr(T[1]/v),I=is(T[0]/v),P=r.a9.identity([]),R=Ur(1,E)*v,L=Ur(1,0)*v*ac(E,p.zoom),B=1/ny(v);let j=L*B;if(y){const J=Gm(p.projection,p.zoom,p.width,p.height,1024);j=B*p.projection.pixelSpaceConversion(p.center.lat,v,J)}const G=sc(E,I);r.Q.add(G,G,r.Q.scale([],r.Q.normalize([],G),R*j*T[2]));const X=function(J){const he=[J[0],J[1],J[2]];let re=[0,1,0];const pe=r.Q.cross([],re,he);return r.Q.cross(re,he,pe),r.Q.squaredLength(re)===0&&(re=[0,1,0],r.Q.cross(pe,he,re)),r.Q.normalize(pe,pe),r.Q.normalize(re,re),r.Q.normalize(he,he),[pe[0],pe[1],pe[2],0,re[0],re[1],re[2],0,he[0],he[1],he[2],0,J[0],J[1],J[2],1]}(G);r.a9.scale(P,P,[j,j,j*R]),r.a9.translate(P,P,[-T[0],-T[1],-T[2]]);const ie=r.a9.multiply([],p.globeMatrix,X);return r.a9.multiply(ie,ie,P),r.a9.multiply(ie,ie,h),ie}(t,e,i);if(s>0){const h=function(p,y){const v=y.worldSize,T=Ur(1,0)*v*ac(y.center.lat,y.zoom)/ny(v),E=Ur(1,y.center.lat)*v,I=r.a9.identity([]);return r.a9.rotateY(I,I,Si(y.center.lng)),r.a9.rotateX(I,I,Si(y.center.lat)),r.a9.translate(I,I,[0,0,Vr]),r.a9.scale(I,I,[T,T,T*E]),r.a9.translate(I,I,[y.point.x-.5*v,y.point.y-.5*v,0]),r.a9.multiply(I,I,p),r.a9.multiply(I,y.globeMatrix,I)}(t,e);return function(p,y,v){const T=(L,B,j)=>{const G=r.Q.length(L),X=r.Q.length(B),ie=ea(L,B,j);return r.Q.scale(ie,ie,1/r.Q.length(ie)*hi(G,X,j))},E=T([p[0],p[1],p[2]],[y[0],y[1],y[2]],v),I=T([p[4],p[5],p[6]],[y[4],y[5],y[6]],v),P=T([p[8],p[9],p[10]],[y[8],y[9],y[10]],v),R=ea([p[12],p[13],p[14]],[y[12],y[13],y[14]],v);return[E[0],E[1],E[2],0,I[0],I[1],I[2],0,P[0],P[1],P[2],0,R[0],R[1],R[2],1]}(c,h,s)}return c}function Qb(t,e,i,s){const c=fn.projectAabbCorners(s,i);let h=Number.MAX_VALUE,p=-1;for(let T=0;T<c.length;++T){const E=c[T];E[0]=(.5*E[0]+.5)*e.width,E[1]=(.5-.5*E[1])*e.height,E[2]<h&&(p=T,h=E[2])}const y=T=>new ft(c[T][0],c[T][1]);let v;switch(p){case 0:case 6:v=[y(1),y(5),y(4),y(7),y(3),y(2),y(1)];break;case 1:case 7:v=[y(0),y(4),y(5),y(6),y(2),y(3),y(0)];break;case 3:case 5:v=[y(1),y(0),y(4),y(7),y(6),y(2),y(1)];break;default:v=[y(1),y(5),y(6),y(7),y(3),y(0),y(1)]}if(Zg(t,v))return h}const mI=ni([{name:"a_pos_3f",components:3,type:"Float32"}]),_I=ni([{name:"a_color_3f",components:3,type:"Float32"}]),gI=ni([{name:"a_color_4f",components:4,type:"Float32"}]),yI=ni([{name:"a_uv_2f",components:2,type:"Float32"}]),xI=ni([{name:"a_normal_3f",components:3,type:"Float32"}]),vI=ni([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),bI=ni([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);class qm{constructor(e,i,s,c){this.message=(e?`${e}: `:"")+s,c&&(this.identifier=c),i!=null&&i.__line__&&(this.line=i.__line__)}}function Xb(t,e){const i=t.indexOf("://")===-1;try{return new URL(t,i&&e?"http://example.com":void 0),!0}catch{return!1}}class Kb{constructor(e,i){this.feature=e,this.instancedDataOffset=i,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class Jb{constructor(){this.instancedDataArray=new kg,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class zy{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.projection=e.projection,this.index=e.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1}populate(e,i,s,c){this.tileToMeter=nm(s);const h=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:p,id:y,index:v,sourceLayerIndex:T}of e){const E=y??(p.properties&&p.properties.hasOwnProperty("id")?p.properties.id:void 0),I=Ga(p,h);if(!this.layers[0]._featureFilter.filter(new Y(this.zoom),I,s))continue;const P={id:E,sourceLayerIndex:T,index:v,geometry:h?I.geometry:Jo(p,s,c),properties:p.properties,type:p.type,patterns:{}},R=this.addFeature(P,P.geometry,I);R&&i.featureIndex.insert(p,P.geometry,v,T,this.index,this.instancesPerModel[R].instancedDataArray.length,pt/32)}this.lookup=null}update(e,i,s,c){for(const h in this.instancesPerModel){const p=this.instancesPerModel[h];for(const y in e)p.idToFeaturesIndex.hasOwnProperty(y)&&(this.evaluate(p.features[p.idToFeaturesIndex[y]],e[y],p,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(const i in this.instancesPerModel){const s=this.instancesPerModel[i];for(const c of s.features){const h=this.layers[0],p=c.feature,y=this.canonical,v=h.paint.get("model-rotation").evaluate(p,{},y),T=h.paint.get("model-scale").evaluate(p,{},y),E=h.paint.get("model-translation").evaluate(p,{},y);r.Q.exactEquals(c.rotation,v)&&r.Q.exactEquals(c.scale,T)&&r.Q.exactEquals(c.translation,E)||(this.evaluate(c,c.featureStates,s,!0),e=!0)}}return e}isEmpty(){for(const e in this.instancesPerModel)if(this.instancesPerModel[e].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(const i in this.instancesPerModel){const s=this.instancesPerModel[i];s.instancedDataArray.length<0||s.instancedDataArray.length===0||(s.instancedDataBuffer?s.instancedDataBuffer.updateData(s.instancedDataArray):s.instancedDataBuffer=e.createVertexBuffer(s.instancedDataArray,vI.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const i in this.instancesPerModel){const s=this.instancesPerModel[i];s.instancedDataArray.length!==0&&s.instancedDataBuffer&&s.instancedDataBuffer.destroy()}const e=this.layers[0].modelManager;if(e&&this.modelUris)for(const i of this.modelUris)e.removeModel(i,"")}addFeature(e,i,s){const c=this.layers[0],h=c.layout.get("model-id").evaluate(s,{},this.canonical);if(!h)return wn(`modelId is not evaluated for layer ${c.id} and it is not going to get rendered.`),h;Xb(h,!1)&&(this.modelUris.includes(h)||this.modelUris.push(h)),this.instancesPerModel[h]||(this.instancesPerModel[h]=new Jb);const p=this.instancesPerModel[h],y=p.instancedDataArray,v=new Kb(s,y.length);for(const T of i)for(const E of T){if(E.x<0||E.x>=pt||E.y<0||E.y>=pt)continue;const I=(this.lookupDim-1)/pt,P=this.lookupDim*(E.y*I|0)+E.x*I|0;if(this.lookup){if(this.lookup[P]!==0)continue;this.lookup[P]=1}this.instanceCount++;const R=y.length;y.resize(R+1),p.instancesEvaluatedElevation.push(0),y.float32[16*R]=E.x,y.float32[16*R+1]=E.y}return v.instancedDataCount=p.instancedDataArray.length-v.instancedDataOffset,v.instancedDataCount>0&&(e.id&&(p.idToFeaturesIndex[e.id]=p.features.length),p.features.push(v),this.evaluate(v,{},p,!1)),h}getModelUris(){return this.modelUris}evaluate(e,i,s,c){const h=this.layers[0],p=e.feature,y=this.canonical,v=e.rotation=h.paint.get("model-rotation").evaluate(p,i,y),T=e.scale=h.paint.get("model-scale").evaluate(p,i,y),E=e.translation=h.paint.get("model-translation").evaluate(p,i,y),I=h.paint.get("model-color").evaluate(p,i,y);I.a=h.paint.get("model-color-mix-intensity").evaluate(p,i,y);const P=[];this.maxVerticalOffset<E[2]&&(this.maxVerticalOffset=E[2]),this.maxScale=Math.max(Math.max(this.maxScale,T[0]),Math.max(T[1],T[2])),Yb(P,v,T);const R=Math.round(100*I.a)+I.b/1.05;for(let L=0;L<e.instancedDataCount;++L){const B=e.instancedDataOffset+L,j=16*B,G=s.instancedDataArray.float32;let X=0;c&&(X=G[j+6]-s.instancesEvaluatedElevation[B]);const ie=0|G[j+1];G[j]=(0|G[j])+I.r/1.05,G[j+1]=ie+I.g/1.05,G[j+2]=R,G[j+3]=1/(y.z>10?this.tileToMeter:nm(y,ie)),G[j+4]=E[0],G[j+5]=E[1],G[j+6]=E[2]+X,G[j+7]=P[0],G[j+8]=P[1],G[j+9]=P[2],G[j+10]=P[4],G[j+11]=P[5],G[j+12]=P[6],G[j+13]=P[8],G[j+14]=P[9],G[j+15]=P[10],s.instancesEvaluatedElevation[B]=E[2]}}}Mt(zy,"ModelBucket",{omit:["layers"]}),Mt(Jb,"PerModelAttributes"),Mt(Kb,"ModelFeature");const wI=new we({visibility:new ge(ae.layout_model.visibility),"model-id":new Ae(ae.layout_model["model-id"])});var TI={paint:new we({"model-opacity":new ge(ae.paint_model["model-opacity"]),"model-rotation":new Ae(ae.paint_model["model-rotation"]),"model-scale":new Ae(ae.paint_model["model-scale"]),"model-translation":new Ae(ae.paint_model["model-translation"]),"model-color":new Ae(ae.paint_model["model-color"]),"model-color-mix-intensity":new Ae(ae.paint_model["model-color-mix-intensity"]),"model-type":new ge(ae.paint_model["model-type"]),"model-cast-shadows":new ge(ae.paint_model["model-cast-shadows"]),"model-receive-shadows":new ge(ae.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new ge(ae.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new Ae(ae.paint_model["model-emissive-strength"]),"model-roughness":new Ae(ae.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new Ae(ae.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new ge(ae.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new ge(ae.paint_model["model-front-cutoff"])}),layout:wI};const uc=64,$u={CoordinateSpaceTile:1,CoordinateSpaceYUp:2,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function e1(t,e,i,s,c,h,p,y,v,T=!1){const E=i.zoom,I=i.project(s),P=ac(s.lat,E),R=1/P;r.a9.identity(t),r.a9.translate(t,t,[I.x+p[0]*R,I.y+p[1]*R,p[2]]);let L=1,B=1;const j=i.worldSize;if(T){if(i.projection.name==="mercator"){let J=0;i.elevation&&(J=i.elevation.getAtPointOrZero(new Sr(I.x/j,I.y/j),0));const he=r.aa.transformMat4([],[I.x,I.y,J,1],i.projMatrix)[3]/i.cameraToCenterDistance;L=he,B=he*ac(i.center.lat,E)}else if(i.projection.name==="globe"){const J=Ry(t,i),he=r.a9.multiply([],i.projMatrix,J),re=[0,0,0,1];r.aa.transformMat4(re,re,he);const pe=re[3]/i.cameraToCenterDistance,_e=Wa(E),Se=i.projection.pixelsPerMeter(s.lat,j)*ac(s.lat,E),Le=i.projection.pixelsPerMeter(i.center.lat,j)*ac(i.center.lat,E);L=pe/hi(Se,Ux(i.center.lat),_e),B=pe*P/Se,L*=Le,B*=Le}}else L=R;r.a9.scale(t,t,[L,L,B]);const G=[...t],X=e.orientation,ie=[];if(Yb(ie,[X[0]+c[0],X[1]+c[1],X[2]+c[2]],h),r.a9.multiply(t,G,ie),y&&i.elevation){let J=0;const he=[];if(v&&i.elevation){J=function(_e,Se,Le,Ce,Be){const Fe=Se.elevation;if(!Fe)return 0;const Oe=fn.projectAabbCorners(Le,Ce),Ze=Ur(1,Be.lat)*Se.worldSize,We=function(Nt,ri){const $t=[0,0,1],ci=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const si of ci){const gi=Nt[si.corners[0]],qt=Nt[si.corners[1]],Hi=Nt[si.corners[2]],Wi=[qt[0]-gi[0],qt[1]-gi[1],ri*(qt[2]-gi[2])],Ci=r.Q.cross(Wi,Wi,[Hi[0]-gi[0],Hi[1]-gi[1],ri*(Hi[2]-gi[2])]);r.Q.normalize(Ci,Ci),si.dotProductWithUp=r.Q.dot(Ci,$t)}return ci.sort((si,gi)=>si.dotProductWithUp-gi.dotProductWithUp),ci[0].corners}(Oe,Ze),Je=Oe[We[0]],Qe=Oe[We[1]],Ne=Oe[We[2]],At=Oe[We[3]],vt=Fe.getAtPointOrZero(new Sr(Je[0]/Se.worldSize,Je[1]/Se.worldSize),0),tt=Fe.getAtPointOrZero(new Sr(Qe[0]/Se.worldSize,Qe[1]/Se.worldSize),0),Gt=Fe.getAtPointOrZero(new Sr(Ne[0]/Se.worldSize,Ne[1]/Se.worldSize),0),kt=Fe.getAtPointOrZero(new Sr(At[0]/Se.worldSize,At[1]/Se.worldSize),0),It=(vt+kt)/2,it=(tt+Gt)/2;return It>it?tt<Gt?Wm(_e,Qe,At,Je,tt,kt,vt,Ze):Wm(_e,Ne,Je,At,Gt,vt,kt,Ze):vt<kt?Wm(_e,Je,Qe,Ne,vt,tt,Gt,Ze):Wm(_e,At,Ne,Qe,kt,Gt,tt,Ze),Math.max(It,it)}(he,i,e.aabb,t,s);const re=r.a9.fromQuat([],he),pe=r.a9.multiply([],re,ie);r.a9.multiply(t,G,pe)}else J=i.elevation.getAtPointOrZero(new Sr(I.x/j,I.y/j),0);J!==0&&(t[14]+=J)}}function Wd(t,e,i=!1){t.uploaded||(t.gfxTexture=new Dy(e,t.image,i?e.gl.R8:e.gl.RGBA,{useMipmap:t.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),t.uploaded=!0,t.image=null)}function MI(t,e,i){t.indexBuffer=e.createIndexBuffer(t.indexArray,!1,!0),t.vertexBuffer=e.createVertexBuffer(t.vertexArray,mI.members,!1,!0),t.normalArray&&(t.normalBuffer=e.createVertexBuffer(t.normalArray,xI.members,!1,!0)),t.texcoordArray&&(t.texcoordBuffer=e.createVertexBuffer(t.texcoordArray,yI.members,!1,!0)),t.colorArray&&(t.colorBuffer=e.createVertexBuffer(t.colorArray,(t.colorArray.bytesPerElement===12?_I:gI).members,!1,!0)),t.featureArray&&(t.pbrBuffer=e.createVertexBuffer(t.featureArray,bI.members,!0)),t.segments=kn.simpleSegment(0,0,t.vertexArray.length,t.indexArray.length);const s=t.material;s.pbrMetallicRoughness.baseColorTexture&&Wd(s.pbrMetallicRoughness.baseColorTexture,e),s.pbrMetallicRoughness.metallicRoughnessTexture&&Wd(s.pbrMetallicRoughness.metallicRoughnessTexture,e),s.normalTexture&&Wd(s.normalTexture,e),s.occlusionTexture&&Wd(s.occlusionTexture,e,i),s.emissionTexture&&Wd(s.emissionTexture,e)}function Ly(t,e,i){if(t.meshes)for(const s of t.meshes)MI(s,e,i);if(t.children)for(const s of t.children)Ly(s,e,i)}function Hm(t){if(t.meshes)for(const e of t.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(t.children)for(const e of t.children)Hm(e)}function Oy(t){if(t.meshes)for(const i of t.meshes)i.vertexBuffer&&(i.vertexBuffer.destroy(),i.indexBuffer.destroy(),i.normalBuffer&&i.normalBuffer.destroy(),i.texcoordBuffer&&i.texcoordBuffer.destroy(),i.colorBuffer&&i.colorBuffer.destroy(),i.pbrBuffer&&i.pbrBuffer.destroy(),i.segments.destroy(),i.material&&((e=i.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(t.children)for(const i of t.children)Oy(i)}class SI{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class EI{constructor(){this.tasks={},this.taskQueue=[],Ch(["process"],this),this.invoker=new SI(this.process),this.nextId=0}add(e,i){const s=this.nextId++,c=function({type:h,isSymbolTile:p,zoom:y}){return y=y||0,h==="message"?0:h!=="maybePrepare"||p?h!=="parseTile"||p?h==="parseTile"&&p?300-y:h==="maybePrepare"&&p?400-y:500:200-y:100-y}(i);if(c===0){Zs();try{e()}finally{}return null}return this.tasks[s]={fn:e,metadata:i,priority:c,id:s},this.taskQueue.push(s),this.invoker.trigger(),{cancel:()=>{delete this.tasks[s]}}}process(){Zs();try{if(this.taskQueue=this.taskQueue.filter(s=>!!this.tasks[s]),!this.taskQueue.length)return;const e=this.pick();if(e===null)return;const i=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!i)return;i.fn()}finally{}}pick(){let e=null,i=1/0;for(let c=0;c<this.taskQueue.length;c++){const h=this.tasks[this.taskQueue[c]];h.priority<i&&(i=h.priority,e=c)}if(e===null)return null;const s=this.taskQueue[e];return this.taskQueue.splice(e,1),s}remove(){this.invoker.remove()}}class t1{constructor(e,i,s){this.target=e,this.parent=i,this.mapId=s,this.callbacks={},this.cancelCallbacks={},Ch(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new EI}send(e,i,s,c,h=!1,p){const y=Math.round(1e18*Math.random()).toString(36).substring(0,10);s&&(s.metadata=p,this.callbacks[y]=s);const v=new Set;return this.target.postMessage({id:y,type:e,hasCallback:!!s,targetMapId:c,mustQueue:h,sourceMapId:this.mapId,data:Kl(i,v)},v),{cancel:()=>{s&&delete this.callbacks[y],this.target.postMessage({id:y,type:"<cancel>",targetMapId:c,sourceMapId:this.mapId})}}}receive(e){const i=e.data,s=i.id;if(s&&(!i.targetMapId||this.mapId===i.targetMapId))if(i.type==="<cancel>"){const c=this.cancelCallbacks[s];delete this.cancelCallbacks[s],c&&c.cancel()}else if(i.mustQueue||Zs()){const c=this.callbacks[s],h=this.scheduler.add(()=>this.processTask(s,i),c&&c.metadata||{type:"message"});h&&(this.cancelCallbacks[s]=h)}else this.processTask(s,i)}processTask(e,i){if(delete this.cancelCallbacks[e],i.type==="<response>"){const s=this.callbacks[e];delete this.callbacks[e],s&&(i.error?s(d(i.error)):s(null,d(i.data)))}else{const s=new Set,c=i.hasCallback?(p,y)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:p?Kl(p):null,data:Kl(y,s)},s)}:p=>{},h=d(i.data);if(this.parent[i.type])this.parent[i.type](i.sourceMapId,h,c);else if(this.parent.getWorkerSource){const p=i.type.split(".");this.parent.getWorkerSource(i.sourceMapId,p[0],h.source,h.scope)[p[1]](h,c)}else c(new Error(`Could not find function ${i.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}class Yu{constructor(e,i){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=Di();const s=this.workerPool.acquire(this.id);for(let c=0;c<s.length;c++){const h=new Yu.Actor(s[c],i,this.id);h.name=`Worker ${c}`,this.actors.push(h)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(e,i,s){Ah(this.actors,(c,h)=>{c.send(e,i,h)},s=s||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(e=>{e.remove()}),this.actors=[],this.workerPool.release(this.id)}}Yu.Actor=t1;var qd={workerUrl:"",workerClass:null,workerParams:void 0};function AI(){return qd.workerClass!=null?new qd.workerClass:new self.Worker(qd.workerUrl,qd.workerParams)}const Fy="mapboxgl_preloaded_worker_pool";class Hd{constructor(){this.active={}}acquire(e){if(!this.workers)for(this.workers=[];this.workers.length<Hd.workerCount;)this.workers.push(new AI);return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],this.workers&&this.numActive()===0&&(this.workers.forEach(i=>{i.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[Fy]}numActive(){return Object.keys(this.active).length}}let Zd;function Zm(){return Zd||(Zd=new Hd),Zd}Hd.workerCount=2;let $m,By,io,Qu,Ny,Xu=null;function i1(){return Zs()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:By||N.DRACO_URL}function n1(){if(Zs()&&self.worker&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(Qu)return Qu;const t=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return Qu=WebAssembly.validate(t)?N.MESHOPT_SIMD_URL:N.MESHOPT_URL,Qu}const Ym={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},II={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},$d={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function r1(t,e,i){const s=i.json.bufferViews.length,c=i.buffers.length;e.bufferView=s,i.json.bufferViews[s]={buffer:c,byteLength:t.byteLength},i.buffers[c]=t}const Vy="KHR_draco_mesh_compression";function CI(t,e){const i=t.extensions&&t.extensions[Vy];if(!i)return;const s=new io.Decoder,c=l1(e,i.bufferView),h=new io.Mesh;if(!s.DecodeArrayToMesh(c,c.byteLength,h))throw new Error("Failed to decode Draco mesh");const p=e.json.accessors[t.indices],y=Ym[p.componentType],v=p.count*y.BYTES_PER_ELEMENT,T=io._malloc(v);y===Uint16Array?s.GetTrianglesUInt16Array(h,v,T):s.GetTrianglesUInt32Array(h,v,T),r1(io.memory.buffer.slice(T,T+v),p,e),io._free(T);for(const E of Object.keys(i.attributes)){const I=s.GetAttributeByUniqueId(h,i.attributes[E]),P=e.json.accessors[t.attributes[E]],R=II[P.componentType],L=P.count*$d[P.type]*Ym[P.componentType].BYTES_PER_ELEMENT,B=io._malloc(L);s.GetAttributeDataArrayForAllPoints(h,I,io[R],L,B),r1(io.memory.buffer.slice(B,B+L),P,e),io._free(B)}s.destroy(),h.destroy(),delete t.extensions[Vy]}const Qm="EXT_meshopt_compression";function PI(t,e){if(!t.extensions||!t.extensions[Qm])return;const i=t.extensions[Qm],s=new Uint8Array(e.buffers[i.buffer],i.byteOffset||0,i.byteLength||0),c=new Uint8Array(i.count*i.byteStride);Ny.decodeGltfBuffer(c,i.count,i.byteStride,s,i.mode,i.filter),t.buffer=e.buffers.length,t.byteOffset=0,e.buffers[t.buffer]=c.buffer,delete t.extensions[Qm]}const s1=1179937895,o1=new TextDecoder("utf8");function a1(t,e){return new URL(t,e).href}function DI(t,e,i,s){return fetch(a1(t.uri,s)).then(c=>c.arrayBuffer()).then(c=>{e.buffers[i]=c})}function l1(t,e){const i=t.json.bufferViews[e];return new Uint8Array(t.buffers[i.buffer],i.byteOffset||0,i.byteLength)}function kI(t,e,i,s){if(t.uri){const c=a1(t.uri,s);return fetch(c).then(h=>h.blob()).then(h=>createImageBitmap(h)).then(h=>{e.images[i]=h})}if(t.bufferView!==void 0){const c=l1(e,t.bufferView),h=new Blob([c],{type:t.mimeType});return createImageBitmap(h).then(p=>{e.images[i]=p})}}function c1(t,e=0,i){const s={json:null,images:[],buffers:[]};if(new Uint32Array(t,e,1)[0]===s1){const E=new Uint32Array(t,e);let I=2;const P=(E[I++]>>2)-3,R=E[I++]>>2;if(I++,s.json=JSON.parse(o1.decode(E.subarray(I,I+R))),I+=R,I<P){const L=E[I++];I++;const B=e+(I<<2);s.buffers[0]=t.slice(B,B+L)}}else s.json=JSON.parse(o1.decode(new Uint8Array(t,e)));const{buffers:c,images:h,meshes:p,extensionsUsed:y,bufferViews:v}=s.json;let T=Promise.resolve();if(c){const E=[];for(let I=0;I<c.length;I++){const P=c[I];P.uri?E.push(DI(P,s,I,i)):s.buffers[I]||(s.buffers[I]=null)}T=Promise.all(E)}return T.then(()=>{const E=[],I=y&&y.includes(Vy),P=y&&y.includes(Qm);if(I&&E.push(function(){if(!io)return $m||($m=function(R){let L,B=null;function j(){L=new Uint8Array(B.buffer)}function G(){throw new Error("Unexpected Draco error.")}const X={a:{a:G,d:function(ie,J,he){return L.copyWithin(ie,J,J+he)},c:function(ie){const J=L.length,he=Math.max(ie>>>0,Math.ceil(1.2*J)),re=Math.ceil((he-J)/65536);try{return B.grow(re),j(),!0}catch{return!1}},b:G}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(R,X):R.then(ie=>ie.arrayBuffer()).then(ie=>WebAssembly.instantiate(ie,X))).then(ie=>{const{Rb:J,Qb:he,P:re,T:pe,X:_e,Ja:Se,La:Le,Qa:Ce,Va:Be,Wa:Fe,eb:Oe,jb:Ze,f:We,e:Je,yb:Qe,zb:Ne,Ab:At,Bb:vt,Db:tt,Gb:Gt}=ie.instance.exports;B=Je;const kt=(()=>{let It=0,it=0,Nt=0,ri=0;return $t=>{Nt&&(J(ri),J(It),it+=Nt,Nt=It=0),It||(it+=128,It=he(it));const ci=$t.length+7&-8;let si=It;ci>=it&&(Nt=ci,si=ri=he(ci));for(let gi=0;gi<$t.length;gi++)L[si+gi]=$t[gi];return si}})();return j(),We(),{memory:Je,_free:J,_malloc:he,Mesh:class{constructor(){this.ptr=re()}destroy(){pe(this.ptr)}},Decoder:class{constructor(){this.ptr=Se()}destroy(){Ze(this.ptr)}DecodeArrayToMesh(It,it,Nt){const ri=kt(It),$t=Le(this.ptr,ri,it,Nt.ptr);return!!_e($t)}GetAttributeByUniqueId(It,it){return{ptr:Ce(this.ptr,It.ptr,it)}}GetTrianglesUInt16Array(It,it,Nt){Be(this.ptr,It.ptr,it,Nt)}GetTrianglesUInt32Array(It,it,Nt){Fe(this.ptr,It.ptr,it,Nt)}GetAttributeDataArrayForAllPoints(It,it,Nt,ri,$t){Oe(this.ptr,It.ptr,it.ptr,Nt,ri,$t)}},DT_INT8:Qe(),DT_UINT8:Ne(),DT_INT16:At(),DT_UINT16:vt(),DT_UINT32:tt(),DT_FLOAT32:Gt()}})}(fetch(i1())),$m.then(R=>{io=R,$m=void 0}))}()),P&&E.push(function(){if(Ny)return;const R=function(L){let B;const j=WebAssembly.instantiateStreaming(L,{}).then(ie=>{B=ie.instance,B.exports.__wasm_call_ctors()}),G={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},X={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:j,supported:!0,decodeGltfBuffer(ie,J,he,re,pe,_e){(function(Se,Le,Ce,Be,Fe,Oe,Ze){const We=Se.exports.sbrk,Je=Be+3&-4,Qe=We(Je*Fe),Ne=We(Oe.length),At=new Uint8Array(Se.exports.memory.buffer);At.set(Oe,Ne);const vt=Le(Qe,Be,Fe,Ne,Oe.length);if(vt===0&&Ze&&Ze(Qe,Je,Fe),Ce.set(At.subarray(Qe,Qe+Be*Fe)),We(Qe-We(0)),vt!==0)throw new Error(`Malformed buffer data: ${vt}`)})(B,B.exports[X[pe]],ie,J,he,re,B.exports[G[_e]])}}}(fetch(n1()));return R.ready.then(()=>{Ny=R})}()),h)for(let R=0;R<h.length;R++)E.push(kI(h[R],s,R,i));return(E.length?Promise.all(E):Promise.resolve()).then(()=>{if(I&&p)for(const{primitives:R}of p)for(const L of R)CI(L,s);if(P&&p&&v)for(const R of v)PI(R,s);return s})})}class u1{constructor(e,i,s,c){if(this.triangleCount=i.length/3,this.min=new ft(0,0),this.max=new ft(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||e.length===0)return;const[h,p]=[e[0].clone(),e[0].clone()];for(let I=1;I<e.length;++I){const P=e[I];h.x=Math.min(h.x,P.x),h.y=Math.min(h.y,P.y),p.x=Math.max(p.x,P.x),p.y=Math.max(p.y,P.y)}if(c){const I=Math.ceil(Math.max(p.x-h.x,p.y-h.y)/c);s=Math.max(s,I)}if(s===0)return;this.min=h,this.max=p;const y=this.max.sub(this.min);y.x=Math.max(y.x,1),y.y=Math.max(y.y,1);const v=Math.max(y.x,y.y)/s;this.cellsX=Math.max(1,Math.ceil(y.x/v)),this.cellsY=Math.max(1,Math.ceil(y.y/v)),this.xScale=1/v,this.yScale=1/v;const T=[];for(let I=0;I<this.triangleCount;I++){const P=e[i[3*I+0]].sub(this.min),R=e[i[3*I+1]].sub(this.min),L=e[i[3*I+2]].sub(this.min),B=Ka(Math.floor(Math.min(P.x,R.x,L.x)),this.xScale,this.cellsX),j=Ka(Math.floor(Math.max(P.x,R.x,L.x)),this.xScale,this.cellsX),G=Ka(Math.floor(Math.min(P.y,R.y,L.y)),this.yScale,this.cellsY),X=Ka(Math.floor(Math.max(P.y,R.y,L.y)),this.yScale,this.cellsY),ie=new ft(0,0),J=new ft(0,0),he=new ft(0,0),re=new ft(0,0);for(let pe=G;pe<=X;++pe){ie.y=J.y=pe*v,he.y=re.y=(pe+1)*v;for(let _e=B;_e<=j;++_e)ie.x=he.x=_e*v,J.x=re.x=(_e+1)*v,(Qg(P,R,L,ie,J,re)||Qg(P,R,L,ie,re,he))&&T.push({cellIdx:pe*this.cellsX+_e,triIdx:I})}}if(T.length===0)return;T.sort((I,P)=>I.cellIdx-P.cellIdx||I.triIdx-P.triIdx);let E=0;for(;E<T.length;){const I=T[E].cellIdx,P={start:this.payload.length,len:0};for(;E<T.length&&T[E].cellIdx===I;)++P.len,this.payload.push(T[E++].triIdx);this.cells[I]=P}}query(e,i,s){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>i.x||e.y>this.max.y||this.min.y>i.y)return;this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8)));for(let v=0;v<this.lookup.length;v++)this.lookup[v]=0;const c=Ka(e.x-this.min.x,this.xScale,this.cellsX),h=Ka(i.x-this.min.x,this.xScale,this.cellsX),p=Ka(e.y-this.min.y,this.yScale,this.cellsY),y=Ka(i.y-this.min.y,this.yScale,this.cellsY);for(let v=p;v<=y;v++)for(let T=c;T<=h;T++){const E=this.cells[v*this.cellsX+T];if(E)for(let I=0;I<E.len;I++){const P=this.payload[E.start+I],R=Math.floor(P/8),L=1<<P%8;if(!(this.lookup[R]&L)&&(this.lookup[R]|=L,s.push(P),s.length===this.triangleCount))return}}}}function Ka(t,e,i){return Math.max(0,Math.min(i-1,Math.floor(t*e)))}function hc(t,e){const i=t.json.bufferViews[e.bufferView],s=Ym[e.componentType];return new s(t.buffers[i.buffer],(e.byteOffset||0)+(i.byteOffset||0),e.count*(i.byteStride&&i.byteStride!==$d[e.type]*s.BYTES_PER_ELEMENT?i.byteStride/s.BYTES_PER_ELEMENT:$d[e.type]))}function Uy(t,e,i,s){const c=Ym[e.componentType],h=function(E){switch(E){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(c),p=t.json.bufferViews[e.bufferView],y=p.byteStride?p.byteStride/c.BYTES_PER_ELEMENT:$d[e.type],v=i.float32,T=v.length/i.capacity;for(let E=0,I=0;E<e.count*y;E+=y,I+=T)for(let P=0;P<T;P++)v[I+P]=s[E+P]*h;i._trim()}function RI(t,e,i){const s=t.indices,c=t.attributes,h={};h.indexArray=new Kn;const p=e.json.accessors[s],y=p.count/3;h.indexArray.reserve(y);const v=hc(e,p);for(let P=0;P<y;P++)h.indexArray.emplaceBack(v[3*P],v[3*P+1],v[3*P+2]);h.indexArray._trim(),h.vertexArray=new nc;const T=e.json.accessors[c.POSITION];h.vertexArray.reserve(T.count);const E=hc(e,T);for(let P=0;P<T.count;P++)h.vertexArray.emplaceBack(E[3*P],E[3*P+1],E[3*P+2]);if(h.vertexArray._trim(),h.aabb=new fn(T.min,T.max),h.centroid=function(P,R){const L=[0,0,0],B=P.length;if(B>0){for(let j=0;j<B;j++){const G=3*P[j];L[0]+=R[G],L[1]+=R[G+1],L[2]+=R[G+2]}L[0]/=B,L[1]/=B,L[2]/=B}return L}(v,E),c.COLOR_0!==void 0){const P=e.json.accessors[c.COLOR_0],R=$d[P.type],L=hc(e,P);h.colorArray=R===3?new nc:new Xn,h.colorArray.resize(P.count),Uy(e,P,h.colorArray,L)}if(c.NORMAL!==void 0){h.normalArray=new nc;const P=e.json.accessors[c.NORMAL];h.normalArray.resize(P.count);const R=hc(e,P);Uy(e,P,h.normalArray,R)}if(c.TEXCOORD_0!==void 0&&i.length>0){h.texcoordArray=new cr;const P=e.json.accessors[c.TEXCOORD_0];h.texcoordArray.resize(P.count);const R=hc(e,P);Uy(e,P,h.texcoordArray,R)}if(c._FEATURE_ID_RGBA4444!==void 0){const P=e.json.accessors[c._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(h.featureData=hc(e,P))}c._FEATURE_RGBA4444!==void 0&&(h.featureData=new Uint32Array(hc(e,e.json.accessors[c._FEATURE_RGBA4444]).buffer));const I=t.material;return h.material=function(P,R){const{emissiveFactor:L=[0,0,0],alphaMode:B="OPAQUE",alphaCutoff:j=.5,normalTexture:G,occlusionTexture:X,emissiveTexture:ie,doubleSided:J}=P,{baseColorFactor:he=[1,1,1,1],metallicFactor:re=1,roughnessFactor:pe=1,baseColorTexture:_e,metallicRoughnessTexture:Se}=P.pbrMetallicRoughness||{},Le=X?R[X.index]:void 0;if(X&&X.extensions&&X.extensions.KHR_texture_transform&&Le){const Ce=X.extensions.KHR_texture_transform;Le.offsetScale=[Ce.offset[0],Ce.offset[1],Ce.scale[0],Ce.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new Bi(...he),metallicFactor:re,roughnessFactor:pe,baseColorTexture:_e?R[_e.index]:void 0,metallicRoughnessTexture:Se?R[Se.index]:void 0},doubleSided:J,emissiveFactor:L,alphaMode:B,alphaCutoff:j,normalTexture:G?R[G.index]:void 0,occlusionTexture:Le,emissionTexture:ie?R[ie.index]:void 0,defined:P.defined===void 0}}(I!==void 0?e.json.materials[I]:{defined:!1},i),h}function h1(t,e,i){const{matrix:s,rotation:c,translation:h,scale:p,mesh:y,extras:v,children:T}=t,E={};if(E.matrix=s||r.a9.fromRotationTranslationScale([],c||[0,0,0,1],h||[0,0,0],p||[1,1,1]),y!==void 0){E.meshes=i[y];const I=E.anchor=[0,0];for(const P of E.meshes){const{min:R,max:L}=P.aabb;I[0]+=R[0]+L[0],I[1]+=R[1]+L[1]}I[0]=Math.floor(I[0]/E.meshes.length/2),I[1]=Math.floor(I[1]/E.meshes.length/2)}if(v&&(v.id&&(E.id=v.id),v.lights&&(E.lights=function(I){if(!I.length)return[];const P=function(G){const X=atob(G),ie=new Uint8Array(X.length);for(let J=0;J<X.length;J++)ie[J]=X.codePointAt(J);return ie}(I),R=[],L=P.length/24,B=new Uint16Array(P.buffer),j=new Float32Array(P.buffer);for(let G=0;G<L;G++){const X=B[2*G*6]/30,ie=B[2*G*6+1]/30,J=B[2*G*6+10]/100,he=j[6*G+1],re=j[6*G+2],pe=j[6*G+3],_e=j[6*G+4],Se=pe-he,Le=_e-re,Ce=Math.hypot(Se,Le);R.push({pos:[he+.5*Se,re+.5*Le,ie],normal:[Le/Ce,-Se/Ce,0],width:Ce,height:X,depth:J,points:[he,re,pe,_e]})}return R}(v.lights))),T){const I=[];for(const P of T)I.push(h1(e.json.nodes[P],e,i));E.children=I}return E}function zI(t){if(t.vertices.length===0||t.indices.length===0)return null;const e=new u1(t.vertices,t.indices,8,256),[i,s]=[e.min.clone(),e.max.clone()];return{vertices:t.vertices,indices:t.indices,grid:e,min:i,max:s}}function LI(t){if(!t.extras||!t.extras.ground)return null;const e=t.extras.ground;if(!e||!Array.isArray(e)||e.length===0)return null;const i=e[0];if(!i||!Array.isArray(i)||i.length===0)return null;const s=[];for(const p of i){if(!Array.isArray(p)||p.length!==2)continue;const y=p[0],v=p[1];typeof y=="number"&&typeof v=="number"&&s.push(new ft(y,v))}if(s.length<3)return null;s.length>1&&s[s.length-1].equals(s[0])&&s.pop();let c=0;for(let p=0;p<s.length;p++){const y=s[p],v=s[(p+1)%s.length],T=s[(p+2)%s.length];c+=(y.x-v.x)*(T.y-v.y)-(T.x-v.x)*(y.y-v.y)}c>0&&s.reverse();const h=_m(s.flatMap(p=>[p.x,p.y]),[]);return h.length===0?null:{vertices:s,indices:h}}function OI(t,e){const i=[],s=[];let c=0;const h=[];for(const p of t){c=i.length;const y=p.vertexArray.float32,v=p.indexArray.uint16;for(let T=0;T<p.vertexArray.length;T++)h[0]=y[3*T+0],h[1]=y[3*T+1],h[2]=y[3*T+2],r.Q.transformMat4(h,h,e),i.push(new ft(h[0],h[1]));for(let T=0;T<3*p.indexArray.length;T++)s.push(v[T]+c)}if(s.length%3!=0)return null;for(let p=0;p<s.length;p+=3){const y=i[s[p+0]],v=i[s[p+1]],T=i[s[p+2]];(y.x-v.x)*(T.y-v.y)-(T.x-v.x)*(y.y-v.y)>0&&([s[p+1],s[p+2]]=[s[p+2],s[p+1]])}return{vertices:i,indices:s}}function d1(t){const e=function(v,T){const E=[],I=WebGL2RenderingContext;if(v.json.textures)for(const P of v.json.textures){const R={magFilter:I.LINEAR,minFilter:I.NEAREST,wrapS:I.REPEAT,wrapT:I.REPEAT};P.sampler!==void 0&&Object.assign(R,v.json.samplers[P.sampler]),E.push({image:T[P.source],sampler:R,uploaded:!1})}return E}(t,t.images),i=function(v,T){const E=[];for(const I of v.json.meshes){const P=[];for(const R of I.primitives)P.push(RI(R,v,T));E.push(P)}return E}(t,e),{scenes:s,scene:c,nodes:h}=t.json,p=s?s[c||0].nodes:h,y=[];for(const v of p)y.push(h1(h[v],t,i));return function(v,T,E){const I={},P=new Set;for(let R=0;R<v.length;R++){const L=E[T[R]];if(!L.extras)continue;const B=L.extras["mapbox:footprint:version"],j=L.extras["mapbox:footprint:id"];(B||j)&&P.add(R),B==="1.0.0"&&j&&(I[j]=R)}for(let R=0;R<v.length;R++){if(P.has(R))continue;const L=v[R],B=E[T[R]];if(!B.extras)continue;let j=null;L.id in I&&(j=OI(v[I[L.id]].meshes,L.matrix)),j||(j=LI(B)),j&&(L.footprint=zI(j))}if(P.size>0){const R=Array.from(P.values()).sort((L,B)=>L-B);for(let L=R.length-1;L>=0;L--)v.splice(R[L],1)}}(y,p,t.json.nodes),y}function FI(t){t.heightmap=new Float32Array(4096),t.heightmap.fill(-1);const e=t.vertexArray.float32,i=t.aabb.min[0]-1,s=t.aabb.min[1]-1,c=uc/(t.aabb.max[0]-i+2),h=uc/(t.aabb.max[1]-s+2);for(let p=0;p<e.length;p+=3){const y=e[p+2],v=(e[p+0]-i)*c|0,T=(e[p+1]-s)*h|0;y>t.heightmap[T*uc+v]&&(t.heightmap[T*uc+v]=y)}}function BI(t,e){const i={};i.indexArray=new Kn,i.indexArray.reserve(4*t.length),i.vertexArray=new nc,i.vertexArray.reserve(10*t.length),i.colorArray=new Xn,i.vertexArray.reserve(10*t.length);let s=0;for(const p of t){const y=Math.min(10,Math.max(4,1.3*p.height))*e,v=[-p.normal[1],p.normal[0],0],T=Math.min(.29,.1*p.width/p.depth),E=p.width-2*p.depth*e*(T+.01),I=r.Q.scaleAndAdd([],p.pos,v,E/2),P=r.Q.scaleAndAdd([],p.pos,v,-E/2),R=[I[0],I[1],I[2]+p.height],L=[P[0],P[1],P[2]+p.height],B=r.Q.scaleAndAdd([],p.normal,v,T);r.Q.scale(B,B,y);const j=r.Q.scaleAndAdd([],p.normal,v,-T);r.Q.scale(j,j,y),r.Q.add(B,I,B),r.Q.add(j,P,j),I[2]+=.1,P[2]+=.1,i.vertexArray.emplaceBack(B[0],B[1],B[2]),i.vertexArray.emplaceBack(j[0],j[1],j[2]),i.vertexArray.emplaceBack(I[0],I[1],I[2]),i.vertexArray.emplaceBack(P[0],P[1],P[2]),i.vertexArray.emplaceBack(R[0],R[1],R[2]),i.vertexArray.emplaceBack(L[0],L[1],L[2]),i.vertexArray.emplaceBack(I[0],I[1],I[2]),i.vertexArray.emplaceBack(P[0],P[1],P[2]),i.vertexArray.emplaceBack(B[0],B[1],B[2]),i.vertexArray.emplaceBack(j[0],j[1],j[2]);const G=E/y/2;i.colorArray.emplaceBack(-G-T,-1,G,.8),i.colorArray.emplaceBack(G+T,-1,G,.8),i.colorArray.emplaceBack(-G,0,G,1.3),i.colorArray.emplaceBack(G,0,G,1.3),i.colorArray.emplaceBack(G+T,-.8,G,.7),i.colorArray.emplaceBack(G+T,-.8,G,.7),i.colorArray.emplaceBack(0,0,G,1.3),i.colorArray.emplaceBack(0,0,G,1.3),i.colorArray.emplaceBack(G+T,-1.2,G,.8),i.colorArray.emplaceBack(G+T,-1.2,G,.8),i.indexArray.emplaceBack(6+s,4+s,8+s),i.indexArray.emplaceBack(7+s,9+s,5+s),i.indexArray.emplaceBack(0+s,1+s,2+s),i.indexArray.emplaceBack(1+s,3+s,2+s),s+=10}const c={defined:!0,emissiveFactor:[0,0,0]},h={};return h.baseColorFactor=Bi.white,c.pbrMetallicRoughness=h,i.material=c,i.aabb=new fn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),i}Mt(u1,"TriangleGridIndex");class f1{constructor(e){this._stringToNumber={},this._numberToString=[];for(let i=0;i<e.length;i++){const s=e[i];this._stringToNumber[s]=i,this._numberToString[i]=s}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}const NI=["tile","layer","source","sourceLayer","state"];class p1{constructor(e,i,s,c,h){this.type="Feature",this._vectorTileFeature=e,this._z=i,this._x=s,this._y=c,this.properties=e.properties,this.id=h}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};this.id!==void 0&&(e.id=this.id);for(const i of NI)this[i]!==void 0&&(e[i]=this[i]);return e}}class m1{constructor(e,i){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new Oa(pt,16,0),this.featureIndexArray=new Px,this.promoteId=i,this.is3DTile=!1}insert(e,i,s,c,h,p=0,y=0){const v=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(s,c,h,p);const T=this.grid;for(let E=0;E<i.length;E++){const I=i[E],P=[1/0,1/0,-1/0,-1/0];for(let R=0;R<I.length;R++){const L=I[R];P[0]=Math.min(P[0],L.x),P[1]=Math.min(P[1],L.y),P[2]=Math.max(P[2],L.x),P[3]=Math.max(P[3],L.y)}y!==0&&(P[0]-=y,P[1]-=y,P[2]+=y,P[3]+=y),P[0]<pt&&P[1]<pt&&P[2]>=0&&P[3]>=0&&T.insert(v,P[0],P[1],P[2],P[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new py(new Gu(this.rawTileData)).layers,this.sourceLayerCoder=new f1(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,i,s,c){this.loadVTLayers();const h=e.params||{},p=gt(h.filter),y=e.tileResult,v=e.transform,T=y.bufferedTilespaceBounds,E=this.grid.query(T.min.x,T.min.y,T.max.x,T.max.y,(L,B,j,G)=>$x(y.bufferedTilespaceGeometry,L,B,j,G));E.sort(VI);let I=null;v.elevation&&E.length>0&&(I=Bu.create(v.elevation,this.tileID));const P={};let R;for(let L=0;L<E.length;L++){const B=E[L];if(B===R)continue;R=B;const j=this.featureIndexArray.get(B);let G=null;if(this.is3DTile){const X=this.bucketLayerIDs[0][0],ie=i[X];if(ie.type!=="model")continue;const{queryFeature:J,intersectionZ:he}=ie.queryIntersectsMatchingFeature(y,j.featureIndex,p,v);J&&this.appendToResult(P,X,j.featureIndex,J,he)}else this.loadMatchingFeature(P,j,p,h.layers,h.availableImages,i,s,c,(X,ie,J,he=0)=>(G||(G=Jo(X,this.tileID.canonical,e.tileTransform)),ie.queryIntersectsFeature(y,X,J,G,this.z,e.transform,e.pixelPosMatrix,I,he)))}return P}loadMatchingFeature(e,i,s,c,h,p,y,v,T){const{featureIndex:E,bucketIndex:I,sourceLayerIndex:P,layoutVertexArrayOffset:R}=i,L=this.bucketLayerIDs[I];if(c&&!function(X,ie){for(let J=0;J<X.length;J++)if(ie.indexOf(X[J])>=0)return!0;return!1}(c,L))return;const B=this.sourceLayerCoder.decode(P),j=this.vtLayers[B].feature(E);if(s.needGeometry){const X=Ga(j,!0);if(!s.filter(new Y(this.tileID.overscaledZ),X,this.tileID.canonical))return}else if(!s.filter(new Y(this.tileID.overscaledZ),j))return;const G=this.getId(j,B);for(let X=0;X<L.length;X++){const ie=L[X];if(c&&c.indexOf(ie)<0)continue;const J=p[ie];if(!J)continue;let he={};G!==void 0&&v&&(he=v.getState(J.sourceLayer||"_geojsonTileLayer",G));const re=!T||T(j,J,he,R);if(!re)continue;const pe=new p1(j,this.z,this.x,this.y,G),_e=Jr({},y[ie]);_e.paint=_1(_e.paint,J.paint,j,he,h),_e.layout=_1(_e.layout,J.layout,j,he,h),pe.layer=_e,this.appendToResult(e,ie,E,pe,re)}}appendToResult(e,i,s,c,h){let p=e[i];p===void 0&&(p=e[i]=[]),p.push({featureIndex:s,feature:c,intersectionZ:h})}lookupSymbolFeatures(e,i,s,c,h,p,y,v){const T={};this.loadVTLayers();const E=gt(h);for(const I of e)this.loadMatchingFeature(T,{bucketIndex:s,sourceLayerIndex:c,featureIndex:I,layoutVertexArrayOffset:0},E,p,y,v,i);return T}loadFeature(e){const{featureIndex:i,sourceLayerIndex:s}=e;this.loadVTLayers();const c=this.sourceLayerCoder.decode(s),h=this.vtFeatures[c];if(h[i])return h[i];const p=this.vtLayers[c].feature(i);return h[i]=p,p}hasLayer(e){for(const i of this.bucketLayerIDs)for(const s of i)if(e===s)return!0;return!1}getId(e,i){let s=e.id;if(this.promoteId){const c=typeof this.promoteId=="string"?this.promoteId:this.promoteId[i];c!=null&&(s=e.properties[c]),typeof s=="boolean"&&(s=Number(s))}return s}}function _1(t,e,i,s,c){return pa(t,(h,p)=>{const y=e instanceof ze?e.get(p):null;return y&&y.evaluate?y.evaluate(i,s,c):y})}function VI(t,e){return e-t}Mt(m1,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const jy=new Float32Array(262144),dc=new Uint8Array(262144);function g1(t){let e=0;if(t.meshes)for(const i of t.meshes)e=Math.max(e,i.aabb.max[2]);if(t.children)for(const i of t.children)e=Math.max(e,g1(i));return e}function y1(t,e,i){if(t.meshes)for(const s of t.meshes)s.aabb.min[0]!==1/0&&i.insert(e,s.aabb.min[0],s.aabb.min[1],s.aabb.max[0],s.aabb.max[1]);if(t.children)for(const s of t.children)y1(s,e,i)}const x1=["","wall","door","roof","window","lamp","logo"];class v1{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.feature={type:"Point",id:e.id,geometry:[],properties:{height:g1(e)}}}getLocalBounds(){if(!this.node.meshes)return new fn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0;const i=new fn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const s of this.node.meshes)this.node.lightMeshIndex!==e&&i.encapsulate(s.aabb),e++;this.aabb=fn.applyTransform(i,this.node.matrix)}return this.aabb}}class Xm{constructor(e,i,s,c,h,p){this.id=i,this.modelTraits|=$u.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,s&&(this.modelTraits|=$u.HasMapboxMeshFeatures),c&&(this.modelTraits|=$u.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=h,this.dirty=!0,this.needsUpload=!1,this.nodesInfo=[];for(const y of e)this.nodesInfo.push(new v1(y)),y1(y,p.featureIndexArray.length,p.grid),p.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,p.bucketLayerIDs.length-1,0)}update(){console.log("Update 3D model bucket")}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;const i=this.getNodesInfo();for(const s of i){const c=s.node;this.uploaded?this.updatePbrBuffer(c):Ly(c,e,!0)}for(const s of i)Hm(s.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let i=!1;if(!e.meshes)return i;for(const s of e.meshes)s.pbrBuffer&&(s.pbrBuffer.updateData(s.featureArray),i=!0);return i}needsReEvaluation(e,i,s){const c=e.transform.projectionOptions,h=e.style.getBrightness(),p=this.brightness!==h;return!!(!this.uploaded||this.dirty||c.name!==this.projection.name||Yd(s.paint.get("model-color").value,p)||Yd(s.paint.get("model-color-mix-intensity").value,p)||Yd(s.paint.get("model-roughness").value,p)||Yd(s.paint.get("model-emissive-strength").value,p)||Yd(s.paint.get("model-height-based-emissive-strength-multiplier").value,p))&&(this.projection=c,this.brightness=h,!0)}evaluateScale(e,i){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;const s=this.getNodesInfo(),c=this.id.canonical;for(const h of s){const p=h.feature;h.evaluatedScale=i.paint.get("model-scale").evaluate(p,{},c)}}evaluate(e){const i=this.getNodesInfo();for(const s of i){if(!s.node.meshes)continue;const c=s.feature,h=s.node.meshes&&s.node.meshes[0].featureData,p=s.evaluatedColor[2],y=s.evaluatedRMEA[2],v=this.id.canonical;if(s.hasTranslucentParts=!1,h){for(let T=0;T<x1.length;T++){const E=x1[T];E.length&&(c.properties.part=E);const I=e.paint.get("model-color").evaluate(c,{},v),P=e.paint.get("model-color-mix-intensity").evaluate(c,{},v);s.evaluatedColor[T]=[I.r,I.g,I.b,P],s.evaluatedRMEA[T][0]=e.paint.get("model-roughness").evaluate(c,{},v),s.evaluatedRMEA[T][2]=e.paint.get("model-emissive-strength").evaluate(c,{},v),s.evaluatedRMEA[T][3]=I.a,s.emissionHeightBasedParams[T]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(c,{},v),!s.hasTranslucentParts&&I.a<1&&(s.hasTranslucentParts=!0)}delete c.properties.part,jI(s,p!==s.evaluatedColor[2]||y!==s.evaluatedRMEA[2],this.modelTraits)}else s.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(c,{},v);s.evaluatedScale=e.paint.get("model-scale").evaluate(c,{},v),this.updatePbrBuffer(s.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,i,s,c){const h=e.findDEMTileFor(s);if(h&&(h.tileID.canonical!==this.terrainTile||i!==this.terrainExaggeration)){if(h.dem&&h.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=h.tileID.overscaledZ;const p=Bu.create(e,s,h);if(!p)return;this.modelTraits&$u.HasMapboxMeshFeatures&&this.updateDEM(e,p,s,c);for(const y of this.getNodesInfo()){const v=y.node;if(!v.footprint||!v.footprint.vertices||!v.footprint.vertices.length)continue;const T=v.footprint.vertices;let E=p.getElevationAt(T[0].x,T[0].y,!0,!0);for(let I=1;I<T.length;I++)E=Math.min(E,p.getElevationAt(T[I].x,T[I].y,!0,!0));v.elevation=E}}this.terrainTile=h.tileID.canonical,this.terrainExaggeration=i}}updateDEM(e,i,s,c){let h=i._dem._modifiedForSources[c];if(h===void 0&&(i._dem._modifiedForSources[c]=[],h=i._dem._modifiedForSources[c]),h.includes(s.canonical))return;const p=i._dem.dim;h.push(s.canonical);let y=!1;for(const v of this.getNodesInfo()){const T=v.node;if(!T.footprint||!T.footprint.grid)continue;const E=T.footprint.grid,I=i.tileCoordToPixel(E.min.x,E.min.y),P=i.tileCoordToPixel(E.max.x,E.max.y),R=Math.min(Math.min(p-P.y,I.x),Math.min(I.y,p-P.x));if(R<0)continue;const L=xi(R,2,5);let B=Math.max(0,I.x-L),j=Math.max(0,I.y-L),G=Math.min(P.x+L,p-1),X=Math.min(P.y+L,p-1);for(let re=j;re<=X;++re)for(let pe=B;pe<=G;++pe)dc[re*p+pe]=255;let ie=0,J=0;for(let re=0;re<E.cellsY;++re)for(let pe=0;pe<E.cellsX;++pe){if(!E.cells[re*E.cellsX+pe])continue;const _e=i.tileCoordToPixel(E.min.x+pe/E.xScale,E.min.y+re/E.yScale),Se=i.tileCoordToPixel(E.min.x+(pe+1)/E.xScale,E.min.y+(re+1)/E.yScale);for(let Le=_e.y;Le<=Math.min(Se.y+1,p-1);++Le)for(let Ce=_e.x;Ce<=Math.min(Se.x+1,p-1);++Ce)dc[Le*p+Ce]===255&&(dc[Le*p+Ce]=0,ie+=i.getElevationAtPixel(Ce,Le),J++)}const he=ie/J;B=Math.max(1,I.x-L),j=Math.max(1,I.y-L),G=Math.min(P.x+L,p-2),X=Math.min(P.y+L,p-2),y=!0;for(let re=j;re<=X;++re)for(let pe=B;pe<=G;++pe)dc[re*p+pe]===0&&(jy[re*p+pe]=i._dem.set(pe,re,he));for(let re=1;re<L;++re){B=Math.max(1,I.x-re),j=Math.max(1,I.y-re),G=Math.min(P.x+re,p-2),X=Math.min(P.y+re,p-2);for(let pe=j;pe<=X;++pe)for(let _e=B;_e<=G;++_e){const Se=pe*p+_e;if(dc[Se]===255){let Le=0,Ce=0,Be=-1,Fe=-1;for(let Oe=-1;Oe<=1;++Oe)for(let Ze=-1;Ze<=1;++Ze){const We=(pe+Oe)*p+_e+Ze;if(dc[We]>=re)continue;const Je=jy[We],Qe=Math.abs(Je);Qe>Ce&&(Le=Je,Ce=Qe,Be=Ze,Fe=Oe)}if(Ce>.1){const Oe=1-(re+.5*Math.abs(Be*Fe))/L;let Ze=i._dem.get(_e,pe)+Le*Oe;const We=i._dem.get(_e+Be,pe+Fe),Je=i._dem.get(_e-Be,pe-Fe,!0);(Ze-We)*(Ze-Je)>0&&(Ze=(We+Je)/2),jy[Se]=i._dem.set(_e,pe,Ze),dc[Se]=re}}}}}y&&(i._demTile.needsDEMTextureUpload=!0,i._dem._timestamp=ks.now())}getNodesInfo(){return this.nodesInfo}destroy(){const e=this.getNodesInfo();for(const i of e)Hm(i.node),Oy(i.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const s=i.getReplacementRegionsForTile(e.toUnwrapped()),c=this.getNodesInfo();for(let h=0;h<this.nodesInfo.length;h++){const p=c[h].node;c[h].hiddenByReplacement=!!p.footprint&&!s.find(y=>y.footprint===p.footprint)}}getHeightAtTileCoord(e,i){const s=this.getNodesInfo(),c=[],h=[0,0,0];for(let p=0;p<this.nodesInfo.length;p++){const y=s[p],v=y.node.meshes[0],T=fn.applyTransform(v.aabb,y.node.matrix);if(e<T.min[0]||i<T.min[1]||e>T.max[0]||i>T.max[1])continue;const E=(e-v.aabb.min[0])/(v.aabb.max[0]-v.aabb.min[0])*uc|0,I=Math.min(63,(i-v.aabb.min[1])/(v.aabb.max[1]-v.aabb.min[1])*uc|0)*uc+Math.min(63,E);if(h[2]=v.heightmap[I],r.Q.transformMat4(h,h,y.node.matrix),!(v.heightmap[I]<0&&y.node.footprint))return y.hiddenByReplacement?void 0:{height:h[2],maxHeight:y.feature.properties.height,hidden:!1,verticalScale:y.evaluatedScale[2]};if(y.node.footprint.grid.query(new ft(e,i),new ft(e,i),c),c.length>0)return{height:void 0,maxHeight:y.feature.properties.height,hidden:y.hiddenByReplacement,verticalScale:y.evaluatedScale[2]}}}}function Yd(t,e){return!t.isLightConstant&&e}function UI(t,e,i,s,c,h,p,y){let v=(61440&e|(61440&e)>>4)>>8,T=(3840&e|(3840&e)>>4)>>4,E=240&e|(240&e)>>4;i[3]>0&&(v=hi(v,255*i[0],i[3]),T=hi(T,255*i[1],i[3]),E=hi(E,255*i[2],i[3]));const I=v<<8|T,P=E<<8|Math.floor(255*s[3]),R=function(re){const pe=xi(re,0,2);return Math.min(Math.round(.5*pe*255),255)}(s[2])<<8|15*s[0]<<4|15*s[1],L=xi(c[0],0,1),B=xi(c[1],0,1),j=xi(c[2],0,1),G=xi(c[3],0,1);let X,ie,J,he;if(L!==B&&p!==h&&B!==L){const re=p-h;ie=1/(re*(B-L)),J=-(h+re*L)/(re*(B-L));const pe=xi(c[4],-1,1);he=Math.pow(10,pe),X=255*j<<8|255*G}else X=65535,ie=0,J=1,he=1;if(t.emplaceBack(I,P,R,X,ie,J,he),y){const re=y.length;y.clear();for(let pe=0;pe<re;pe++)y.emplaceBack(I,P,R,X,ie,J,he)}}function jI(t,e,i){const s=t.node;let c=0;const h=i&$u.HasMeshoptCompression;for(const p of s.meshes){if(s.lights&&s.lightMeshIndex===c||!p.featureData)continue;p.featureArray=new em,p.featureArray.reserve(p.featureData.length);let y=e;for(const v of p.featureData){const T=h?65535&v:v>>16&65535,E=h?v>>16&65535:65535&v,I=(15&E)<8?15&E:0,P=t.evaluatedRMEA[I],R=t.evaluatedColor[I],L=t.emissionHeightBasedParams[I];let B;if(y&&I===2&&s.lights&&(B=new em,B.resize(10*s.lights.length)),UI(p.featureArray,T,R,P,L,p.aabb.min[2],p.aabb.max[2],B),B&&y){y=!1;const j=s.meshes[s.lightMeshIndex];j.featureArray=B,j.featureArray._trim()}}p.featureArray._trim(),c++}}function b1(t,e,i,s){const c=1<<t.z;e.lat=xr((s/pt+t.y)/c),e.lng=is((i/pt+t.x)/c)}Mt(Xm,"Tiled3dModelBucket",{omit:["layers"]}),Mt(v1,"Tiled3dModelFeature");const GI={circle:class extends ui{constructor(t,e,i){super(t,XS,e,i)}createBucket(t){return new Hg(t)}queryRadius(t){const e=t;return Lu("circle-radius",this,e)+Lu("circle-stroke-width",this,e)+om(this.paint.get("circle-translate"))}queryIntersectsFeature(t,e,i,s,c,h,p,y){const v=Qx(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),h.angle,t.pixelToTileUnitsFactor),T=this.paint.get("circle-radius").evaluate(e,i)+this.paint.get("circle-stroke-width").evaluate(e,i);return uv(t,s,h,p,y,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",v,T)}getProgramIds(){return["circle"]}getDefaultProgramParams(t,e){const i=cv(this);return{config:new rc(this,e),defines:i,overrideFog:!1}}},heatmap:class extends ui{createBucket(t){return new dv(t)}constructor(t,e,i){super(t,cE,e,i),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(t){t==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Id({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(t){return Lu("heatmap-radius",this,t)}queryIntersectsFeature(t,e,i,s,c,h,p,y){const v=this.paint.get("heatmap-radius").evaluate(e,i);return uv(t,s,h,p,y,!0,!0,new ft(0,0),v)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(t,e){return t==="heatmap"?{config:new rc(this,e),overrideFog:!1}:{}}},hillshade:class extends ui{constructor(t,e,i){super(t,hE,e,i)}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(t,e){return{overrideFog:!1}}},fill:class extends ui{constructor(t,e,i){super(t,SE,e,i)}getProgramIds(){const t=this.paint.get("fill-pattern"),e=t&&t.constantOr(1),i=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&i.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),i}getDefaultProgramParams(t,e){return{config:new rc(this,e),overrideFog:!1}}recalculate(t,e){super.recalculate(t,e);const i=this.paint._values["fill-outline-color"];i.value.kind==="constant"&&i.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(t){return new fy(t)}queryRadius(){return om(this.paint.get("fill-translate"))}queryIntersectsFeature(t,e,i,s,c,h){return!t.queryGeometry.isAboveHorizon&&qx(Yx(t.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),h.angle,t.pixelToTileUnitsFactor),s)}isTileClipped(){return!0}},"fill-extrusion":class extends ui{constructor(t,e,i){super(t,JE,e,i),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(t){return new Tm(t)}queryRadius(){return om(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}hasShadowPass(){return!0}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(t,e,i,s,c,h,p,y,v){const T=Qx(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),h.angle,t.pixelToTileUnitsFactor),E=this.paint.get("fill-extrusion-height").evaluate(e,i),I=this.paint.get("fill-extrusion-base").evaluate(e,i),P=[0,0],R=y&&h.elevation,L=h.elevation?h.elevation.exaggeration():1,B=t.tile.getBucket(this);if(R&&B instanceof Tm){const J=B.centroidVertexArray,he=v+1;he<J.length&&(P[0]=J.geta_centroid_pos0(he),P[1]=J.geta_centroid_pos1(he))}if(P[0]===0&&P[1]===1)return!1;h.projection.name==="globe"&&(s=Zv([s],[new ft(0,0),new ft(pt,pt)],t.tileID.canonical).map(J=>J.polygon).flat());const j=R?y:null,[G,X]=function(J,he,re,pe,_e,Se,Le,Ce,Be,Fe,Oe){return J.projection.name==="globe"?function(Ze,We,Je,Qe,Ne,At,vt,tt,Gt,kt,It){const it=[],Nt=[],ri=Ze.projection.upVectorScale(It,Ze.center.lat,Ze.worldSize).metersToTile,$t=[0,0,0,1],ci=[0,0,0,1],si=(qt,Hi,Wi,Ci)=>{qt[0]=Hi,qt[1]=Wi,qt[2]=Ci,qt[3]=1},gi=Hv();Je>0&&(Je+=gi),Qe+=gi;for(const qt of We){const Hi=[],Wi=[];for(const Ci of qt){const Mi=Ci.x+Ne.x,Pi=Ci.y+Ne.y,sn=Ze.projection.projectTilePoint(Mi,Pi,It),Ji=Ze.projection.upVector(It,Ci.x,Ci.y);let Tn=Je,xn=Qe;if(vt){const Er=Yv(Mi,Pi,Je,Qe,vt,tt,Gt,kt);Tn+=Er.base,xn+=Er.top}Je!==0?si($t,sn.x+Ji[0]*ri*Tn,sn.y+Ji[1]*ri*Tn,sn.z+Ji[2]*ri*Tn):si($t,sn.x,sn.y,sn.z),si(ci,sn.x+Ji[0]*ri*xn,sn.y+Ji[1]*ri*xn,sn.z+Ji[2]*ri*xn),r.Q.transformMat4($t,$t,At),r.Q.transformMat4(ci,ci,At),Hi.push(new Nu($t[0],$t[1],$t[2])),Wi.push(new Nu(ci[0],ci[1],ci[2]))}it.push(Hi),Nt.push(Wi)}return[it,Nt]}(J,he,re,pe,_e,Se,Le,Ce,Be,Fe,Oe):Le?function(Ze,We,Je,Qe,Ne,At,vt,tt,Gt){const kt=[],It=[],it=[0,0,0,1];for(const Nt of Ze){const ri=[],$t=[];for(const ci of Nt){const si=ci.x+Qe.x,gi=ci.y+Qe.y,qt=Yv(si,gi,We,Je,At,vt,tt,Gt);it[0]=si,it[1]=gi,it[2]=qt.base,it[3]=1,r.aa.transformMat4(it,it,Ne),it[3]=Math.max(it[3],1e-5);const Hi=new Nu(it[0]/it[3],it[1]/it[3],it[2]/it[3]);it[0]=si,it[1]=gi,it[2]=qt.top,it[3]=1,r.aa.transformMat4(it,it,Ne),it[3]=Math.max(it[3],1e-5);const Wi=new Nu(it[0]/it[3],it[1]/it[3],it[2]/it[3]);ri.push(Hi),$t.push(Wi)}kt.push(ri),It.push($t)}return[kt,It]}(he,re,pe,_e,Se,Le,Ce,Be,Fe):function(Ze,We,Je,Qe,Ne){const At=[],vt=[],tt=Ne[8]*We,Gt=Ne[9]*We,kt=Ne[10]*We,It=Ne[11]*We,it=Ne[8]*Je,Nt=Ne[9]*Je,ri=Ne[10]*Je,$t=Ne[11]*Je;for(const ci of Ze){const si=[],gi=[];for(const qt of ci){const Hi=qt.x+Qe.x,Wi=qt.y+Qe.y,Ci=Ne[0]*Hi+Ne[4]*Wi+Ne[12],Mi=Ne[1]*Hi+Ne[5]*Wi+Ne[13],Pi=Ne[2]*Hi+Ne[6]*Wi+Ne[14],sn=Ne[3]*Hi+Ne[7]*Wi+Ne[15],Ji=Ci+tt,Tn=Mi+Gt,xn=Pi+kt,Er=Math.max(sn+It,1e-5),In=Ci+it,mn=Mi+Nt,Wn=Pi+ri,hr=Math.max(sn+$t,1e-5);si.push(new Nu(Ji/Er,Tn/Er,xn/Er)),gi.push(new Nu(In/hr,mn/hr,Wn/hr))}At.push(si),vt.push(gi)}return[At,vt]}(he,re,pe,_e,Se)}(h,s,I,E,T,p,j,P,L,h.center.lat,t.tileID.canonical),ie=t.queryGeometry;return function(J,he,re){let pe=1/0;qx(re,he)&&(pe=$v(re,he[0]));for(let _e=0;_e<he.length;_e++){const Se=he[_e],Le=J[_e];for(let Ce=0;Ce<Se.length-1;Ce++){const Be=Se[Ce],Fe=[Be,Se[Ce+1],Le[Ce+1],Le[Ce],Be];Zg(re,Fe)&&(pe=Math.min(pe,$v(re,Fe)))}}return pe!==1/0&&pe}(G,X,ie.isPointQuery()?ie.screenBounds:ie.screenGeometry)}},line:class extends ui{constructor(t,e,i){super(t,Xv,e,i),this.gradientVersion=0}_handleSpecialPaintPropertyUpdate(t){if(t==="line-gradient"){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof Gl,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(t,e){super.recalculate(t,e),this.paint._values["line-floorwidth"]=nb.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,t)}createBucket(t){return new _y(t)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(t,e){const i=tb(this);return{config:new rc(this,e),defines:i,overrideFog:!1}}queryRadius(t){const e=t,i=rb(Lu("line-width",this,e),Lu("line-gap-width",this,e)),s=Lu("line-offset",this,e);return i/2+Math.abs(s)+om(this.paint.get("line-translate"))}queryIntersectsFeature(t,e,i,s,c,h){if(t.queryGeometry.isAboveHorizon)return!1;const p=Yx(t.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),h.angle,t.pixelToTileUnitsFactor),y=t.pixelToTileUnitsFactor/2*rb(this.paint.get("line-width").evaluate(e,i),this.paint.get("line-gap-width").evaluate(e,i)),v=this.paint.get("line-offset").evaluate(e,i);return v&&(s=function(T,E){const I=[],P=new ft(0,0);for(let R=0;R<T.length;R++){const L=T[R],B=[];for(let j=0;j<L.length;j++){const G=L[j],X=L[j+1],ie=j===0?P:G.sub(L[j-1])._unit()._perp(),J=j===L.length-1?P:X.sub(G)._unit()._perp(),he=ie._add(J)._unit();he._mult(1/(he.x*J.x+he.y*J.y)),B.push(he._mult(E)._add(G))}I.push(B)}return I}(s,v*t.pixelToTileUnitsFactor)),function(T,E,I){for(let P=0;P<E.length;P++){const R=E[P];if(T.length>=3){for(let L=0;L<R.length;L++)if(lc(T,R[L]))return!0}if(ZS(T,R,I))return!0}return!1}(p,s,y)}isTileClipped(){return!0}},symbol:Nm,background:class extends ui{constructor(t,e,i){super(t,sI,e,i)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(t,e){return{overrideFog:!1}}},raster:Gb,"raster-particle":Wb,sky:class extends ui{constructor(t,e,i){super(t,fI,e,i),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(t){t==="sky-gradient"?this._updateColorRamp():t!=="sky-atmosphere-sun"&&t!=="sky-atmosphere-halo-color"&&t!=="sky-atmosphere-color"&&t!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Id({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(t){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const e=t.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(t,e){if(this.paint.get("sky-type")==="atmosphere"){const s=this.paint.get("sky-atmosphere-sun"),c=!s,h=t.style.light,p=h.properties.get("position");return c&&h.properties.get("anchor")==="viewport"&&wn("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),c?ky(p.azimuthal,90-p.polar,e):ky(s[0],90-s[1],e)}const i=this.paint.get("sky-gradient-center");return ky(i[0],90-i[1],e)}isSky(){return!0}markSkyboxValid(t){this._skyboxInvalidated=!1,this._lightPosition=t.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const t=this.paint.get("sky-type");return t==="atmosphere"?["skyboxCapture","skybox"]:t==="gradient"?["skyboxGradient"]:null}},slot:class extends ui{constructor(t,e,i){super(t,pI,e)}},model:class extends ui{constructor(t,e,i){super(t,TI,e,i),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(t){return new zy(t)}getProgramIds(){return["model"]}is3D(){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(t){return t instanceof Xm?pt-1:0}queryIntersectsFeature(t,e,i,s,c,h){if(!this.modelManager)return!1;const p=this.modelManager,y=t.tile.getBucket(this);if(!(y&&y instanceof zy))return!1;const v=y;for(const T in v.instancesPerModel){const E=v.instancesPerModel[T],I=e.id!==void 0?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(E.idToFeaturesIndex.hasOwnProperty(I)){const P=E.features[E.idToFeaturesIndex[I]],R=p.getModel(T,this.scope);if(!R)return!1;let L=r.a9.create();const B=new Ii(0,0),j=v.canonical;let G=Number.MAX_VALUE;for(let X=0;X<P.instancedDataCount;++X){const ie=16*(P.instancedDataOffset+X),J=E.instancedDataArray.float32,he=[J[ie+4],J[ie+5],J[ie+6]];b1(j,B,J[ie],0|J[ie+1]),e1(L,R,h,B,P.rotation,P.scale,he,!1,!1,!1),h.projection.name==="globe"&&(L=Ry(L,h));const re=r.a9.multiply([],h.projMatrix,L),pe=t.queryGeometry,_e=Qb(pe.isPointQuery()?pe.screenBounds:pe.screenGeometry,h,re,R.aabb);_e!=null&&(G=Math.min(_e,G))}return G!==Number.MAX_VALUE&&G}}return!1}_handleOverridablePaintPropertyUpdate(t,e,i){return!(!this.layout||e.isDataDriven()||i.isDataDriven()||t!=="model-color"&&t!=="model-color-mix-intensity"&&t!=="model-rotation"&&t!=="model-scale"&&t!=="model-translation"&&t!=="model-emissive-strength")}_isPropertyZoomDependent(t){const e=this._transitionablePaint._values[t];return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof Ql}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}queryIntersectsMatchingFeature(t,e,i,s){const c=t.tile,h=c.getBucket(this);let p=null,y=Number.MAX_VALUE;if(!(h&&h instanceof Xm))return{queryFeature:p,intersectionZ:y};const v=h.getNodesInfo()[e];if(v.hiddenByReplacement||!v.node.meshes||!i.filter(new Y(c.tileID.overscaledZ),v.feature,c.tileID.canonical))return{queryFeature:p,intersectionZ:y};const T=v.node,E=s.calculatePosMatrix(c.tileID.toUnwrapped(),s.worldSize),I=v.evaluatedScale;let P=0;s.elevation&&T.elevation&&(P=T.elevation*s.elevation.exaggeration()),r.a9.translate(E,E,[(T.anchor?T.anchor[0]:0)*(I[0]-1),(T.anchor?T.anchor[1]:0)*(I[1]-1),P]),r.a9.scale(E,E,I),r.a9.multiply(E,E,T.matrix);const R=t.queryGeometry,L=R.isPointQuery()?R.screenBounds:R.screenGeometry,B=function(G){const X=r.a9.multiply([],E,G.matrix),ie=r.a9.multiply(X,s.expandedFarZProjMatrix,X);for(let J=0;J<G.meshes.length;++J){const he=G.meshes[J];if(J===G.lightMeshIndex)continue;const re=Qb(L,s,ie,he.aabb);re!=null&&(y=Math.min(re,y))}if(G.children)for(const J of G.children)B(J)};if(B(T),y===Number.MAX_VALUE)return{queryFeature:p,intersectionZ:y};const j=new Ii(0,0);return b1(c.tileID.canonical,j,v.node.anchor[0],v.node.anchor[1]),p={type:"Feature",geometry:{type:"Point",coordinates:[j.lng,j.lat]},properties:v.feature.properties,id:v.feature.id,state:{},layer:this.serialize()},{queryFeature:p,intersectionZ:y}}}},ti={read:function(t,e){return t.readFields(ti._readField,{header_length:0,x:0,y:0,z:0,layers:[]},e)},_readField:function(t,e,i){t===1?e.header_length=i.readFixed32():t===2?e.x=i.readVarint():t===3?e.y=i.readVarint():t===4?e.z=i.readVarint():t===5&&e.layers.push(ti.Layer.read(i,i.readVarint()+i.pos))},PixelFormat:{PIXEL_FORMAT_UNKNOWN:{value:0,options:{}},PIXEL_FORMAT_UINT32:{value:1,options:{}},PIXEL_FORMAT_UINT16:{value:2,options:{}},PIXEL_FORMAT_UINT8:{value:3,options:{}}},Filter:{}};ti.Filter.read=function(t,e){return t.readFields(ti.Filter._readField,{delta_filter:null,filter:null,zigzag_filter:null,bitshuffle_filter:null,byteshuffle_filter:null},e)},ti.Filter._readField=function(t,e,i){t===1?(e.delta_filter=ti.Filter.Delta.read(i,i.readVarint()+i.pos),e.filter="delta_filter"):t===2?(e.zigzag_filter=ti.Filter.Zigzag.read(i,i.readVarint()+i.pos),e.filter="zigzag_filter"):t===3?(e.bitshuffle_filter=ti.Filter.BitShuffle.read(i,i.readVarint()+i.pos),e.filter="bitshuffle_filter"):t===4&&(e.byteshuffle_filter=ti.Filter.ByteShuffle.read(i,i.readVarint()+i.pos),e.filter="byteshuffle_filter")},ti.Filter.Delta={},ti.Filter.Delta.read=function(t,e){return t.readFields(ti.Filter.Delta._readField,{block_size:0},e)},ti.Filter.Delta._readField=function(t,e,i){t===1&&(e.block_size=i.readVarint())},ti.Filter.Zigzag={},ti.Filter.Zigzag.read=function(t,e){return t.readFields(ti.Filter.Zigzag._readField,{},e)},ti.Filter.Zigzag._readField=function(t,e,i){},ti.Filter.BitShuffle={},ti.Filter.BitShuffle.read=function(t,e){return t.readFields(ti.Filter.BitShuffle._readField,{},e)},ti.Filter.BitShuffle._readField=function(t,e,i){},ti.Filter.ByteShuffle={},ti.Filter.ByteShuffle.read=function(t,e){return t.readFields(ti.Filter.ByteShuffle._readField,{},e)},ti.Filter.ByteShuffle._readField=function(t,e,i){},ti.Codec={},ti.Codec.read=function(t,e){return t.readFields(ti.Codec._readField,{gzip_data:null,codec:null,jpeg_image:null,webp_image:null,png_image:null},e)},ti.Codec._readField=function(t,e,i){t===1?(e.gzip_data=ti.Codec.GzipData.read(i,i.readVarint()+i.pos),e.codec="gzip_data"):t===2?(e.jpeg_image=ti.Codec.JpegImage.read(i,i.readVarint()+i.pos),e.codec="jpeg_image"):t===3?(e.webp_image=ti.Codec.WebpImage.read(i,i.readVarint()+i.pos),e.codec="webp_image"):t===4&&(e.png_image=ti.Codec.PngImage.read(i,i.readVarint()+i.pos),e.codec="png_image")},ti.Codec.GzipData={},ti.Codec.GzipData.read=function(t,e){return t.readFields(ti.Codec.GzipData._readField,{},e)},ti.Codec.GzipData._readField=function(t,e,i){},ti.Codec.JpegImage={},ti.Codec.JpegImage.read=function(t,e){return t.readFields(ti.Codec.JpegImage._readField,{},e)},ti.Codec.JpegImage._readField=function(t,e,i){},ti.Codec.WebpImage={},ti.Codec.WebpImage.read=function(t,e){return t.readFields(ti.Codec.WebpImage._readField,{},e)},ti.Codec.WebpImage._readField=function(t,e,i){},ti.Codec.PngImage={},ti.Codec.PngImage.read=function(t,e){return t.readFields(ti.Codec.PngImage._readField,{},e)},ti.Codec.PngImage._readField=function(t,e,i){},ti.DataIndexEntry={},ti.DataIndexEntry.read=function(t,e){return t.readFields(ti.DataIndexEntry._readField,{first_byte:0,last_byte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},e)},ti.DataIndexEntry._readField=function(t,e,i){t===1?e.first_byte=i.readFixed64():t===2?e.last_byte=i.readFixed64():t===3?e.filters.push(ti.Filter.read(i,i.readVarint()+i.pos)):t===4?e.codec=ti.Codec.read(i,i.readVarint()+i.pos):t===5?e.offset=i.readFloat():t===6?e.scale=i.readFloat():t===7&&e.bands.push(i.readString())},ti.Layer={},ti.Layer.read=function(t,e){return t.readFields(ti.Layer._readField,{version:0,name:"",units:"",tilesize:0,buffer:0,pixel_format:0,data_index:[]},e)},ti.Layer._readField=function(t,e,i){t===1?e.version=i.readVarint():t===2?e.name=i.readString():t===3?e.units=i.readString():t===4?e.tilesize=i.readVarint():t===5?e.buffer=i.readVarint():t===6?e.pixel_format=i.readVarint():t===7&&e.data_index.push(ti.DataIndexEntry.read(i,i.readVarint()+i.pos))};const no={read:function(t,e){return t.readFields(no._readField,{uint32_values:null,values:null,fixed32_values:null},e)},_readField:function(t,e,i){t===2?(e.uint32_values=no.Uint32Values.read(i,i.readVarint()+i.pos),e.values="uint32_values"):t===3&&(e.fixed32_values=no.Fixed32Values.read(i,i.readVarint()+i.pos),e.values="fixed32_values")},Uint32Values:{}};no.Uint32Values.read=function(t,e){return t.readFields(no.Uint32Values._readField,{values:[]},e)},no.Uint32Values._readField=function(t,e,i){t===1&&(e.readValuesInto=function(s){if(s.type!==2)throw new Error(`Unsupported pbf type "${s.type}"`);const c=function(p){return p.type===2?p.readVarint()+p.pos:p.pos+1}(s),h=s.pos;return s.pos=c,function(p){s.pos=h;let y=0;for(;s.pos<c;){const v=s.readVarint();p[y++]=v}return p}}(i))},no.Fixed32Values={},no.Fixed32Values.read=function(t,e){return t.readFields(no.Fixed32Values._readField,{values:[]},e)},no.Fixed32Values._readField=function(t,e,i){throw new Error("Not implemented")};/**
 * tiny-lru
 *
 * @copyright 2024 Jason Mulligan <jason.mulligan@avoidwork.com>
 * @license BSD-3-Clause
 * @version 11.2.6
 */class WI{constructor(e=0,i=0,s=!1){this.first=null,this.items=Object.create(null),this.last=null,this.max=e,this.resetTtl=s,this.size=0,this.ttl=i}clear(){return this.first=null,this.items=Object.create(null),this.last=null,this.size=0,this}delete(e){if(this.has(e)){const i=this.items[e];delete this.items[e],this.size--,i.prev!==null&&(i.prev.next=i.next),i.next!==null&&(i.next.prev=i.prev),this.first===i&&(this.first=i.next),this.last===i&&(this.last=i.prev)}return this}entries(e=this.keys()){return e.map(i=>[i,this.get(i)])}evict(e=!1){if(e||this.size>0){const i=this.first;delete this.items[i.key],--this.size==0?(this.first=null,this.last=null):(this.first=i.next,this.first.prev=null)}return this}expiresAt(e){let i;return this.has(e)&&(i=this.items[e].expiry),i}get(e){let i;if(this.has(e)){const s=this.items[e];this.ttl>0&&s.expiry<=Date.now()?this.delete(e):(i=s.value,this.set(e,i,!0))}return i}has(e){return e in this.items}keys(){const e=[];let i=this.first;for(;i!==null;)e.push(i.key),i=i.next;return e}set(e,i,s=!1,c=this.resetTtl){let h;if(s||this.has(e)){if(h=this.items[e],h.value=i,s===!1&&c&&(h.expiry=this.ttl>0?Date.now()+this.ttl:this.ttl),this.last!==h){const p=this.last,y=h.next,v=h.prev;this.first===h&&(this.first=h.next),h.next=null,h.prev=this.last,p.next=h,v!==null&&(v.next=y),y!==null&&(y.prev=v)}}else this.max>0&&this.size===this.max&&this.evict(!0),h=this.items[e]={expiry:this.ttl>0?Date.now()+this.ttl:this.ttl,key:e,prev:this.last,next:null,value:i},++this.size==1?this.first=h:this.last.next=h;return this.last=h,this}values(e=this.keys()){return e.map(i=>this.get(i))}}function qI(t,e){if(e.length!==4)throw new Error(`Expected data of dimension 4 but got ${e.length}.`);let i=e[3];for(let s=2;s>=1;s--){const c=s===1?1:0,h=s===2?1:0;for(let p=0;p<e[0];p++){const y=e[1]*p;for(let v=c;v<e[1];v++){const T=e[2]*(v+y);for(let E=h;E<e[2];E++){const I=e[3]*(E+T);for(let P=0;P<e[3];P++){const R=I+P;t[R]+=t[R-i]}}}}i*=e[s]}return t}function HI(t){for(let e=0,i=t.length;e<i;e++)t[e]=t[e]>>>1^-(1&t[e]);return t}function ZI(t,e){switch(e){case"uint32":return t;case"uint16":for(let i=0;i<t.length;i+=2){const s=t[i],c=t[i+1];t[i]=(240&s)>>4|(61440&s)>>8|(240&c)<<4|61440&c,t[i+1]=15&s|(3840&s)>>4|(15&c)<<8|(3840&c)<<4}return t;case"uint8":for(let i=0;i<t.length;i+=4){const s=t[i],c=t[i+1],h=t[i+2],p=t[i+3];t[i+0]=(192&s)>>6|(192&c)>>4|(192&h)>>2|192&p,t[i+1]=(48&s)>>4|(48&c)>>2|48&h|(48&p)<<2,t[i+2]=(12&s)>>2|12&c|(12&h)<<2|(12&p)<<4,t[i+3]=3&s|(3&c)<<2|(3&h)<<4|(3&p)<<6}return t;default:throw new Error(`Invalid pixel format, "${e}"`)}}class Ja extends Error{constructor(e){super(e),this.name="MRTError"}}var Ss=Uint8Array,Qd=Uint16Array,$I=Int32Array,w1=new Ss([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),T1=new Ss([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),YI=new Ss([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),M1=function(t,e){for(var i=new Qd(31),s=0;s<31;++s)i[s]=e+=1<<t[s-1];var c=new $I(i[30]);for(s=1;s<30;++s)for(var h=i[s];h<i[s+1];++h)c[h]=h-i[s]<<5|s;return{b:i,r:c}},S1=M1(w1,2),E1=S1.b,QI=S1.r;E1[28]=258,QI[258]=28;for(var XI=M1(T1,0).b,A1=new Qd(32768),Bn=0;Bn<32768;++Bn){var Ku=(43690&Bn)>>1|(21845&Bn)<<1;A1[Bn]=((65280&(Ku=(61680&(Ku=(52428&Ku)>>2|(13107&Ku)<<2))>>4|(3855&Ku)<<4))>>8|(255&Ku)<<8)>>1}var Xd=function(t,e,i){for(var s=t.length,c=0,h=new Qd(e);c<s;++c)t[c]&&++h[t[c]-1];var p,y=new Qd(e);for(c=1;c<e;++c)y[c]=y[c-1]+h[c-1]<<1;{p=new Qd(1<<e);var v=15-e;for(c=0;c<s;++c)if(t[c])for(var T=c<<4|t[c],E=e-t[c],I=y[t[c]-1]++<<E,P=I|(1<<E)-1;I<=P;++I)p[A1[I]>>v]=T}return p},Kd=new Ss(288);for(Bn=0;Bn<144;++Bn)Kd[Bn]=8;for(Bn=144;Bn<256;++Bn)Kd[Bn]=9;for(Bn=256;Bn<280;++Bn)Kd[Bn]=7;for(Bn=280;Bn<288;++Bn)Kd[Bn]=8;var I1=new Ss(32);for(Bn=0;Bn<32;++Bn)I1[Bn]=5;var KI=Xd(Kd,9),JI=Xd(I1,5),Gy=function(t){for(var e=t[0],i=1;i<t.length;++i)t[i]>e&&(e=t[i]);return e},ro=function(t,e,i){var s=e/8|0;return(t[s]|t[s+1]<<8)>>(7&e)&i},Wy=function(t,e){var i=e/8|0;return(t[i]|t[i+1]<<8|t[i+2]<<16)>>(7&e)},eC=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],so=function(t,e,i){var s=new Error(e||eC[t]);if(s.code=t,Error.captureStackTrace&&Error.captureStackTrace(s,so),!i)throw s;return s},tC=new Ss(0),iC=typeof TextDecoder<"u"&&new TextDecoder;try{iC.decode(tC,{stream:!0})}catch{}const nC={gzip_data:"gzip"},rC={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},sC={uint32:1,uint16:2,uint8:4},oC={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};class C1{constructor(e=1){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){return this.layers[e]}getHeaderLength(e){const i=new Uint8Array(e),s=new DataView(e);if(i[0]!==13)throw new Ja("File is not a valid MRT.");return s.getUint32(1,!0)}parseHeader(e){const i=new Uint8Array(e),s=this.getHeaderLength(e);if(i.length<s)throw new Ja(`Expected header with length >= ${s} but got buffer of length ${i.length}`);const c=new Gu(i.subarray(0,s)),h=ti.read(c);if(!isNaN(this.x)&&(this.x!==h.x||this.y!==h.y||this.z!==h.z))throw new Ja(`Invalid attempt to parse header ${h.z}/${h.x}/${h.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=h.x,this.y=h.y,this.z=h.z;for(const p of h.layers)this.layers[p.name]=new aC(p,{cacheSize:this._cacheSize});return this}createDecodingTask(e){const i=[],s=this.getLayer(e.layerName);for(let c=0;c<s.dataIndex.length;c++){const h=s.dataIndex[c],p=h.first_byte-e.firstByte,y=h.last_byte+1-e.firstByte;if(c<e.firstBlock||c>e.lastBlock||s._blocksInProgress.has(c))continue;const v={layerName:s.name,firstByte:p,lastByte:y,pixelFormat:s.pixelFormat,blockIndex:c,blockShape:[h.bands.length].concat(s.bandShape),buffer:s.buffer,codec:h.codec.codec,filters:h.filters.map(T=>T.filter)};s._blocksInProgress.add(c),i.push(v)}return new P1(i,()=>{i.forEach(c=>s._blocksInProgress.delete(c.blockIndex))},(c,h)=>{if(i.forEach(p=>s._blocksInProgress.delete(p.blockIndex)),c)throw c;h.forEach(p=>{this.getLayer(p.layerName).processDecodedData(p)})})}}class aC{constructor({version:e,name:i,units:s,tilesize:c,pixel_format:h,buffer:p,data_index:y},v){if(this.version=e,this.version!==1)throw new Ja(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=i,this.units=s,this.tileSize=c,this.buffer=p,this.pixelFormat=rC[h],this.dataIndex=y,this.bandShape=[c+2*p,c+2*p,sC[this.pixelFormat]],this._decodedBlocks=function(T=1e3,E=0,I=!1){if(isNaN(T)||T<0)throw new TypeError("Invalid max value");if(isNaN(E)||E<0)throw new TypeError("Invalid ttl value");if(typeof I!="boolean")throw new TypeError("Invalid resetTtl value");return new WI(T,E,I)}(v?v.cacheSize:5),this._blocksInProgress=new Set}processDecodedData(e){const i=e.blockIndex.toString();this._decodedBlocks.get(i)||this._decodedBlocks.set(i,e.data)}getBlockForBand(e){let i=0;switch(typeof e){case"string":for(const[s,c]of this.dataIndex.entries()){for(const[h,p]of c.bands.entries())if(p===e)return{bandIndex:i+h,blockIndex:s,blockBandIndex:h};i+=c.bands.length}break;case"number":for(const[s,c]of this.dataIndex.entries()){if(e>=i&&e<i+c.bands.length)return{bandIndex:e,blockIndex:s,blockBandIndex:e-i};i+=c.bands.length}break;default:throw new Ja(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}throw new Ja(`Band not found: ${JSON.stringify(e)}`)}getDataRange(e){let i=1/0,s=-1/0,c=1/0,h=-1/0;for(const p of e){const{blockIndex:y}=this.getBlockForBand(p);if(y<0)throw new Ja(`Invalid band: ${JSON.stringify(p)}`);const v=this.dataIndex[y];c=Math.min(c,y),h=Math.max(h,y),i=Math.min(i,v.first_byte),s=Math.max(s,v.last_byte)}return{layerName:this.name,firstByte:i,lastByte:s,firstBlock:c,lastBlock:h}}hasBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0}hasDataForBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0&&!!this._decodedBlocks.get(i.toString())}getBandView(e){const{blockIndex:i,blockBandIndex:s}=this.getBlockForBand(e),c=this._decodedBlocks.get(i.toString());if(!c)throw new Ja(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);const h=this.dataIndex[i],p=this.bandShape.reduce((T,E)=>T*E,1),y=s*p,v=c.subarray(y,y+p);return{data:v,bytes:new Uint8Array(v.buffer).subarray(v.byteOffset,v.byteOffset+v.byteLength),tileSize:this.tileSize,buffer:this.buffer,offset:h.offset,scale:h.scale}}}class P1{constructor(e,i,s){this.tasks=e,this._onCancel=i,this._onComplete=s,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,i){this._finalized||(this._onComplete(e,i),this._finalized=!0)}}C1.performDecoding=function(t,e){return Promise.all(e.tasks.map(i=>{const{layerName:s,firstByte:c,lastByte:h,pixelFormat:p,blockShape:y,blockIndex:v,filters:T,codec:E}=i,I=new Uint8Array(t).subarray(c,h+1),P=new Uint32Array(y[0]*y[1]*y[2]);let R;if(E!=="gzip_data")throw new Error(`Unhandled codec: ${E}`);return R=function(L,B){if(!globalThis.DecompressionStream&&B==="gzip_data")return Promise.resolve(((ie=function(re){re[0]==31&&re[1]==139&&re[2]==8||so(6,"invalid gzip data");var pe=re[3],_e=10;4&pe&&(_e+=2+(re[10]|re[11]<<8));for(var Se=(pe>>3&1)+(pe>>4&1);Se>0;Se-=!re[_e++]);return _e+(2&pe)}(X=L))+8>X.length&&so(6,"invalid gzip data"),function(re,pe,_e,Se){var Le=re.length;if(!Le||pe.f&&!pe.l)return _e||new Ss(0);var Ce=!_e,Be=Ce||pe.i!=2,Fe=pe.i;Ce&&(_e=new Ss(3*Le));var Oe,Ze,We=function(el){var tl=_e.length;if(el>tl){var fc=new Ss(Math.max(2*tl,el));fc.set(_e),_e=fc}},Je=pe.f||0,Qe=pe.p||0,Ne=pe.b||0,At=pe.l,vt=pe.d,tt=pe.m,Gt=pe.n,kt=8*Le;do{if(!At){Je=ro(re,Qe,1);var It=ro(re,Qe+1,3);if(Qe+=3,!It){var it=re[(Mi=4+((Qe+7)/8|0))-4]|re[Mi-3]<<8,Nt=Mi+it;if(Nt>Le){Fe&&so(0);break}Be&&We(Ne+it),_e.set(re.subarray(Mi,Nt),Ne),pe.b=Ne+=it,pe.p=Qe=8*Nt,pe.f=Je;continue}if(It==1)At=KI,vt=JI,tt=9,Gt=5;else if(It==2){var ri=ro(re,Qe,31)+257,$t=ro(re,Qe+10,15)+4,ci=ri+ro(re,Qe+5,31)+1;Qe+=14;for(var si=new Ss(ci),gi=new Ss(19),qt=0;qt<$t;++qt)gi[YI[qt]]=ro(re,Qe+3*qt,7);Qe+=3*$t;var Hi=Gy(gi),Wi=(1<<Hi)-1,Ci=Xd(gi,Hi);for(qt=0;qt<ci;){var Mi,Pi=Ci[ro(re,Qe,Wi)];if(Qe+=15&Pi,(Mi=Pi>>4)<16)si[qt++]=Mi;else{var sn=0,Ji=0;for(Mi==16?(Ji=3+ro(re,Qe,3),Qe+=2,sn=si[qt-1]):Mi==17?(Ji=3+ro(re,Qe,7),Qe+=3):Mi==18&&(Ji=11+ro(re,Qe,127),Qe+=7);Ji--;)si[qt++]=sn}}var Tn=si.subarray(0,ri),xn=si.subarray(ri);tt=Gy(Tn),Gt=Gy(xn),At=Xd(Tn,tt),vt=Xd(xn,Gt)}else so(1);if(Qe>kt){Fe&&so(0);break}}Be&&We(Ne+131072);for(var Er=(1<<tt)-1,In=(1<<Gt)-1,mn=Qe;;mn=Qe){var Wn=(sn=At[Wy(re,Qe)&Er])>>4;if((Qe+=15&sn)>kt){Fe&&so(0);break}if(sn||so(2),Wn<256)_e[Ne++]=Wn;else{if(Wn==256){mn=Qe,At=null;break}var hr=Wn-254;Wn>264&&(hr=ro(re,Qe,(1<<(jr=w1[qt=Wn-257]))-1)+E1[qt],Qe+=jr);var dr=vt[Wy(re,Qe)&In],nn=dr>>4;if(dr||so(3),Qe+=15&dr,xn=XI[nn],nn>3){var jr=T1[nn];xn+=Wy(re,Qe)&(1<<jr)-1,Qe+=jr}if(Qe>kt){Fe&&so(0);break}Be&&We(Ne+131072);var na=Ne+hr;if(Ne<xn){var Us=0-xn,oo=Math.min(xn,na);for(Us+Ne<0&&so(3);Ne<oo;++Ne)_e[Ne]=(void 0)[Us+Ne]}for(;Ne<na;++Ne)_e[Ne]=_e[Ne-xn]}}pe.l=At,pe.p=mn,pe.b=Ne,pe.f=Je,At&&(Je=1,pe.m=tt,pe.d=vt,pe.n=Gt)}while(!Je);return Ne!=_e.length&&Ce?(Oe=_e,((Ze=Ne)==null||Ze>Oe.length)&&(Ze=Oe.length),new Ss(Oe.subarray(0,Ze))):_e.subarray(0,Ne)}(X.subarray(ie,-8),{i:2},new Ss(((j=X)[(G=j.length)-4]|j[G-3]<<8|j[G-2]<<16|j[G-1]<<24)>>>0))));var j,G,X,ie;const J=nC[B];if(!J)throw new Error(`Unhandled codec: ${B}`);const he=new globalThis.DecompressionStream(J);return new Response(new Blob([L]).stream().pipeThrough(he)).arrayBuffer().then(re=>new Uint8Array(re))}(I,E).then(L=>{const B=no.read(new Gu(L));if(B.values==="uint32_values")return B.uint32_values.readValuesInto(P),new oC[p](P.buffer);throw new Error(`Unhandled numeric data "${B.values}"`)}),R.then(L=>{for(let B=T.length-1;B>=0;B--)switch(T[B]){case"delta_filter":qI(L,y);break;case"zigzag_filter":HI(L);break;case"bitshuffle_filter":ZI(L,p);break;default:throw new Error(`Unhandled filter "${T[B]}"`)}return{layerName:s,blockIndex:v,data:L}}).catch(L=>{throw L})}))},Mt(P1,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]});const D1=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class qy{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[i,s]=new Uint8Array(e,0,2);if(i!==219)throw new Error("Data does not appear to be in a KDBush format.");const c=s>>4;if(c!==1)throw new Error(`Got v${c} data when expected v1.`);const h=D1[15&s];if(!h)throw new Error("Unrecognized array type.");const[p]=new Uint16Array(e,2,1),[y]=new Uint32Array(e,4,1);return new qy(y,p,h,e)}constructor(e,i=64,s=Float64Array,c){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+i,2),65535),this.ArrayType=s,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const h=D1.indexOf(this.ArrayType),p=2*e*this.ArrayType.BYTES_PER_ELEMENT,y=e*this.IndexArrayType.BYTES_PER_ELEMENT,v=(8-y%8)%8;if(h<0)throw new Error(`Unexpected typed array class: ${s}.`);c&&c instanceof ArrayBuffer?(this.data=c,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+y+v,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+p+y+v),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+y+v,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+h]),new Uint16Array(this.data,2,1)[0]=i,new Uint32Array(this.data,4,1)[0]=e)}add(e,i){const s=this._pos>>1;return this.ids[s]=s,this.coords[this._pos++]=e,this.coords[this._pos++]=i,s}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return Hy(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,i,s,c){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:h,coords:p,nodeSize:y}=this,v=[0,h.length-1,0],T=[];for(;v.length;){const E=v.pop()||0,I=v.pop()||0,P=v.pop()||0;if(I-P<=y){for(let j=P;j<=I;j++){const G=p[2*j],X=p[2*j+1];G>=e&&G<=s&&X>=i&&X<=c&&T.push(h[j])}continue}const R=P+I>>1,L=p[2*R],B=p[2*R+1];L>=e&&L<=s&&B>=i&&B<=c&&T.push(h[R]),(E===0?e<=L:i<=B)&&(v.push(P),v.push(R-1),v.push(1-E)),(E===0?s>=L:c>=B)&&(v.push(R+1),v.push(I),v.push(1-E))}return T}within(e,i,s){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:c,coords:h,nodeSize:p}=this,y=[0,c.length-1,0],v=[],T=s*s;for(;y.length;){const E=y.pop()||0,I=y.pop()||0,P=y.pop()||0;if(I-P<=p){for(let j=P;j<=I;j++)R1(h[2*j],h[2*j+1],e,i)<=T&&v.push(c[j]);continue}const R=P+I>>1,L=h[2*R],B=h[2*R+1];R1(L,B,e,i)<=T&&v.push(c[R]),(E===0?e-s<=L:i-s<=B)&&(y.push(P),y.push(R-1),y.push(1-E)),(E===0?e+s>=L:i+s>=B)&&(y.push(R+1),y.push(I),y.push(1-E))}return v}}function Hy(t,e,i,s,c,h){if(c-s<=i)return;const p=s+c>>1;k1(t,e,p,s,c,h),Hy(t,e,i,s,p-1,1-h),Hy(t,e,i,p+1,c,1-h)}function k1(t,e,i,s,c,h){for(;c>s;){if(c-s>600){const T=c-s+1,E=i-s+1,I=Math.log(T),P=.5*Math.exp(2*I/3),R=.5*Math.sqrt(I*P*(T-P)/T)*(E-T/2<0?-1:1);k1(t,e,i,Math.max(s,Math.floor(i-E*P/T+R)),Math.min(c,Math.floor(i+(T-E)*P/T+R)),h)}const p=e[2*i+h];let y=s,v=c;for(Jd(t,e,s,i),e[2*c+h]>p&&Jd(t,e,s,c);y<v;){for(Jd(t,e,y,v),y++,v--;e[2*y+h]<p;)y++;for(;e[2*v+h]>p;)v--}e[2*s+h]===p?Jd(t,e,s,v):(v++,Jd(t,e,v,c)),v<=i&&(s=v+1),i<=v&&(c=v-1)}}function Jd(t,e,i,s){Zy(t,i,s),Zy(e,2*i,2*s),Zy(e,2*i+1,2*s+1)}function Zy(t,e,i){const s=t[e];t[e]=t[i],t[i]=s}function R1(t,e,i,s){const c=t-i,h=e-s;return c*c+h*h}r.$=class{constructor(t){this.specification=t}possiblyEvaluate(t,e){return function([i,s]){const c=gl([1,i,s]);return{x:c.x,y:c.y,z:c.z}}(t.expression.evaluate(e))}interpolate(t,e,i){return{x:hi(t.x,e.x,i),y:hi(t.y,e.y,i),z:hi(t.z,e.z,i)}}},r.A=Ue,r.B=xd,r.C=Br,r.D=Hp,r.E=No,r.F=function(t){const e=t.value;let i=[];if(!e)return i;const s=go(e);return s!=="string"?(i=i.concat([new qm(t.key,e,`string expected, "${s}" found`)]),i):(Xb(e,!0)||(i=i.concat([new qm(t.key,e,`invalid url "${e}"`)])),i)},r.G=ae,r.H=we,r.I=wy,r.J=ge,r.K=class{constructor(t){this.specification=t}possiblyEvaluate(t,e){return gl(t.expression.evaluate(e))}interpolate(t,e,i){return{x:hi(t.x,e.x,i),y:hi(t.y,e.y,i),z:hi(t.z,e.z,i),azimuthal:hi(t.azimuthal,e.azimuthal,i),polar:hi(t.polar,e.polar,i)}}},r.L=fe,r.M=class{constructor(t,e,i,s){this.id=t,this.position=e!=null?new Ii(e[0],e[1]):new Ii(0,0),this.orientation=i??[0,0,0],this.nodes=s,this.uploaded=!1,this.aabb=new fn([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(t,e){if(r.a9.multiply(t.matrix,e,t.matrix),t.meshes)for(const i of t.meshes){const s=fn.applyTransform(i.aabb,t.matrix);this.aabb.encapsulate(s)}if(t.children)for(const i of t.children)this._applyTransformations(i,t.matrix)}computeBoundsAndApplyParent(){const t=r.a9.identity([]);for(const e of this.nodes)this._applyTransformations(e,t)}computeModelMatrix(t,e,i,s,c,h,p=!1){e1(this.matrix,this,t.transform,this.position,e,i,s,c,h,p)}upload(t){if(!this.uploaded){for(const e of this.nodes)Ly(e,t);for(const e of this.nodes)Hm(e);this.uploaded=!0}}destroy(){for(const t of this.nodes)Oy(t)}},r.N=Y,r.O=Sr,r.P=ft,r.R=$c,r.S=pl,r.T=Dy,r.U=ze,r.V=qm,r.W=Wa,r.X=hi,r.Y=pt,r.Z=Ql,r._=Il,r.a=nu,r.a$=Ch,r.a0=function(t,e,i=0,s=!0){const c=new ft(i,i),h=t.sub(c),p=e.add(c),y=[h,new ft(p.x,h.y),p,new ft(h.x,p.y)];return s&&y.push(h.clone()),y},r.a1=function(t,e){const i=[];for(let s=0;s<t.length;s++){const c=qs(s-1,-1,t.length-1),h=qs(s+1,-1,t.length-1),p=t[s],y=t[h],v=t[c].sub(p).unit(),T=y.sub(p).unit(),E=T.angleWithSep(v.x,v.y),I=v.add(T).unit().mult(-1*e/Math.sin(E/2));i.push(p.add(I))}return i},r.a2=zb,r.a3=$x,r.a4=function(t,e,i=0){return r.Q.fromValues(((e.x-i)*t.scale-t.x)*pt,(e.y*t.scale-t.y)*pt,Vx(e.z,e.y))},r.a5=Xg,r.a6=Kv,r.a7=function(t){let e=1/0,i=1/0,s=-1/0,c=-1/0;for(const h of t)e=Math.min(e,h.x),i=Math.min(i,h.y),s=Math.max(s,h.x),c=Math.max(c,h.y);return{min:new ft(e,i),max:new ft(s,c)}},r.a8=ja,r.aA=Bi,r.aB=ni,r.aC=Up,r.aD=Rg,r.aE=kn,r.aF=Di,r.aG=wx,r.aH=Bm,r.aI=function(){le.isLoading()||le.isLoaded()||oe()!=="deferred"||se()},r.aJ=gt,r.aK=Ga,r.aL=p1,r.aM=Zr,r.aN=_y,r.aO=fy,r.aP=Jo,r.aQ=gr,r.aR=Dg,r.aS=ev,r.aT=_m,r.aU=Py,r.aV=function(t,e){const i=Wa(e.zoom);if(i===0)return Mo(t);const s=cm(t),c=ty(s),h=ja(s.getWest())*e.worldSize,p=ja(s.getEast())*e.worldSize,y=Ko(s.getNorth())*e.worldSize,v=Ko(s.getSouth())*e.worldSize,T=[h,y,0],E=[p,y,0],I=[h,v,0],P=[p,v,0],R=r.a9.invert([],e.globeMatrix);return r.Q.transformMat4(T,T,R),r.Q.transformMat4(E,E,R),r.Q.transformMat4(I,I,R),r.Q.transformMat4(P,P,R),c[0]=ea(c[0],I,i),c[1]=ea(c[1],P,i),c[2]=ea(c[2],E,i),c[3]=ea(c[3],T,i),fn.fromPoints(c)},r.aW=hm,r.aX=Ad,r.aY=ea,r.aZ=Qn,r.a_=JS,r.ab=lc,r.ac=Gx,r.ad=xi,r.ae=Vr,r.af=function(t,e){const i={};for(let s=0;s<e.length;s++){const c=e[s];c in t&&(i[c]=t[c])}return i},r.ag=Ua,r.ah=Ko,r.ai=class{constructor(t){this.entries={},this.scheduler=t}request(t,e,i,s){const c=this.entries[t]=this.entries[t]||{callbacks:[]};if(c.result){const[h,p]=c.result;return this.scheduler?this.scheduler.add(()=>{s(h,p)},e):s(h,p),()=>{}}return c.callbacks.push(s),c.cancel||(c.cancel=i((h,p)=>{c.result=[h,p];for(const y of c.callbacks)this.scheduler?this.scheduler.add(()=>{y(h,p)},e):y(h,p);setTimeout(()=>delete this.entries[t],3e3)})),()=>{c.result||(c.callbacks=c.callbacks.filter(h=>h!==s),c.callbacks.length||(c.cancel(),delete this.entries[t]))}}},r.aj=Xi,r.ak=function(t,e,i){const s=JSON.stringify(t.request);return t.data&&(this.deduped.entries[s]={result:[null,t.data]}),this.deduped.request(s,{type:"parseTile",isSymbolTile:t.isSymbolTile,zoom:t.tileZoom},c=>{const h=bl(t.request,(p,y,v,T)=>{p?c(p):y&&c(null,{vectorTile:i?void 0:new py(new Gu(y)),rawData:y,cacheControl:v,expires:T})});return()=>{h.cancel(),c()}},e)},r.al=function(t){zh++,zh>hp&&(t.getActor().send("enforceCacheSizeLimit",Hc),zh=0)},r.am=Or,r.an=Gc,r.ao=function(t){return t<=1?1:Math.pow(2,Math.floor(Math.log(t)/Math.LN2))},r.ap=Mr,r.aq=Gb,r.ar=Wb,r.as=jb,r.at=function(t,e){const i=document.createElement("video");i.muted=!0,i.onloadstart=function(){e(null,i)};for(let s=0;s<t.length;s++){const c=document.createElement("source");Oh(t[s])||(i.crossOrigin="Anonymous"),c.src=t[s],i.appendChild(c)}return{cancel:()=>{}}},r.au=Vm,r.av=Nd,r.aw=is,r.ax=xr,r.ay=yr,r.az=Kn,r.b=mo,r.b$=qu,r.b0=C1,r.b1=bl,r.b2=function(t){const e=[];for(const i in t)e.push(t[i]);return e},r.b3=function(t,e){const i=[];for(const s in t)s in e||i.push(s);return i},r.b4=Ah,r.b5=["type","source","source-layer","minzoom","maxzoom","filter","layout"],r.b6=function(t,e){const{x:i,y:s}=t.point,c=ov(i,s,t.worldSize/t._pixelsPerMercatorPixel,0,0);return r.a9.multiply(c,c,iy(Mo(e)))},r.b8=Vu,r.b9=Ms,r.bA=Fx,r.bB=function(t){const e=r.a9.identity(new Float64Array(16));r.a9.multiply(e,t.pixelMatrix,t.globeMatrix);const i=[0,Ns,0],s=[0,Vs,0];return r.Q.transformMat4(i,i,e),r.Q.transformMat4(s,s,e),[i[0]>0&&i[0]<=t.width&&i[1]>0&&i[1]<=t.height&&!ry(t,new Ii(t.center.lat,90)),s[0]>0&&s[0]<=t.width&&s[1]>0&&s[1]<=t.height&&!ry(t,new Ii(t.center.lat,-90))]},r.bC=function(t,e){const{scale:i}=t.tileTransform,s=i*pt/(t.tileSize*Math.pow(2,e.zoom-t.tileID.overscaledZ+t.tileID.canonical.z));return r.b7.scale(new Float32Array(4),e.inverseAdjustmentMatrix,[s,s])},r.bD=Gm,r.bE=qb,r.bF=function(t){const e=qb(t,!0);return r.b7.invert([],[e[0],e[1],e[4],e[5]])},r.bG=Kg,r.bH=function(t){const{x:e,y:i}=t.point,{lng:s,lat:c}=t._center;return ov(e,i,t.worldSize,s,c)},r.bI=kr,r.bJ=Ng,r.bK=function(t){const e=Math.round((t+45+360)%360/90)%4;return op[e]},r.bL=45,r.bM=jg,r.bN=Td,r.bO=Ba,r.bP=Og,r.bQ=Nr,r.bR=im,r.bS=zx,r.bT=function(t,e,i){const s=Math.sqrt(t*t+e*e+i*i),c=s>0?Math.acos(i/s)*Eh:0;let h=t!==0||e!==0?Math.atan2(-e,-t)*Eh+90:0;return h<0&&(h+=360),[s,h,c]},r.bU=nm,r.bV=fn,r.bW=gl,r.bX=function(t){return[Math.pow(t[0],1/2.2),Math.pow(t[1],1/2.2),Math.pow(t[2],1/2.2)]},r.bY=function(t){return t({pluginStatus:H,pluginURL:q}),K.on("pluginStateChange",t),t},r.bZ=Yu,r.b_=Zm,r.ba=Mm,r.bb=function(t,e,i,s,c){const h=5*e+2;t.float32[h+0]=i,t.float32[h+1]=s,t.float32[h+2]=c},r.bc=Fm,r.bd=Tb,r.be=Zg,r.bf=vr,r.bg=Sy,r.bh=Pb,r.bi=by,r.bj=qy,r.bk=qs,r.bm=Si,r.bn=Oo,r.bo=Ur,r.bp=function(t,e,i){t[4*e+0]=i[0],t[4*e+1]=i[1],t[4*e+2]=i[2],t[4*e+3]=i[3]},r.bq=Ii,r.br=Nb,r.bs=Nx,r.bt=Jg,r.bu=Hb,r.bv=oc,r.bw=nv,r.bx=function(t,e,i,s,c,h,p,y,v){if(v.name==="globe")return nv(t,e,new oc(i,s,c),!1);const T=Nd({z:i,x:s,y:c},v);return new fn([(h+T.x/T.scale)*e,e*(T.y/T.scale),p],[(h+T.x2/T.scale)*e,e*(T.y2/T.scale),y])},r.by=function(t,e,i){let s=0;for(let c=0;c<2;++c)t[c]>0&&(s+=(t[c]-0)*(t[c]-0)),e[c]<0&&(s+=(0-e[c])*(0-e[c]));return s},r.bz=Rn,r.c=d1,r.c$=[1,1,1],r.c0=Ty,r.c1=xa,r.c2=Z,r.c3=Q,r.c4=qc,r.c5=Sl,r.c6=Hs,r.c7=function(t,e,i){return t.type==="custom"?new hI(t,e):new GI[t.type](t,e,i)},r.c8=function(t){const e=t.indexOf(Dn);return e>=0?t.slice(0,e):t},r.c9=function(t){return t.indexOf(Dn)>=0},r.cA=t=>({u_matrix:new Td(t),u_pixels_to_tile_units:new Fg(t),u_device_pixel_ratio:new Nr(t),u_units_to_pixels:new Ba(t),u_dash_image:new im(t),u_gradient_image:new im(t),u_image_height:new Nr(t),u_texsize:new Ba(t),u_tile_units_to_pixels:new Nr(t),u_alpha_discard_threshold:new Nr(t),u_trim_offset:new Ba(t),u_emissive_strength:new Nr(t)}),r.cB=t=>({u_matrix:new Td(t),u_texsize:new Ba(t),u_pixels_to_tile_units:new Fg(t),u_device_pixel_ratio:new Nr(t),u_image:new im(t),u_units_to_pixels:new Ba(t),u_tile_units_to_pixels:new Nr(t),u_alpha_discard_threshold:new Nr(t),u_trim_offset:new Ba(t)}),r.cC=ec,r.cD=gA,r.cE=yA,r.cF=cv,r.cG=(t,e,i,s,c,h)=>{const p=t.transform,y=p.projection.name==="globe";let v;if(h.paint.get("circle-pitch-alignment")==="map")if(y){const E=sv(p.zoom,e.canonical)*p._pixelsPerMercatorPixel;v=Float32Array.from([E,0,0,E])}else v=p.calculatePixelsToTileUnitsMatrix(i);else v=new Float32Array([p.pixelsToGLUnits[0],0,0,p.pixelsToGLUnits[1]]);const T={u_camera_to_center_distance:t.transform.getCameraToCenterDistance(p.projection),u_matrix:t.translatePosMatrix(e.projMatrix,i,h.paint.get("circle-translate"),h.paint.get("circle-translate-anchor")),u_device_pixel_ratio:ks.devicePixelRatio,u_extrude_scale:v,u_inv_rot_matrix:rE,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:h.paint.get("circle-emissive-strength")};if(y){T.u_inv_rot_matrix=s,T.u_merc_center=c,T.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],T.u_zoom_transition=Wa(p.zoom);const E=c[0]*pt,I=c[1]*pt;T.u_up_dir=p.projection.upVector(new oc(0,0,0),E,I)}return T},r.cH=tb,r.cI=(t,e,i,s,c,h)=>{const p=t.transform;return{u_matrix:eb(t,e,i,s),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:p.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:c,u_image:0,u_tile_units_to_pixels:Jv(e,p),u_units_to_pixels:[1/p.pixelsToGLUnits[0],1/p.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:h}},r.cJ=(t,e,i,s,c,h,p)=>{const y=t.transform,v=y.calculatePixelsToTileUnitsMatrix(e);return{u_matrix:eb(t,e,i,s),u_pixels_to_tile_units:v,u_device_pixel_ratio:h,u_units_to_pixels:[1/y.pixelsToGLUnits[0],1/y.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:c,u_texsize:ib(i)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:Jv(e,t.transform),u_alpha_discard_threshold:0,u_trim_offset:p,u_emissive_strength:i.paint.get("line-emissive-strength")}},r.cK=Ih,r.cL=Id,r.cM=Hv,r.cN=US,r.cO=Tm,r.cP=Za,r.cQ=450,r.cR=7,r.cS=lI,r.cT=256,r.cU=iy,r.cV=nc,r.cW=ic,r.cX=Cg,r.cY=function(t,e,i,s,c){return xi((t-e)/(i-e)*(c-s)+s,s,c)},r.cZ=ac,r.c_=Ry,r.ca=function(t){const e=t.indexOf(Dn);return e>=0?t.slice(e+1):""},r.cb=function(t){const e=[],i=t.id;return i===void 0&&e.push({message:`layers.${i}: missing required property "id"`}),t.render===void 0&&e.push({message:`layers.${i}: missing required method "render"`}),t.renderingMode&&t.renderingMode!=="2d"&&t.renderingMode!=="3d"&&e.push({message:`layers.${i}: property "renderingMode" must be either "2d" or "3d"`}),e},r.cc=ml,r.cd=K,r.ce=vl,r.cf=Lx,r.cg=class extends Qo{constructor(t){super(t),this.current=RS}set(t,e,i){if(this.fetchUniformLocation(t,e)){for(let s=0;s<9;s++)if(i[s]!==this.current[s]){this.current=i,this.gl.uniformMatrix3fv(this.location,!1,i);break}}}},r.ch=Fc,r.ci=function(t,e,i){const s=Wa(i.zoom),c=t.style.map._antialias,h=e.options.extStandardDerivativesForceOff||t.terrain&&t.terrain.exaggeration()>0;return s===0&&!c&&!h},r.cj=function(t){const e=t.pixelsPerMeter,i=e/Ur(1,t.center.lat),s=r.a9.identity(new Float64Array(16));return r.a9.translate(s,s,[t.point.x,t.point.y,0]),r.a9.scale(s,s,[i,i,e]),Float32Array.from(s)},r.ck=cm,r.cl=function(t){const e=Rn-5;t=xi(t,-e,e)/e*90;const i=Math.pow(Math.abs(Math.sin(Si(t))),3);return Math.round(i*(Vg.length-1))},r.cm=function(t,e,i,s){const c=e.getNorth(),h=e.getSouth(),p=e.getWest(),y=e.getEast(),v=1<<t.z,T=y-p,E=c-h,I=T/Du,P=-E/Vg[i],R=[0,I,0,P,0,0,c,p,0];if(t.z>0){const L=180/s;r.ct.multiply(R,R,[L/T+1,0,0,0,L/E+1,0,-.5*L/I,.5*L/P,1])}return R[2]=v,R[5]=t.x,R[8]=t.y,R},r.cn=Mo,r.co=function(t,e,i){const s=r.a9.identity(new Float64Array(16)),c=(e/(1<<t)-.5)*Math.PI*2;return r.a9.rotateY(s,i.globeMatrix,c),Float32Array.from(s)},r.cp=class{isDataAvailableAtPoint(t){const e=this._source();if(this.isUsingMockSource()||!e||t.y<0||t.y>1)return!1;const i=e.getSource().maxzoom,s=1<<i,c=Math.floor(t.x),h=Math.floor((t.x-c)*s),p=Math.floor(t.y*s),y=this.findDEMTileFor(new Mr(i,c,i,h,p));return!(!y||!y.dem)}getAtPointOrZero(t,e=0){return this.getAtPoint(t,e)||0}getAtPoint(t,e,i=!0){if(this.isUsingMockSource())return null;e==null&&(e=null);const s=this._source();if(!s||t.y<0||t.y>1)return e;const c=s.getSource().maxzoom,h=1<<c,p=Math.floor(t.x),y=t.x-p,v=new Mr(c,p,c,Math.floor(y*h),Math.floor(t.y*h)),T=this.findDEMTileFor(v);if(!T||!T.dem)return e;const E=T.dem,I=1<<T.tileID.canonical.z,P=(y*I-T.tileID.canonical.x)*E.dim,R=(t.y*I-T.tileID.canonical.y)*E.dim,L=Math.floor(P),B=Math.floor(R);return(i?this.exaggeration():1)*hi(hi(E.get(L,B),E.get(L,B+1),R-B),hi(E.get(L+1,B),E.get(L+1,B+1),R-B),P-L)}getAtTileOffset(t,e,i){const s=1<<t.canonical.z;return this.getAtPointOrZero(new Sr(t.wrap+(t.canonical.x+e/pt)/s,(t.canonical.y+i/pt)/s))}getAtTileOffsetFunc(t,e,i,s){return c=>{const h=this.getAtTileOffset(t,c.x,c.y),p=s.upVector(t.canonical,c.x,c.y),y=s.upVectorScale(t.canonical,e,i).metersToTile;return r.Q.scale(p,p,h*y),p}}getForTilePoints(t,e,i,s){if(this.isUsingMockSource())return!1;const c=Bu.create(this,t,s);return!!c&&(e.forEach(h=>{h[2]=this.exaggeration()*c.getElevationAt(h[0],h[1],i)}),!0)}getMinMaxForTile(t){if(this.isUsingMockSource())return null;const e=this.findDEMTileFor(t);if(!e||!e.dem)return null;const i=e.dem.tree,s=e.tileID,c=1<<t.canonical.z-s.canonical.z;let h=t.canonical.x/c-s.canonical.x,p=t.canonical.y/c-s.canonical.y,y=0;for(let v=0;v<t.canonical.z-s.canonical.z&&!i.leaves[y];v++){h*=2,p*=2;const T=2*Math.floor(p)+Math.floor(h);y=i.childOffsets[y]+T,h%=1,p%=1}return{min:this.exaggeration()*i.minimums[y],max:this.exaggeration()*i.maximums[y]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(t,e,i){throw new Error("Pure virtual method called.")}pointCoordinate(t){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(t){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const t=this.visibleDemTiles;if(t.length===0)return null;let e=!1,i=Number.MAX_VALUE,s=Number.MIN_VALUE;for(const c of t){const h=this.getMinMaxForTile(c.tileID);h&&(i=Math.min(i,h.min),s=Math.max(s,h.max),e=!0)}return e?{min:i,max:s}:null}},r.cq=lm,r.cr=mv,r.cs=function(t,e){return[Math.pow(t[0],2.2)*e,Math.pow(t[1],2.2)*e,Math.pow(t[2],2.2)*e]},r.cu=sv,r.cv=up,r.cw=_s,r.cx=256,r.cy=function(t,e){const i=[0,0,0],s=hm(Mo(e.canonical));return r.Q.transformMat4(i,i,s),r.Q.transformMat4(i,i,t),i},r.cz=t=>({u_camera_to_center_distance:new Nr(t),u_extrude_scale:new Fg(t),u_device_pixel_ratio:new Nr(t),u_matrix:new Td(t),u_inv_rot_matrix:new Td(t),u_merc_center:new Ba(t),u_tile_id:new Og(t),u_zoom_transition:new Nr(t),u_up_dir:new Og(t),u_emissive_strength:new Nr(t)}),r.d=Fh,r.d$=t1,r.d0=Bu,r.d1=$u,r.d2=ts,r.d3=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[]}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(t){const e=Sv(new ft(0,0),new ft(pt,pt),t),i=[];for(const s of this._activeRegions){if(s.hiddenByOverlap||!Mv(e,s))continue;const c=NE(s.min,s.max,t);i.push({min:c.min,max:c.max,sourceId:this._sourceIds[s.priority],footprint:s.footprint,footprintTileId:s.tileId})}return i}setSources(t){this._setSources(t.map(e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{const i=[];for(const s of e.cache.getVisibleCoordinates()){const c=e.cache.getTile(s).buckets[e.layer];if(c)for(const h of c.getNodesInfo()){const p=h.node;p.footprint&&i.push({footprint:p.footprint,id:s.toUnwrapped()})}}return i}})))}_addSource(t){const e=t.getFootprints();if(e.length!==0){for(const i of e){if(!i.footprint)continue;const s=Sv(i.footprint.min,i.footprint.max,i.id);this._activeRegions.push({min:s.min,max:s.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:i.id,footprint:i.footprint})}this._sourceIds.push(t.getSourceId())}}_computeReplacement(){this._activeRegions.sort((e,i)=>e.priority-i.priority||vm(e.min,i.min)||vm(e.max,i.max));let t=this._activeRegions.length!==this._prevRegions.length;if(!t){let e=0,i=0;for(;!t&&e!==this._activeRegions.length;){const s=this._activeRegions[e],c=this._prevRegions[i];t=s.priority!==c.priority||!Tv(s,c),++e,++i}}if(t){++this._updateTime;const e=i=>{const s=this._activeRegions;if(i>=s.length)return i;const c=s[i].priority;for(;i<s.length&&s[i].priority===c;)++i;return i};if(this._sourceIds.length>1){let i=0,s=e(i);for(;i!==s;){let c=i;const h=i;for(;c!==s;){const p=this._activeRegions[c];p.hiddenByOverlap=!1;for(let y=0;y<h;y++){const v=this._activeRegions[y];if(!v.hiddenByOverlap&&Mv(p,v)&&(p.hiddenByOverlap=Av(p.footprint,p.tileId,v.footprint,v.tileId),p.hiddenByOverlap))break}++c}i=s,s=e(i)}}}}_setSources(t){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=t.length-1;e>=0;e--)this._addSource(t[e]);this._computeReplacement()}},r.d4=class{constructor(t){this._createGrid(t),this._createPoles(t)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const t of this._poleSegments)t.destroy();for(const t of this._gridSegments)t.withSkirts.destroy(),t.withoutSkirts.destroy()}_fillGridMeshWithLods(t,e){const i=new gr,s=new Kn,c=[],h=t+1+2,p=e[0]+1,y=e[0]+1+(1+e.length),v=(T,E,I)=>{let P=T===h-1?T-2:T===0?T:T-1;return P+=I?24575:0,[P,E]};for(let T=0;T<h;++T)i.emplaceBack(...v(T,0,!0));for(let T=0;T<p;++T)for(let E=0;E<h;++E)i.emplaceBack(...v(E,T,(E===0||E===h-1)&&!0));for(let T=0;T<e.length;++T){const E=e[T];for(let I=0;I<h;++I)i.emplaceBack(...v(I,E,!0))}for(let T=0;T<e.length;++T){const E=s.length,I=e[T]+1+2,P=new Kn;for(let B=0;B<I-1;B++){const j=B===I-2,G=j?h*(y-e.length+T-B):h;for(let X=0;X<h-1;X++){const ie=B*h+X;B===0||j||X===0||X===h-2?(P.emplaceBack(ie+1,ie,ie+G),P.emplaceBack(ie+G,ie+G+1,ie+1)):(s.emplaceBack(ie+1,ie,ie+G),s.emplaceBack(ie+G,ie+G+1,ie+1))}}const R=kn.simpleSegment(0,E,i.length,s.length-E);for(let B=0;B<P.uint16.length;B+=3)s.emplaceBack(P.uint16[B],P.uint16[B+1],P.uint16[B+2]);const L=kn.simpleSegment(0,E,i.length,s.length-E);c.push({withoutSkirts:R,withSkirts:L})}return{vertices:i,indices:s,segments:c}}_createGrid(t){const e=this._fillGridMeshWithLods(Du,Vg);this._gridSegments=e.segments,this._gridBuffer=t.createVertexBuffer(e.vertices,ev.members),this._gridIndexBuffer=t.createIndexBuffer(e.indices,!0)}_createPoles(t){const e=new Kn;for(let p=0;p<=Du;p++)e.emplaceBack(0,p+1,p+2);this._poleIndexBuffer=t.createIndexBuffer(e,!0);const i=new ic,s=new ic,c=new ic,h=new ic;this._poleSegments=[];for(let p=0,y=0;p<Ng;p++){const v=360/(1<<p);i.emplaceBack(0,-Vr,0,.5,0),s.emplaceBack(0,-Vr,0,.5,1),c.emplaceBack(0,-Vr,0,.5,.5),h.emplaceBack(0,-Vr,0,.5,.5);for(let T=0;T<=Du;T++){let E=T/Du,I=0;const P=hi(0,v,E),[R,L,B]=ku(iE,nE,P,Vr);i.emplaceBack(R,L,B,E,I),s.emplaceBack(R,L,B,E,1-I);const j=Si(P);E=.5+.5*Math.sin(j),I=.5+.5*Math.cos(j),c.emplaceBack(R,L,B,E,I),h.emplaceBack(R,L,B,E,1-I)}this._poleSegments.push(kn.simpleSegment(y,0,66,64)),y+=66}this._poleNorthVertexBuffer=t.createVertexBuffer(i,am,!1),this._poleSouthVertexBuffer=t.createVertexBuffer(s,am,!1),this._texturedPoleNorthVertexBuffer=t.createVertexBuffer(c,am,!1),this._texturedPoleSouthVertexBuffer=t.createVertexBuffer(h,am,!1)}getGridBuffers(t,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[t].withSkirts:this._gridSegments[t].withoutSkirts]}getPoleBuffers(t,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[t]]}},r.d5=function(t){return tu.has(t)},r.d6=ap,r.d7=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},r.d8=ms,r.d9=jx,r.dA=Hd,r.dB=function(t){const e=Rh();if(!e)return;const i=e.delete(_a);t&&i.catch(t).then(()=>t())},r.dC=qd,r.dD=i1,r.dE=function(t){By=ks.resolveURL(t),Xu||(Xu=new Yu(Zm(),new No)),Xu.broadcast("setDracoUrl",By)},r.dF=n1,r.dG=function(t){Qu=ks.resolveURL(t),Xu||(Xu=new Yu(Zm(),new No)),Xu.broadcast("setMeshoptUrl",Qu)},r.dH=Mt,r.dI=qa,r.dJ=to,r.dK=f1,r.dL=m1,r.dM=Qv,r.dN=pa,r.dO=Sb,r.dP=function(t,e,i,s,c,h,p,y,v,T,E){t.createArrays(),t.tilePixelRatio=pt/(512*t.overscaling),t.compareText={},t.iconsNeedLinear=!1;const I=t.layers[0].layout,P=t.layers[0]._unevaluatedLayout._values,R={};if(t.textSizeData.kind==="composite"){const{minZoom:G,maxZoom:X}=t.textSizeData;R.compositeTextSizes=[P["text-size"].possiblyEvaluate(new Y(G),y),P["text-size"].possiblyEvaluate(new Y(X),y)]}if(t.iconSizeData.kind==="composite"){const{minZoom:G,maxZoom:X}=t.iconSizeData;R.compositeIconSizes=[P["icon-size"].possiblyEvaluate(new Y(G),y),P["icon-size"].possiblyEvaluate(new Y(X),y)]}R.layoutTextSize=P["text-size"].possiblyEvaluate(new Y(v+1),y),R.layoutIconSize=P["icon-size"].possiblyEvaluate(new Y(v+1),y),R.textMaxSize=P["text-size"].possiblyEvaluate(new Y(18),y);const L=I.get("text-rotation-alignment")==="map"&&I.get("symbol-placement")!=="point",B=I.get("text-size");let j=!1;for(const G of t.features)if(G.icon&&G.icon.nameSecondary){j=!0;break}for(const G of t.features){const X=I.get("text-font").evaluate(G,{},y).join(","),ie=B.evaluate(G,{},y),J=R.layoutTextSize.evaluate(G,{},y),he=(R.layoutIconSize.evaluate(G,{},y),{horizontal:{},vertical:void 0}),re=G.text;let pe,_e=[0,0];if(re){const Ce=re.toString(),Be=I.get("text-letter-spacing").evaluate(G,{},y)*vr,Fe=I.get("text-line-height").evaluate(G,{},y)*vr,Oe=f(Ce)?Be:0,Ze=I.get("text-anchor").evaluate(G,{},y),We=I.get("text-variable-anchor");if(!We){const vt=I.get("text-radial-offset").evaluate(G,{},y);_e=vt?Pb(Ze,[vt*vr,My]):I.get("text-offset").evaluate(G,{},y).map(tt=>tt*vr)}let Je=L?"center":I.get("text-justify").evaluate(G,{},y);const Qe=I.get("symbol-placement")==="point",Ne=Qe?I.get("text-max-width").evaluate(G,{},y)*vr:1/0,At=vt=>{t.allowVerticalPlacement&&a(Ce)&&(he.vertical=vy(re,e,i,c,X,Ne,Fe,Ze,vt,Oe,_e,Ms.vertical,!0,J,ie))};if(!L&&We){const vt=Je==="auto"?We.map(Gt=>Sy(Gt)):[Je];let tt=!1;for(let Gt=0;Gt<vt.length;Gt++){const kt=vt[Gt];if(!he.horizontal[kt])if(tt)he.horizontal[kt]=he.horizontal[0];else{const It=vy(re,e,i,c,X,Ne,Fe,"center",kt,Oe,_e,Ms.horizontal,!1,J,ie);It&&(he.horizontal[kt]=It,tt=It.positionedLines.length===1)}}At("left")}else{if(Je==="auto"&&(Je=Sy(Ze)),Qe||I.get("text-writing-mode").indexOf("horizontal")>=0||!a(Ce)){const vt=vy(re,e,i,c,X,Ne,Fe,Ze,Je,Oe,_e,Ms.horizontal,!1,J,ie);vt&&(he.horizontal[Je]=vt)}At(Qe?"left":Je)}}let Se=!1;if(G.icon&&G.icon.namePrimary){const Ce=s[G.icon.namePrimary];Ce&&(pe=FA(c[G.icon.namePrimary],G.icon.nameSecondary?c[G.icon.nameSecondary]:void 0,I.get("icon-offset").evaluate(G,{},y),I.get("icon-anchor").evaluate(G,{},y)),Se=Ce.sdf,t.sdfIcons===void 0?t.sdfIcons=Ce.sdf:t.sdfIcons!==Ce.sdf&&wn("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Ce.pixelRatio!==t.pixelRatio||I.get("icon-rotate").constantOr(1)!==0)&&(t.iconsNeedLinear=!0))}const Le=kb(he.horizontal)||he.vertical;t.iconsInText||(t.iconsInText=!!Le&&Le.iconsInText),(Le||pe)&&WA(t,G,he,pe,s,R,J,0,_e,Se,p,y,T,E,j)}h&&t.generateCollisionDebugBuffers(v,t.collisionBoxArray)},r.dQ=py,r.dR=Gu,r.dS=bm,r.dT=ym,r.dU=gm,r.dV=Oc,r.dW=ob,r.dX=Ee,r.dY=function(t){let e=0;if(new Uint32Array(t,0,1)[0]!==s1){const i=new Uint32Array(t,0,7),[,,s,c,h,p]=i;e=i.byteLength+c+h+p+h,(s!==t.byteLength||e>=t.byteLength)&&wn("Invalid b3dm header information.")}return c1(t,e)},r.dZ=function(t,e){const i=d1(t);for(const s of i){for(const c of s.meshes)FI(c);s.lights&&(s.lightMeshIndex=s.meshes.length,s.meshes.push(BI(s.lights,e)))}return i},r.d_=Xm,r.da=sc,r.db=function([t,e,i]){const s=Math.hypot(t,e,i),c=Math.atan2(t,i),h=.5*Math.PI-Math.acos(-e/s);return new Ii(kr(c),kr(h))},r.dc=Ru,r.dd=N,r.de=ry,r.df=av,r.dg=function(t){const e=[0,0,0],i=r.a9.identity(new Float64Array(16));return r.a9.multiply(i,t.pixelMatrix,t.globeMatrix),r.Q.transformMat4(e,e,i),new ft(e[0],e[1])},r.dh=function(t){const e=t.navigator?t.navigator.userAgent:null;return!!function(i){if(jc==null){const s=i.navigator?i.navigator.userAgent:null;jc=!!i.safari||!(!s||!(/\b(iPad|iPhone|iPod)\b/.test(s)||s.match("Safari")&&!s.match("Chrome")))}return jc}(t)&&e&&(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},r.di=class{constructor(t,e,i){this._transformRequestFn=t,this._customAccessToken=e,this._silenceAuthErrors=!!i,this._createSkuToken()}_createSkuToken(){const t=function(){let e="";for(let i=0;i<10;i++)e+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",Tl,e].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,e){return this._transformRequestFn&&this._transformRequestFn(t,e)||{url:t}}normalizeStyleURL(t,e){if(!Q(t))return t;const i=gs(t);return i.params.push(`sdk=js-${k}`),i.path=`/styles/v1${i.path}`,this._makeAPIURL(i,this._customAccessToken||e)}normalizeGlyphsURL(t,e){if(!Q(t))return t;const i=gs(t);return i.path=`/fonts/v1${i.path}`,this._makeAPIURL(i,this._customAccessToken||e)}normalizeModelURL(t,e){if(!Q(t))return t;const i=gs(t);return i.path=`/models/v1${i.path}`,this._makeAPIURL(i,this._customAccessToken||e)}normalizeSourceURL(t,e,i,s){if(!Q(t))return t;const c=gs(t);return c.path=`/v4/${c.authority}.json`,c.params.push("secure"),i&&c.params.push(`language=${i}`),s&&c.params.push(`worldview=${s}`),this._makeAPIURL(c,this._customAccessToken||e)}normalizeSpriteURL(t,e,i,s){const c=gs(t);return Q(t)?(c.path=`/styles/v1${c.path}/sprite${e}${i}`,this._makeAPIURL(c,this._customAccessToken||s)):(c.path+=`${e}${i}`,va(c))}normalizeTileURL(t,e,i){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!Q(t))return t;const s=gs(t);s.path=s.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${e||i&&s.authority!=="raster"&&i===512?"@2x":""}${Bo.supported?".webp":"$1"}`),s.authority==="raster"?s.path=`/${N.RASTER_URL_PREFIX}${s.path}`:s.authority==="rasterarrays"?s.path=`/${N.RASTERARRAYS_URL_PREFIX}${s.path}`:(s.path=s.path.replace(/^.+\/v4\//,"/"),s.path=`/${N.TILE_URL_VERSION}${s.path}`);const c=this._customAccessToken||function(h){for(const p of h){const y=p.match(/^access_token=(.*)$/);if(y)return y[1]}return null}(s.params)||N.ACCESS_TOKEN;return N.REQUIRE_ACCESS_TOKEN&&c&&this._skuToken&&s.params.push(`sku=${this._skuToken}`),this._makeAPIURL(s,c)}canonicalizeTileURL(t,e){const i=gs(t);if(!i.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!i.path.match(/\.[\w]+$/))return t;let s="mapbox://";i.path.match(/^\/raster\/v1\//)?s+=`raster/${i.path.replace(`/${N.RASTER_URL_PREFIX}/`,"")}`:i.path.match(/^\/rasterarrays\/v1\//)?s+=`rasterarrays/${i.path.replace(`/${N.RASTERARRAYS_URL_PREFIX}/`,"")}`:s+=`tiles/${i.path.replace(`/${N.TILE_URL_VERSION}/`,"")}`;let c=i.params;return e&&(c=c.filter(h=>!h.match(/^access_token=/))),c.length&&(s+=`?${c.join("&")}`),s}canonicalizeTileset(t,e){const i=!!e&&Q(e),s=[];for(const c of t.tiles||[])W(c)?s.push(this.canonicalizeTileURL(c,i)):s.push(c);return s}_makeAPIURL(t,e){const i="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",s=gs(N.API_URL);if(t.protocol=s.protocol,t.authority=s.authority,t.protocol==="http"){const c=t.params.indexOf("secure");c>=0&&t.params.splice(c,1)}if(s.path!=="/"&&(t.path=`${s.path}${t.path}`),!N.REQUIRE_ACCESS_TOKEN)return va(t);if(e=e||N.ACCESS_TOKEN,!this._silenceAuthErrors){if(!e)throw new Error(`An API access token is required to use Mapbox GL. ${i}`);if(e[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${i}`)}return t.params=t.params.filter(c=>c.indexOf("access_token")===-1),t.params.push(`access_token=${e||""}`),va(t)}},r.dj=function(t,e){e?tu.add(t):tu.delete(t)},r.dk=Bo,r.dl=Jc,r.dm=Vh,r.dn=Xc,r.dp=Fr,r.dq=ug,r.dr=function(t){tu.delete(t)},r.ds=eu,r.dt=po,r.du=k,r.dv=function(t,e){Hc=t,hp=e},r.dw=function(t,e,i=!1){if(H===z||H===O||H===V)throw new Error("setRTLTextPlugin cannot be called multiple times.");q=ks.resolveURL(t),H=z,U=e,$(),i||se()},r.dx=oe,r.dy=function(){Zm().acquire(Fy)},r.dz=function(){const t=Zd;t&&(t.isPreloaded()&&t.numActive()===1?(t.release(Fy),Zd=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},r.e=Jr,r.e0=le,r.e1=function(t){ga(),$s&&$s.then(e=>{e.keys().then(i=>{for(let s=0;s<i.length-t;s++)e.delete(i[s])})})},r.f=ks,r.g=function(t,e){return vl(Jr(t,{type:"json"}),e)},r.h=Ts,r.i=class extends qm{},r.j=go,r.k=ou,r.l=function(t){return fetch(t).then(e=>e.arrayBuffer()).then(e=>c1(e,0,t))},r.m=Su,r.n=Zp,r.o=Au,r.p=Mb,r.q=Re,r.r=Qp,r.s=za,r.t=La,r.u=De,r.v=Vl,r.w=wn,r.x=jl,r.y=vo}),M(["./shared"],function(r){function k(rt){const ne=rt?rt.url.toString():void 0;return ne?performance.getEntriesByName(ne):[]}function F(rt){if(typeof rt=="number"||typeof rt=="boolean"||typeof rt=="string"||rt==null)return JSON.stringify(rt);if(Array.isArray(rt)){let ue="[";for(const be of rt)ue+=`${F(be)},`;return`${ue}]`}let ne="{";for(const ue of Object.keys(rt).sort())ne+=`${ue}:${F(rt[ue])},`;return`${ne}}`}function N(rt){let ne="";for(const ue of r.b5)ne+=`/${F(rt[ue])}`;return ne}class W{constructor(ne){this.keyCache={},this._layers={},this._layerConfigs={},ne&&this.replace(ne)}replace(ne,ue){this._layerConfigs={},this._layers={},this.update(ne,[],ue)}update(ne,ue,be){this._options=be;for(const Ke of ne)this._layerConfigs[Ke.id]=Ke,(this._layers[Ke.id]=r.c7(Ke,this.scope,this._options)).compileFilter(),this.keyCache[Ke.id]&&delete this.keyCache[Ke.id];for(const Ke of ue)delete this.keyCache[Ke],delete this._layerConfigs[Ke],delete this._layers[Ke];this.familiesBySource={};const $e=function(Ke,ot){const Dt={};for(let St=0;St<Ke.length;St++){const Ct=ot&&ot[Ke[St].id]||N(Ke[St]);ot&&(ot[Ke[St].id]=Ct);let Lt=Dt[Ct];Lt||(Lt=Dt[Ct]=[]),Lt.push(Ke[St])}const He=[];for(const St in Dt)He.push(Dt[St]);return He}(r.b2(this._layerConfigs),this.keyCache);for(const Ke of $e){const ot=Ke.map(yt=>this._layers[yt.id]),Dt=ot[0];if(Dt.visibility==="none")continue;const He=Dt.source||"";let St=this.familiesBySource[He];St||(St=this.familiesBySource[He]={});const Ct=Dt.sourceLayer||"_geojsonTileLayer";let Lt=St[Ct];Lt||(Lt=St[Ct]=[]),Lt.push(ot)}}}const Q=1*r.dJ;class te{constructor(ne){const ue={},be=[];for(const Dt in ne){const He=ne[Dt],St=ue[Dt]={};for(const Ct in He.glyphs){const Lt=He.glyphs[+Ct];if(!Lt||Lt.bitmap.width===0||Lt.bitmap.height===0)continue;const yt=Lt.metrics.localGlyph?Q:1,$i={x:0,y:0,w:Lt.bitmap.width+2*yt,h:Lt.bitmap.height+2*yt};be.push($i),St[Ct]=$i}}const{w:$e,h:Ke}=r.p(be),ot=new r.dI({width:$e||1,height:Ke||1});for(const Dt in ne){const He=ne[Dt];for(const St in He.glyphs){const Ct=He.glyphs[+St];if(!Ct||Ct.bitmap.width===0||Ct.bitmap.height===0)continue;const Lt=ue[Dt][St],yt=Ct.metrics.localGlyph?Q:1;r.dI.copy(Ct.bitmap,ot,{x:0,y:0},{x:Lt.x+yt,y:Lt.y+yt},Ct.bitmap)}}this.image=ot,this.positions=ue}}r.dH(te,"GlyphAtlas");class ce{constructor(ne){this.tileID=new r.ap(ne.tileID.overscaledZ,ne.tileID.wrap,ne.tileID.canonical.z,ne.tileID.canonical.x,ne.tileID.canonical.y),this.tileZoom=ne.tileZoom,this.uid=ne.uid,this.zoom=ne.zoom,this.canonical=ne.tileID.canonical,this.pixelRatio=ne.pixelRatio,this.tileSize=ne.tileSize,this.source=ne.source,this.scope=ne.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=ne.showCollisionBoxes,this.collectResourceTiming=!!ne.collectResourceTiming,this.promoteId=ne.promoteId,this.isSymbolTile=ne.isSymbolTile,this.tileTransform=r.av(ne.tileID.canonical,ne.projection),this.projection=ne.projection,this.brightness=ne.brightness,this.extraShadowCaster=!!ne.extraShadowCaster}parse(ne,ue,be,$e,Ke){this.status="parsing",this.data=ne,this.collisionBoxArray=new r.aG;const ot=new r.dK(Object.keys(ne.layers).sort()),Dt=new r.dL(this.tileID,this.promoteId);Dt.bucketLayerIDs=[];const He={},St=new r.dM(256,256),Ct={featureIndex:Dt,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:St,availableImages:be,brightness:this.brightness},Lt=ue.familiesBySource[this.source];for(const Yi in Lt){const yn=ne.layers[Yi];if(!yn)continue;let nr=!1,ln=!1,Cr=!1;for(const Un of Lt[Yi])Un[0].type==="symbol"?nr=!0:ln=!0,Un[0].is3D()&&Un[0].type!=="model"&&(Cr=!0);if(this.extraShadowCaster&&!Cr||this.isSymbolTile===!0&&!nr||this.isSymbolTile===!1&&!ln)continue;yn.version===1&&r.w(`Vector tile source "${this.source}" layer "${Yi}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const wr=ot.encode(Yi),ds=[];for(let Un=0;Un<yn.length;Un++){const vn=yn.feature(Un),je=Dt.getId(vn,Yi);ds.push({feature:vn,id:je,index:Un,sourceLayerIndex:wr})}for(const Un of Lt[Yi]){const vn=Un[0];(!this.extraShadowCaster||vn.is3D()&&vn.type!=="model")&&(this.isSymbolTile!==void 0&&vn.type==="symbol"!==this.isSymbolTile||vn.minzoom&&this.zoom<Math.floor(vn.minzoom)||vn.maxzoom&&this.zoom>=vn.maxzoom||vn.visibility!=="none"&&(de(Un,this.zoom,Ct.brightness,be),(He[vn.id]=vn.createBucket({index:Dt.bucketLayerIDs.length,layers:Un,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:wr,sourceID:this.source,projection:this.projection.spec})).populate(ds,Ct,this.tileID.canonical,this.tileTransform),Dt.bucketLayerIDs.push(Un.map(je=>je.id))))}}let yt,$i,zi,qi;St.trim();const Li={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},Oi=()=>{if(yt)return this.status="done",Ke(yt);if(this.extraShadowCaster)this.status="done",Ke(null,{buckets:r.b2(He).filter(Yi=>!Yi.isEmpty()),featureIndex:Dt,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:Ct.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if($i&&zi&&qi){const Yi=new te($i),yn=new r.dO(zi,qi);for(const nr in He){const ln=He[nr];ln instanceof r.aH?(de(ln.layers,this.zoom,Ct.brightness,be),r.dP(ln,$i,Yi.positions,zi,yn.iconPositions,this.showCollisionBoxes,be,this.tileID.canonical,this.tileZoom,this.projection,this.brightness)):ln.hasPattern&&(ln instanceof r.aN||ln instanceof r.aO||ln instanceof r.cO)&&(de(ln.layers,this.zoom,Ct.brightness,be),ln.addFeatures(Ct,this.tileID.canonical,yn.patternPositions,be,this.tileTransform,this.brightness))}this.status="done",Ke(null,{buckets:r.b2(He).filter(nr=>!nr.isEmpty()),featureIndex:Dt,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Yi.image,lineAtlas:St,imageAtlas:yn,brightness:Ct.brightness})}};if(!this.extraShadowCaster){const Yi=r.dN(Ct.glyphDependencies,ln=>Object.keys(ln).map(Number));Object.keys(Yi).length?$e.send("getGlyphs",{uid:this.uid,stacks:Yi,scope:this.scope},(ln,Cr)=>{yt||(yt=ln,$i=Cr,Oi())},void 0,!1,Li):$i={};const yn=Object.keys(Ct.iconDependencies);yn.length?$e.send("getImages",{icons:yn,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(ln,Cr)=>{yt||(yt=ln,zi=Cr,Oi())},void 0,!1,Li):zi={};const nr=Object.keys(Ct.patternDependencies);nr.length?$e.send("getImages",{icons:nr,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(ln,Cr)=>{yt||(yt=ln,qi=Cr,Oi())},void 0,!1,Li):qi={}}Oi()}}function de(rt,ne,ue,be){const $e=new r.N(ne,{brightness:ue});for(const Ke of rt)Ke.recalculate($e,be)}class ve extends r.E{constructor(ne,ue,be,$e,Ke,ot){super(),this.actor=ne,this.layerIndex=ue,this.availableImages=be,this.loadVectorData=Ke||r.ak,this.loading={},this.loaded={},this.deduped=new r.ai(ne.scheduler),this.isSpriteLoaded=$e,this.scheduler=ne.scheduler,this.brightness=ot}loadTile(ne,ue){const be=ne.uid,$e=ne&&ne.request,Ke=$e&&$e.collectResourceTiming,ot=this.loading[be]=new ce(ne);ot.abort=this.loadVectorData(ne,(Dt,He)=>{const St=!this.loading[be];if(delete this.loading[be],St||Dt||!He)return ot.status="done",St||(this.loaded[be]=ot),ue(Dt);const Ct=He.rawData,Lt={};He.expires&&(Lt.expires=He.expires),He.cacheControl&&(Lt.cacheControl=He.cacheControl),ot.vectorTile=He.vectorTile||new r.dQ(new r.dR(Ct));const yt=()=>{ot.parse(ot.vectorTile,this.layerIndex,this.availableImages,this.actor,($i,zi)=>{if($i||!zi)return ue($i);const qi={};if(Ke){const Li=k($e);Li.length>0&&(qi.resourceTiming=JSON.parse(JSON.stringify(Li)))}ue(null,r.e({rawTileData:Ct.slice(0)},zi,Lt,qi))})};this.isSpriteLoaded?yt():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(yt,{type:"parseTile",isSymbolTile:ne.isSymbolTile,zoom:ne.tileZoom}):yt()}),this.loaded=this.loaded||{},this.loaded[be]=ot})}reloadTile(ne,ue){const be=this.loaded,$e=ne.uid,Ke=this;if(be&&be[$e]){const ot=be[$e];ot.showCollisionBoxes=ne.showCollisionBoxes,ot.projection=ne.projection,ot.brightness=ne.brightness,ot.tileTransform=r.av(ne.tileID.canonical,ne.projection),ot.extraShadowCaster=ne.extraShadowCaster;const Dt=(He,St)=>{const Ct=ot.reloadCallback;Ct&&(delete ot.reloadCallback,ot.parse(ot.vectorTile,Ke.layerIndex,this.availableImages,Ke.actor,Ct)),ue(He,St)};ot.status==="parsing"?ot.reloadCallback=Dt:ot.status==="done"&&(ot.vectorTile?ot.parse(ot.vectorTile,this.layerIndex,this.availableImages,this.actor,Dt):Dt())}else ue(null,void 0)}abortTile(ne,ue){const be=ne.uid,$e=this.loading[be];$e&&($e.abort&&$e.abort(),delete this.loading[be]),ue()}removeTile(ne,ue){const be=this.loaded,$e=ne.uid;be&&be[$e]&&delete be[$e],ue()}}class Te{loadTile(ne,ue){const{uid:be,encoding:$e,rawImageData:Ke,padding:ot}=ne,Dt=ImageBitmap&&Ke instanceof ImageBitmap?this.getImageData(Ke,ot):Ke;ue(null,new r.dS(be,Dt,$e,ot<1))}getImageData(ne,ue){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(ne.width,ne.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=ne.width,this.offscreenCanvas.height=ne.height,this.offscreenCanvasContext.drawImage(ne,0,0,ne.width,ne.height);const be=this.offscreenCanvasContext.getImageData(-ue,-ue,ne.width+2*ue,ne.height+2*ue);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),be}}class Ee{decodeRasterArray({task:ne,buffer:ue},be){r.b0.performDecoding(ue,ne).then($e=>{be(null,$e)},$e=>{be($e)})}}const Me=r.dT.prototype.toGeoJSON;let Ie=class{constructor(rt){this._feature=rt,this.extent=r.Y,this.type=rt.type,this.properties=rt.tags,"id"in rt&&!isNaN(rt.id)&&(this.id=parseInt(rt.id,10))}loadGeometry(){if(this._feature.type===1){const rt=[];for(const ne of this._feature.geometry)rt.push([new r.P(ne[0],ne[1])]);return rt}{const rt=[];for(const ne of this._feature.geometry){const ue=[];for(const be of ne)ue.push(new r.P(be[0],be[1]));rt.push(ue)}return rt}}toGeoJSON(rt,ne,ue){return Me.call(this,rt,ne,ue)}},qe=class{constructor(rt){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=r.Y,this.length=rt.length,this._features=rt}feature(rt){return new Ie(this._features[rt])}};var Ve={exports:{}},nt=r.dV,lt=r.dU.VectorTileFeature,ht=st;function st(rt,ne){this.options=ne||{},this.features=rt,this.length=rt.length}function Ot(rt,ne){this.id=typeof rt.id=="number"?rt.id:void 0,this.type=rt.type,this.rawGeometry=rt.type===1?[rt.geometry]:rt.geometry,this.properties=rt.tags,this.extent=ne||4096}st.prototype.feature=function(rt){return new Ot(this.features[rt],this.options.extent)},Ot.prototype.loadGeometry=function(){var rt=this.rawGeometry;this.geometry=[];for(var ne=0;ne<rt.length;ne++){for(var ue=rt[ne],be=[],$e=0;$e<ue.length;$e++)be.push(new nt(ue[$e][0],ue[$e][1]));this.geometry.push(be)}return this.geometry},Ot.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var rt=this.geometry,ne=1/0,ue=-1/0,be=1/0,$e=-1/0,Ke=0;Ke<rt.length;Ke++)for(var ot=rt[Ke],Dt=0;Dt<ot.length;Dt++){var He=ot[Dt];ne=Math.min(ne,He.x),ue=Math.max(ue,He.x),be=Math.min(be,He.y),$e=Math.max($e,He.y)}return[ne,be,ue,$e]},Ot.prototype.toGeoJSON=lt.prototype.toGeoJSON;var oi=r.dW,ii=ht;function Xe(rt){var ne=new oi;return function(ue,be){for(var $e in ue.layers)be.writeMessage(3,wt,ue.layers[$e])}(rt,ne),ne.finish()}function wt(rt,ne){var ue;ne.writeVarintField(15,rt.version||1),ne.writeStringField(1,rt.name||""),ne.writeVarintField(5,rt.extent||4096);var be={keys:[],values:[],keycache:{},valuecache:{}};for(ue=0;ue<rt.length;ue++)be.feature=rt.feature(ue),ne.writeMessage(2,di,be);var $e=be.keys;for(ue=0;ue<$e.length;ue++)ne.writeStringField(3,$e[ue]);var Ke=be.values;for(ue=0;ue<Ke.length;ue++)ne.writeMessage(4,Kt,Ke[ue])}function di(rt,ne){var ue=rt.feature;ue.id!==void 0&&ne.writeVarintField(1,ue.id),ne.writeMessage(2,Bt,rt),ne.writeVarintField(3,ue.type),ne.writeMessage(4,_n,ue)}function Bt(rt,ne){var ue=rt.feature,be=rt.keys,$e=rt.values,Ke=rt.keycache,ot=rt.valuecache;for(var Dt in ue.properties){var He=ue.properties[Dt],St=Ke[Dt];if(He!==null){St===void 0&&(be.push(Dt),Ke[Dt]=St=be.length-1),ne.writeVarint(St);var Ct=typeof He;Ct!=="string"&&Ct!=="boolean"&&Ct!=="number"&&(He=JSON.stringify(He));var Lt=Ct+":"+He,yt=ot[Lt];yt===void 0&&($e.push(He),ot[Lt]=yt=$e.length-1),ne.writeVarint(yt)}}}function fi(rt,ne){return(ne<<3)+(7&rt)}function Cn(rt){return rt<<1^rt>>31}function _n(rt,ne){for(var ue=rt.loadGeometry(),be=rt.type,$e=0,Ke=0,ot=ue.length,Dt=0;Dt<ot;Dt++){var He=ue[Dt],St=1;be===1&&(St=He.length),ne.writeVarint(fi(1,St));for(var Ct=be===3?He.length-1:He.length,Lt=0;Lt<Ct;Lt++){Lt===1&&be!==1&&ne.writeVarint(fi(2,Ct-1));var yt=He[Lt].x-$e,$i=He[Lt].y-Ke;ne.writeVarint(Cn(yt)),ne.writeVarint(Cn($i)),$e+=yt,Ke+=$i}be===3&&ne.writeVarint(fi(7,1))}}function Kt(rt,ne){var ue=typeof rt;ue==="string"?ne.writeStringField(1,rt):ue==="boolean"?ne.writeBooleanField(7,rt):ue==="number"&&(rt%1!=0?ne.writeDoubleField(3,rt):rt<0?ne.writeSVarintField(6,rt):ne.writeVarintField(5,rt))}Ve.exports=Xe,Ve.exports.fromVectorTileJs=Xe,Ve.exports.fromGeojsonVt=function(rt,ne){ne=ne||{};var ue={};for(var be in rt)ue[be]=new ii(rt[be].features,ne),ue[be].name=be,ue[be].version=ne.version,ue[be].extent=ne.extent;return Xe({layers:ue})},Ve.exports.GeoJSONWrapper=ii;var gn=r.dX(Ve.exports);const ji={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:rt=>rt},On=Math.fround||(Zn=new Float32Array(1),rt=>(Zn[0]=+rt,Zn[0]));var Zn;const pr=3,Vt=5,Wt=6;class Ht{constructor(ne){this.options=Object.assign(Object.create(ji),ne),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(ne){const{log:ue,minZoom:be,maxZoom:$e}=this.options;ue&&console.time("total time");const Ke=`prepare ${ne.length} points`;ue&&console.time(Ke),this.points=ne;const ot=[];for(let He=0;He<ne.length;He++){const St=ne[He];if(!St.geometry)continue;const[Ct,Lt]=St.geometry.coordinates,yt=On(Fn(Ct)),$i=On(Zi(Lt));ot.push(yt,$i,1/0,He,-1,1),this.options.reduce&&ot.push(0)}let Dt=this.trees[$e+1]=this._createTree(ot);ue&&console.timeEnd(Ke);for(let He=$e;He>=be;He--){const St=+Date.now();Dt=this.trees[He]=this._createTree(this._cluster(Dt,He)),ue&&console.log("z%d: %d clusters in %dms",He,Dt.numItems,+Date.now()-St)}return ue&&console.timeEnd("total time"),this}getClusters(ne,ue){let be=((ne[0]+180)%360+360)%360-180;const $e=Math.max(-90,Math.min(90,ne[1]));let Ke=ne[2]===180?180:((ne[2]+180)%360+360)%360-180;const ot=Math.max(-90,Math.min(90,ne[3]));if(ne[2]-ne[0]>=360)be=-180,Ke=180;else if(be>Ke){const Lt=this.getClusters([be,$e,180,ot],ue),yt=this.getClusters([-180,$e,Ke,ot],ue);return Lt.concat(yt)}const Dt=this.trees[this._limitZoom(ue)],He=Dt.range(Fn(be),Zi(ot),Fn(Ke),Zi($e)),St=Dt.data,Ct=[];for(const Lt of He){const yt=this.stride*Lt;Ct.push(St[yt+Vt]>1?Ui(St,yt,this.clusterProps):this.points[St[yt+pr]])}return Ct}getChildren(ne){const ue=this._getOriginId(ne),be=this._getOriginZoom(ne),$e="No cluster with the specified id.",Ke=this.trees[be];if(!Ke)throw new Error($e);const ot=Ke.data;if(ue*this.stride>=ot.length)throw new Error($e);const Dt=this.options.radius/(this.options.extent*Math.pow(2,be-1)),He=Ke.within(ot[ue*this.stride],ot[ue*this.stride+1],Dt),St=[];for(const Ct of He){const Lt=Ct*this.stride;ot[Lt+4]===ne&&St.push(ot[Lt+Vt]>1?Ui(ot,Lt,this.clusterProps):this.points[ot[Lt+pr]])}if(St.length===0)throw new Error($e);return St}getLeaves(ne,ue,be){const $e=[];return this._appendLeaves($e,ne,ue=ue||10,be=be||0,0),$e}getTile(ne,ue,be){const $e=this.trees[this._limitZoom(ne)],Ke=Math.pow(2,ne),{extent:ot,radius:Dt}=this.options,He=Dt/ot,St=(be-He)/Ke,Ct=(be+1+He)/Ke,Lt={features:[]};return this._addTileFeatures($e.range((ue-He)/Ke,St,(ue+1+He)/Ke,Ct),$e.data,ue,be,Ke,Lt),ue===0&&this._addTileFeatures($e.range(1-He/Ke,St,1,Ct),$e.data,Ke,be,Ke,Lt),ue===Ke-1&&this._addTileFeatures($e.range(0,St,He/Ke,Ct),$e.data,-1,be,Ke,Lt),Lt.features.length?Lt:null}getClusterExpansionZoom(ne){let ue=this._getOriginZoom(ne)-1;for(;ue<=this.options.maxZoom;){const be=this.getChildren(ne);if(ue++,be.length!==1)break;ne=be[0].properties.cluster_id}return ue}_appendLeaves(ne,ue,be,$e,Ke){const ot=this.getChildren(ue);for(const Dt of ot){const He=Dt.properties;if(He&&He.cluster?Ke+He.point_count<=$e?Ke+=He.point_count:Ke=this._appendLeaves(ne,He.cluster_id,be,$e,Ke):Ke<$e?Ke++:ne.push(Dt),ne.length===be)break}return Ke}_createTree(ne){const ue=new r.bj(ne.length/this.stride|0,this.options.nodeSize,Float32Array);for(let be=0;be<ne.length;be+=this.stride)ue.add(ne[be],ne[be+1]);return ue.finish(),ue.data=ne,ue}_addTileFeatures(ne,ue,be,$e,Ke,ot){for(const Dt of ne){const He=Dt*this.stride,St=ue[He+Vt]>1;let Ct,Lt,yt;if(St)Ct=Tt(ue,He,this.clusterProps),Lt=ue[He],yt=ue[He+1];else{const qi=this.points[ue[He+pr]];Ct=qi.properties;const[Li,Oi]=qi.geometry.coordinates;Lt=Fn(Li),yt=Zi(Oi)}const $i={type:1,geometry:[[Math.round(this.options.extent*(Lt*Ke-be)),Math.round(this.options.extent*(yt*Ke-$e))]],tags:Ct};let zi;zi=St||this.options.generateId?ue[He+pr]:this.points[ue[He+pr]].id,zi!==void 0&&($i.id=zi),ot.features.push($i)}}_limitZoom(ne){return Math.max(this.options.minZoom,Math.min(Math.floor(+ne),this.options.maxZoom+1))}_cluster(ne,ue){const{radius:be,extent:$e,reduce:Ke,minPoints:ot}=this.options,Dt=be/($e*Math.pow(2,ue)),He=ne.data,St=[],Ct=this.stride;for(let Lt=0;Lt<He.length;Lt+=Ct){if(He[Lt+2]<=ue)continue;He[Lt+2]=ue;const yt=He[Lt],$i=He[Lt+1],zi=ne.within(He[Lt],He[Lt+1],Dt),qi=He[Lt+Vt];let Li=qi;for(const Oi of zi){const Yi=Oi*Ct;He[Yi+2]>ue&&(Li+=He[Yi+Vt])}if(Li>qi&&Li>=ot){let Oi,Yi=yt*qi,yn=$i*qi,nr=-1;const ln=(Lt/Ct<<5)+(ue+1)+this.points.length;for(const Cr of zi){const wr=Cr*Ct;if(He[wr+2]<=ue)continue;He[wr+2]=ue;const ds=He[wr+Vt];Yi+=He[wr]*ds,yn+=He[wr+1]*ds,He[wr+4]=ln,Ke&&(Oi||(Oi=this._map(He,Lt,!0),nr=this.clusterProps.length,this.clusterProps.push(Oi)),Ke(Oi,this._map(He,wr)))}He[Lt+4]=ln,St.push(Yi/Li,yn/Li,1/0,ln,-1,Li),Ke&&St.push(nr)}else{for(let Oi=0;Oi<Ct;Oi++)St.push(He[Lt+Oi]);if(Li>1)for(const Oi of zi){const Yi=Oi*Ct;if(!(He[Yi+2]<=ue)){He[Yi+2]=ue;for(let yn=0;yn<Ct;yn++)St.push(He[Yi+yn])}}}}return St}_getOriginId(ne){return ne-this.points.length>>5}_getOriginZoom(ne){return(ne-this.points.length)%32}_map(ne,ue,be){if(ne[ue+Vt]>1){const ot=this.clusterProps[ne[ue+Wt]];return be?Object.assign({},ot):ot}const $e=this.points[ne[ue+pr]].properties,Ke=this.options.map($e);return be&&Ke===$e?Object.assign({},Ke):Ke}}function Ui(rt,ne,ue){return{type:"Feature",id:rt[ne+pr],properties:Tt(rt,ne,ue),geometry:{type:"Point",coordinates:[(be=rt[ne],360*(be-.5)),ir(rt[ne+1])]}};var be}function Tt(rt,ne,ue){const be=rt[ne+Vt],$e=be>=1e4?`${Math.round(be/1e3)}k`:be>=1e3?Math.round(be/100)/10+"k":be,Ke=rt[ne+Wt],ot=Ke===-1?{}:Object.assign({},ue[Ke]);return Object.assign(ot,{cluster:!0,cluster_id:rt[ne+pr],point_count:be,point_count_abbreviated:$e})}function Fn(rt){return rt/360+.5}function Zi(rt){const ne=Math.sin(rt*Math.PI/180),ue=.5-.25*Math.log((1+ne)/(1-ne))/Math.PI;return ue<0?0:ue>1?1:ue}function ir(rt){const ne=(180-360*rt)*Math.PI/180;return 360*Math.atan(Math.exp(ne))/Math.PI-90}var $n={exports:{}};$n.exports=function(){function rt(je,Ge,et,ct){for(var at,mt=ct,_t=et-Ge>>1,ut=et-Ge,xt=je[Ge],dt=je[Ge+1],Xt=je[et],wi=je[et+1],Rt=Ge+3;Rt<et;Rt+=3){var Qi=ne(je[Rt],je[Rt+1],xt,dt,Xt,wi);if(Qi>mt)at=Rt,mt=Qi;else if(Qi===mt){var bn=Math.abs(Rt-_t);bn<ut&&(at=Rt,ut=bn)}}mt>ct&&(at-Ge>3&&rt(je,Ge,at,ct),je[at+2]=mt,et-at>3&&rt(je,at,et,ct))}function ne(je,Ge,et,ct,at,mt){var _t=at-et,ut=mt-ct;if(_t!==0||ut!==0){var xt=((je-et)*_t+(Ge-ct)*ut)/(_t*_t+ut*ut);xt>1?(et=at,ct=mt):xt>0&&(et+=_t*xt,ct+=ut*xt)}return(_t=je-et)*_t+(ut=Ge-ct)*ut}function ue(je,Ge,et,ct){var at={id:je===void 0?null:je,type:Ge,geometry:et,tags:ct,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(mt){var _t=mt.geometry,ut=mt.type;if(ut==="Point"||ut==="MultiPoint"||ut==="LineString")be(mt,_t);else if(ut==="Polygon"||ut==="MultiLineString")for(var xt=0;xt<_t.length;xt++)be(mt,_t[xt]);else if(ut==="MultiPolygon")for(xt=0;xt<_t.length;xt++)for(var dt=0;dt<_t[xt].length;dt++)be(mt,_t[xt][dt])}(at),at}function be(je,Ge){for(var et=0;et<Ge.length;et+=3)je.minX=Math.min(je.minX,Ge[et]),je.minY=Math.min(je.minY,Ge[et+1]),je.maxX=Math.max(je.maxX,Ge[et]),je.maxY=Math.max(je.maxY,Ge[et+1])}function $e(je,Ge,et,ct){if(Ge.geometry){var at=Ge.geometry.coordinates,mt=Ge.geometry.type,_t=Math.pow(et.tolerance/((1<<et.maxZoom)*et.extent),2),ut=[],xt=Ge.id;if(et.promoteId?xt=Ge.properties[et.promoteId]:et.generateId&&(xt=ct||0),mt==="Point")Ke(at,ut);else if(mt==="MultiPoint")for(var dt=0;dt<at.length;dt++)Ke(at[dt],ut);else if(mt==="LineString")ot(at,ut,_t,!1);else if(mt==="MultiLineString"){if(et.lineMetrics){for(dt=0;dt<at.length;dt++)ot(at[dt],ut=[],_t,!1),je.push(ue(xt,"LineString",ut,Ge.properties));return}Dt(at,ut,_t,!1)}else if(mt==="Polygon")Dt(at,ut,_t,!0);else{if(mt!=="MultiPolygon"){if(mt==="GeometryCollection"){for(dt=0;dt<Ge.geometry.geometries.length;dt++)$e(je,{id:xt,geometry:Ge.geometry.geometries[dt],properties:Ge.properties},et,ct);return}throw new Error("Input data is not a valid GeoJSON object.")}for(dt=0;dt<at.length;dt++){var Xt=[];Dt(at[dt],Xt,_t,!0),ut.push(Xt)}}je.push(ue(xt,mt,ut,Ge.properties))}}function Ke(je,Ge){Ge.push(He(je[0])),Ge.push(St(je[1])),Ge.push(0)}function ot(je,Ge,et,ct){for(var at,mt,_t=0,ut=0;ut<je.length;ut++){var xt=He(je[ut][0]),dt=St(je[ut][1]);Ge.push(xt),Ge.push(dt),Ge.push(0),ut>0&&(_t+=ct?(at*dt-xt*mt)/2:Math.sqrt(Math.pow(xt-at,2)+Math.pow(dt-mt,2))),at=xt,mt=dt}var Xt=Ge.length-3;Ge[2]=1,rt(Ge,0,Xt,et),Ge[Xt+2]=1,Ge.size=Math.abs(_t),Ge.start=0,Ge.end=Ge.size}function Dt(je,Ge,et,ct){for(var at=0;at<je.length;at++){var mt=[];ot(je[at],mt,et,ct),Ge.push(mt)}}function He(je){return je/360+.5}function St(je){var Ge=Math.sin(je*Math.PI/180),et=.5-.25*Math.log((1+Ge)/(1-Ge))/Math.PI;return et<0?0:et>1?1:et}function Ct(je,Ge,et,ct,at,mt,_t,ut){if(ct/=Ge,mt>=(et/=Ge)&&_t<ct)return je;if(_t<et||mt>=ct)return null;for(var xt=[],dt=0;dt<je.length;dt++){var Xt=je[dt],wi=Xt.geometry,Rt=Xt.type,Qi=at===0?Xt.minX:Xt.minY,bn=at===0?Xt.maxX:Xt.maxY;if(Qi>=et&&bn<ct)xt.push(Xt);else if(!(bn<et||Qi>=ct)){var tn=[];if(Rt==="Point"||Rt==="MultiPoint")Lt(wi,tn,et,ct,at);else if(Rt==="LineString")yt(wi,tn,et,ct,at,!1,ut.lineMetrics);else if(Rt==="MultiLineString")zi(wi,tn,et,ct,at,!1);else if(Rt==="Polygon")zi(wi,tn,et,ct,at,!0);else if(Rt==="MultiPolygon")for(var Pn=0;Pn<wi.length;Pn++){var En=[];zi(wi[Pn],En,et,ct,at,!0),En.length&&tn.push(En)}if(tn.length){if(ut.lineMetrics&&Rt==="LineString"){for(Pn=0;Pn<tn.length;Pn++)xt.push(ue(Xt.id,Rt,tn[Pn],Xt.tags));continue}Rt!=="LineString"&&Rt!=="MultiLineString"||(tn.length===1?(Rt="LineString",tn=tn[0]):Rt="MultiLineString"),Rt!=="Point"&&Rt!=="MultiPoint"||(Rt=tn.length===3?"Point":"MultiPoint"),xt.push(ue(Xt.id,Rt,tn,Xt.tags))}}}return xt.length?xt:null}function Lt(je,Ge,et,ct,at){for(var mt=0;mt<je.length;mt+=3){var _t=je[mt+at];_t>=et&&_t<=ct&&(Ge.push(je[mt]),Ge.push(je[mt+1]),Ge.push(je[mt+2]))}}function yt(je,Ge,et,ct,at,mt,_t){for(var ut,xt,dt=$i(je),Xt=at===0?Li:Oi,wi=je.start,Rt=0;Rt<je.length-3;Rt+=3){var Qi=je[Rt],bn=je[Rt+1],tn=je[Rt+2],Pn=je[Rt+3],En=je[Rt+4],Ai=at===0?Qi:bn,Hr=at===0?Pn:En,fs=!1;_t&&(ut=Math.sqrt(Math.pow(Qi-Pn,2)+Math.pow(bn-En,2))),Ai<et?Hr>et&&(xt=Xt(dt,Qi,bn,Pn,En,et),_t&&(dt.start=wi+ut*xt)):Ai>ct?Hr<ct&&(xt=Xt(dt,Qi,bn,Pn,En,ct),_t&&(dt.start=wi+ut*xt)):qi(dt,Qi,bn,tn),Hr<et&&Ai>=et&&(xt=Xt(dt,Qi,bn,Pn,En,et),fs=!0),Hr>ct&&Ai<=ct&&(xt=Xt(dt,Qi,bn,Pn,En,ct),fs=!0),!mt&&fs&&(_t&&(dt.end=wi+ut*xt),Ge.push(dt),dt=$i(je)),_t&&(wi+=ut)}var lr=je.length-3;Qi=je[lr],bn=je[lr+1],tn=je[lr+2],(Ai=at===0?Qi:bn)>=et&&Ai<=ct&&qi(dt,Qi,bn,tn),lr=dt.length-3,mt&&lr>=3&&(dt[lr]!==dt[0]||dt[lr+1]!==dt[1])&&qi(dt,dt[0],dt[1],dt[2]),dt.length&&Ge.push(dt)}function $i(je){var Ge=[];return Ge.size=je.size,Ge.start=je.start,Ge.end=je.end,Ge}function zi(je,Ge,et,ct,at,mt){for(var _t=0;_t<je.length;_t++)yt(je[_t],Ge,et,ct,at,mt,!1)}function qi(je,Ge,et,ct){je.push(Ge),je.push(et),je.push(ct)}function Li(je,Ge,et,ct,at,mt){var _t=(mt-Ge)/(ct-Ge);return je.push(mt),je.push(et+(at-et)*_t),je.push(1),_t}function Oi(je,Ge,et,ct,at,mt){var _t=(mt-et)/(at-et);return je.push(Ge+(ct-Ge)*_t),je.push(mt),je.push(1),_t}function Yi(je,Ge){for(var et=[],ct=0;ct<je.length;ct++){var at,mt=je[ct],_t=mt.type;if(_t==="Point"||_t==="MultiPoint"||_t==="LineString")at=yn(mt.geometry,Ge);else if(_t==="MultiLineString"||_t==="Polygon"){at=[];for(var ut=0;ut<mt.geometry.length;ut++)at.push(yn(mt.geometry[ut],Ge))}else if(_t==="MultiPolygon")for(at=[],ut=0;ut<mt.geometry.length;ut++){for(var xt=[],dt=0;dt<mt.geometry[ut].length;dt++)xt.push(yn(mt.geometry[ut][dt],Ge));at.push(xt)}et.push(ue(mt.id,_t,at,mt.tags))}return et}function yn(je,Ge){var et=[];et.size=je.size,je.start!==void 0&&(et.start=je.start,et.end=je.end);for(var ct=0;ct<je.length;ct+=3)et.push(je[ct]+Ge,je[ct+1],je[ct+2]);return et}function nr(je,Ge){if(je.transformed)return je;var et,ct,at,mt=1<<je.z,_t=je.x,ut=je.y;for(et=0;et<je.features.length;et++){var xt=je.features[et],dt=xt.geometry,Xt=xt.type;if(xt.geometry=[],Xt===1)for(ct=0;ct<dt.length;ct+=2)xt.geometry.push(ln(dt[ct],dt[ct+1],Ge,mt,_t,ut));else for(ct=0;ct<dt.length;ct++){var wi=[];for(at=0;at<dt[ct].length;at+=2)wi.push(ln(dt[ct][at],dt[ct][at+1],Ge,mt,_t,ut));xt.geometry.push(wi)}}return je.transformed=!0,je}function ln(je,Ge,et,ct,at,mt){return[Math.round(et*(je*ct-at)),Math.round(et*(Ge*ct-mt))]}function Cr(je,Ge,et,ct,at){for(var mt=Ge===at.maxZoom?0:at.tolerance/((1<<Ge)*at.extent),_t={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:et,y:ct,z:Ge,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},ut=0;ut<je.length;ut++){_t.numFeatures++,wr(_t,je[ut],mt,at);var xt=je[ut].minX,dt=je[ut].minY,Xt=je[ut].maxX,wi=je[ut].maxY;xt<_t.minX&&(_t.minX=xt),dt<_t.minY&&(_t.minY=dt),Xt>_t.maxX&&(_t.maxX=Xt),wi>_t.maxY&&(_t.maxY=wi)}return _t}function wr(je,Ge,et,ct){var at=Ge.geometry,mt=Ge.type,_t=[];if(mt==="Point"||mt==="MultiPoint")for(var ut=0;ut<at.length;ut+=3)_t.push(at[ut]),_t.push(at[ut+1]),je.numPoints++,je.numSimplified++;else if(mt==="LineString")ds(_t,at,je,et,!1,!1);else if(mt==="MultiLineString"||mt==="Polygon")for(ut=0;ut<at.length;ut++)ds(_t,at[ut],je,et,mt==="Polygon",ut===0);else if(mt==="MultiPolygon")for(var xt=0;xt<at.length;xt++){var dt=at[xt];for(ut=0;ut<dt.length;ut++)ds(_t,dt[ut],je,et,!0,ut===0)}if(_t.length){var Xt=Ge.tags||null;if(mt==="LineString"&&ct.lineMetrics){for(var wi in Xt={},Ge.tags)Xt[wi]=Ge.tags[wi];Xt.mapbox_clip_start=at.start/at.size,Xt.mapbox_clip_end=at.end/at.size}var Rt={geometry:_t,type:mt==="Polygon"||mt==="MultiPolygon"?3:mt==="LineString"||mt==="MultiLineString"?2:1,tags:Xt};Ge.id!==null&&(Rt.id=Ge.id),je.features.push(Rt)}}function ds(je,Ge,et,ct,at,mt){var _t=ct*ct;if(ct>0&&Ge.size<(at?_t:ct))et.numPoints+=Ge.length/3;else{for(var ut=[],xt=0;xt<Ge.length;xt+=3)(ct===0||Ge[xt+2]>_t)&&(et.numSimplified++,ut.push(Ge[xt]),ut.push(Ge[xt+1])),et.numPoints++;at&&function(dt,Xt){for(var wi=0,Rt=0,Qi=dt.length,bn=Qi-2;Rt<Qi;bn=Rt,Rt+=2)wi+=(dt[Rt]-dt[bn])*(dt[Rt+1]+dt[bn+1]);if(wi>0===Xt)for(Rt=0,Qi=dt.length;Rt<Qi/2;Rt+=2){var tn=dt[Rt],Pn=dt[Rt+1];dt[Rt]=dt[Qi-2-Rt],dt[Rt+1]=dt[Qi-1-Rt],dt[Qi-2-Rt]=tn,dt[Qi-1-Rt]=Pn}}(ut,mt),je.push(ut)}}function Un(je,Ge){var et=(Ge=this.options=function(at,mt){for(var _t in mt)at[_t]=mt[_t];return at}(Object.create(this.options),Ge)).debug;if(et&&console.time("preprocess data"),Ge.maxZoom<0||Ge.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(Ge.promoteId&&Ge.generateId)throw new Error("promoteId and generateId cannot be used together.");var ct=function(at,mt){var _t=[];if(at.type==="FeatureCollection")for(var ut=0;ut<at.features.length;ut++)$e(_t,at.features[ut],mt,ut);else $e(_t,at.type==="Feature"?at:{geometry:at},mt);return _t}(je,Ge);this.tiles={},this.tileCoords=[],et&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",Ge.indexMaxZoom,Ge.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),(ct=function(at,mt){var _t=mt.buffer/mt.extent,ut=at,xt=Ct(at,1,-1-_t,_t,0,-1,2,mt),dt=Ct(at,1,1-_t,2+_t,0,-1,2,mt);return(xt||dt)&&(ut=Ct(at,1,-_t,1+_t,0,-1,2,mt)||[],xt&&(ut=Yi(xt,1).concat(ut)),dt&&(ut=ut.concat(Yi(dt,-1)))),ut}(ct,Ge)).length&&this.splitTile(ct,0,0,0),et&&(ct.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function vn(je,Ge,et){return 32*((1<<je)*et+Ge)+je}return Un.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},Un.prototype.splitTile=function(je,Ge,et,ct,at,mt,_t){for(var ut=[je,Ge,et,ct],xt=this.options,dt=xt.debug;ut.length;){ct=ut.pop(),et=ut.pop(),Ge=ut.pop(),je=ut.pop();var Xt=1<<Ge,wi=vn(Ge,et,ct),Rt=this.tiles[wi];if(!Rt&&(dt>1&&console.time("creation"),Rt=this.tiles[wi]=Cr(je,Ge,et,ct,xt),this.tileCoords.push({z:Ge,x:et,y:ct}),dt)){dt>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",Ge,et,ct,Rt.numFeatures,Rt.numPoints,Rt.numSimplified),console.timeEnd("creation"));var Qi="z"+Ge;this.stats[Qi]=(this.stats[Qi]||0)+1,this.total++}if(Rt.source=je,at){if(Ge===xt.maxZoom||Ge===at)continue;var bn=1<<at-Ge;if(et!==Math.floor(mt/bn)||ct!==Math.floor(_t/bn))continue}else if(Ge===xt.indexMaxZoom||Rt.numPoints<=xt.indexMaxPoints)continue;if(Rt.source=null,je.length!==0){dt>1&&console.time("clipping");var tn,Pn,En,Ai,Hr,fs,lr=.5*xt.buffer/xt.extent,ko=.5-lr,fl=.5+lr,Pr=1+lr;tn=Pn=En=Ai=null,Hr=Ct(je,Xt,et-lr,et+fl,0,Rt.minX,Rt.maxX,xt),fs=Ct(je,Xt,et+ko,et+Pr,0,Rt.minX,Rt.maxX,xt),je=null,Hr&&(tn=Ct(Hr,Xt,ct-lr,ct+fl,1,Rt.minY,Rt.maxY,xt),Pn=Ct(Hr,Xt,ct+ko,ct+Pr,1,Rt.minY,Rt.maxY,xt),Hr=null),fs&&(En=Ct(fs,Xt,ct-lr,ct+fl,1,Rt.minY,Rt.maxY,xt),Ai=Ct(fs,Xt,ct+ko,ct+Pr,1,Rt.minY,Rt.maxY,xt),fs=null),dt>1&&console.timeEnd("clipping"),ut.push(tn||[],Ge+1,2*et,2*ct),ut.push(Pn||[],Ge+1,2*et,2*ct+1),ut.push(En||[],Ge+1,2*et+1,2*ct),ut.push(Ai||[],Ge+1,2*et+1,2*ct+1)}}},Un.prototype.getTile=function(je,Ge,et){var ct=this.options,at=ct.extent,mt=ct.debug;if(je<0||je>24)return null;var _t=1<<je,ut=vn(je,Ge=(Ge%_t+_t)%_t,et);if(this.tiles[ut])return nr(this.tiles[ut],at);mt>1&&console.log("drilling down to z%d-%d-%d",je,Ge,et);for(var xt,dt=je,Xt=Ge,wi=et;!xt&&dt>0;)dt--,Xt=Math.floor(Xt/2),wi=Math.floor(wi/2),xt=this.tiles[vn(dt,Xt,wi)];return xt&&xt.source?(mt>1&&console.log("found parent tile z%d-%d-%d",dt,Xt,wi),mt>1&&console.time("drilling down"),this.splitTile(xt.source,dt,Xt,wi,je,Ge,et),mt>1&&console.timeEnd("drilling down"),this.tiles[ut]?nr(this.tiles[ut],at):null):null},function(je,Ge){return new Un(je,Ge)}}();var un=r.dX($n.exports);function Do(rt,ne){const ue=rt.tileID.canonical;if(!this._geoJSONIndex)return ne(null,null);const be=this._geoJSONIndex.getTile(ue.z,ue.x,ue.y);if(!be)return ne(null,null);const $e=new qe(be.features);let Ke=gn($e);Ke.byteOffset===0&&Ke.byteLength===Ke.buffer.byteLength||(Ke=new Uint8Array(Ke)),ne(null,{vectorTile:$e,rawData:Ke.buffer})}class Qt extends ve{constructor(ne,ue,be,$e,Ke,ot){super(ne,ue,be,$e,Do,ot),Ke&&(this.loadGeoJSON=Ke),this._featureMap=new Map}loadData(ne,ue){const be=ne&&ne.request,$e=be&&be.collectResourceTiming;this.loadGeoJSON(ne,(Ke,ot)=>{if(Ke||!ot)return ue(Ke);if(typeof ot!="object")return ue(new Error(`Input data given to '${ne.source}' is not a valid GeoJSON object.`));{try{if(ne.filter){const He=r.t(ne.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(He.result==="error")throw new Error(He.value.map(St=>`${St.key}: ${St.message}`).join(", "));ot.features=ot.features.filter(St=>He.value.evaluate({zoom:0},St))}if(ne.dynamic){ot.type==="Feature"&&(ot={type:"FeatureCollection",features:[ot]}),ne.append||this._featureMap.clear();for(const He of ot.features||[]){const St=He.id;St!==void 0&&(He.geometry?this._featureMap.set(St,He):this._featureMap.delete(St))}ot.features=[...this._featureMap.values()]}this._geoJSONIndex=ne.cluster?new Ht(function({superclusterOptions:He,clusterProperties:St}){if(!St||!He)return He;const Ct={},Lt={},yt={accumulated:null,zoom:0},$i={properties:null},zi=Object.keys(St);for(const qi of zi){const[Li,Oi]=St[qi],Yi=r.t(Oi),yn=r.t(typeof Li=="string"?[Li,["accumulated"],["get",qi]]:Li);Ct[qi]=Yi.value,Lt[qi]=yn.value}return He.map=qi=>{$i.properties=qi;const Li={};for(const Oi of zi)Li[Oi]=Ct[Oi].evaluate(yt,$i);return Li},He.reduce=(qi,Li)=>{$i.properties=Li;for(const Oi of zi)yt.accumulated=qi[Oi],qi[Oi]=Lt[Oi].evaluate(yt,$i)},He}(ne)).load(ot.features):un(ot,ne.geojsonVtOptions)}catch(He){return ue(He)}this.loaded={};const Dt={};if($e){const He=k(be);He&&(Dt.resourceTiming={},Dt.resourceTiming[ne.source]=JSON.parse(JSON.stringify(He)))}ue(null,Dt)}})}reloadTile(ne,ue){const be=this.loaded;return be&&be[ne.uid]?super.reloadTile(ne,ue):this.loadTile(ne,ue)}loadGeoJSON(ne,ue){if(ne.request)r.g(ne.request,ue);else{if(typeof ne.data!="string")return ue(new Error(`Input data given to '${ne.source}' is not a valid GeoJSON object.`));try{return ue(null,JSON.parse(ne.data))}catch{return ue(new Error(`Input data given to '${ne.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(ne,ue){try{ue(null,this._geoJSONIndex.getClusterExpansionZoom(ne.clusterId))}catch(be){ue(be)}}getClusterChildren(ne,ue){try{ue(null,this._geoJSONIndex.getChildren(ne.clusterId))}catch(be){ue(be)}}getClusterLeaves(ne,ue){try{ue(null,this._geoJSONIndex.getLeaves(ne.clusterId,ne.limit,ne.offset))}catch(be){ue(be)}}}class Zt{constructor(ne,ue){this.tileID=new r.ap(ne.tileID.overscaledZ,ne.tileID.wrap,ne.tileID.canonical.z,ne.tileID.canonical.x,ne.tileID.canonical.y),this.tileZoom=ne.tileZoom,this.uid=ne.uid,this.zoom=ne.zoom,this.canonical=ne.tileID.canonical,this.pixelRatio=ne.pixelRatio,this.tileSize=ne.tileSize,this.source=ne.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=ne.projection,this.brightness=ue}parse(ne,ue,be,$e){this.status="parsing";const Ke=new r.ap(be.tileID.overscaledZ,be.tileID.wrap,be.tileID.canonical.z,be.tileID.canonical.x,be.tileID.canonical.y),ot={},Dt=ue.familiesBySource[be.source],He=new r.dL(Ke,be.promoteId);return He.bucketLayerIDs=[],He.is3DTile=!0,r.dY(ne).then(St=>{if(!St)return $e(new Error("Could not parse tile"));const Ct=r.dZ(St,1/r.bU(be.tileID.canonical)),Lt=St.json.extensionsUsed&&St.json.extensionsUsed.includes("MAPBOX_mesh_features")||St.json.asset.extras&&St.json.asset.extras.MAPBOX_mesh_features,yt=St.json.extensionsUsed&&St.json.extensionsUsed.includes("EXT_meshopt_compression"),$i=new r.N(this.zoom,{brightness:this.brightness});for(const zi in Dt)for(const qi of Dt[zi]){const Li=qi[0];He.bucketLayerIDs.push(qi.map(Yi=>Yi.id)),Li.recalculate($i,[]);const Oi=new r.d_(Ct,Ke,Lt,yt,this.brightness,He);Lt||(Oi.needsUpload=!0),ot[Li.fqid]=Oi,Oi.evaluate(Li)}this.status="done",$e(null,{buckets:ot,featureIndex:He})}).catch(St=>$e(new Error(St.message)))}}class dl{constructor(ne,ue,be,$e,Ke,ot){this.actor=ne,this.layerIndex=ue,this.brightness=ot,this.loading={},this.loaded={}}loadTile(ne,ue){const be=ne.uid,$e=this.loading[be]=new Zt(ne,this.brightness);r.b1(ne.request,(Ke,ot)=>{const Dt=!this.loading[be];return delete this.loading[be],Dt||Ke?($e.status="done",Dt||(this.loaded[be]=$e),ue(Ke)):ot&&ot.byteLength!==0?void $e.parse(ot,this.layerIndex,ne,(He,St)=>{$e.status="done",this.loaded=this.loaded||{},this.loaded[be]=$e,He||!St?ue(He):ue(null,St)}):($e.status="done",this.loaded[be]=$e,ue())})}reloadTile(ne,ue){const be=this.loaded,$e=ne.uid;if(be&&be[$e]){const Ke=be[$e];Ke.projection=ne.projection,Ke.brightness=ne.brightness;const ot=(Dt,He)=>{Ke.reloadCallback&&(delete Ke.reloadCallback,this.loadTile(ne,ue)),ue(Dt,He)};Ke.status==="parsing"?Ke.reloadCallback=ot:Ke.status==="done"&&this.loadTile(ne,ue)}}abortTile(ne,ue){const be=ne.uid;this.loading[be]&&delete this.loading[be],ue()}removeTile(ne,ue){const be=this.loaded,$e=ne.uid;be&&be[$e]&&delete be[$e],ue()}}class Kr{constructor(ne){this.self=ne,this.actor=new r.d$(ne,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=r.br({name:"mercator"}),this.workerSourceTypes={vector:ve,geojson:Qt,"batched-model":dl},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(ue,be)=>{if(this.workerSourceTypes[ue])throw new Error(`Worker source with name "${ue}" already registered.`);this.workerSourceTypes[ue]=be},this.self.registerRTLTextPlugin=ue=>{if(r.e0.isParsed())throw new Error("RTL text plugin already registered.");r.e0.applyArabicShaping=ue.applyArabicShaping,r.e0.processBidirectionalText=ue.processBidirectionalText,r.e0.processStyledBidirectionalText=ue.processStyledBidirectionalText}}clearCaches(ne,ue,be){delete this.layerIndexes[ne],delete this.availableImages[ne],delete this.workerSources[ne],delete this.demWorkerSources[ne],delete this.rasterArrayWorkerSource,be()}checkIfReady(ne,ue,be){be()}setReferrer(ne,ue){this.referrer=ue}spriteLoaded(ne,{scope:ue,isLoaded:be}){if(this.isSpriteLoaded[ne]||(this.isSpriteLoaded[ne]={}),this.isSpriteLoaded[ne][ue]=be,this.workerSources[ne]&&this.workerSources[ne][ue])for(const $e in this.workerSources[ne][ue]){const Ke=this.workerSources[ne][ue][$e];for(const ot in Ke)Ke[ot]instanceof ve&&(Ke[ot].isSpriteLoaded=be,Ke[ot].fire(new r.b("isSpriteLoaded")))}}setImages(ne,{scope:ue,images:be},$e){if(this.availableImages[ne]||(this.availableImages[ne]={}),this.availableImages[ne][ue]=be,this.workerSources[ne]&&this.workerSources[ne][ue]){for(const Ke in this.workerSources[ne][ue]){const ot=this.workerSources[ne][ue][Ke];for(const Dt in ot)ot[Dt].availableImages=be}$e()}else $e()}setProjection(ne,ue){this.projections[ne]=r.br(ue)}setBrightness(ne,ue,be){this.brightness=ue,be()}setLayers(ne,ue,be){this.getLayerIndex(ne,ue.scope).replace(ue.layers,ue.options),be()}updateLayers(ne,ue,be){this.getLayerIndex(ne,ue.scope).update(ue.layers,ue.removedIds,ue.options),be()}loadTile(ne,ue,be){ue.projection=this.projections[ne]||this.defaultProjection,this.getWorkerSource(ne,ue.type,ue.source,ue.scope).loadTile(ue,be)}loadDEMTile(ne,ue,be){this.getDEMWorkerSource(ne,ue.source,ue.scope).loadTile(ue,be)}decodeRasterArray(ne,ue,be){this.getRasterArrayWorkerSource().decodeRasterArray(ue,be)}reloadTile(ne,ue,be){ue.projection=this.projections[ne]||this.defaultProjection,this.getWorkerSource(ne,ue.type,ue.source,ue.scope).reloadTile(ue,be)}abortTile(ne,ue,be){this.getWorkerSource(ne,ue.type,ue.source,ue.scope).abortTile(ue,be)}removeTile(ne,ue,be){this.getWorkerSource(ne,ue.type,ue.source,ue.scope).removeTile(ue,be)}removeSource(ne,ue,be){if(!(this.workerSources[ne]&&this.workerSources[ne][ue.scope]&&this.workerSources[ne][ue.scope][ue.type]&&this.workerSources[ne][ue.scope][ue.type][ue.source]))return;const $e=this.workerSources[ne][ue.scope][ue.type][ue.source];delete this.workerSources[ne][ue.scope][ue.type][ue.source],$e.removeSource!==void 0?$e.removeSource(ue,be):be()}loadWorkerSource(ne,ue,be){try{this.self.importScripts(ue.url),be()}catch($e){be($e.toString())}}syncRTLPluginState(ne,ue,be){try{r.e0.setState(ue);const $e=r.e0.getPluginURL();if(r.e0.isLoaded()&&!r.e0.isParsed()&&$e!=null){this.self.importScripts($e);const Ke=r.e0.isParsed();be(Ke?void 0:new Error(`RTL Text Plugin failed to import scripts from ${$e}`),Ke)}}catch($e){be($e.toString())}}setDracoUrl(ne,ue){this.dracoUrl=ue}getAvailableImages(ne,ue){this.availableImages[ne]||(this.availableImages[ne]={});let be=this.availableImages[ne][ue];return be||(be=[]),be}getLayerIndex(ne,ue){this.layerIndexes[ne]||(this.layerIndexes[ne]={});let be=this.layerIndexes[ne][ue];return be||(be=this.layerIndexes[ne][ue]=new W,be.scope=ue),be}getWorkerSource(ne,ue,be,$e){if(this.workerSources[ne]||(this.workerSources[ne]={}),this.workerSources[ne][$e]||(this.workerSources[ne][$e]={}),this.workerSources[ne][$e][ue]||(this.workerSources[ne][$e][ue]={}),this.isSpriteLoaded[ne]||(this.isSpriteLoaded[ne]={}),!this.workerSources[ne][$e][ue][be]){const Ke={send:(ot,Dt,He,St,Ct,Lt)=>{this.actor.send(ot,Dt,He,ne,Ct,Lt)},scheduler:this.actor.scheduler};this.workerSources[ne][$e][ue][be]=new this.workerSourceTypes[ue](Ke,this.getLayerIndex(ne,$e),this.getAvailableImages(ne,$e),this.isSpriteLoaded[ne][$e],void 0,this.brightness)}return this.workerSources[ne][$e][ue][be]}getDEMWorkerSource(ne,ue,be){return this.demWorkerSources[ne]||(this.demWorkerSources[ne]={}),this.demWorkerSources[ne][be]||(this.demWorkerSources[ne][be]={}),this.demWorkerSources[ne][be][ue]||(this.demWorkerSources[ne][be][ue]=new Te),this.demWorkerSources[ne][be][ue]}getRasterArrayWorkerSource(){return this.rasterArrayWorkerSource||(this.rasterArrayWorkerSource=new Ee),this.rasterArrayWorkerSource}enforceCacheSizeLimit(ne,ue){r.e1(ue)}getWorkerPerformanceMetrics(ne,ue,be){be(void 0,void 0)}}return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope&&(self.worker=new Kr(self)),Kr}),M(["./shared"],function(r){function k(d,n){if(Array.isArray(d)){if(!Array.isArray(n)||d.length!==n.length)return!1;for(let a=0;a<d.length;a++)if(!k(d[a],n[a]))return!1;return!0}if(typeof d=="object"&&d!==null&&n!==null){if(typeof n!="object"||Object.keys(d).length!==Object.keys(n).length)return!1;for(const a in d)if(!k(d[a],n[a]))return!1;return!0}return d===n}var F=N;function N(d){return!function(n){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var f,_,x=new Blob([""],{type:"text/javascript"}),w=URL.createObjectURL(x);try{_=new Worker(w),f=!0}catch{f=!1}return _&&_.terminate(),URL.revokeObjectURL(w),f}()?function(){var f=document.createElement("canvas");f.width=f.height=1;var _=f.getContext("2d");if(!_)return!1;var x=_.getImageData(0,0,1,1);return x&&x.width===f.width}()?(W[a=n&&n.failIfMajorPerformanceCaveat]===void 0&&(W[a]=function(f){var _,x=function(w){var S=document.createElement("canvas"),C=Object.create(N.webGLContextAttributes);return C.failIfMajorPerformanceCaveat=w,S.getContext("webgl2",C)}(f);if(!x)return!1;try{_=x.createShader(x.VERTEX_SHADER)}catch{return!1}return!(!_||x.isContextLost())&&(x.shaderSource(_,"void main() {}"),x.compileShader(_),x.getShaderParameter(_,x.COMPILE_STATUS)===!0)}(a)),W[a]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var a}(d)}var W={};function Q(d,n,a){const f=document.createElement(d);return n!=null&&(f.className=n),a&&a.appendChild(f),f}function te(d,n,a){const f=document.createElementNS("http://www.w3.org/2000/svg",d);for(const _ of Object.keys(n))f.setAttributeNS(null,_,String(n[_]));return a&&a.appendChild(f),f}N.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const ce=typeof document<"u"?document.documentElement&&document.documentElement.style:null,de=ce&&ce.userSelect!==void 0?"userSelect":"WebkitUserSelect";let ve;function Te(){ce&&de&&(ve=ce[de],ce[de]="none")}function Ee(){ce&&de&&(ce[de]=ve)}function Me(d){d.preventDefault(),d.stopPropagation(),window.removeEventListener("click",Me,!0)}function Ie(){window.addEventListener("click",Me,!0),window.setTimeout(()=>{window.removeEventListener("click",Me,!0)},0)}function qe(d,n){const a=d.getBoundingClientRect();return lt(d,a,n)}function Ve(d,n){const a=d.getBoundingClientRect(),f=[];for(let _=0;_<n.length;_++)f.push(lt(d,a,n[_]));return f}function nt(d){return window.InstallTrigger!==void 0&&d.button===2&&d.ctrlKey&&window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:d.button}function lt(d,n,a){const f=d.offsetWidth===n.width?1:d.offsetWidth/n.width;return new r.P((a.clientX-n.left)*f,(a.clientY-n.top)*f)}class ht{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages=new Set}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(n,a){this._updatedSourceCaches[n]=a,this.setDirty()}discardSourceCacheUpdate(n){delete this._updatedSourceCaches[n]}updateLayer(n){const a=n.scope;this._updatedLayers[a]=this._updatedLayers[a]||new Set,this._updatedLayers[a].add(n.id),this.setDirty()}removeLayer(n){const a=n.scope;this._removedLayers[a]=this._removedLayers[a]||{},this._updatedLayers[a]=this._updatedLayers[a]||new Set,this._removedLayers[a][n.id]=n,this._updatedLayers[a].delete(n.id),this._updatedPaintProps.delete(n.fqid),this.setDirty()}getRemovedLayer(n){return this._removedLayers[n.scope]?this._removedLayers[n.scope][n.id]:null}discardLayerRemoval(n){this._removedLayers[n.scope]&&delete this._removedLayers[n.scope][n.id]}getLayerUpdatesByScope(){const n={};for(const a in this._updatedLayers)n[a]=n[a]||{},n[a].updatedIds=Array.from(this._updatedLayers[a].values());for(const a in this._removedLayers)n[a]=n[a]||{},n[a].removedIds=Object.keys(this._removedLayers[a]);return n}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(n){this._updatedPaintProps.add(n.fqid),this.setDirty()}getUpdatedImages(){return Array.from(this._updatedImages.values())}updateImage(n){this._updatedImages.add(n),this.setDirty()}resetUpdatedImages(){this._updatedImages.clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages.clear()}}class st extends r.E{constructor(n){super(),this.requestManager=n,this.models={"":{}},this.numModelsLoading={}}loadModel(n,a){return r.l(this.requestManager.transformRequest(a,r.R.Model).url).then(f=>{if(!f)return;const _=r.c(f),x=new r.M(n,void 0,void 0,_);return x.computeBoundsAndApplyParent(),x}).catch(f=>{if(f&&f.status===404)return null;this.fire(new r.a(new Error(`Could not load model ${n} from ${a}: ${f.message}`)))})}load(n,a){this.models[a]||(this.models[a]={});const f=Object.keys(n);this.numModelsLoading[a]=(this.numModelsLoading[a]||0)+f.length;const _=[];for(const x of f)_.push(this.loadModel(x,n[x]));Promise.allSettled(_).then(x=>{for(let w=0;w<x.length;w++){const{status:S,value:C}=x[w];S==="fulfilled"&&C&&(this.models[a][f[w]]={model:C,numReferences:1})}this.numModelsLoading[a]-=f.length,this.fire(new r.b("data",{dataType:"style"}))}).catch(x=>{this.fire(new r.a(new Error(`Could not load models: ${x.message}`)))})}isLoaded(){for(const n in this.numModelsLoading)if(this.numModelsLoading[n]>0)return!1;return!0}hasModel(n,a){return!!this.getModel(n,a)}getModel(n,a){return this.models[a]||(this.models[a]={}),this.models[a][n]?this.models[a][n].model:void 0}addModel(n,a,f){this.models[f]||(this.models[f]={}),this.hasModel(n,f)&&this.models[f][n].numReferences++,this.load({[n]:this.requestManager.normalizeModelURL(a)},f)}addModels(n,a){this.models[a]||(this.models[a]={});const f={};for(const _ in n)this.models[a][_]={},f[_]=this.requestManager.normalizeModelURL(n[_]);this.load(f,a)}addModelsFromBucket(n,a){this.models[a]||(this.models[a]={});const f={};for(const _ of n)this.hasModel(_,a)?this.models[a][_].numReferences++:f[_]=this.requestManager.normalizeModelURL(_);this.load(f,a)}removeModel(n,a){if(this.models[a]&&this.models[a][n]&&(this.models[a][n].numReferences--,this.models[a][n].numReferences===0)){const f=this.models[a][n].model;delete this.models[a][n],f.destroy()}}listModels(n){return this.models[n]||(this.models[n]={}),Object.keys(this.models[n])}upload(n,a){this.models[a]||(this.models[a]={});for(const f in this.models[a])this.models[a][f].model&&this.models[a][f].model.upload(n.context)}}class Ot{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(n,a,f){const _=String(a);if(this.stateChanges[n]=this.stateChanges[n]||{},this.stateChanges[n][_]=this.stateChanges[n][_]||{},r.e(this.stateChanges[n][_],f),this.deletedStates[n]===null){this.deletedStates[n]={};for(const x in this.state[n])x!==_&&(this.deletedStates[n][x]=null)}else if(this.deletedStates[n]&&this.deletedStates[n][_]===null){this.deletedStates[n][_]={};for(const x in this.state[n][_])f[x]||(this.deletedStates[n][_][x]=null)}else for(const x in f)this.deletedStates[n]&&this.deletedStates[n][_]&&this.deletedStates[n][_][x]===null&&delete this.deletedStates[n][_][x]}removeFeatureState(n,a,f){if(this.deletedStates[n]===null)return;const _=String(a);if(this.deletedStates[n]=this.deletedStates[n]||{},f&&a!==void 0)this.deletedStates[n][_]!==null&&(this.deletedStates[n][_]=this.deletedStates[n][_]||{},this.deletedStates[n][_][f]=null);else if(a!==void 0)if(this.stateChanges[n]&&this.stateChanges[n][_])for(f in this.deletedStates[n][_]={},this.stateChanges[n][_])this.deletedStates[n][_][f]=null;else this.deletedStates[n][_]=null;else this.deletedStates[n]=null}getState(n,a){const f=String(a),_=r.e({},(this.state[n]||{})[f],(this.stateChanges[n]||{})[f]);if(this.deletedStates[n]===null)return{};if(this.deletedStates[n]){const x=this.deletedStates[n][a];if(x===null)return{};for(const w in x)delete _[w]}return _}initializeTileState(n,a){n.setFeatureState(this.state,a)}coalesceChanges(n,a){const f={};for(const _ in this.stateChanges){this.state[_]=this.state[_]||{};const x={};for(const w in this.stateChanges[_])this.state[_][w]||(this.state[_][w]={}),r.e(this.state[_][w],this.stateChanges[_][w]),x[w]=this.state[_][w];f[_]=x}for(const _ in this.deletedStates){this.state[_]=this.state[_]||{};const x={};if(this.deletedStates[_]===null)for(const w in this.state[_])x[w]={},this.state[_][w]={};else for(const w in this.deletedStates[_]){if(this.deletedStates[_][w]===null)this.state[_][w]={};else if(this.state[_][w])for(const S of Object.keys(this.deletedStates[_][w]))delete this.state[_][w][S];x[w]=this.state[_][w]}f[_]=f[_]||{},r.e(f[_],x)}if(this.stateChanges={},this.deletedStates={},Object.keys(f).length!==0)for(const _ in n)n[_].setFeatureState(f,a)}}function oi(d){const{userImage:n}=d;return!!(n&&n.render&&n.render())&&(d.data.replace(new Uint8Array(n.data.buffer)),!0)}class ii extends r.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.atlasImage={},this.atlasTexture={},this.dirty=!0}createScope(n){this.images[n]={},this.loaded[n]=!1,this.updatedImages[n]={},this.patterns[n]={},this.callbackDispatchedThisFrame[n]={},this.atlasImage[n]=new r.h({width:1,height:1})}isLoaded(){for(const n in this.loaded)if(!this.loaded[n])return!1;return!0}setLoaded(n,a){if(this.loaded[a]!==n&&(this.loaded[a]=n,n)){for(const{ids:f,callback:_}of this.requestors)this._notify(f,a,_);this.requestors=[]}}hasImage(n,a){return!!this.getImage(n,a)}getImage(n,a){return this.images[a][n]}addImage(n,a,f){this._validate(n,f)&&(this.images[a][n]=f)}_validate(n,a){let f=!0;return this._validateStretch(a.stretchX,a.data&&a.data.width)||(this.fire(new r.a(new Error(`Image "${n}" has invalid "stretchX" value`))),f=!1),this._validateStretch(a.stretchY,a.data&&a.data.height)||(this.fire(new r.a(new Error(`Image "${n}" has invalid "stretchY" value`))),f=!1),this._validateContent(a.content,a)||(this.fire(new r.a(new Error(`Image "${n}" has invalid "content" value`))),f=!1),f}_validateStretch(n,a){if(!n)return!0;let f=0;for(const _ of n){if(_[0]<f||_[1]<_[0]||a<_[1])return!1;f=_[1]}return!0}_validateContent(n,a){return!(n&&(n.length!==4||n[0]<0||a.data.width<n[0]||n[1]<0||a.data.height<n[1]||n[2]<0||a.data.width<n[2]||n[3]<0||a.data.height<n[3]||n[2]<n[0]||n[3]<n[1]))}updateImage(n,a,f){f.version=this.images[a][n].version+1,this.images[a][n]=f,this.updatedImages[a][n]=!0}removeImage(n,a){const f=this.images[a][n];delete this.images[a][n],delete this.patterns[a][n],f.userImage&&f.userImage.onRemove&&f.userImage.onRemove()}listImages(n){return Object.keys(this.images[n])}getImages(n,a,f){let _=!0;const x=!!this.loaded[a];if(!x)for(const w of n)this.images[a][w]||(_=!1);x||_?this._notify(n,a,f):this.requestors.push({ids:n,scope:a,callback:f})}getUpdatedImages(n){return this.updatedImages[n]}_notify(n,a,f){const _={};for(const x of n){this.images[a][x]||this.fire(new r.b("styleimagemissing",{id:x}));const w=this.images[a][x];w?_[x]={data:w.data.clone(),pixelRatio:w.pixelRatio,sdf:w.sdf,version:w.version,stretchX:w.stretchX,stretchY:w.stretchY,content:w.content,hasRenderCallback:!!(w.userImage&&w.userImage.render)}:r.w(`Image "${x}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}f(null,_)}getPixelSize(n){const{width:a,height:f}=this.atlasImage[n];return{width:a,height:f}}getPattern(n,a){const f=this.patterns[a][n],_=this.getImage(n,a);if(!_)return null;if(f&&f.position.version===_.version)return f.position;if(f)f.position.version=_.version;else{const x={w:_.data.width+2,h:_.data.height+2,x:0,y:0},w=new r.I(x,_);this.patterns[a][n]={bin:x,position:w}}return this._updatePatternAtlas(a),this.patterns[a][n].position}bind(n,a){const f=n.gl;let _=this.atlasTexture[a];_?this.dirty&&(_.update(this.atlasImage[a]),this.dirty=!1):(_=new r.T(n,this.atlasImage[a],f.RGBA),this.atlasTexture[a]=_),_.bind(f.LINEAR,f.CLAMP_TO_EDGE)}_updatePatternAtlas(n){const a=[];for(const w in this.patterns[n])a.push(this.patterns[n][w].bin);const{w:f,h:_}=r.p(a),x=this.atlasImage[n];x.resize({width:f||1,height:_||1});for(const w in this.patterns[n]){const{bin:S}=this.patterns[n][w],C=S.x+1,D=S.y+1,z=this.images[n][w].data,O=z.width,V=z.height;r.h.copy(z,x,{x:0,y:0},{x:C,y:D},{width:O,height:V}),r.h.copy(z,x,{x:0,y:V-1},{x:C,y:D-1},{width:O,height:1}),r.h.copy(z,x,{x:0,y:0},{x:C,y:D+V},{width:O,height:1}),r.h.copy(z,x,{x:O-1,y:0},{x:C-1,y:D},{width:1,height:V}),r.h.copy(z,x,{x:0,y:0},{x:C+O,y:D},{width:1,height:V})}this.dirty=!0}beginFrame(){for(const n in this.images)this.callbackDispatchedThisFrame[n]={}}dispatchRenderCallbacks(n,a){for(const f of n){if(this.callbackDispatchedThisFrame[a][f])continue;this.callbackDispatchedThisFrame[a][f]=!0;const _=this.images[a][f];oi(_)&&this.updateImage(f,a,_)}}}function Xe(d){const n=d.key,a=d.value,f=d.valueSpec||{},_=d.objectElementValidators||{},x=d.style,w=d.styleSpec;let S=[];const C=r.j(a);if(C!=="object")return[new r.V(n,a,`object expected, ${C} found`)];for(const D in a){const z=D.split(".")[0];let O;_[z]?O=_[z]:f[z]?O=un:_["*"]?O=_["*"]:f["*"]&&(O=un),O?S=S.concat(O({key:(n&&`${n}.`)+D,value:a[D],valueSpec:f[z]||f["*"],style:x,styleSpec:w,object:a,objectKey:D},a)):S.push(new r.i(n,a[D],`unknown property "${D}"`))}for(const D in f)_[D]||f[D].required&&f[D].default===void 0&&a[D]===void 0&&S.push(new r.V(n,a,`missing required property "${D}"`));return S}function wt(d){const n=d.value,a=d.valueSpec,f=d.style,_=d.styleSpec,x=d.key,w=d.arrayElementValidator||un;if(r.j(n)!=="array")return[new r.V(x,n,`array expected, ${r.j(n)} found`)];if(a.length&&n.length!==a.length)return[new r.V(x,n,`array length ${a.length} expected, length ${n.length} found`)];if(a["min-length"]&&n.length<a["min-length"])return[new r.V(x,n,`array length at least ${a["min-length"]} expected, length ${n.length} found`)];let S={type:a.value,values:a.values,minimum:a.minimum,maximum:a.maximum,function:void 0};_.$version<7&&(S.function=a.function),r.j(a.value)==="object"&&(S=a.value);let C=[];for(let D=0;D<n.length;D++)C=C.concat(w({array:n,arrayIndex:D,value:n[D],valueSpec:S,style:f,styleSpec:_,key:`${x}[${D}]`},!0));return C}function di(d){const n=d.key,a=d.value,f=d.valueSpec;let _=r.j(a);if(_==="number"&&a!=a&&(_="NaN"),_!=="number")return[new r.V(n,a,`number expected, ${_} found`)];if("minimum"in f){let x=f.minimum;if(r.j(f.minimum)==="array"&&(x=f.minimum[d.arrayIndex]),a<x)return[new r.V(n,a,`${a} is less than the minimum value ${x}`)]}if("maximum"in f){let x=f.maximum;if(r.j(f.maximum)==="array"&&(x=f.maximum[d.arrayIndex]),a>x)return[new r.V(n,a,`${a} is greater than the maximum value ${x}`)]}return[]}function Bt(d){const n=d.valueSpec,a=r.u(d.value.type);let f,_,x,w={};const S=a!=="categorical"&&d.value.property===void 0,C=!S,D=r.j(d.value.stops)==="array"&&r.j(d.value.stops[0])==="array"&&r.j(d.value.stops[0][0])==="object",z=Xe({key:d.key,value:d.value,valueSpec:d.styleSpec.function,style:d.style,styleSpec:d.styleSpec,objectElementValidators:{stops:function(U){if(a==="identity")return[new r.V(U.key,U.value,'identity function may not have a "stops" property')];let H=[];const q=U.value;return H=H.concat(wt({key:U.key,value:q,valueSpec:U.valueSpec,style:U.style,styleSpec:U.styleSpec,arrayElementValidator:O})),r.j(q)==="array"&&q.length===0&&H.push(new r.V(U.key,q,"array must have at least one stop")),H},default:function(U){return un({key:U.key,value:U.value,valueSpec:n,style:U.style,styleSpec:U.styleSpec})}}});return a==="identity"&&S&&z.push(new r.V(d.key,d.value,'missing required property "property"')),a==="identity"||d.value.stops||z.push(new r.V(d.key,d.value,'missing required property "stops"')),a==="exponential"&&d.valueSpec.expression&&!r.s(d.valueSpec)&&z.push(new r.V(d.key,d.value,"exponential functions not supported")),d.styleSpec.$version>=8&&(C&&!r.m(d.valueSpec)?z.push(new r.V(d.key,d.value,"property functions not supported")):S&&!r.n(d.valueSpec)&&z.push(new r.V(d.key,d.value,"zoom functions not supported"))),a!=="categorical"&&!D||d.value.property!==void 0||z.push(new r.V(d.key,d.value,'"property" property is required')),z;function O(U){let H=[];const q=U.value,Z=U.key;if(r.j(q)!=="array")return[new r.V(Z,q,`array expected, ${r.j(q)} found`)];if(q.length!==2)return[new r.V(Z,q,`array length 2 expected, length ${q.length} found`)];if(D){if(r.j(q[0])!=="object")return[new r.V(Z,q,`object expected, ${r.j(q[0])} found`)];if(q[0].zoom===void 0)return[new r.V(Z,q,"object stop key must have zoom")];if(q[0].value===void 0)return[new r.V(Z,q,"object stop key must have value")];const $=r.u(q[0].zoom);if(typeof $!="number")return[new r.V(Z,q[0].zoom,"stop zoom values must be numbers")];if(x&&x>$)return[new r.V(Z,q[0].zoom,"stop zoom values must appear in ascending order")];$!==x&&(x=$,_=void 0,w={}),H=H.concat(Xe({key:`${Z}[0]`,value:q[0],valueSpec:{zoom:{}},style:U.style,styleSpec:U.styleSpec,objectElementValidators:{zoom:di,value:V}}))}else H=H.concat(V({key:`${Z}[0]`,value:q[0],valueSpec:{},style:U.style,styleSpec:U.styleSpec},q));return r.o(r.q(q[1]))?H.concat([new r.V(`${Z}[1]`,q[1],"expressions are not allowed in function stops.")]):H.concat(un({key:`${Z}[1]`,value:q[1],valueSpec:n,style:U.style,styleSpec:U.styleSpec}))}function V(U,H){const q=r.j(U.value),Z=r.u(U.value),$=U.value!==null?U.value:H;if(f){if(q!==f)return[new r.V(U.key,$,`${q} stop domain type must match previous stop domain type ${f}`)]}else f=q;if(q!=="number"&&q!=="string"&&q!=="boolean"&&typeof Z!="number"&&typeof Z!="string"&&typeof Z!="boolean")return[new r.V(U.key,$,"stop domain value must be a number, string, or boolean")];if(q!=="number"&&a!=="categorical"){let K=`number expected, ${q} found`;return r.m(n)&&a===void 0&&(K+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new r.V(U.key,$,K)]}return a!=="categorical"||q!=="number"||typeof Z=="number"&&isFinite(Z)&&Math.floor(Z)===Z?a!=="categorical"&&q==="number"&&typeof Z=="number"&&typeof _=="number"&&_!==void 0&&Z<_?[new r.V(U.key,$,"stop domain values must appear in ascending order")]:(_=Z,a==="categorical"&&Z in w?[new r.V(U.key,$,"stop domain values must be unique")]:(w[Z]=!0,[])):[new r.V(U.key,$,`integer expected, found ${String(Z)}`)]}}function fi(d){const n=(d.expressionContext==="property"?r.r:r.t)(r.q(d.value),d.valueSpec);if(n.result==="error")return n.value.map(f=>new r.V(`${d.key}${f.key}`,d.value,f.message));const a=n.value.expression||n.value._styleExpression.expression;if(d.expressionContext==="property"&&d.propertyKey==="text-font"&&!a.outputDefined())return[new r.V(d.key,d.value,`Invalid data expression for "${d.propertyKey}". Output values must be contained as literals within the expression.`)];if(d.expressionContext==="property"&&d.propertyType==="layout"&&!r.v(a))return[new r.V(d.key,d.value,'"feature-state" data expressions are not supported with layout properties.')];if(d.expressionContext==="filter")return Cn(a,d);if(d.expressionContext&&d.expressionContext.indexOf("cluster")===0){if(!r.x(a,["zoom","feature-state"]))return[new r.V(d.key,d.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(d.expressionContext==="cluster-initial"&&!r.y(a))return[new r.V(d.key,d.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Cn(d,n){const a=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(n.valueSpec&&n.valueSpec.expression)for(const _ of n.valueSpec.expression.parameters)a.delete(_);if(a.size===0)return[];const f=[];return d instanceof r.C&&a.has(d.name)?[new r.V(n.key,n.value,`["${d.name}"] expression is not supported in a filter for a ${n.object.type} layer with id: ${n.object.id}`)]:(d.eachChild(_=>{f.push(...Cn(_,n))}),f)}function _n(d){const n=d.key,a=d.value,f=d.valueSpec,_=[];return Array.isArray(f.values)?f.values.indexOf(r.u(a))===-1&&_.push(new r.V(n,a,`expected one of [${f.values.join(", ")}], ${JSON.stringify(a)} found`)):Object.keys(f.values).indexOf(r.u(a))===-1&&_.push(new r.V(n,a,`expected one of [${Object.keys(f.values).join(", ")}], ${JSON.stringify(a)} found`)),_}function Kt(d){return r.A(r.q(d.value))?fi(r.k({},d,{expressionContext:"filter",valueSpec:d.styleSpec[`filter_${d.layerType||"fill"}`]})):gn(d)}function gn(d){const n=d.value,a=d.key;if(r.j(n)!=="array")return[new r.V(a,n,`array expected, ${r.j(n)} found`)];const f=d.styleSpec;let _,x=[];if(n.length<1)return[new r.V(a,n,"filter array must have at least 1 element")];switch(x=x.concat(_n({key:`${a}[0]`,value:n[0],valueSpec:f.filter_operator,style:d.style,styleSpec:d.styleSpec})),r.u(n[0])){case"<":case"<=":case">":case">=":n.length>=2&&r.u(n[1])==="$type"&&x.push(new r.V(a,n,`"$type" cannot be use with operator "${n[0]}"`));case"==":case"!=":n.length!==3&&x.push(new r.V(a,n,`filter array for operator "${n[0]}" must have 3 elements`));case"in":case"!in":n.length>=2&&(_=r.j(n[1]),_!=="string"&&x.push(new r.V(`${a}[1]`,n[1],`string expected, ${_} found`)));for(let w=2;w<n.length;w++)_=r.j(n[w]),r.u(n[1])==="$type"?x=x.concat(_n({key:`${a}[${w}]`,value:n[w],valueSpec:f.geometry_type,style:d.style,styleSpec:d.styleSpec})):_!=="string"&&_!=="number"&&_!=="boolean"&&x.push(new r.V(`${a}[${w}]`,n[w],`string, number, or boolean expected, ${_} found`));break;case"any":case"all":case"none":for(let w=1;w<n.length;w++)x=x.concat(gn({key:`${a}[${w}]`,value:n[w],style:d.style,styleSpec:d.styleSpec}));break;case"has":case"!has":_=r.j(n[1]),n.length!==2?x.push(new r.V(a,n,`filter array for "${n[0]}" operator must have 2 elements`)):_!=="string"&&x.push(new r.V(`${a}[1]`,n[1],`string expected, ${_} found`))}return x}function ji(d,n){const a=d.key,f=d.style,_=d.layer,x=d.styleSpec,w=d.value,S=d.objectKey,C=x[`${n}_${d.layerType}`];if(!C)return[];const D=S.match(/^(.*)-transition$/);if(n==="paint"&&D&&C[D[1]]&&C[D[1]].transition)return un({key:a,value:w,valueSpec:x.transition,style:f,styleSpec:x});const z=d.valueSpec||C[S];if(!z)return[new r.i(a,w,`unknown property "${S}"`)];let O;if(r.j(w)==="string"&&r.m(z)&&!z.tokens&&(O=/^{([^}]+)}$/.exec(w))){const U=`\`{ "type": "identity", "property": ${O?JSON.stringify(O[1]):'"_"'} }\``;return[new r.V(a,w,`"${S}" does not support interpolation syntax
Use an identity property function instead: ${U}.`)]}const V=[];if(d.layerType==="symbol")S!=="text-field"||!f||f.glyphs||f.imports||V.push(new r.V(a,w,'use of "text-field" requires a style "glyphs" property')),S==="text-font"&&r.B(r.q(w))&&r.u(w.type)==="identity"&&V.push(new r.V(a,w,'"text-font" does not support identity functions'));else if(d.layerType==="model"&&n==="paint"&&_&&_.layout&&_.layout.hasOwnProperty("model-id")&&r.m(z)&&(r.D(z)||r.n(z))){const U=r.r(r.q(w),z),H=U.value.expression||U.value._styleExpression.expression;H&&!r.x(H,["measure-light"])&&(S==="model-emissive-strength"&&r.y(H)&&r.v(H)||V.push(new r.V(a,w,`${S} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return V.concat(un({key:d.key,value:w,valueSpec:z,style:f,styleSpec:x,expressionContext:"property",propertyType:n,propertyKey:S}))}function On(d){return ji(d,"paint")}function Zn(d){return ji(d,"layout")}function pr(d){let n=[];const a=d.value,f=d.key,_=d.style,x=d.styleSpec;a.type||a.ref||n.push(new r.V(f,a,'either "type" or "ref" is required'));let w=r.u(a.type);const S=r.u(a.ref);if(a.id){const C=r.u(a.id);for(let D=0;D<d.arrayIndex;D++){const z=_.layers[D];r.u(z.id)===C&&n.push(new r.V(f,a.id,`duplicate layer id "${a.id}", previously used at line ${z.id.__line__}`))}}if("ref"in a){let C;["type","source","source-layer","filter","layout"].forEach(D=>{D in a&&n.push(new r.V(f,a[D],`"${D}" is prohibited for ref layers`))}),_.layers.forEach(D=>{r.u(D.id)===S&&(C=D)}),C?C.ref?n.push(new r.V(f,a.ref,"ref cannot reference another ref layer")):w=r.u(C.type):typeof S=="string"&&n.push(new r.V(f,a.ref,`ref layer "${S}" not found`))}else if(w!=="background"&&w!=="sky"&&w!=="slot")if(a.source){const C=_.sources&&_.sources[a.source],D=C&&r.u(C.type);C?D==="vector"&&w==="raster"?n.push(new r.V(f,a.source,`layer "${a.id}" requires a raster source`)):D==="raster"&&w!=="raster"?n.push(new r.V(f,a.source,`layer "${a.id}" requires a vector source`)):D!=="vector"||a["source-layer"]?D==="raster-dem"&&w!=="hillshade"?n.push(new r.V(f,a.source,"raster-dem source can only be used with layer type 'hillshade'.")):D!=="raster-array"||["raster","raster-particle"].includes(w)?w!=="line"||!a.paint||!a.paint["line-gradient"]&&!a.paint["line-trim-offset"]||D==="geojson"&&C.lineMetrics?w==="raster-particle"&&D!=="raster-array"&&n.push(new r.V(f,a.source,`layer "${a.id}" requires a 'raster-array' source.`)):n.push(new r.V(f,a,`layer "${a.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):n.push(new r.V(f,a.source,"raster-array source can only be used with layer type 'raster'.")):n.push(new r.V(f,a,`layer "${a.id}" must specify a "source-layer"`)):n.push(new r.V(f,a.source,`source "${a.source}" not found`))}else n.push(new r.V(f,a,'missing required property "source"'));return n=n.concat(Xe({key:f,value:a,valueSpec:x.layer,style:d.style,styleSpec:d.styleSpec,objectElementValidators:{"*":()=>[],type:()=>un({key:`${f}.type`,value:a.type,valueSpec:x.layer.type,style:d.style,styleSpec:d.styleSpec,object:a,objectKey:"type"}),filter:C=>Kt(r.k({layerType:w},C)),layout:C=>Xe({layer:a,key:C.key,value:C.value,valueSpec:{},style:C.style,styleSpec:C.styleSpec,objectElementValidators:{"*":D=>Zn(r.k({layerType:w},D))}}),paint:C=>Xe({layer:a,key:C.key,value:C.value,valueSpec:{},style:C.style,styleSpec:C.styleSpec,objectElementValidators:{"*":D=>On(r.k({layerType:w,layer:a},D))}})}})),n}function Vt(d){const n=d.value,a=d.key,f=r.j(n);return f!=="string"?[new r.V(a,n,`string expected, ${f} found`)]:[]}const Wt={promoteId:function({key:d,value:n}){if(r.j(n)==="string")return Vt({key:d,value:n});{const a=[];for(const f in n)a.push(...Vt({key:`${d}.${f}`,value:n[f]}));return a}}};function Ht(d){const n=d.value,a=d.key,f=d.styleSpec,_=d.style;if(!n.type)return[new r.V(a,n,'"type" is required')];const x=r.u(n.type);let w=[];switch(["vector","raster","raster-dem","raster-array"].includes(x)&&(n.url||n.tiles||w.push(new r.i(a,n,'Either "url" or "tiles" is required.'))),x){case"vector":case"raster":case"raster-dem":case"raster-array":return w=w.concat(Xe({key:a,value:n,valueSpec:f[`source_${x.replace("-","_")}`],style:d.style,styleSpec:f,objectElementValidators:Wt})),w;case"geojson":if(w=Xe({key:a,value:n,valueSpec:f.source_geojson,style:_,styleSpec:f,objectElementValidators:Wt}),n.cluster)for(const S in n.clusterProperties){const[C,D]=n.clusterProperties[S],z=typeof C=="string"?[C,["accumulated"],["get",S]]:C;w.push(...fi({key:`${a}.${S}.map`,value:D,expressionContext:"cluster-map"})),w.push(...fi({key:`${a}.${S}.reduce`,value:z,expressionContext:"cluster-reduce"}))}return w;case"video":return Xe({key:a,value:n,valueSpec:f.source_video,style:_,styleSpec:f});case"image":return Xe({key:a,value:n,valueSpec:f.source_image,style:_,styleSpec:f});case"canvas":return[new r.V(a,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return _n({key:`${a}.type`,value:n.type,valueSpec:{values:Ui(f)},style:_,styleSpec:f})}}function Ui(d){return d.source.reduce((n,a)=>{const f=d[a];return f.type.type==="enum"&&(n=n.concat(Object.keys(f.type.values))),n},[])}function Tt(d){const n=d.value,a=d.styleSpec,f=a.light,_=d.style;let x=[];const w=r.j(n);if(n===void 0)return x;if(w!=="object")return x=x.concat([new r.V("light",n,`object expected, ${w} found`)]),x;for(const S in n){const C=S.match(/^(.*)-transition$/);x=x.concat(C&&f[C[1]]&&f[C[1]].transition?un({key:S,value:n[S],valueSpec:a.transition,style:_,styleSpec:a}):f[S]?un({key:S,value:n[S],valueSpec:f[S],style:_,styleSpec:a}):[new r.V(S,n[S],`unknown property "${S}"`)])}return x}function Fn(d){const n=d.value;let a=[];if(!n)return a;const f=r.j(n);if(f!=="object")return a=a.concat([new r.V("light-3d",n,`object expected, ${f} found`)]),a;const _=d.styleSpec,x=_["light-3d"],w=d.key,S=d.style,C=d.style.lights;for(const O of["type","id"])if(!(O in n))return a=a.concat([new r.V("light-3d",n,`missing property ${O} on light`)]),a;if(n.type&&C)for(let O=0;O<d.arrayIndex;O++){const V=r.u(n.type),U=C[O];r.u(U.type)===V&&a.push(new r.V(w,n.id,`duplicate light type "${n.type}", previously defined at line ${U.id.__line__}`))}const D=`properties_light_${n.type}`;if(!(D in _))return a=a.concat([new r.V("light-3d",n,`Invalid light type ${n.type}`)]),a;const z=_[D];for(const O in n)if(O==="properties"){const V=n[O],U=r.j(V);if(U!=="object")return a=a.concat([new r.V("properties",V,`object expected, ${U} found`)]),a;for(const H in V)a=a.concat(z[H]?un({key:H,value:V[H],valueSpec:z[H],style:S,styleSpec:_}):[new r.i(d.key,V[H],`unknown property "${H}"`)])}else{const V=O.match(/^(.*)-transition$/);a=a.concat(V&&x[V[1]]&&x[V[1]].transition?un({key:O,value:n[O],valueSpec:_.transition,style:S,styleSpec:_}):x[O]?un({key:O,value:n[O],valueSpec:x[O],style:S,styleSpec:_}):[new r.i(O,n[O],`unknown property "${O}"`)])}return a}function Zi(d){const n=d.value,a=d.key,f=d.style,_=d.styleSpec,x=_.terrain;let w=[];const S=r.j(n);if(n===void 0||S==="null")return w;if(S!=="object")return w=w.concat([new r.V("terrain",n,`object expected, ${S} found`)]),w;for(const C in n){const D=C.match(/^(.*)-transition$/);w=w.concat(D&&x[D[1]]&&x[D[1]].transition?un({key:C,value:n[C],valueSpec:_.transition,style:f,styleSpec:_}):x[C]?un({key:C,value:n[C],valueSpec:x[C],style:f,styleSpec:_}):[new r.i(C,n[C],`unknown property "${C}"`)])}if(n.source){const C=f.sources&&f.sources[n.source],D=C&&r.u(C.type);C?D!=="raster-dem"&&w.push(new r.V(a,n.source,`terrain cannot be used with a source of type ${String(D)}, it only be used with a "raster-dem" source type`)):w.push(new r.V(a,n.source,`source "${n.source}" not found`))}else w.push(new r.V(a,n,'terrain is missing required property "source"'));return w}function ir(d){const n=d.value,a=d.style,f=d.styleSpec,_=f.fog;let x=[];const w=r.j(n);if(n===void 0)return x;if(w!=="object")return x=x.concat([new r.V("fog",n,`object expected, ${w} found`)]),x;for(const S in n){const C=S.match(/^(.*)-transition$/);x=x.concat(C&&_[C[1]]&&_[C[1]].transition?un({key:S,value:n[S],valueSpec:f.transition,style:a,styleSpec:f}):_[S]?un({key:S,value:n[S],valueSpec:_[S],style:a,styleSpec:f}):[new r.i(S,n[S],`unknown property "${S}"`)])}return x}const $n={"*":()=>[],array:wt,boolean:function(d){const n=d.value,a=d.key,f=r.j(n);return f!=="boolean"?[new r.V(a,n,`boolean expected, ${f} found`)]:[]},number:di,color:function(d){const n=d.key,a=d.value,f=r.j(a);return f!=="string"?[new r.V(n,a,`color expected, ${f} found`)]:r.z(a)===null?[new r.V(n,a,`color expected, "${a}" found`)]:[]},enum:_n,filter:Kt,function:Bt,layer:pr,object:Xe,source:Ht,model:r.F,light:Tt,"light-3d":Fn,terrain:Zi,fog:ir,string:Vt,formatted:function(d){return Vt(d).length===0?[]:fi(d)},resolvedImage:function(d){return Vt(d).length===0?[]:fi(d)},projection:function(d){const n=d.value,a=d.styleSpec,f=a.projection,_=d.style;let x=[];const w=r.j(n);if(w==="object")for(const S in n)x=x.concat(un({key:S,value:n[S],valueSpec:f[S],style:_,styleSpec:a}));else w!=="string"&&(x=x.concat([new r.V("projection",n,`object or string expected, ${w} found`)]));return x},import:function(d){const{value:n,styleSpec:a}=d,{data:f,..._}=n;Object.defineProperty(_,"__line__",{value:n.__line__,enumerable:!1});let x=Xe(r.k({},d,{value:_,valueSpec:a.import}));return r.u(_.id)===""&&x.push(new r.V(`${d.key}.id`,_,"import id can't be an empty string")),f&&(x=x.concat(Qt(f,a,{key:`${d.key}.data`}))),x}};function un(d,n=!1){const a=d.value,f=d.valueSpec,_=d.styleSpec;if(f.expression&&r.B(r.u(a)))return Bt(d);if(f.expression&&r.o(r.q(a)))return fi(d);if(f.type&&$n[f.type]){const x=$n[f.type](d);return n===!0&&x.length>0&&r.j(d.value)==="array"?fi(d):x}return Xe(r.k({},d,{valueSpec:f.type?_[f.type]:f}))}function Do(d){const n=d.value,a=d.key,f=Vt(d);return f.length||(n.indexOf("{fontstack}")===-1&&f.push(new r.V(a,n,'"glyphs" url must include a "{fontstack}" token')),n.indexOf("{range}")===-1&&f.push(new r.V(a,n,'"glyphs" url must include a "{range}" token'))),f}function Qt(d,n=r.G,a={}){return un({key:a.key||"",value:d,valueSpec:n.$root,styleSpec:n,style:d,objectElementValidators:{glyphs:Do,"*":()=>[]}})}function Zt(d,n=r.G){return He(Qt(d,n))}const dl=d=>He(Ht(d)),Kr=d=>He(Tt(d)),rt=d=>He(Fn(d)),ne=d=>He(Zi(d)),ue=d=>He(ir(d)),be=d=>He(pr(d)),$e=d=>He(Kt(d)),Ke=d=>He(On(d)),ot=d=>He(Zn(d)),Dt=d=>He(r.F(d));function He(d){return d.slice().sort((n,a)=>n.line&&a.line?n.line-a.line:0)}function St(d,n){let a=!1;if(n&&n.length)for(const f of n)f instanceof r.i?r.w(f.message):(d.fire(new r.a(new Error(f.message))),a=!0);return a}const Ct=new r.H({anchor:new r.J(r.G.light.anchor),position:new r.K(r.G.light.position),color:new r.J(r.G.light.color),intensity:new r.J(r.G.light.intensity)});class Lt extends r.E{constructor(n,a="flat"){super(),this._transitionable=new r.L(Ct),this.setLight(n,a),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(n,a,f={}){this._validate(Kr,n,f)||(this._transitionable.setTransitionOrValue(n),this.id=a)}updateTransitions(n){this._transitioning=this._transitionable.transitioned(n,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(n){this.properties=this._transitioning.possiblyEvaluate(n)}_validate(n,a,f){return(!f||f.validate!==!1)&&St(this,n.call(Zt,r.e({value:a,style:{glyphs:!0,sprite:!0},styleSpec:r.G})))}}const yt=new r.H({source:new r.J(r.G.terrain.source),exaggeration:new r.J(r.G.terrain.exaggeration)});let $i=class extends r.E{constructor(d,n,a,f){super(),this.scope=a,this._transitionable=new r.L(yt,a,f),this._transitionable.setTransitionOrValue(d,f),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=n}get(){return this._transitionable.serialize()}set(d,n){this._transitionable.setTransitionOrValue(d,n)}updateTransitions(d){this._transitioning=this._transitionable.transitioned(d,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(d){this.properties=this._transitioning.possiblyEvaluate(d)}getExaggeration(d){return this._transitioning.possiblyEvaluate(new r.N(d)).get("exaggeration")}isZoomDependent(){const d=this._transitionable._values.exaggeration;return d!=null&&d.value!=null&&d.value.expression!=null&&d.value.expression instanceof r.Z}};const zi=45,qi=65,Li=.05;function Oi(d,n,a,f){const _=r.S(zi,qi,a),[x,w]=Yi(d,f);let S=1-Math.min(1,Math.exp((n-x)/(w-x)*-6));return S*=S*S,S=Math.min(1,1.00747*S),S*_*d.alpha}function Yi(d,n){const a=.5/Math.tan(.5*n);return[d.range[0]+a,d.range[1]+a]}function yn(d,n,a,f,_){const x=r.Q.transformMat4([],[n,a,f],_.mercatorFogMatrix);return Oi(d,r.Q.length(x),_.pitch,_._fov)}function nr(d,n,a,f,_,x,w){const S=[[a,f,0],[_,f,0],[_,x,0],[a,x,0]];let C=Number.MAX_VALUE,D=-Number.MAX_VALUE;for(const z of S){const O=r.Q.transformMat4([],z,n),V=r.Q.length(O);C=Math.min(C,V),D=Math.max(D,V)}return[Oi(d,C,w.pitch,w._fov),Oi(d,D,w.pitch,w._fov)]}const ln=new r.H({range:new r.J(r.G.fog.range),color:new r.J(r.G.fog.color),"high-color":new r.J(r.G.fog["high-color"]),"space-color":new r.J(r.G.fog["space-color"]),"horizon-blend":new r.J(r.G.fog["horizon-blend"]),"star-intensity":new r.J(r.G.fog["star-intensity"]),"vertical-range":new r.J(r.G.fog["vertical-range"])});class Cr extends r.E{constructor(n,a,f,_){super(),this._transitionable=new r.L(ln,f,new Map(_)),this.set(n,_),this._transitioning=this._transitionable.untransitioned(),this._transform=a,this.properties=new r.U(ln)}get state(){const n=this._transform,a=n.projection.name==="globe",f=r.W(n.zoom),_=this.properties.get("range"),x=[.5,3];return{range:a?[r.X(x[0],_[0],f),r.X(x[1],_[1],f)]:_,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(n,a,f={}){if(this._validate(ue,n,f))return;const _=r.e({},n);for(const x of Object.keys(r.G.fog))_[x]===void 0&&(_[x]=r.G.fog[x].default);this._options=_,this._transitionable.setTransitionOrValue(this._options,a)}getOpacity(n){if(!this._transform.projection.supportsFog)return 0;const a=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:r.S(zi,qi,n))*a.a}getOpacityAtLatLng(n,a){return this._transform.projection.supportsFog?function(f,_,x){const w=r.O.fromLngLat(_),S=x.elevation?x.elevation.getAtPointOrZero(w):0;return yn(f,w.x,w.y,S,x)}(this.state,n,a):0}getOpacityForTile(n){if(!this._transform.projection.supportsFog)return[1,1];const a=this._transform.calculateFogTileMatrix(n.toUnwrapped());return nr(this.state,a,0,0,r.Y,r.Y,this._transform)}getOpacityForBounds(n,a,f,_,x){return this._transform.projection.supportsFog?nr(this.state,n,a,f,_,x,this._transform):[1,1]}getFovAdjustedRange(n){return this._transform.projection.supportsFog?Yi(this.state,n):[0,1]}isVisibleOnFrustum(n){if(!this._transform.projection.supportsFog)return!1;const a=[4,5,6,7];for(const f of a){const _=n.points[f];let x;if(_[2]>=0)x=_;else{const w=n.points[f-4];x=r._(w,_,w[2]/(w[2]-_[2]))}if(yn(this.state,x[0],x[1],0,this._transform)>=Li)return!0}return!1}updateConfig(n){this._transitionable.setTransitionOrValue(this._options,new Map(n))}updateTransitions(n){this._transitioning=this._transitionable.transitioned(n,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(n){this.properties=this._transitioning.possiblyEvaluate(n)}_validate(n,a,f){return(!f||f.validate!==!1)&&St(this,n.call(Zt,r.e({value:a,style:{glyphs:!0,sprite:!0},styleSpec:r.G})))}}class wr extends r.E{constructor(n,a,f,_){super(),this.scope=f,this._options=n,this.properties=new r.U(a),this._transitionable=new r.L(a,f,new Map(_)),this._transitionable.setTransitionOrValue(n.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(n){this._transitionable.setTransitionOrValue(this._options.properties,new Map(n))}updateTransitions(n){this._transitioning=this._transitionable.transitioned(n,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(n){this.properties=this._transitioning.possiblyEvaluate(n)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(n,a){this._options=n,this._transitionable.setTransitionOrValue(n.properties,a)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}const ds=new r.H({color:new r.J(r.G.properties_light_ambient.color),intensity:new r.J(r.G.properties_light_ambient.intensity)}),Un=new r.H({direction:new r.$(r.G.properties_light_directional.direction),color:new r.J(r.G.properties_light_directional.color),intensity:new r.J(r.G.properties_light_directional.intensity),"cast-shadows":new r.J(r.G.properties_light_directional["cast-shadows"]),"shadow-intensity":new r.J(r.G.properties_light_directional["shadow-intensity"])});class vn{constructor(n,a,f,_){this.screenBounds=n,this.cameraPoint=a,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=f,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,_)}static createFromScreenPoints(n,a){let f,_;if(n instanceof r.P||typeof n[0]=="number"){const x=r.P.convert(n);f=[x],_=a.isPointAboveHorizon(x)}else{const x=r.P.convert(n[0]),w=r.P.convert(n[1]);f=[x,w],_=r.a0(x,w).every(S=>a.isPointAboveHorizon(S))}return new vn(f,a.getCameraPoint(),_,a)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(n){return r.a0(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],n)}bufferedCameraGeometry(n){const a=this.screenBounds[0],f=this.screenBounds.length===1?this.screenBounds[0].add(new r.P(1,1)):this.screenBounds[1],_=r.a0(a,f,0,!1);return this.cameraPoint.y>f.y&&(this.cameraPoint.x>a.x&&this.cameraPoint.x<f.x?_.splice(3,0,this.cameraPoint):this.cameraPoint.x>=f.x?_[2]=this.cameraPoint:this.cameraPoint.x<=a.x&&(_[3]=this.cameraPoint)),r.a1(_,n)}bufferedCameraGeometryGlobe(n){const a=this.screenBounds[0],f=this.screenBounds.length===1?this.screenBounds[0].add(new r.P(1,1)):this.screenBounds[1],_=r.a0(a,f,n),x=this.cameraPoint.clone();switch(3*((x.y>a.y)+(x.y>f.y))+((x.x>a.x)+(x.x>f.x))){case 0:_[0]=x,_[4]=x.clone();break;case 1:_.splice(1,0,x);break;case 2:_[1]=x;break;case 3:_.splice(4,0,x);break;case 5:_.splice(2,0,x);break;case 6:_[3]=x;break;case 7:_.splice(3,0,x);break;case 8:_[2]=x}return _}containsTile(n,a,f,_=0){const x=n.queryPadding/a._pixelsPerMercatorPixel+1,w=f?this._bufferedCameraMercator(x,a):this._bufferedScreenMercator(x,a);let S=n.tileID.wrap+(w.unwrapped?_:0);const C=w.polygon.map(Z=>r.a2(n.tileTransform,Z,S));if(!r.a3(C,0,0,r.Y,r.Y))return;S=n.tileID.wrap+(this.screenGeometryMercator.unwrapped?_:0);const D=this.screenGeometryMercator.polygon.map(Z=>r.a4(n.tileTransform,Z,S)),z=D.map(Z=>new r.P(Z[0],Z[1])),O=a.getFreeCameraOptions().position||new r.O(0,0,0),V=r.a4(n.tileTransform,O,S),U=D.map(Z=>{const $=r.Q.sub(Z,Z,V);return r.Q.normalize($,$),new r.a5(V,$)}),H=r.a6(n,1,a.zoom)*a._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:z,tilespaceRays:U,bufferedTilespaceGeometry:C,bufferedTilespaceBounds:(q=r.a7(C),q.min.x=r.ad(q.min.x,0,r.Y),q.min.y=r.ad(q.min.y,0,r.Y),q.max.x=r.ad(q.max.x,0,r.Y),q.max.y=r.ad(q.max.y,0,r.Y),q),tile:n,tileID:n.tileID,pixelToTileUnitsFactor:H};var q}_bufferedScreenMercator(n,a){const f=et(n);if(this._screenRaycastCache[f])return this._screenRaycastCache[f];{let _;return _=a.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(n),a):{polygon:this.bufferedScreenGeometry(n).map(x=>a.pointCoordinate3D(x)),unwrapped:!0},this._screenRaycastCache[f]=_,_}}_bufferedCameraMercator(n,a){const f=et(n);if(this._cameraRaycastCache[f])return this._cameraRaycastCache[f];{let _;return _=a.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(n),a):{polygon:this.bufferedCameraGeometry(n).map(x=>a.pointCoordinate3D(x)),unwrapped:!0},this._cameraRaycastCache[f]=_,_}}_projectAndResample(n,a){const f=function(x,w){const S=r.a9.multiply([],w.pixelMatrix,w.globeMatrix),C=[0,-r.ae,0,1],D=[0,r.ae,0,1],z=[0,0,0,1];r.aa.transformMat4(C,C,S),r.aa.transformMat4(D,D,S),r.aa.transformMat4(z,z,S);const O=new r.P(C[0]/C[3],C[1]/C[3]),V=new r.P(D[0]/D[3],D[1]/D[3]),U=r.ab(x,O)&&C[3]<z[3],H=r.ab(x,V)&&D[3]<z[3];if(!U&&!H)return null;const q=function(ee,me,fe){for(let xe=1;xe<ee.length;xe++){const ke=Ge(me.pointCoordinate3D(ee[xe-1]).x),ye=Ge(me.pointCoordinate3D(ee[xe]).x);if(fe<0){if(ke<ye)return{idx:xe,t:-ke/(ye-1-ke)}}else if(ye<ke)return{idx:xe,t:(1-ke)/(ye+1-ke)}}return null}(x,w,U?-1:1);if(!q)return null;const{idx:Z,t:$}=q;let K=Z>1?je(x.slice(0,Z),w):[],oe=Z<x.length?je(x.slice(Z),w):[];K=K.map(ee=>new r.P(Ge(ee.x),ee.y)),oe=oe.map(ee=>new r.P(Ge(ee.x),ee.y));const se=[...K];se.length===0&&se.push(oe[oe.length-1]);const le=r.X(se[se.length-1].y,(oe.length===0?K[0]:oe[0]).y,$);let Y;return Y=U?[new r.P(0,le),new r.P(0,0),new r.P(1,0),new r.P(1,le)]:[new r.P(1,le),new r.P(1,1),new r.P(0,1),new r.P(0,le)],se.push(...Y),oe.length===0?se.push(K[0]):se.push(...oe),{polygon:se.map(ee=>new r.O(ee.x,ee.y)),unwrapped:!1}}(n,a);if(f)return f;const _=function(x,w){let S=!1,C=-1/0,D=0;for(let O=0;O<x.length-1;O++)x[O].x>C&&(C=x[O].x,D=O);for(let O=0;O<x.length-1;O++){const V=(D+O)%(x.length-1),U=x[V],H=x[V+1];Math.abs(U.x-H.x)>.5&&(U.x<H.x?(U.x+=1,V===0&&(x[x.length-1].x+=1)):(H.x+=1,V+1===x.length-1&&(x[0].x+=1)),S=!0)}const z=r.a8(w.center.lng);return S&&z<Math.abs(z-1)&&x.forEach(O=>{O.x-=1}),{polygon:x,unwrapped:S}}(je(n,a).map(x=>new r.P(Ge(x.x),x.y)),a);return{polygon:_.polygon.map(x=>new r.O(x.x,x.y)),unwrapped:_.unwrapped}}}function je(d,n){return r.ac(d,a=>{const f=n.pointCoordinate3D(a);a.x=f.x,a.y=f.y},1/256)}function Ge(d){return d<0?1+d%1:d%1}function et(d){return 100*d|0}function ct(d,n,a,f,_){const x=function(w,S){if(w)return _(w);if(S){d.url&&S.tiles&&d.tiles&&delete d.tiles;const C=r.af(r.e(S,d),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);S.vector_layers&&(C.vectorLayers=S.vector_layers,C.vectorLayerIds=C.vectorLayers.map(D=>D.id)),S.raster_layers&&(C.rasterLayers=S.raster_layers,C.rasterLayerIds=C.rasterLayers.map(D=>D.id)),C.tiles=n.canonicalizeTileset(C,d.url),_(null,C)}};return d.url?r.g(n.transformRequest(n.normalizeSourceURL(d.url,null,a,f),r.R.Source),x):r.f.frame(()=>x(null,d))}class at{constructor(n,a,f){this.bounds=r.ag.convert(this.validateBounds(n)),this.minzoom=a||0,this.maxzoom=f||24}validateBounds(n){return Array.isArray(n)&&n.length===4?[Math.max(-180,n[0]),Math.max(-90,n[1]),Math.min(180,n[2]),Math.min(90,n[3])]:[-180,-90,180,90]}contains(n){const a=Math.pow(2,n.z),f=Math.floor(r.a8(this.bounds.getWest())*a),_=Math.floor(r.ah(this.bounds.getNorth())*a),x=Math.ceil(r.a8(this.bounds.getEast())*a),w=Math.ceil(r.ah(this.bounds.getSouth())*a);return n.x>=f&&n.x<x&&n.y>=_&&n.y<w}}class mt extends r.E{constructor(n,a,f,_){if(super(),this.id=n,this.dispatcher=f,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,r.e(this,r.af(a,["url","scheme","tileSize","promoteId"])),this._options=r.e({type:"vector"},a),this._collectResourceTiming=!!a.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(_),this._tileWorkers={},this._deduped=new r.ai}load(n){this._loaded=!1,this.fire(new r.b("dataloading",{dataType:"source"}));const a=Array.isArray(this.map._language)?this.map._language.join():this.map._language,f=this.map._worldview;this._tileJSONRequest=ct(this._options,this.map._requestManager,a,f,(_,x)=>{this._tileJSONRequest=null,this._loaded=!0,_?(a&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${a}`),f&&f.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${f}`),this.fire(new r.a(_))):x&&(r.e(this,x),x.bounds&&(this.tileBounds=new at(x.bounds,this.minzoom,this.maxzoom)),r.am(x.tiles,this.map._requestManager._customAccessToken),this.fire(new r.b("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new r.b("data",{dataType:"source",sourceDataType:"content"}))),n&&n(_)})}loaded(){return this._loaded}hasTile(n){return!this.tileBounds||this.tileBounds.contains(n.canonical)}onAdd(n){this.map=n,this.load()}reload(){this.cancelTileJSONRequest();const n=r.aj(this.id,this.scope);this.load(()=>this.map.style.clearSource(n))}setTiles(n){return this._options.tiles=n,this.reload(),this}setUrl(n){return this.url=n,this._options.url=n,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return r.e({},this._options)}loadTile(n,a){const f=this.map._requestManager.normalizeTileURL(n.tileID.canonical.url(this.tiles,this.scheme)),_={request:this.map._requestManager.transformRequest(f,r.R.Tile),data:void 0,uid:n.uid,tileID:n.tileID,tileZoom:n.tileZoom,zoom:n.tileID.overscaledZ,tileSize:this.tileSize*n.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:r.f.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:n.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:n.isExtraShadowCaster};if(_.request.collectResourceTiming=this._collectResourceTiming,n.actor&&n.state!=="expired")n.state==="loading"?n.reloadCallback=a:n.request=n.actor.send("reloadTile",_,x.bind(this));else if(n.actor=this._tileWorkers[f]=this._tileWorkers[f]||this.dispatcher.getActor(),this.dispatcher.ready)n.request=n.actor.send("loadTile",_,x.bind(this),void 0,!0);else{const w=r.ak.call({deduped:this._deduped},_,(S,C)=>{S||!C?x.call(this,S):(_.data={cacheControl:C.cacheControl,expires:C.expires,rawData:C.rawData.slice(0)},n.actor&&n.actor.send("loadTile",_,x.bind(this),void 0,!0))},!0);n.request={cancel:w}}function x(w,S){return delete n.request,n.aborted?a(null):w&&w.status!==404?a(w):(S&&S.resourceTiming&&(n.resourceTiming=S.resourceTiming),this.map._refreshExpiredTiles&&S&&n.setExpiryData(S),n.loadVectorData(S,this.map.painter),r.al(this.dispatcher),a(null),void(n.reloadCallback&&(this.loadTile(n,n.reloadCallback),n.reloadCallback=null)))}}abortTile(n){n.request&&(n.request.cancel(),delete n.request),n.actor&&n.actor.send("abortTile",{uid:n.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(n){n.actor&&n.actor.send("removeTile",{uid:n.uid,type:this.type,source:this.id,scope:this.scope}),n.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class _t extends r.E{constructor(n,a,f,_){super(),this.id=n,this.dispatcher=f,this.setEventedParent(_),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=r.e({type:"raster"},a),r.e(this,r.af(a,["url","scheme","tileSize"]))}load(n){this._loaded=!1,this.fire(new r.b("dataloading",{dataType:"source"})),this._tileJSONRequest=ct(this._options,this.map._requestManager,null,null,(a,f)=>{this._tileJSONRequest=null,this._loaded=!0,a?this.fire(new r.a(a)):f&&(r.e(this,f),f.bounds&&(this.tileBounds=new at(f.bounds,this.minzoom,this.maxzoom)),r.am(f.tiles),this.fire(new r.b("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new r.b("data",{dataType:"source",sourceDataType:"content"}))),n&&n(a)})}loaded(){return this._loaded}onAdd(n){this.map=n,this.load()}reload(){this.cancelTileJSONRequest();const n=r.aj(this.id,this.scope);this.load(()=>this.map.style.clearSource(n))}setTiles(n){return this._options.tiles=n,this.reload(),this}setUrl(n){return this.url=n,this._options.url=n,this.reload(),this}onRemove(){this.cancelTileJSONRequest()}serialize(){return r.e({},this._options)}hasTile(n){return!this.tileBounds||this.tileBounds.contains(n.canonical)}loadTile(n,a){const f=r.f.devicePixelRatio>=2,_=this.map._requestManager.normalizeTileURL(n.tileID.canonical.url(this.tiles,this.scheme),f,this.tileSize);n.request=r.d(this.map._requestManager.transformRequest(_,r.R.Tile),(x,w,S,C)=>(delete n.request,n.aborted?(n.state="unloaded",a(null)):x?(n.state="errored",a(x)):w?(this.map._refreshExpiredTiles&&n.setExpiryData({cacheControl:S,expires:C}),n.setTexture(w,this.map.painter),n.state="loaded",r.al(this.dispatcher),void a(null)):a(null)))}abortTile(n,a){n.request&&(n.request.cancel(),delete n.request),a()}unloadTile(n,a){n.texture&&n.texture instanceof r.T?(n.destroy(!0),n.texture&&n.texture instanceof r.T&&this.map.painter.saveTileTexture(n.texture)):n.destroy(),a()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class ut extends _t{constructor(n,a,f,_){super(n,a,f,_),this.type="raster-array",this.maxzoom=22,this._options=r.e({type:"raster-array"},a)}triggerRepaint(n){const a=this.map.painter._terrain,f=this.map.style.getSourceCache(this.id);a&&a.enabled&&f&&a._clearRenderCacheForTile(f.id,n.tileID),this.map.triggerRepaint()}loadTile(n,a){const f=this.map._requestManager.normalizeTileURL(n.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),_=this.map._requestManager.transformRequest(f,r.R.Tile);n.requestParams=_,n.actor||(n.actor=this.dispatcher.getActor()),n.request=n.fetchHeader(void 0,(x,w,S,C)=>{if(delete n.request,n.aborted)return n.state="unloaded",a(null);if(x)return x.code===20?void 0:(n.state="errored",a(x));this.map._refreshExpiredTiles&&n.setExpiryData({cacheControl:S,expires:C}),n.state="empty",a(null)})}unloadTile(n){const a=n.texture;a&&a instanceof r.T?(n.destroy(!0),this.map.painter.saveTileTexture(a)):(n.destroy(),n.flushQueues(),n._isHeaderLoaded=!1,delete n._mrt,delete n.textureDescriptor),n.fbo&&(n.fbo.destroy(),delete n.fbo),delete n.request,delete n.requestParams,delete n.neighboringTiles,n.state="unloaded"}prepareTile(n,a,f){n._isHeaderLoaded&&(n.state!=="empty"&&(n.state="reloading"),n.fetchBand(a,f,(_,x)=>{if(_)return n.state="errored",this.fire(new r.a(_)),void this.triggerRepaint(n);x&&(n.setTexture(x,this.map.painter),n.state="loaded",this.triggerRepaint(n))}))}getInitialBand(n){if(!this.rasterLayers)return 0;const a=this.rasterLayers.find(({id:x})=>x===n),f=a&&a.fields,_=f&&f.bands&&f.bands;return _?_[0]:0}getTextureDescriptor(n,a,f){if(!n)return;const _=a.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!_)return;let x=null;a instanceof r.aq?x=a.paint.get("raster-array-band"):a instanceof r.ar&&(x=a.paint.get("raster-particle-array-band"));const w=x||this.getInitialBand(_);if(w!=null)if(n.textureDescriptor){if(!n.updateNeeded(_,w)||f)return Object.assign({},n.textureDescriptor,{texture:n.texture})}else this.prepareTile(n,_,w)}}const xt=32,dt=33,Xt=new Uint16Array(8184);for(let d=0;d<2046;d++){let n=d+2,a=0,f=0,_=0,x=0,w=0,S=0;for(1&n?_=x=w=xt:a=f=S=xt;(n>>=1)>1;){const D=a+_>>1,z=f+x>>1;1&n?(_=a,x=f,a=w,f=S):(a=_,f=x,_=w,x=S),w=D,S=z}const C=4*d;Xt[C+0]=a,Xt[C+1]=f,Xt[C+2]=_,Xt[C+3]=x}const wi=new Uint16Array(2178),Rt=new Uint8Array(1089),Qi=new Uint16Array(1089);function bn(d){return d===0?-.03125:d===32?.03125:0}class tn{constructor(n,a,f,_){this.id=tn.uniqueIdxCounter,tn.uniqueIdxCounter++,this.context=n;const x=n.gl;this.buffer=x.createBuffer(),this.dynamicDraw=!!f,this.context.unbindVAO(),n.bindElementBuffer.set(this.buffer),x.bufferData(x.ELEMENT_ARRAY_BUFFER,a.arrayBuffer,this.dynamicDraw?x.DYNAMIC_DRAW:x.STATIC_DRAW),this.dynamicDraw||_||a.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(n){this.id=tn.uniqueIdxCounter,tn.uniqueIdxCounter++;const a=this.context.gl;this.context.unbindVAO(),this.bind(),a.bufferSubData(a.ELEMENT_ARRAY_BUFFER,0,n.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}tn.uniqueIdxCounter=0;const Pn={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class En{constructor(n,a,f,_,x,w){this.length=a.length,this.attributes=f,this.itemSize=a.bytesPerElement,this.dynamicDraw=_,this.instanceCount=w,this.context=n;const S=n.gl;this.buffer=S.createBuffer(),n.bindVertexBuffer.set(this.buffer),S.bufferData(S.ARRAY_BUFFER,a.arrayBuffer,this.dynamicDraw?S.DYNAMIC_DRAW:S.STATIC_DRAW),this.dynamicDraw||x||a.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(n){const a=this.context.gl;this.bind(),a.bufferSubData(a.ARRAY_BUFFER,0,n.arrayBuffer)}enableAttributes(n,a){for(let f=0;f<this.attributes.length;f++){const _=a.attributes[this.attributes[f].name];_!==void 0&&n.enableVertexAttribArray(_)}}setVertexAttribPointers(n,a,f){for(let _=0;_<this.attributes.length;_++){const x=this.attributes[_],w=a.attributes[x.name];w!==void 0&&n.vertexAttribPointer(w,x.components,n[Pn[x.type]],!1,this.itemSize,x.offset+this.itemSize*(f||0))}}setVertexAttribDivisor(n,a,f){for(let _=0;_<this.attributes.length;_++){const x=a.attributes[this.attributes[_].name];x!==void 0&&this.instanceCount&&this.instanceCount>0&&n.vertexAttribDivisor(x,f)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Ai{constructor(n){this.gl=n.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(n){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Hr extends Ai{getDefault(){return r.aA.transparent}set(n){const a=this.current;(n.r!==a.r||n.g!==a.g||n.b!==a.b||n.a!==a.a||this.dirty)&&(this.gl.clearColor(n.r,n.g,n.b,n.a),this.current=n,this.dirty=!1)}}class fs extends Ai{getDefault(){return 1}set(n){(n!==this.current||this.dirty)&&(this.gl.clearDepth(n),this.current=n,this.dirty=!1)}}class lr extends Ai{getDefault(){return 0}set(n){(n!==this.current||this.dirty)&&(this.gl.clearStencil(n),this.current=n,this.dirty=!1)}}class ko extends Ai{getDefault(){return[!0,!0,!0,!0]}set(n){const a=this.current;(n[0]!==a[0]||n[1]!==a[1]||n[2]!==a[2]||n[3]!==a[3]||this.dirty)&&(this.gl.colorMask(n[0],n[1],n[2],n[3]),this.current=n,this.dirty=!1)}}class fl extends Ai{getDefault(){return!0}set(n){(n!==this.current||this.dirty)&&(this.gl.depthMask(n),this.current=n,this.dirty=!1)}}class Pr extends Ai{getDefault(){return 255}set(n){(n!==this.current||this.dirty)&&(this.gl.stencilMask(n),this.current=n,this.dirty=!1)}}class rg extends Ai{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(n){const a=this.current;(n.func!==a.func||n.ref!==a.ref||n.mask!==a.mask||this.dirty)&&(this.gl.stencilFunc(n.func,n.ref,n.mask),this.current=n,this.dirty=!1)}}class yi extends Ai{getDefault(){const n=this.gl;return[n.KEEP,n.KEEP,n.KEEP]}set(n){const a=this.current;(n[0]!==a[0]||n[1]!==a[1]||n[2]!==a[2]||this.dirty)&&(this.gl.stencilOp(n[0],n[1],n[2]),this.current=n,this.dirty=!1)}}class xh extends Ai{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const a=this.gl;n?a.enable(a.STENCIL_TEST):a.disable(a.STENCIL_TEST),this.current=n,this.dirty=!1}}class Dr extends Ai{getDefault(){return[0,1]}set(n){const a=this.current;(n[0]!==a[0]||n[1]!==a[1]||this.dirty)&&(this.gl.depthRange(n[0],n[1]),this.current=n,this.dirty=!1)}}class Ws extends Ai{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const a=this.gl;n?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),this.current=n,this.dirty=!1}}class Wf extends Ai{getDefault(){return this.gl.LESS}set(n){(n!==this.current||this.dirty)&&(this.gl.depthFunc(n),this.current=n,this.dirty=!1)}}class qf extends Ai{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const a=this.gl;n?a.enable(a.BLEND):a.disable(a.BLEND),this.current=n,this.dirty=!1}}class vh extends Ai{getDefault(){const n=this.gl;return[n.ONE,n.ZERO,n.ONE,n.ZERO]}set(n){const a=this.current;(n[0]!==a[0]||n[1]!==a[1]||n[2]!==a[2]||n[3]!==a[3]||this.dirty)&&(this.gl.blendFuncSeparate(n[0],n[1],n[2],n[3]),this.current=n,this.dirty=!1)}}class Hf extends Ai{getDefault(){return r.aA.transparent}set(n){const a=this.current;(n.r!==a.r||n.g!==a.g||n.b!==a.b||n.a!==a.a||this.dirty)&&(this.gl.blendColor(n.r,n.g,n.b,n.a),this.current=n,this.dirty=!1)}}class Zf extends Ai{getDefault(){return this.gl.FUNC_ADD}set(n){(n!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(n,n),this.current=n,this.dirty=!1)}}class $f extends Ai{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const a=this.gl;n?a.enable(a.CULL_FACE):a.disable(a.CULL_FACE),this.current=n,this.dirty=!1}}class Yf extends Ai{getDefault(){return this.gl.BACK}set(n){(n!==this.current||this.dirty)&&(this.gl.cullFace(n),this.current=n,this.dirty=!1)}}class Qf extends Ai{getDefault(){return this.gl.CCW}set(n){(n!==this.current||this.dirty)&&(this.gl.frontFace(n),this.current=n,this.dirty=!1)}}let kc=class extends Ai{getDefault(){return null}set(d){(d!==this.current||this.dirty)&&(this.gl.useProgram(d),this.current=d,this.dirty=!1)}};class ai extends Ai{getDefault(){return this.gl.TEXTURE0}set(n){(n!==this.current||this.dirty)&&(this.gl.activeTexture(n),this.current=n,this.dirty=!1)}}class bh extends Ai{getDefault(){const n=this.gl;return[0,0,n.drawingBufferWidth,n.drawingBufferHeight]}set(n){const a=this.current;(n[0]!==a[0]||n[1]!==a[1]||n[2]!==a[2]||n[3]!==a[3]||this.dirty)&&(this.gl.viewport(n[0],n[1],n[2],n[3]),this.current=n,this.dirty=!1)}}class Ro extends Ai{getDefault(){return null}set(n){if(n===this.current&&!this.dirty)return;const a=this.gl;a.bindFramebuffer(a.FRAMEBUFFER,n),this.current=n,this.dirty=!1}}class Xf extends Ai{getDefault(){return null}set(n){if(n===this.current&&!this.dirty)return;const a=this.gl;a.bindRenderbuffer(a.RENDERBUFFER,n),this.current=n,this.dirty=!1}}class Kf extends Ai{getDefault(){return null}set(n){if(n===this.current&&!this.dirty)return;const a=this.gl;a.bindTexture(a.TEXTURE_2D,n),this.current=n,this.dirty=!1}}class Jf extends Ai{getDefault(){return null}set(n){if(n===this.current&&!this.dirty)return;const a=this.gl;a.bindBuffer(a.ARRAY_BUFFER,n),this.current=n,this.dirty=!1}}class ep extends Ai{getDefault(){return null}set(n){const a=this.gl;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,n),this.current=n,this.dirty=!1}}class tp extends Ai{getDefault(){return null}set(n){this.gl&&(n!==this.current||this.dirty)&&(this.gl.bindVertexArray(n),this.current=n,this.dirty=!1)}}class ip extends Ai{getDefault(){return 4}set(n){if(n===this.current&&!this.dirty)return;const a=this.gl;a.pixelStorei(a.UNPACK_ALIGNMENT,n),this.current=n,this.dirty=!1}}class np extends Ai{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const a=this.gl;a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n),this.current=n,this.dirty=!1}}class rp extends Ai{getDefault(){return!1}set(n){if(n===this.current&&!this.dirty)return;const a=this.gl;a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,n),this.current=n,this.dirty=!1}}class Rc extends Ai{constructor(n,a){super(n),this.context=n,this.parent=a}getDefault(){return null}}class sg extends Rc{setDirty(){this.dirty=!0}set(n){if(n===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const a=this.gl;a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,n,0),this.current=n,this.dirty=!1}}class zc extends Rc{attachment(){return this.gl.DEPTH_ATTACHMENT}set(n){if(n===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const a=this.gl;a.framebufferRenderbuffer(a.FRAMEBUFFER,this.attachment(),a.RENDERBUFFER,n),this.current=n,this.dirty=!1}}class og extends Rc{attachment(){return this.gl.DEPTH_ATTACHMENT}set(n){if(n===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const a=this.gl;a.framebufferTexture2D(a.FRAMEBUFFER,this.attachment(),a.TEXTURE_2D,n,0),this.current=n,this.dirty=!1}}class ag extends zc{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}class lg{constructor(n,a,f,_,x){this.context=n,this.width=a,this.height=f;const w=this.framebuffer=n.gl.createFramebuffer();_&&(this.colorAttachment=new sg(n,w)),x&&(this.depthAttachmentType=x,this.depthAttachment=x==="renderbuffer"?new zc(n,w):new og(n,w))}destroy(){const n=this.context.gl;if(this.colorAttachment){const a=this.colorAttachment.get();a&&n.deleteTexture(a)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){const a=this.depthAttachment.get();a&&n.deleteRenderbuffer(a)}else{const a=this.depthAttachment.get();a&&n.deleteTexture(a)}n.deleteFramebuffer(this.framebuffer)}}class jt{constructor(n,a,f){this.func=n,this.mask=a,this.range=f}}jt.ReadOnly=!1,jt.ReadWrite=!0,jt.disabled=new jt(519,jt.ReadOnly,[0,1]);const wh=7680;class ei{constructor(n,a,f,_,x,w){this.test=n,this.ref=a,this.mask=f,this.fail=_,this.depthFail=x,this.pass=w}}ei.disabled=new ei({func:519,mask:0},0,0,wh,wh,wh);const Lc=771;class pi{constructor(n,a,f,_){this.blendFunction=n,this.blendColor=a,this.mask=f,this.blendEquation=_}}pi.Replace=[1,0,1,0],pi.disabled=new pi(pi.Replace,r.aA.transparent,[!1,!1,!1,!1]),pi.unblended=new pi(pi.Replace,r.aA.transparent,[!0,!0,!0,!0]),pi.alphaBlended=new pi([1,Lc,1,Lc],r.aA.transparent,[!0,!0,!0,!0]),pi.multiply=new pi([774,0,774,0],r.aA.transparent,[!0,!0,!0,!0]);const Th=1029,Mh=2305;class Yt{constructor(n,a,f){this.enable=n,this.mode=a,this.frontFace=f}}Yt.disabled=new Yt(!1,Th,Mh),Yt.backCCW=new Yt(!0,Th,Mh),Yt.backCW=new Yt(!0,Th,2304),Yt.frontCW=new Yt(!0,1028,2304),Yt.frontCCW=new Yt(!0,1028,Mh);class Ds{constructor(n,a){this.gl=n,this.clearColor=new Hr(this),this.clearDepth=new fs(this),this.clearStencil=new lr(this),this.colorMask=new ko(this),this.depthMask=new fl(this),this.stencilMask=new Pr(this),this.stencilFunc=new rg(this),this.stencilOp=new yi(this),this.stencilTest=new xh(this),this.depthRange=new Dr(this),this.depthTest=new Ws(this),this.depthFunc=new Wf(this),this.blend=new qf(this),this.blendFunc=new vh(this),this.blendColor=new Hf(this),this.blendEquation=new Zf(this),this.cullFace=new $f(this),this.cullFaceSide=new Yf(this),this.frontFace=new Qf(this),this.program=new kc(this),this.activeTexture=new ai(this),this.viewport=new bh(this),this.bindFramebuffer=new Ro(this),this.bindRenderbuffer=new Xf(this),this.bindTexture=new Kf(this),this.bindVertexBuffer=new Jf(this),this.bindElementBuffer=new ep(this),this.bindVertexArrayOES=new tp(this),this.pixelStoreUnpack=new ip(this),this.pixelStoreUnpackPremultiplyAlpha=new np(this),this.pixelStoreUnpackFlipY=new rp(this),this.options=a?{...a}:{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=n.getExtension("EXT_texture_filter_anisotropic")||n.getExtension("MOZ_EXT_texture_filter_anisotropic")||n.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=n.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=n.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=n.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=n.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=n.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=n.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=n.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=n.getParameter(n.MAX_TEXTURE_SIZE),this.maxPointSize=n.getParameter(n.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(n,a,f){return new tn(this,n,a,f)}createVertexBuffer(n,a,f,_,x){return new En(this,n,a,f,_,x)}createRenderbuffer(n,a,f){const _=this.gl,x=_.createRenderbuffer();return this.bindRenderbuffer.set(x),_.renderbufferStorage(_.RENDERBUFFER,n,a,f),this.bindRenderbuffer.set(null),x}createFramebuffer(n,a,f,_){return new lg(this,n,a,f,_)}clear({color:n,depth:a,stencil:f,colorMask:_}){const x=this.gl;let w=0;n&&(w|=x.COLOR_BUFFER_BIT,this.clearColor.set(n),this.colorMask.set(_||[!0,!0,!0,!0])),a!==void 0&&(w|=x.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(a),this.depthMask.set(!0)),f!==void 0&&(w|=x.STENCIL_BUFFER_BIT,this.clearStencil.set(f),this.stencilMask.set(255)),x.clear(w)}setCullFace(n){n.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(n.mode),this.frontFace.set(n.frontFace))}setDepthMode(n){n.func!==this.gl.ALWAYS||n.mask?(this.depthTest.set(!0),this.depthFunc.set(n.func),this.depthMask.set(n.mask),this.depthRange.set(n.range)):this.depthTest.set(!1)}setStencilMode(n){n.test.func!==this.gl.ALWAYS||n.mask?(this.stencilTest.set(!0),this.stencilMask.set(n.mask),this.stencilOp.set([n.fail,n.depthFail,n.pass]),this.stencilFunc.set({func:n.test.func,ref:n.ref,mask:n.test.mask})):this.stencilTest.set(!1)}setColorMode(n){k(n.blendFunction,pi.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(n.blendFunction),this.blendColor.set(n.blendColor),n.blendEquation?this.blendEquation.set(n.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(n.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}var cg=r.aB([{name:"a_index",type:"Int16",components:1}]);const zo=.15000000000000002;class sp{constructor(n,a,f,_){const x={width:f[0],height:f[1],data:null},w=n.gl;this.targetColorTexture=new r.T(n,x,w.RGBA,{useMipmap:!1}),this.backgroundColorTexture=new r.T(n,x,w.RGBA,{useMipmap:!1}),this.context=n,this.setParticleTextureDimension(a,_),this.lastInvalidatedAt=0}setParticleTextureDimension(n,a){if(this.particleTextureDimension===a)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const f=this.context.gl,_=a*a,x=new Uint8Array(4*_),w=.7692307692307692,S=r.aC(n.key);for(let z=0;z<x.length;z+=4){const O=w*(S()+zo),V=w*(S()+zo),U=255*O%1,H=255*V%1,q=U,Z=V-H/255,$=H;x[z+0]=Math.floor(255*(O-U/255)),x[z+1]=Math.floor(255*q),x[z+2]=Math.floor(255*Z),x[z+3]=Math.floor(255*$)}const C=new r.h({width:a,height:a},x);this.particleTexture0=new r.T(this.context,C,f.RGBA,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new r.T(this.context,C,f.RGBA,{premultiply:!1,useMipmap:!1});const D=new r.aD;D.reserve(_);for(let z=0;z<_;z++)D.emplaceBack(z);this.particleIndexBuffer=this.context.createVertexBuffer(D,cg.members,!0),this.particleSegment=r.aE.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=a}update(n){return!(this.lastInvalidatedAt<n&&(this.lastInvalidatedAt=r.f.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}const Oc={type:2,extent:r.Y,loadGeometry:()=>[[new r.P(0,0),new r.P(r.Y+1,0),new r.P(r.Y+1,r.Y+1),new r.P(0,r.Y+1),new r.P(0,0)]]};class ps{constructor(n,a,f,_,x){this.tileID=n,this.uid=r.aF(),this.uses=0,this.tileSize=a,this.tileZoom=f,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=x,_&&_.style&&(this._lastUpdatedBrightness=_.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",_&&_.transform&&(this.projection=_.transform.projection)}registerFadeDuration(n){const a=n+this.timeAdded;a<r.f.now()||this.fadeEndTime&&a<this.fadeEndTime||(this.fadeEndTime=a)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=r.av(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(n,a,f){if(this.unloadVectorData(),this.state="loaded",n){n.featureIndex&&(this.latestFeatureIndex=n.featureIndex,n.rawTileData?(this.latestRawTileData=n.rawTileData,this.latestFeatureIndex.rawTileData=n.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=n.collisionBoxArray,this.buckets=function(_,x){const w={};if(!x)return w;for(const S of _){const C=S.layerIds.map(D=>x.getLayer(D)).filter(Boolean);if(C.length!==0){S.layers=C,S.stateDependentLayerIds&&(S.stateDependentLayers=S.stateDependentLayerIds.map(D=>C.filter(z=>z.id===D)[0]));for(const D of C)w[D.fqid]=S}}return w}(n.buckets,a.style),this.hasSymbolBuckets=!1;for(const _ in this.buckets){const x=this.buckets[_];if(x instanceof r.aH){if(this.hasSymbolBuckets=!0,!f)break;x.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const _ in this.buckets){const x=this.buckets[_];if(x instanceof r.aH&&x.hasRTLText){this.hasRTLText=!0,r.aI();break}}this.queryPadding=0;for(const _ in this.buckets){const x=this.buckets[_],w=a.style.getOwnLayer(_);if(!w)continue;const S=w.queryRadius(x);this.queryPadding=Math.max(this.queryPadding,S)}n.imageAtlas&&(this.imageAtlas=n.imageAtlas),n.glyphAtlasImage&&(this.glyphAtlasImage=n.glyphAtlasImage),n.lineAtlas&&(this.lineAtlas=n.lineAtlas),this._lastUpdatedBrightness=n.brightness}else this.collisionBoxArray=new r.aG}unloadVectorData(){if(this.hasData()){for(const n in this.buckets)this.buckets[n].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}getBucket(n){return this.buckets[n.fqid]}upload(n){for(const _ in this.buckets){const x=this.buckets[_];x.uploadPending()&&x.upload(n)}const a=n.gl,f=this.imageAtlas;if(f&&!f.uploaded){const _=!!Object.keys(f.patternPositions).length;this.imageAtlasTexture=new r.T(n,f.image,a.RGBA,{useMipmap:_}),this.imageAtlas.uploaded=!0}this.glyphAtlasImage&&(this.glyphAtlasTexture=new r.T(n,this.glyphAtlasImage,a.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new r.T(n,this.lineAtlas.image,a.R8),this.lineAtlas.uploaded=!0)}prepare(n,a,f){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(n,this.imageAtlasTexture,f),!a||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const _=a.style.getBrightness();(this._lastUpdatedBrightness||_)&&(this._lastUpdatedBrightness&&_&&Math.abs(this._lastUpdatedBrightness-_)<.001||(this._lastUpdatedBrightness=_,this.updateBuckets(void 0,a)))}queryRenderedFeatures(n,a,f,_,x,w,S,C){return this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)?this.latestFeatureIndex.query({tileResult:_,pixelPosMatrix:S,transform:w,params:x,tileTransform:this.tileTransform},n,a,f):{}}querySourceFeatures(n,a){const f=this.latestFeatureIndex;if(!f||!f.rawTileData)return;const _=f.loadVTLayers(),x=a?a.sourceLayer:"",w=_._geojsonTileLayer||_[x];if(!w)return;const S=r.aJ(a&&a.filter),{z:C,x:D,y:z}=this.tileID.canonical,O={z:C,x:D,y:z};for(let V=0;V<w.length;V++){const U=w.feature(V);if(S.needGeometry){const Z=r.aK(U,!0);if(!S.filter(new r.N(this.tileID.overscaledZ),Z,this.tileID.canonical))continue}else if(!S.filter(new r.N(this.tileID.overscaledZ),U))continue;const H=f.getId(U,x),q=new r.aL(U,C,D,z,H);q.tile=O,n.push(q)}}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}bucketsLoaded(){for(const n in this.buckets)if(this.buckets[n].uploadPending())return!1;return!0}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(n){const a=this.expirationTime;if(n.cacheControl){const f=r.aM(n.cacheControl);f["max-age"]&&(this.expirationTime=Date.now()+1e3*f["max-age"])}else n.expires&&(this.expirationTime=new Date(n.expires).getTime());if(this.expirationTime){const f=Date.now();let _=!1;if(this.expirationTime>f)_=!1;else if(a)if(this.expirationTime<a)_=!0;else{const x=this.expirationTime-a;x?this.expirationTime=f+Math.max(x,3e4):_=!0}else _=!0;_?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}setFeatureState(n,a){this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData&&Object.keys(n).length!==0&&a&&this.updateBuckets(n,a)}updateBuckets(n,a){if(!this.latestFeatureIndex)return;const f=this.latestFeatureIndex.loadVTLayers(),_=a.style.listImages(),x=a.style.getBrightness();for(const w in this.buckets){if(!a.style.hasLayer(w))continue;const S=this.buckets[w],C=S.layers[0].sourceLayer||"_geojsonTileLayer",D=f[C];let z={};if(n&&(z=n[C],!D||!z||Object.keys(z).length===0))continue;if(S.update(z,D,_,this.imageAtlas&&this.imageAtlas.patternPositions||{},x),S instanceof r.aN||S instanceof r.aO){const V=a.style.getOwnSourceCache(S.layers[0].source);a._terrain&&a._terrain.enabled&&V&&S.programConfigurations.needsUpload&&a._terrain._clearRenderCacheForTile(V.id,this.tileID)}const O=a&&a.style&&a.style.getOwnLayer(w);O&&(this.queryPadding=Math.max(this.queryPadding,O.queryRadius(S)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<r.f.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(n){this.symbolFadeHoldUntil=r.f.now()+n}setTexture(n,a){const f=a.context,_=f.gl;this.texture=this.texture||a.getTileTexture(n.width),this.texture&&this.texture instanceof r.T?this.texture.update(n,{useMipmap:!0}):(this.texture=new r.T(f,n,_.RGBA,{useMipmap:!0}),this.texture.bind(_.LINEAR,_.CLAMP_TO_EDGE))}setDependencies(n,a){const f={};for(const _ of a)f[_]=!0;this.dependencies[n]=f}hasDependency(n,a){for(const f of n){const _=this.dependencies[f];if(_){for(const x of a)if(_[x])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(n,a){if(!a||a.name==="mercator"||this._tileDebugBuffer)return;const f=r.aP(Oc,this.tileID.canonical,this.tileTransform)[0],_=new r.aQ,x=new r.aR;for(let w=0;w<f.length;w++){const{x:S,y:C}=f[w];_.emplaceBack(S,C),x.emplaceBack(w)}x.emplaceBack(0),this._tileDebugIndexBuffer=n.createIndexBuffer(x),this._tileDebugBuffer=n.createVertexBuffer(_,r.aS.members),this._tileDebugSegments=r.aE.simpleSegment(0,0,_.length,x.length)}_makeTileBoundsBuffers(n,a){if(this._tileBoundsBuffer||!a||a.name==="mercator")return;const f=r.aP(Oc,this.tileID.canonical,this.tileTransform)[0];let _,x;if(this.isRaster){const w=function(S,C){const D=r.av(S,C),z=Math.pow(2,S.z);for(let Z=0;Z<dt;Z++)for(let $=0;$<dt;$++){const K=r.aw((S.x+($+bn($))/xt)/z),oe=r.ax((S.y+(Z+bn(Z))/xt)/z),se=C.project(K,oe),le=Z*dt+$;wi[2*le+0]=Math.round((se.x*D.scale-D.x)*r.Y),wi[2*le+1]=Math.round((se.y*D.scale-D.y)*r.Y)}Rt.fill(0),Qi.fill(0);for(let Z=2045;Z>=0;Z--){const $=4*Z,K=Xt[$+0],oe=Xt[$+1],se=Xt[$+2],le=Xt[$+3],Y=K+se>>1,ee=oe+le>>1,me=Y+ee-oe,fe=ee+K-Y,xe=oe*dt+K,ke=le*dt+se,ye=ee*dt+Y,Pe=Math.hypot((wi[2*xe+0]+wi[2*ke+0])/2-wi[2*ye+0],(wi[2*xe+1]+wi[2*ke+1])/2-wi[2*ye+1])>=16;Rt[ye]=Rt[ye]||(Pe?1:0),Z<1022&&(Rt[ye]=Rt[ye]||Rt[(oe+fe>>1)*dt+(K+me>>1)]||Rt[(le+fe>>1)*dt+(se+me>>1)])}const O=new r.ay,V=new r.az;let U=0;function H(Z,$){const K=$*dt+Z;return Qi[K]===0&&(O.emplaceBack(wi[2*K+0],wi[2*K+1],Z*r.Y/xt,$*r.Y/xt),Qi[K]=++U),Qi[K]-1}function q(Z,$,K,oe,se,le){const Y=Z+K>>1,ee=$+oe>>1;if(Math.abs(Z-se)+Math.abs($-le)>1&&Rt[ee*dt+Y])q(se,le,Z,$,Y,ee),q(K,oe,se,le,Y,ee);else{const me=H(Z,$),fe=H(K,oe),xe=H(se,le);V.emplaceBack(me,fe,xe)}}return q(0,0,xt,xt,xt,0),q(xt,xt,0,0,0,xt),{vertices:O,indices:V}}(this.tileID.canonical,a);_=w.vertices,x=w.indices}else{_=new r.ay,x=new r.az;for(const{x:S,y:C}of f)_.emplaceBack(S,C,0,0);const w=r.aT(_.int16,void 0,4);for(let S=0;S<w.length;S+=3)x.emplaceBack(w[S],w[S+1],w[S+2])}this._tileBoundsBuffer=n.createVertexBuffer(_,r.aU.members),this._tileBoundsIndexBuffer=n.createIndexBuffer(x),this._tileBoundsSegments=r.aE.simpleSegment(0,0,_.length,x.length)}_makeGlobeTileDebugBuffers(n,a){const f=a.projection;if(!f||f.name!=="globe"||a.freezeTileCoverage)return;const _=this.tileID.canonical,x=r.aV(_,a),w=r.aW(x),S=r.W(a.zoom);let C;S>0&&(C=r.a9.invert(new Float64Array(16),a.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(n,_,a,w,C,S),this._makeGlobeTileDebugTextBuffer(n,_,a,w,C,S)}_globePoint(n,a,f,_,x,w,S){let C=r.aX(n,a,f);if(w){const D=1<<f.z,z=r.a8(_.center.lng),O=r.ah(_.center.lat),V=(f.x+.5)/D-z;let U=0;V>.5?U=-1:V<-.5&&(U=1);let H=(n/r.Y+f.x)/D+U,q=(a/r.Y+f.y)/D;H=(H-z)*_._pixelsPerMercatorPixel+z,q=(q-O)*_._pixelsPerMercatorPixel+O;const Z=[H*_.worldSize,q*_.worldSize,0];r.Q.transformMat4(Z,Z,w),C=r.aY(C,Z,S)}return r.Q.transformMat4(C,C,x)}_makeGlobeTileDebugBorderBuffer(n,a,f,_,x,w){const S=new r.aQ,C=new r.aR,D=new r.aZ,z=(V,U,H,q,Z)=>{const $=(H-V)/(Z-1),K=(q-U)/(Z-1),oe=S.length;for(let se=0;se<Z;se++){const le=V+se*$,Y=U+se*K;S.emplaceBack(le,Y);const ee=this._globePoint(le,Y,a,f,_,x,w);D.emplaceBack(ee[0],ee[1],ee[2]),C.emplaceBack(oe+se)}},O=r.Y;z(0,0,O,0,16),z(O,0,O,O,16),z(O,O,0,O,16),z(0,O,0,0,16),this._tileDebugIndexBuffer=n.createIndexBuffer(C),this._tileDebugBuffer=n.createVertexBuffer(S,r.aS.members),this._globeTileDebugBorderBuffer=n.createVertexBuffer(D,r.a_.members),this._tileDebugSegments=r.aE.simpleSegment(0,0,S.length,C.length)}_makeGlobeTileDebugTextBuffer(n,a,f,_,x,w){const S=r.Y/4,C=new r.aQ,D=new r.az,z=new r.aZ,O=25;D.reserve(32),C.reserve(O),z.reserve(O);const V=(U,H)=>O*U+H;for(let U=0;U<O;U++){const H=U*S;for(let q=0;q<O;q++){const Z=q*S;C.emplaceBack(Z,H);const $=this._globePoint(Z,H,a,f,_,x,w);z.emplaceBack($[0],$[1],$[2])}}for(let U=0;U<4;U++)for(let H=0;H<4;H++){const q=V(U,H),Z=V(U,H+1),$=V(U+1,H),K=V(U+1,H+1);D.emplaceBack(q,Z,$),D.emplaceBack($,Z,K)}this._tileDebugTextIndexBuffer=n.createIndexBuffer(D),this._tileDebugTextBuffer=n.createVertexBuffer(C,r.aS.members),this._globeTileDebugTextBuffer=n.createVertexBuffer(z,r.a_.members),this._tileDebugTextSegments=r.aE.simpleSegment(0,0,O,32)}destroy(n=!1){for(const a in this.buckets)this.buckets[a].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!n&&this.texture&&this.texture instanceof r.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}const ft={vector:mt,raster:_t,"raster-dem":class extends _t{constructor(d,n,a,f){super(d,n,a,f),this.type="raster-dem",this.maxzoom=22,this._options=r.e({type:"raster-dem"},n),this.encoding=n.encoding||"mapbox"}loadTile(d,n){const a=this.map._requestManager.normalizeTileURL(d.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function f(_,x){_&&(d.state="errored",n(_)),x&&(d.dem=x,d.dem.onDeserialize(),d.needsHillshadePrepare=!0,d.needsDEMTextureUpload=!0,d.state="loaded",n(null))}d.request=r.d(this.map._requestManager.transformRequest(a,r.R.Tile),(function(_,x,w,S){if(delete d.request,d.aborted)d.state="unloaded",n(null);else if(_)d.state="errored",n(_);else if(x){this.map._refreshExpiredTiles&&d.setExpiryData({cacheControl:w,expires:S});const C=ImageBitmap&&x instanceof ImageBitmap&&r.an(),D=1-(x.width-r.ao(x.width))/2;D<1||d.neighboringTiles||(d.neighboringTiles=this._getNeighboringTiles(d.tileID));const z=C?x:r.f.getImageData(x,D),O={uid:d.uid,coord:d.tileID,source:this.id,scope:this.scope,rawImageData:z,encoding:this.encoding,padding:D};d.actor&&d.state!=="expired"||(d.actor=this.dispatcher.getActor(),d.actor.send("loadDEMTile",O,f.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(d){const n=d.canonical,a=Math.pow(2,n.z),f=(n.x-1+a)%a,_=n.x===0?d.wrap-1:d.wrap,x=(n.x+1+a)%a,w=n.x+1===a?d.wrap+1:d.wrap,S={};return S[new r.ap(d.overscaledZ,_,n.z,f,n.y).key]={backfilled:!1},S[new r.ap(d.overscaledZ,w,n.z,x,n.y).key]={backfilled:!1},n.y>0&&(S[new r.ap(d.overscaledZ,_,n.z,f,n.y-1).key]={backfilled:!1},S[new r.ap(d.overscaledZ,d.wrap,n.z,n.x,n.y-1).key]={backfilled:!1},S[new r.ap(d.overscaledZ,w,n.z,x,n.y-1).key]={backfilled:!1}),n.y+1<a&&(S[new r.ap(d.overscaledZ,_,n.z,f,n.y+1).key]={backfilled:!1},S[new r.ap(d.overscaledZ,d.wrap,n.z,n.x,n.y+1).key]={backfilled:!1},S[new r.ap(d.overscaledZ,w,n.z,x,n.y+1).key]={backfilled:!1}),S}},"raster-array":ut,geojson:class extends r.E{constructor(d,n,a,f){super(),this.id=d,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=a.getActor(),this.setEventedParent(f),this._data=n.data,this._options=r.e({},n),this._collectResourceTiming=n.collectResourceTiming,n.maxzoom!==void 0&&(this.maxzoom=n.maxzoom),n.minzoom!==void 0&&(this.minzoom=n.minzoom),n.type&&(this.type=n.type),n.attribution&&(this.attribution=n.attribution),this.promoteId=n.promoteId;const _=r.Y/this.tileSize;this.workerOptions=r.e({source:this.id,scope:this.scope,cluster:n.cluster||!1,geojsonVtOptions:{buffer:(n.buffer!==void 0?n.buffer:128)*_,tolerance:(n.tolerance!==void 0?n.tolerance:.375)*_,extent:r.Y,maxZoom:this.maxzoom,lineMetrics:n.lineMetrics||!1,generateId:n.generateId||!1},superclusterOptions:{maxZoom:n.clusterMaxZoom!==void 0?n.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,n.clusterMinPoints||2),extent:r.Y,radius:(n.clusterRadius!==void 0?n.clusterRadius:50)*_,log:!1,generateId:n.generateId||!1},clusterProperties:n.clusterProperties,filter:n.filter,dynamic:n.dynamic},n.workerOptions)}onAdd(d){this.map=d,this.setData(this._data)}setData(d){return this._data=d,this._updateWorkerData(),this}updateData(d){return this._options.dynamic?(this._data=d,this._updateWorkerData(!0),this):this.fire(new r.a(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")))}getClusterExpansionZoom(d,n){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:d,source:this.id,scope:this.scope},n),this}getClusterChildren(d,n){return this.actor.send("geojson.getClusterChildren",{clusterId:d,source:this.id,scope:this.scope},n),this}getClusterLeaves(d,n,a,f){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:d,limit:n,offset:a},f),this}_updateWorkerData(d=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new r.b("dataloading",{dataType:"source"})),this._loaded=!1;const n=r.e({append:d},this.workerOptions);n.scope=this.scope;const a=this._data;typeof a=="string"?(n.request=this.map._requestManager.transformRequest(r.f.resolveURL(a),r.R.Source),n.request.collectResourceTiming=this._collectResourceTiming):n.data=JSON.stringify(a),this._pendingLoad=this.actor.send(`${this.type}.loadData`,n,(f,_)=>{if(this._loaded=!0,this._pendingLoad=null,f)this.fire(new r.a(f));else{const x={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&_&&_.resourceTiming&&_.resourceTiming[this.id]&&(x.resourceTiming=_.resourceTiming[this.id]),this.fire(new r.b("data",x)),this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(d),this._coalesce=!1)})}loaded(){return this._loaded}loadTile(d,n){const a=d.actor?"reloadTile":"loadTile";d.actor=this.actor;const f={type:this.type,uid:d.uid,tileID:d.tileID,tileZoom:d.tileZoom,zoom:d.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,scope:this.scope,pixelRatio:r.f.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0};d.request=this.actor.send(a,f,(_,x)=>(delete d.request,d.destroy(),d.aborted?n(null):_?n(_):(d.loadVectorData(x,this.map.painter,a==="reloadTile"),n(null))),void 0,a==="loadTile")}abortTile(d){d.request&&(d.request.cancel(),delete d.request),d.aborted=!0}unloadTile(d){this.actor.send("removeTile",{uid:d.uid,type:this.type,source:this.id,scope:this.scope}),d.destroy()}onRemove(){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return r.e({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends r.as{constructor(d,n,a,f){super(d,n,a,f),this.roundZoom=!0,this.type="video",this.options=n}load(){this._loaded=!1;const d=this.options;this.urls=[];for(const n of d.urls)this.urls.push(this.map._requestManager.transformRequest(n,r.R.Source).url);r.at(this.urls,(n,a)=>{this._loaded=!0,n?this.fire(new r.a(n)):a&&(this.video=a,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(d){if(this.video){const n=this.video.seekable;d<n.start(0)||d>n.end(0)?this.fire(new r.a(new r.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${n.start(0)} and ${n.end(0)}-second mark.`))):this.video.currentTime=d}}getVideo(){return this.video}onAdd(d){this.map||(this.map=d,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const d=this.map.painter.context,n=d.gl;this.texture?this.video.paused||(this.texture.bind(n.LINEAR,n.CLAMP_TO_EDGE),n.texSubImage2D(n.TEXTURE_2D,0,0,0,n.RGBA,n.UNSIGNED_BYTE,this.video)):(this.texture=new r.T(d,this.video,n.RGBA),this.texture.bind(n.LINEAR,n.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(d)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:r.as,model:class extends r.E{constructor(d,n,a,f){super(),this.id=d,this.type="model",this.models=[],this._loaded=!1,this._options=n}load(){const d=[];for(const n in this._options.models){const a=this._options.models[n],f=r.l(this.map._requestManager.transformRequest(a.uri,r.R.Model).url).then(_=>{if(!_)return;const x=r.c(_),w=new r.M(n,a.position,a.orientation,x);w.computeBoundsAndApplyParent(),this.models.push(w)}).catch(_=>{this.fire(new r.a(new Error(`Could not load model ${n} from ${a.uri}: ${_.message}`)))});d.push(f)}return Promise.allSettled(d).then(()=>{this._loaded=!0,this.fire(new r.b("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(n=>{this.fire(new r.a(new Error(`Could not load models: ${n.message}`)))})}onAdd(d){this.map=d,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(d,n){}serialize(){return{type:"model"}}},"batched-model":class extends r.E{constructor(d,n,a,f){super(),this.type="batched-model",this.id=d,this.tileSize=512,this._options=n,this.tiles=this._options.tiles,this.maxzoom=n.maxzoom||19,this.minzoom=n.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=a,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(f)}onAdd(d){this.map=d,this.load()}load(d){this._loaded=!1,this.fire(new r.b("dataloading",{dataType:"source"}));const n=Array.isArray(this.map._language)?this.map._language.join():this.map._language,a=this.map._worldview;this._tileJSONRequest=ct(this._options,this.map._requestManager,n,a,(f,_)=>{this._tileJSONRequest=null,this._loaded=!0,f?(n&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${n}`),a&&a.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${a}`),this.fire(new r.a(f))):_&&(r.e(this,_),_.bounds&&(this.tileBounds=new at(_.bounds,this.minzoom,this.maxzoom)),r.am(_.tiles,this.map._requestManager._customAccessToken),this.fire(new r.b("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new r.b("data",{dataType:"source",sourceDataType:"content"}))),d&&d(f)})}hasTransition(){return!1}hasTile(d){return!this.tileBounds||this.tileBounds.contains(d.canonical)}loaded(){return this._loaded}loadTile(d,n){const a=this.map._requestManager.normalizeTileURL(d.tileID.canonical.url(this.tiles,this.scheme)),f={request:this.map._requestManager.transformRequest(a,r.R.Tile),data:void 0,uid:d.uid,tileID:d.tileID,tileZoom:d.tileZoom,zoom:d.tileID.overscaledZ,tileSize:this.tileSize*d.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:d.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0};if(d.actor&&d.state!=="expired")if(d.state==="loading")d.reloadCallback=n;else{if(d.buckets){const x=Object.values(d.buckets);for(const w of x)w.dirty=!0;return void(d.state="loaded")}d.request=d.actor.send("reloadTile",f,_.bind(this))}else d.actor=this.dispatcher.getActor(),d.request=d.actor.send("loadTile",f,_.bind(this),void 0,!0);function _(x,w){return d.aborted?n(null):x&&x.status!==404?n(x):(w&&(w.resourceTiming&&(d.resourceTiming=w.resourceTiming),this.map._refreshExpiredTiles&&d.setExpiryData(w),d.buckets={...d.buckets,...w.buckets},w.featureIndex&&(d.latestFeatureIndex=w.featureIndex)),d.state="loaded",void n(null))}}serialize(){return r.e({},this._options)}},canvas:class extends r.as{constructor(d,n,a,f){super(d,n,a,f),n.coordinates?Array.isArray(n.coordinates)&&n.coordinates.length===4&&!n.coordinates.some(_=>!Array.isArray(_)||_.length!==2||_.some(x=>typeof x!="number"))||this.fire(new r.a(new r.V(`sources.${d}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new r.a(new r.V(`sources.${d}`,null,'missing required property "coordinates"'))),n.animate&&typeof n.animate!="boolean"&&this.fire(new r.a(new r.V(`sources.${d}`,null,'optional "animate" property must be a boolean value'))),n.canvas?typeof n.canvas=="string"||n.canvas instanceof HTMLCanvasElement||this.fire(new r.a(new r.V(`sources.${d}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new r.a(new r.V(`sources.${d}`,null,'missing required property "canvas"'))),this.options=n,this.animate=n.animate===void 0||n.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new r.a(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(d){this.map=d,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let d=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,d=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,d=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const n=this.map.painter.context;this.texture?!d&&!this._playing||this.texture instanceof r.au||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new r.T(n,this.canvas,n.gl.RGBA,{premultiply:!0}),this._prepareData(n)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const d of[this.canvas.width,this.canvas.height])if(isNaN(d)||d<=0)return!0;return!1}},custom:class extends r.E{constructor(d,n,a,f){super(),this.id=d,this.type="custom",this._dataType="raster",this._dispatcher=a,this._implementation=n,this.setEventedParent(f),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new r.a(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new r.a(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new at(this._implementation.bounds,this.minzoom,this.maxzoom)),n.update=this._update.bind(this),n.clearTiles=this._clearTiles.bind(this),n.coveringTiles=this._coveringTiles.bind(this),r.e(this,r.af(n,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return r.af(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new r.b("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new r.b("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(d){this._map=d,this._loaded=!1,this.fire(new r.b("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(d),this.load()}onRemove(d){this._implementation.onRemove&&this._implementation.onRemove(d)}hasTile(d){if(this._implementation.hasTile){const{x:n,y:a,z:f}=d.canonical;return this._implementation.hasTile({x:n,y:a,z:f})}return!this.tileBounds||this.tileBounds.contains(d.canonical)}loadTile(d,n){const{x:a,y:f,z:_}=d.tileID.canonical,x=new AbortController;d.request=Promise.resolve(this._implementation.loadTile({x:a,y:f,z:_},{signal:x.signal})).then((function(w){return delete d.request,d.aborted?(d.state="unloaded",n(null)):w===void 0?(d.state="errored",n(null)):w===null?(this.loadTileData(d,{width:this.tileSize,height:this.tileSize,data:null}),d.state="loaded",n(null)):function(S){return S instanceof ImageData||S instanceof HTMLCanvasElement||S instanceof ImageBitmap||S instanceof HTMLImageElement}(w)?(this.loadTileData(d,w),d.state="loaded",void n(null)):(d.state="errored",n(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(w=>{w.code!==20&&(d.state="errored",n(w))}),d.request.cancel=()=>x.abort()}loadTileData(d,n){d.setTexture(n,this._map.painter)}unloadTile(d,n){if(d.texture&&d.texture instanceof r.T?(d.destroy(!0),d.texture&&d.texture instanceof r.T&&this._map.painter.saveTileTexture(d.texture)):d.destroy(),this._implementation.unloadTile){const{x:a,y:f,z:_}=d.tileID.canonical;this._implementation.unloadTile({x:a,y:f,z:_})}n()}abortTile(d,n){d.request&&d.request.cancel&&(d.request.cancel(),delete d.request),n()}hasTransition(){return!1}_coveringTiles(){return this._map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(d=>({x:d.canonical.x,y:d.canonical.y,z:d.canonical.z}))}_clearTiles(){const d=r.aj(this.id,this.scope);this._map.style.clearSource(d)}_update(){this.fire(new r.b("data",{dataType:"source",sourceDataType:"content"}))}}},Sh=function(d,n,a,f){const _=new ft[n.type](d,n,a,f);if(_.id!==d)throw new Error(`Expected Source id to be ${d} instead of ${_.id}`);return r.a$(["load","abort","unload","serialize","prepare"],_),_};function Eh(d,n){const a=r.a9.identity([]);return r.a9.scale(a,a,[.5*d.width,.5*-d.height,1]),r.a9.translate(a,a,[1,-1,0]),r.a9.multiply(a,a,d.calculateProjMatrix(n.toUnwrapped())),Float32Array.from(a)}function Si(d,n,a,f,_,x,w,S=!1){const C=d.tilesIn(f,w,S);C.sort(op);const D=[];for(const O of C)D.push({wrappedTileID:O.tile.tileID.wrapped().key,queryResults:O.tile.queryRenderedFeatures(n,a,d._state,O,_,x,Eh(d.transform,O.tile.tileID),S)});const z=function(O){const V={},U={};for(const H of O){const q=H.queryResults,Z=H.wrappedTileID,$=U[Z]=U[Z]||{};for(const K in q){const oe=q[K],se=$[K]=$[K]||{},le=V[K]=V[K]||[];for(const Y of oe)se[Y.featureIndex]||(se[Y.featureIndex]=!0,le.push(Y))}}return V}(D);for(const O in z)z[O].forEach(V=>{const U=V.feature,H=U.layer;H&&H.type!=="background"&&H.type!=="sky"&&H.type!=="slot"&&(U.source=H.source,H["source-layer"]&&(U.sourceLayer=H["source-layer"]),U.state=U.id!==void 0?d.getFeatureState(H["source-layer"],U.id):{})});return z}function kr(d,n){const a=d.getRenderableIds().map(x=>d.getTileByID(x)),f=[],_={};for(let x=0;x<a.length;x++){const w=a[x],S=w.tileID.canonical.key;_[S]||(_[S]=!0,w.querySourceFeatures(f,n))}return f}function op(d,n){const a=d.tileID,f=n.tileID;return a.overscaledZ-f.overscaledZ||a.canonical.y-f.canonical.y||a.wrap-f.wrap||a.canonical.x-f.canonical.x}class Fc extends ps{constructor(n,a,f,_,x){super(n,a,f,_,x),this._workQueue=[],this._fetchQueue=[],this._isHeaderLoaded=!1}setTexture(n,a){const f=a.context,_=f.gl;this.texture=this.texture||a.getTileTexture(n.width),this.texture&&this.texture instanceof r.T?this.texture.update(n,{useMipmap:!1,premultiply:!1}):this.texture=new r.T(f,n,_.RGBA,{useMipmap:!1,premultiply:!1})}flushQueues(){for(;this._workQueue.length;)this._workQueue.pop()();for(;this._fetchQueue.length;)this._fetchQueue.pop()()}fetchHeader(n=16384,a){const f=this._mrt=new r.b0(30),_=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(n-1)}});return this.entireBuffer=null,this.request=r.b1(_,(x,w,S,C)=>{if(x)a(x);else try{const D=f.getHeaderLength(w);if(D>n)return void(this.request=this.fetchHeader(D,a));f.parseHeader(w),this._isHeaderLoaded=!0;let z=0;for(const O of Object.values(f.layers))z=Math.max(z,O.dataIndex[O.dataIndex.length-1].last_byte);w.byteLength>=z&&(this.entireBuffer=w),a(null,this.entireBuffer||w,S,C)}catch(D){a(D)}}),this.request}fetchBand(n,a,f){const _=this._mrt;if(!this._isHeaderLoaded||!_)return void f(new Error("Tile header is not ready"));const x=this.actor;if(!x)return void f(new Error("Can't fetch tile band without an actor"));let w;const S=(O,V)=>{w.complete(O,V),O?f(O):(this.updateTextureDescriptor(n,a),f(null,this.textureDescriptor&&this.textureDescriptor.img))},C=(O,V)=>{if(O)return f(O);const U=x.send("decodeRasterArray",{buffer:V,task:w},S,void 0,!0);this._workQueue.push(()=>{U&&U.cancel(),w.cancel()})},D=_.getLayer(n);if(!D)return void f(new Error(`Unknown sourceLayer "${n}"`));if(D.hasDataForBand(a))return this.updateTextureDescriptor(n,a),void f(null,this.textureDescriptor?this.textureDescriptor.img:null);const z=D.getDataRange([a]);if(w=_.createDecodingTask(z),!w||w.tasks.length)if(this.flushQueues(),this.entireBuffer)C(null,this.entireBuffer.slice(z.firstByte,z.lastByte+1));else{const O=Object.assign({},this.requestParams,{headers:{Range:`bytes=${z.firstByte}-${z.lastByte}`}}),V=r.b1(O,C);this._fetchQueue.push(()=>{V.cancel(),w.cancel()})}else f(null)}updateNeeded(n,a){return(!this.textureDescriptor||this.textureDescriptor.band!==a||this.textureDescriptor.layer!==n)&&this.state!=="errored"}updateTextureDescriptor(n,a){if(!this._mrt)return;const f=this._mrt.getLayer(n);if(!f||!f.hasBand(a)||!f.hasDataForBand(a))return;const{bytes:_,tileSize:x,buffer:w,offset:S,scale:C}=f.getBandView(a),D=x+2*w,z={data:_,width:D,height:D},O=this.texture;O&&O instanceof r.T&&O.update(z,{useMipmap:!1,premultiply:!1}),this.textureDescriptor={layer:n,band:a,img:z,buffer:w,offset:S,tileSize:x,format:f.pixelFormat,mix:[C,256*C,65536*C,16777216*C]}}}class ap{constructor(n,a){this.max=n,this.onRemove=a,this.reset()}reset(){for(const n in this.data)for(const a of this.data[n])a.timeout&&clearTimeout(a.timeout),this.onRemove(a.value);return this.data={},this.order=[],this}add(n,a,f){const _=n.wrapped().key;this.data[_]===void 0&&(this.data[_]=[]);const x={value:a,timeout:void 0};if(f!==void 0&&(x.timeout=setTimeout(()=>{this.remove(n,x)},f)),this.data[_].push(x),this.order.push(_),this.order.length>this.max){const w=this._getAndRemoveByKey(this.order[0]);w&&this.onRemove(w)}return this}has(n){return n.wrapped().key in this.data}getAndRemove(n){return this.has(n)?this._getAndRemoveByKey(n.wrapped().key):null}_getAndRemoveByKey(n){const a=this.data[n].shift();return a.timeout&&clearTimeout(a.timeout),this.data[n].length===0&&delete this.data[n],this.order.splice(this.order.indexOf(n),1),a.value}getByKey(n){const a=this.data[n];return a?a[0].value:null}get(n){return this.has(n)?this.data[n.wrapped().key][0].value:null}remove(n,a){if(!this.has(n))return this;const f=n.wrapped().key,_=a===void 0?0:this.data[f].indexOf(a),x=this.data[f][_];return this.data[f].splice(_,1),x.timeout&&clearTimeout(x.timeout),this.data[f].length===0&&delete this.data[f],this.onRemove(x.value),this.order.splice(this.order.indexOf(f),1),this}setMaxSize(n){for(this.max=n;this.order.length>this.max;){const a=this._getAndRemoveByKey(this.order[0]);a&&this.onRemove(a)}return this}filter(n){const a=[];for(const f in this.data)for(const _ of this.data[f])n(_.value)||a.push(_);for(const f of a)this.remove(f.value.tileID,f)}}class ms extends r.E{constructor(n,a,f){super(),this.id=n,this._onlySymbols=f,a.on("data",_=>{_.dataType==="source"&&_.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&_.dataType==="source"&&_.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))}),a.on("error",()=>{this._sourceErrored=!0}),this._source=a,this._tiles={},this._cache=new ap(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=a.minTileCacheSize,this._maxTileCacheSize=a.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Ot,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(n){this.map=n,this._minTileCacheSize=this._minTileCacheSize===void 0&&n?n._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&n?n._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const n in this._tiles){const a=this._tiles[n];if(a.state!=="errored"&&(a.state!=="loaded"||!a.bucketsLoaded()))return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const n=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,n&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(n,a){return n.isSymbolTile=this._onlySymbols,n.isExtraShadowCaster=this._shadowCasterTiles[n.tileID.key],this._source.loadTile(n,a)}_unloadTile(n){if(this._source.unloadTile)return this._source.unloadTile(n,()=>{})}_abortTile(n){if(this._source.abortTile)return this._source.abortTile(n,()=>{})}serialize(){return this._source.serialize()}prepare(n){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const a in this._tiles){const f=this._tiles[a];f.upload(n),f.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return r.b2(this._tiles).map(n=>n.tileID).sort(xi).map(n=>n.key)}getRenderableIds(n,a){const f=[];for(const _ in this._tiles)this._isIdRenderable(+_,n,a)&&f.push(this._tiles[_]);return n?f.sort((_,x)=>{const w=_.tileID,S=x.tileID,C=new r.P(w.canonical.x,w.canonical.y)._rotate(this.transform.angle),D=new r.P(S.canonical.x,S.canonical.y)._rotate(this.transform.angle);return w.overscaledZ-S.overscaledZ||D.y-C.y||D.x-C.x}).map(_=>_.tileID.key):f.map(_=>_.tileID).sort(xi).map(_=>_.key)}hasRenderableParent(n){const a=this.findLoadedParent(n,0);return!!a&&this._isIdRenderable(a.tileID.key)}_isIdRenderable(n,a,f){return this._tiles[n]&&this._tiles[n].hasData()&&!this._coveredTiles[n]&&(a||!this._tiles[n].holdingForFade())&&(f||!this._shadowCasterTiles[n])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const n in this._tiles)this._tiles[n].state!=="errored"&&this._reloadTile(+n,"reloading")}}_reloadTile(n,a){const f=this._tiles[n];f&&(f.state!=="loading"&&(f.state=a),this._loadTile(f,this._tileLoaded.bind(this,f,n,a)))}_tileLoaded(n,a,f,_){if(_)if(n.state="errored",_.status!==404)this._source.fire(new r.a(_,{tile:n}));else{if(!(n.tileID.key in this._loadedParentTiles))return void this._source.fire(new r.b("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id}));if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const x=this.map.painter.terrain;this.update(this.transform,x.getScaledDemTileSize(),!0),x.resetTileLookupCache(this.id)}else this.update(this.transform)}else n.timeAdded=r.f.now(),f==="expired"&&(n.refreshedUponExpiration=!0),this._setTileReloadTimer(a,n),this._source.type==="raster-dem"&&n.dem&&this._backfillDEM(n),this._state.initializeTileState(n,this.map?this.map.painter:null),this._source.fire(new r.b("data",{dataType:"source",tile:n,coord:n.tileID,sourceCacheId:this.id}))}_backfillDEM(n){const a=this.getRenderableIds();for(let _=0;_<a.length;_++){const x=a[_];if(n.neighboringTiles&&n.neighboringTiles[x]){const w=this.getTileByID(x);f(n,w),f(w,n)}}function f(_,x){if(!_.dem||_.dem.borderReady)return;_.needsHillshadePrepare=!0,_.needsDEMTextureUpload=!0;let w=x.tileID.canonical.x-_.tileID.canonical.x;const S=x.tileID.canonical.y-_.tileID.canonical.y,C=Math.pow(2,_.tileID.canonical.z),D=x.tileID.key;w===0&&S===0||Math.abs(S)>1||(Math.abs(w)>1&&(Math.abs(w+C)===1?w+=C:Math.abs(w-C)===1&&(w-=C)),x.dem&&_.dem&&(_.dem.backfillBorder(x.dem,w,S),_.neighboringTiles&&_.neighboringTiles[D]&&(_.neighboringTiles[D].backfilled=!0)))}}getTile(n){return this.getTileByID(n.key)}getTileByID(n){return this._tiles[n]}_retainLoadedChildren(n,a,f,_){for(const x in this._tiles){let w=this._tiles[x];if(_[x]||!w.hasData()||w.tileID.overscaledZ<=a||w.tileID.overscaledZ>f)continue;let S=w.tileID;for(;w&&w.tileID.overscaledZ>a+1;){const D=w.tileID.scaledTo(w.tileID.overscaledZ-1);w=this._tiles[D.key],w&&w.hasData()&&(S=D)}let C=S;for(;C.overscaledZ>a;)if(C=C.scaledTo(C.overscaledZ-1),n[C.key]){_[S.key]=S;break}}}findLoadedParent(n,a){if(n.key in this._loadedParentTiles){const f=this._loadedParentTiles[n.key];return f&&f.tileID.overscaledZ>=a?f:null}for(let f=n.overscaledZ-1;f>=a;f--){const _=n.scaledTo(f),x=this._getLoadedTile(_);if(x)return x}}_getLoadedTile(n){const a=this._tiles[n.key];return a&&a.hasData()?a:this._cache.getByKey(this._source.reparseOverscaled?n.wrapped().key:n.canonical.key)}updateCacheSize(n,a){a=a||this._source.tileSize;const f=Math.ceil(n.width/a)+1,_=Math.ceil(n.height/a)+1,x=Math.floor(f*_*5),w=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,x):x,S=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,w):w;this._cache.setMaxSize(S)}handleWrapJump(n){const a=Math.round((n-(this._prevLng===void 0?n:this._prevLng))/360);if(this._prevLng=n,a){const f={};for(const _ in this._tiles){const x=this._tiles[_];x.tileID=x.tileID.unwrapTo(x.tileID.wrap+a),f[x.tileID.key]=x}this._tiles=f;for(const _ in this._timers)clearTimeout(this._timers[_]),delete this._timers[_];for(const _ in this._tiles)this._setTileReloadTimer(+_,this._tiles[_])}}update(n,a,f,_){if(this.transform=n,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!f)return;let x;if(this.updateCacheSize(n,a),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={},this.used||this.usedForTerrain)if(this._source.tileID)x=n.getVisibleUnwrappedCoordinates(this._source.tileID).map(C=>new r.ap(C.canonical.z,C.wrap,C.canonical.z,C.canonical.x,C.canonical.y));else if(this.tileCoverLift!==0){const C=n.clone();C.tileCoverLift=this.tileCoverLift,x=C.coveringTiles({tileSize:a||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!f,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.minzoom<=1&&n.projection.name==="globe"&&(x.push(new r.ap(1,0,1,0,0)),x.push(new r.ap(1,0,1,1,0)),x.push(new r.ap(1,0,1,0,1)),x.push(new r.ap(1,0,1,1,1)))}else x=n.coveringTiles({tileSize:a||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!f,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(x=x.filter(C=>this._source.hasTile(C)));else x=[];if(x.length>0&&this.castsShadows&&_&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!pl(this._source.type)){const C=n.coveringZoomLevel({tileSize:a||this._source.tileSize,roundZoom:this._source.roundZoom&&!f}),D=Math.min(C,this._source.maxzoom),z=n.extendTileCoverForShadows(x,_,D);for(const O of z)this._shadowCasterTiles[O.key]=!0,x.push(O)}const w=this._updateRetainedTiles(x);if(pl(this._source.type)&&x.length!==0){const C={},D={},z=Object.keys(w);for(const V of z){const U=w[V],H=this._tiles[V];if(!H||H.fadeEndTime&&H.fadeEndTime<=r.f.now())continue;const q=this.findLoadedParent(U,Math.max(U.overscaledZ-ms.maxOverzooming,this._source.minzoom));q&&(this._addTile(q.tileID),C[q.tileID.key]=q.tileID),D[V]=U}const O=x[x.length-1].overscaledZ;for(const V in this._tiles){const U=this._tiles[V];if(w[V]||!U.hasData())continue;let H=U.tileID;for(;H.overscaledZ>O;){H=H.scaledTo(H.overscaledZ-1);const q=this._tiles[H.key];if(q&&q.hasData()&&D[H.key]){w[V]=U.tileID;break}}}for(const V in C)w[V]||(this._coveredTiles[V]=!0,w[V]=C[V])}for(const C in w)this._tiles[C].clearFadeHold();const S=r.b3(this._tiles,w);for(const C of S){const D=this._tiles[C];D.hasSymbolBuckets&&!D.holdingForFade()?D.setHoldDuration(this.map._fadeDuration):D.hasSymbolBuckets&&!D.symbolFadeFinished()||this._removeTile(+C)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const n in this._tiles)this._tiles[n].holdingForFade()&&this._removeTile(+n)}_updateRetainedTiles(n){const a={};if(n.length===0)return a;const f={},_=n.reduce((D,z)=>Math.min(D,z.overscaledZ),1/0),x=n[0].overscaledZ,w=Math.max(x-ms.maxOverzooming,this._source.minzoom),S=Math.max(x+ms.maxUnderzooming,this._source.minzoom),C={};for(const D of n){const z=this._addTile(D);a[D.key]=D,z.hasData()||_<this._source.maxzoom&&(C[D.key]=D)}this._retainLoadedChildren(C,_,S,a);for(const D of n){let z=this._tiles[D.key];if(z.hasData())continue;if(D.canonical.z>=this._source.maxzoom){const V=D.children(this._source.maxzoom)[0],U=this.getTile(V);if(U&&U.hasData()){a[V.key]=V;continue}}else{const V=D.children(this._source.maxzoom);if(a[V[0].key]&&a[V[1].key]&&a[V[2].key]&&a[V[3].key])continue}let O=z.wasRequested();for(let V=D.overscaledZ-1;V>=w;--V){const U=D.scaledTo(V);if(f[U.key]||(f[U.key]=!0,z=this.getTile(U),!z&&O&&(z=this._addTile(U)),z&&(a[U.key]=U,O=z.wasRequested(),z.hasData())))break}}return a}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const n in this._tiles){const a=[];let f,_=this._tiles[n].tileID;for(;_.overscaledZ>0;){if(_.key in this._loadedParentTiles){f=this._loadedParentTiles[_.key];break}a.push(_.key);const x=_.scaledTo(_.overscaledZ-1);if(f=this._getLoadedTile(x),f)break;_=x}for(const x of a)this._loadedParentTiles[x]=f}}_addTile(n){let a=this._tiles[n.key];if(a)return a.isExtraShadowCaster!==!0||this._shadowCasterTiles[n.key]||this._reloadTile(n.key,"reloading"),a;a=this._cache.getAndRemove(n),a&&(this._setTileReloadTimer(n.key,a),a.tileID=n,this._state.initializeTileState(a,this.map?this.map.painter:null),this._cacheTimers[n.key]&&(clearTimeout(this._cacheTimers[n.key]),delete this._cacheTimers[n.key],this._setTileReloadTimer(n.key,a)));const f=!!a;if(!f){const _=this.map?this.map.painter:null,x=this._source.tileSize*n.overscaleFactor();a=this._source.type==="raster-array"?new Fc(n,x,this.transform.tileZoom,_,this._isRaster):new ps(n,x,this.transform.tileZoom,_,this._isRaster),this._loadTile(a,this._tileLoaded.bind(this,a,n.key,a.state))}return a?(a.uses++,this._tiles[n.key]=a,f||this._source.fire(new r.b("dataloading",{tile:a,coord:a.tileID,dataType:"source"})),a):null}_setTileReloadTimer(n,a){n in this._timers&&(clearTimeout(this._timers[n]),delete this._timers[n]);const f=a.getExpiryTimeout();f&&(this._timers[n]=setTimeout(()=>{this._reloadTile(n,"expired"),delete this._timers[n]},f))}_removeTile(n){const a=this._tiles[n];a&&(a.uses--,delete this._tiles[n],this._timers[n]&&(clearTimeout(this._timers[n]),delete this._timers[n]),a.uses>0||(a.hasData()&&a.state!=="reloading"||a.state==="empty"?this._cache.add(a.tileID,a,a.getExpiryTimeout()):(a.aborted=!0,this._abortTile(a),this._unloadTile(a))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const n in this._tiles)this._removeTile(+n);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(n,a,f){const _=[],x=this.transform;if(!x)return _;const w=x.projection.name==="globe",S=r.a8(x.center.lng);for(const C in this._tiles){const D=this._tiles[C];if(f&&D.clearQueryDebugViz(),D.holdingForFade())continue;let z;if(w){const O=D.tileID.canonical;if(O.z===0){const V=[Math.abs(r.ad(S,...qs(O,-1))-S),Math.abs(r.ad(S,...qs(O,1))-S)];z=[0,2*V.indexOf(Math.min(...V))-1]}else{const V=[Math.abs(r.ad(S,...qs(O,-1))-S),Math.abs(r.ad(S,...qs(O,0))-S),Math.abs(r.ad(S,...qs(O,1))-S)];z=[V.indexOf(Math.min(...V))-1]}}else z=[0];for(const O of z){const V=n.containsTile(D,x,a,O);V&&_.push(V)}}return _}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(n){return this._getRenderableCoordinates(n)}_getRenderableCoordinates(n,a){const f=this.getRenderableIds(n,a).map(x=>this._tiles[x].tileID),_=this.transform.projection.name==="globe";for(const x of f)x.projMatrix=this.transform.calculateProjMatrix(x.toUnwrapped()),x.expandedProjMatrix=_?this.transform.calculateProjMatrix(x.toUnwrapped(),!1,!0):x.projMatrix;return f}sortCoordinatesByDistance(n){const a=n.slice(),f=this.transform._camera.position,_=this.transform._camera.forward(),x={};for(const w of a){const S=1/(1<<w.canonical.z);x[w.key]=((w.canonical.x+.5)*S+w.wrap-f[0])*_[0]+((w.canonical.y+.5)*S-f[1])*_[1]-f[2]*_[2]}return a.sort((w,S)=>x[w.key]-x[S.key]),a}hasTransition(){if(this._source.hasTransition())return!0;if(pl(this._source.type))for(const n in this._tiles){const a=this._tiles[n];if(a.fadeEndTime!==void 0&&a.fadeEndTime>=r.f.now())return!0}return!1}setFeatureState(n,a,f){this._state.updateState(n=n||"_geojsonTileLayer",a,f)}removeFeatureState(n,a,f){this._state.removeFeatureState(n=n||"_geojsonTileLayer",a,f)}getFeatureState(n,a){return this._state.getState(n=n||"_geojsonTileLayer",a)}setDependencies(n,a,f){const _=this._tiles[n];_&&_.setDependencies(a,f)}reloadTilesForDependencies(n,a){for(const f in this._tiles)this._tiles[f].hasDependency(n,a)&&this._reloadTile(+f,"reloading");this._cache.filter(f=>!f.hasDependency(n,a))}_preloadTiles(n,a){if(!this._sourceLoaded){const C=()=>{this._sourceLoaded&&(this._source.off("data",C),this._preloadTiles(n,a))};return void this._source.on("data",C)}const f=new Map,_=Array.isArray(n)?n:[n],x=this.map.painter.terrain,w=this.usedForTerrain&&x?x.getScaledDemTileSize():this._source.tileSize;for(const C of _){const D=C.coveringTiles({tileSize:w,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const z of D)f.set(z.key,z);this.usedForTerrain&&C.updateElevation(!1)}const S=Array.from(f.values());r.b4(S,(C,D)=>{const z=new ps(C,this._source.tileSize*C.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(z,O=>{this._source.type==="raster-dem"&&z.dem&&this._backfillDEM(z),D(O,z)})},a)}}function xi(d,n){const a=Math.abs(2*d.wrap)-+(d.wrap<0),f=Math.abs(2*n.wrap)-+(n.wrap<0);return d.overscaledZ-n.overscaledZ||f-a||n.canonical.y-d.canonical.y||n.canonical.x-d.canonical.x}function pl(d){return d==="raster"||d==="image"||d==="video"||d==="custom"}function qs(d,n){const a=1<<d.z;return[d.x/a+n,(d.x+1)/a+n]}ms.maxOverzooming=10,ms.maxUnderzooming=3;class Ah{constructor(n){this.style=n,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const n=!1,a=!1;for(const f in this.style._mergedLayers){const _=this.style._mergedLayers[f];if(_.type==="fill-extrusion")this.layers.push({layer:_,visible:n,visibilityChanged:a});else if(_.type==="model"){const x=this.style.getLayerSource(_);x&&x.type==="batched-model"&&this.layers.push({layer:_,visible:n,visibilityChanged:a})}}}onNewFrame(n){this.layersGotHidden=!1;for(const a of this.layers){const f=a.layer;let _=!1;f.type==="fill-extrusion"?_=!f.isHidden(n)&&f.paint.get("fill-extrusion-opacity")>0:f.type==="model"&&(_=!f.isHidden(n)&&f.paint.get("model-opacity")>0),this.layersGotHidden=this.layersGotHidden||!_&&a.visible,a.visible=_}}updateZOffset(n,a){this.currentBuildingBuckets=[];for(const _ of this.layers){const x=_.layer,w=this.style.getLayerSourceCache(x);let S=1;x.type==="fill-extrusion"&&(S=_.visible?x.paint.get("fill-extrusion-vertical-scale"):0);let C=w?w.getTile(a):null;if(!C&&w&&a.canonical.z>w.getSource().minzoom){let D=a.scaledTo(Math.min(w.getSource().maxzoom,a.overscaledZ-1));for(;D.overscaledZ>=w.getSource().minzoom&&(C=w.getTile(D),!C&&D.overscaledZ!==0);)D=D.scaledTo(D.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:C?C.getBucket(x):null,tileID:C?C.tileID:a,verticalScale:S})}n.hasAnyZOffset=!1;let f=!1;for(let _=0;_<n.symbolInstances.length;_++){const x=n.symbolInstances.get(_),w=x.zOffset,S=this._getHeightAtTileOffset(a,x.tileAnchorX,x.tileAnchorY);x.zOffset=S!==Number.NEGATIVE_INFINITY?S:w,f||w===x.zOffset||(f=!0),n.hasAnyZOffset||x.zOffset===0||(n.hasAnyZOffset=!0)}f&&(n.zOffsetBuffersNeedUpload=!0,n.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(n,a,f,_){let x=a,w=f;if(n.canonical.z!==_.canonical.z){const S=_.canonical,C=1/(1<<n.canonical.z-S.z);x=(a+n.canonical.x*r.Y)*C-S.x*r.Y|0,w=(f+n.canonical.y*r.Y)*C-S.y*r.Y|0}return{tileX:x,tileY:w}}_getHeightAtTileOffset(n,a,f){let _,x;for(let w=0;w<this.layers.length;++w){if(this.layers[w].layer.type!=="fill-extrusion")continue;const{bucket:S,tileID:C,verticalScale:D}=this.currentBuildingBuckets[w];if(!S)continue;const{tileX:z,tileY:O}=this._mapCoordToOverlappingTile(n,a,f,C),V=S.getHeightAtTileCoord(z,O);V&&V.height!==void 0&&(V.hidden?_=V.height:x=Math.max(V.height*D,x||0))}if(x!==void 0)return x;for(let w=0;w<this.layers.length;++w){const S=this.layers[w];if(S.layer.type!=="model"||!S.visible)continue;const{bucket:C,tileID:D}=this.currentBuildingBuckets[w];if(!C)continue;const{tileX:z,tileY:O}=this._mapCoordToOverlappingTile(n,a,f,D),V=C.getHeightAtTileCoord(z,O);if(V&&!V.hidden)return V.height===void 0&&_!==void 0?Math.min(V.maxHeight,_)*V.verticalScale:V.height?V.height*V.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function Jr(d,n){const a={};for(const f in d)f!=="ref"&&(a[f]=d[f]);return r.b5.forEach(f=>{f in n&&(a[f]=n[f])}),a}function lp(d){d=d.slice();const n=Object.create(null);for(let a=0;a<d.length;a++)n[d[a].id]=d[a];for(let a=0;a<d.length;a++)"ref"in d[a]&&(d[a]=Jr(d[a],n[d[a].ref]));return d}const Di={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport"};function Bc(d,n,a){a.push({command:Di.addSource,args:[d,n[d]]})}function Ih(d,n,a){n.push({command:Di.removeSource,args:[d]}),a[d]=!0}function cp(d,n,a,f){Ih(d,a,f),Bc(d,n,a)}function Ch(d,n,a){let f;for(f in d[a])if(d[a].hasOwnProperty(f)&&f!=="data"&&!k(d[a][f],n[a][f]))return!1;for(f in n[a])if(n[a].hasOwnProperty(f)&&f!=="data"&&!k(d[a][f],n[a][f]))return!1;return!0}function Lo(d,n,a,f,_,x){let w;for(w in n=n||{},d=d||{})d.hasOwnProperty(w)&&(k(d[w],n[w])||a.push({command:x,args:[f,w,n[w],_]}));for(w in n)n.hasOwnProperty(w)&&!d.hasOwnProperty(w)&&(k(d[w],n[w])||a.push({command:x,args:[f,w,n[w],_]}))}function pa(d){return d.id}function ml(d,n){return d[n.id]=n,d}class Hs{constructor(n,a){this.reset(n,a)}reset(n,a){this.points=n||[],this._distances=[0];for(let f=1;f<this.points.length;f++)this._distances[f]=this._distances[f-1]+this.points[f].dist(this.points[f-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(a||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(n){if(this.points.length===1)return this.points[0];n=r.ad(n,0,1);let a=1,f=this._distances[a];const _=n*this.paddedLength+this.padding;for(;f<_&&a<this._distances.length;)f=this._distances[++a];const x=a-1,w=this._distances[x],S=f-w,C=S>0?(_-w)/S:0;return this.points[x].mult(1-C).add(this.points[a].mult(C))}}class Ph{constructor(n,a,f){const _=this.boxCells=[],x=this.circleCells=[];this.xCellCount=Math.ceil(n/f),this.yCellCount=Math.ceil(a/f);for(let w=0;w<this.xCellCount*this.yCellCount;w++)_.push([]),x.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=n,this.height=a,this.xScale=this.xCellCount/n,this.yScale=this.yCellCount/a,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(n,a,f,_,x){this._forEachCell(a,f,_,x,this._insertBoxCell,this.boxUid++),this.boxKeys.push(n),this.bboxes.push(a),this.bboxes.push(f),this.bboxes.push(_),this.bboxes.push(x)}insertCircle(n,a,f,_){this._forEachCell(a-_,f-_,a+_,f+_,this._insertCircleCell,this.circleUid++),this.circleKeys.push(n),this.circles.push(a),this.circles.push(f),this.circles.push(_)}_insertBoxCell(n,a,f,_,x,w){this.boxCells[x].push(w)}_insertCircleCell(n,a,f,_,x,w){this.circleCells[x].push(w)}_query(n,a,f,_,x,w){if(f<0||n>this.width||_<0||a>this.height)return!x&&[];const S=[];if(n<=0&&a<=0&&this.width<=f&&this.height<=_){if(x)return!0;for(let C=0;C<this.boxKeys.length;C++)S.push({key:this.boxKeys[C],x1:this.bboxes[4*C],y1:this.bboxes[4*C+1],x2:this.bboxes[4*C+2],y2:this.bboxes[4*C+3]});for(let C=0;C<this.circleKeys.length;C++){const D=this.circles[3*C],z=this.circles[3*C+1],O=this.circles[3*C+2];S.push({key:this.circleKeys[C],x1:D-O,y1:z-O,x2:D+O,y2:z+O})}return w?S.filter(w):S}return this._forEachCell(n,a,f,_,this._queryCell,S,{hitTest:x,seenUids:{box:{},circle:{}}},w),x?S.length>0:S}_queryCircle(n,a,f,_,x){const w=n-f,S=n+f,C=a-f,D=a+f;if(S<0||w>this.width||D<0||C>this.height)return!_&&[];const z=[];return this._forEachCell(w,C,S,D,this._queryCellCircle,z,{hitTest:_,circle:{x:n,y:a,radius:f},seenUids:{box:{},circle:{}}},x),_?z.length>0:z}query(n,a,f,_,x){return this._query(n,a,f,_,!1,x)}hitTest(n,a,f,_,x){return this._query(n,a,f,_,!0,x)}hitTestCircle(n,a,f,_){return this._queryCircle(n,a,f,!0,_)}_queryCell(n,a,f,_,x,w,S,C){const D=S.seenUids,z=this.boxCells[x];if(z!==null){const V=this.bboxes;for(const U of z)if(!D.box[U]){D.box[U]=!0;const H=4*U;if(n<=V[H+2]&&a<=V[H+3]&&f>=V[H+0]&&_>=V[H+1]&&(!C||C(this.boxKeys[U]))){if(S.hitTest)return w.push(!0),!0;w.push({key:this.boxKeys[U],x1:V[H],y1:V[H+1],x2:V[H+2],y2:V[H+3]})}}}const O=this.circleCells[x];if(O!==null){const V=this.circles;for(const U of O)if(!D.circle[U]){D.circle[U]=!0;const H=3*U;if(this._circleAndRectCollide(V[H],V[H+1],V[H+2],n,a,f,_)&&(!C||C(this.circleKeys[U]))){if(S.hitTest)return w.push(!0),!0;{const q=V[H],Z=V[H+1],$=V[H+2];w.push({key:this.circleKeys[U],x1:q-$,y1:Z-$,x2:q+$,y2:Z+$})}}}}}_queryCellCircle(n,a,f,_,x,w,S,C){const D=S.circle,z=S.seenUids,O=this.boxCells[x];if(O!==null){const U=this.bboxes;for(const H of O)if(!z.box[H]){z.box[H]=!0;const q=4*H;if(this._circleAndRectCollide(D.x,D.y,D.radius,U[q+0],U[q+1],U[q+2],U[q+3])&&(!C||C(this.boxKeys[H])))return w.push(!0),!0}}const V=this.circleCells[x];if(V!==null){const U=this.circles;for(const H of V)if(!z.circle[H]){z.circle[H]=!0;const q=3*H;if(this._circlesCollide(U[q],U[q+1],U[q+2],D.x,D.y,D.radius)&&(!C||C(this.circleKeys[H])))return w.push(!0),!0}}}_forEachCell(n,a,f,_,x,w,S,C){const D=this._convertToXCellCoord(n),z=this._convertToYCellCoord(a),O=this._convertToXCellCoord(f),V=this._convertToYCellCoord(_);for(let U=D;U<=O;U++)for(let H=z;H<=V;H++)if(x.call(this,n,a,f,_,this.xCellCount*H+U,w,S,C))return}_convertToXCellCoord(n){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(n*this.xScale)))}_convertToYCellCoord(n){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(n*this.yScale)))}_circlesCollide(n,a,f,_,x,w){const S=_-n,C=x-a,D=f+w;return D*D>S*S+C*C}_circleAndRectCollide(n,a,f,_,x,w,S){const C=(w-_)/2,D=Math.abs(n-(_+C));if(D>C+f)return!1;const z=(S-x)/2,O=Math.abs(a-(x+z));if(O>z+f)return!1;if(D<=C||O<=z)return!0;const V=D-C,U=O-z;return V*V+U*U<=f*f}}const wn={unknown:0,flipRequired:1,flipNotRequired:2},ho=Math.tan(85*Math.PI/180);function _l(d,n,a,f,_,x,w){const S=r.a9.create();if(a)if(x.name==="globe"){const C=r.b6(_,n);r.a9.multiply(S,S,C)}else{const C=r.b7.invert([],w);S[0]=C[0],S[1]=C[1],S[4]=C[2],S[5]=C[3],f||r.a9.rotateZ(S,S,_.angle)}else r.a9.multiply(S,_.labelPlaneMatrix,d);return S}function gl(d,n,a,f,_,x,w){const S=_l(d,n,a,f,_,x,w);return x.name==="globe"&&a||(S[2]=S[6]=S[10]=S[14]=0),S}function Zs(d,n,a,f,_,x,w){if(a){if(x.name==="globe"){const S=_l(d,n,a,f,_,x,w);return r.a9.invert(S,S),r.a9.multiply(S,d,S),S}{const S=r.a9.clone(d),C=r.a9.identity([]);return C[0]=w[0],C[1]=w[1],C[4]=w[2],C[5]=w[3],r.a9.multiply(S,S,C),f||r.a9.rotateZ(S,S,-_.angle),S}}return _.glCoordMatrix}function Zr(d,n,a,f){const _=[d,n,a,1];a?r.aa.transformMat4(_,_,f):kh(_,_,f);const x=_[3];return _[0]/=x,_[1]/=x,_[2]/=x,_}function Nc(d,n){return Math.min(.5+d/n*.5,1.5)}function Vc(d,n){const a=d[0]/d[3],f=d[1]/d[3];return a>=-n[0]&&a<=n[0]&&f>=-n[1]&&f<=n[1]}function Uc(d,n,a,f,_,x,w,S,C,D){const z=a.transform,O=f?d.textSizeData:d.iconSizeData,V=r.b8(O,a.transform.zoom),U=z.projection.name==="globe",H=[256/a.width*2+1,256/a.height*2+1],q=f?d.text.dynamicLayoutVertexArray:d.icon.dynamicLayoutVertexArray;q.clear();let Z=null;U&&(Z=f?d.text.globeExtVertexArray:d.icon.globeExtVertexArray);const $=d.lineVertexArray,K=f?d.text.placedSymbolArray:d.icon.placedSymbolArray,oe=a.transform.width/a.transform.height;let se,le=!1;for(let Y=0;Y<K.length;Y++){const ee=K.get(Y),{numGlyphs:me,writingMode:fe}=ee;if(fe!==r.b9.vertical||le||se===r.b9.horizontal||(le=!0),se=fe,(ee.hidden||fe===r.b9.vertical)&&!le){Fo(me,q);continue}le=!1;const xe=new r.P(ee.tileAnchorX,ee.tileAnchorY);let{x:ke,y:ye,z:Pe}=z.projection.projectTilePoint(xe.x,xe.y,D.canonical);if(C){const[gt,Et,zt]=C(xe);ke+=gt,ye+=Et,Pe+=zt}const ze=[ke,ye,Pe,1];if(r.aa.transformMat4(ze,ze,n),!Vc(ze,H)){Fo(me,q);continue}const ge=ze[3],Ae=Nc(a.transform.getCameraToCenterDistance(z.projection),ge),Ye=r.ba(O,V,ee),we=w?Ye/Ae:Ye*Ae,De=Zr(ke,ye,Pe,_);if(De[3]<=0){Fo(me,q);continue}let Re={};const ae=w?null:C,Ue=ma(ee,we,!1,S,n,_,x,d.glyphOffsetArray,$,q,Z,De,xe,Re,oe,ae,z.projection,D,w);le=Ue.useVertical,ae&&Ue.needsFlipping&&(Re={}),(Ue.notEnoughRoom||le||Ue.needsFlipping&&ma(ee,we,!0,S,n,_,x,d.glyphOffsetArray,$,q,Z,De,xe,Re,oe,ae,z.projection,D,w).notEnoughRoom)&&Fo(me,q)}f?(d.text.dynamicLayoutVertexBuffer.updateData(q),Z&&d.text.globeExtVertexBuffer&&d.text.globeExtVertexBuffer.updateData(Z)):(d.icon.dynamicLayoutVertexBuffer.updateData(q),Z&&d.icon.globeExtVertexBuffer&&d.icon.globeExtVertexBuffer.updateData(Z))}function yl(d,n,a,f,_,x,w,S,C,D,z,O,V,U,H,q){const{lineStartIndex:Z,glyphStartIndex:$,segment:K}=S,oe=$+S.numGlyphs,se=Z+S.lineLength,le=n.getoffsetX($),Y=n.getoffsetX(oe-1),ee=Oo(d*le,a,f,_,x,w,K,Z,se,C,D,z,O,V,!0,U,H,q);if(!ee)return null;const me=Oo(d*Y,a,f,_,x,w,K,Z,se,C,D,z,O,V,!0,U,H,q);return me?{first:ee,last:me}:null}function fo(d,n,a,f){return d===r.b9.horizontal&&Math.abs(f)>Math.abs(a)?{useVertical:!0}:d===r.b9.vertical?f>0?{needsFlipping:!0}:null:n!==wn.unknown&&function(_,x){return _===0||Math.abs(x/_)>ho}(a,f)?n===wn.flipRequired?{needsFlipping:!0}:null:a<0?{needsFlipping:!0}:null}function ma(d,n,a,f,_,x,w,S,C,D,z,O,V,U,H,q,Z,$,K){const oe=n/24,se=d.lineOffsetX*oe,le=d.lineOffsetY*oe,{lineStartIndex:Y,glyphStartIndex:ee,numGlyphs:me,segment:fe,writingMode:xe,flipState:ke}=d,ye=Y+d.lineLength,Pe=ze=>{if(z){const[we,De,Re]=ze.up,ae=D.length;r.bb(z,ae+0,we,De,Re),r.bb(z,ae+1,we,De,Re),r.bb(z,ae+2,we,De,Re),r.bb(z,ae+3,we,De,Re)}const[ge,Ae,Ye]=ze.point;r.bc(D,ge,Ae,Ye,ze.angle)};if(me>1){const ze=yl(oe,S,se,le,a,O,V,d,C,x,U,q,!1,Z,$,K);if(!ze)return{notEnoughRoom:!0};if(f&&!a){let[ge,Ae,Ye]=ze.first.point,[we,De,Re]=ze.last.point;[ge,Ae]=Zr(ge,Ae,Ye,w),[we,De]=Zr(we,De,Re,w);const ae=fo(xe,ke,(we-ge)*H,De-Ae);if(d.flipState=ae&&ae.needsFlipping?wn.flipRequired:wn.flipNotRequired,ae)return ae}Pe(ze.first);for(let ge=ee+1;ge<ee+me-1;ge++){const Ae=Oo(oe*S.getoffsetX(ge),se,le,a,O,V,fe,Y,ye,C,x,U,q,!1,!1,Z,$,K);if(!Ae)return D.length-=4*(ge-ee),{notEnoughRoom:!0};Pe(Ae)}Pe(ze.last)}else{if(f&&!a){const ge=Zr(V.x,V.y,0,_),Ae=Y+fe+1,Ye=new r.P(C.getx(Ae),C.gety(Ae)),we=Zr(Ye.x,Ye.y,0,_),De=we[3]>0?we:Dh(V,Ye,ge,1,_,void 0,Z,$.canonical),Re=fo(xe,ke,(De[0]-ge[0])*H,De[1]-ge[1]);if(d.flipState=Re&&Re.needsFlipping?wn.flipRequired:wn.flipNotRequired,Re)return Re}const ze=Oo(oe*S.getoffsetX(ee),se,le,a,O,V,fe,Y,ye,C,x,U,q,!1,!1,Z,$,K);if(!ze)return{notEnoughRoom:!0};Pe(ze)}return{}}function jc(d,n,a,f,_){const{x,y:w,z:S}=f.projectTilePoint(d.x,d.y,n);if(!_)return Zr(x,w,S,a);const[C,D,z]=_(d);return Zr(x+C,w+D,S+z,a)}function Dh(d,n,a,f,_,x,w,S){const C=jc(d.sub(n)._unit()._add(d),S,_,w,x);return r.Q.sub(C,a,C),r.Q.normalize(C,C),r.Q.scaleAndAdd(C,a,C,f)}function Oo(d,n,a,f,_,x,w,S,C,D,z,O,V,U,H,q,Z,$){const K=f?d-n:d+n;let oe=K>0?1:-1,se=0;f&&(oe*=-1,se=Math.PI),oe<0&&(se+=Math.PI);let le=S+w+(oe>0?0:1)|0,Y=_,ee=_,me=0,fe=0;const xe=Math.abs(K),ke=[],ye=[];let Pe=x,ze=Pe;const ge=()=>Dh(ze,Pe,ee,xe-me+1,z,V,q,Z.canonical);for(;me+fe<=xe;){if(le+=oe,le<S||le>=C)return null;if(ee=Y,ze=Pe,ke.push(ee),U&&ye.push(ze),Pe=new r.P(D.getx(le),D.gety(le)),Y=O[le],!Y){const Et=jc(Pe,Z.canonical,z,q,V);Y=Et[3]>0?O[le]=Et:ge()}me+=fe,fe=r.Q.distance(ee,Y)}H&&V&&(O[le]&&(Y=ge(),fe=r.Q.distance(ee,Y)),O[le]=Y);const Ae=(xe-me)/fe,Ye=Pe.sub(ze)._mult(Ae)._add(ze),we=r.Q.sub([],Y,ee),De=r.Q.scaleAndAdd([],ee,we,Ae);let Re=[0,0,1],ae=we[0],Ue=we[1];if($&&(Re=q.upVector(Z.canonical,Ye.x,Ye.y),Re[0]!==0||Re[1]!==0||Re[2]!==1)){const Et=[Re[2],0,-Re[0]],zt=r.Q.cross([],Re,Et);r.Q.normalize(Et,Et),r.Q.normalize(zt,zt),ae=r.Q.dot(we,Et),Ue=r.Q.dot(we,zt)}if(a){const Et=r.Q.cross([],Re,we);r.Q.normalize(Et,Et),r.Q.scaleAndAdd(De,De,Et,a*oe)}const gt=se+Math.atan2(Ue,ae);return ke.push(De),U&&ye.push(Ye),{point:De,angle:gt,path:ke,tilePath:ye,up:Re}}function Fo(d,n){const a=n.length,f=a+4*d;n.resize(f),n.float32.fill(-1/0,4*a,4*f)}function kh(d,n,a){const f=n[0],_=n[1];return d[0]=a[0]*f+a[4]*_+a[12],d[1]=a[1]*f+a[5]*_+a[13],d[3]=a[3]*f+a[7]*_+a[15],d}const _s=100;class up{constructor(n,a,f=new Ph(n.width+200,n.height+200,25),_=new Ph(n.width+200,n.height+200,25)){this.transform=n,this.grid=f,this.ignoredGrid=_,this.pitchfactor=Math.cos(n._pitch)*n.cameraToCenterDistance,this.screenRightBoundary=n.width+_s,this.screenBottomBoundary=n.height+_s,this.gridRightBoundary=n.width+200,this.gridBottomBoundary=n.height+200,this.fogState=a}placeCollisionBox(n,a,f,_,x,w,S,C){let D=f.projectedAnchorX,z=f.projectedAnchorY,O=f.projectedAnchorZ;const V=f.elevation,U=f.tileID,H=n.getProjection();if(V&&U){const[Y,ee,me]=H.upVector(U.canonical,f.tileAnchorX,f.tileAnchorY),fe=H.upVectorScale(U.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;D+=Y*V*fe,z+=ee*V*fe,O+=me*V*fe}const q=this.projectAndGetPerspectiveRatio(S,D,z,O,f.tileID,H.name==="globe"||!!V||this.transform.pitch>0,H),Z=w*q.perspectiveRatio,$=(f.x1*a+_.x-f.padding)*Z+q.point.x,K=(f.y1*a+_.y-f.padding)*Z+q.point.y,oe=(f.x2*a+_.x+f.padding)*Z+q.point.x,se=(f.y2*a+_.y+f.padding)*Z+q.point.y,le=q.perspectiveRatio<=.55||q.occluded;return!this.isInsideGrid($,K,oe,se)||!x&&this.grid.hitTest($,K,oe,se,C)||le?{box:[],offscreen:!1,occluded:q.occluded}:{box:[$,K,oe,se],offscreen:this.isOffscreen($,K,oe,se),occluded:!1}}placeCollisionCircles(n,a,f,_,x,w,S,C,D,z,O,V,U,H,q){const Z=[],$=this.transform.elevation,K=n.getProjection(),oe=$?$.getAtTileOffsetFunc(q,this.transform.center.lat,this.transform.worldSize,K):null,se=new r.P(f.tileAnchorX,f.tileAnchorY);let{x:le,y:Y,z:ee}=K.projectTilePoint(se.x,se.y,q.canonical);if(oe){const[Ye,we,De]=oe(se);le+=Ye,Y+=we,ee+=De}const me=K.name==="globe",fe=this.projectAndGetPerspectiveRatio(S,le,Y,ee,q,me||!!$||this.transform.pitch>0,K),{perspectiveRatio:xe}=fe,ke=(O?w/xe:w*xe)/r.bf,ye=Zr(le,Y,ee,C),Pe=fe.signedDistanceFromCamera>0?yl(ke,x,f.lineOffsetX*ke,f.lineOffsetY*ke,!1,ye,se,f,_,C,{},$&&!O?oe:null,O&&!!$,K,q,O):null;let ze=!1,ge=!1,Ae=!0;if(Pe&&!fe.occluded){const Ye=.5*U*xe+H,we=new r.P(-100,-100),De=new r.P(this.screenRightBoundary,this.screenBottomBoundary),Re=new Hs,{first:ae,last:Ue}=Pe,gt=ae.path.length;let Et=[];for(let Ut=gt-1;Ut>=1;Ut--)Et.push(ae.path[Ut]);for(let Ut=1;Ut<Ue.path.length;Ut++)Et.push(Ue.path[Ut]);const zt=2.5*Ye;D&&(Et=Et.map(([Ut,vi,Jt],Ti)=>(oe&&!me&&(Jt=oe(Ti<gt-1?ae.tilePath[gt-1-Ti]:Ue.tilePath[Ti-gt+2])[2]),Zr(Ut,vi,Jt,D))),Et.some(Ut=>Ut[3]<=0)&&(Et=[]));let Pt=[];if(Et.length>0){let Ut=1/0,vi=-1/0,Jt=1/0,Ti=-1/0;for(const bi of Et)Ut=Math.min(Ut,bi[0]),Jt=Math.min(Jt,bi[1]),vi=Math.max(vi,bi[0]),Ti=Math.max(Ti,bi[1]);vi>=we.x&&Ut<=De.x&&Ti>=we.y&&Jt<=De.y&&(Pt=[Et.map(bi=>new r.P(bi[0],bi[1]))],(Ut<we.x||vi>De.x||Jt<we.y||Ti>De.y)&&(Pt=r.bd(Pt,we.x,we.y,De.x,De.y)))}for(const Ut of Pt){Re.reset(Ut,.25*Ye);let vi=0;vi=Re.length<=.5*Ye?1:Math.ceil(Re.paddedLength/zt)+1;for(let Jt=0;Jt<vi;Jt++){const Ti=Jt/Math.max(vi-1,1),bi=Re.lerp(Ti),hn=bi.x+_s,Ni=bi.y+_s;Z.push(hn,Ni,Ye,0);const Gn=hn-Ye,Dn=Ni-Ye,Xi=hn+Ye,Gi=Ni+Ye;if(Ae=Ae&&this.isOffscreen(Gn,Dn,Xi,Gi),ge=ge||this.isInsideGrid(Gn,Dn,Xi,Gi),!a&&this.grid.hitTestCircle(hn,Ni,Ye,V)&&(ze=!0,!z))return{circles:[],offscreen:!1,collisionDetected:ze,occluded:!1}}}}return{circles:!z&&ze||!ge?[]:Z,offscreen:Ae,collisionDetected:ze,occluded:fe.occluded}}queryRenderedSymbols(n){if(n.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const a=[];let f=1/0,_=1/0,x=-1/0,w=-1/0;for(const z of n){const O=new r.P(z.x+_s,z.y+_s);f=Math.min(f,O.x),_=Math.min(_,O.y),x=Math.max(x,O.x),w=Math.max(w,O.y),a.push(O)}const S=this.grid.query(f,_,x,w).concat(this.ignoredGrid.query(f,_,x,w)),C={},D={};for(const z of S){const O=z.key;if(C[O.bucketInstanceId]===void 0&&(C[O.bucketInstanceId]={}),C[O.bucketInstanceId][O.featureIndex])continue;const V=[new r.P(z.x1,z.y1),new r.P(z.x2,z.y1),new r.P(z.x2,z.y2),new r.P(z.x1,z.y2)];r.be(a,V)&&(C[O.bucketInstanceId][O.featureIndex]=!0,D[O.bucketInstanceId]===void 0&&(D[O.bucketInstanceId]=[]),D[O.bucketInstanceId].push(O.featureIndex))}return D}insertCollisionBox(n,a,f,_,x){(a?this.ignoredGrid:this.grid).insert({bucketInstanceId:f,featureIndex:_,collisionGroupID:x},n[0],n[1],n[2],n[3])}insertCollisionCircles(n,a,f,_,x){const w=a?this.ignoredGrid:this.grid,S={bucketInstanceId:f,featureIndex:_,collisionGroupID:x};for(let C=0;C<n.length;C+=4)w.insertCircle(S,n[C],n[C+1],n[C+2])}projectAndGetPerspectiveRatio(n,a,f,_,x,w,S){const C=[a,f,_,1];let D=!1;_||this.transform.pitch>0?(r.aa.transformMat4(C,C,n),this.fogState&&x&&S.name!=="globe"&&(D=function(V,U,H,q,Z,$){const K=$.calculateFogTileMatrix(Z),oe=[U,H,q];return r.Q.transformMat4(oe,oe,K),Oi(V,r.Q.length(oe),$.pitch,$._fov)}(this.fogState,a,f,_,x.toUnwrapped(),this.transform)>.9)):kh(C,C,n);const z=C[3];return{point:new r.P((C[0]/z+1)/2*this.transform.width+_s,(-C[1]/z+1)/2*this.transform.height+_s),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(S)/z*.5,1.5),signedDistanceFromCamera:z,occluded:w&&C[2]>z||D}}isOffscreen(n,a,f,_){return f<_s||n>=this.screenRightBoundary||_<_s||a>this.screenBottomBoundary}isInsideGrid(n,a,f,_){return f>=0&&n<this.gridRightBoundary&&_>=0&&a<this.gridBottomBoundary}getViewportMatrix(){const n=r.a9.identity([]);return r.a9.translate(n,n,[-100,-100,0]),n}}function Gc(d,n,a){const f=n.createTileMatrix(d,d.worldSize,a.toUnwrapped());return r.a9.multiply(new Float32Array(16),d.projMatrix,f)}function ks(d,n,a){if(n.projection.name===a.projection.name)return d.projMatrix;const f=a.clone();return f.setProjection(n.projection),Gc(f,n.getProjection(),d)}function Wc(d,n,a){return n.name===a.projection.name?d.projMatrix:Gc(a,n,d)}class qc{constructor(n,a,f,_){this.opacity=n?Math.max(0,Math.min(1,n.opacity+(n.placed?a:-a))):_&&f?1:0,this.placed=f}isHidden(){return this.opacity===0&&!this.placed}}class _a{constructor(n,a,f,_,x,w=!1){this.text=new qc(n?n.text:null,a,f,x),this.icon=new qc(n?n.icon:null,a,_,x),this.clipped=w}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Hc{constructor(n,a,f,_=!1){this.text=n,this.icon=a,this.skipFade=f,this.clipped=_}}class hp{constructor(){this.invProjMatrix=r.a9.create(),this.viewportMatrix=r.a9.create(),this.circles=[]}}class $s{constructor(n,a,f,_,x){this.bucketInstanceId=n,this.featureIndex=a,this.sourceLayerIndex=f,this.bucketIndex=_,this.tileID=x}}class Zc{constructor(n){this.crossSourceCollisions=n,this.maxGroupID=0,this.collisionGroups={}}get(n){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[n]){const a=++this.maxGroupID;this.collisionGroups[n]={ID:a,predicate:f=>f.collisionGroupID===a}}return this.collisionGroups[n]}}function Rh(d,n,a,f,_){const{horizontalAlign:x,verticalAlign:w}=r.bi(d),S=-(x-.5)*n,C=-(w-.5)*a,D=r.bh(d,f);return new r.P(S+D[0]*_,C+D[1]*_)}function ga(d,n,a,f,_){const x=new r.P(d,n);return a&&x._rotate(f?_:-_),x}class zh{constructor(n,a,f,_,x,w){this.transform=n.clone(),this.projection=n.projection.name,this.collisionIndex=new up(this.transform,x),this.buildingIndex=w,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=a,this.retainedQueryData={},this.collisionGroups=new Zc(f),this.collisionCircleArrays={},this.prevPlacement=_,_&&(_.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(n,a,f,_){const x=f.getBucket(a),w=f.latestFeatureIndex;if(!x||!w||a.fqid!==x.layerIds[0])return;const S=x.layers[0].layout,C=f.collisionBoxArray,D=Math.pow(2,this.transform.zoom-f.tileID.overscaledZ),z=f.tileSize/r.Y,O=f.tileID.toUnwrapped();this.transform.setProjection(x.projection);const V=(U=f.tileID,H=x.getProjection(),q=this.transform,H.name===this.projection?q.calculateProjMatrix(U.toUnwrapped()):Gc(q,H,U));var U,H,q;const Z=S.get("text-pitch-alignment")==="map",$=S.get("text-rotation-alignment")==="map";a.compileFilter();const K=a.dynamicFilter(),oe=a.dynamicFilterNeedsFeature(),se=this.transform.calculatePixelsToTileUnitsMatrix(f),le=gl(V,f.tileID.canonical,Z,$,this.transform,x.getProjection(),se);let Y=null;if(Z){const fe=Zs(V,f.tileID.canonical,Z,$,this.transform,x.getProjection(),se);Y=r.a9.multiply([],this.transform.labelPlaneMatrix,fe)}let ee=null;K&&f.latestFeatureIndex&&(ee={unwrappedTileID:O,dynamicFilter:K,dynamicFilterNeedsFeature:oe,featureIndex:f.latestFeatureIndex}),this.retainedQueryData[x.bucketInstanceId]=new $s(x.bucketInstanceId,w,x.sourceLayerIndex,x.index,f.tileID);const me={bucket:x,layout:S,posMatrix:V,textLabelPlaneMatrix:le,labelToScreenMatrix:Y,clippingData:ee,scale:D,textPixelRatio:z,holdingForFade:f.holdingForFade(),collisionBoxArray:C,partiallyEvaluatedTextSize:r.b8(x.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:r.b8(x.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(x.sourceID)};if(_)for(const fe of x.sortKeyRanges){const{sortKey:xe,symbolInstanceStart:ke,symbolInstanceEnd:ye}=fe;n.push({sortKey:xe,symbolInstanceStart:ke,symbolInstanceEnd:ye,parameters:me})}else n.push({symbolInstanceStart:0,symbolInstanceEnd:x.symbolInstances.length,parameters:me})}attemptAnchorPlacement(n,a,f,_,x,w,S,C,D,z,O,V,U,H,q,Z,$,K){const{textOffset0:oe,textOffset1:se,crossTileID:le}=V,Y=[oe,se],ee=Rh(n,f,_,Y,x),me=this.collisionIndex.placeCollisionBox(H,x,a,ga(ee.x,ee.y,w,S,this.transform.angle),O,C,D,z.predicate);if(Z){const fe=H.getSymbolInstanceIconSize(K,this.transform.zoom,V.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(H,fe,Z,ga(ee.x,ee.y,w,S,this.transform.angle),O,C,D,z.predicate).box.length===0)return}if(me.box.length>0){let fe;return this.prevPlacement&&this.prevPlacement.variableOffsets[le]&&this.prevPlacement.placements[le]&&this.prevPlacement.placements[le].text&&(fe=this.prevPlacement.variableOffsets[le].anchor),this.variableOffsets[le]={textOffset:Y,width:f,height:_,anchor:n,textScale:x,prevAnchor:fe},this.markUsedJustification(H,n,V,q),H.allowVerticalPlacement&&(this.markUsedOrientation(H,q,V),this.placedOrientations[le]=q),{shift:ee,placedGlyphBoxes:me}}}placeLayerBucketPart(n,a,f,_){const{bucket:x,layout:w,posMatrix:S,textLabelPlaneMatrix:C,labelToScreenMatrix:D,clippingData:z,textPixelRatio:O,holdingForFade:V,collisionBoxArray:U,partiallyEvaluatedTextSize:H,partiallyEvaluatedIconSize:q,collisionGroup:Z}=n.parameters,$=w.get("text-optional"),K=w.get("icon-optional"),oe=w.get("text-allow-overlap"),se=w.get("icon-allow-overlap"),le=w.get("text-rotation-alignment")==="map",Y=w.get("text-pitch-alignment")==="map",ee=w.get("symbol-z-order")==="viewport-y",me=w.get("symbol-z-elevate");this.transform.setProjection(x.projection);let fe=oe&&(se||!x.hasIconData()||K),xe=se&&(oe||!x.hasTextData()||$);!x.collisionArrays&&U&&x.deserializeCollisionBoxes(U),f&&_&&x.updateCollisionDebugBuffers(this.transform.zoom,U);const ke=(ye,Pe,ze)=>{const{crossTileID:ge,numVerticalGlyphVertices:Ae}=ye;if(z){const Xi={zoom:this.transform.zoom,pitch:this.transform.pitch};let Gi=null;if(z.dynamicFilterNeedsFeature){const li=this.retainedQueryData[x.bucketInstanceId];Gi=z.featureIndex.loadFeature({featureIndex:ye.featureIndex,bucketIndex:li.bucketIndex,sourceLayerIndex:li.sourceLayerIndex,layoutVertexArrayOffset:0})}if(!(0,z.dynamicFilter)(Xi,Gi,this.retainedQueryData[x.bucketInstanceId].tileID.canonical,new r.P(ye.tileAnchorX,ye.tileAnchorY),this.transform.calculateDistanceTileData(z.unwrappedTileID)))return this.placements[ge]=new Hc(!1,!1,!1,!0),void a.add(ge)}if(a.has(ge))return;if(V)return void(this.placements[ge]=new Hc(!1,!1,!1));let Ye=!1,we=!1,De=!0,Re=!1,ae=!1,Ue=null,gt={box:null,offscreen:null,occluded:null},Et={box:null,offscreen:null,occluded:null},zt=null,Pt=null,Ut=null,vi=0,Jt=0,Ti=0;ze.textFeatureIndex?vi=ze.textFeatureIndex:ye.useRuntimeCollisionCircles&&(vi=ye.featureIndex),ze.verticalTextFeatureIndex&&(Jt=ze.verticalTextFeatureIndex);const bi=Xi=>{Xi.tileID=this.retainedQueryData[x.bucketInstanceId].tileID;const Gi=this.transform.elevation;Xi.elevation=ye.zOffset+(Gi?Gi.getAtTileOffset(Xi.tileID,Xi.tileAnchorX,Xi.tileAnchorY):0)},hn=ze.textBox;if(hn){bi(hn);const Xi=li=>{let ui=r.b9.horizontal;if(x.allowVerticalPlacement&&!li&&this.prevPlacement){const rn=this.prevPlacement.placedOrientations[ge];rn&&(this.placedOrientations[ge]=rn,ui=rn,this.markUsedOrientation(x,ui,ye))}return ui},Gi=(li,ui)=>{if(x.allowVerticalPlacement&&Ae>0&&ze.verticalTextBox){for(const rn of x.writingModes)if(rn===r.b9.vertical?(gt=ui(),Et=gt):gt=li(),gt&&gt.box&&gt.box.length)break}else gt=li()};if(w.get("text-variable-anchor")){let li=w.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[ge]){const Ki=this.prevPlacement.variableOffsets[ge];li.indexOf(Ki.anchor)>0&&(li=li.filter(_i=>_i!==Ki.anchor),li.unshift(Ki.anchor))}const ui=(Ki,_i,ni)=>{const Rr=x.getSymbolInstanceTextSize(H,ye,this.transform.zoom,Pe),gr=(Ki.x2-Ki.x1)*Rr+2*Ki.padding,Qn=(Ki.y2-Ki.y1)*Rr+2*Ki.padding,yr=ye.hasIconTextFit&&!se?_i:null;yr&&bi(yr);let zr={box:[],offscreen:!1,occluded:!1};const Tr=oe?2*li.length:li.length;for(let Xn=0;Xn<Tr;++Xn){const cr=this.attemptAnchorPlacement(li[Xn%li.length],Ki,gr,Qn,Rr,le,Y,O,S,Z,Xn>=li.length,ye,Pe,x,ni,yr,H,q);if(cr&&(zr=cr.placedGlyphBoxes,zr&&zr.box&&zr.box.length)){Ye=!0,Ue=cr.shift;break}}return zr};Gi(()=>ui(hn,ze.iconBox,r.b9.horizontal),()=>{const Ki=ze.verticalTextBox;return Ki&&bi(Ki),x.allowVerticalPlacement&&!(gt&&gt.box&&gt.box.length)&&Ae>0&&Ki?ui(Ki,ze.verticalIconBox,r.b9.vertical):{box:null,offscreen:null,occluded:null}}),gt&&(Ye=gt.box,De=gt.offscreen,Re=gt.occluded);const rn=Xi(!(!gt||!gt.box));if(!Ye&&this.prevPlacement){const Ki=this.prevPlacement.variableOffsets[ge];Ki&&(this.variableOffsets[ge]=Ki,this.markUsedJustification(x,Ki.anchor,ye,rn))}}else{const li=(ui,rn)=>{const Ki=x.getSymbolInstanceTextSize(H,ye,this.transform.zoom,Pe),_i=this.collisionIndex.placeCollisionBox(x,Ki,ui,new r.P(0,0),oe,O,S,Z.predicate);return _i&&_i.box&&_i.box.length&&(this.markUsedOrientation(x,rn,ye),this.placedOrientations[ge]=rn),_i};Gi(()=>li(hn,r.b9.horizontal),()=>{const ui=ze.verticalTextBox;return x.allowVerticalPlacement&&Ae>0&&ui?(bi(ui),li(ui,r.b9.vertical)):{box:null,offscreen:null,occluded:null}}),Xi(!!(gt&&gt.box&&gt.box.length))}}if(zt=gt,Ye=zt&&zt.box&&zt.box.length>0,De=zt&&zt.offscreen,Re=zt&&zt.occluded,ye.useRuntimeCollisionCircles){const Xi=x.text.placedSymbolArray.get(ye.centerJustifiedTextSymbolIndex>=0?ye.centerJustifiedTextSymbolIndex:ye.verticalPlacedTextSymbolIndex),Gi=r.ba(x.textSizeData,H,Xi),li=w.get("text-padding");Pt=this.collisionIndex.placeCollisionCircles(x,oe,Xi,x.lineVertexArray,x.glyphOffsetArray,Gi,S,C,D,f,Y,Z.predicate,ye.collisionCircleDiameter*Gi/r.bf,li,this.retainedQueryData[x.bucketInstanceId].tileID),Ye=oe||Pt.circles.length>0&&!Pt.collisionDetected,De=De&&Pt.offscreen,Re=Pt.occluded}if(ze.iconFeatureIndex&&(Ti=ze.iconFeatureIndex),ze.iconBox){const Xi=Gi=>{bi(Gi);const li=ye.hasIconTextFit&&Ue?ga(Ue.x,Ue.y,le,Y,this.transform.angle):new r.P(0,0),ui=x.getSymbolInstanceIconSize(q,this.transform.zoom,ye.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(x,ui,Gi,li,se,O,S,Z.predicate)};Et&&Et.box&&Et.box.length&&ze.verticalIconBox?(Ut=Xi(ze.verticalIconBox),we=Ut.box.length>0):(Ut=Xi(ze.iconBox),we=Ut.box.length>0),De=De&&Ut.offscreen,ae=Ut.occluded}const Ni=$||ye.numHorizontalGlyphVertices===0&&Ae===0,Gn=K||ye.numIconVertices===0;if(Ni||Gn?Gn?Ni||(we=we&&Ye):Ye=we&&Ye:we=Ye=we&&Ye,Ye&&zt&&zt.box&&this.collisionIndex.insertCollisionBox(zt.box,w.get("text-ignore-placement"),x.bucketInstanceId,Et&&Et.box&&Jt?Jt:vi,Z.ID),we&&Ut&&this.collisionIndex.insertCollisionBox(Ut.box,w.get("icon-ignore-placement"),x.bucketInstanceId,Ti,Z.ID),Pt&&(Ye&&this.collisionIndex.insertCollisionCircles(Pt.circles,w.get("text-ignore-placement"),x.bucketInstanceId,vi,Z.ID),f)){const Xi=x.bucketInstanceId;let Gi=this.collisionCircleArrays[Xi];Gi===void 0&&(Gi=this.collisionCircleArrays[Xi]=new hp);for(let li=0;li<Pt.circles.length;li+=4)Gi.circles.push(Pt.circles[li+0]),Gi.circles.push(Pt.circles[li+1]),Gi.circles.push(Pt.circles[li+2]),Gi.circles.push(Pt.collisionDetected?1:0)}const Dn=x.projection.name!=="globe";fe=fe&&(Dn||!Re),xe=xe&&(Dn||!ae),this.placements[ge]=new Hc(Ye||fe,we||xe,De||x.justReloaded),a.add(ge)};if(me&&this.buildingIndex&&(this.buildingIndex.updateZOffset(x,this.retainedQueryData[x.bucketInstanceId].tileID),x.updateZOffset()),ee){const ye=x.getSortedSymbolIndexes(this.transform.angle);for(let Pe=ye.length-1;Pe>=0;--Pe){const ze=ye[Pe];ke(x.symbolInstances.get(ze),ze,x.collisionArrays[ze])}x.hasAnyZOffset&&r.w(`${x.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(x.hasAnyZOffset){const ye=x.getSortedIndexesByZOffset();for(let Pe=0;Pe<ye.length;++Pe){const ze=ye[Pe];ke(x.symbolInstances.get(ze),ze,x.collisionArrays[ze])}}else for(let ye=n.symbolInstanceStart;ye<n.symbolInstanceEnd;ye++)ke(x.symbolInstances.get(ye),ye,x.collisionArrays[ye]);if(f&&x.bucketInstanceId in this.collisionCircleArrays){const ye=this.collisionCircleArrays[x.bucketInstanceId];r.a9.invert(ye.invProjMatrix,S),ye.viewportMatrix=this.collisionIndex.getViewportMatrix()}x.justReloaded=!1}markUsedJustification(n,a,f,_){const{leftJustifiedTextSymbolIndex:x,centerJustifiedTextSymbolIndex:w,rightJustifiedTextSymbolIndex:S,verticalPlacedTextSymbolIndex:C,crossTileID:D}=f,z=r.bg(a),O=_===r.b9.vertical?C:z==="left"?x:z==="center"?w:z==="right"?S:-1;x>=0&&(n.text.placedSymbolArray.get(x).crossTileID=O>=0&&x!==O?0:D),w>=0&&(n.text.placedSymbolArray.get(w).crossTileID=O>=0&&w!==O?0:D),S>=0&&(n.text.placedSymbolArray.get(S).crossTileID=O>=0&&S!==O?0:D),C>=0&&(n.text.placedSymbolArray.get(C).crossTileID=O>=0&&C!==O?0:D)}markUsedOrientation(n,a,f){const _=a===r.b9.horizontal||a===r.b9.horizontalOnly?a:0,x=a===r.b9.vertical?a:0,{leftJustifiedTextSymbolIndex:w,centerJustifiedTextSymbolIndex:S,rightJustifiedTextSymbolIndex:C,verticalPlacedTextSymbolIndex:D}=f,z=n.text.placedSymbolArray;w>=0&&(z.get(w).placedOrientation=_),S>=0&&(z.get(S).placedOrientation=_),C>=0&&(z.get(C).placedOrientation=_),D>=0&&(z.get(D).placedOrientation=x)}commit(n){this.commitTime=n,this.zoomAtLastRecencyCheck=this.transform.zoom;const a=this.prevPlacement;let f=!1;this.prevZoomAdjustment=a?a.zoomAdjustment(this.transform.zoom):0;const _=a?a.symbolFadeChange(n):1,x=a?a.opacities:{},w=a?a.variableOffsets:{},S=a?a.placedOrientations:{};for(const C in this.placements){const D=this.placements[C],z=x[C];z?(this.opacities[C]=new _a(z,_,D.text,D.icon,null,D.clipped),f=f||D.text!==z.text.placed||D.icon!==z.icon.placed):(this.opacities[C]=new _a(null,_,D.text,D.icon,D.skipFade,D.clipped),f=f||D.text||D.icon)}for(const C in x){const D=x[C];if(!this.opacities[C]){const z=new _a(D,_,!1,!1);z.isHidden()||(this.opacities[C]=z,f=f||D.text.placed||D.icon.placed)}}for(const C in w)this.variableOffsets[C]||!this.opacities[C]||this.opacities[C].isHidden()||(this.variableOffsets[C]=w[C]);for(const C in S)this.placedOrientations[C]||!this.opacities[C]||this.opacities[C].isHidden()||(this.placedOrientations[C]=S[C]);f?this.lastPlacementChangeTime=n:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=a?a.lastPlacementChangeTime:n)}updateLayerOpacities(n,a){const f=new Set;for(const _ of a){const x=_.getBucket(n);x&&_.latestFeatureIndex&&n.fqid===x.layerIds[0]&&(this.updateBucketOpacities(x,f,_.collisionBoxArray),x.layers[0].layout.get("symbol-z-elevate")&&this.buildingIndex&&(this.buildingIndex.updateZOffset(x,_.tileID),x.updateZOffset()))}}updateBucketOpacities(n,a,f){n.hasTextData()&&n.text.opacityVertexArray.clear(),n.hasIconData()&&n.icon.opacityVertexArray.clear(),n.hasIconCollisionBoxData()&&n.iconCollisionBox.collisionVertexArray.clear(),n.hasTextCollisionBoxData()&&n.textCollisionBox.collisionVertexArray.clear();const _=n.layers[0].layout,x=!!n.layers[0].dynamicFilter(),w=new _a(null,0,!1,!1,!0),S=_.get("text-allow-overlap"),C=_.get("icon-allow-overlap"),D=_.get("text-variable-anchor"),z=_.get("text-rotation-alignment")==="map",O=_.get("text-pitch-alignment")==="map",V=new _a(null,0,S&&(C||!n.hasIconData()||_.get("icon-optional")),C&&(S||!n.hasTextData()||_.get("text-optional")),!0);!n.collisionArrays&&f&&(n.hasIconCollisionBoxData()||n.hasTextCollisionBoxData())&&n.deserializeCollisionBoxes(f);const U=(q,Z,$)=>{for(let K=0;K<Z/4;K++)q.opacityVertexArray.emplaceBack($)};let H=0;for(let q=0;q<n.symbolInstances.length;q++){const Z=n.symbolInstances.get(q),{numHorizontalGlyphVertices:$,numVerticalGlyphVertices:K,crossTileID:oe,numIconVertices:se}=Z,le=a.has(oe);let Y=this.opacities[oe];le?Y=w:Y||(Y=V,this.opacities[oe]=Y),a.add(oe);const ee=$>0||K>0,me=se>0,fe=this.placedOrientations[oe],xe=fe===r.b9.vertical,ke=fe===r.b9.horizontal||fe===r.b9.horizontalOnly;if(!ee&&!me||Y.isHidden()||H++,ee){const ye=Yc(Y.text);U(n.text,$,xe?xa:ye),U(n.text,K,ke?xa:ye);const Pe=Y.text.isHidden(),{leftJustifiedTextSymbolIndex:ze,centerJustifiedTextSymbolIndex:ge,rightJustifiedTextSymbolIndex:Ae,verticalPlacedTextSymbolIndex:Ye}=Z,we=n.text.placedSymbolArray,De=Pe||xe?1:0;ze>=0&&(we.get(ze).hidden=De),ge>=0&&(we.get(ge).hidden=De),Ae>=0&&(we.get(Ae).hidden=De),Ye>=0&&(we.get(Ye).hidden=Pe||ke?1:0);const Re=this.variableOffsets[oe];Re&&this.markUsedJustification(n,Re.anchor,Z,fe);const ae=this.placedOrientations[oe];ae&&(this.markUsedJustification(n,"left",Z,ae),this.markUsedOrientation(n,ae,Z))}if(me){const ye=Yc(Y.icon),{placedIconSymbolIndex:Pe,verticalPlacedIconSymbolIndex:ze}=Z,ge=n.icon.placedSymbolArray,Ae=Y.icon.isHidden()?1:0;Pe>=0&&(U(n.icon,se,xe?xa:ye),ge.get(Pe).hidden=Ae),ze>=0&&(U(n.icon,Z.numVerticalIconVertices,ke?xa:ye),ge.get(ze).hidden=Ae)}if(n.hasIconCollisionBoxData()||n.hasTextCollisionBoxData()){const ye=n.collisionArrays[q];if(ye){let Pe=new r.P(0,0),ze=!0;if(ye.textBox||ye.verticalTextBox){if(D){const Ae=this.variableOffsets[oe];Ae?(Pe=Rh(Ae.anchor,Ae.width,Ae.height,Ae.textOffset,Ae.textScale),z&&Pe._rotate(O?this.transform.angle:-this.transform.angle)):ze=!1}x&&(ze=!Y.clipped),ye.textBox&&Bo(n.textCollisionBox.collisionVertexArray,Y.text.placed,!ze||xe,Pe.x,Pe.y),ye.verticalTextBox&&Bo(n.textCollisionBox.collisionVertexArray,Y.text.placed,!ze||ke,Pe.x,Pe.y)}const ge=ze&&!!(!ke&&ye.verticalIconBox);ye.iconBox&&Bo(n.iconCollisionBox.collisionVertexArray,Y.icon.placed,ge,Z.hasIconTextFit?Pe.x:0,Z.hasIconTextFit?Pe.y:0),ye.verticalIconBox&&Bo(n.iconCollisionBox.collisionVertexArray,Y.icon.placed,!ge,Z.hasIconTextFit?Pe.x:0,Z.hasIconTextFit?Pe.y:0)}}}if(n.fullyClipped=H===0,n.sortFeatures(this.transform.angle),this.retainedQueryData[n.bucketInstanceId]&&(this.retainedQueryData[n.bucketInstanceId].featureSortOrder=n.featureSortOrder),n.hasTextData()&&n.text.opacityVertexBuffer&&n.text.opacityVertexBuffer.updateData(n.text.opacityVertexArray),n.hasIconData()&&n.icon.opacityVertexBuffer&&n.icon.opacityVertexBuffer.updateData(n.icon.opacityVertexArray),n.hasIconCollisionBoxData()&&n.iconCollisionBox.collisionVertexBuffer&&n.iconCollisionBox.collisionVertexBuffer.updateData(n.iconCollisionBox.collisionVertexArray),n.hasTextCollisionBoxData()&&n.textCollisionBox.collisionVertexBuffer&&n.textCollisionBox.collisionVertexBuffer.updateData(n.textCollisionBox.collisionVertexArray),n.bucketInstanceId in this.collisionCircleArrays){const q=this.collisionCircleArrays[n.bucketInstanceId];n.placementInvProjMatrix=q.invProjMatrix,n.placementViewportMatrix=q.viewportMatrix,n.collisionCircleArray=q.circles,delete this.collisionCircleArrays[n.bucketInstanceId]}}symbolFadeChange(n){return this.fadeDuration===0?1:(n-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(n){return Math.max(0,(this.transform.zoom-n)/1.5)}hasTransitions(n){return this.stale||n-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(n,a){const f=this.zoomAtLastRecencyCheck===a?1-this.zoomAdjustment(a):1;return this.zoomAtLastRecencyCheck=a,this.commitTime+this.fadeDuration*f>n}setStale(){this.stale=!0}}function Bo(d,n,a,f,_){d.emplaceBack(n?1:0,a?1:0,f||0,_||0),d.emplaceBack(n?1:0,a?1:0,f||0,_||0),d.emplaceBack(n?1:0,a?1:0,f||0,_||0),d.emplaceBack(n?1:0,a?1:0,f||0,_||0)}const xl=Math.pow(2,25),ya=Math.pow(2,24),Lh=Math.pow(2,17),dp=Math.pow(2,16),fp=Math.pow(2,9),pp=Math.pow(2,8),$c=Math.pow(2,1);function Yc(d){if(d.opacity===0&&!d.placed)return 0;if(d.opacity===1&&d.placed)return 4294967295;const n=d.placed?1:0,a=Math.floor(127*d.opacity);return a*xl+n*ya+a*Lh+n*dp+a*fp+n*pp+a*$c+n}const xa=0;class vl{constructor(n){this._sortAcrossTiles=n.layout.get("symbol-z-order")!=="viewport-y"&&n.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(n,a,f,_,x){const w=this._bucketParts;for(;this._currentTileIndex<n.length;)if(a.getBucketParts(w,_,n[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,x())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,w.sort((S,C)=>S.sortKey-C.sortKey));this._currentPartIndex<w.length;){const S=w[this._currentPartIndex];if(a.placeLayerBucketPart(S,this._seenCrossTileIDs,f,S.symbolInstanceStart===0),this._currentPartIndex++,x())return!0}return!1}}class bl{constructor(n,a,f,_,x,w,S,C,D){this.placement=new zh(n,x,w,S,C,D),this._currentPlacementIndex=a.length-1,this._forceFullPlacement=f,this._showCollisionBoxes=_,this._done=!1}isDone(){return this._done}continuePlacement(n,a,f,_){const x=r.f.now(),w=()=>{const S=r.f.now()-x;return!this._forceFullPlacement&&S>2};for(;this._currentPlacementIndex>=0;){const S=a[n[this._currentPlacementIndex]],C=this.placement.collisionIndex.transform.zoom;if(S.type==="symbol"&&(!S.minzoom||S.minzoom<=C)&&(!S.maxzoom||S.maxzoom>C)){const D=S,z=D.layout.get("symbol-z-elevate"),O=this._inProgressLayer=this._inProgressLayer||new vl(D),V=r.aj(S.source,S.scope);if(O.continuePlacement(z?_[V]:f[V],this.placement,this._showCollisionBoxes,S,w))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(n){return this.placement.commit(n),this.placement}}const Oh=512/r.Y/2;class mp{constructor(n,a,f){this.tileID=n,this.bucketInstanceId=f,this.index=new r.bj(a.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const _=n.canonical.x*r.Y,x=n.canonical.y*r.Y;for(let w=0;w<a.length;w++){const{key:S,crossTileID:C,tileAnchorX:D,tileAnchorY:z}=a.get(w),O=Math.floor((_+D)*Oh),V=Math.floor((x+z)*Oh);this.index.add(O,V),this.keys.push(S),this.crossTileIDs.push(C)}this.index.finish()}findMatches(n,a,f){const _=this.tileID.canonical.z<a.canonical.z?1:Math.pow(2,this.tileID.canonical.z-a.canonical.z),x=Oh/Math.pow(2,a.canonical.z-this.tileID.canonical.z),w=a.canonical.x*r.Y,S=a.canonical.y*r.Y;for(let C=0;C<n.length;C++){const D=n.get(C);if(D.crossTileID)continue;const{key:z,tileAnchorX:O,tileAnchorY:V}=D,U=Math.floor((w+O)*x),H=Math.floor((S+V)*x),q=this.index.range(U-_,H-_,U+_,H+_);for(const Z of q){const $=this.crossTileIDs[Z];if(this.keys[Z]===z&&!f.has($)){f.add($),D.crossTileID=$;break}}}}}class Qc{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class wl{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(n){const a=Math.round((n-this.lng)/360);if(a!==0)for(const f in this.indexes){const _=this.indexes[f],x={};for(const w in _){const S=_[w];S.tileID=S.tileID.unwrapTo(S.tileID.wrap+a),x[S.tileID.key]=S}this.indexes[f]=x}this.lng=n}addBucket(n,a,f){if(this.indexes[n.overscaledZ]&&this.indexes[n.overscaledZ][n.key]){if(this.indexes[n.overscaledZ][n.key].bucketInstanceId===a.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(n.overscaledZ,this.indexes[n.overscaledZ][n.key])}for(let x=0;x<a.symbolInstances.length;x++)a.symbolInstances.get(x).crossTileID=0;this.usedCrossTileIDs[n.overscaledZ]||(this.usedCrossTileIDs[n.overscaledZ]=new Set);const _=this.usedCrossTileIDs[n.overscaledZ];for(const x in this.indexes){const w=this.indexes[x];if(Number(x)>n.overscaledZ)for(const S in w){const C=w[S];C.tileID.isChildOf(n)&&C.findMatches(a.symbolInstances,n,_)}else{const S=w[n.scaledTo(Number(x)).key];S&&S.findMatches(a.symbolInstances,n,_)}}for(let x=0;x<a.symbolInstances.length;x++){const w=a.symbolInstances.get(x);w.crossTileID||(w.crossTileID=f.generate(),_.add(w.crossTileID))}return this.indexes[n.overscaledZ]===void 0&&(this.indexes[n.overscaledZ]={}),this.indexes[n.overscaledZ][n.key]=new mp(n,a.symbolInstances,a.bucketInstanceId),!0}removeBucketCrossTileIDs(n,a){for(const f of a.crossTileIDs)this.usedCrossTileIDs[n].delete(f)}removeStaleBuckets(n){let a=!1;for(const f in this.indexes){const _=this.indexes[f];for(const x in _)n[_[x].bucketInstanceId]||(this.removeBucketCrossTileIDs(f,_[x]),delete _[x],a=!0)}return a}}class Fh{constructor(){this.layerIndexes={},this.crossTileIDs=new Qc,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(n,a,f,_){let x=this.layerIndexes[n.fqid];x===void 0&&(x=this.layerIndexes[n.fqid]=new wl);let w=!1;const S={};_.name!=="globe"&&x.handleWrapJump(f);for(const C of a){const D=C.getBucket(n);D&&n.fqid===D.layerIds[0]&&(D.bucketInstanceId||(D.bucketInstanceId=++this.maxBucketInstanceId),x.addBucket(C.tileID,D,this.crossTileIDs)&&(w=!0),S[D.bucketInstanceId]=!0)}return x.removeStaleBuckets(S)&&(w=!0),w}pruneUnusedLayers(n){const a={};n.forEach(f=>{a[f]=!0});for(const f in this.layerIndexes)a[f]||delete this.layerIndexes[f]}}class Tl{constructor(n=0,a=0,f=0,_=0){if(isNaN(n)||n<0||isNaN(a)||a<0||isNaN(f)||f<0||isNaN(_)||_<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=n,this.bottom=a,this.left=f,this.right=_}interpolate(n,a,f){return a.top!=null&&n.top!=null&&(this.top=r.X(n.top,a.top,f)),a.bottom!=null&&n.bottom!=null&&(this.bottom=r.X(n.bottom,a.bottom,f)),a.left!=null&&n.left!=null&&(this.left=r.X(n.left,a.left,f)),a.right!=null&&n.right!=null&&(this.right=r.X(n.right,a.right,f)),this}getCenter(n,a){const f=r.ad((this.left+n-this.right)/2,0,n),_=r.ad((this.top+a-this.bottom)/2,0,a);return new r.P(f,_)}equals(n){return this.top===n.top&&this.bottom===n.bottom&&this.left===n.left&&this.right===n.right}clone(){return new Tl(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function Xc(d,n){const a=r.bn(d,3);r.a9.fromQuat(d,n),r.bp(d,3,a)}function Bh(d,n){const a=r.bl.identity([]);return r.bl.rotateZ(a,a,-n),r.bl.rotateX(a,a,-d),a}function gs(d,n){const a=[d[0],d[1],0],f=[n[0],n[1],0];if(r.Q.length(a)>=1e-15){const w=r.Q.normalize([],a);r.Q.scale(f,w,r.Q.dot(f,w)),n[0]=f[0],n[1]=f[1]}const _=r.Q.cross([],n,d);if(r.Q.len(_)<1e-15)return null;const x=Math.atan2(-_[1],_[0]);return Bh(Math.atan2(Math.sqrt(d[0]*d[0]+d[1]*d[1]),-d[2]),x)}class va{constructor(n,a){this.position=n,this.orientation=a}get position(){return this._position}set position(n){if(n){const a=n instanceof r.O?n:new r.O(n[0],n[1],n[2]);this._renderWorldCopies&&(a.x=r.bk(a.x,0,1)),this._position=a}else this._position=null}lookAtPoint(n,a){if(this.orientation=null,!this.position)return;const f=this.position,_=this._elevation?this._elevation.getAtPointOrZero(r.O.fromLngLat(n)):0,x=r.O.fromLngLat(n,_),w=[x.x-f.x,x.y-f.y,x.z-f.z];a||(a=[0,0,1]),a[2]=Math.abs(a[2]),this.orientation=gs(w,a)}setPitchBearing(n,a){this.orientation=Bh(r.bm(n),r.bm(-a))}}class Ml{constructor(n,a){this._transform=r.a9.identity([]),this.orientation=a,this.position=n}get mercatorPosition(){const n=this.position;return new r.O(n[0],n[1],n[2])}get position(){const n=r.bn(this._transform,3);return[n[0],n[1],n[2]]}set position(n){var a;n&&r.bp(this._transform,3,[(a=n)[0],a[1],a[2],1])}get orientation(){return this._orientation}set orientation(n){this._orientation=n||r.bl.identity([]),n&&Xc(this._transform,this._orientation)}getPitchBearing(){const n=this.forward(),a=this.right();return{bearing:Math.atan2(-a[1],a[0]),pitch:Math.atan2(Math.sqrt(n[0]*n[0]+n[1]*n[1]),-n[2])}}setPitchBearing(n,a){this._orientation=Bh(n,a),Xc(this._transform,this._orientation)}forward(){const n=r.bn(this._transform,2);return[-n[0],-n[1],-n[2]]}up(){const n=r.bn(this._transform,1);return[-n[0],-n[1],-n[2]]}right(){const n=r.bn(this._transform,0);return[n[0],n[1],n[2]]}getCameraToWorld(n,a){const f=new Float64Array(16);return r.a9.invert(f,this.getWorldToCamera(n,a)),f}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(n,a,f){const _=this.position;r.Q.scale(_,_,-n);const x=new Float64Array(16);return r.a9.fromScaling(x,[f,f,f]),r.a9.translate(x,x,_),x[10]*=a,x}getWorldToCamera(n,a){const f=new Float64Array(16),_=new Float64Array(4),x=this.position;return r.bl.conjugate(_,this._orientation),r.Q.scale(x,x,-n),r.a9.fromQuat(f,_),r.a9.translate(f,f,x),f[1]*=-1,f[5]*=-1,f[9]*=-1,f[13]*=-1,f[8]*=a,f[9]*=a,f[10]*=a,f[11]*=a,f}getCameraToClipPerspective(n,a,f,_){const x=new Float64Array(16);return r.a9.perspective(x,n,a,f,_),x}getCameraToClipOrthographic(n,a,f,_,x,w){const S=new Float64Array(16);return r.a9.ortho(S,n,a,f,_,x,w),S}getDistanceToElevation(n,a=!1){const f=n===0?0:r.bo(n,a?r.ax(this.position[1]):this.position[1]),_=this.forward();return(f-this.position[2])/_[2]}clone(){return new Ml([...this.position],[...this.orientation])}}const Nh=(d,n,a)=>(1-a)*d+a*n,ba=d=>d*d*d*d*d;class Kc{constructor(n,a,f,_,x,w,S){this.tileSize=512,this._renderWorldCopies=x===void 0||x,this._minZoom=n||0,this._maxZoom=a||22,this._minPitch=f??0,this._maxPitch=_??60,this.setProjection(w),this.setMaxBounds(S),this.width=0,this.height=0,this._center=new r.bq(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Tl,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new Ml,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1}clone(){const n=new Kc(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return n._elevation=this._elevation,n._centerAltitude=this._centerAltitude,n._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,n.tileSize=this.tileSize,n.mercatorFromTransition=this.mercatorFromTransition,n.width=this.width,n.height=this.height,n.cameraElevationReference=this.cameraElevationReference,n._center=this._center,n._setZoom(this.zoom),n._seaLevelZoom=this._seaLevelZoom,n.angle=this.angle,n._fov=this._fov,n._pitch=this._pitch,n._nearZ=this._nearZ,n._farZ=this._farZ,n._averageElevation=this._averageElevation,n._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,n._unmodified=this._unmodified,n._edgeInsets=this._edgeInsets.clone(),n._camera=this._camera.clone(),n._calcMatrices(),n.freezeTileCoverage=this.freezeTileCoverage,n.frustumCorners=this.frustumCorners,n}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(n){this._elevation!==n&&(this._elevation=n,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(n,a=!1){const f=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||f)&&this._updateCameraOnTerrain(),(n||f)&&this._constrainCamera(a),this._calcMatrices()}getProjection(){return r.af(this.projection,["name","center","parallels"])}setProjection(n){this.projectionOptions=n||{name:"mercator"};const a=this.projection?this.getProjection():void 0;this.projection=r.br(this.projectionOptions);const f=!k(a,this.getProjection());return f&&this._calcMatrices(),this.mercatorFromTransition=!1,f}setOrthographicProjectionAtLowPitch(n){return this._orthographicProjectionAtLowPitch!==n&&(this._orthographicProjectionAtLowPitch=n,this._calcMatrices(),!0)}setMercatorFromTransition(){const n=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=r.br({name:"mercator"});const a=n!==this.projection.name;return a&&this._calcMatrices(),a}get minZoom(){return this._minZoom}set minZoom(n){this._minZoom!==n&&(this._minZoom=n,this.zoom=Math.max(this.zoom,n))}get maxZoom(){return this._maxZoom}set maxZoom(n){this._maxZoom!==n&&(this._maxZoom=n,this.zoom=Math.min(this.zoom,n))}get minPitch(){return this._minPitch}set minPitch(n){this._minPitch!==n&&(this._minPitch=n,this.pitch=Math.max(this.pitch,n))}get maxPitch(){return this._maxPitch}set maxPitch(n){this._maxPitch!==n&&(this._maxPitch=n,this.pitch=Math.min(this.pitch,n))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(n){n===void 0?n=!0:n===null&&(n=!1),this._renderWorldCopies=n}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const n=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(n))}get cameraWorldSize(){const n=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(n))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return r.bo(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new r.P(this.width,this.height)}get bearing(){return r.bk(this.rotation,-180,180)}set bearing(n){this.rotation=n}get rotation(){return-this.angle/Math.PI*180}set rotation(n){const a=-n*Math.PI/180;this.angle!==a&&(this._unmodified=!1,this.angle=a,this._calcMatrices(),this.rotationMatrix=r.b7.create(),r.b7.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(n){const a=r.ad(n,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==a&&(this._unmodified=!1,this._pitch=a,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){const n=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/n)}set fov(n){n=Math.max(.01,Math.min(60,n)),this._fov!==n&&(this._unmodified=!1,this._fov=r.bm(n),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(n){this._averageElevation=n,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(n){const a=Math.min(Math.max(n,this.minZoom),this.maxZoom);this._zoom!==a&&(this._unmodified=!1,this._setZoom(a),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(n){this._zoom=n,this.scale=this.zoomScale(n),this.tileZoom=Math.floor(n),this.zoomFraction=n-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(n){this._tileCoverLift!==n&&(this._tileCoverLift=n)}_updateCameraOnTerrain(){const n=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,a=this.elevation&&n===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||n===Number.NEGATIVE_INFINITY&&(!a||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const f=this._elevation;a||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&f.exaggeration()&&this._centerAltitudeValidForExaggeration!==f.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*f.exaggeration(),this._centerAltitudeValidForExaggeration=f.exaggeration()):(this._centerAltitude=n||0,this._centerAltitudeValidForExaggeration=f.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){this._centerAltitudeValidForExaggeration!==void 0&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const n=this._elevation,a=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],f=this.horizonLineFromTop();let _=0,x=0;for(let w=0;w<a.length;w++){const S=new r.P(a[w][0]*this.width,f+a[w][1]*(this.height-f)),C=n.pointCoordinate(S);if(!C)continue;const D=1/Math.hypot(C[0]-this._camera.position[0],C[1]-this._camera.position[1]);_+=C[3]*D,x+=D}return x===0?NaN:_/x}get center(){return this._center}set center(n){n.lat===this._center.lat&&n.lng===this._center.lng||(this._unmodified=!1,this._center=n,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const n=this._seaLevelZoom,a=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),f=this.pixelsPerMeter/this.worldSize*a,_=this._mercatorZfromZoom(n),x=this._mercatorZfromZoom(this._maxZoom),w=Math.max(_-f,x);this._setZoom(this._zoomFromMercatorZ(w))}get padding(){return this._edgeInsets.toJSON()}set padding(n){this._edgeInsets.equals(n)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,n,1),this._calcMatrices())}computeZoomRelativeTo(n){const a=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,n.toAltitude()));let f;f=n.z<this._camera.position[2]?[a.x,a.y,a.z]:[n.x,n.y,n.z];const _=r.Q.length(r.Q.sub([],this._camera.position,f));return r.ad(this._zoomFromMercatorZ(_),this._minZoom,this._maxZoom)}setFreeCameraOptions(n){if(!this.height||!n.position&&!n.orientation)return;this._updateCameraState();let a=!1;if(n.orientation&&!r.bl.exactEquals(n.orientation,this._camera.orientation)&&(a=this._setCameraOrientation(n.orientation)),n.position){const f=[n.position.x,n.position.y,n.position.z];r.Q.exactEquals(f,this._camera.position)||(this._setCameraPosition(f),a=!0)}a&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const n=this._camera.position,a=new va;return a.position=new r.O(n[0],n[1],n[2]),a.orientation=this._camera.orientation,a._elevation=this.elevation,a._renderWorldCopies=this.renderWorldCopies,a}_setCameraOrientation(n){if(!r.bl.length(n))return!1;r.bl.normalize(n,n);const a=r.Q.transformQuat([],[0,0,-1],n),f=r.Q.transformQuat([],[0,-1,0],n);if(f[2]<0)return!1;const _=gs(a,f);return!!_&&(this._camera.orientation=_,!0)}_setCameraPosition(n){const a=this.zoomScale(this.minZoom)*this.tileSize,f=this.zoomScale(this.maxZoom)*this.tileSize,_=this.cameraToCenterDistance;n[2]=r.ad(n[2],_/f,_/a),this._camera.position=n}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(n){return this._edgeInsets.equals(n)}interpolatePadding(n,a,f){this._unmodified=!1,this._edgeInsets.interpolate(n,a,f),this._constrain(),this._calcMatrices()}coveringZoomLevel(n){const a=(n.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/n.tileSize));return Math.max(0,a)}getVisibleUnwrappedCoordinates(n){const a=[new r.bs(0,n)];if(this.renderWorldCopies){const f=this.pointCoordinate(new r.P(0,0)),_=this.pointCoordinate(new r.P(this.width,0)),x=this.pointCoordinate(new r.P(this.width,this.height)),w=this.pointCoordinate(new r.P(0,this.height)),S=Math.floor(Math.min(f.x,_.x,x.x,w.x)),C=Math.floor(Math.max(f.x,_.x,x.x,w.x)),D=1;for(let z=S-D;z<=C+D;z++)z!==0&&a.push(new r.bs(z,n))}return a}isLODDisabled(n){return(!n||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCoverForShadows(n,a,f){let _=[];if(a[0]===0&&a[1]===0)return _;for(const w of n){const S=w.canonical,C=w.overscaledZ,D=w.wrap,z=1<<S.z,O=S.x+1<z,V=S.x>0,U=S.y+1<z,H=S.y>0,q=w.wrap-(V?0:1),Z=w.wrap+(O?0:1),$=V?S.x-1:z-1,K=O?S.x+1:0;a[0]<0?(_.push(new r.ap(C,Z,S.z,K,S.y)),a[1]<0&&U&&(_.push(new r.ap(C,D,S.z,S.x,S.y+1)),_.push(new r.ap(C,Z,S.z,K,S.y+1))),a[1]>0&&H&&(_.push(new r.ap(C,D,S.z,S.x,S.y-1)),_.push(new r.ap(C,Z,S.z,K,S.y-1)))):a[0]>0?(_.push(new r.ap(C,q,S.z,$,S.y)),a[1]<0&&U&&(_.push(new r.ap(C,D,S.z,S.x,S.y+1)),_.push(new r.ap(C,q,S.z,$,S.y+1))),a[1]>0&&H&&(_.push(new r.ap(C,D,S.z,S.x,S.y-1)),_.push(new r.ap(C,q,S.z,$,S.y-1)))):a[1]<0&&U?_.push(new r.ap(C,D,S.z,S.x,S.y+1)):H&&_.push(new r.ap(C,D,S.z,S.x,S.y-1))}if(_.length>1){_.sort((C,D)=>C.overscaledZ-D.overscaledZ||C.wrap-D.wrap||C.canonical.z-D.canonical.z||C.canonical.x-D.canonical.x||C.canonical.y-D.canonical.y);let w=0,S=0;for(;S<_.length;)_[S].equals(_[w])?++S:_[++w]=_[S++];_.length=w+1}const x=[];for(const w of _)_.some(S=>w.isChildOf(S))||x.push(w);return _=x.filter(w=>!n.some(S=>!!(w.overscaledZ<f&&S.isChildOf(w))||w.equals(S)||w.isChildOf(S))),_}coveringTiles(n){let a=this.coveringZoomLevel(n);const f=a,_=this.elevation&&this.elevation.exaggeration(),x=_&&!n.isTerrainDEM,w=this.projection.name==="mercator";if(n.minzoom!==void 0&&a<n.minzoom)return[];n.maxzoom!==void 0&&a>n.maxzoom&&(a=n.maxzoom);const S=this.locationCoordinate(this.center),C=this.center.lat,D=1<<a,z=[D*S.x,D*S.y,0],O=this.projection.name==="globe",V=!O,U=r.bt.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,a,V),H=O?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),q=D*r.bo(1,this.center.lat),Z=this._camera.position[2]/r.bo(1,this.center.lat),$=[D*H.x,D*H.y,Z*(V?1:q)],K=O||_,oe=this.cameraToCenterDistance/n.tileSize*(n.roundZoom?1:.502),se=this.isLODDisabled(!0)?a:0;let le;if(this._elevation&&n.isTerrainDEM)le=1e4*this._elevation.exaggeration();else if(this._elevation){const we=this._elevation.getMinMaxForVisibleTiles();le=we?we.max:this._centerAltitude}else le=this._centerAltitude;const Y=n.isTerrainDEM?-le:this._elevation?this._elevation.getMinElevationBelowMSL():0,ee=this.projection.isReprojectedInTileSpace?r.bu(this):1,me=we=>{const Re=new r.O(we.x+25e-6,we.y,we.z),ae=new r.O(we.x,we.y+25e-6,we.z),Ue=we.toLngLat(),gt=Re.toLngLat(),Et=ae.toLngLat(),zt=this.locationCoordinate(Ue),Pt=this.locationCoordinate(gt),Ut=this.locationCoordinate(Et),vi=Math.hypot(Pt.x-zt.x,Pt.y-zt.y),Jt=Math.hypot(Ut.x-zt.x,Ut.y-zt.y);return Math.sqrt(vi*Jt)*ee/25e-6},fe=we=>{const De=le,Re=Y;return{aabb:r.bx(this,D,0,0,0,we,Re,De,this.projection),zoom:0,x:0,y:0,minZ:Re,maxZ:De,wrap:we,fullyVisible:!1}},xe=[];let ke=[];const ye=a,Pe=n.reparseOverscaled?f:a,ze=we=>we*we,ge=ze((Z-this._centerAltitude)*q),Ae=we=>{if(!this._elevation||!we.tileID||!w)return;const De=this._elevation.getMinMaxForTile(we.tileID),Re=we.aabb;De?(Re.min[2]=De.min,Re.max[2]=De.max,Re.center[2]=(Re.min[2]+Re.max[2])/2):(we.shouldSplit=Ye(we),we.shouldSplit||(Re.min[2]=Re.max[2]=Re.center[2]=this._centerAltitude))},Ye=we=>{if(we.zoom<se)return!0;if(we.zoom===ye)return!1;if(we.shouldSplit!=null)return we.shouldSplit;const De=we.aabb.distanceX($),Re=we.aabb.distanceY($);let ae=ge,Ue=1;if(O){ae=ze(we.aabb.distanceZ($));const zt=Math.pow(2,we.zoom),Pt=r.ax((we.y+1)/zt),Ut=r.ax(we.y/zt),vi=Math.min(Math.max(C,Pt),Ut),Jt=r.bM(vi)/r.bM(C);if(Ue=vi===C?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,Jt/this._mercatorScaleRatio),this.zoom<=r.bJ&&we.zoom===ye-1&&Jt>=.9)return!0}else if(x&&(ae=ze(we.aabb.distanceZ($)*q)),this.projection.isReprojectedInTileSpace&&f<=5){const zt=Math.pow(2,we.zoom),Pt=me(new r.O((we.x+.5)/zt,(we.y+.5)/zt));Ue=Pt>.85?1:Pt}const gt=De*De+Re*Re+ae,Et=ze((1<<ye-we.zoom)*oe*Ue*((zt,Pt)=>{if(Pt*ze(.707)<zt)return 1;const Ut=Math.sqrt(Pt/zt);return Ut/(1.4144271570014144+(Math.pow(1.1,Ut-1.4144271570014144+1)-1)/(1.1-1)-1)})(Math.max(ae,ge),gt));return gt<Et};if(this.renderWorldCopies)for(let we=1;we<=3;we++)xe.push(fe(-we)),xe.push(fe(we));for(xe.push(fe(0));xe.length>0;){const we=xe.pop(),De=we.x,Re=we.y;let ae=we.fullyVisible;const Ue=()=>this.projection.name==="globe"&&(we.y===0||we.y===(1<<we.zoom)-1);if(!ae){let gt=K?we.aabb.intersects(U):we.aabb.intersectsFlat(U);if(gt===0&&Ue()){const Et=new r.bv(we.zoom,De,Re);gt=r.bw(this,D,Et,!0).intersects(U)}if(gt===0)continue;ae=gt===2}if(we.zoom!==ye&&Ye(we))for(let gt=0;gt<4;gt++){const Et=(De<<1)+gt%2,zt=(Re<<1)+(gt>>1),Pt={aabb:w?we.aabb.quadrant(gt):r.bx(this,D,we.zoom+1,Et,zt,we.wrap,we.minZ,we.maxZ,this.projection),zoom:we.zoom+1,x:Et,y:zt,wrap:we.wrap,fullyVisible:ae,tileID:void 0,shouldSplit:void 0,minZ:we.minZ,maxZ:we.maxZ};x&&!O&&(Pt.tileID=new r.ap(we.zoom+1===ye?Pe:we.zoom+1,we.wrap,we.zoom+1,Et,zt),Ae(Pt)),xe.push(Pt)}else{const gt=we.zoom===ye?Pe:we.zoom;if(n.minzoom&&n.minzoom>gt)continue;if(!ae){let Ut=K?we.aabb.intersectsPrecise(U):we.aabb.intersectsPreciseFlat(U);if(Ut===0&&Ue()){const vi=new r.bv(we.zoom,De,Re);Ut=r.bw(this,D,vi,!0).intersectsPrecise(U)}if(Ut===0)continue}const Et=z[0]-(.5+De+(we.wrap<<we.zoom))*(1<<a-we.zoom),zt=z[1]-.5-Re,Pt=we.tileID?we.tileID:new r.ap(gt,we.wrap,we.zoom,De,Re);ke.push({tileID:Pt,distanceSq:Et*Et+zt*zt})}}if(this.fogCullDistSq){const we=this.fogCullDistSq,De=this.horizonLineFromTop();ke=ke.filter(Re=>{const ae=[0,0,0,1],Ue=[r.Y,r.Y,0,1],gt=this.calculateFogTileMatrix(Re.tileID.toUnwrapped());r.aa.transformMat4(ae,ae,gt),r.aa.transformMat4(Ue,Ue,gt);const Et=r.aa.min([],ae,Ue),zt=r.aa.max([],ae,Ue),Pt=r.by(Et,zt);if(Pt===0)return!0;let Ut=!1;const vi=this._elevation;if(vi&&Pt>we&&De!==0){const Jt=this.calculateProjMatrix(Re.tileID.toUnwrapped());let Ti;n.isTerrainDEM||(Ti=vi.getMinMaxForTile(Re.tileID)),Ti||(Ti={min:Y,max:le});const bi=r.bK(this.rotation),hn=[bi[0]*r.Y,bi[1]*r.Y,Ti.max];r.Q.transformMat4(hn,hn,Jt),Ut=(1-hn[1])*this.height*.5<De}return Pt<we||Ut})}return ke.sort((we,De)=>we.distanceSq-De.distanceSq).map(we=>we.tileID)}resize(n,a){this.width=n,this.height=a,this.pixelsToGLUnits=[2/n,-2/a],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(n){return Math.pow(2,n)}scaleZoom(n){return Math.log(n)/Math.LN2}project(n){const a=r.ad(n.lat,-r.bz,r.bz),f=this.projection.project(n.lng,a);return new r.P(f.x*this.worldSize,f.y*this.worldSize)}unproject(n){return this.projection.unproject(n.x/this.worldSize,n.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/r.bo(1,this.center.lat)/this.worldSize}setLocationAtPoint(n,a){let f,_;const x=this.centerPoint;if(this.projection.name==="globe"){const S=this.worldSize;f=(a.x-x.x)/S,_=(a.y-x.y)/S}else{const S=this.pointCoordinate(a),C=this.pointCoordinate(x);f=S.x-C.x,_=S.y-C.y}const w=this.locationCoordinate(n);this.setLocation(new r.O(w.x-f,w.y-_))}setLocation(n){this.center=this.coordinateLocation(n),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(n){return this.projection.locationPoint(this,n)}locationPoint3D(n){return this.projection.locationPoint(this,n,!0)}pointLocation(n){return this.coordinateLocation(this.pointCoordinate(n))}pointLocation3D(n){return this.coordinateLocation(this.pointCoordinate3D(n))}locationCoordinate(n,a){const f=a?r.bo(a,n.lat):void 0,_=this.projection.project(n.lng,n.lat);return new r.O(_.x,_.y,f)}coordinateLocation(n){return this.projection.unproject(n.x,n.y)}pointRayIntersection(n,a){const f=a??this._centerAltitude,_=[n.x,n.y,0,1],x=[n.x,n.y,1,1];r.aa.transformMat4(_,_,this.pixelMatrixInverse),r.aa.transformMat4(x,x,this.pixelMatrixInverse);const w=x[3];r.aa.scale(_,_,1/_[3]),r.aa.scale(x,x,1/w);const S=_[2],C=x[2];return{p0:_,p1:x,t:S===C?0:(f-S)/(C-S)}}screenPointToMercatorRay(n){const a=[n.x,n.y,0,1],f=[n.x,n.y,1,1];return r.aa.transformMat4(a,a,this.pixelMatrixInverse),r.aa.transformMat4(f,f,this.pixelMatrixInverse),r.aa.scale(a,a,1/a[3]),r.aa.scale(f,f,1/f[3]),a[2]=r.bo(a[2],this._center.lat)*this.worldSize,f[2]=r.bo(f[2],this._center.lat)*this.worldSize,r.aa.scale(a,a,1/this.worldSize),r.aa.scale(f,f,1/this.worldSize),new r.a5([a[0],a[1],a[2]],r.Q.normalize([],r.Q.sub([],f,a)))}rayIntersectionCoordinate(n){const{p0:a,p1:f,t:_}=n,x=r.bo(a[2],this._center.lat),w=r.bo(f[2],this._center.lat);return new r.O(r.X(a[0],f[0],_)/this.worldSize,r.X(a[1],f[1],_)/this.worldSize,r.X(x,w,_))}pointCoordinate(n,a=this._centerAltitude){return this.projection.pointCoordinate(this,n.x,n.y,a)}pointCoordinate3D(n){if(!this.elevation)return this.pointCoordinate(n);let a=this.projection.pointCoordinate3D(this,n.x,n.y);if(a)return new r.O(a[0],a[1],a[2]);let f=0,_=this.horizonLineFromTop();if(n.y>_)return this.pointCoordinate(n);const x=.02*_,w=n.clone();for(let S=0;S<10&&_-f>x;S++){w.y=r.X(f,_,.66);const C=this.projection.pointCoordinate3D(this,w.x,w.y);C?(_=w.y,a=C):f=w.y}return a?new r.O(a[0],a[1],a[2]):this.pointCoordinate(n)}isPointAboveHorizon(n){return this.projection.isPointAboveHorizon(this,n)}isPointOnSurface(n){if(n.y<0||n.y>this.height||n.x<0||n.x>this.width)return!1;if(this.elevation||this.zoom>=r.bA)return!this.isPointAboveHorizon(n);const a=this.pointCoordinate(n);return a.y>=0&&a.y<=1}_coordinatePoint(n,a){const f=a&&this.elevation?this.elevation.getAtPointOrZero(n,this._centerAltitude):this._centerAltitude,_=[n.x*this.worldSize,n.y*this.worldSize,f+n.toAltitude(),1];return r.aa.transformMat4(_,_,this.pixelMatrix),_[3]>0?new r.P(_[0]/_[3],_[1]/_[3]):new r.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:n,left:a}=this._edgeInsets,f=this.height-this._edgeInsets.bottom,_=this.width-this._edgeInsets.right,x=this.pointLocation3D(new r.P(a,n)),w=this.pointLocation3D(new r.P(_,n)),S=this.pointLocation3D(new r.P(_,f)),C=this.pointLocation3D(new r.P(a,f));let D=Math.min(x.lng,w.lng,S.lng,C.lng),z=Math.max(x.lng,w.lng,S.lng,C.lng),O=Math.min(x.lat,w.lat,S.lat,C.lat),V=Math.max(x.lat,w.lat,S.lat,C.lat);const U=Math.pow(2,-this.zoom)/16*270,H=this.projection.name==="globe"?1:4,q=(Z,$,K,oe,se)=>{const le=(Z+K)/2,Y=($+oe)/2,ee=new r.P(le,Y),{lng:me,lat:fe}=this.pointLocation3D(ee),xe=Math.max(0,D-me,O-fe,me-z,fe-V);D=Math.min(D,me),z=Math.max(z,me),O=Math.min(O,fe),V=Math.max(V,fe),(se<H||xe>U)&&(q(Z,$,le,Y,se+1),q(le,Y,K,oe,se+1))};if(q(a,n,_,n,1),q(_,n,_,f,1),q(_,f,a,f,1),q(a,f,a,n,1),this.projection.name==="globe"){const[Z,$]=r.bB(this);Z?(V=90,z=180,D=-180):$&&(O=-90,z=180,D=-180)}return new r.ag(new r.bq(D,O),new r.bq(z,V))}_getBoundsRectangular(n,a){const{top:f,left:_}=this._edgeInsets,x=this.height-this._edgeInsets.bottom,w=this.width-this._edgeInsets.right,S=new r.P(_,f),C=new r.P(w,f),D=new r.P(w,x),z=new r.P(_,x);let O=this.pointCoordinate(S,n),V=this.pointCoordinate(C,n);const U=this.pointCoordinate(D,a),H=this.pointCoordinate(z,a),q=(Z,$)=>($.y-Z.y)/($.x-Z.x);return O.y>1&&V.y>=0?O=new r.O((1-H.y)/q(H,O)+H.x,1):O.y<0&&V.y<=1&&(O=new r.O(-H.y/q(H,O)+H.x,0)),V.y>1&&O.y>=0?V=new r.O((1-U.y)/q(U,V)+U.x,1):V.y<0&&O.y<=1&&(V=new r.O(-U.y/q(U,V)+U.x,0)),new r.ag().extend(this.coordinateLocation(O)).extend(this.coordinateLocation(V)).extend(this.coordinateLocation(H)).extend(this.coordinateLocation(U))}_getBoundsRectangularTerrain(){const n=this.elevation;if(!n.visibleDemTiles.length||n.isUsingMockSource())return this._getBoundsRectangular(0,0);const a=n.visibleDemTiles.reduce((f,_)=>{if(_.dem){const x=_.dem.tree;f.min=Math.min(f.min,x.minimums[0]),f.max=Math.max(f.max,x.maximums[0])}return f},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(a.min*n.exaggeration(),a.max*n.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(n=!0){const a=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,f=this.height/2-a*(1-this._horizonShift);return n?Math.max(0,f):f}getMaxBounds(){return this.maxBounds}setMaxBounds(n){this.maxBounds=n,this.minLat=-r.bz,this.maxLat=r.bz,this.minLng=-180,this.maxLng=180,n&&(this.minLat=n.getSouth(),this.maxLat=n.getNorth(),this.minLng=n.getWest(),this.maxLng=n.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=r.a8(this.minLng)*this.tileSize,this.worldMaxX=r.a8(this.maxLng)*this.tileSize,this.worldMinY=r.ah(this.maxLat)*this.tileSize,this.worldMaxY=r.ah(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(n,a){return this.projection.createTileMatrix(this,a,n)}calculateDistanceTileData(n){const a=n.key,f=this._distanceTileDataCache;if(f[a])return f[a];const _=n.canonical,x=1/this.height,w=this.cameraWorldSize,S=w/this.zoomScale(_.z),C=(_.x+Math.pow(2,_.z)*n.wrap)*S,D=_.y*S,z=this.point;z.x*=w/this.worldSize,z.y*=w/this.worldSize;const O=this.angle,V=Math.sin(-O),U=-Math.cos(-O);return f[a]={bearing:[V,U],center:[(z.x-C)*x,(z.y-D)*x],scale:S/r.Y*x},f[a]}calculateFogTileMatrix(n){const a=n.key,f=this._fogTileMatrixCache;if(f[a])return f[a];const _=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,n);return r.a9.multiply(_,this.worldToFogMatrix,_),f[a]=new Float32Array(_),f[a]}calculateProjMatrix(n,a=!1,f=!1){const _=n.key;let x;if(x=f?this._expandedProjMatrixCache:a?this._alignedProjMatrixCache:this._projMatrixCache,x[_])return x[_];const w=this.calculatePosMatrix(n,this.worldSize);let S;return S=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:f?this.expandedFarZProjMatrix:a?this.alignedProjMatrix:this.projMatrix,r.a9.multiply(w,S,w),x[_]=new Float32Array(w),x[_]}calculatePixelsToTileUnitsMatrix(n){const a=n.tileID.key,f=this._pixelsToTileUnitsCache;if(f[a])return f[a];const _=r.bC(n,this);return f[a]=_,f[a]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const n=1/this.worldSize,a=r.a9.fromScaling([],[n,n,n]);return r.a9.multiply(a,a,this.globeMatrix),a}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const n=this._elevation;this._updateCameraState();const a=r.bo(1,this._center.lat)*this.worldSize,f=this._computeCameraPosition(a),_=this._camera.forward(),x=r.bo(1,this._center.lat);f[2]/=x,_[2]/=x,r.Q.normalize(_,_);const w=n.raycast(f,_,n.exaggeration());if(w){const S=r.Q.scaleAndAdd([],f,_,w),C=new r.O(S[0],S[1],r.bo(S[2],r.ax(S[1]))),D=(C.z+r.Q.length([C.x-f[0],C.y-f[1],C.z-f[2]*x]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(D),this._centerAltitude=C.toAltitude(),this._center=this.coordinateLocation(C),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(n=!1){if(!this._elevation)return;const a=this._elevation,f=r.bo(1,this._center.lat)*this.worldSize,_=this._computeCameraPosition(f),x=a.getAtPointOrZero(new r.O(..._)),w=this.pixelsPerMeter/this.worldSize*x,S=this._minimumHeightOverTerrain(),C=_[2]-w;if(C<=S)if(C<0||n){const D=this.locationCoordinate(this._center,this._centerAltitude),z=[_[0],_[1],D.z-_[2]],O=r.Q.length(z);z[2]-=(S-C)/this._pixelsPerMercatorPixel;const V=r.Q.length(z);if(V===0)return;r.Q.scale(z,z,O/V*this._pixelsPerMercatorPixel),this._camera.position=[_[0],_[1],D.z*this._pixelsPerMercatorPixel-z[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const n=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||n){const V=this.center;return V.lat=r.ad(V.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!n)&&(V.lng=r.ad(V.lng,this.minLng,this.maxLng)),this.center=V,void(this._constraining=!1)}const a=this._unmodified,{x:f,y:_}=this.point;let x=0,w=f,S=_;const C=this.width/2,D=this.height/2,z=this.worldMinY*this.scale,O=this.worldMaxY*this.scale;if(_-D<z&&(S=z+D),_+D>O&&(S=O-D),O-z<this.height&&(x=Math.max(x,this.height/(O-z)),S=(O+z)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const V=this.worldMinX*this.scale,U=this.worldMaxX*this.scale,H=this.worldSize/2-(V+U)/2;w=(f+H+this.worldSize)%this.worldSize-H,w-C<V&&(w=V+C),w+C>U&&(w=U-C),U-V<this.width&&(x=Math.max(x,this.width/(U-V)),w=(U+V)/2)}w===f&&S===_||(this.center=this.unproject(new r.P(w,S))),x&&(this.zoom+=this.scaleZoom(x)),this._constrainCamera(),this._unmodified=a,this._constraining=!1}_minZoomForBounds(){let n=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(n=Math.max(n,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),n}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const n=this.centerOffset,a=this.projection.name==="globe",f=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=r.bo(1,this.center.lat)/r.bo(1,r.bL));const _=r.bD(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,_),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const x=this.projection.zAxisUnit==="meters"?f:1,w=this._camera.getWorldToCamera(this.worldSize,x);let S;const C=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(C[8]=2*-n.x/this.width,C[9]=2*n.y/this.height,this.isOrthographic){let fe=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),xe=fe*this.aspect,ke=-xe,ye=-fe;xe-=n.x,ke-=n.x,fe+=n.y,ye+=n.y,S=this._camera.getCameraToClipOrthographic(ke,xe,ye,fe,this._nearZ,this._farZ),((Pe,ze,ge,Ae)=>{for(let Ye=0;Ye<16;Ye++)Pe[Ye]=Nh(ze[Ye],ge[Ye],Ae)})(S,S,C,ba(this.pitch>=15?1:this.pitch/15))}else S=C;const D=r.a9.mul([],C,w);let z=r.a9.mul([],S,w);if(this.projection.isReprojectedInTileSpace){const fe=this.locationCoordinate(this.center),xe=r.a9.identity([]);r.a9.translate(xe,xe,[fe.x*this.worldSize,fe.y*this.worldSize,0]),r.a9.multiply(xe,xe,r.bE(this)),r.a9.translate(xe,xe,[-fe.x*this.worldSize,-fe.y*this.worldSize,0]),r.a9.multiply(z,z,xe),r.a9.multiply(D,D,xe),this.inverseAdjustmentMatrix=r.bF(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=r.a9.scale([],z,[this.worldSize,this.worldSize,this.worldSize/x,1]),this.projMatrix=z,this.invProjMatrix=r.a9.invert(new Float64Array(16),this.projMatrix),a){const fe=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);fe[8]=2*-n.x/this.width,fe[9]=2*n.y/this.height,this.expandedFarZProjMatrix=r.a9.mul([],fe,w)}else this.expandedFarZProjMatrix=this.projMatrix;const O=r.a9.invert([],S);this.frustumCorners=r.bG.fromInvProjectionMatrix(O,this.horizonLineFromTop(),this.height),this.cameraFrustum=r.bt.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!a);const V=new Float32Array(16);r.a9.identity(V),r.a9.scale(V,V,[1,-1,1]),r.a9.rotateX(V,V,this._pitch),r.a9.rotateZ(V,V,this.angle);const U=r.a9.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=r.a9.clone(U);const H=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;U[8]=2*-n.x/this.width,U[9]=2*(n.y+H)/this.height,this.skyboxMatrix=r.a9.multiply(V,U,V);const q=this.point,Z=q.x,$=q.y,K=this.width%2/2,oe=this.height%2/2,se=Math.cos(this.angle),le=Math.sin(this.angle),Y=Z-Math.round(Z)+se*K+le*oe,ee=$-Math.round($)+se*oe+le*K,me=new Float64Array(z);if(r.a9.translate(me,me,[Y>.5?Y-1:Y,ee>.5?ee-1:ee,0]),this.alignedProjMatrix=me,z=r.a9.create(),r.a9.scale(z,z,[this.width/2,-this.height/2,1]),r.a9.translate(z,z,[1,-1,0]),this.labelPlaneMatrix=z,z=r.a9.create(),r.a9.scale(z,z,[1,-1,1]),r.a9.translate(z,z,[-1,-1,0]),r.a9.scale(z,z,[2/this.width,2/this.height,1]),this.glCoordMatrix=z,this.pixelMatrix=r.a9.multiply(new Float64Array(16),this.labelPlaneMatrix,D),this._calcFogMatrices(),this._distanceTileDataCache={},z=r.a9.invert(new Float64Array(16),this.pixelMatrix),!z)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=z,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=r.bH(this);const fe=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=r.Q.transformMat4(fe,fe,w),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=z;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const n=this.cameraWorldSizeForFog,a=this.cameraPixelsPerMeter,f=this._camera.position,_=1/this.height/this._pixelsPerMercatorPixel,x=[n,n,a];r.Q.scale(x,x,_),r.Q.scale(f,f,-1),r.Q.multiply(f,f,x);const w=r.a9.create();r.a9.translate(w,w,f),r.a9.scale(w,w,x),this.mercatorFogMatrix=w,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(n,a,_)}_computeCameraPosition(n){const a=(n=n||this.pixelsPerMeter)/this.pixelsPerMeter,f=this._camera.forward(),_=this.point,x=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*a-n/this.worldSize*this._centerAltitude;return[_.x/this.worldSize-f[0]*x,_.y/this.worldSize-f[1]*x,n/this.worldSize*this._centerAltitude-f[2]*x]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(n){const a=this._maxCameraBoundsDistance()*Math.cos(this._pitch),f=this._camera.position[2],_=n[2];let x=1;this.projection.wrap&&(this.center=this.center.wrap()),_>0&&(x=Math.min((a-f)/_,1)),this._camera.position=r.Q.scaleAndAdd([],this._camera.position,n,x),this._updateStateFromCamera()}_updateStateFromCamera(){const n=this._camera.position,a=this._camera.forward(),{pitch:f,bearing:_}=this._camera.getPitchBearing(),x=r.bo(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,w=this._mercatorZfromZoom(this._maxZoom)*Math.cos(r.bm(this._maxPitch)),S=Math.max((n[2]-x)/Math.cos(f),w),C=this._zoomFromMercatorZ(S);r.Q.scaleAndAdd(n,n,a,S),this._pitch=r.ad(f,r.bm(this.minPitch),r.bm(this.maxPitch)),this.angle=r.bk(_,-Math.PI,Math.PI),this._setZoom(r.ad(C,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new r.O(n[0],n[1],n[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(n){return Math.pow(2,n)*this.tileSize}_mercatorZfromZoom(n){return this.cameraToCenterDistance/this._worldSizeFromZoom(n)}_minimumHeightOverTerrain(){const n=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(n)}_zoomFromMercatorZ(n){return this.scaleZoom(this.cameraToCenterDistance/(n*this.tileSize))}zoomFromMercatorZAdjusted(n){let a=0,f=r.bA,_=0,x=1/0;for(;f-a>1e-6&&f>a;){const w=a+.5*(f-a),S=this.tileSize*Math.pow(2,w),C=this.getCameraToCenterDistance(this.projection,w,S),D=this.scaleZoom(C/(n*this.tileSize)),z=Math.abs(w-D);z<x&&(x=z,_=w),w<D?a=w:f=w}return _}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(r.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(n,a){const f=Math.min(n.x,a.x),_=Math.max(n.x,a.x),x=Math.min(n.y,a.y),w=Math.max(n.y,a.y);if(x<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const S=[new r.P(f,x),new r.P(_,w),new r.P(f,w),new r.P(_,x)],C=this.renderWorldCopies?-3:0,D=this.renderWorldCopies?4:1;for(const z of S){const O=this.pointRayIntersection(z);if(O.t<0)return!0;const V=this.rayIntersectionCoordinate(O);if(V.x<C||V.y<0||V.x>D||V.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+r.bI(this.fovAboveCenter)>88||this.anyCornerOffEdge(new r.P(0,0),new r.P(this.width,this.height))}zoomDeltaToMovement(n,a){const f=r.Q.length(r.Q.sub([],this._camera.position,n)),_=this._zoomFromMercatorZ(f)+a;return f-this._mercatorZfromZoom(_)}getCameraPoint(){if(this.projection.name==="globe"){const n=function([a,f,_],x){const w=[a,f,_,1];r.aa.transformMat4(w,w,x);const S=w[3]=Math.max(w[3],1e-6);return w[0]/=S,w[1]/=S,w[2]/=S,w}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new r.P(n[0],n[1])}{const n=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new r.P(0,n))}}getCameraToCenterDistance(n,a=this.zoom,f=this.worldSize){const _=r.bD(n,a,this.width,this.height,1024),x=n.pixelSpaceConversion(this.center.lat,f,_);let w=.5/Math.tan(.5*this._fov)*this.height*x;return this.isOrthographic&&(w=Nh(1,w,ba(this.pitch>=15?1:this.pitch/15))),w}getWorldToCameraMatrix(){const n=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&r.a9.multiply(n,n,this.globeMatrix),n}getFrustum(n){return r.bt.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,n,this.projection.zAxisUnit==="meters")}}const Or={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,ShadowMap0:10},po=(d,n)=>{if(n>0&&d.terrain&&r.w("Cutoff is currently disabled on terrain"),n<=0||d.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const a=d.transform,f=Math.max(Math.abs(a._zoom-(d.minCutoffZoom-1)),1),_=a.isLODDisabled(!1)?r.S(60,45,a.pitch):r.S(30,15,a.pitch),x=a._farZ-a._nearZ,w=n*a.height,S=((1-(C=_))*a.cameraToCenterDistance+C*(a._farZ+w))*f;var C;return{shouldRenderCutoff:_<1,uniformValues:{u_cutoff_params:[a._nearZ,a._farZ,(S-a._nearZ)/x,(S-w-a._nearZ)/x]}}},Fr={cascadeCount:2,shadowMapResolution:2048};class _p{constructor(n,a){this.aabb=n,this.lastCascade=a}}class ug{add(n,a){const f=this.receivers[n.key];f!==void 0?(f.aabb.min[0]=Math.min(f.aabb.min[0],a.min[0]),f.aabb.min[1]=Math.min(f.aabb.min[1],a.min[1]),f.aabb.min[2]=Math.min(f.aabb.min[2],a.min[2]),f.aabb.max[0]=Math.max(f.aabb.max[0],a.max[0]),f.aabb.max[1]=Math.max(f.aabb.max[1],a.max[1]),f.aabb.max[2]=Math.max(f.aabb.max[2],a.max[2])):this.receivers[n.key]=new _p(a,null)}clear(){this.receivers={}}get(n){return this.receivers[n.key]}computeRequiredCascades(n,a,f){const _=r.bV.fromPoints(n.points);let x=0;for(const w in this.receivers){const S=this.receivers[w];if(!S||!_.intersectsAabb(S.aabb))continue;S.aabb.min=_.closestPoint(S.aabb.min),S.aabb.max=_.closestPoint(S.aabb.max);const C=S.aabb.getCorners();for(let D=0;D<f.length;D++){let z=!0;for(const O of C){const V=[O[0]*a,O[1]*a,O[2]];if(r.Q.transformMat4(V,V,f[D].matrix),V[0]<-1||V[0]>1||V[1]<-1||V[1]>1){z=!1;break}}if(S.lastCascade=D,x=Math.max(x,D),z)break}}return x+1}}class gp{constructor(n){this.painter=n,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new ug,this._depthMode=new jt(n.context.gl.LEQUAL,jt.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,n.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),n.tp.registerParameter(Fr,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),n.tp.registerParameter(Fr,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),n.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const n of this._cascades)n.texture.destroy(),n.framebuffer.destroy();this._cascades=[]}updateShadowParameters(n,a){const f=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!a||!a.properties)return;const _=a.properties.get("shadow-intensity");if(!a.shadowsEnabled()||_<=0||(this._shadowLayerCount=f.style.order.reduce((H,q)=>{const Z=f.style._mergedLayers[q];return H+(Z.hasShadowPass()&&!Z.isHidden(n.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;const x=f.context,w=Fr.shadowMapResolution,S=Fr.shadowMapResolution;if(this._cascades.length===0||Fr.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let H=0;H<Fr.cascadeCount;++H){const q=f._shadowMapDebug,Z=x.gl,$=x.createFramebuffer(w,S,q,"texture"),K=new r.T(x,{width:w,height:S,data:null},Z.DEPTH_COMPONENT);if($.depthAttachment.set(K.texture),q){const oe=new r.T(x,{width:w,height:S,data:null},Z.RGBA);$.colorAttachment.set(oe.texture)}this._cascades.push({framebuffer:$,texture:K,matrix:[],far:0,boundingSphereRadius:0,frustum:new r.bt,scale:0})}}this.shadowDirection=eu(a);let C=0;if(n.elevation){const H=n.elevation,q=[1e4,-1e4];H.visibleDemTiles.filter(Z=>Z.dem).forEach(Z=>{const $=Z.dem.tree;q[0]=Math.min(q[0],$.minimums[0]),q[1]=Math.max(q[1],$.maximums[0])}),q[0]!==1e4&&(C=(q[1]-q[0])*H.exaggeration())}const D=1.5*n.cameraToCenterDistance,z=3*D,O=new Float64Array(16);for(let H=0;H<this._cascades.length;++H){const q=this._cascades[H];let Z=n.height/50,$=1;Fr.cascadeCount===1?$=z:H===0?$=D:(Z=D,$=z);const[K,oe]=tu(n,this.shadowDirection,Z,$,Fr.shadowMapResolution,C);q.scale=n.scale,q.matrix=K,q.boundingSphereRadius=oe,r.a9.invert(O,q.matrix),q.frustum=r.bt.fromInvProjectionMatrix(O,1,0,!0),q.far=$}const V=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[V].far,this._cascades[V].far],this._uniformValues.u_shadow_intensity=_,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/Fr.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=Fr.shadowMapResolution,this._uniformValues.u_shadowmap_0=Or.ShadowMap0,this._uniformValues.u_shadowmap_1=Or.ShadowMap0+1,this._groundShadowTiles=f.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const U=f.transform.elevation;for(const H of this._groundShadowTiles){let q={min:0,max:0};if(U){const Z=U.getMinMaxForTile(H);Z&&(q=Z)}this.addShadowReceiver(H.toUnwrapped(),q.min,q.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(n){this._enabled=n}drawShadowPass(n,a){if(!this.enabled)return;const f=this.painter,_=f.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(f.transform.getFrustum(0),f.transform.worldSize,this._cascades),_.viewport.set([0,0,Fr.shadowMapResolution,Fr.shadowMapResolution]);for(let x=0;x<this._numCascadesToRender;++x){f.currentShadowCascade=x,_.bindFramebuffer.set(this._cascades[x].framebuffer.framebuffer),_.clear({color:r.aA.white,depth:1});for(const w of n.order){const S=n._mergedLayers[w];if(!S.hasShadowPass()||S.isHidden(f.transform.zoom))continue;const C=n.getLayerSourceCache(S),D=C?a[C.id]:void 0;(S.type==="model"||D&&D.length)&&f.renderLayer(f,C,S,D)}}f.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const n=this.painter,a=n.style,f=n.context,_=a.directionalLight,x=a.ambientLight;if(!_||!x)return;const w=[],S=po(n,n.longestCutoffRange);S.shouldRenderCutoff&&w.push("RENDER_CUTOFF");const C=Vh(_,x),D=new jt(f.gl.LEQUAL,jt.ReadOnly,n.depthRangeFor3D);for(const z of this._groundShadowTiles){const O=z.toUnwrapped(),V=n.isTileAffectedByFog(z),U=n.getOrCreateProgram("groundShadow",{defines:w,overrideFog:V});this.setupShadows(O,U),n.uploadCommonUniforms(f,U,O,null,S);const H={u_matrix:n.transform.calculateProjMatrix(O),u_ground_shadow_factor:C};U.draw(n,f.gl.TRIANGLES,D,ei.disabled,pi.multiply,Yt.disabled,H,"ground_shadow",n.tileExtentBuffer,n.quadTriangleIndexBuffer,n.tileExtentSegments,{},n.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?pi.unblended:pi.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(n){const a=this.painter.transform,f=a.calculatePosMatrix(n,a.worldSize);return r.a9.multiply(f,this._cascades[this.painter.currentShadowCascade].matrix,f),Float32Array.from(f)}calculateShadowPassMatrixFromMatrix(n){return r.a9.multiply(n,this._cascades[this.painter.currentShadowCascade].matrix,n),Float32Array.from(n)}setupShadows(n,a,f,_=0){if(!this.enabled)return;const x=this.painter.transform,w=this.painter.context,S=w.gl,C=this._uniformValues,D=new Float64Array(16),z=x.calculatePosMatrix(n,x.worldSize);for(let O=0;O<this._cascades.length;O++)r.a9.multiply(D,this._cascades[O].matrix,z),C[O===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(D),w.activeTexture.set(S.TEXTURE0+Or.ShadowMap0+O),this._cascades[O].texture.bind(S.NEAREST,S.CLAMP_TO_EDGE);if(this.useNormalOffset=!!f,this.useNormalOffset){const O=r.bU(n.canonical),V=2/x.tileSize*r.Y/Fr.shadowMapResolution,U=V*this._cascades[0].boundingSphereRadius,H=V*this._cascades[this._cascades.length-1].boundingSphereRadius,q=(f==="vector-tile"?1:3)/Math.pow(2,_-n.canonical.z-(1-x.zoom+Math.floor(x.zoom)));C.u_shadow_normal_offset=[O,U*q,H*q],C.u_shadow_bias=[6e-5,.0012,.012]}else C.u_shadow_bias=[36e-5,.0012,.012];a.setShadowUniformValues(w,C)}setupShadowsFromMatrix(n,a,f=!1){if(!this.enabled)return;const _=this.painter.context,x=_.gl,w=this._uniformValues,S=new Float64Array(16);for(let C=0;C<Fr.cascadeCount;C++)r.a9.multiply(S,this._cascades[C].matrix,n),w[C===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(S),_.activeTexture.set(x.TEXTURE0+Or.ShadowMap0+C),this._cascades[C].texture.bind(x.NEAREST,x.CLAMP_TO_EDGE);this.useNormalOffset=f,f?(w.u_shadow_normal_offset=[1,5,5],w.u_shadow_bias=[6e-5,.0012,.012]):w.u_shadow_bias=[36e-5,.0012,.012],a.setShadowUniformValues(_,w)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(n,a,f,_){if(_[2]>=0)return{};const x=function(C,D,z){const O=z/(1<<C.canonical.z);return new r.bV([C.canonical.x*O+C.wrap*z,C.canonical.y*O+C.wrap*z,0],[(C.canonical.x+1)*O+C.wrap*z,(C.canonical.y+1)*O+C.wrap*z,D])}(n,a,f).getCorners(),w=a/-_[2];_[0]<0?(r.Q.add(x[0],x[0],[_[0]*w,0,0]),r.Q.add(x[3],x[3],[_[0]*w,0,0])):_[0]>0&&(r.Q.add(x[1],x[1],[_[0]*w,0,0]),r.Q.add(x[2],x[2],[_[0]*w,0,0])),_[1]<0?(r.Q.add(x[0],x[0],[0,_[1]*w,0]),r.Q.add(x[1],x[1],[0,_[1]*w,0])):_[1]>0&&(r.Q.add(x[2],x[2],[0,_[1]*w,0]),r.Q.add(x[3],x[3],[0,_[1]*w,0]));const S={};return S.vertices=x,S.planes=[Jc(x[1],x[0],x[4]),Jc(x[2],x[1],x[5]),Jc(x[3],x[2],x[6]),Jc(x[0],x[3],x[7])],S}addShadowReceiver(n,a,f){this._receivers.add(n,r.bV.fromTileIdAndHeight(n,a,f))}getMaxCascadeForTile(n){const a=this._receivers.get(n);return a&&a.lastCascade?a.lastCascade:0}}function Jc(d,n,a){const f=r.Q.sub([],a,n),_=r.Q.sub([],d,n),x=r.Q.cross([],f,_),w=r.Q.length(x);return w===0?[0,0,1,0]:(r.Q.scale(x,x,1/w),[x[0],x[1],x[2],-r.Q.dot(x,n)])}function eu(d){const n=d.properties.get("direction"),a=r.bT(n.x,n.y,n.z);a[2]=r.ad(a[2],0,75);const f=r.bW([a[0],a[1],a[2]]);return r.Q.fromValues(f.x,f.y,f.z)}function Vh(d,n){const a=d.properties.get("color"),f=d.properties.get("intensity"),_=d.properties.get("direction"),x=[_.x,_.y,_.z],w=n.properties.get("color"),S=n.properties.get("intensity"),C=Math.max(r.Q.dot([0,0,1],x),0),D=[0,0,0];r.Q.scale(D,w.toArray01Linear().slice(0,3),S);const z=[0,0,0];return r.Q.scale(z,a.toArray01Linear().slice(0,3),C*f),r.bX([D[0]>0?D[0]/(D[0]+z[0]):0,D[1]>0?D[1]/(D[1]+z[1]):0,D[2]>0?D[2]/(D[2]+z[2]):0])}function tu(d,n,a,f,_,x){const w=d.zoom,S=d.scale,C=d.worldSize,D=1/C,z=d.aspect,O=Math.sqrt(1+z*z)*Math.tan(.5*d.fovX),V=O*O,U=f-a,H=f+a;let q,Z;V>U/H?(q=f,Z=f*O):(q=.5*H*(1+V),Z=.5*Math.sqrt(U*U+2*(f*f+a*a)*V+H*H*V*V));const $=d.projection.pixelsPerMeter(d.center.lat,C),K=d._camera.getCameraToWorldMercator(),oe=[0,0,-q*D];r.Q.transformMat4(oe,oe,K);let se=Z*D;const le=d._edgeInsets;if(!(le.left===0&&le.top===0&&le.right===0&&le.bottom===0||le.left===le.right&&le.top===le.bottom)){const ae=d._camera.getWorldToCamera(d.worldSize,d.projection.zAxisUnit==="meters"?$:1),Ue=d._camera.getCameraToClipPerspective(d._fov,d.width/d.height,a,f);Ue[8]=2*-d.centerOffset.x/d.width,Ue[9]=2*d.centerOffset.y/d.height;const gt=new Float64Array(16);r.a9.mul(gt,Ue,ae);const Et=new Float64Array(16);r.a9.invert(Et,gt);const zt=r.bt.fromInvProjectionMatrix(Et,C,w,!0);for(const Pt of zt.points){const Ut=((Y=Pt)[0]/=S,Y[1]/=S,Y[2]=r.bo(Y[2],d._center.lat),Y);se=Math.max(se,r.Q.len(r.Q.subtract([],oe,Ut)))}}var Y;se*=_/(_-1);const ee=Math.acos(n[2]),me=Math.atan2(-n[0],-n[1]),fe=new Ml;fe.position=oe,fe.setPitchBearing(ee,me);const xe=fe.getWorldToCamera(C,$),ke=se*C,ye=Math.min(d._mercatorZfromZoom(17)*C*-2,-2*ke),Pe=fe.getCameraToClipOrthographic(-ke,ke,-ke,ke,ye,(ke+x*$)/n[2]),ze=new Float64Array(16);r.a9.multiply(ze,Pe,xe);const ge=r.Q.fromValues(Math.floor(1e6*oe[0])/1e6*C,Math.floor(1e6*oe[1])/1e6*C,0),Ae=.5*_,Ye=[0,0,0];r.Q.transformMat4(Ye,ge,ze),r.Q.scale(Ye,Ye,Ae);const we=[Math.floor(Ye[0]),Math.floor(Ye[1]),Math.floor(Ye[2])],De=[0,0,0];r.Q.sub(De,Ye,we),r.Q.scale(De,De,-1/Ae);const Re=new Float64Array(16);return r.a9.identity(Re),r.a9.translate(Re,Re,De),r.a9.multiply(ze,Re,ze),[ze,ke]}const Rs=(d,n)=>St(d,n&&n.filter(a=>a.identifier!=="source.canvas")),yp=r.af(Di,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection","setCamera","addImport","removeImport","updateImport"]),hg=r.af(Di,["setCenter","setZoom","setBearing","setPitch"]),Uh={version:8,layers:[],sources:{}},jh={duration:300,delay:0};class ys extends r.E{constructor(n,a={}){super(),this.map=n,this.scope=a.scope||"",this.globalId=null,this.fragments=[],this.importDepth=a.importDepth||0,this.importsCache=a.importsCache||new Map,this.resolvedImports=a.resolvedImports||new Set,this.transition=r.e({},jh),this._buildingIndex=new Ah(this),this.crossTileSymbolIndex=new Fh,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=a.styleChanges||new ht,this.dispatcher=a.dispatcher?a.dispatcher:new r.bZ(r.b_(),this),a.imageManager?this.imageManager=a.imageManager:(this.imageManager=new ii,this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=a.glyphManager?a.glyphManager:new r.b$(n._requestManager,a.localFontFamily?r.c0.all:a.localIdeographFontFamily?r.c0.ideographs:r.c0.none,a.localFontFamily||a.localIdeographFontFamily),a.modelManager?this.modelManager=a.modelManager:(this.modelManager=new st(n._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this.options=a.configOptions?a.configOptions:new Map,this._configDependentLayers=a.configDependentLayers?a.configDependentLayers:new Set,this._config=a.config,this._initialConfig=a.initialConfig,this.dispatcher.broadcast("setReferrer",r.c1());const f=this;this._rtlTextPluginCallback=ys.registerForPluginStateChange(_=>{f.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:_.pluginStatus,pluginURL:_.pluginURL},(x,w)=>{if(r.c2(x),w&&w.every(S=>S))for(const S in f._sourceCaches){const C=f._sourceCaches[S],D=C.getSource().type;D!=="vector"&&D!=="geojson"||C.reload()}})}),this.on("data",_=>{if(_.dataType!=="source"||_.sourceDataType!=="metadata")return;const x=this.getOwnSource(_.sourceId);if(x&&x.vectorLayerIds)for(const w in this._layers){const S=this._layers[w];S.source===x.id&&this._validateLayer(S)}})}load(n){return n?(typeof n=="string"?this.loadURL(n):this.loadJSON(n),this):this}_getGlobalId(n){if(!n)return null;if(typeof n=="string"){if(r.c3(n))return n;const a=r.c4(n);if(!a.startsWith("http"))try{return new URL(a,location.href).toString()}catch{return a}return a}return`json://${r.c5(JSON.stringify(n))}`}_diffStyle(n,a,f){this.globalId=this._getGlobalId(n);const _=(x,w)=>{try{w(null,this.setState(x,f))}catch(S){w(S,!1)}};if(typeof n=="string"){const x=this.map._requestManager.normalizeStyleURL(n),w=this.map._requestManager.transformRequest(x,r.R.Style);r.g(w,(S,C)=>{S?this.fire(new r.a(S)):C&&_(C,a)})}else typeof n=="object"&&_(n,a)}loadURL(n,a={}){this.fire(new r.b("dataloading",{dataType:"style"}));const f=typeof a.validate=="boolean"?a.validate:!r.c3(n);this.globalId=this._getGlobalId(n),n=this.map._requestManager.normalizeStyleURL(n,a.accessToken),this.resolvedImports.add(n);const _=this.importsCache.get(n);if(_)return this._load(_,f);const x=this.map._requestManager.transformRequest(n,r.R.Style);this._request=r.g(x,(w,S)=>{if(this._request=null,w)this.fire(new r.a(w));else if(S)return this.importsCache.set(n,S),this._load(S,f)})}loadJSON(n,a={}){this.fire(new r.b("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(n),this._request=r.f.frame(()=>{this._request=null,this._load(n,a.validate!==!1)})}loadEmpty(){this.fire(new r.b("dataloading",{dataType:"style"})),this._load(Uh,!1)}_loadImports(n,a,f){if(this.importDepth>=4)return r.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const _=[];for(const x of n){const w=this._createFragmentStyle(x),S=new Promise(z=>{w.once("style.import.load",z),w.once("error",z)}).then(()=>this.mergeAll());if(_.push(S),this.resolvedImports.has(x.url)){w.loadEmpty();continue}const C=x.data||this.importsCache.get(x.url);C?(w.loadJSON(C,{validate:a}),this._isInternalStyle(C)&&(w.globalId=null)):x.url?w.loadURL(x.url,{validate:a}):w.loadEmpty();const D={style:w,id:x.id,config:x.config};if(f){const z=this.fragments.findIndex(({id:O})=>O===f);this.fragments=this.fragments.slice(0,z).concat(D).concat(this.fragments.slice(z))}else this.fragments.push(D)}return Promise.allSettled(_)}getImportGlobalIds(n=this,a=new Set){for(const f of n.fragments)f.style.globalId&&a.add(f.style.globalId),this.getImportGlobalIds(f.style,a);return[...a.values()]}_createFragmentStyle(n){const a=this.scope?r.aj(n.id,this.scope):n.id;let f;const _=this._initialConfig&&this._initialConfig[a];(n.config||_)&&(f=r.e({},n.config,_));const x=new ys(this.map,{scope:a,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:f,configOptions:this.options,configDependentLayers:this._configDependentLayers});return x.setEventedParent(this.map,{style:x}),x}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.isRootStyle()}_isInternalStyle(n){return this.isRootStyle()&&(n.fragment||!!n.schema&&n.fragment!==!1)}_load(n,a){const f=n.schema;if(this._isInternalStyle(n)){const S=r.e({},Uh,{imports:[{id:"basemap",data:n,url:""}]});return void this._load(S,a)}if(this.updateConfig(this._config,f),a&&Rs(this,Zt(n)))return;this._loaded=!0,this.stylesheet=r.c6(n);for(const S in n.sources)this.addSource(S,n.sources[S],{validate:!1,isInitialLoad:!0});n.sprite?this._loadSprite(n.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.glyphManager.setURL(n.glyphs,this.scope);const _=lp(this.stylesheet.layers);if(this._order=_.map(S=>S.id),this.stylesheet.light&&r.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){const S=this.stylesheet.lights[0];this.light=new Lt(S.properties,S.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new Lt(this.stylesheet.light)),this._layers={},this._serializedLayers={};for(const S of _){const C=r.c7(S,this.scope,this.options);C.isConfigDependent&&this._configDependentLayers.add(C.fqid),C.setEventedParent(this,{layer:{id:C.id}}),this._layers[C.id]=C,this._serializedLayers[C.id]=C.serialize();const D=this.getOwnLayerSourceCache(C),z=!!this.directionalLight&&this.directionalLight.shadowsEnabled();D&&C.canCastShadows()&&z&&(D.castsShadows=!0)}this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);const x=this.stylesheet.terrain;x&&(this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=r.f.hasCanvasFingerprintNoise()),this.disableElevatedTerrain?r.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."):this.terrainSetForDrapingOnly()||this._createTerrain(x,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new r.b("data",{dataType:"style"}));const w=this.isRootStyle();n.imports?this._loadImports(n.imports,a).then(()=>{this._reloadImports(),this.fire(new r.b(w?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new r.b(w?"style.load":"style.import.load")))}isRootStyle(){return this.importDepth===0}mergeAll(){let n,a,f,_,x,w,S,C;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(D=>{if(D.stylesheet){if(D.light!=null&&(n=D.light),D.stylesheet.lights)for(const z of D.stylesheet.lights)z.type==="ambient"&&D.ambientLight!=null&&(a=D.ambientLight),z.type==="directional"&&D.directionalLight!=null&&(f=D.directionalLight);_=this._prioritizeTerrain(_,D.terrain,D.stylesheet.terrain),D.stylesheet.fog&&D.fog!=null&&(x=D.fog),D.stylesheet.camera!=null&&(C=D.stylesheet.camera),D.stylesheet.projection!=null&&(w=D.stylesheet.projection),D.stylesheet.transition!=null&&(S=D.stylesheet.transition)}}),this.light=n,this.ambientLight=a,this.directionalLight=f,this.fog=x,_===null?delete this.terrain:this.terrain=_,this.camera=C||{"camera-projection":"perspective"},this.projection=w||{name:"mercator"},this.transition=r.e({},jh,S),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(n){const a=f=>{for(const _ of f.fragments)a(_.style);n(f)};a(this)}_prioritizeTerrain(n,a,f){const _=n&&n.drapeRenderMode===0;return f===null?a&&a.drapeRenderMode===0?a:_?n:null:a!=null&&(!n||_||a&&a.drapeRenderMode===1)?a:n}mergeTerrain(){let n;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(a=>{n=this._prioritizeTerrain(n,a.terrain,a.stylesheet.terrain)}),n===null?delete this.terrain:this.terrain=n}mergeProjection(){let n;this.forEachFragmentStyle(a=>{a.stylesheet.projection!=null&&(n=a.stylesheet.projection)}),this.projection=n||{name:"mercator"}}mergeSources(){const n={},a={},f={};this.forEachFragmentStyle(_=>{for(const x in _._sourceCaches){const w=r.aj(x,_.scope);n[w]=_._sourceCaches[x]}for(const x in _._otherSourceCaches){const w=r.aj(x,_.scope);a[w]=_._otherSourceCaches[x]}for(const x in _._symbolSourceCaches){const w=r.aj(x,_.scope);f[w]=_._symbolSourceCaches[x]}}),this._mergedSourceCaches=n,this._mergedOtherSourceCaches=a,this._mergedSymbolSourceCaches=f}mergeLayers(){const n={},a=[],f={};this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(x=>{for(const w of x._order){const S=x._layers[w];if(S.type==="slot"){const C=r.c8(w);if(n[C])continue;n[C]=[]}S.slot&&n[S.slot]?n[S.slot].push(S):a.push(S)}}),this._mergedOrder=[];const _=(x=[])=>{for(const w of x)if(w.type==="slot"){const S=r.c8(w.id);n[S]&&_(n[S])}else{const S=r.aj(w.id,w.scope);this._mergedOrder.push(S),f[S]=w,w.is3D()&&(this._has3DLayers=!0),w.type==="circle"&&(this._hasCircleLayers=!0),w.type==="symbol"&&(this._hasSymbolLayers=!0)}};_(a),this._mergedLayers=f,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(n){return this.stylesheet.camera=r.e({},this.stylesheet.camera,n),this.camera=this.stylesheet.camera,this}setProjection(n){n?this.stylesheet.projection=n:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(n){this._spriteRequest=function(a,f,_){let x,w,S;const C=r.f.devicePixelRatio>1?"@2x":"";let D=r.g(f.transformRequest(f.normalizeSpriteURL(a,C,".json"),r.R.SpriteJSON),(V,U)=>{D=null,S||(S=V,x=U,O())}),z=r.d(f.transformRequest(f.normalizeSpriteURL(a,C,".png"),r.R.SpriteImage),(V,U)=>{z=null,S||(S=V,w=U,O())});function O(){if(S)_(S);else if(x&&w){const V=r.f.getImageData(w),U={};for(const H in x){const{width:q,height:Z,x:$,y:K,sdf:oe,pixelRatio:se,stretchX:le,stretchY:Y,content:ee}=x[H],me=new r.h({width:q,height:Z});r.h.copy(V,me,{x:$,y:K},{x:0,y:0},{width:q,height:Z}),U[H]={data:me,pixelRatio:se,sdf:oe,stretchX:le,stretchY:Y,content:ee}}_(null,U)}}return{cancel(){D&&(D.cancel(),D=null),z&&(z.cancel(),z=null)}}}(n,this.map._requestManager,(a,f)=>{if(this._spriteRequest=null,a)this.fire(new r.a(a));else if(f)for(const _ in f)this.imageManager.addImage(_,this.scope,f[_]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new r.b("data",{dataType:"style"}))})}_validateLayer(n){const a=this.getOwnSource(n.source);if(!a)return;const f=n.sourceLayer;f&&(a.type==="geojson"||a.vectorLayerIds&&a.vectorLayerIds.indexOf(f)===-1)&&this.fire(new r.a(new Error(`Source layer "${f}" does not exist on source "${a.id}" as specified by style layer "${n.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const n in this._sourceCaches)if(!this._sourceCaches[n].loaded())return!1;if(!this.imageManager.isLoaded()||!this.modelManager.isLoaded())return!1;for(const{style:n}of this.fragments)if(!n.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((n,a)=>{const f=this.fragments[a];return f&&f.style&&(n.data=f.style.serialize()),n})}_serializeSources(){const n={};for(const a in this._sourceCaches){const f=this._sourceCaches[a].getSource();n[f.id]||(n[f.id]=f.serialize())}return n}_serializeLayers(n){const a=[];for(const f of n){const _=this._layers[f];_&&_.type!=="custom"&&a.push(_.serialize())}return a}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition())return!0;for(const n in this._sourceCaches)if(this._sourceCaches[n].hasTransition())return!0;for(const n in this._layers)if(this._layers[n].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}isLayerDraped(n){return!!this.terrain&&n.isDraped(this.getLayerSourceCache(n))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(n){const a=this.getOwnLayer(n);if(a)return a;this.fire(new r.a(new Error(`The layer '${n}' does not exist in the map's style.`)))}_checkSource(n){const a=this.getOwnSource(n);if(a)return a;this.fire(new r.a(new Error(`The source '${n}' does not exist in the map's style.`)))}update(n){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(n),this.directionalLight&&this.directionalLight.recalculate(n);const a=this.calculateLightsBrightness();n.brightness=a||0,a!==this._brightness&&(this._brightness=a,this.dispatcher.broadcast("setBrightness",a));const f=this._changes.isDirty();if(this._changes.isDirty()){const x=this._changes.getLayerUpdatesByScope();for(const w in x){const{updatedIds:S,removedIds:C}=x[w];(S||C)&&this._updateWorkerLayers(w,S,C)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(n),this.light&&this.light.updateTransitions(n),this.ambientLight&&this.ambientLight.updateTransitions(n),this.directionalLight&&this.directionalLight.updateTransitions(n),this.fog&&this.fog.updateTransitions(n),this._changes.reset()}const _={};for(const x in this._mergedSourceCaches){const w=this._mergedSourceCaches[x];_[x]=w.used,w.used=!1,w.tileCoverLift=0}for(const x of this._mergedOrder){const w=this._mergedLayers[x];if(w.recalculate(n,this._availableImages),!w.isHidden(n.zoom)){const S=this.getLayerSourceCache(w);S&&(S.used=!0,S.tileCoverLift=Math.max(S.tileCoverLift,w.tileCoverLift()))}if(!this._precompileDone&&this._shouldPrecompile)for(let S=w.minzoom||0;S<(w.maxzoom||25.5);S++){const C=this.map.painter;if(C){const D=w.getProgramIds();if(!D)continue;for(const z of D){const O=w.getDefaultProgramParams(z,n.zoom);O&&(C.style=this,this.fog&&(C._fogVisible=!0,O.overrideFog=!0,C.getOrCreateProgram(z,O)),C._fogVisible=!1,O.overrideFog=!1,C.getOrCreateProgram(z,O),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(O.overrideRtt=!0,C.getOrCreateProgram(z,O)))}}}}this._shouldPrecompile&&(this._precompileDone=!0);for(const x in _){const w=this._mergedSourceCaches[x];_[x]!==w.used&&w.getSource().fire(new r.b("data",{sourceDataType:"visibility",dataType:"source",sourceId:w.getSource().id}))}this.light&&this.light.recalculate(n),this.terrain&&this.terrain.recalculate(n),this.fog&&this.fog.recalculate(n),this.z=n.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),f&&this.fire(new r.b("data",{dataType:"style"}))}_updateTilesForChangedImages(){const n=this._changes.getUpdatedImages();if(n.length){for(const a in this._sourceCaches)this._sourceCaches[a].reloadTilesForDependencies(["icons","patterns"],n);this._changes.resetUpdatedImages()}}_updateWorkerLayers(n,a,f){const _=this.getFragmentStyle(n);_&&this.dispatcher.broadcast("updateLayers",{layers:a?_._serializeLayers(a):[],scope:n,removedIds:f||[],options:_.options})}setState(n,a){if(this._checkLoaded(),Rs(this,Zt(n)))return!1;(n=r.c6(n)).layers=lp(n.layers);const f=function(w,S){if(!w)return[{command:Di.setStyle,args:[S]}];let C=[];try{if(!k(w.version,S.version))return[{command:Di.setStyle,args:[S]}];k(w.center,S.center)||C.push({command:Di.setCenter,args:[S.center]}),k(w.zoom,S.zoom)||C.push({command:Di.setZoom,args:[S.zoom]}),k(w.bearing,S.bearing)||C.push({command:Di.setBearing,args:[S.bearing]}),k(w.pitch,S.pitch)||C.push({command:Di.setPitch,args:[S.pitch]}),k(w.sprite,S.sprite)||C.push({command:Di.setSprite,args:[S.sprite]}),k(w.glyphs,S.glyphs)||C.push({command:Di.setGlyphs,args:[S.glyphs]}),k(w.imports,S.imports)||function(U=[],H=[],q){H=H||[];const Z=(U=U||[]).map(pa),$=H.map(pa),K=U.reduce(ml,{}),oe=H.reduce(ml,{}),se=Z.slice();let le,Y,ee,me;for(le=0,Y=0;le<Z.length;le++)ee=Z[le],oe.hasOwnProperty(ee)?Y++:(q.push({command:Di.removeImport,args:[ee]}),se.splice(se.indexOf(ee,Y),1));for(le=0,Y=0;le<$.length;le++)ee=$[$.length-1-le],se[se.length-1-le]!==ee&&(K.hasOwnProperty(ee)?(q.push({command:Di.removeImport,args:[ee]}),se.splice(se.lastIndexOf(ee,se.length-Y),1)):Y++,me=se[se.length-le],q.push({command:Di.addImport,args:[oe[ee],me]}),se.splice(se.length-le,0,ee));for(const fe of H){const xe=K[fe.id];xe&&!k(xe,fe)&&q.push({command:Di.updateImport,args:[fe.id,fe]})}}(w.imports,S.imports,C),k(w.transition,S.transition)||C.push({command:Di.setTransition,args:[S.transition]}),k(w.light,S.light)||C.push({command:Di.setLight,args:[S.light]}),k(w.fog,S.fog)||C.push({command:Di.setFog,args:[S.fog]}),k(w.projection,S.projection)||C.push({command:Di.setProjection,args:[S.projection]}),k(w.lights,S.lights)||C.push({command:Di.setLights,args:[S.lights]}),k(w.camera,S.camera)||C.push({command:Di.setCamera,args:[S.camera]});const D={},z=[];(function(U,H,q,Z){let $;for($ in H=H||{},U=U||{})U.hasOwnProperty($)&&(H.hasOwnProperty($)||Ih($,q,Z));for($ in H){if(!H.hasOwnProperty($))continue;const K=H[$];U.hasOwnProperty($)?k(U[$],K)||(U[$].type==="geojson"&&K.type==="geojson"&&Ch(U,H,$)?q.push({command:Di.setGeoJSONSourceData,args:[$,K.data]}):cp($,H,q,Z)):Bc($,H,q)}})(w.sources,S.sources,z,D);const O=[];w.layers&&w.layers.forEach(U=>{U.source&&D[U.source]?C.push({command:Di.removeLayer,args:[U.id]}):O.push(U)});let V=w.terrain;V&&D[V.source]&&(C.push({command:Di.setTerrain,args:[void 0]}),V=void 0),C=C.concat(z),k(V,S.terrain)||C.push({command:Di.setTerrain,args:[S.terrain]}),function(U,H,q){H=H||[];const Z=(U=U||[]).map(pa),$=H.map(pa),K=U.reduce(ml,{}),oe=H.reduce(ml,{}),se=Z.slice(),le=Object.create(null);let Y,ee,me,fe,xe,ke,ye;for(Y=0,ee=0;Y<Z.length;Y++)me=Z[Y],oe.hasOwnProperty(me)?ee++:(q.push({command:Di.removeLayer,args:[me]}),se.splice(se.indexOf(me,ee),1));for(Y=0,ee=0;Y<$.length;Y++)me=$[$.length-1-Y],se[se.length-1-Y]!==me&&(K.hasOwnProperty(me)?(q.push({command:Di.removeLayer,args:[me]}),se.splice(se.lastIndexOf(me,se.length-ee),1)):ee++,ke=se[se.length-Y],q.push({command:Di.addLayer,args:[oe[me],ke]}),se.splice(se.length-Y,0,me),le[me]=!0);for(Y=0;Y<$.length;Y++)if(me=$[Y],fe=K[me],xe=oe[me],!le[me]&&!k(fe,xe))if(k(fe.source,xe.source)&&k(fe["source-layer"],xe["source-layer"])&&k(fe.type,xe.type)){for(ye in Lo(fe.layout,xe.layout,q,me,null,Di.setLayoutProperty),Lo(fe.paint,xe.paint,q,me,null,Di.setPaintProperty),k(fe.slot,xe.slot)||q.push({command:Di.setSlot,args:[me,xe.slot]}),k(fe.filter,xe.filter)||q.push({command:Di.setFilter,args:[me,xe.filter]}),k(fe.minzoom,xe.minzoom)&&k(fe.maxzoom,xe.maxzoom)||q.push({command:Di.setLayerZoomRange,args:[me,xe.minzoom,xe.maxzoom]}),fe)fe.hasOwnProperty(ye)&&ye!=="layout"&&ye!=="paint"&&ye!=="filter"&&ye!=="metadata"&&ye!=="minzoom"&&ye!=="maxzoom"&&ye!=="slot"&&(ye.indexOf("paint.")===0?Lo(fe[ye],xe[ye],q,me,ye.slice(6),Di.setPaintProperty):k(fe[ye],xe[ye])||q.push({command:Di.setLayerProperty,args:[me,ye,xe[ye]]}));for(ye in xe)xe.hasOwnProperty(ye)&&!fe.hasOwnProperty(ye)&&ye!=="layout"&&ye!=="paint"&&ye!=="filter"&&ye!=="metadata"&&ye!=="minzoom"&&ye!=="maxzoom"&&ye!=="slot"&&(ye.indexOf("paint.")===0?Lo(fe[ye],xe[ye],q,me,ye.slice(6),Di.setPaintProperty):k(fe[ye],xe[ye])||q.push({command:Di.setLayerProperty,args:[me,ye,xe[ye]]}))}else q.push({command:Di.removeLayer,args:[me]}),ke=se[se.lastIndexOf(me)+1],q.push({command:Di.addLayer,args:[xe,ke]})}(O,S.layers,C)}catch(D){console.warn("Unable to compute style diff:",D),C=[{command:Di.setStyle,args:[S]}]}return C}(this.serialize(),n).filter(w=>!(w.command in hg));if(f.length===0)return!1;const _=f.filter(w=>!(w.command in yp));if(_.length>0)throw new Error(`Unimplemented: ${_.map(w=>w.command).join(", ")}.`);const x=[];return f.forEach(w=>{x.push(this[w.command].apply(this,w.args))}),a&&Promise.all(x).then(a),this.stylesheet=n,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}addImage(n,a){return this.getImage(n)?this.fire(new r.a(new Error("An image with this name already exists."))):(this.imageManager.addImage(n,this.scope,a),this._afterImageUpdated(n),this)}updateImage(n,a){this.imageManager.updateImage(n,this.scope,a)}getImage(n){return this.imageManager.getImage(n,this.scope)}removeImage(n){return this.getImage(n)?(this.imageManager.removeImage(n,this.scope),this._afterImageUpdated(n),this):this.fire(new r.a(new Error("No image with this name exists.")))}_afterImageUpdated(n){this._availableImages=this.imageManager.listImages(this.scope),this._changes.updateImage(n),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.fire(new r.b("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(n,a,f={}){return this._checkLoaded(),this._validate(Dt,`models.${n}`,a,null,f)||(this.modelManager.addModel(n,a,this.scope),this._changes.setDirty()),this}hasModel(n){return this.modelManager.hasModel(n,this.scope)}removeModel(n){return this.hasModel(n)?(this.modelManager.removeModel(n,this.scope),this):this.fire(new r.a(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(n,a,f={}){if(this._checkLoaded(),this.getOwnSource(n)!==void 0)throw new Error(`There is already a source with ID "${n}".`);if(!a.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(a).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(a.type)>=0&&this._validate(dl,`sources.${n}`,a,null,f))return;this.map&&this.map._collectResourceTiming&&(a.collectResourceTiming=!0);const _=Sh(n,a,this.dispatcher,this);_.scope=this.scope,_.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(_.id),source:_.serialize(),sourceId:_.id}));const x=w=>{const S=(w?"symbol:":"other:")+_.id,C=r.aj(S,this.scope),D=this._sourceCaches[S]=new ms(C,_,w);(w?this._symbolSourceCaches:this._otherSourceCaches)[_.id]=D,D.onAdd(this.map)};x(!1),a.type!=="vector"&&a.type!=="geojson"||x(!0),_.onAdd&&_.onAdd(this.map),f.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(n){this._checkLoaded();const a=this.getOwnSource(n);if(!a)throw new Error("There is no source with this ID");for(const _ in this._layers)if(this._layers[_].source===n)return this.fire(new r.a(new Error(`Source "${n}" cannot be removed while layer "${_}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===n)return this.fire(new r.a(new Error(`Source "${n}" cannot be removed while terrain is using it.`)));const f=this.getOwnSourceCaches(n);for(const _ of f){const x=r.c8(_.id);delete this._sourceCaches[x],this._changes.discardSourceCacheUpdate(_.id),_.fire(new r.b("data",{sourceDataType:"metadata",dataType:"source",sourceId:_.getSource().id})),_.setEventedParent(null),_.clearTiles()}return delete this._otherSourceCaches[n],delete this._symbolSourceCaches[n],this.mergeSources(),a.setEventedParent(null),a.onRemove&&a.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(n,a){this._checkLoaded(),this.getOwnSource(n).setData(a),this._changes.setDirty()}getOwnSource(n){const a=this.getOwnSourceCache(n);return a&&a.getSource()}getOwnSources(){const n=[];for(const a in this._otherSourceCaches){const f=this.getOwnSourceCache(a);f&&n.push(f.getSource())}return n}areTilesLoaded(){const n=this._mergedSourceCaches;for(const a in n){const f=n[a]._tiles;for(const _ in f){const x=f[_];if(x.state!=="loaded"&&x.state!=="errored")return!1}}return!0}setLights(n){if(this._checkLoaded(),!n)return delete this.ambientLight,void delete this.directionalLight;const a=this._getTransitionParameters();for(const _ of n){if(this._validate(rt,"lights",_))return;switch(_.type){case"ambient":if(this.ambientLight){const x=this.ambientLight;x.set(_),x.updateTransitions(a)}else this.ambientLight=new wr(_,ds,this.scope,this.options);break;case"directional":if(this.directionalLight){const x=this.directionalLight;x.set(_),x.updateTransitions(a)}else this.directionalLight=new wr(_,Un,this.scope,this.options)}}const f=new r.N(this.z||0,a);this.ambientLight&&this.ambientLight.recalculate(f),this.directionalLight&&this.directionalLight.recalculate(f),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const n=this.directionalLight,a=this.ambientLight;if(!n||!a)return;const f=O=>.2126*(O[0]<=.03928?O[0]/12.92:Math.pow((O[0]+.055)/1.055,2.4))+.7152*(O[1]<=.03928?O[1]/12.92:Math.pow((O[1]+.055)/1.055,2.4))+.0722*(O[2]<=.03928?O[2]/12.92:Math.pow((O[2]+.055)/1.055,2.4)),_=n.properties.get("color").toArray01(),x=n.properties.get("intensity"),w=n.properties.get("direction"),S=1-r.bT(w.x,w.y,w.z)[2]/90,C=f(_)*x*S,D=a.properties.get("color").toArray01(),z=a.properties.get("intensity");return(C+f(D)*z)/2}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const n=[];return this.directionalLight&&n.push(this.directionalLight.get()),this.ambientLight&&n.push(this.ambientLight.get()),n}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(n){if(!n)return this;if(r.c9(n)){const a=r.ca(n),f=this.fragments.find(({id:x})=>x===a);if(!f)throw new Error(`Style import not found: ${n}`);const _=r.c8(n);return f.style.getFragmentStyle(_)}{const a=this.fragments.find(({id:f})=>f===n);if(!a)throw new Error(`Style import not found: ${n}`);return a.style}}getConfigProperty(n,a){const f=this.getFragmentStyle(n);if(!f)return null;const _=r.aj(a,f.scope),x=f.options.get(_),w=x?x.value||x.default:null;return w?w.serialize():null}setConfigProperty(n,a,f){const _=this.getFragmentStyle(n);if(!_)return;const x=_.stylesheet.schema;if(!x||!x[a])return;const w=r.t(f);if(w.result!=="success")return void Rs(this,w.value);const S=w.value.expression,C=r.aj(a,_.scope),D=_.options.get(C);if(!D)return;let z;const{minValue:O,maxValue:V,stepValue:U,type:H,values:q}=x[a],Z=r.t(x[a].default);Z.result==="success"&&(z=Z.value.expression),z?(this.options.set(C,{...D,value:S,default:z,minValue:O,maxValue:V,stepValue:U,type:H,values:q}),this.updateConfigDependencies()):this.fire(new r.a(new Error(`No schema defined for the config option "${a}" in the "${n}" fragment.`)))}getConfig(n){const a=this.getFragmentStyle(n);if(!a)return null;const f=a.stylesheet.schema;if(!f)return null;const _={};for(const x in f){const w=r.aj(x,a.scope),S=a.options.get(w),C=S?S.value||S.default:null;_[x]=C?C.serialize():null}return _}setConfig(n,a){const f=this.getFragmentStyle(n);f&&(f.updateConfig(a,f.stylesheet.schema),this.updateConfigDependencies())}getSchema(n){const a=this.getFragmentStyle(n);return a?a.stylesheet.schema:null}setSchema(n,a){const f=this.getFragmentStyle(n);f&&(f.stylesheet.schema=a,f.updateConfig(f._config,a),this.updateConfigDependencies())}updateConfig(n,a){if(this._config=n,n||a)if(a)for(const f in a){let _,x;const w=r.t(a[f].default);if(w.result==="success"&&(_=w.value.expression),n&&n[f]!==void 0){const V=r.t(n[f]);V.result==="success"&&(x=V.value.expression)}const{minValue:S,maxValue:C,stepValue:D,type:z,values:O}=a[f];if(_){const V=r.aj(f,this.scope);this.options.set(V,{default:_,value:x,minValue:S,maxValue:C,stepValue:D,type:z,values:O})}else this.fire(new r.a(new Error(`No schema defined for config option "${f}".`)))}else this.fire(new r.a(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(){for(const n of this._configDependentLayers){const a=this.getLayer(n);a&&(a.possiblyEvaluateVisibility(),this._updateLayer(a))}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this._changes.setDirty()}addLayer(n,a,f={}){this._checkLoaded();const _=n.id;if(this._layers[_])return void this.fire(new r.a(new Error(`Layer with id "${_}" already exists on this map`)));let x;if(n.type==="custom"){if(Rs(this,r.cb(n)))return;x=r.c7(n,this.scope,this.options)}else{if(typeof n.source=="object"&&(this.addSource(_,n.source),n=r.c6(n),n=r.e(n,{source:_})),this._validate(be,`layers.${_}`,n,{arrayIndex:-1},f))return;x=r.c7(n,this.scope,this.options),this._validateLayer(x),x.setEventedParent(this,{layer:{id:_}}),this._serializedLayers[x.id]=x.serialize()}x.isConfigDependent&&this._configDependentLayers.add(x.fqid);let w=this._order.length;if(a){const z=this._order.indexOf(a);if(z===-1)return void this.fire(new r.a(new Error(`Layer with id "${a}" does not exist on this map.`)));x.slot===this._layers[a].slot?w=z:r.w(`Layer with id "${a}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(w,0,_),this._layerOrderChanged=!0,this._layers[_]=x;const S=this.getOwnLayerSourceCache(x),C=!!this.directionalLight&&this.directionalLight.shadowsEnabled();S&&x.canCastShadows()&&C&&(S.castsShadows=!0);const D=this._changes.getRemovedLayer(x);if(D&&x.source&&S&&x.type!=="custom"){this._changes.discardLayerRemoval(x);const z=r.aj(x.source,x.scope);D.type!==x.type?this._changes.updateSourceCache(z,"clear"):(this._changes.updateSourceCache(z,"reload"),S.pause())}this._updateLayer(x),x.onAdd&&x.onAdd(this.map),x.scope=this.scope,this.mergeLayers()}moveLayer(n,a){this._checkLoaded();const f=this._checkLayer(n);if(!f||n===a)return;const _=this._order.indexOf(n);this._order.splice(_,1);let x=this._order.length;if(a){const w=this._order.indexOf(a);if(w===-1)return void this.fire(new r.a(new Error(`Layer with id "${a}" does not exist on this map.`)));f.slot===this._layers[a].slot?x=w:r.w(`Layer with id "${a}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(x,0,n),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(n){this._checkLoaded();const a=this._checkLayer(n);if(!a)return;a.setEventedParent(null);const f=this._order.indexOf(n);this._order.splice(f,1),delete this._layers[n],delete this._serializedLayers[n],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(a.fqid),this._changes.removeLayer(a);const _=this.getOwnLayerSourceCache(a);if(_&&_.castsShadows){let x=!1;for(const w in this._layers)if(this._layers[w].source===a.source&&this._layers[w].canCastShadows()){x=!0;break}_.castsShadows=x}a.onRemove&&a.onRemove(this.map),this.mergeLayers()}getOwnLayer(n){return this._layers[n]}hasLayer(n){return n in this._mergedLayers}hasLayerType(n){for(const a in this._layers)if(this._layers[a].type===n)return!0;return!1}setLayerZoomRange(n,a,f){this._checkLoaded();const _=this._checkLayer(n);_&&(_.minzoom===a&&_.maxzoom===f||(a!=null&&(_.minzoom=a),f!=null&&(_.maxzoom=f),this._updateLayer(_)))}setSlot(n,a){this._checkLoaded();const f=this._checkLayer(n);f&&f.slot!==a&&(f.slot=a,this._updateLayer(f))}setFilter(n,a,f={}){this._checkLoaded();const _=this._checkLayer(n);if(_&&!k(_.filter,a))return a==null?(_.filter=void 0,void this._updateLayer(_)):void(this._validate($e,`layers.${_.id}.filter`,a,{layerType:_.type},f)||(_.filter=r.c6(a),this._updateLayer(_)))}getFilter(n){const a=this._checkLayer(n);if(a)return r.c6(a.filter)}setLayoutProperty(n,a,f,_={}){this._checkLoaded();const x=this._checkLayer(n);if(x&&!k(x.getLayoutProperty(a),f)){if(f!=null&&(!_||_.validate!==!1)&&Rs(x,ot.call(Zt,{key:`layers.${n}.layout.${a}`,layerType:x.type,objectKey:a,value:f,styleSpec:r.G,style:{glyphs:!0,sprite:!0}})))return;x.setLayoutProperty(a,f),x.isConfigDependent&&this._configDependentLayers.add(x.fqid),this._updateLayer(x)}}getLayoutProperty(n,a){const f=this._checkLayer(n);if(f)return f.getLayoutProperty(a)}setPaintProperty(n,a,f,_={}){this._checkLoaded();const x=this._checkLayer(n);if(!x||k(x.getPaintProperty(a),f)||f!=null&&(!_||_.validate!==!1)&&Rs(x,Ke.call(Zt,{key:`layers.${n}.paint.${a}`,layerType:x.type,objectKey:a,value:f,styleSpec:r.G})))return;const w=x.setPaintProperty(a,f);x.isConfigDependent&&this._configDependentLayers.add(x.fqid),w&&this._updateLayer(x),this._changes.updatePaintProperties(x)}getPaintProperty(n,a){const f=this._checkLayer(n);if(f)return f.getPaintProperty(a)}setFeatureState(n,a){this._checkLoaded();const f=n.source,_=n.sourceLayer,x=this._checkSource(f);if(!x)return;const w=x.type;if(w==="geojson"&&_)return void this.fire(new r.a(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(w==="vector"&&!_)return void this.fire(new r.a(new Error("The sourceLayer parameter must be provided for vector source types.")));n.id===void 0&&this.fire(new r.a(new Error("The feature id parameter must be provided.")));const S=this.getOwnSourceCaches(f);for(const C of S)C.setFeatureState(_,n.id,a)}removeFeatureState(n,a){this._checkLoaded();const f=n.source,_=this._checkSource(f);if(!_)return;const x=_.type,w=x==="vector"?n.sourceLayer:void 0;if(x==="vector"&&!w)return void this.fire(new r.a(new Error("The sourceLayer parameter must be provided for vector source types.")));if(a&&typeof n.id!="string"&&typeof n.id!="number")return void this.fire(new r.a(new Error("A feature id is required to remove its specific state property.")));const S=this.getOwnSourceCaches(f);for(const C of S)C.removeFeatureState(w,n.id,a)}getFeatureState(n){this._checkLoaded();const a=n.source,f=n.sourceLayer,_=this._checkSource(a);if(_){if(_.type!=="vector"||f)return n.id===void 0&&this.fire(new r.a(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(a)[0].getFeatureState(f,n.id);this.fire(new r.a(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(n){return this.stylesheet.transition=r.e({},this.stylesheet.transition,n),this.transition=this.stylesheet.transition,this}getTransition(){return r.e({},this.stylesheet.transition)}serialize(){this._checkLoaded();const n=this.getTerrain(),a=n&&this.terrain&&this.terrain.scope===this.scope?n:this.stylesheet.terrain;return r.cc({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:a,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},f=>f!==void 0)}_updateLayer(n){this._changes.updateLayer(n);const a=this.getLayerSourceCache(n),f=r.aj(n.source,n.scope),_=this._changes.getUpdatedSourceCaches();n.source&&!_[f]&&a&&a.getSource().type!=="raster"&&(this._changes.updateSourceCache(f,"reload"),a.pause()),n.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(n){const a=S=>this._mergedLayers[S].type==="fill-extrusion"||this._mergedLayers[S].type==="model",f=this.order,_={},x=[];for(let S=f.length-1;S>=0;S--){const C=f[S];if(a(C)){_[C]=S;for(const D of n){const z=D[C];if(z)for(const O of z)x.push(O)}}}x.sort((S,C)=>C.intersectionZ-S.intersectionZ);const w=[];for(let S=f.length-1;S>=0;S--){const C=f[S];if(a(C))for(let D=x.length-1;D>=0;D--){const z=x[D].feature;if(_[z.layer.id]<S)break;w.push(z),x.pop()}else for(const D of n){const z=D[C];if(z)for(const O of z)w.push(O.feature)}}return w}queryRenderedFeatures(n,a,f){a&&a.filter&&this._validate($e,"queryRenderedFeatures.filter",a.filter,null,a),a.scope=this.scope,a.availableImages=this._availableImages,a.serializedLayers=this._serializedLayers;const _={};if(a&&a.layers){if(!Array.isArray(a.layers))return this.fire(new r.a(new Error("parameters.layers must be an Array."))),[];for(const D of a.layers){const z=this._mergedLayers[D];if(!z)return this.fire(new r.a(new Error(`The layer '${D}' does not exist in the map's style and cannot be queried for features.`))),[];_[z.source]=!0}}const x=[],w=a.serializedLayers||{},S=a&&a.layers?a.layers.some(D=>{const z=this.getLayer(D);return z&&z.is3D()}):this.has3DLayers(),C=vn.createFromScreenPoints(n,f);for(const D in this._mergedSourceCaches){const z=this._mergedSourceCaches[D].getSource();if(!z||z.scope!==a.scope)continue;const O=this._mergedSourceCaches[D].getSource().id;a.layers&&!_[O]||x.push(Si(this._mergedSourceCaches[D],this._mergedLayers,w,C,a,f,S,!!this.map._showQueryGeometry))}return this.placement&&x.push(function(D,z,O,V,U,H,q){const Z={},$=H.queryRenderedSymbols(V),K=[];for(const oe of Object.keys($).map(Number))K.push(q[oe]);K.sort(op);for(const oe of K){const se=oe.featureIndex.lookupSymbolFeatures($[oe.bucketInstanceId],z,oe.bucketIndex,oe.sourceLayerIndex,U.filter,U.layers,U.availableImages,D);for(const le in se){const Y=Z[le]=Z[le]||[],ee=se[le];ee.sort((me,fe)=>{const xe=oe.featureSortOrder;if(xe){const ke=xe.indexOf(me.featureIndex);return xe.indexOf(fe.featureIndex)-ke}return fe.featureIndex-me.featureIndex});for(const me of ee)Y.push(me)}}for(const oe in Z)Z[oe].forEach(se=>{const le=se.feature,Y=O(D[oe]);if(!Y)return;const ee=Y.getFeatureState(le.layer["source-layer"],le.id);le.source=le.layer.source,le.layer["source-layer"]&&(le.sourceLayer=le.layer["source-layer"]),le.state=ee});return Z}(this._mergedLayers,w,this.getLayerSourceCache.bind(this),C.screenGeometry,a,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(x)}querySourceFeatures(n,a){a&&a.filter&&this._validate($e,"querySourceFeatures.filter",a.filter,null,a);const f=this.getOwnSourceCaches(n);let _=[];for(const x of f)_=_.concat(kr(x,a));return _}addSourceType(n,a,f){return ys.getSourceType(n)?f(new Error(`A source type called "${n}" already exists.`)):(ys.setSourceType(n,a),a.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:n,url:a.workerSourceURL},f):f(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(n,a,f={}){this._checkLoaded();const _=this.light.getLight();let x=!1;for(const S in n)if(!k(n[S],_[S])){x=!0;break}if(!x)return;const w=this._getTransitionParameters();this.light.setLight(n,a,f),this.light.updateTransitions(w)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}setTerrain(n,a=1){if(this._checkLoaded(),!n)return this.terrainSetForDrapingOnly()&&a!==0||delete this.terrain,n===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);let f=n;const _=n.source==null;if(a===1){if(typeof f.source=="object"){const S="terrain-dem-src";this.addSource(S,f.source),f=r.c6(f),f=r.e(f,{source:S})}const x=r.e({},f),w={};if(this.terrain&&_){x.source=this.terrain.get().source;const S=this.terrain?this.getFragmentStyle(this.terrain.scope):null;S&&(w.style=S.serialize())}if(this._validate(ne,"terrain",x,w))return}if(!this.terrain||this.terrain.scope!==this.scope&&!_||this.terrain&&a!==this.terrain.drapeRenderMode){if(!f)return;this._createTerrain(f,a),this.fire(new r.b("data",{dataType:"style"}))}else{const x=this.terrain,w=x.get();for(const S of Object.keys(r.G.terrain))!f.hasOwnProperty(S)&&r.G.terrain[S].default&&(f[S]=r.G.terrain[S].default);for(const S in n)if(!k(n[S],w[S])){x.set(n,this.options),this.stylesheet.terrain=n;const C=this._getTransitionParameters({duration:0});x.updateTransitions(C),this.fire(new r.b("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(n){const a=this.fog=new Cr(n,this.map.transform,this.scope,this.options);this.stylesheet.fog=a.get();const f=this._getTransitionParameters({duration:0});a.updateTransitions(f)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask(()=>{for(const n of this.map._markers)n._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(n){if(this._checkLoaded(),!n)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const a=this.fog;if(!k(a.get(),n)){a.set(n,this.options),this.stylesheet.fog=a.get();const f=this._getTransitionParameters({duration:0});a.updateTransitions(f)}}else this._createFog(n);this._markersNeedUpdate=!0}_getTransitionParameters(n){return{now:r.f.now(),transition:r.e(this.transition,n)}}updateDrapeFirstLayers(){if(!this.terrain)return;const n=[],a=[];for(const f in this._mergedLayers)this.isLayerDraped(this._mergedLayers[f])?n.push(f):a.push(f);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...n),this._drapedFirstOrder.push(...a)}_createTerrain(n,a){const f=this.terrain=new $i(n,a,this.scope,this.options);a===1&&(this.stylesheet.terrain=n),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const _=this._getTransitionParameters({duration:0});f.updateTransitions(_)}_force3DLayerUpdate(){for(const n in this._layers){const a=this._layers[n];a.type==="fill-extrusion"&&this._updateLayer(a)}}_forceSymbolLayerUpdate(){for(const n in this._layers){const a=this._layers[n];a.type==="symbol"&&this._updateLayer(a)}}_validate(n,a,f,_,x={}){if(x&&x.validate===!1)return!1;const w=r.e({},this.serialize());return Rs(this,n.call(Zt,r.e({key:a,style:w,value:f,styleSpec:r.G},_)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),r.cd.off("pluginStateChange",this._rtlTextPluginCallback);for(const n in this._mergedLayers)this._mergedLayers[n].setEventedParent(null);for(const n in this._mergedSourceCaches)this._mergedSourceCaches[n].clearTiles(),this._mergedSourceCaches[n].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(n){const a=this.getSourceCaches(n);for(const f of a)f.clearTiles()}clearSources(){for(const n in this._mergedSourceCaches)this._mergedSourceCaches[n].clearTiles()}reloadSource(n){const a=this.getSourceCaches(n);for(const f of a)f.resume(),f.reload()}reloadSources(){for(const n of this.getSources())n.reload&&n.reload()}updateSources(n){let a;this.directionalLight&&(a=eu(this.directionalLight));for(const f in this._mergedSourceCaches)this._mergedSourceCaches[f].update(n,void 0,void 0,a)}_generateCollisionBoxes(){for(const n in this._sourceCaches){const a=this._sourceCaches[n];a.resume(),a.reload()}}_updatePlacement(n,a,f,_,x=!1){let w=!1,S=!1;const C={},D={};for(const z of this._mergedOrder){const O=this._mergedLayers[z];if(O.type!=="symbol")continue;const V=r.aj(O.source,O.scope);let U=C[V];if(!U){const q=this.getLayerSourceCache(O);if(!q)continue;const Z=q.getRenderableIds(!0).map($=>q.getTileByID($));D[V]=Z.slice(),U=C[V]=Z.sort(($,K)=>K.tileID.overscaledZ-$.tileID.overscaledZ||($.tileID.isLessThan(K.tileID)?-1:1))}const H=this.crossTileSymbolIndex.addLayer(O,U,n.center.lng,n.projection);w=w||H}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),x=x||this._layerOrderChanged||f===0,this._layerOrderChanged&&this.fire(new r.b("neworder")),(x||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(r.f.now(),n.zoom))&&(this.pauseablePlacement=new bl(n,this._mergedOrder,x,a,f,_,this.placement,this.fog&&n.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,C,D),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(r.f.now()),S=!0),w&&this.pauseablePlacement.placement.setStale()),S||w){this._buildingIndex.onNewFrame(n.zoom);for(const z of this._mergedOrder){const O=this._mergedLayers[z];O.type==="symbol"&&this.placement.updateLayerOpacities(O,C[r.aj(O.source,O.scope)])}}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(r.f.now())}_releaseSymbolFadeTiles(){for(const n in this._sourceCaches)this._sourceCaches[n].releaseSymbolFadeTiles()}addImport(n,a){this._checkLoaded();const f=this.stylesheet.imports=this.stylesheet.imports||[];if(f.findIndex(({id:x})=>x===n.id)!==-1)return void this.fire(new r.a(new Error(`Import with id '${n.id}' already exists in the map's style.`)));if(!a)return f.push(n),this._loadImports([n],!0);const _=f.findIndex(({id:x})=>x===a);return _===-1&&this.fire(new r.a(new Error(`Import with id "${a}" does not exist on this map.`))),this.stylesheet.imports=f.slice(0,_).concat(n).concat(f.slice(_)),this._loadImports([n],!0,a)}updateImport(n,a){this._checkLoaded();const f=this.stylesheet.imports||[],_=this.getImportIndex(n);return _===-1?this:typeof a=="string"?(this.setImportUrl(n,a),this):(a.url&&a.url!==f[_].url&&this.setImportUrl(n,a.url),k(a.config,f[_].config)||this.setImportConfig(n,a.config),k(a.data,f[_].data)||this.setImportData(n,a.data),this)}moveImport(n,a){this._checkLoaded();let f=this.stylesheet.imports||[];const _=this.getImportIndex(n);if(_===-1)return this;const x=this.getImportIndex(a);if(x===-1)return this;const w=f[_],S=this.fragments[_];return f=f.filter(({id:C})=>C!==n),this.fragments=this.fragments.filter(({id:C})=>C!==n),this.stylesheet.imports=f.slice(0,x).concat(w).concat(f.slice(x)),this.fragments=this.fragments.slice(0,x).concat(S).concat(this.fragments.slice(x)),this.mergeLayers(),this}setImportUrl(n,a){this._checkLoaded();const f=this.stylesheet.imports||[],_=this.getImportIndex(n);if(_===-1)return this;f[_].url=a;const x=this.fragments[_];return x.style=this._createFragmentStyle(f[_]),x.style.on("style.import.load",()=>this.mergeAll()),x.style.loadURL(a),this}setImportData(n,a){this._checkLoaded();const f=this.getImportIndex(n),_=this.stylesheet.imports||[];return f===-1?this:a?(this.fragments[f].style.setState(a),this._reloadImports(),this):(delete _[f].data,this.setImportUrl(n,_[f].url))}setImportConfig(n,a){this._checkLoaded();const f=this.getImportIndex(n),_=this.stylesheet.imports||[];if(f===-1)return this;a?_[f].config=a:delete _[f].config;const x=this.fragments[f],w=x.style.stylesheet&&x.style.stylesheet.schema;return x.config=a,x.style.updateConfig(a,w),this.updateConfigDependencies(),this}removeImport(n){this._checkLoaded();const a=this.stylesheet.imports||[],f=this.getImportIndex(n);f!==-1&&(a.splice(f,1),this.fragments[f].style._remove(),this.fragments.splice(f,1),this._reloadImports())}getImportIndex(n){const a=(this.stylesheet.imports||[]).findIndex(f=>f.id===n);return a===-1&&this.fire(new r.a(new Error(`Import '${n}' does not exist in the map's style and cannot be updated.`))),a}getLayer(n){return this._mergedLayers[n]}getSources(){const n=[];for(const a in this._mergedOtherSourceCaches){const f=this._mergedOtherSourceCaches[a];f&&n.push(f.getSource())}return n}getSource(n,a){const f=this.getSourceCache(n,a);return f&&f.getSource()}getLayerSource(n){const a=this.getLayerSourceCache(n);return a&&a.getSource()}getSourceCache(n,a){const f=r.aj(n,a);return this._mergedOtherSourceCaches[f]}getLayerSourceCache(n){const a=r.aj(n.source,n.scope);return n.type==="symbol"?this._mergedSymbolSourceCaches[a]:this._mergedOtherSourceCaches[a]}getSourceCaches(n){if(n==null)return Object.values(this._mergedSourceCaches);const a=[];return this._mergedOtherSourceCaches[n]&&a.push(this._mergedOtherSourceCaches[n]),this._mergedSymbolSourceCaches[n]&&a.push(this._mergedSymbolSourceCaches[n]),a}updateSourceCaches(){const n=this._changes.getUpdatedSourceCaches();for(const a in n){const f=n[a];f==="reload"?this.reloadSource(a):f==="clear"&&this.clearSource(a)}}updateLayers(n){const a=this._changes.getUpdatedPaintProperties();for(const f of a){const _=this.getLayer(f);_&&_.updateTransitions(n)}}getImages(n,a,f){this.imageManager.getImages(a.icons,a.scope,f),this._updateTilesForChangedImages();const _=x=>{x&&x.setDependencies(a.tileID.key,a.type,a.icons)};_(this._otherSourceCaches[a.source]),_(this._symbolSourceCaches[a.source])}getGlyphs(n,a,f){this.glyphManager.getGlyphs(a.stacks,a.scope,f)}getResource(n,a,f){return r.ce(a,f)}getOwnSourceCache(n){return this._otherSourceCaches[n]}getOwnLayerSourceCache(n){return n.type==="symbol"?this._symbolSourceCaches[n.source]:this._otherSourceCaches[n.source]}getOwnSourceCaches(n){const a=[];return this._otherSourceCaches[n]&&a.push(this._otherSourceCaches[n]),this._symbolSourceCaches[n]&&a.push(this._symbolSourceCaches[n]),a}_isSourceCacheLoaded(n){const a=this.getOwnSourceCaches(n);return a.length===0?(this.fire(new r.a(new Error(`There is no source with ID '${n}'`))),!1):a.every(f=>f.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(n=>{n.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}ys.getSourceType=function(d){return ft[d]},ys.setSourceType=function(d,n){ft[d]=n},ys.registerForPluginStateChange=r.bY;var Sl=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,Gh=`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec2 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color) {
#ifdef INDICATOR_CUTOUT
float holeMinOpacity=u_indicator_cutout_params.x;float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,vec2 pos,vec2 lod_coord) {vec2 size=vec2(textureSize(image,0));vec2 dx=dFdx(lod_coord.xy*size);vec2 dy=dFdy(lod_coord.xy*size);float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}`,iu=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}`,mo="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",nu=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(
unpack_depth(texture(u_depth,uv-df.xz)),unpack_depth(texture(u_depth,uv+df.xz)),unpack_depth(texture(u_depth,uv-df.zy)),unpack_depth(texture(u_depth,uv+df.zy))
);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }
#endif`,No=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,Wh=`highp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}
#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {
#ifdef FOG_DITHERING
vec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);
#else
return color;
#endif
}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,El=`#ifdef RASTER_ARRAY
uniform sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,ru=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec4 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=vec2(u_data_offset+dot(t.rg,u_data_scale.yx),-(u_data_offset+dot(t.ba,u_data_scale.yx)));velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,Al=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,su=`#ifdef RENDER_SHADOWS
#ifdef DEPTH_TEXTURE
uniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;
#else
uniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;
#endif
uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_1,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;
#ifdef DEPTH_TEXTURE
shadow_depth=texture(u_shadowmap_0,uv).r;
#else
shadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;
#endif
return step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;
#ifdef NATIVE
highp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));
#else
highp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(
shadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)
);
#endif
vec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return mix(lerpx.x,lerpx.y,f.y);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {
#ifdef SHADOWS_SINGLE_CASCADE
light_view_pos0.xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);
#else
light_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth));
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;const Bi=[];_o(Sl,Bi),_o(iu,Bi),_o(Gh,Bi);const hi={"_prelude_fog.vertex.glsl":No,"_prelude_terrain.vertex.glsl":nu,"_prelude_shadow.vertex.glsl":Al,"_prelude_fog.fragment.glsl":Wh,"_prelude_shadow.fragment.glsl":su,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":El,"_prelude_raster_particle.glsl":ru},Il={};mi("",nu),mi(Wh,No),mi(su,Al),mi(El,""),mi(ru,"");const Cl=mi(Gh,iu),ou=Sl;var xs={background:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in vec2 v_pos;void main() {vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),circle:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:mi("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:mi(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:mi(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:mi("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in float a_size_scale;in vec2 a_padding;in float a_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(a_z_offset+elevation(a_anchor_pos)),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:mi("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:mi("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),fill:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutline:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
in vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;in vec2 v_pos;uniform float u_emissive_strength;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
uniform float u_emissive_strength;in float v_height;void main() {
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,u_emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=max(0.01,cutoff_opacity(u_cutoff_params,ground.z));if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff < 0.01 && centroid_pos.x !=0.0));gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);v_flat=vec4(linearProduct(color.rgb,vec3(calculate_NdotL(normal))),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:mi(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_vertical_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
out highp float v_depth;void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base);pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
in vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 imagecoord=mod(v_pos,1.0);vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
out vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool flat_roof=centroid_pos.x !=0.0 && t > 0.0;ele=elevation(pos_nx.xy);c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif 
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:mi(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0)).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:mi(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(1.0,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:mi(`precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec4 v_uv;
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;alpha*=linearstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trimmed=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {out_color=vec4(0,0,0,0);trimmed=0.0;}}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=(border_width+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {    
float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color.rgb=mix(border_color.rgb*border_color.a*trimmed,out_color.rgb,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec4 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec4 v_uv;
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec4(a_uv_x,a_split_index*texel_height-half_texel_height,a_clip_start,a_clip_end);
#else
v_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/floorwidth,(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),linePattern:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform mediump float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec4 v_uv;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;vec2 pattern_size=vec2(display_size.x/u_tile_units_to_pixels,display_size.y);float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float pattern_x=v_linesofar/pattern_size.x*aspect;float x=mod(pattern_x,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef RENDER_LINE_TRIM_OFFSET
highp float start=v_uv[2];highp float end=v_uv[3];highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=(start+(v_uv.x)*(end-start));if (trim_end > trim_start) {if (line_progress <=trim_end && line_progress >=trim_start) {color=vec4(0,0,0,0);}}
#endif
#ifdef LINE_JOIN_NONE
float pattern_len=pattern_size.x/aspect;float segment_phase=pattern_len-mod((v_linesofar-v_pattern_data.x),pattern_len);float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_ground(color);
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
color=applyCutout(color);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec4 a_packed;
#endif
in float a_linesofar;
#ifdef LINE_JOIN_NONE
in vec2 a_pattern_data;out vec2 v_pattern_data;
#endif
uniform mat4 u_matrix;uniform mediump float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec4 v_uv;
#endif
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 pattern
#pragma mapbox: define lowp float pixel_ratio
void main() {
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
float a_uv_x=a_packed[0];highp float a_clip_start=a_packed[2];highp float a_clip_end=a_packed[3];v_uv=vec4(a_uv_x,0.0,a_clip_start,a_clip_end);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;
#ifdef LINE_JOIN_NONE
v_width+=ANTIALIASING;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5/u_tile_units_to_pixels;v_linesofar+=line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),raster:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:mi("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-vec2(1.0),0.0,1.0);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:mi("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:mi(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp float speed=velocity==INVALID_VELOCITY ? 0.0 : length(velocity);highp float reset_rate_bump=speed*u_reset_rate;highp vec2 particle_pos_min=-u_particle_pos_offset;highp vec2 particle_pos_max=vec2(1.0)+u_particle_pos_offset;highp vec2 pos_drop_rate=vec2(1.0)-step(particle_pos_min,pos)+step(particle_pos_max,pos);highp float drop_rate=max(u_reset_rate+reset_rate_bump,length(pos_drop_rate));highp float drop=step(1.0-drop_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbolIcon:mi(`#include "_prelude_lighting.glsl"
uniform sampler2D u_texture;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
in float v_fade_opacity;in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float emissive_strength
lowp float alpha=opacity*v_fade_opacity;vec4 out_color;
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
out_color*=alpha;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform vec3 u_up_vector;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_fade_opacity;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float emissive_strength
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjected_point;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetProjected_point=u_matrix*vec4(a_globe_anchor+displacement,1);
#else
offsetProjected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);
#endif
vec2 a=projected_point.xy/projected_point.w;vec2 b=offsetProjected_point.xy/offsetProjected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
v_tex_a=a_tex/u_texsize;
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
v_fade_opacity=out_fade_opacity;}`),symbolSDF:mi(`#include "_prelude_lighting.glsl"
#define SDF_PX 8.0
uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;in float v_draw_halo;in vec2 v_data0;in vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
float EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out float v_draw_halo;out vec2 v_data0;out vec3 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);
#endif
vec2 a=projected_point.xy/projected_point.w;vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,out_fade_opacity);}`),symbolTextAndIcon:mi(`#include "_prelude_lighting.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_halo;in float v_draw_halo;in vec4 v_data0;in vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
float fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);vec4 out_color=color*(alpha*opacity*fade_opacity);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out float v_draw_halo;out vec4 v_data0;out vec4 v_data1;
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos=mix_globe_mercator(a_globe_anchor+h,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offset_projected_point=u_matrix*vec4(a_pos+vec2(1,0),0,1);vec2 a=projected_point.xy/projected_point.w;vec2 b=offset_projected_point.xy/offset_projected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz+h,mercator_pos,u_zoom_transition);projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*font_scale);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
float occlusion_fade=occlusionFade(projected_point)*globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;
#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)
projection_transition_fade=1.0-step(EPSILON,u_zoom_transition);
#endif
float out_fade_opacity=interpolated_fade_opacity*projection_transition_fade;float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);
#else
gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);
#endif
float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,out_fade_opacity,is_sdf);}`),terrainRaster:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:mi("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:mi(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,mo),skyboxGradient:mi(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,mo),skyboxCapture:mi(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);vec3 dir=normalize(ray_dir);vec3 closest_point=dot(u_globe_pos,dir)*dir;float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(raster.rgb*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:mi(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;
#ifndef NATIVE
c=dither(c,gl_FragCoord.xy+u_temporal_offset);
#endif
glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:mi(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform sampler2D u_depthTexture;uniform vec2 u_inv_depth_size;bool isOccluded() {vec2 coord=gl_FragCoord.xy*u_inv_depth_size;highp float depth=unpack_depth(texture(u_depthTexture,coord));return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
return vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);color=mix(color,v_color_mix.rgb,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=u_matrix*pos;pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normalize(normal_3f));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:mi(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=u_matrix*pos;
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:mi(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`)};function _o(d,n){const a=d.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let f of a)if(f=f.trim(),f[0]==="#"&&f.includes("if")&&!f.includes("endif")){f=f.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const _=f.split(" ");for(const x of _)n.includes(x)||n.push(x)}}function mi(d,n){const a=/#include\s+"([^"]+)"/g,f=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let _=n.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);_&&(_=_.map(D=>{const z=D.split(" ");return z[z.length-1]}),_=[...new Set(_)]);const x={},w=[],S=[];if(d=d.replace(a,(D,z)=>(S.push(z),"")),(n=n.replace(a,(D,z)=>(w.push(z),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let C=[...Bi];_o(d,C),_o(n,C);for(const D of[...w,...S])hi[D]||console.error(`Undefined include: ${D}`),Il[D]||(Il[D]=[],_o(hi[D],Il[D])),C=[...C,...Il[D]];return{fragmentSource:d=d.replace(f,(D,z,O,V,U)=>(x[U]=!0,z==="define"?`
#ifndef HAS_UNIFORM_u_${U}
in ${O} ${V} ${U};
#else
uniform ${O} ${V} u_${U};
#endif
`:z==="initialize"?`
#ifdef HAS_UNIFORM_u_${U}
    ${O} ${V} ${U} = u_${U};
#endif
`:z==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${U}
    in ${O} ${V} ${U};
#endif
`:z==="initialize-attribute"?"":void 0)),vertexSource:n=n.replace(f,(D,z,O,V,U)=>{const H=V==="float"?"vec2":V,q=U.match(/color/)?"color":H;return z==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${U}
in ${O} ${V} a_${U};
#endif
`:x[U]?z==="define"?`
#ifndef HAS_UNIFORM_u_${U}
uniform lowp float u_${U}_t;
in ${O} ${H} a_${U};
out ${O} ${V} ${U};
#else
uniform ${O} ${V} u_${U};
#endif
`:z==="initialize"?q==="vec4"?`
#ifndef HAS_UNIFORM_u_${U}
    ${U} = a_${U};
#else
    ${O} ${V} ${U} = u_${U};
#endif
`:`
#ifndef HAS_UNIFORM_u_${U}
    ${U} = unpack_mix_${q}(a_${U}, u_${U}_t);
#else
    ${O} ${V} ${U} = u_${U};
#endif
`:z==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${U}
    in ${O} ${V} a_${U};
    out ${O} ${V} ${U};
#endif
`:z==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${U}
    ${U} = a_${U};
#endif
`:void 0:z==="define"?`
#ifndef HAS_UNIFORM_u_${U}
uniform lowp float u_${U}_t;
in ${O} ${H} a_${U};
#else
uniform ${O} ${V} u_${U};
#endif
`:z==="define-instanced"?q==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${U}0;
in vec4 a_${U}1;
in vec4 a_${U}2;
in vec4 a_${U}3;
#else
uniform ${O} ${V} u_${U};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${O} ${H} a_${U};
#else
uniform ${O} ${V} u_${U};
#endif
`:z==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${U}
    ${O} ${V} ${U} = a_${U};
#endif
`:q==="vec4"?`
#ifndef HAS_UNIFORM_u_${U}
    ${O} ${V} ${U} = a_${U};
#else
    ${O} ${V} ${U} = u_${U};
#endif
`:`
#ifndef HAS_UNIFORM_u_${U}
    ${O} ${V} ${U} = unpack_mix_${q}(a_${U}, u_${U}_t);
#else
    ${O} ${V} ${U} = u_${U};
#endif
`}),staticAttributes:_,usedDefines:C,vertexIncludes:w,fragmentIncludes:S}}class bt{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(n,a,f,_,x,w,S,C){this.context=n;let D=this.boundPaintVertexBuffers.length!==_.length;for(let O=0;!D&&O<_.length;O++)this.boundPaintVertexBuffers[O]!==_[O]&&(D=!0);let z=this.boundDynamicVertexBuffers.length!==S.length;for(let O=0;!z&&O<S.length;O++)this.boundDynamicVertexBuffers[O]!==S[O]&&(z=!0);if(!this.vao||this.boundProgram!==a||this.boundLayoutVertexBuffer!==f||D||z||this.boundIndexBuffer!==x||this.boundVertexOffset!==w)this.freshBind(a,f,_,x,w,S,C);else{n.bindVertexArrayOES.set(this.vao);for(const O of S)O&&(O.bind(),C&&O.instanceCount&&O.setVertexAttribDivisor(n.gl,a,C));x&&x.dynamicDraw&&x.bind()}}freshBind(n,a,f,_,x,w,S){const C=n.numAttributes,D=this.context,z=D.gl;this.vao&&this.destroy(),this.vao=D.gl.createVertexArray(),D.bindVertexArrayOES.set(this.vao),this.boundProgram=n,this.boundLayoutVertexBuffer=a,this.boundPaintVertexBuffers=f,this.boundIndexBuffer=_,this.boundVertexOffset=x,this.boundDynamicVertexBuffers=w,a.enableAttributes(z,n),a.bind(),a.setVertexAttribPointers(z,n,x);for(const O of f)O.enableAttributes(z,n),O.bind(),O.setVertexAttribPointers(z,n,x);for(const O of w)O&&(O.enableAttributes(z,n),O.bind(),O.setVertexAttribPointers(z,n,x),S&&O.instanceCount&&O.setVertexAttribDivisor(z,n,S));_&&_.bind(),D.currentNumAttributes=C}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function ki(d,n){const a=Math.pow(2,n.canonical.z),f=n.canonical.y;return[new r.O(0,f/a).toLngLat().lat,new r.O(0,(f+1)/a).toLngLat().lat]}function Ri(d,n,a,f,_,x,w){const S=d.context,C=S.gl,D=a.hillshadeFBO;if(!D)return;d.prepareDrawTile();const z=d.isTileAffectedByFog(n),O=d.getOrCreateProgram("hillshade",{overrideFog:z});S.activeTexture.set(C.TEXTURE0),C.bindTexture(C.TEXTURE_2D,D.colorAttachment.get());const V=((Z,$,K,oe)=>{const se=K.paint.get("hillshade-shadow-color"),le=K.paint.get("hillshade-highlight-color"),Y=K.paint.get("hillshade-accent-color"),ee=K.paint.get("hillshade-emissive-strength");let me=r.bm(K.paint.get("hillshade-illumination-direction"));if(K.paint.get("hillshade-illumination-anchor")==="viewport")me-=Z.transform.angle;else if(Z.style&&Z.style.enable3dLights()&&Z.style.directionalLight){const xe=Z.style.directionalLight.properties.get("direction"),ke=r.bT(xe.x,xe.y,xe.z);me=r.bm(ke[1])}const fe=!Z.options.moving;return{u_matrix:oe||Z.transform.calculateProjMatrix($.tileID.toUnwrapped(),fe),u_image:0,u_latrange:ki(0,$.tileID),u_light:[K.paint.get("hillshade-exaggeration"),me],u_shadow:se,u_highlight:le,u_emissive_strength:ee,u_accent:Y}})(d,a,f,d.terrain?n.projMatrix:null);d.uploadCommonUniforms(S,O,n.toUnwrapped());const{tileBoundsBuffer:U,tileBoundsIndexBuffer:H,tileBoundsSegments:q}=d.getTileBoundsBuffers(a);O.draw(d,C.TRIANGLES,_,x,w,Yt.disabled,V,f.id,U,H,q)}function $r(d,n,a){if(!n.needsDEMTextureUpload)return;const f=d.context,_=f.gl;f.pixelStoreUnpackPremultiplyAlpha.set(!1),n.demTexture=n.demTexture||d.getTileTexture(a.stride);const x=a.getPixels();n.demTexture?n.demTexture.update(x,{premultiply:!1}):n.demTexture=new r.T(f,x,_.R32F,{premultiply:!1}),n.needsDEMTextureUpload=!1}function wa(d,n,a){const f=d.context,_=f.gl;if(!n.dem)return;const x=n.dem;if(f.activeTexture.set(_.TEXTURE1),$r(d,n,x),!n.demTexture)return;n.demTexture.bind(_.NEAREST,_.CLAMP_TO_EDGE);const w=x.dim;f.activeTexture.set(_.TEXTURE0);let S=n.hillshadeFBO;if(!S){const V=new r.T(f,{width:w,height:w,data:null},_.RGBA);V.bind(_.LINEAR,_.CLAMP_TO_EDGE),S=n.hillshadeFBO=f.createFramebuffer(w,w,!0,"renderbuffer"),S.colorAttachment.set(V.texture)}f.bindFramebuffer.set(S.framebuffer),f.viewport.set([0,0,w,w]);const{tileBoundsBuffer:C,tileBoundsIndexBuffer:D,tileBoundsSegments:z}=d.getMercatorTileBoundsBuffers(),O=[];d.linearFloatFilteringSupported()&&O.push("TERRAIN_DEM_FLOAT_FORMAT"),d.getOrCreateProgram("hillshadePrepare",{defines:O}).draw(d,_.TRIANGLES,jt.disabled,ei.disabled,pi.unblended,Yt.disabled,((V,U)=>{const H=U.stride,q=r.a9.create();return r.a9.ortho(q,0,r.Y,-r.Y,0,0,1),r.a9.translate(q,q,[0,-r.Y,0]),{u_matrix:q,u_image:1,u_dimension:[H,H],u_zoom:V.overscaledZ}})(n.tileID,x),a.id,C,D,z),n.needsHillshadePrepare=!1}const Ei=d=>({u_matrix:new r.bN(d),u_image0:new r.bR(d),u_skirt_height:new r.bQ(d),u_ground_shadow_factor:new r.bP(d)}),Pl=(d,n,a)=>({u_matrix:d,u_image0:0,u_skirt_height:n,u_ground_shadow_factor:a}),Ta=(d,n,a,f,_,x,w,S,C,D,z,O,V,U,H,q)=>({u_proj_matrix:Float32Array.from(d),u_globe_matrix:n,u_normalize_matrix:Float32Array.from(f),u_merc_matrix:a,u_zoom_transition:_,u_merc_center:x,u_image0:0,u_frustum_tl:w,u_frustum_tr:S,u_frustum_br:C,u_frustum_bl:D,u_globe_pos:z,u_globe_radius:O,u_viewport:V,u_grid_matrix:q?Float32Array.from(q):new Float32Array(9),u_skirt_height:U,u_far_z_cutoff:H});function Ma(d,n){return d!=null&&n!=null&&!(!d.hasData()||!n.hasData())&&d.demTexture!=null&&n.demTexture!=null&&d.tileID.key!==n.tileID.key}const rr=new class{constructor(){this.operations={}}newMorphing(d,n,a,f,_){if(d in this.operations){const x=this.operations[d];x.to.tileID.key!==a.tileID.key&&(x.queued=a)}else this.operations[d]={startTime:f,phase:0,duration:_,from:n,to:a,queued:null}}getMorphValuesForProxy(d){if(!(d in this.operations))return null;const n=this.operations[d];return{from:n.from,to:n.to,phase:n.phase}}update(d){for(const n in this.operations){const a=this.operations[n];for(a.phase=(d-a.startTime)/a.duration;a.phase>=1||!this._validOp(a);)if(!this._nextOp(a,d)){delete this.operations[n];break}}}_nextOp(d,n){return!!d.queued&&(d.from=d.to,d.to=d.queued,d.queued=null,d.phase=0,d.startTime=n,!0)}_validOp(d){return d.from.hasData()&&d.to.hasData()}},An={0:null,1:"TERRAIN_VERTEX_MORPHING"};function xp(d,n,a){if(n===0)return 0;const f=n<1&&a===514?.25/n:1;return 6*Math.pow(1.5,22-d)*Math.max(n,1)*f}function Dl(d,n){const a=1<<d.z;return!n&&(d.x===0||d.x===a-1)||d.y===0||d.y===a-1}const kl=d=>({u_matrix:d});function Vo(d,n,a,f,_){if(_>0){const x=r.f.now(),w=(x-d.timeAdded)/_,S=n?(x-n.timeAdded)/_:-1,C=a.getSource(),D=f.coveringZoomLevel({tileSize:C.tileSize,roundZoom:C.roundZoom}),z=!n||Math.abs(n.tileID.overscaledZ-D)>Math.abs(d.tileID.overscaledZ-D),O=z&&d.refreshedUponExpiration?1:r.ad(z?w:1-S,0,1);return d.refreshedUponExpiration&&w>=1&&(d.refreshedUponExpiration=!1),n?{opacity:1,mix:1-O}:{opacity:O,mix:0}}return{opacity:1,mix:0}}class qh extends ms{constructor(n){const a={type:"raster-dem",maxzoom:n.transform.maxZoom},f=new r.bZ(r.b_(),null),_=Sh("mock-dem",a,f,n.style);super("mock-dem",_,!1),_.setEventedParent(this),this._sourceLoaded=!0}_loadTile(n,a){n.state="loaded",a(null)}}class au extends ms{constructor(n){const a=Sh("proxy",{type:"geojson",maxzoom:n.transform.maxZoom},new r.bZ(r.b_(),null),n.style);super("proxy",a,!1),a.setEventedParent(this),this.map=this.getSource().map=n,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(n,a,f){if(n.freezeTileCoverage)return;this.transform=n;const _=n.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((x,w)=>{if(x[w.key]="",!this._tiles[w.key]){const S=new ps(w,this._source.tileSize*w.overscaleFactor(),n.tileZoom);S.state="loaded",this._tiles[w.key]=S}return x},{});for(const x in this._tiles)x in _||(this.freeFBO(x),this._tiles[x].unloadVectorData(),delete this._tiles[x])}freeFBO(n){const a=this.proxyCachedFBO[n];if(a!==void 0){const f=Object.values(a);this.renderCachePool.push(...f),delete this.proxyCachedFBO[n]}}deallocRenderCache(){this.renderCache.forEach(n=>n.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class mr extends r.ap{constructor(n,a,f){super(n.overscaledZ,n.wrap,n.canonical.z,n.canonical.x,n.canonical.y),this.proxyTileKey=a,this.projMatrix=f}}class Yr extends r.cp{constructor(n,a){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},n.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),n.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),n.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=n,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[f,_,x]=function(C){const D=new r.aQ,z=new r.az,O=131;D.reserve(17161),z.reserve(33800);const V=r.Y/128,U=r.Y+V/2,H=U+V;for(let Z=-V;Z<H;Z+=V)for(let $=-V;$<H;$+=V){const K=$<0||$>U||Z<0||Z>U?24575:0,oe=r.ad(Math.round($),0,r.Y),se=r.ad(Math.round(Z),0,r.Y);D.emplaceBack(oe+K,se)}const q=(Z,$)=>{const K=$*O+Z;z.emplaceBack(K+1,K,K+O),z.emplaceBack(K+O,K+O+1,K+1)};for(let Z=1;Z<129;Z++)for(let $=1;$<129;$++)q($,Z);return[0,129].forEach(Z=>{for(let $=0;$<130;$++)q($,Z),q(Z,$)}),[D,z,32768]}(),w=n.context;this.gridBuffer=w.createVertexBuffer(f,r.aS.members),this.gridIndexBuffer=w.createIndexBuffer(_),this.gridSegments=r.aE.simpleSegment(0,0,f.length,_.length),this.gridNoSkirtSegments=r.aE.simpleSegment(0,0,f.length,x),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new au(a.map),this.orthoMatrix=r.a9.create(),r.a9.ortho(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,r.Y,0,r.Y,0,1);const S=w.gl;this._overlapStencilMode=new ei({func:S.GEQUAL,mask:255},0,255,S.KEEP,S.KEEP,S.REPLACE),this._previousZoom=n.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=a,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new qh(a.map),this._pendingGroundEffectLayers=[]}set style(n){n.on("data",this._onStyleDataEvent.bind(this)),this._style=n,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(n,a,f){if(n&&n.terrain){this._style!==n&&(this.style=n,this._evaluationZoom=void 0);const _=n.terrain.properties,x=n.terrain.drapeRenderMode===0,w=n.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=r.f.now();const S=n.terrain&&n.terrain.scope,C=_.get("source"),D=x?this._mockSourceCache:n.getSourceCache(C,S);if(!D)return void r.w(`Couldn't find terrain source "${C}".`);if(this.sourceCache=D,this._exaggeration=w?this.calculateExaggeration(a):_.get("exaggeration"),!a.projection.requiresDraping&&w&&this._exaggeration===0)return void this._disable();this.enabled=!0;const z=()=>{this.sourceCache.used&&r.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const O=this.getScaledDemTileSize();this.sourceCache.update(a,O,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,z(),this._initializing=!0),z(),a.updateElevation(!0,f),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(a),this._emptyDEMTextureDirty=!0,this._previousZoom=a.zoom}else this._disable()}calculateExaggeration(n){const a=this._previousCameraAltitude,f=n.getFreeCameraOptions().position.z/n.pixelsPerMeter*n.worldSize;this._previousCameraAltitude=f;const _=a!=null?f-a:Number.MAX_VALUE;if(Math.abs(_)<2)return this._exaggeration;const x=n.zoom,w=this._style.terrain;if(!this._previousUpdateTimestamp)return w.getExaggeration(x);let S=x-this._previousZoom;const C=this._previousUpdateTimestamp;let D=x;this._evaluationZoom!=null&&(D=this._evaluationZoom,Math.abs(x-D)>.5&&(S=.5*(x-D+S)),S*_<0&&(D+=S)),this._evaluationZoom=D;const z=w.getExaggeration(D),O=z===w.getExaggeration(Math.max(0,D-.1));if(O&&Math.abs(z-this._exaggeration)<.01)return z;let V=Math.min(.1,.00375*(this._updateTimestamp-C));return(O||z<.1||Math.abs(S)<1e-4)&&(V=Math.min(.2,4*V)),r.X(this._exaggeration,z,V)}resetTileLookupCache(n){this._findCoveringTileCache[n]={}}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(n){n.coord&&n.dataType==="source"?this._clearRenderCacheForTile(n.sourceCacheId,n.coord):n.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const n in this._style._mergedSourceCaches)this._style._mergedSourceCaches[n].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach(n=>n.fb.destroy()),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this._exaggeration}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const n=2*this.proxySourceCache.getSource().tileSize;return[n,n]}set useVertexMorphing(n){this._useVertexMorphing=n}updateTileBinding(n){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const a=this.proxySourceCache,f=this.painter.transform;this._initializing&&(this._initializing=f._centerAltitude===0&&this.getAtPointOrZero(r.O.fromLngLat(f.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const _=this.proxyCoords=a.getIds().map(C=>{const D=a.getTileByID(C).tileID;return D.projMatrix=f.calculateProjMatrix(D.toUnwrapped()),D});(function(C,D){const z=D.transform.pointCoordinate(D.transform.getCameraPoint()),O=new r.P(z.x,z.y);C.sort((V,U)=>{if(U.overscaledZ-V.overscaledZ)return U.overscaledZ-V.overscaledZ;const H=new r.P(V.canonical.x+(1<<V.canonical.z)*V.wrap,V.canonical.y),q=new r.P(U.canonical.x+(1<<U.canonical.z)*U.wrap,U.canonical.y),Z=O.mult(1<<V.canonical.z);return Z.x-=.5,Z.y-=.5,Z.distSqr(H)-Z.distSqr(q)})})(_,this.painter);const x=this.proxyToSource||{};this.proxyToSource={},_.forEach(C=>{this.proxyToSource[C.key]={}}),this.terrainTileForTile={};const w=this._style._mergedSourceCaches;for(const C in w){const D=w[C];if(!D.used||(D!==this.sourceCache&&this.resetTileLookupCache(D.id),this._setupProxiedCoordsForOrtho(D,n[C],x),D.usedForTerrain))continue;const z=n[C];D.getSource().reparseOverscaled&&this._assignTerrainTiles(z)}this.proxiedCoords[a.id]=_.map(C=>new mr(C,C.key,this.orthoMatrix)),this._assignTerrainTiles(_),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(x),this.renderingToTexture=!1;const S={};this._visibleDemTiles=[];for(const C of this.proxyCoords){const D=this.terrainTileForTile[C.key];if(!D)continue;const z=D.tileID.key;z in S||(this._visibleDemTiles.push(D),S[z]=z)}}_assignTerrainTiles(n){this._initializing||n.forEach(a=>{if(this.terrainTileForTile[a.key])return;const f=this._findTileCoveringTileID(a,this.sourceCache);f&&(this.terrainTileForTile[a.key]=f)})}_prepareDEMTextures(){const n=this.painter.context,a=n.gl;for(const f in this.terrainTileForTile){const _=this.terrainTileForTile[f],x=_.dem;!x||_.demTexture&&!_.needsDEMTextureUpload||(n.activeTexture.set(a.TEXTURE1),$r(this.painter,_,x))}}_prepareDemTileUniforms(n,a,f,_){if(!a||a.demTexture==null)return!1;const x=n.tileID.canonical,w=Math.pow(2,a.tileID.canonical.z-x.z),S=_||"";return f[`u_dem_tl${S}`]=[x.x*w%1,x.y*w%1],f[`u_dem_scale${S}`]=w,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}get emptyDepthBufferTexture(){const n=this.painter.context,a=n.gl;if(!this._emptyDepthBufferTexture){const f=new r.h({width:1,height:1},Uint8Array.of(255,255,255,255));this._emptyDepthBufferTexture=new r.T(n,f,a.RGBA,{premultiply:!1})}return this._emptyDepthBufferTexture}_getLoadedAreaMinimum(){let n=0;const a=this._visibleDemTiles.reduce((f,_)=>{if(!_.dem)return f;const x=_.dem.tree.minimums[0];return x>0&&n++,f+x},0);return n?a/n:0}_updateEmptyDEMTexture(){const n=this.painter.context,a=n.gl;n.activeTexture.set(a.TEXTURE2);const f=this._getLoadedAreaMinimum(),[_,x]=(()=>{const S=new r.cr({width:1,height:1},new Float32Array([f]));return[a.R32F,S]})();this._emptyDEMTextureDirty=!1;let w=this._emptyDEMTexture;return w?w.update(x,{premultiply:!1}):w=this._emptyDEMTexture=new r.T(n,x,_,{premultiply:!1}),w}setupElevationDraw(n,a,f){const _=this.painter.context,x=_.gl,w={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0};w.u_exaggeration=this.exaggeration();let S=null,C=null,D=1;if(f&&f.morphing&&this._useVertexMorphing){const V=f.morphing.srcDemTile,U=f.morphing.dstDemTile;D=f.morphing.phase,V&&U&&(this._prepareDemTileUniforms(n,V,w,"_prev")&&(C=V),this._prepareDemTileUniforms(n,U,w)&&(S=U))}const z=V=>V&&V.demTexture&&this.painter.linearFloatFilteringSupported()?x.LINEAR:x.NEAREST,O=V=>{w.u_dem_size=V.size[0]===1?1:V.size[0]-2};if(C&&S)_.activeTexture.set(x.TEXTURE2),S.demTexture.bind(z(S),x.CLAMP_TO_EDGE),_.activeTexture.set(x.TEXTURE4),C.demTexture.bind(z(C),x.CLAMP_TO_EDGE),S.demTexture&&O(S.demTexture),w.u_dem_lerp=D;else{S=this.terrainTileForTile[n.tileID.key],_.activeTexture.set(x.TEXTURE2);const V=this._prepareDemTileUniforms(n,S,w)?S.demTexture:this.emptyDEMTexture;V.bind(z(S),x.CLAMP_TO_EDGE),O(V)}if(_.activeTexture.set(x.TEXTURE3),f&&f.useDepthForOcclusion?(this._depthTexture&&this._depthTexture.bind(x.NEAREST,x.CLAMP_TO_EDGE),this._depthFBO&&(w.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height])):(this.emptyDepthBufferTexture.bind(x.NEAREST,x.CLAMP_TO_EDGE),w.u_depth_size_inv=[1,1]),f&&f.useMeterToDem&&S){const V=(1<<S.tileID.canonical.z)*r.bo(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;w.u_meter_to_dem=V}if(f&&f.labelPlaneMatrixInv&&(w.u_label_plane_matrix_inv=f.labelPlaneMatrixInv),a.setTerrainUniformValues(_,w),this.painter.transform.projection.name==="globe"){const V=this.globeUniformValues(this.painter.transform,n.tileID.canonical,f&&f.useDenormalizedUpVectorScale);a.setGlobeUniformValues(_,V)}}globeUniformValues(n,a,f){const _=n.projection;return{u_tile_tl_up:_.upVector(a,0,0),u_tile_tr_up:_.upVector(a,r.Y,0),u_tile_br_up:_.upVector(a,r.Y,r.Y),u_tile_bl_up:_.upVector(a,0,r.Y),u_tile_up_scale:f?r.cq(1):_.upVectorScale(a,n.center.lat,n.worldSize).metersToTile}}renderToBackBuffer(n){const a=this.painter,f=this.painter.context;n.length!==0&&(f.bindFramebuffer.set(null),f.viewport.set([0,0,a.width,a.height]),a.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(_,x,w,S,C){if(_.transform.projection.name==="globe")(function(D,z,O,V,U){const H=D.context,q=H.gl;let Z,$;const K=D.transform,oe=r.ci(D,H,K),se=(Pe,ze)=>{if($===ze)return;const ge=[An[ze],"PROJECTION_GLOBE_VIEW"];oe&&ge.push("CUSTOM_ANTIALIASING");const Ae=D.isTileAffectedByFog(Pe);Z=D.getOrCreateProgram("globeRaster",{defines:ge,overrideFog:Ae}),$=ze},le=D.colorModeForRenderPass(),Y=new jt(q.LEQUAL,jt.ReadWrite,D.depthRangeFor3D);rr.update(U);const ee=r.cj(K),me=[r.a8(K.center.lng),r.ah(K.center.lat)],fe=D.globeSharedBuffers,xe=[K.width*r.f.devicePixelRatio,K.height*r.f.devicePixelRatio],ke=Float32Array.from(K.globeMatrix),ye={useDenormalizedUpVectorScale:!0};{const Pe=D.transform,ze=xp(Pe.zoom,z.exaggeration(),z.sourceCache._source.tileSize);$=-1;const ge=q.TRIANGLES;for(const Ae of V){const Ye=O.getTile(Ae),we=ei.disabled,De=z.prevTerrainTileForTile[Ae.key],Re=z.terrainTileForTile[Ae.key];Ma(De,Re)&&rr.newMorphing(Ae.key,De,Re,U,250),H.activeTexture.set(q.TEXTURE0),Ye.texture&&Ye.texture.bind(q.LINEAR,q.CLAMP_TO_EDGE);const ae=rr.getMorphValuesForProxy(Ae.key),Ue=ae?1:0;ae&&r.k(ye,{morphing:{srcDemTile:ae.from,dstDemTile:ae.to,phase:r.ch(ae.phase)}});const gt=r.ck(Ae.canonical),Et=r.cl(gt.getCenter().lat),zt=r.cm(Ae.canonical,gt,Et,Pe.worldSize/Pe._pixelsPerMercatorPixel),Pt=r.aW(r.cn(Ae.canonical)),Ut=Ta(Pe.expandedFarZProjMatrix,ke,ee,Pt,r.W(Pe.zoom),me,Pe.frustumCorners.TL,Pe.frustumCorners.TR,Pe.frustumCorners.BR,Pe.frustumCorners.BL,Pe.globeCenterInViewSpace,Pe.globeRadius,xe,ze,Pe._farZ,zt);if(se(Ae,Ue),Z&&(z.setupElevationDraw(Ye,Z,ye),D.uploadCommonUniforms(H,Z,Ae.toUnwrapped()),fe)){const[vi,Jt,Ti]=fe.getGridBuffers(Et,ze!==0);Z.draw(D,ge,Y,we,le,Yt.backCCW,Ut,"globe_raster",vi,Jt,Ti)}}}if(fe&&(D.renderDefaultNorthPole||D.renderDefaultSouthPole)){const Pe=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];oe&&Pe.push("CUSTOM_ANTIALIASING"),Z=D.getOrCreateProgram("globeRaster",{defines:Pe});for(const ze of V){const{x:ge,y:Ae,z:Ye}=ze.canonical,we=Ae===0,De=Ae===(1<<Ye)-1,[Re,ae,Ue,gt]=fe.getPoleBuffers(Ye,!1);if(gt&&(we||De)){const Et=O.getTile(ze);H.activeTexture.set(q.TEXTURE0),Et.texture&&Et.texture.bind(q.LINEAR,q.CLAMP_TO_EDGE);let zt=r.co(Ye,ge,K);const Pt=r.aW(r.cn(ze.canonical)),Ut=(vi,Jt)=>vi.draw(D,q.TRIANGLES,Y,ei.disabled,le,Yt.disabled,Ta(K.expandedFarZProjMatrix,zt,zt,Pt,0,me,K.frustumCorners.TL,K.frustumCorners.TR,K.frustumCorners.BR,K.frustumCorners.BL,K.globeCenterInViewSpace,K.globeRadius,xe,0,K._farZ),"globe_pole_raster",Jt,Ue,gt);z.setupElevationDraw(Et,Z,ye),D.uploadCommonUniforms(H,Z,ze.toUnwrapped()),we&&D.renderDefaultNorthPole&&Ut(Z,Re),De&&D.renderDefaultSouthPole&&(zt=r.a9.scale(r.a9.create(),zt,[1,-1,1]),Ut(Z,ae))}}}})(_,x,w,S,C);else{const D=_.context,z=D.gl;let O,V;const U=_.shadowRenderer,H=po(_,_.longestCutoffRange),q=le=>{if(V===le)return;const Y=[];Y.push(An[le]),H.shouldRenderCutoff&&Y.push("RENDER_CUTOFF"),O=_.getOrCreateProgram("terrainRaster",{defines:Y}),V=le},Z=_.colorModeForRenderPass(),$=new jt(z.LEQUAL,jt.ReadWrite,_.depthRangeFor3D);rr.update(C);const K=_.transform,oe=xp(K.zoom,x.exaggeration(),x.sourceCache._source.tileSize);let se=[0,0,0];if(U){const le=_.style.directionalLight,Y=_.style.ambientLight;le&&Y&&(se=Vh(le,Y))}{V=-1;const le=z.TRIANGLES,[Y,ee]=[x.gridIndexBuffer,x.gridSegments];for(const me of S){const fe=w.getTile(me),xe=ei.disabled,ke=x.prevTerrainTileForTile[me.key],ye=x.terrainTileForTile[me.key];Ma(ke,ye)&&rr.newMorphing(me.key,ke,ye,C,250),D.activeTexture.set(z.TEXTURE0),fe.texture&&fe.texture.bind(z.LINEAR,z.CLAMP_TO_EDGE);const Pe=rr.getMorphValuesForProxy(me.key),ze=Pe?1:0;let ge;Pe&&(ge={morphing:{srcDemTile:Pe.from,dstDemTile:Pe.to,phase:r.ch(Pe.phase)}});const Ae=Pl(me.projMatrix,Dl(me.canonical,K.renderWorldCopies)?oe/10:oe,se);if(q(ze),!O)continue;x.setupElevationDraw(fe,O,ge);const Ye=me.toUnwrapped();U&&U.setupShadows(Ye,O),_.uploadCommonUniforms(D,O,Ye,null,H),O.draw(_,le,$,xe,Z,Yt.backCCW,Ae,"terrain_raster",x.gridBuffer,Y,ee)}}}}(a,this,this.proxySourceCache,n,this._updateTimestamp),this.renderingToTexture=!0,a.gpuTimingDeferredRenderEnd(),n.splice(0,n.length))}renderBatch(n){if(this._drapedRenderBatches.length===0)return n+1;this.renderingToTexture=!0;const a=this.painter,f=this.painter.context,_=this.proxySourceCache,x=this.proxiedCoords[_.id],w=this._drapedRenderBatches.shift(),S=a.style.order,C=[];let D=0;for(const z of x){const O=_.getTileByID(z.proxyTileKey),V=_.proxyCachedFBO[z.key]?_.proxyCachedFBO[z.key][n]:void 0,U=V!==void 0?_.renderCache[V]:this.pool[D++],H=V!==void 0;if(O.texture=U.tex,H&&!U.dirty){C.push(O.tileID);continue}let q;f.bindFramebuffer.set(U.fb.framebuffer),this.renderedToTile=!1,U.dirty&&(f.clear({color:r.aA.transparent,stencil:0}),U.dirty=!1);for(let Z=w.start;Z<=w.end;++Z){const $=a.style._mergedLayers[S[Z]];if($.isHidden(a.transform.zoom))continue;const K=a.style.getLayerSourceCache($),oe=K?this.proxyToSource[z.key][K.id]:[z];if(!oe)continue;const se=oe;f.viewport.set([0,0,U.fb.width,U.fb.height]),q!==(K?K.id:null)&&(this._setupStencil(U,oe,$,K),q=K?K.id:null),a.renderLayer(a,K,$,se)}if(this._drapedRenderBatches.length===0)for(const Z of this._pendingGroundEffectLayers){const $=a.style._mergedLayers[S[Z]];if($.isHidden(a.transform.zoom))continue;const K=a.style.getLayerSourceCache($),oe=K?this.proxyToSource[z.key][K.id]:[z];if(!oe)continue;const se=oe;f.viewport.set([0,0,U.fb.width,U.fb.height]),q!==(K?K.id:null)&&(this._setupStencil(U,oe,$,K),q=K?K.id:null),a.renderLayer(a,K,$,se)}this.renderedToTile?(U.dirty=!0,C.push(O.tileID)):H||--D,D===5&&(D=0,this.renderToBackBuffer(C))}return this.renderToBackBuffer(C),this.renderingToTexture=!1,f.bindFramebuffer.set(null),f.viewport.set([0,0,a.width,a.height]),w.end+1}postRender(){}isLayerOrderingCorrect(n){const a=n.order.length;let f=-1,_=a;for(let x=0;x<a;++x)this._style.isLayerDraped(n._mergedLayers[n.order[x]])?f=Math.max(f,x):_=Math.min(_,x);return _>f}getMinElevationBelowMSL(){let n=0;return this._visibleDemTiles.filter(a=>a.dem).forEach(a=>{n=Math.min(n,a.dem.tree.minimums[0])}),n===0?n:(n-30)*this._exaggeration}raycast(n,a,f){if(!this._visibleDemTiles)return null;const _=this._visibleDemTiles.filter(x=>x.dem).map(x=>{const w=x.tileID,S=1<<w.overscaledZ,{x:C,y:D}=w.canonical,z=C/S,O=(C+1)/S,V=D/S,U=(D+1)/S;return{minx:z,miny:V,maxx:O,maxy:U,t:x.dem.tree.raycastRoot(z,V,O,U,n,a,f),tile:x}});_.sort((x,w)=>(x.t!==null?x.t:Number.MAX_VALUE)-(w.t!==null?w.t:Number.MAX_VALUE));for(const x of _){if(x.t==null)return null;const w=x.tile.dem.tree.raycast(x.minx,x.miny,x.maxx,x.maxy,n,a,f);if(w!=null)return w}return null}_createFBO(){const n=this.painter.context,a=n.gl,f=this.drapeBufferSize;n.activeTexture.set(a.TEXTURE0);const _=new r.T(n,{width:f[0],height:f[1],data:null},a.RGBA);_.bind(a.LINEAR,a.CLAMP_TO_EDGE);const x=n.createFramebuffer(f[0],f[1],!0,null);return x.colorAttachment.set(_.texture),x.depthAttachment=new ag(n,x.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=n.createRenderbuffer(n.gl.DEPTH_STENCIL,f[0],f[1]),this._stencilRef=0,x.depthAttachment.set(this._sharedDepthStencil),n.clear({stencil:0})):x.depthAttachment.set(this._sharedDepthStencil),n.extTextureFilterAnisotropic&&a.texParameterf(a.TEXTURE_2D,n.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,n.extTextureFilterAnisotropicMax),{fb:x,tex:_,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const n in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[n].hasTransition())return!0;return this._style.order.some(n=>{const a=this._style._mergedLayers[n],f=a.isHidden(this.painter.transform.zoom);return a.type==="custom"?!f&&a.shouldRedrape():!f&&a.hasTransition()})}_clearLineLayersFromRenderCache(){let n=!1;for(const f of this._style.getSources())if(f instanceof mt){n=!0;break}if(!n)return;const a={};for(let f=0;f<this._style.order.length;++f){const _=this._style._mergedLayers[this._style.order[f]],x=this._style.getLayerSourceCache(_);if(x&&!a[x.id]&&!_.isHidden(this.painter.transform.zoom)&&_.type==="line"&&_.widthExpression()instanceof r.Z){a[x.id]=!0;for(const w of this.proxyCoords){const S=this.proxyToSource[w.key][x.id];if(S)for(const C of S)this._clearRenderCacheForTile(x.id,C)}}}}_clearRasterLayersFromRenderCache(){let n=!1;for(const f in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[f]._source instanceof _t){n=!0;break}if(!n)return;const a={};for(let f=0;f<this._style.order.length;++f){const _=this._style._mergedLayers[this._style.order[f]],x=this._style.getLayerSourceCache(_);if(!x||a[x.id]||_.isHidden(this.painter.transform.zoom)||_.type!=="raster")continue;const w=_.paint.get("raster-fade-duration");for(const S of this.proxyCoords){const C=this.proxyToSource[S.key][x.id];if(C)for(const D of C){const z=Vo(x.getTile(D),x.findLoadedParent(D,0),x,this.painter.transform,w);(z.opacity!==1||z.mix!==0)&&this._clearRenderCacheForTile(x.id,D)}}}}_setupDrapedRenderBatches(){const n=this._style.order,a=n.length;if(a===0)return;const f=[];this._pendingGroundEffectLayers=[];let _,x=0,w=this._style._mergedLayers[n[x]];for(;!this._style.isLayerDraped(w)&&w.isHidden(this.painter.transform.zoom)&&++x<a;)w=this._style._mergedLayers[n[x]];for(;x<a;++x){const S=this._style._mergedLayers[n[x]];S.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(S)?_===void 0&&(_=x):(S.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(x),_!==void 0&&(f.push({start:_,end:x-1}),_=void 0)))}if(_!==void 0&&f.push({start:_,end:x-1}),f.length!==0){const S=f[f.length-1];this._pendingGroundEffectLayers.every(C=>C>S.end)||r.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=f}_setupRenderCache(n){const a=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,a.renderCache.length>a.renderCachePool.length){const w=Object.values(a.proxyCachedFBO);a.proxyCachedFBO={};for(let S=0;S<w.length;++S){const C=Object.values(w[S]);a.renderCachePool.push(...C)}}return}this._clearRasterLayersFromRenderCache();const f=this.proxyCoords,_=this._tilesDirty;for(let w=f.length-1;w>=0;w--){const S=f[w];if(a.getTileByID(S.key),a.proxyCachedFBO[S.key]!==void 0){const C=n[S.key],D=this.proxyToSource[S.key];let z=0;for(const O in D){const V=D[O],U=C[O];if(!U||U.length!==V.length||V.some((H,q)=>H!==U[q]||_[O]&&_[O].hasOwnProperty(H.key))){z=-1;break}++z}for(const O in a.proxyCachedFBO[S.key])a.renderCache[a.proxyCachedFBO[S.key][O]].dirty=z<0||z!==Object.values(C).length}}const x=[...this._drapedRenderBatches];x.sort((w,S)=>S.end-S.start-(w.end-w.start));for(const w of x)for(const S of f){if(a.proxyCachedFBO[S.key])continue;let C=a.renderCachePool.pop();C===void 0&&a.renderCache.length<50&&(C=a.renderCache.length,a.renderCache.push(this._createFBO())),C!==void 0&&(a.proxyCachedFBO[S.key]={},a.proxyCachedFBO[S.key][w.start]=C,a.renderCache[C].dirty=!0)}this._tilesDirty={}}_setupStencil(n,a,f,_){if(!_||!this._sourceTilesOverlap[_.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const x=this.painter.context,w=x.gl;if(a.length<=1)return void(this._overlapStencilType=!1);let S;if(f.isTileClipped())S=a.length,this._overlapStencilMode.test={func:w.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(a[0].overscaledZ>a[a.length-1].overscaledZ))return void(this._overlapStencilType=!1);S=1,this._overlapStencilMode.test={func:w.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+S>255&&(x.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=S,this._overlapStencilMode.ref=this._stencilRef,f.isTileClipped()&&this._renderTileClippingMasks(a,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(n){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[n.key]),this._overlapStencilMode):ei.disabled}_renderTileClippingMasks(n,a){const f=this.painter,_=this.painter.context,x=_.gl;f._tileClippingMaskIDs={},_.setColorMode(pi.disabled),_.setDepthMode(jt.disabled);const w=f.getOrCreateProgram("clippingMask");for(const S of n){const C=f._tileClippingMaskIDs[S.key]=--a;w.draw(f,x.TRIANGLES,jt.disabled,new ei({func:x.ALWAYS,mask:0},C,255,x.KEEP,x.KEEP,x.REPLACE),pi.disabled,Yt.disabled,kl(S.projMatrix),"$clipping",f.tileExtentBuffer,f.quadTriangleIndexBuffer,f.tileExtentSegments)}}pointCoordinate(n){const a=this.painter.transform;if(n.x<0||n.x>a.width||n.y<0||n.y>a.height)return null;const f=[n.x,n.y,1,1];r.aa.transformMat4(f,f,a.pixelMatrixInverse),r.aa.scale(f,f,1/f[3]),f[0]/=a.worldSize,f[1]/=a.worldSize;const _=a._camera.position,x=r.bo(1,a.center.lat),w=[_[0],_[1],_[2]/x,0],S=r.Q.subtract([],f.slice(0,3),w);r.Q.normalize(S,S);const C=this.raycast(w,S,this._exaggeration);return C!==null&&C?(r.Q.scaleAndAdd(w,w,S,C),w[3]=w[2],w[2]*=x,w):null}drawDepth(){const n=this.painter,a=n.context,f=this.proxySourceCache,_=Math.ceil(n.width),x=Math.ceil(n.height);if(!this._depthFBO||this._depthFBO.width===_&&this._depthFBO.height===x||(this._depthFBO.destroy(),this._depthFBO=void 0,this._depthTexture=void 0),!this._depthFBO){const w=a.gl,S=a.createFramebuffer(_,x,!0,"renderbuffer");a.activeTexture.set(w.TEXTURE0);const C=new r.T(a,{width:_,height:x,data:null},w.RGBA);C.bind(w.NEAREST,w.CLAMP_TO_EDGE),S.colorAttachment.set(C.texture);const D=a.createRenderbuffer(a.gl.DEPTH_COMPONENT16,_,x);S.depthAttachment.set(D),this._depthFBO=S,this._depthTexture=C}a.bindFramebuffer.set(this._depthFBO.framebuffer),a.viewport.set([0,0,_,x]),function(w,S,C,D){if(w.transform.projection.name==="globe")return;const z=w.context,O=z.gl;z.clear({depth:1});const V=w.getOrCreateProgram("terrainDepth"),U=new jt(O.LESS,jt.ReadWrite,w.depthRangeFor3D);for(const H of D){const q=C.getTile(H),Z=Pl(H.projMatrix,0,[0,0,0]);S.setupElevationDraw(q,V),V.draw(w,O.TRIANGLES,U,ei.disabled,pi.unblended,Yt.backCCW,Z,"terrain_depth",S.gridBuffer,S.gridIndexBuffer,S.gridNoSkirtSegments)}}(n,this,f,this.proxyCoords)}_setupProxiedCoordsForOrtho(n,a,f){if(n.getSource()instanceof r.as)return this._setupProxiedCoordsForImageSource(n,a,f);this._findCoveringTileCache[n.id]=this._findCoveringTileCache[n.id]||{};const _=this.proxiedCoords[n.id]=[],x=this.proxyCoords;for(let C=0;C<x.length;C++){const D=x[C],z=this._findTileCoveringTileID(D,n);if(z){const O=this._createProxiedId(D,z,f[D.key]&&f[D.key][n.id]);_.push(O),this.proxyToSource[D.key][n.id]=[O]}}let w=!1;const S=new Set;for(let C=0;C<a.length;C++){const D=n.getTile(a[C]);if(!D||!D.hasData())continue;const z=this._findTileCoveringTileID(D.tileID,this.proxySourceCache);if(z&&z.tileID.canonical.z!==D.tileID.canonical.z){const O=this.proxyToSource[z.tileID.key][n.id],V=this._createProxiedId(z.tileID,D,f[z.tileID.key]&&f[z.tileID.key][n.id]);O?O.splice(O.length-1,0,V):this.proxyToSource[z.tileID.key][n.id]=[V];const U=this.proxyToSource[z.tileID.key][n.id];S.has(U)||S.add(U),_.push(V),w=!0}}if(this._sourceTilesOverlap[n.id]=w,w&&this._debugParams.sortTilesHiZFirst)for(const C of S)C.sort((D,z)=>z.overscaledZ-D.overscaledZ)}_setupProxiedCoordsForImageSource(n,a,f){if(!n.getSource().loaded())return;const _=this.proxiedCoords[n.id]=[],x=this.proxyCoords,w=n.getSource(),S=w.tileID;if(!S)return;const C=new r.P(S.x,S.y)._div(1<<S.z),D=w.coordinates.map(r.O.fromLngLat).reduce((O,V)=>(O.min.x=Math.min(O.min.x,V.x-C.x),O.min.y=Math.min(O.min.y,V.y-C.y),O.max.x=Math.max(O.max.x,V.x-C.x),O.max.y=Math.max(O.max.y,V.y-C.y),O),{min:new r.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new r.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),z=(O,V)=>{const U=O.wrap+O.canonical.x/(1<<O.canonical.z),H=O.canonical.y/(1<<O.canonical.z),q=r.Y/(1<<O.canonical.z),Z=V.wrap+V.canonical.x/(1<<V.canonical.z),$=V.canonical.y/(1<<V.canonical.z);return U+q<Z+D.min.x||U>Z+D.max.x||H+q<$+D.min.y||H>$+D.max.y};for(let O=0;O<x.length;O++){const V=x[O];for(let U=0;U<a.length;U++){const H=n.getTile(a[U]);if(!H||!H.hasData()||z(V,H.tileID))continue;const q=this._createProxiedId(V,H,f[V.key]&&f[V.key][n.id]),Z=this.proxyToSource[V.key][n.id];Z?Z.push(q):this.proxyToSource[V.key][n.id]=[q],_.push(q)}}}_createProxiedId(n,a,f){let _=this.orthoMatrix;if(f){const x=f.find(w=>w.key===a.tileID.key);if(x)return x}if(a.tileID.key!==n.key){const x=n.canonical.z-a.tileID.canonical.z;let w,S,C;_=r.a9.create();const D=a.tileID.wrap-n.wrap<<n.overscaledZ;x>0?(w=r.Y>>x,S=w*((a.tileID.canonical.x<<x)-n.canonical.x+D),C=w*((a.tileID.canonical.y<<x)-n.canonical.y)):(w=r.Y<<-x,S=r.Y*(a.tileID.canonical.x-(n.canonical.x+D<<-x)),C=r.Y*(a.tileID.canonical.y-(n.canonical.y<<-x))),r.a9.ortho(_,0,w,0,w,0,1),r.a9.translate(_,_,[S,C,0])}return new mr(a.tileID,n.key,_)}_findTileCoveringTileID(n,a){let f=a.getTile(n);if(f&&f.hasData())return f;const _=this._findCoveringTileCache[a.id],x=_[n.key];if(f=x?a.getTileByID(x):null,f&&f.hasData()||x===null)return f;let w=f?f.tileID:n,S=w.overscaledZ;const C=a.getSource().minzoom,D=[];if(!x){const O=a.getSource().maxzoom;if(n.canonical.z>=O){const V=n.canonical.z-O;a.getSource().reparseOverscaled?(S=Math.max(n.canonical.z+2,a.transform.tileZoom),w=new r.ap(S,n.wrap,O,n.canonical.x>>V,n.canonical.y>>V)):V!==0&&(S=O,w=new r.ap(S,n.wrap,O,n.canonical.x>>V,n.canonical.y>>V))}w.key!==n.key&&(D.push(w.key),f=a.getTile(w))}const z=O=>{D.forEach(V=>{_[V]=O}),D.length=0};for(S-=1;S>=C&&(!f||!f.hasData());S--){f&&z(f.tileID.key);const O=w.calculateScaledKey(S);if(f=a.getTileByID(O),f&&f.hasData())break;const V=_[O];if(V===null)break;V===void 0?D.push(O):f=a.getTileByID(V)}return z(f?f.tileID.key:null),f&&f.hasData()?f:null}findDEMTileFor(n){return this.enabled?this._findTileCoveringTileID(n,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(n,a){let f=this._tilesDirty[n];f||(f=this._tilesDirty[n]={}),f[a.key]=!0}}function vp(d,n,a){const f=function(S,C,D){const z=r.Q.dot(C,S),O=r.Q.dot(D,[.2126,.7152,.0722]),V=(H,q,Z)=>(1-Z)*H+Z*q,U=V(1-.3*Math.min(O,1),1,Math.min(z+1,1));return V(.92,1,Math.asin(r.ad(C[2],-1,1))/Math.PI+.5)*U}(d,[0,0,1],n),_=[0,0,0];r.Q.scale(_,a.slice(0,3),f);const x=[0,0,0];r.Q.scale(x,n.slice(0,3),d[2]);const w=[0,0,0];return r.Q.add(w,_,x),r.bX(w)}const Sa=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],jn=["stars","fillExtrusion","fillExtrusionGroundEffect","model","symbolSDF","symbolIcon","symbolTextAndIcon"];class es{static cacheKey(n,a,f,_){let x=`${a}${_?_.cacheKey:""}`;for(const w of f)n.usedDefines.includes(w)&&(x+=`/${w}`);return x}constructor(n,a,f,_,x,w){const S=n.gl;this.program=S.createProgram(),this.configuration=_,this.name=a,this.fixedDefines=[...w];const C=_?_.getBinderAttributes():[],D=(f.staticAttributes||[]).concat(C);let z=_?_.defines():[];z=z.concat(w.map(Z=>`#define ${Z}`));const O=`#version 300 es
`;let V=O+z.concat("precision mediump float;",ou,Cl.fragmentSource).join(`
`);for(const Z of f.fragmentIncludes)V+=`
${hi[Z]}`;V+=`
${f.fragmentSource}`;let U=O+z.concat("precision highp float;",ou,Cl.vertexSource).join(`
`);for(const Z of f.vertexIncludes)U+=`
${hi[Z]}`;U+=`
${f.vertexSource}`;const H=S.createShader(S.FRAGMENT_SHADER);if(S.isContextLost())return void(this.failedToCreate=!0);S.shaderSource(H,V),S.compileShader(H),S.attachShader(this.program,H);const q=S.createShader(S.VERTEX_SHADER);if(S.isContextLost())this.failedToCreate=!0;else{S.shaderSource(q,U),S.compileShader(q),S.attachShader(this.program,q),this.attributes={},this.numAttributes=D.length;for(let Z=0;Z<this.numAttributes;Z++)if(D[Z]){const $=D[Z].startsWith("a_")?D[Z]:`a_${D[Z]}`;S.bindAttribLocation(this.program,Z,$),this.attributes[$]=Z}S.linkProgram(this.program),S.deleteShader(q),S.deleteShader(H),this.fixedUniforms=x(n),this.binderUniforms=_?_.getUniforms(n):[],w.includes("TERRAIN")&&(this.terrainUniforms=(Z=>({u_dem:new r.bR(Z),u_dem_prev:new r.bR(Z),u_dem_tl:new r.bO(Z),u_dem_scale:new r.bQ(Z),u_dem_tl_prev:new r.bO(Z),u_dem_scale_prev:new r.bQ(Z),u_dem_size:new r.bQ(Z),u_dem_lerp:new r.bQ(Z),u_exaggeration:new r.bQ(Z),u_depth:new r.bR(Z),u_depth_size_inv:new r.bO(Z),u_meter_to_dem:new r.bQ(Z),u_label_plane_matrix_inv:new r.bN(Z)}))(n)),w.includes("GLOBE")&&(this.globeUniforms=(Z=>({u_tile_tl_up:new r.bP(Z),u_tile_tr_up:new r.bP(Z),u_tile_br_up:new r.bP(Z),u_tile_bl_up:new r.bP(Z),u_tile_up_scale:new r.bQ(Z)}))(n)),w.includes("FOG")&&(this.fogUniforms=(Z=>({u_fog_matrix:new r.bN(Z),u_fog_range:new r.bO(Z),u_fog_color:new r.bS(Z),u_fog_horizon_blend:new r.bQ(Z),u_fog_vertical_limit:new r.bO(Z),u_fog_temporal_offset:new r.bQ(Z),u_frustum_tl:new r.bP(Z),u_frustum_tr:new r.bP(Z),u_frustum_br:new r.bP(Z),u_frustum_bl:new r.bP(Z),u_globe_pos:new r.bP(Z),u_globe_radius:new r.bQ(Z),u_globe_transition:new r.bQ(Z),u_is_globe:new r.bR(Z),u_viewport:new r.bO(Z)}))(n)),w.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(Z=>({u_cutoff_params:new r.bS(Z)}))(n)),w.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(Z=>({u_lighting_ambient_color:new r.bP(Z),u_lighting_directional_dir:new r.bP(Z),u_lighting_directional_color:new r.bP(Z),u_ground_radiance:new r.bP(Z)}))(n)),w.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(Z=>({u_light_matrix_0:new r.bN(Z),u_light_matrix_1:new r.bN(Z),u_fade_range:new r.bO(Z),u_shadow_normal_offset:new r.bP(Z),u_shadow_intensity:new r.bQ(Z),u_shadow_texel_size:new r.bQ(Z),u_shadow_map_resolution:new r.bQ(Z),u_shadow_direction:new r.bP(Z),u_shadow_bias:new r.bP(Z),u_shadowmap_0:new r.bR(Z),u_shadowmap_1:new r.bR(Z)}))(n))}}setTerrainUniformValues(n,a){if(!this.terrainUniforms)return;const f=this.terrainUniforms;if(!this.failedToCreate){n.program.set(this.program);for(const _ in a)f[_]&&f[_].set(this.program,_,a[_])}}setGlobeUniformValues(n,a){if(!this.globeUniforms)return;const f=this.globeUniforms;if(!this.failedToCreate){n.program.set(this.program);for(const _ in a)f[_]&&f[_].set(this.program,_,a[_])}}setFogUniformValues(n,a){if(!this.fogUniforms)return;const f=this.fogUniforms;if(!this.failedToCreate){n.program.set(this.program);for(const _ in a)f[_].set(this.program,_,a[_])}}setCutoffUniformValues(n,a){if(!this.cutoffUniforms)return;const f=this.cutoffUniforms;if(!this.failedToCreate){n.program.set(this.program);for(const _ in a)f[_].set(this.program,_,a[_])}}setLightsUniformValues(n,a){if(!this.lightsUniforms)return;const f=this.lightsUniforms;if(!this.failedToCreate){n.program.set(this.program);for(const _ in a)f[_].set(this.program,_,a[_])}}setShadowUniformValues(n,a){if(this.failedToCreate||!this.shadowUniforms)return;const f=this.shadowUniforms;n.program.set(this.program);for(const _ in a)f[_].set(this.program,_,a[_])}_drawDebugWireframe(n,a,f,_,x,w,S,C,D,z){const O=n.options.wireframe;if(O.terrain===!1&&O.layers2D===!1&&O.layers3D===!1)return;const V=n.context;if(!(!(!O.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!O.layers2D||n._terrain&&n._terrain.renderingToTexture||!Sa.includes(this.name))||!(!O.layers3D||!jn.includes(this.name))))return;const U=V.gl,H=n.wireframeDebugCache.getLinesFromTrianglesBuffer(n.frameCounter,x,V);if(!H)return;const q=[...this.fixedDefines];q.push("DEBUG_WIREFRAME");const Z=n.getOrCreateProgram(this.name,{config:this.configuration,defines:q});V.program.set(Z.program);const $=(se,le,Y)=>{if(le[se]&&Y[se])for(const ee in le[se])Y[se][ee]&&Y[se][ee].set(Y.program,ee,le[se][ee].current)};D&&D.setUniforms(Z.program,V,Z.binderUniforms,S,{zoom:C}),$("fixedUniforms",this,Z),$("terrainUniforms",this,Z),$("globeUniforms",this,Z),$("fogUniforms",this,Z),$("lightsUniforms",this,Z),$("shadowUniforms",this,Z),H.bind(),V.setColorMode(new pi([U.ONE,U.ONE_MINUS_SRC_ALPHA,U.ZERO,U.ONE],r.aA.transparent,[!0,!0,!0,!1])),V.setDepthMode(new jt(a.func===U.LESS?U.LEQUAL:a.func,jt.ReadOnly,a.range)),V.setStencilMode(ei.disabled);const K=3*w.primitiveLength*2,oe=3*w.primitiveOffset*2*2;z&&z>1?U.drawElementsInstanced(U.LINES,K,U.UNSIGNED_SHORT,oe,z):U.drawElements(U.LINES,K,U.UNSIGNED_SHORT,oe),x.bind(),V.program.set(this.program),V.setDepthMode(a),V.setStencilMode(f),V.setColorMode(_)}draw(n,a,f,_,x,w,S,C,D,z,O,V,U,H,q,Z){const $=n.context,K=$.gl;if(this.failedToCreate)return;$.program.set(this.program),$.setDepthMode(f),$.setStencilMode(_),$.setColorMode(x),$.setCullFace(w);for(const le of Object.keys(this.fixedUniforms))this.fixedUniforms[le].set(this.program,le,S[le]);H&&H.setUniforms(this.program,$,this.binderUniforms,V,{zoom:U});const oe={[K.POINTS]:1,[K.LINES]:2,[K.TRIANGLES]:3,[K.LINE_STRIP]:1}[a],se=Z&&Z>0?1:void 0;for(const le of O.get()){const Y=le.vaos||(le.vaos={});(Y[C]||(Y[C]=new bt)).bind($,this,D,H?H.getPaintVertexBuffers():[],z,le.vertexOffset,q||[],se),Z&&Z>1?K.drawElementsInstanced(a,le.primitiveLength*oe,K.UNSIGNED_SHORT,le.primitiveOffset*oe*2,Z):z?K.drawElements(a,le.primitiveLength*oe,K.UNSIGNED_SHORT,le.primitiveOffset*oe*2):K.drawArrays(a,le.vertexOffset,le.vertexLength),a===K.TRIANGLES&&z&&this._drawDebugWireframe(n,f,_,x,z,le,V,U,H,Z)}}}function zs(d,n){const a=Math.pow(2,n.tileID.overscaledZ),f=n.tileSize*Math.pow(2,d.transform.tileZoom)/a,_=f*(n.tileID.canonical.x+n.tileID.wrap*a),x=f*n.tileID.canonical.y;return{u_image:0,u_texsize:n.imageAtlasTexture?n.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/r.a6(n,1,d.transform.tileZoom),u_pixel_coord_upper:[_>>16,x>>16],u_pixel_coord_lower:[65535&_,65535&x]}}const Yn=r.a9.create(),lu=(d,n,a,f,_,x,w,S,C,D,z,O,V,U,H,q)=>{const Z=n.style.light,$=Z.properties.get("position"),K=[$.x,$.y,$.z],oe=r.ct.create();Z.properties.get("anchor")==="viewport"&&(r.ct.fromRotation(oe,-n.transform.angle),r.Q.transformMat3(K,K,oe));const se=Z.properties.get("color"),le=n.transform,Y={u_matrix:d,u_lightpos:K,u_lightintensity:Z.properties.get("intensity"),u_lightcolor:[se.r,se.g,se.b],u_vertical_gradient:+a,u_opacity:f,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Yn,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_ao:_,u_edge_radius:x,u_flood_light_color:O,u_vertical_scale:V,u_flood_light_intensity:U,u_ground_shadow_factor:H,u_emissive_strength:q};return le.projection.name==="globe"&&(Y.u_tile_id=[w.canonical.x,w.canonical.y,1<<w.canonical.z],Y.u_zoom_transition=C,Y.u_inv_rot_matrix=z,Y.u_merc_center=D,Y.u_up_dir=le.projection.upVector(new r.bv(0,0,0),D[0]*r.Y,D[1]*r.Y),Y.u_height_lift=S),Y},vs=(d,n,a)=>({u_matrix:d,u_edge_radius:n,u_vertical_scale:a}),Rl=(d,n,a,f,_,x,w,S,C,D,z,O,V,U)=>{const H=lu(d,n,a,f,_,x,w,C,D,z,O,V,U,1,[0,0,0],0),q={u_height_factor:-Math.pow(2,w.overscaledZ)/S.tileSize/8};return r.e(H,zs(n,S),q)},Ea=(d,n)=>({u_matrix:d,u_emissive_strength:n}),go=(d,n,a,f)=>r.e(Ea(d,n),zs(a,f)),dg=(d,n,a)=>({u_matrix:d,u_world:a,u_emissive_strength:n}),Ys=(d,n,a,f,_)=>r.e(go(d,n,a,f),{u_world:_}),fg=(d,n,a,f)=>{const _=r.Y/a.tileSize;return{u_matrix:d,u_camera_to_center_distance:n.getCameraToCenterDistance(f),u_extrude_scale:[n.pixelsToGLUnits[0]/_,n.pixelsToGLUnits[1]/_]}},Hh=(d,n,a=1)=>({u_matrix:d,u_color:n,u_overlay:0,u_overlay_scale:a}),Br=r.a9.create(),pg=(d,n,a,f,_,x,w)=>{const S=d.transform,C=S.projection.name==="globe",D=C?r.cu(S.zoom,n.canonical)*S._pixelsPerMercatorPixel:r.a6(a,1,x),z={u_matrix:n.projMatrix,u_extrude_scale:D,u_intensity:w,u_inv_rot_matrix:Br,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(C){z.u_inv_rot_matrix=f,z.u_merc_center=_,z.u_tile_id=[n.canonical.x,n.canonical.y,1<<n.canonical.z],z.u_zoom_transition=r.W(S.zoom);const O=_[0]*r.Y,V=_[1]*r.Y;z.u_up_dir=S.projection.upVector(new r.bv(0,0,0),O,V)}return z};function zl(d,[n,a,f,_],[x,w]){if(x===w)return[0,0,0,0];const S=255*(d-1)/(d*(w-x));return[n*S,a*S,f*S,_*S]}function Zh(d,n,[a,f]){return a===f?0:.5/d+(n-a)*(d-1)/(d*(f-a))}const bp=(d,n,a,f,_,x,w,S,C,D,z,O,V,U,H,q,Z,$,K,oe,se)=>({u_matrix:d,u_normalize_matrix:n,u_globe_matrix:a,u_merc_matrix:f,u_grid_matrix:_,u_tl_parent:x,u_scale_parent:D,u_fade_t:z.mix,u_opacity:z.opacity*O.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:O.paint.get("raster-brightness-min"),u_brightness_high:O.paint.get("raster-brightness-max"),u_saturation_factor:r.cv(O.paint.get("raster-saturation")),u_contrast_factor:r.cw(O.paint.get("raster-contrast")),u_spin_weights:mg(O.paint.get("raster-hue-rotate")),u_perspective_transform:V,u_raster_elevation:U,u_zoom_transition:w,u_merc_center:S,u_cutoff_params:C,u_colorization_mix:zl(r.cx,q,$),u_colorization_offset:Zh(r.cx,Z,$),u_color_ramp:H,u_texture_offset:[oe/(K+2*oe),K/(K+2*oe)],u_texture_res:[K+2*oe,K+2*oe],u_emissive_strength:se});function mg(d){d*=Math.PI/180;const n=Math.sin(d),a=Math.cos(d);return[(2*a+1)/3,(-Math.sqrt(3)*n-a+1)/3,(Math.sqrt(3)*n-a+1)/3]}const Ll=(d,n,a,f,_,x,w,S,C,D,z,O)=>({u_matrix:d,u_normalize_matrix:n,u_globe_matrix:a,u_merc_matrix:f,u_grid_matrix:_,u_tl_parent:x,u_scale_parent:D,u_fade_t:z.mix,u_opacity:z.opacity,u_image0:0,u_image1:1,u_raster_elevation:O,u_zoom_transition:w,u_merc_center:S,u_cutoff_params:C}),Ol=(d,n,a,f,_,x,w,S,C,D)=>({u_particle_texture:d,u_particle_texture_side_len:n,u_tile_offset:a,u_velocity:f,u_color_ramp:x,u_velocity_res:_,u_max_speed:w,u_uv_offset:S,u_data_scale:C,u_data_offset:D,u_particle_pos_scale:1.3,u_particle_pos_offset:[zo,zo]}),_g=(d,n,a,f,_,x,w,S,C,D)=>({u_particle_texture:d,u_particle_texture_side_len:n,u_velocity:a,u_velocity_res:f,u_max_speed:_,u_speed_factor:x,u_reset_rate:w,u_rand_seed:Math.random(),u_uv_offset:S,u_data_scale:C,u_data_offset:D,u_particle_pos_scale:1.3,u_particle_pos_offset:[zo,zo]}),Uo=r.a9.create(),$h=(d,n,a,f,_,x,w,S,C,D,z,O,V,U,H,q,Z,$)=>{const K=_.transform,oe={u_is_size_zoom_constant:+(d==="constant"||d==="source"),u_is_size_feature_constant:+(d==="constant"||d==="camera"),u_size_t:n?n.uSizeT:0,u_size:n?n.uSize:0,u_camera_to_center_distance:K.getCameraToCenterDistance(q),u_rotate_symbol:+a,u_aspect_ratio:K.width/K.height,u_fade_change:_.options.fadeDuration?_.symbolFadeChange:1,u_matrix:x,u_label_plane_matrix:w,u_coord_matrix:S,u_is_text:+C,u_pitch_with_map:+f,u_texsize:D,u_texture:0,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Uo,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Uo,u_up_vector:[0,-1,0],u_color_adj_mat:Z,u_icon_transition:$||0};return q.name==="globe"&&(oe.u_tile_id=[z.canonical.x,z.canonical.y,1<<z.canonical.z],oe.u_zoom_transition=O,oe.u_inv_rot_matrix=U,oe.u_merc_center=V,oe.u_camera_forward=K._camera.forward(),oe.u_ecef_origin=r.cy(K.globeMatrix,z.toUnwrapped()),oe.u_tile_matrix=Float32Array.from(K.globeMatrix),oe.u_up_vector=H),oe},Aa=(d,n,a,f,_,x,w,S,C,D,z,O,V,U,H,q,Z)=>r.e($h(d,n,a,f,_,x,w,S,C,D,O,V,U,H,q,Z),{u_gamma_scale:f?_.transform.getCameraToCenterDistance(Z)*Math.cos(_.terrain?0:_.transform._pitch):1,u_device_pixel_ratio:r.f.devicePixelRatio,u_is_halo:+z,undefined:void 0}),yo=(d,n,a,f,_,x,w,S,C,D,z,O,V,U,H,q)=>r.e(Aa(d,n,a,f,_,x,w,S,!0,C,!0,z,O,V,U,H,q),{u_texsize_icon:D,u_texture_icon:1}),gg=(d,n,a,f)=>({u_matrix:d,u_emissive_strength:n,u_opacity:a,u_color:f}),yg=(d,n,a,f,_,x,w)=>r.e(function(S,C,D,z){const O=D.imageManager.getPattern(S.toString(),C),{width:V,height:U}=D.imageManager.getPixelSize(C),H=Math.pow(2,z.tileID.overscaledZ),q=z.tileSize*Math.pow(2,D.transform.tileZoom)/H,Z=q*(z.tileID.canonical.x+z.tileID.wrap*H),$=q*z.tileID.canonical.y;return{u_image:0,u_pattern_tl:O.tl,u_pattern_br:O.br,u_texsize:[V,U],u_pattern_size:O.displaySize,u_tile_units_to_pixels:1/r.a6(z,1,D.transform.tileZoom),u_pixel_coord_upper:[Z>>16,$>>16],u_pixel_coord_lower:[65535&Z,65535&$]}}(_,x,f,w),{u_matrix:d,u_emissive_strength:n,u_opacity:a}),Yh=new Float32Array(r.a9.identity([])),cu=(d,n,a,f,_,x,w,S,C,D,z,O,V,U=[0,0,0],H)=>{const q=_.style.light,Z=q.properties.get("position"),$=[-Z.x,-Z.y,Z.z],K=r.ct.create();q.properties.get("anchor")==="viewport"&&(r.ct.fromRotation(K,-_.transform.angle),r.Q.transformMat3($,$,K));const oe=z.alphaMode==="MASK",se=q.properties.get("color"),le=V.paint.get("model-ambient-occlusion-intensity"),Y=V.paint.get("model-color").constantOr(r.aA.white),ee=V.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:d,u_lighting_matrix:n,u_normal_matrix:a,u_node_matrix:f||Yh,u_lightpos:$,u_lightintensity:q.properties.get("intensity"),u_lightcolor:[se.r,se.g,se.b],u_camera_pos:U,u_opacity:x,u_baseTextureIsAlpha:0,u_alphaMask:+oe,u_alphaCutoff:z.alphaCutoff,u_baseColorFactor:[w.r,w.g,w.b,w.a],u_emissiveFactor:[S[0],S[1],S[2],1],u_metallicFactor:C,u_roughnessFactor:D,u_baseColorTexture:Or.BaseColor,u_metallicRoughnessTexture:Or.MetallicRoughness,u_normalTexture:Or.Normal,u_occlusionTexture:Or.Occlusion,u_emissionTexture:Or.Emission,u_color_mix:[Y.r,Y.g,Y.b,ee],u_aoIntensity:le,u_emissive_strength:O,u_occlusionTextureTransform:H||[0,0,0,0]}},wp=(d,n=Yh,a=Yh)=>({u_matrix:d,u_instance:n,u_node_matrix:a}),Qh={fillExtrusion:d=>({u_matrix:new r.bN(d),u_lightpos:new r.bP(d),u_lightintensity:new r.bQ(d),u_lightcolor:new r.bP(d),u_vertical_gradient:new r.bQ(d),u_opacity:new r.bQ(d),u_edge_radius:new r.bQ(d),u_ao:new r.bO(d),u_tile_id:new r.bP(d),u_zoom_transition:new r.bQ(d),u_inv_rot_matrix:new r.bN(d),u_merc_center:new r.bO(d),u_up_dir:new r.bP(d),u_height_lift:new r.bQ(d),u_flood_light_color:new r.bP(d),u_vertical_scale:new r.bQ(d),u_flood_light_intensity:new r.bQ(d),u_ground_shadow_factor:new r.bP(d),u_emissive_strength:new r.bQ(d)}),fillExtrusionDepth:d=>({u_matrix:new r.bN(d),u_edge_radius:new r.bQ(d),u_vertical_scale:new r.bQ(d)}),fillExtrusionPattern:d=>({u_matrix:new r.bN(d),u_lightpos:new r.bP(d),u_lightintensity:new r.bQ(d),u_lightcolor:new r.bP(d),u_vertical_gradient:new r.bQ(d),u_height_factor:new r.bQ(d),u_edge_radius:new r.bQ(d),u_ao:new r.bO(d),u_tile_id:new r.bP(d),u_zoom_transition:new r.bQ(d),u_inv_rot_matrix:new r.bN(d),u_merc_center:new r.bO(d),u_up_dir:new r.bP(d),u_height_lift:new r.bQ(d),u_image:new r.bR(d),u_texsize:new r.bO(d),u_pixel_coord_upper:new r.bO(d),u_pixel_coord_lower:new r.bO(d),u_tile_units_to_pixels:new r.bQ(d),u_opacity:new r.bQ(d)}),fillExtrusionGroundEffect:d=>({u_matrix:new r.bN(d),u_opacity:new r.bQ(d),u_ao_pass:new r.bQ(d),u_meter_to_tile:new r.bQ(d),u_ao:new r.bO(d),u_flood_light_intensity:new r.bQ(d),u_flood_light_color:new r.bP(d),u_attenuation:new r.bQ(d),u_edge_radius:new r.bQ(d),u_fb:new r.bR(d),u_fb_size:new r.bQ(d)}),fill:d=>({u_matrix:new r.bN(d),u_emissive_strength:new r.bQ(d)}),fillPattern:d=>({u_matrix:new r.bN(d),u_emissive_strength:new r.bQ(d),u_image:new r.bR(d),u_texsize:new r.bO(d),u_pixel_coord_upper:new r.bO(d),u_pixel_coord_lower:new r.bO(d),u_tile_units_to_pixels:new r.bQ(d)}),fillOutline:d=>({u_matrix:new r.bN(d),u_emissive_strength:new r.bQ(d),u_world:new r.bO(d)}),fillOutlinePattern:d=>({u_matrix:new r.bN(d),u_emissive_strength:new r.bQ(d),u_world:new r.bO(d),u_image:new r.bR(d),u_texsize:new r.bO(d),u_pixel_coord_upper:new r.bO(d),u_pixel_coord_lower:new r.bO(d),u_tile_units_to_pixels:new r.bQ(d)}),circle:r.cz,collisionBox:d=>({u_matrix:new r.bN(d),u_camera_to_center_distance:new r.bQ(d),u_extrude_scale:new r.bO(d)}),collisionCircle:d=>({u_matrix:new r.bN(d),u_inv_matrix:new r.bN(d),u_camera_to_center_distance:new r.bQ(d),u_viewport_size:new r.bO(d)}),debug:d=>({u_color:new r.cf(d),u_matrix:new r.bN(d),u_overlay:new r.bR(d),u_overlay_scale:new r.bQ(d)}),clippingMask:d=>({u_matrix:new r.bN(d)}),heatmap:d=>({u_extrude_scale:new r.bQ(d),u_intensity:new r.bQ(d),u_matrix:new r.bN(d),u_inv_rot_matrix:new r.bN(d),u_merc_center:new r.bO(d),u_tile_id:new r.bP(d),u_zoom_transition:new r.bQ(d),u_up_dir:new r.bP(d)}),heatmapTexture:d=>({u_image:new r.bR(d),u_color_ramp:new r.bR(d),u_opacity:new r.bQ(d)}),hillshade:d=>({u_matrix:new r.bN(d),u_image:new r.bR(d),u_latrange:new r.bO(d),u_light:new r.bO(d),u_shadow:new r.cf(d),u_highlight:new r.cf(d),u_emissive_strength:new r.bQ(d),u_accent:new r.cf(d)}),hillshadePrepare:d=>({u_matrix:new r.bN(d),u_image:new r.bR(d),u_dimension:new r.bO(d),u_zoom:new r.bQ(d)}),line:r.cA,linePattern:r.cB,raster:d=>({u_matrix:new r.bN(d),u_normalize_matrix:new r.bN(d),u_globe_matrix:new r.bN(d),u_merc_matrix:new r.bN(d),u_grid_matrix:new r.cg(d),u_tl_parent:new r.bO(d),u_scale_parent:new r.bQ(d),u_fade_t:new r.bQ(d),u_opacity:new r.bQ(d),u_image0:new r.bR(d),u_image1:new r.bR(d),u_brightness_low:new r.bQ(d),u_brightness_high:new r.bQ(d),u_saturation_factor:new r.bQ(d),u_contrast_factor:new r.bQ(d),u_spin_weights:new r.bP(d),u_perspective_transform:new r.bO(d),u_raster_elevation:new r.bQ(d),u_zoom_transition:new r.bQ(d),u_merc_center:new r.bO(d),u_cutoff_params:new r.bS(d),u_colorization_mix:new r.bS(d),u_colorization_offset:new r.bQ(d),u_color_ramp:new r.bR(d),u_texture_offset:new r.bO(d),u_texture_res:new r.bO(d),u_emissive_strength:new r.bQ(d)}),rasterParticle:d=>({u_matrix:new r.bN(d),u_normalize_matrix:new r.bN(d),u_globe_matrix:new r.bN(d),u_merc_matrix:new r.bN(d),u_grid_matrix:new r.cg(d),u_tl_parent:new r.bO(d),u_scale_parent:new r.bQ(d),u_fade_t:new r.bQ(d),u_opacity:new r.bQ(d),u_image0:new r.bR(d),u_image1:new r.bR(d),u_raster_elevation:new r.bQ(d),u_zoom_transition:new r.bQ(d),u_merc_center:new r.bO(d),u_cutoff_params:new r.bS(d)}),rasterParticleTexture:d=>({u_texture:new r.bR(d),u_opacity:new r.bQ(d)}),rasterParticleDraw:d=>({u_particle_texture:new r.bR(d),u_particle_texture_side_len:new r.bQ(d),u_tile_offset:new r.bO(d),u_velocity:new r.bR(d),u_color_ramp:new r.bR(d),u_velocity_res:new r.bO(d),u_max_speed:new r.bQ(d),u_uv_offset:new r.bO(d),u_data_scale:new r.bS(d),u_data_offset:new r.bQ(d),u_particle_pos_scale:new r.bQ(d),u_particle_pos_offset:new r.bO(d)}),rasterParticleUpdate:d=>({u_particle_texture:new r.bR(d),u_particle_texture_side_len:new r.bQ(d),u_velocity:new r.bR(d),u_velocity_res:new r.bO(d),u_max_speed:new r.bQ(d),u_speed_factor:new r.bQ(d),u_reset_rate:new r.bQ(d),u_rand_seed:new r.bQ(d),u_uv_offset:new r.bO(d),u_data_scale:new r.bS(d),u_data_offset:new r.bQ(d),u_particle_pos_scale:new r.bQ(d),u_particle_pos_offset:new r.bO(d)}),symbolIcon:d=>({u_is_size_zoom_constant:new r.bR(d),u_is_size_feature_constant:new r.bR(d),u_size_t:new r.bQ(d),u_size:new r.bQ(d),u_camera_to_center_distance:new r.bQ(d),u_rotate_symbol:new r.bR(d),u_aspect_ratio:new r.bQ(d),u_fade_change:new r.bQ(d),u_matrix:new r.bN(d),u_label_plane_matrix:new r.bN(d),u_coord_matrix:new r.bN(d),u_is_text:new r.bR(d),u_pitch_with_map:new r.bR(d),u_texsize:new r.bO(d),u_tile_id:new r.bP(d),u_zoom_transition:new r.bQ(d),u_inv_rot_matrix:new r.bN(d),u_merc_center:new r.bO(d),u_camera_forward:new r.bP(d),u_tile_matrix:new r.bN(d),u_up_vector:new r.bP(d),u_ecef_origin:new r.bP(d),u_texture:new r.bR(d),u_icon_transition:new r.bQ(d),u_color_adj_mat:new r.bN(d)}),symbolSDF:d=>({u_is_size_zoom_constant:new r.bR(d),u_is_size_feature_constant:new r.bR(d),u_size_t:new r.bQ(d),u_size:new r.bQ(d),u_camera_to_center_distance:new r.bQ(d),u_rotate_symbol:new r.bR(d),u_aspect_ratio:new r.bQ(d),u_fade_change:new r.bQ(d),u_matrix:new r.bN(d),u_label_plane_matrix:new r.bN(d),u_coord_matrix:new r.bN(d),u_is_text:new r.bR(d),u_pitch_with_map:new r.bR(d),u_texsize:new r.bO(d),u_texture:new r.bR(d),u_gamma_scale:new r.bQ(d),u_device_pixel_ratio:new r.bQ(d),u_tile_id:new r.bP(d),u_zoom_transition:new r.bQ(d),u_inv_rot_matrix:new r.bN(d),u_merc_center:new r.bO(d),u_camera_forward:new r.bP(d),u_tile_matrix:new r.bN(d),u_up_vector:new r.bP(d),u_ecef_origin:new r.bP(d),u_is_halo:new r.bR(d)}),symbolTextAndIcon:d=>({u_is_size_zoom_constant:new r.bR(d),u_is_size_feature_constant:new r.bR(d),u_size_t:new r.bQ(d),u_size:new r.bQ(d),u_camera_to_center_distance:new r.bQ(d),u_rotate_symbol:new r.bR(d),u_aspect_ratio:new r.bQ(d),u_fade_change:new r.bQ(d),u_matrix:new r.bN(d),u_label_plane_matrix:new r.bN(d),u_coord_matrix:new r.bN(d),u_is_text:new r.bR(d),u_pitch_with_map:new r.bR(d),u_texsize:new r.bO(d),u_texsize_icon:new r.bO(d),u_texture:new r.bR(d),u_texture_icon:new r.bR(d),u_gamma_scale:new r.bQ(d),u_device_pixel_ratio:new r.bQ(d),u_is_halo:new r.bR(d)}),background:d=>({u_matrix:new r.bN(d),u_emissive_strength:new r.bQ(d),u_opacity:new r.bQ(d),u_color:new r.cf(d)}),backgroundPattern:d=>({u_matrix:new r.bN(d),u_emissive_strength:new r.bQ(d),u_opacity:new r.bQ(d),u_image:new r.bR(d),u_pattern_tl:new r.bO(d),u_pattern_br:new r.bO(d),u_texsize:new r.bO(d),u_pattern_size:new r.bO(d),u_pixel_coord_upper:new r.bO(d),u_pixel_coord_lower:new r.bO(d),u_tile_units_to_pixels:new r.bQ(d)}),terrainRaster:Ei,terrainDepth:Ei,skybox:d=>({u_matrix:new r.bN(d),u_sun_direction:new r.bP(d),u_cubemap:new r.bR(d),u_opacity:new r.bQ(d),u_temporal_offset:new r.bQ(d)}),skyboxGradient:d=>({u_matrix:new r.bN(d),u_color_ramp:new r.bR(d),u_center_direction:new r.bP(d),u_radius:new r.bQ(d),u_opacity:new r.bQ(d),u_temporal_offset:new r.bQ(d)}),skyboxCapture:d=>({u_matrix_3f:new r.cg(d),u_sun_direction:new r.bP(d),u_sun_intensity:new r.bQ(d),u_color_tint_r:new r.bS(d),u_color_tint_m:new r.bS(d),u_luminance:new r.bQ(d)}),globeRaster:d=>({u_proj_matrix:new r.bN(d),u_globe_matrix:new r.bN(d),u_normalize_matrix:new r.bN(d),u_merc_matrix:new r.bN(d),u_zoom_transition:new r.bQ(d),u_merc_center:new r.bO(d),u_image0:new r.bR(d),u_grid_matrix:new r.cg(d),u_skirt_height:new r.bQ(d),u_far_z_cutoff:new r.bQ(d),u_frustum_tl:new r.bP(d),u_frustum_tr:new r.bP(d),u_frustum_br:new r.bP(d),u_frustum_bl:new r.bP(d),u_globe_pos:new r.bP(d),u_globe_radius:new r.bQ(d),u_viewport:new r.bO(d)}),globeAtmosphere:d=>({u_frustum_tl:new r.bP(d),u_frustum_tr:new r.bP(d),u_frustum_br:new r.bP(d),u_frustum_bl:new r.bP(d),u_horizon:new r.bQ(d),u_transition:new r.bQ(d),u_fadeout_range:new r.bQ(d),u_color:new r.bS(d),u_high_color:new r.bS(d),u_space_color:new r.bS(d),u_temporal_offset:new r.bQ(d),u_horizon_angle:new r.bQ(d)}),model:d=>({u_matrix:new r.bN(d),u_lighting_matrix:new r.bN(d),u_normal_matrix:new r.bN(d),u_node_matrix:new r.bN(d),u_lightpos:new r.bP(d),u_lightintensity:new r.bQ(d),u_lightcolor:new r.bP(d),u_camera_pos:new r.bP(d),u_opacity:new r.bQ(d),u_baseColorFactor:new r.bS(d),u_emissiveFactor:new r.bS(d),u_metallicFactor:new r.bQ(d),u_roughnessFactor:new r.bQ(d),u_baseTextureIsAlpha:new r.bR(d),u_alphaMask:new r.bR(d),u_alphaCutoff:new r.bQ(d),u_baseColorTexture:new r.bR(d),u_metallicRoughnessTexture:new r.bR(d),u_normalTexture:new r.bR(d),u_occlusionTexture:new r.bR(d),u_emissionTexture:new r.bR(d),u_color_mix:new r.bS(d),u_aoIntensity:new r.bQ(d),u_emissive_strength:new r.bQ(d),u_occlusionTextureTransform:new r.bS(d)}),modelDepth:d=>({u_matrix:new r.bN(d),u_instance:new r.bN(d),u_node_matrix:new r.bN(d)}),groundShadow:d=>({u_matrix:new r.bN(d),u_ground_shadow_factor:new r.bP(d)}),stars:d=>({u_matrix:new r.bN(d),u_up:new r.bP(d),u_right:new r.bP(d),u_intensity_multiplier:new r.bQ(d)})};let Fl;function Xh(d,n,a,f,_,x,w){const S=d.context,C=S.gl,D=d.transform,z=d.getOrCreateProgram("collisionBox"),O=[];let V=0,U=0;for(let se=0;se<f.length;se++){const le=f[se],Y=n.getTile(le),ee=Y.getBucket(a);if(!ee)continue;const me=ks(le,ee,D);let fe=me;_[0]===0&&_[1]===0||(fe=d.translatePosMatrix(me,Y,_,x));const xe=w?ee.textCollisionBox:ee.iconCollisionBox,ke=ee.collisionCircleArray;if(ke.length>0){const ye=r.a9.create(),Pe=fe;r.a9.mul(ye,ee.placementInvProjMatrix,D.glCoordMatrix),r.a9.mul(ye,ye,ee.placementViewportMatrix),O.push({circleArray:ke,circleOffset:U,transform:Pe,invTransform:ye,projection:ee.getProjection()}),V+=ke.length/4,U=V}xe&&(d.terrain&&d.terrain.setupElevationDraw(Y,z),z.draw(d,C.LINES,jt.disabled,ei.disabled,d.colorModeForRenderPass(),Yt.disabled,fg(fe,D,Y,ee.getProjection()),a.id,xe.layoutVertexBuffer,xe.indexBuffer,xe.segments,null,D.zoom,null,[xe.collisionVertexBuffer,xe.collisionVertexBufferExt]))}if(!w||!O.length)return;const H=d.getOrCreateProgram("collisionCircle"),q=new r.cC;q.resize(4*V),q._trim();let Z=0;for(const se of O)for(let le=0;le<se.circleArray.length/4;le++){const Y=4*le,ee=se.circleArray[Y+0],me=se.circleArray[Y+1],fe=se.circleArray[Y+2],xe=se.circleArray[Y+3];q.emplace(Z++,ee,me,fe,xe,0),q.emplace(Z++,ee,me,fe,xe,1),q.emplace(Z++,ee,me,fe,xe,2),q.emplace(Z++,ee,me,fe,xe,3)}(!Fl||Fl.length<2*V)&&(Fl=function(se){const le=2*se,Y=new r.az;Y.resize(le),Y._trim();for(let ee=0;ee<le;ee++){const me=6*ee;Y.uint16[me+0]=4*ee+0,Y.uint16[me+1]=4*ee+1,Y.uint16[me+2]=4*ee+2,Y.uint16[me+3]=4*ee+2,Y.uint16[me+4]=4*ee+3,Y.uint16[me+5]=4*ee+0}return Y}(V));const $=S.createIndexBuffer(Fl,!0),K=S.createVertexBuffer(q,r.cD.members,!0);for(const se of O){const le={u_matrix:se.transform,u_inv_matrix:se.invTransform,u_camera_to_center_distance:(oe=D).getCameraToCenterDistance(se.projection),u_viewport_size:[oe.width,oe.height]};H.draw(d,C.TRIANGLES,jt.disabled,ei.disabled,d.colorModeForRenderPass(),Yt.disabled,le,a.id,K,$,r.aE.simpleSegment(0,2*se.circleOffset,se.circleArray.length,se.circleArray.length/2),null,D.zoom)}var oe;K.destroy(),$.destroy()}const Bl=r.a9.create();function Kh(d){const n=d._camera.getWorldToCamera(d.worldSize,1),a=r.a9.multiply([],n,d.globeMatrix);r.a9.invert(a,a);const f=[0,0,0],_=[0,1,0,0];return r.aa.transformMat4(_,_,a),f[0]=_[0],f[1]=_[1],f[2]=_[2],r.Q.normalize(f,f),f}function jo({width:d,height:n,anchor:a,textOffset:f,textScale:_},x){const{horizontalAlign:w,verticalAlign:S}=r.bi(a),C=-(w-.5)*d,D=-(S-.5)*n,z=r.bh(a,f);return new r.P((C/_+z[0])*x,(D/_+z[1])*x)}function Tp(d,n,a,f,_,x,w,S,C,D,z){const O=d.text.placedSymbolArray,V=d.text.dynamicLayoutVertexArray,U=d.icon.dynamicLayoutVertexArray,H={},q=d.getProjection(),Z=Wc(S,q,x),$=x.elevation,K=q.upVectorScale(S.canonical,x.center.lat,x.worldSize).metersToTile;V.clear();for(let oe=0;oe<O.length;oe++){const se=O.get(oe),{tileAnchorX:le,tileAnchorY:Y,numGlyphs:ee}=se,me=se.hidden||!se.crossTileID||d.allowVerticalPlacement&&!se.placedOrientation?null:f[se.crossTileID];if(me){let fe=0,xe=0,ke=0;if($){const Re=$?$.getAtTileOffset(S,le,Y):0,[ae,Ue,gt]=q.upVector(S.canonical,le,Y);fe=Re*ae*K,xe=Re*Ue*K,ke=Re*gt*K}let[ye,Pe,ze,ge]=Zr(se.projectedAnchorX+fe,se.projectedAnchorY+xe,se.projectedAnchorZ+ke,a?Z:w);const Ae=Nc(x.getCameraToCenterDistance(q),ge);let Ye=_.evaluateSizeForFeature(d.textSizeData,D,se)*Ae/r.bf;a&&(Ye*=d.tilePixelRatio/C);const we=jo(me,Ye);a?({x:ye,y:Pe,z:ze}=q.projectTilePoint(le+we.x,Y+we.y,S.canonical),[ye,Pe,ze]=Zr(ye+fe,Pe+xe,ze+ke,w)):(n&&we._rotate(-x.angle),ye+=we.x,Pe+=we.y,ze=0);const De=d.allowVerticalPlacement&&se.placedOrientation===r.b9.vertical?Math.PI/2:0;for(let Re=0;Re<ee;Re++)r.bc(V,ye,Pe,ze,De);z&&se.associatedIconIndex>=0&&(H[se.associatedIconIndex]={x:ye,y:Pe,z:ze,angle:De})}else Fo(ee,V)}if(z){U.clear();const oe=d.icon.placedSymbolArray;for(let se=0;se<oe.length;se++){const le=oe.get(se),{numGlyphs:Y}=le,ee=H[se];if(le.hidden||!ee)Fo(Y,U);else{const{x:me,y:fe,z:xe,angle:ke}=ee;for(let ye=0;ye<Y;ye++)r.bc(U,me,fe,xe,ke)}}d.icon.dynamicLayoutVertexBuffer.updateData(U)}d.text.dynamicLayoutVertexBuffer.updateData(V)}function Nl(d,n,a,f,_,x,w={}){const S=a.paint.get("icon-translate"),C=a.paint.get("text-translate"),D=a.paint.get("icon-translate-anchor"),z=a.paint.get("text-translate-anchor"),O=a.layout.get("icon-rotation-alignment"),V=a.layout.get("text-rotation-alignment"),U=a.layout.get("icon-pitch-alignment"),H=a.layout.get("text-pitch-alignment"),q=a.layout.get("icon-keep-upright"),Z=a.layout.get("text-keep-upright"),$=a.paint.get("icon-color-saturation"),K=a.paint.get("icon-color-contrast"),oe=a.paint.get("icon-color-brightness-min"),se=a.paint.get("icon-color-brightness-max"),le=d.context,Y=le.gl,ee=d.transform,me=O==="map",fe=V==="map",xe=U==="map",ke=H==="map",ye=a.layout.get("symbol-sort-key").constantOr(1)!==void 0;let Pe=!1;const ze=d.depthModeForSublayer(0,jt.ReadOnly),ge=[r.a8(ee.center.lng),r.ah(ee.center.lat)],Ae=a.layout.get("text-variable-anchor"),Ye=ee.projection.name==="globe",we=[],De=[0,-1,0];for(const Re of f){const ae=n.getTile(Re),Ue=ae.getBucket(a);if(!Ue||Ue.projection.name==="mercator"&&Ye||Ue.fullyClipped)continue;const gt=Ue.projection.name==="globe",Et=gt?r.W(ee.zoom):0,zt=Wc(Re,Ue.getProjection(),ee),Pt=ee.calculatePixelsToTileUnitsMatrix(ae),Ut=Ae&&Ue.hasTextData(),vi=Ue.hasIconTextFit()&&Ut&&Ue.hasIconData(),Jt=Ue.getProjection().createInversionMatrix(ee,Re.canonical),Ti=()=>{const li=me&&a.layout.get("symbol-placement")!=="point",ui=[],rn=li||vi,Ki=a.paint.get("icon-image-cross-fade").constantOr(0);d.terrainRenderModeElevated()&&xe&&ui.push("PITCH_WITH_MAP_TERRAIN"),gt&&(ui.push("PROJECTION_GLOBE_VIEW"),rn&&ui.push("PROJECTED_POS_ON_VIEWPORT")),Ki>0&&ui.push("ICON_TRANSITION"),Ue.icon.zOffsetVertexBuffer&&ui.push("Z_OFFSET"),$===0&&K===0&&oe===0&&se===1||ui.push("COLOR_ADJUSTMENT");const _i=Ue.icon.programConfigurations.get(a.id),ni=d.getOrCreateProgram(Ue.sdfIcons?"symbolSDF":"symbolIcon",{config:_i,defines:ui});let Rr;const gr=ae.imageAtlasTexture?ae.imageAtlasTexture.size:[0,0],Qn=Ue.iconSizeData,yr=r.b8(Qn,ee.zoom),zr=xe||ee.pitch!==0,Tr=_l(zt,ae.tileID.canonical,xe,me,ee,Ue.getProjection(),Pt),Xn=Zs(zt,ae.tileID.canonical,xe,me,ee,Ue.getProjection(),Pt),cr=d.translatePosMatrix(Xn,ae,S,D,!0),ur=d.translatePosMatrix(zt,ae,S,D),Os=rn?Bl:Tr,ws=me&&!xe&&!li;let Fs=De;!Ye&&!ee.mercatorFromTransition||me||(Fs=Kh(ee));const Bs=gt?Fs:De;if(Ue.sdfIcons&&!Ue.iconsInText)Rr=Aa(Qn.kind,yr,ws,xe,d,ur,Os,cr,!1,gr,!0,Re,Et,ge,Jt,Bs,Ue.getProjection());else{const Ks=a.getColorAdjustmentMatrix($,K,oe,se);Rr=$h(Qn.kind,yr,ws,xe,d,ur,Os,cr,!1,gr,Re,Et,ge,Jt,Bs,Ue.getProjection(),Ks,Ki)}const To=ae.imageAtlasTexture?ae.imageAtlasTexture:null,ts=a.layout.get("icon-size").constantOr(0)!==1||Ue.iconsNeedLinear,Jl=Ue.sdfIcons||d.options.rotating||d.options.zooming||ts||zr?Y.LINEAR:Y.NEAREST,Fa=Ue.sdfIcons&&a.paint.get("icon-halo-width").constantOr(1)!==0,ec=d.terrain&&xe&&li?r.a9.invert(r.a9.create(),Tr):Bl;if(li&&Ue.icon){const Ks=ee.elevation,Kn=Ks?Ks.getAtTileOffsetFunc(Re,ee.center.lat,ee.worldSize,Ue.getProjection()):null,tc=gl(zt,ae.tileID.canonical,xe,me,ee,Ue.getProjection(),Pt);Uc(Ue,zt,d,!1,tc,Xn,xe,q,Kn,Re)}return{program:ni,buffers:Ue.icon,uniformValues:Rr,atlasTexture:To,atlasTextureIcon:null,atlasInterpolation:Jl,atlasInterpolationIcon:null,isSDF:Ue.sdfIcons,hasHalo:Fa,tile:ae,labelPlaneMatrixInv:ec}},bi=()=>{const li=fe&&a.layout.get("symbol-placement")!=="point",ui=[],rn=li||Ae||vi;d.terrainRenderModeElevated()&&ke&&ui.push("PITCH_WITH_MAP_TERRAIN"),gt&&(ui.push("PROJECTION_GLOBE_VIEW"),rn&&ui.push("PROJECTED_POS_ON_VIEWPORT")),Ue.text.zOffsetVertexBuffer&&ui.push("Z_OFFSET");const Ki=Ue.text.programConfigurations.get(a.id),_i=d.getOrCreateProgram(Ue.iconsInText?"symbolTextAndIcon":"symbolSDF",{config:Ki,defines:ui});let ni,Rr=[0,0],gr=null;const Qn=Ue.textSizeData;Ue.iconsInText&&(Rr=ae.imageAtlasTexture?ae.imageAtlasTexture.size:[0,0],gr=ae.imageAtlasTexture?ae.imageAtlasTexture:null,ni=ke||ee.pitch!==0||d.options.rotating||d.options.zooming||Qn.kind==="composite"||Qn.kind==="camera"?Y.LINEAR:Y.NEAREST);const yr=ae.glyphAtlasTexture?ae.glyphAtlasTexture.size:[0,0],zr=r.b8(Qn,ee.zoom),Tr=_l(zt,ae.tileID.canonical,ke,fe,ee,Ue.getProjection(),Pt),Xn=Zs(zt,ae.tileID.canonical,ke,fe,ee,Ue.getProjection(),Pt),cr=d.translatePosMatrix(Xn,ae,C,z,!0),ur=d.translatePosMatrix(zt,ae,C,z),Os=rn?Bl:Tr,ws=fe&&!ke&&!li;let Fs=De;!Ye&&!ee.mercatorFromTransition||fe||(Fs=Kh(ee));const Bs=gt?Fs:De;let To;To=Ue.iconsInText?yo(Qn.kind,zr,ws,ke,d,ur,Os,cr,yr,Rr,Re,Et,ge,Jt,Bs,Ue.getProjection()):Aa(Qn.kind,zr,ws,ke,d,ur,Os,cr,!0,yr,!0,Re,Et,ge,Jt,Bs,Ue.getProjection());const ts=ae.glyphAtlasTexture?ae.glyphAtlasTexture:null,Jl=Y.LINEAR,Fa=a.paint.get("text-halo-width").constantOr(1)!==0,ec=d.terrain&&ke&&li?r.a9.invert(r.a9.create(),Tr):Bl;if(li&&Ue.text){const Ks=ee.elevation,Kn=Ks?Ks.getAtTileOffsetFunc(Re,ee.center.lat,ee.worldSize,Ue.getProjection()):null,tc=gl(zt,ae.tileID.canonical,ke,fe,ee,Ue.getProjection(),Pt);Uc(Ue,zt,d,!0,tc,Xn,ke,Z,Kn,Re)}return{program:_i,buffers:Ue.text,uniformValues:To,atlasTexture:ts,atlasTextureIcon:gr,atlasInterpolation:Jl,atlasInterpolationIcon:ni,isSDF:!0,hasHalo:Fa,tile:ae,labelPlaneMatrixInv:ec}},hn=Ue.icon.segments.get().length,Ni=Ue.text.segments.get().length,Gn=hn&&!w.onlyText?Ti():null,Dn=Ni&&!w.onlyIcons?bi():null,Xi=a.paint.get("icon-opacity").constantOr(1),Gi=a.paint.get("text-opacity").constantOr(1);if(ye&&Ue.canOverlap){Pe=!0;const li=Xi&&!w.onlyText?Ue.icon.segments.get():[],ui=Gi&&!w.onlyIcons?Ue.text.segments.get():[];for(const rn of li)we.push({segments:new r.aE([rn]),sortKey:rn.sortKey,state:Gn});for(const rn of ui)we.push({segments:new r.aE([rn]),sortKey:rn.sortKey,state:Dn})}else w.onlyText||we.push({segments:Xi?Ue.icon.segments:new r.aE([]),sortKey:0,state:Gn}),w.onlyIcons||we.push({segments:Gi?Ue.text.segments:new r.aE([]),sortKey:0,state:Dn})}Pe&&we.sort((Re,ae)=>Re.sortKey-ae.sortKey);for(const Re of we){const ae=Re.state;if(ae)if(d.terrain&&d.terrain.setupElevationDraw(ae.tile,ae.program,{useDepthForOcclusion:ee.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:ae.labelPlaneMatrixInv}),le.activeTexture.set(Y.TEXTURE0),ae.atlasTexture&&ae.atlasTexture.bind(ae.atlasInterpolation,Y.CLAMP_TO_EDGE,!0),ae.atlasTextureIcon&&(le.activeTexture.set(Y.TEXTURE1),ae.atlasTextureIcon&&ae.atlasTextureIcon.bind(ae.atlasInterpolationIcon,Y.CLAMP_TO_EDGE,!0)),d.uploadCommonLightUniforms(d.context,ae.program),ae.hasHalo){const Ue=ae.uniformValues;Ue.u_is_halo=1,uu(ae.buffers,Re.segments,a,d,ae.program,ze,_,x,Ue,2),Ue.u_is_halo=0}else{if(ae.isSDF){const Ue=ae.uniformValues;ae.hasHalo&&(Ue.u_is_halo=1,uu(ae.buffers,Re.segments,a,d,ae.program,ze,_,x,Ue,1)),Ue.u_is_halo=0}uu(ae.buffers,Re.segments,a,d,ae.program,ze,_,x,ae.uniformValues,1)}}}function uu(d,n,a,f,_,x,w,S,C,D){const z=[d.dynamicLayoutVertexBuffer,d.opacityVertexBuffer,d.iconTransitioningVertexBuffer,d.globeExtVertexBuffer,d.zOffsetVertexBuffer];_.draw(f,f.context.gl.TRIANGLES,x,w,S,Yt.disabled,C,a.id,d.layoutVertexBuffer,d.indexBuffer,n,a.paint,f.transform.zoom,d.programConfigurations.get(a.id),z,D)}function hu(d,n,a,f,_,x,w){const S=d.context.gl,C=a.paint.get("fill-pattern"),D=C&&C.constantOr(1);let z,O,V,U,H;w?(O=D&&!a.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",z=S.LINES):(O=D?"fillPattern":"fill",z=S.TRIANGLES);for(const q of f){const Z=n.getTile(q);if(D&&!Z.patternsLoaded())continue;const $=Z.getBucket(a);if(!$)continue;d.prepareDrawTile();const K=$.programConfigurations.get(a.id),oe=d.isTileAffectedByFog(q),se=d.getOrCreateProgram(O,{config:K,overrideFog:oe});D&&(d.context.activeTexture.set(S.TEXTURE0),Z.imageAtlasTexture&&Z.imageAtlasTexture.bind(S.LINEAR,S.CLAMP_TO_EDGE),K.updatePaintBuffers());const le=C.constantOr(null);if(le&&Z.imageAtlas){const me=Z.imageAtlas.patternPositions[le.toString()];me&&K.setConstantPatternPositions(me)}const Y=d.translatePosMatrix(q.projMatrix,Z,a.paint.get("fill-translate"),a.paint.get("fill-translate-anchor")),ee=a.paint.get("fill-emissive-strength");if(w){U=$.indexBuffer2,H=$.segments2;const me=d.terrain&&d.terrain.renderingToTexture?d.terrain.drapeBufferSize:[S.drawingBufferWidth,S.drawingBufferHeight];V=O==="fillOutlinePattern"&&D?Ys(Y,ee,d,Z,me):dg(Y,ee,me)}else U=$.indexBuffer,H=$.segments,V=D?go(Y,ee,d,Z):Ea(Y,ee);d.uploadCommonUniforms(d.context,se,q.toUnwrapped()),se.draw(d,z,_,d.stencilModeForClipping(q),x,Yt.disabled,V,a.id,$.layoutVertexBuffer,U,H,a.paint,d.transform.zoom,K,void 0)}}function pt(d,n,a,f,_,x,w,S){a.resetLayerRenderingStats(d);const C=d.context,D=C.gl,z=d.transform,O=a.paint.get("fill-extrusion-pattern"),V=O.constantOr(1),U=a.paint.get("fill-extrusion-opacity"),H=d.style.enable3dLights(),q=a.paint.get(H&&!V?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),Z=[a.paint.get("fill-extrusion-ambient-occlusion-intensity"),q],$=a.layout.get("fill-extrusion-edge-radius"),K=$>0&&!a.paint.get("fill-extrusion-rounded-roof"),oe=K?0:$,se=z.projection.name==="globe"?r.cM():0,le=z.projection.name==="globe",Y=le?r.W(z.zoom):0,ee=[r.a8(z.center.lng),r.ah(z.center.lat)],me=a.paint.get("fill-extrusion-flood-light-color").toArray01().slice(0,3),fe=a.paint.get("fill-extrusion-flood-light-intensity"),xe=a.paint.get("fill-extrusion-vertical-scale"),ke=po(d,a.paint.get("fill-extrusion-cutoff-fade-range")),ye=a.paint.get("fill-extrusion-emissive-strength"),Pe=[];let ze;le&&Pe.push("PROJECTION_GLOBE_VIEW"),Z[0]>0&&Pe.push("FAUX_AO"),K&&Pe.push("ZERO_ROOF_RADIUS"),S&&Pe.push("HAS_CENTROID"),fe>0&&Pe.push("FLOOD_LIGHT"),ke.shouldRenderCutoff&&Pe.push("RENDER_CUTOFF");const ge=d.renderPass==="shadow",Ae=d.shadowRenderer,Ye=ge&&!!Ae;d.shadowRenderer&&(d.shadowRenderer.useNormalOffset=!0);let we=[0,0,0];if(Ae){const ae=d.style.directionalLight,Ue=d.style.ambientLight;ae&&Ue&&(we=Vh(ae,Ue)),ze=Pe.concat(["SHADOWS_SINGLE_CASCADE"])}const De=Ye?"fillExtrusionDepth":V?"fillExtrusionPattern":"fillExtrusion",Re=a.getLayerRenderingStats();for(const ae of f){const Ue=n.getTile(ae),gt=Ue.getBucket(a);if(!gt||gt.projection.name!==z.projection.name)continue;let Et=!1;Ae&&(Et=Ae.getMaxCascadeForTile(ae.toUnwrapped())===0);const zt=d.isTileAffectedByFog(ae),Pt=gt.programConfigurations.get(a.id),Ut=d.getOrCreateProgram(De,{config:Pt,defines:Et?ze:Pe,overrideFog:zt});if(d.terrain&&d.terrain.setupElevationDraw(Ue,Ut,{useMeterToDem:!0}),!gt.centroidVertexBuffer){const Ni=Ut.attributes.a_centroid_pos;Ni!==void 0&&D.vertexAttrib2f(Ni,0,0)}!ge&&Ae&&Ae.setupShadows(Ue.tileID.toUnwrapped(),Ut,"vector-tile",Ue.tileID.overscaledZ),V&&(d.context.activeTexture.set(D.TEXTURE0),Ue.imageAtlasTexture&&Ue.imageAtlasTexture.bind(D.LINEAR,D.CLAMP_TO_EDGE),Pt.updatePaintBuffers());const vi=O.constantOr(null);if(vi&&Ue.imageAtlas){const Ni=Ue.imageAtlas.patternPositions[vi.toString()];Ni&&Pt.setConstantPatternPositions(Ni)}const Jt=a.paint.get("fill-extrusion-vertical-gradient");let Ti;if(ge&&Ae){if(Qs(Ue.tileID,gt,d))continue;const Ni=Ae.calculateShadowPassMatrixFromTile(Ue.tileID.toUnwrapped());Ti=vs(Ni,oe,xe)}else{const Ni=d.translatePosMatrix(ae.expandedProjMatrix,Ue,a.paint.get("fill-extrusion-translate"),a.paint.get("fill-extrusion-translate-anchor")),Gn=z.projection.createInversionMatrix(z,ae.canonical);Ti=V?Rl(Ni,d,Jt,U,Z,oe,ae,Ue,se,Y,ee,Gn,me,xe):lu(Ni,d,Jt,U,Z,oe,ae,se,Y,ee,Gn,me,xe,fe,we,ye)}d.uploadCommonUniforms(C,Ut,ae.toUnwrapped(),null,ke);let bi=gt.segments;if(z.projection.name==="mercator"&&!ge&&(bi=gt.getVisibleSegments(Ue.tileID,d.terrain,d.transform.getFrustum(0)),!bi.get().length))continue;if(Re)if(ge)for(const Ni of bi.get())Re.numRenderedVerticesInShadowPass+=Ni.primitiveLength;else for(const Ni of bi.get())Re.numRenderedVerticesInTransparentPass+=Ni.primitiveLength;const hn=[];(d.terrain||S)&&hn.push(gt.centroidVertexBuffer),le&&hn.push(gt.layoutVertexExtBuffer),Ut.draw(d,C.gl.TRIANGLES,_,x,w,Yt.backCCW,Ti,a.id,gt.layoutVertexBuffer,gt.indexBuffer,bi,a.paint,d.transform.zoom,Pt,hn)}d.shadowRenderer&&(d.shadowRenderer.useNormalOffset=!1)}function Go(d,n,a,f,_,x,w,S,C,D,z,O,V,U,H,q,Z,$,K){const oe=d.context,se=oe.gl,le=d.transform,Y=d.transform.zoom,ee=[],me=po(d,a.paint.get("fill-extrusion-cutoff-fade-range"));D==="clear"?(ee.push("CLEAR_SUBPASS"),K&&(ee.push("CLEAR_FROM_TEXTURE"),oe.activeTexture.set(se.TEXTURE0),K.bind(se.LINEAR,se.CLAMP_TO_EDGE))):D==="sdf"&&ee.push("SDF_SUBPASS"),Z&&ee.push("HAS_CENTROID"),me.shouldRenderCutoff&&ee.push("RENDER_CUTOFF");const fe=a.layout.get("fill-extrusion-edge-radius"),xe=(ke,ye,Pe,ze,ge)=>{const Ae=ye.programConfigurations.get(a.id),Ye=d.isTileAffectedByFog(ke),we=d.getOrCreateProgram("fillExtrusionGroundEffect",{config:Ae,defines:ee,overrideFog:Ye}),De=((ae,Ue,gt,Et,zt,Pt,Ut,vi,Jt,Ti,bi)=>({u_matrix:Ue,u_opacity:gt,u_ao_pass:Et?1:0,u_meter_to_tile:zt,u_ao:Pt,u_flood_light_intensity:Ut,u_flood_light_color:vi,u_attenuation:Jt,u_edge_radius:Ti,u_fb:0,u_fb_size:bi}))(0,ze,z,C,ge,[O,V*ge],U,H,q,Y>=17?0:fe*ge,K?K.size[0]:0),Re=[];Z&&Re.push(ye.hiddenByLandmarkVertexBuffer),d.uploadCommonUniforms(oe,we,ke.toUnwrapped(),null,me),we.draw(d,oe.gl.TRIANGLES,_,x,w,S,De,a.id,ye.vertexBuffer,ye.indexBuffer,Pe,a.paint,Y,Ae,Re)};for(const ke of f){const ye=n.getTile(ke),Pe=ye.getBucket(a);if(!Pe||Pe.projection.name!==le.projection.name||!Pe.groundEffect||Pe.groundEffect&&!Pe.groundEffect.hasData())continue;const ze=Pe.groundEffect,ge=1/Pe.tileToMeter;{const Ae=d.translatePosMatrix(ke.projMatrix,ye,a.paint.get("fill-extrusion-translate"),a.paint.get("fill-extrusion-translate-anchor")),Ye=ze.getDefaultSegment();xe(ke,ze,Ye,Ae,ge)}if($)for(let Ae=0;Ae<4;Ae++){const Ye=r.cN[Ae](ke),we=n.getTile(Ye);if(!we)continue;const De=we.getBucket(a);if(!De||De.projection.name!==le.projection.name||!De.groundEffect||De.groundEffect&&!De.groundEffect.hasData())continue;const Re=De.groundEffect;let ae,Ue;Ae===0?(ae=[-r.Y,0,0],Ue=1):Ae===1?(ae=[r.Y,0,0],Ue=0):Ae===2?(ae=[0,-r.Y,0],Ue=3):(ae=[0,r.Y,0],Ue=2);const gt=Re.regionSegments[Ue];if(!gt)continue;const Et=new Float32Array(16);r.a9.translate(Et,ke.projMatrix,ae),xe(ke,Re,gt,d.translatePosMatrix(Et,ye,a.paint.get("fill-extrusion-translate"),a.paint.get("fill-extrusion-translate-anchor")),ge)}}}function Jh(d,n,a,f,_,x,w){f.centroidVertexArray.length===0&&f.createCentroidsBuffer();const S=x?x.findDEMTileFor(a):null;if(!(S&&S.dem||w))return;const C=$=>new r.P(Math.ceil(($+r.cQ)*r.cR),0),D=$=>{const K=n.getSource().minzoom,oe=le=>{const Y=n.getTileByID(le);if(Y&&Y.hasData())return Y.getBucket(_)},se=[0,-1,1];for(const le of se){if($.overscaledZ+le<K)continue;const Y=oe($.calculateScaledKey($.overscaledZ+le));if(Y)return Y}},z=[0,0,0],O=($,K)=>(z[0]=Math.min($.min.y,K.min.y),z[1]=Math.max($.max.y,K.max.y),z[2]=r.Y-K.min.x>$.max.x?K.min.x-r.Y:$.max.x,z),V=($,K)=>(z[0]=Math.min($.min.x,K.min.x),z[1]=Math.max($.max.x,K.max.x),z[2]=r.Y-K.min.y>$.max.y?K.min.y-r.Y:$.max.y,z),U=[($,K)=>O($,K),($,K)=>O(K,$),($,K)=>V($,K),($,K)=>V(K,$)],H=($,K,oe,se,le,Y,ee)=>{if(!x)return 0;const me=[[Y?oe:$,Y?$:oe,0],[Y?oe:K,Y?K:oe,0]],fe=ee<0?r.Y+ee:ee,xe=[Y?fe:($+K)/2,Y?($+K)/2:fe,0];return oe===0&&ee<0||oe!==0&&ee>0?x.getForTilePoints(le,[xe],!0,se):me.push(xe),x.getForTilePoints(a,me,!0,S),Math.max(me[0][2],me[1][2],xe[2])/x.exaggeration()};for(let $=0;$<4;$++){const K=f.borderFeatureIndices[$];if(K.length===0)continue;const oe=r.cN[$](a),se=D(oe);if(!(se&&se instanceof r.cO)||f.borderDoneWithNeighborZ[$]===se.canonical.z)continue;se.centroidVertexArray.length===0&&se.createCentroidsBuffer();const le=x?x.findDEMTileFor(oe):null;if(!(le&&le.dem||w))continue;const Y=($<2?1:5)-$,ee=se.borderDoneWithNeighborZ[Y]!==f.canonical.z,me=se.borderFeatureIndices[Y];let fe=0;if(f.canonical.z!==se.canonical.z){for(const xe of K)f.showCentroid(f.featuresOnBorder[xe]);if(ee)for(const xe of me)se.showCentroid(se.featuresOnBorder[xe]);f.borderDoneWithNeighborZ[$]=se.canonical.z,se.borderDoneWithNeighborZ[Y]=f.canonical.z}for(const xe of K){const ke=f.featuresOnBorder[xe],ye=f.centroidData[ke.centroidDataIndex],Pe=ke.borders[$];let ze;for(;fe<me.length;){ze=se.featuresOnBorder[me[fe]];const ge=ze.borders[Y];if(ge[1]>Pe[0]+3||ge[0]>Pe[0]-3)break;se.showCentroid(ze),fe++}if(ze&&fe<me.length){const ge=fe;let Ae=0;for(;!(ze.borders[Y][0]>Pe[1]-3)&&(Ae++,++fe!==me.length);)ze=se.featuresOnBorder[me[fe]];if(ze=se.featuresOnBorder[me[ge]],Ae>1){const De=ze.borders[Y];Math.abs(Pe[0]-De[0])<3&&Math.abs(Pe[1]-De[1])<3&&(Ae=1,fe=ge+1)}else if(Ae===0){f.showCentroid(ke);continue}const Ye=se.centroidData[ze.centroidDataIndex];w&&Ae===1&&(((q=ye).flags|(Z=Ye).flags)&r.cP?(q.flags|=r.cP,Z.flags|=r.cP):(q.flags&=~r.cP,Z.flags&=~r.cP));const we=ke.intersectsCount()>1||ze.intersectsCount()>1;if(Ae>1)fe=ge,ye.centroidXY=Ye.centroidXY=new r.P(0,0);else if(le&&le.dem&&!we){const De=U[$](ye,Ye),Re=$%2?r.Y-1:0,ae=H(De[0],Math.min(r.Y-1,De[1]),Re,le,oe,$<2,De[2]);ye.centroidXY=Ye.centroidXY=C(ae)}else we?ye.centroidXY=Ye.centroidXY=new r.P(0,0):(ye.centroidXY=f.encodeBorderCentroid(ke),Ye.centroidXY=se.encodeBorderCentroid(ze));f.writeCentroidToBuffer(ye),se.writeCentroidToBuffer(Ye)}else f.showCentroid(ke)}f.borderDoneWithNeighborZ[$]=se.canonical.z,se.borderDoneWithNeighborZ[Y]=f.canonical.z}var q,Z;(f.needsCentroidUpdate||!f.centroidVertexBuffer&&f.centroidVertexArray.length!==0)&&f.uploadCentroid(d)}const ed=[1,0,0],Mp=[0,1,0],du=[0,0,1];function Qs(d,n,a){const f=a.transform,_=a.shadowRenderer;if(!_)return!0;const x=d.toUnwrapped(),w=f.tileSize*_._cascades[a.currentShadowCascade].scale;let S=n.maxHeight;if(f.elevation){const q=f.elevation.getMinMaxForTile(d);q&&(S+=q.max)}const C=[..._.shadowDirection];C[2]=-C[2];const D=_.computeSimplifiedTileShadowVolume(x,S,w,C);if(!D)return!1;const z=[ed,Mp,du,C,[C[0],0,C[2]],[0,C[1],C[2]]],O=f.projection.name==="globe",V=f.scaleZoom(w),U=r.bt.fromInvProjectionMatrix(f.invProjMatrix,f.worldSize,V,!O),H=_.getCurrentCascadeFrustum();return U.intersectsPrecise(D.vertices,D.planes,z)===0||H.intersectsPrecise(D.vertices,D.planes,z)===0}function fu(d){return[d[0]*r.cS,d[1]*r.cS,d[2]*r.cS,0]}function Xs(d,n,a,f,_,x,w,S,C){const D=f.getSource(),z=a.globeSharedBuffers;if(!z)return;let O,V,U;if(n&&(O=f.getTile(n)),D instanceof r.as?(V=D.texture,U=r.co(0,0,a.transform)):O&&n&&(V=O.texture,U=r.co(n.canonical.z,n.canonical.x,a.transform)),!V||!U)return;d||(U=r.a9.scale(r.a9.create(),U,[1,-1,1]));const H=a.context,q=H.gl,Z=_.paint.get("raster-resampling")==="nearest"?q.NEAREST:q.LINEAR,$=a.colorModeForDrapableLayerRenderPass(x),K=w.defines;K.push("GLOBE_POLES");const oe=new jt(q.LEQUAL,jt.ReadWrite,a.depthRangeFor3D),se=Float32Array.from(a.transform.expandedFarZProjMatrix),le=Float32Array.from(r.aW(r.cn(new r.bv(0,0,0))));a.terrain&&a.terrain.prepareDrawTile(),H.activeTexture.set(q.TEXTURE0),V.bind(Z,q.CLAMP_TO_EDGE),H.activeTexture.set(q.TEXTURE1),V.bind(Z,q.CLAMP_TO_EDGE),V.useMipmap&&H.extTextureFilterAnisotropic&&a.transform.pitch>20&&q.texParameterf(q.TEXTURE_2D,H.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,H.extTextureFilterAnisotropicMax);const[Y,ee,me,fe]=n?z.getPoleBuffers(n.canonical.z,!1):z.getPoleBuffers(0,!0),xe=_.paint.get("raster-elevation");let ke;d?(ke=Y,a.renderDefaultNorthPole=xe!==0):(ke=ee,a.renderDefaultSouthPole=xe!==0);const ye=fu(w.mix),Pe=((ge,Ae,Ye,we,De,Re,ae,Ue,gt,Et,zt,Pt,Ut)=>bp(ge,Ae,Ye,new Float32Array(16),new Float32Array(9),[0,0],we,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Re,[0,0],Ue,2,Et,zt,Pt,1,0,Ut))(se,le,U,r.W(a.transform.zoom),0,_,0,xe,0,ye,w.offset,w.range,x),ze=a.getOrCreateProgram("raster",{defines:K});a.uploadCommonUniforms(H,ze,null),ze.draw(a,q.TRIANGLES,oe,C,$,S,Pe,_.id,ke,me,fe)}function pu(d){const n=d._nearZ,a=d.projection.farthestPixelDistance(d),f=a-n,_=.2*d.height,x=n+_;return[n,a,(x-_-n)/f,(x-n)/f]}function Ia(d,n,a,f){if(d)return n instanceof ut&&d instanceof Fc?n.getTextureDescriptor(d,a,!0):{texture:d.texture,mix:fu(f.mix),offset:f.offset,buffer:0,tileSize:1}}function xg(d,n,a){if(!d)return null;const f=n.getTextureDescriptor(d,a,!0);if(!f)return null;let{texture:_,mix:x,offset:w,tileSize:S,buffer:C,format:D}=f;if(!_||!D)return null;let z=!1;return D==="uint32"&&(z=!0,x[3]=0,x=zl(r.cT,x,[0,a.paint.get("raster-particle-max-speed")]),w=Zh(r.cT,w,[0,a.paint.get("raster-particle-max-speed")])),{texture:_,textureOffset:[C/(S+2*C),S/(S+2*C)],tileSize:S,scalarData:z,scale:x,offset:w,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[D]]}}function vg(d){const n=d._nearZ,a=d.projection.farthestPixelDistance(d),f=a-n,_=.2*d.height,x=n+_;return[n,a,(x-_-n)/f,(x-n)/f]}const td=new r.aA(1,0,0,1),bg=new r.aA(0,1,0,1),Sp=new r.aA(0,0,1,1),Ep=new r.aA(1,0,1,1),id=new r.aA(0,1,1,1);function Ca(d,n,a,f,_,x,w){const S=d.context,C=d.transform,D=S.gl,z=C.projection.name==="globe",O=z?["PROJECTION_GLOBE_VIEW"]:[];let V=r.a9.clone(a.projMatrix);if(z&&r.W(C.zoom)>0){const ye=r.aV(a.canonical,C),Pe=r.cU(ye);V=r.a9.multiply(new Float32Array(16),C.globeMatrix,Pe),r.a9.multiply(V,C.projMatrix,V)}const U=r.a9.create();U[12]+=2*_/(r.f.devicePixelRatio*C.width),U[13]+=2*x/(r.f.devicePixelRatio*C.height),r.a9.multiply(V,U,V);const H=d.getOrCreateProgram("debug",{defines:O}),q=n.getTileByID(a.key);d.terrain&&d.terrain.setupElevationDraw(q,H);const Z=jt.disabled,$=ei.disabled,K=d.colorModeForRenderPass(),oe="$debug";S.activeTexture.set(D.TEXTURE0),d.emptyTexture.bind(D.LINEAR,D.CLAMP_TO_EDGE),z?q._makeGlobeTileDebugBuffers(d.context,C):q._makeDebugTileBoundsBuffers(d.context,C.projection);const se=q._tileDebugBuffer||d.debugBuffer,le=q._tileDebugIndexBuffer||d.debugIndexBuffer,Y=q._tileDebugSegments||d.debugSegments;if(H.draw(d,D.LINE_STRIP,Z,$,K,Yt.disabled,Hh(V,f),oe,se,le,Y,null,null,null,[q._globeTileDebugBorderBuffer]),w){const ye=q.latestRawTileData,Pe=Math.floor((ye&&ye.byteLength||0)/1024);let ze=a.canonical.toString();a.overscaledZ!==a.canonical.z&&(ze+=` => ${a.overscaledZ}`),ze+=` ${q.state}`,ze+=` ${Pe}kb`,function(ge,Ae){ge.initDebugOverlayCanvas();const Ye=ge.debugOverlayCanvas,we=ge.context.gl,De=ge.debugOverlayCanvas.getContext("2d");De.clearRect(0,0,Ye.width,Ye.height),De.shadowColor="white",De.shadowBlur=2,De.lineWidth=1.5,De.strokeStyle="white",De.textBaseline="top",De.font="bold 36px Open Sans, sans-serif",De.fillText(Ae,5,5),De.strokeText(Ae,5,5),ge.debugOverlayTexture.update(Ye),ge.debugOverlayTexture.bind(we.LINEAR,we.CLAMP_TO_EDGE)}(d,ze)}const ee=n.getTile(a).tileSize,me=512/Math.min(ee,512)*(a.overscaledZ/C.zoom)*.5,fe=q._tileDebugTextBuffer||d.debugBuffer,xe=q._tileDebugTextIndexBuffer||d.quadTriangleIndexBuffer,ke=q._tileDebugTextSegments||d.debugSegments;H.draw(d,D.TRIANGLES,Z,$,pi.alphaBlended,Yt.disabled,Hh(V,r.aA.transparent,me),oe,fe,xe,ke,null,null,null,[q._globeTileDebugTextBuffer])}function Ap(d,n,a,f){mu(d,0,n+a/2,d.transform.width,a,f)}function Ip(d,n,a,f){mu(d,n-a/2,0,a,d.transform.height,f)}function mu(d,n,a,f,_,x){const w=d.context,S=w.gl;S.enable(S.SCISSOR_TEST),S.scissor(n*r.f.devicePixelRatio,a*r.f.devicePixelRatio,f*r.f.devicePixelRatio,_*r.f.devicePixelRatio),w.clear({color:x}),S.disable(S.SCISSOR_TEST)}const Cp=r.aB([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:wg}=Cp;function bs(d,n,a,f){d.emplaceBack(n,a,f)}class Pp{constructor(n){this.vertexArray=new r.cV,this.indices=new r.az,bs(this.vertexArray,-1,-1,1),bs(this.vertexArray,1,-1,1),bs(this.vertexArray,-1,1,1),bs(this.vertexArray,1,1,1),bs(this.vertexArray,-1,-1,-1),bs(this.vertexArray,1,-1,-1),bs(this.vertexArray,-1,1,-1),bs(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=n.createVertexBuffer(this.vertexArray,wg),this.indexBuffer=n.createIndexBuffer(this.indices),this.segment=r.aE.simpleSegment(0,0,36,12)}}function Wo(d,n,a,f,_,x){const w=d.context.gl,S=n.paint.get("sky-atmosphere-color"),C=n.paint.get("sky-atmosphere-halo-color"),D=n.paint.get("sky-atmosphere-sun-intensity"),z=((O,V,U,H,q)=>({u_matrix_3f:O,u_sun_direction:V,u_sun_intensity:U,u_color_tint_r:[H.r,H.g,H.b,H.a],u_color_tint_m:[q.r,q.g,q.b,q.a],u_luminance:5e-5}))(r.ct.fromMat4(r.ct.create(),f),_,D,S,C);w.framebufferTexture2D(w.FRAMEBUFFER,w.COLOR_ATTACHMENT0,w.TEXTURE_CUBE_MAP_POSITIVE_X+x,n.skyboxTexture,0),a.draw(d,w.TRIANGLES,jt.disabled,ei.disabled,pi.unblended,Yt.frontCW,z,"skyboxCapture",n.skyboxGeometry.vertexBuffer,n.skyboxGeometry.indexBuffer,n.skyboxGeometry.segment)}const nd=r.aB([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class _u{constructor(n){const a=new r.cW;a.emplaceBack(-1,1,1,0,0),a.emplaceBack(1,1,1,1,0),a.emplaceBack(1,-1,1,1,1),a.emplaceBack(-1,-1,1,0,1);const f=new r.az;f.emplaceBack(0,1,2),f.emplaceBack(2,3,0),this.vertexBuffer=n.createVertexBuffer(a,nd.members),this.indexBuffer=n.createIndexBuffer(f),this.segments=r.aE.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const rd=r.aB([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class qo{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class sd{constructor(n){this.colorModeAlphaBlendedWriteRGB=new pi([1,Lc,1,Lc],r.aA.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new pi([1,0,1,0],r.aA.transparent,[!1,!1,!1,!0]),this.params=new qo,this.updateNeeded=!0,n.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),n.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),n.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),n.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(n){const a=n.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new _u(a);const f=this.params.sizeRange,_=this.params.intensityRange,x=function(z){const O=r.aC(30),V=[];for(let U=0;U<z;++U){const H=2*Math.PI*O(),q=Math.acos(1-2*O())-.5*Math.PI;V.push(r.Q.fromValues(Math.cos(q)*Math.cos(H),Math.cos(q)*Math.sin(H),Math.sin(q)))}return V}(this.params.starsCount),w=r.aC(300),S=new r.cX,C=new r.az;let D=0;for(let z=0;z<x.length;++z){const O=r.Q.scale([],x[z],200),V=Math.max(0,1+.01*f*(1*w()-.5)),U=Math.max(0,1+.01*_*(1*w()-.5));S.emplaceBack(O[0],O[1],O[2],-1,-1,V,U),S.emplaceBack(O[0],O[1],O[2],1,-1,V,U),S.emplaceBack(O[0],O[1],O[2],1,1,V,U),S.emplaceBack(O[0],O[1],O[2],-1,1,V,U),C.emplaceBack(D+0,D+1,D+2),C.emplaceBack(D+0,D+2,D+3),D+=4}this.starsVx=a.createVertexBuffer(S,rd.members),this.starsIdx=a.createIndexBuffer(C),this.starsSegments=r.aE.simpleSegment(0,0,S.length,C.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(n,a){const f=n.context,_=f.gl,x=n.transform,w=new jt(_.LEQUAL,jt.ReadOnly,[0,1]),S=r.W(x.zoom),C=a.properties.get("color").toArray01(),D=a.properties.get("high-color").toArray01(),z=a.properties.get("space-color").toArray01PremultipliedAlpha(),O=5e-4,V=r.cY(a.properties.get("horizon-blend"),0,1,O,.25),U=r.ci(n,f,x)&&V===O?x.worldSize/(2*Math.PI*1.025)-1:x.globeRadius,H=n.frameCounter/1e3%1,q=r.Q.length(x.globeCenterInViewSpace),Z=Math.sqrt(Math.pow(q,2)-Math.pow(U,2)),$=Math.acos(Z/q),K=oe=>{const se=x.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];oe&&se.push("ALPHA_PASS");const le=n.getOrCreateProgram("globeAtmosphere",{defines:se}),Y=((me,fe,xe,ke,ye,Pe,ze,ge,Ae,Ye,we,De)=>({u_frustum_tl:me,u_frustum_tr:fe,u_frustum_br:xe,u_frustum_bl:ke,u_horizon:ye,u_transition:Pe,u_fadeout_range:ze,u_color:ge,u_high_color:Ae,u_space_color:Ye,u_temporal_offset:we,u_horizon_angle:De}))(x.frustumCorners.TL,x.frustumCorners.TR,x.frustumCorners.BR,x.frustumCorners.BL,x.frustumCorners.horizon,S,V,C,D,z,H,$);n.uploadCommonUniforms(f,le);const ee=this.atmosphereBuffer;ee&&le.draw(n,_.TRIANGLES,w,ei.disabled,oe?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Yt.backCW,Y,oe?"atmosphere_glow_alpha":"atmosphere_glow",ee.vertexBuffer,ee.indexBuffer,ee.segments)};K(!1),K(!0)}drawStars(n,a){const f=r.ad(a.properties.get("star-intensity"),0,1);if(f===0)return;const _=n.context,x=_.gl,w=n.transform,S=n.getOrCreateProgram("stars"),C=r.bl.identity([]);r.bl.rotateX(C,C,-w._pitch),r.bl.rotateZ(C,C,-w.angle),r.bl.rotateX(C,C,r.bm(w._center.lat)),r.bl.rotateY(C,C,-r.bm(w._center.lng));const D=r.a9.fromQuat(new Float32Array(16),C),z=r.a9.multiply([],w.starsProjMatrix,D),O=r.ct.fromMat4([],D),V=r.ct.invert([],O),U=[0,1,0];r.Q.transformMat3(U,U,V),r.Q.scale(U,U,this.params.sizeMultiplier);const H=[1,0,0];r.Q.transformMat3(H,H,V),r.Q.scale(H,H,this.params.sizeMultiplier);const q=(Z=U,$=H,K=f,{u_matrix:Float32Array.from(z),u_up:Z,u_right:$,u_intensity_multiplier:K});var Z,$,K;n.uploadCommonUniforms(_,S),this.starsVx&&this.starsIdx&&S.draw(n,x.TRIANGLES,jt.disabled,ei.disabled,this.colorModeAlphaBlendedWriteRGB,Yt.disabled,q,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function od(d,n){const a=[...d],f=n.cameraWorldSizeForFog/n.worldSize,_=r.a9.identity([]);return r.a9.scale(_,_,[f,f,1]),r.a9.multiply(a,_,a),r.a9.multiply(a,n.worldToFogMatrix,a),a}function xo(d,n,a,f){const _=a.material,x=f.context,{baseColorTexture:w,metallicRoughnessTexture:S}=_.pbrMetallicRoughness,{normalTexture:C,occlusionTexture:D,emissionTexture:z}=_;function O(V,U,H){if(V&&(d.push(U),x.activeTexture.set(x.gl.TEXTURE0+H),V.gfxTexture)){const{minFilter:q,magFilter:Z,wrapS:$,wrapT:K}=V.sampler;V.gfxTexture.bindExtraParam(q,Z,$,K)}}O(w,"HAS_TEXTURE_u_baseColorTexture",Or.BaseColor),O(S,"HAS_TEXTURE_u_metallicRoughnessTexture",Or.MetallicRoughness),O(C,"HAS_TEXTURE_u_normalTexture",Or.Normal),O(D,"HAS_TEXTURE_u_occlusionTexture",Or.Occlusion),O(z,"HAS_TEXTURE_u_emissionTexture",Or.Emission),a.texcoordBuffer&&(d.push("HAS_ATTRIBUTE_a_uv_2f"),n.push(a.texcoordBuffer)),a.colorBuffer&&(d.push(a.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),n.push(a.colorBuffer)),a.normalBuffer&&(d.push("HAS_ATTRIBUTE_a_normal_3f"),n.push(a.normalBuffer)),a.pbrBuffer&&(d.push("HAS_ATTRIBUTE_a_pbr"),d.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),n.push(a.pbrBuffer)),_.alphaMode!=="OPAQUE"&&_.alphaMode!=="MASK"||d.push("UNPREMULT_TEXTURE_IN_SHADER"),_.defined||d.push("DIFFUSE_SHADED"),d.push("USE_STANDARD_DERIVATIVES")}function vo(d,n,a,f,_,x){const w=a.paint.get("model-opacity"),S=n.context,C=new jt(n.context.gl.LEQUAL,jt.ReadWrite,n.depthRangeFor3D),D=n.transform,z=d.mesh,O=z.material,V=O.pbrMetallicRoughness,U=n.style.fog;let H;H=n.transform.projection.zAxisUnit==="pixels"?[...d.nodeModelMatrix]:r.a9.multiply([],f.zScaleMatrix,d.nodeModelMatrix),r.a9.multiply(H,f.negCameraPosMatrix,H);const q=r.a9.invert([],H);r.a9.transpose(q,q);const Z=a.paint.get("model-emissive-strength").constantOr(0),$=cu(new Float32Array(d.worldViewProjection),new Float32Array(H),new Float32Array(q),null,n,w,V.baseColorFactor,O.emissiveFactor,V.metallicFactor,V.roughnessFactor,O,Z,a),K={defines:[]},oe=[];xo(K.defines,oe,z,n);const se=n.shadowRenderer;se&&(se.useNormalOffset=!1);let le=null;if(U){const me=od(d.nodeModelMatrix,n.transform);if(le=new Float32Array(me),D.projection.name!=="globe"){const fe=z.aabb.min,xe=z.aabb.max,[ke,ye]=U.getOpacityForBounds(me,fe[0],fe[1],xe[0],xe[1]);K.overrideFog=ke>=Li||ye>=Li}}const Y=po(n,a.paint.get("model-cutoff-fade-range"));Y.shouldRenderCutoff&&K.defines.push("RENDER_CUTOFF");const ee=n.getOrCreateProgram("model",K);n.uploadCommonUniforms(S,ee,null,le,Y),n.renderPass!=="shadow"&&se&&se.setupShadowsFromMatrix(d.nodeModelMatrix,ee),ee.draw(n,S.gl.TRIANGLES,C,_,x,z.material.doubleSided?Yt.disabled:Yt.backCCW,$,a.id,z.vertexBuffer,z.indexBuffer,z.segments,a.paint,n.transform.zoom,void 0,oe)}function Vl(d,n,a,f,_,x,w){let S;S=d.projection.name==="globe"?r.c_(a,d):[...a],r.a9.multiply(S,S,n.matrix);const C=r.a9.multiply([],f,S);if(n.meshes)for(const D of n.meshes){if(D.material.alphaMode!=="BLEND"){w.push({mesh:D,depth:0,modelIndex:_,worldViewProjection:C,nodeModelMatrix:S});continue}const z=r.Q.transformMat4([],D.centroid,C);z[2]>0&&x.push({mesh:D,depth:z[2],modelIndex:_,worldViewProjection:C,nodeModelMatrix:S})}if(n.children)for(const D of n.children)Vl(d,D,a,f,_,x,w)}function Ul(d,n,a,f){const _=a.shadowRenderer;if(!_)return;const x=_.getShadowPassDepthMode(),w=_.getShadowPassColorMode(),S=_.calculateShadowPassMatrixFromMatrix(n),C=wp(S);a.getOrCreateProgram("modelDepth",{defines:a._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(a,a.context.gl.TRIANGLES,x,ei.disabled,w,Yt.backCCW,C,f.id,d.vertexBuffer,d.indexBuffer,d.segments,f.paint,a.transform.zoom,void 0,void 0)}function jl(d,n,a){const f=n.updateZoomBasedPaintProperties(),_=function(x,w,S){let C,D,z,O=x.terrain?x.terrain.exaggeration():0;if(x.terrain&&O>0){const V=x.terrain,U=V.findDEMTileFor(S);U&&U.dem?C=r.d0.create(V,S,U):O=0}if(O===0&&(w.terrainElevationMin=0,w.terrainElevationMax=0),O===w.validForExaggeration&&(O===0||C&&C._demTile&&C._demTile.tileID===w.validForDEMTile.id&&C._dem._timestamp===w.validForDEMTile.timestamp))return!1;for(const V in w.instancesPerModel){const U=w.instancesPerModel[V];for(let H=0;H<U.instancedDataArray.length;++H){const q=(C?O*C.getElevationAt(0|U.instancedDataArray.float32[16*H],0|U.instancedDataArray.float32[16*H+1],!0,!0):0)+U.instancesEvaluatedElevation[H];U.instancedDataArray.float32[16*H+6]=q,D=D?Math.min(w.terrainElevationMin,q):q,z=z?Math.max(w.terrainElevationMax,q):q}}return w.terrainElevationMin=D||0,w.terrainElevationMax=z||0,w.validForExaggeration=O,w.validForDEMTile=C&&C._demTile?{id:C._demTile.tileID,timestamp:C._dem._timestamp}:{id:void 0,timestamp:0},!0}(d,n,a);(f||_)&&(n.uploaded=!1,n.upload(d.context))}const Qr={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new r.bV([0,0,0],[r.Y,r.Y,0])};function gu(d,n){const a=1<<d.canonical.z,f=n.getFreeCameraOptions().position,_=n.elevation,x=d.canonical.x/a,w=(d.canonical.x+1)/a,S=d.canonical.y/a,C=(d.canonical.y+1)/a;let D=n._centerAltitude;if(_){const U=_.getMinMaxForTile(d);U&&U.max>D&&(D=U.max)}const z=r.ad(f.x,x,w)-f.x,O=r.ad(f.y,S,C)-f.y,V=r.bo(D,n.center.lat)-f.z;return n._zoomFromMercatorZ(Math.sqrt(z*z+O*O+V*V))}function yu(d,n,a,f,_,x,w){const S=d.context,C=d.renderPass==="shadow",D=d.shadowRenderer,z=C&&D?D.getShadowPassDepthMode():new jt(S.gl.LEQUAL,jt.ReadWrite,d.depthRangeFor3D),O=d.isTileAffectedByFog(x);if(a.meshes)for(const V of a.meshes){const U=["MODEL_POSITION_ON_GPU"],H=[];let q,Z,$;f.instancedDataArray.length>20&&U.push("INSTANCED_ARRAYS");const K=po(d,n.paint.get("model-cutoff-fade-range"));if(K.shouldRenderCutoff&&U.push("RENDER_CUTOFF"),C&&D)q=d.getOrCreateProgram("modelDepth",{defines:U}),Z=wp(w.shadowTileMatrix,w.shadowTileMatrix,Float32Array.from(a.matrix)),$=D.getShadowPassColorMode();else{xo(U,H,V,d),q=d.getOrCreateProgram("model",{defines:U,overrideFog:O});const se=V.material,le=se.pbrMetallicRoughness,Y=n.paint.get("model-opacity"),ee=n.paint.get("model-emissive-strength").constantOr(0);Z=cu(x.expandedProjMatrix,Float32Array.from(a.matrix),new Float32Array(16),null,d,Y,le.baseColorFactor,se.emissiveFactor,le.metallicFactor,le.roughnessFactor,se,ee,n,_),D&&(w.shadowUniformsInitialized?q.setShadowUniformValues(S,D.getShadowUniformValues()):(D.setupShadows(x.toUnwrapped(),q,"model-tile",x.overscaledZ),w.shadowUniformsInitialized=!0)),$=K.shouldRenderCutoff||Y<1||se.alphaMode!=="OPAQUE"?pi.alphaBlended:pi.unblended}d.uploadCommonUniforms(S,q,x.toUnwrapped(),null,K);const oe=V.material.doubleSided?Yt.disabled:Yt.backCCW;if(f.instancedDataArray.length>20)H.push(f.instancedDataBuffer),q.draw(d,S.gl.TRIANGLES,z,ei.disabled,$,oe,Z,n.id,V.vertexBuffer,V.indexBuffer,V.segments,n.paint,d.transform.zoom,void 0,H,f.instancedDataArray.length);else{const se=C?"u_instance":"u_normal_matrix";for(let le=0;le<f.instancedDataArray.length;++le)Z[se]=new Float32Array(f.instancedDataArray.arrayBuffer,64*le,16),q.draw(d,S.gl.TRIANGLES,z,ei.disabled,$,oe,Z,n.id,V.vertexBuffer,V.indexBuffer,V.segments,n.paint,d.transform.zoom,void 0,H)}}if(a.children)for(const V of a.children)yu(d,n,V,f,_,x,w)}const xu=[1,-1,1];function Gl(d,n,a,f){if(!a.modelManager)return!0;const _=a.modelManager;if(!a.shadowRenderer)return!0;const x=a.shadowRenderer,w=n.aabb;let S=!0,C=d.maxHeight;if(C===0){let z=0;for(const O in d.instancesPerModel){const V=_.getModel(O,f);V?z=Math.max(z,Math.max(Math.max(V.aabb.max[0],V.aabb.max[1]),V.aabb.max[2])):S=!1}C=d.maxScale*z*1.41+d.maxVerticalOffset,S&&(d.maxHeight=C)}w.max[2]=C,w.min[2]+=d.terrainElevationMin,w.max[2]+=d.terrainElevationMax,r.Q.transformMat4(w.min,w.min,n.tileMatrix),r.Q.transformMat4(w.max,w.max,n.tileMatrix);const D=w.intersects(x.getCurrentCascadeFrustum());return a.currentShadowCascade===0&&(d.isInsideFirstShadowMapFrustum=D===2),D===0}class Dp{}class kp{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(n,a,f){{const O=this._storage.get(a.id);if(O)return O.lastUsedFrameIdx=n,O.buf}const _=f.gl,x=_.getBufferParameter(_.ELEMENT_ARRAY_BUFFER,_.BUFFER_SIZE),w=new ArrayBuffer(x),S=new Int16Array(w);_.getBufferSubData(_.ELEMENT_ARRAY_BUFFER,0,new Int16Array(w));const C=new r.d2;for(let O=0;O<x/2;O+=3){const V=S[O],U=S[O+1],H=S[O+2];C.emplaceBack(V,U),C.emplaceBack(U,H),C.emplaceBack(H,V)}const D=f.bindVertexArrayOES.current,z=new Dp;return z.buf=new tn(f,C),z.lastUsedFrameIdx=n,this._storage.set(a.id,z),f.bindVertexArrayOES.set(D),z.buf}update(n){for(const[a,f]of this._storage)n-f.lastUsedFrameIdx>30&&(f.buf.destroy(),this._storage.delete(a))}destroy(){for(const[n,a]of this._storage)a.buf.destroy(),this._storage.delete(n)}}const vu={symbol:function(d,n,a,f,_){if(d.renderPass!=="translucent")return;const x=ei.disabled,w=d.colorModeForRenderPass();a.layout.get("text-variable-anchor")&&function(D,z,O,V,U,H,q){const Z=z.transform,$=U==="map",K=H==="map";for(const oe of D){const se=V.getTile(oe),le=se.getBucket(O);if(!le||!le.text||!le.text.segments.get().length)continue;const Y=r.b8(le.textSizeData,Z.zoom),ee=Wc(oe,le.getProjection(),Z),me=Z.calculatePixelsToTileUnitsMatrix(se),fe=_l(ee,se.tileID.canonical,K,$,Z,le.getProjection(),me),xe=le.hasIconTextFit()&&le.hasIconData();if(Y){const ke=Math.pow(2,Z.zoom-se.tileID.overscaledZ);Tp(le,$,K,q,r.cE,Z,fe,oe,ke,Y,xe)}}}(f,d,a,n,a.layout.get("text-rotation-alignment"),a.layout.get("text-pitch-alignment"),_);const S=a.paint.get("icon-opacity").constantOr(1)!==0,C=a.paint.get("text-opacity").constantOr(1)!==0;a.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(S||C)?Nl(d,n,a,f,x,w):(S&&Nl(d,n,a,f,x,w,{onlyIcons:!0}),C&&Nl(d,n,a,f,x,w,{onlyText:!0})),n.map.showCollisionBoxes&&(Xh(d,n,a,f,a.paint.get("text-translate"),a.paint.get("text-translate-anchor"),!0),Xh(d,n,a,f,a.paint.get("icon-translate"),a.paint.get("icon-translate-anchor"),!1))},circle:function(d,n,a,f){if(d.renderPass!=="translucent")return;const _=a.paint.get("circle-opacity"),x=a.paint.get("circle-stroke-width"),w=a.paint.get("circle-stroke-opacity"),S=a.layout.get("circle-sort-key").constantOr(1)!==void 0,C=a.paint.get("circle-emissive-strength");if(_.constantOr(1)===0&&(x.constantOr(1)===0||w.constantOr(1)===0))return;const D=d.context,z=D.gl,O=d.transform,V=d.depthModeForSublayer(0,jt.ReadOnly),U=ei.disabled,H=d.colorModeForDrapableLayerRenderPass(C),q=O.projection.name==="globe",Z=[r.a8(O.center.lng),r.ah(O.center.lat)],$=[];for(let oe=0;oe<f.length;oe++){const se=f[oe],le=n.getTile(se),Y=le.getBucket(a);if(!Y||Y.projection.name!==O.projection.name)continue;const ee=Y.programConfigurations.get(a.id),me=r.cF(a),fe=d.isTileAffectedByFog(se);q&&me.push("PROJECTION_GLOBE_VIEW");const xe=d.getOrCreateProgram("circle",{config:ee,defines:me,overrideFog:fe}),ke=Y.layoutVertexBuffer,ye=Y.globeExtVertexBuffer,Pe=Y.indexBuffer,ze=O.projection.createInversionMatrix(O,se.canonical),ge={programConfiguration:ee,program:xe,layoutVertexBuffer:ke,globeExtVertexBuffer:ye,indexBuffer:Pe,uniformValues:r.cG(d,se,le,ze,Z,a),tile:le};if(S){const Ae=Y.segments.get();for(const Ye of Ae)$.push({segments:new r.aE([Ye]),sortKey:Ye.sortKey,state:ge})}else $.push({segments:Y.segments,sortKey:0,state:ge})}S&&$.sort((oe,se)=>oe.sortKey-se.sortKey);const K={useDepthForOcclusion:O.depthOcclusionForSymbolsAndCircles};for(const oe of $){const{programConfiguration:se,program:le,layoutVertexBuffer:Y,globeExtVertexBuffer:ee,indexBuffer:me,uniformValues:fe,tile:xe}=oe.state,ke=oe.segments;d.terrain&&d.terrain.setupElevationDraw(xe,le,K),d.uploadCommonUniforms(D,le,xe.tileID.toUnwrapped()),le.draw(d,z.TRIANGLES,V,U,H,Yt.disabled,fe,a.id,Y,me,ke,a.paint,O.zoom,se,[ee])}},heatmap:function(d,n,a,f){if(a.paint.get("heatmap-opacity")!==0)if(d.renderPass==="offscreen"){const _=d.context,x=_.gl,w=ei.disabled,S=new pi([x.ONE,x.ONE,x.ONE,x.ONE],r.aA.transparent,[!0,!0,!0,!0]);(function(U,H,q,Z){const $=U.gl,K=H.width*Z,oe=H.height*Z;U.activeTexture.set($.TEXTURE1),U.viewport.set([0,0,K,oe]);let se=q.heatmapFbo;if(!se||se&&(se.width!==K||se.height!==oe)){se&&se.destroy();const le=$.createTexture();$.bindTexture($.TEXTURE_2D,le),$.texParameteri($.TEXTURE_2D,$.TEXTURE_WRAP_S,$.CLAMP_TO_EDGE),$.texParameteri($.TEXTURE_2D,$.TEXTURE_WRAP_T,$.CLAMP_TO_EDGE),$.texParameteri($.TEXTURE_2D,$.TEXTURE_MIN_FILTER,$.LINEAR),$.texParameteri($.TEXTURE_2D,$.TEXTURE_MAG_FILTER,$.LINEAR),se=q.heatmapFbo=U.createFramebuffer(K,oe,!0,null),function(Y,ee,me,fe,xe,ke){const ye=Y.gl;ye.texImage2D(ye.TEXTURE_2D,0,Y.extRenderToTextureHalfFloat?ye.RGBA16F:ye.RGBA,xe,ke,0,ye.RGBA,Y.extRenderToTextureHalfFloat?ye.HALF_FLOAT:ye.UNSIGNED_BYTE,null),fe.colorAttachment.set(me)}(U,0,le,se,K,oe)}else $.bindTexture($.TEXTURE_2D,se.colorAttachment.get()),U.bindFramebuffer.set(se.framebuffer)})(_,d,a,d.transform.projection.name==="globe"?.5:.25),_.clear({color:r.aA.transparent});const C=d.transform,D=C.projection.name==="globe",z=D?["PROJECTION_GLOBE_VIEW"]:[],O=D?Yt.frontCCW:Yt.disabled,V=[r.a8(C.center.lng),r.ah(C.center.lat)];for(let U=0;U<f.length;U++){const H=f[U];if(n.hasRenderableParent(H))continue;const q=n.getTile(H),Z=q.getBucket(a);if(!Z||Z.projection.name!==C.projection.name)continue;const $=d.isTileAffectedByFog(H),K=Z.programConfigurations.get(a.id),oe=d.getOrCreateProgram("heatmap",{config:K,defines:z,overrideFog:$}),{zoom:se}=d.transform;d.terrain&&d.terrain.setupElevationDraw(q,oe),d.uploadCommonUniforms(_,oe,H.toUnwrapped());const le=C.projection.createInversionMatrix(C,H.canonical);oe.draw(d,x.TRIANGLES,jt.disabled,w,S,O,pg(d,H,q,le,V,se,a.paint.get("heatmap-intensity")),a.id,Z.layoutVertexBuffer,Z.indexBuffer,Z.segments,a.paint,d.transform.zoom,K,D?[Z.globeExtVertexBuffer]:null)}_.viewport.set([0,0,d.width,d.height])}else d.renderPass==="translucent"&&(d.context.setColorMode(d.colorModeForRenderPass()),function(_,x){const w=_.context,S=w.gl,C=x.heatmapFbo;if(!C)return;w.activeTexture.set(S.TEXTURE0),S.bindTexture(S.TEXTURE_2D,C.colorAttachment.get()),w.activeTexture.set(S.TEXTURE1);let D=x.colorRampTexture;D||(D=x.colorRampTexture=new r.T(w,x.colorRamp,S.RGBA)),D.bind(S.LINEAR,S.CLAMP_TO_EDGE),_.getOrCreateProgram("heatmapTexture").draw(_,S.TRIANGLES,jt.disabled,ei.disabled,_.colorModeForRenderPass(),Yt.disabled,((z,O,V,U)=>({u_image:0,u_color_ramp:1,u_opacity:O.paint.get("heatmap-opacity")}))(0,x),x.id,_.viewportBuffer,_.quadTriangleIndexBuffer,_.viewportSegments,x.paint,_.transform.zoom)}(d,a))},line:function(d,n,a,f){if(d.renderPass!=="translucent")return;const _=a.paint.get("line-opacity"),x=a.paint.get("line-width");if(_.constantOr(1)===0||x.constantOr(1)===0)return;const w=a.paint.get("line-emissive-strength"),S=d.depthModeForSublayer(0,jt.ReadOnly),C=d.colorModeForDrapableLayerRenderPass(w),D=d.terrain&&d.terrain.renderingToTexture?1:r.f.devicePixelRatio,z=a.paint.get("line-dasharray"),O=z.constantOr(1),V=a.layout.get("line-cap"),U=a.paint.get("line-pattern"),H=U.constantOr(1),q=a.paint.get("line-opacity").constantOr(1)!==1;let Z=!H&&q;const $=a.paint.get("line-gradient"),K=H?"linePattern":"line",oe=d.context,se=oe.gl,le=r.cH(a);d.terrain&&d.terrain.clipOrMaskOverlapStencilType()&&(Z=!1);for(const Y of f){const ee=n.getTile(Y);if(H&&!ee.patternsLoaded())continue;const me=ee.getBucket(a);if(!me)continue;d.prepareDrawTile();const fe=me.programConfigurations.get(a.id),xe=d.isTileAffectedByFog(Y),ke=d.getOrCreateProgram(K,{config:fe,defines:le,overrideFog:xe}),ye=U.constantOr(null);if(ye&&ee.imageAtlas){const Re=ee.imageAtlas.patternPositions[ye.toString()];Re&&fe.setConstantPatternPositions(Re)}const Pe=z.constantOr(null),ze=V.constantOr(null);if(!H&&Pe&&ze&&ee.lineAtlas){const Re=ee.lineAtlas.getDash(Pe,ze);Re&&fe.setConstantPatternPositions(Re)}let[ge,Ae]=a.paint.get("line-trim-offset");(ze==="round"||ze==="square")&&ge!==Ae&&(ge===0&&(ge-=1),Ae===1&&(Ae+=1));const Ye=d.terrain?Y.projMatrix:null,we=H?r.cI(d,ee,a,Ye,D,[ge,Ae]):r.cJ(d,ee,a,Ye,me.lineClipsArray.length,D,[ge,Ae]);if($){const Re=me.gradients[a.id];let ae=Re.texture;if(a.gradientVersion!==Re.version){let Ue=256;if(a.stepInterpolant){const gt=n.getSource().maxzoom,Et=Y.canonical.z===gt?Math.ceil(1<<d.transform.maxZoom-Y.canonical.z):1;Ue=r.ad(r.cK(me.maxLineLength/r.Y*1024*Et),256,oe.maxTextureSize)}Re.gradient=r.cL({expression:a.gradientExpression(),evaluationKey:"lineProgress",resolution:Ue,image:Re.gradient||void 0,clips:me.lineClipsArray}),Re.texture?Re.texture.update(Re.gradient):Re.texture=new r.T(oe,Re.gradient,se.RGBA),Re.version=a.gradientVersion,ae=Re.texture}oe.activeTexture.set(se.TEXTURE1),ae.bind(a.stepInterpolant?se.NEAREST:se.LINEAR,se.CLAMP_TO_EDGE)}O&&(oe.activeTexture.set(se.TEXTURE0),ee.lineAtlasTexture&&ee.lineAtlasTexture.bind(se.LINEAR,se.REPEAT),fe.updatePaintBuffers()),H&&(oe.activeTexture.set(se.TEXTURE0),ee.imageAtlasTexture&&ee.imageAtlasTexture.bind(se.LINEAR,se.CLAMP_TO_EDGE),fe.updatePaintBuffers()),d.uploadCommonUniforms(oe,ke,Y.toUnwrapped());const De=Re=>{ke.draw(d,se.TRIANGLES,S,Re,C,Yt.disabled,we,a.id,me.layoutVertexBuffer,me.indexBuffer,me.segments,a.paint,d.transform.zoom,fe,[me.layoutVertexBuffer2,me.patternVertexBuffer])};if(Z){const Re=d.stencilModeForClipping(Y).ref;Re===0&&d.terrain&&oe.clear({stencil:0});const ae={func:se.EQUAL,mask:255};we.u_alpha_discard_threshold=.8,De(new ei(ae,Re,255,se.KEEP,se.KEEP,se.INVERT)),we.u_alpha_discard_threshold=0,De(new ei(ae,Re,255,se.KEEP,se.KEEP,se.KEEP))}else De(d.stencilModeForClipping(Y))}Z&&(d.resetStencilClippingMasks(),d.terrain&&oe.clear({stencil:0}))},fill:function(d,n,a,f){const _=a.paint.get("fill-color"),x=a.paint.get("fill-opacity");if(x.constantOr(1)===0)return;const w=a.paint.get("fill-emissive-strength"),S=d.colorModeForDrapableLayerRenderPass(w),C=a.paint.get("fill-pattern"),D=d.opaquePassEnabledForLayer()&&!C.constantOr(1)&&_.constantOr(r.aA.transparent).a===1&&x.constantOr(0)===1?"opaque":"translucent";if(d.renderPass===D){const z=d.depthModeForSublayer(1,d.renderPass==="opaque"?jt.ReadWrite:jt.ReadOnly);hu(d,n,a,f,z,S,!1)}if(d.renderPass==="translucent"&&a.paint.get("fill-antialias")){const z=d.depthModeForSublayer(a.getPaintProperty("fill-outline-color")?2:0,jt.ReadOnly);hu(d,n,a,f,z,S,!0)}},"fill-extrusion":function(d,n,a,f){const _=a.paint.get("fill-extrusion-opacity"),x=d.context,w=x.gl,S=d.terrain,C=S&&S.renderingToTexture;if(_===0)return;const D=d.conflationActive&&d.layerUsedInConflation(a,n.getSource());if(D&&function(z,O,V,U){for(const H of U){const q=O.getTile(H).getBucket(V);q&&(q.updateReplacement(H,z.replacementSource),q.uploadCentroid(z.context))}}(d,n,a,f),S||D)for(const z of f){const O=n.getTile(z).getBucket(a);O&&Jh(d.context,n,z,O,a,S,D)}if(d.renderPass==="shadow"&&d.shadowRenderer){const z=d.shadowRenderer;if(S&&_<.65&&a._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof r.Z)return;const O=z.getShadowPassDepthMode(),V=z.getShadowPassColorMode();pt(d,n,a,f,O,ei.disabled,V,D)}else if(d.renderPass==="translucent"){const z=!a.paint.get("fill-extrusion-pattern").constantOr(1),O=a.paint.get("fill-extrusion-color").constantOr(r.aA.white);if(!C&&O.a!==0){const V=new jt(d.context.gl.LEQUAL,jt.ReadWrite,d.depthRangeFor3D);_===1&&z?pt(d,n,a,f,V,ei.disabled,pi.unblended,D):(pt(d,n,a,f,V,ei.disabled,pi.disabled,D),pt(d,n,a,f,V,d.stencilModeFor3D(),d.colorModeForRenderPass(),D),d.resetStencilClippingMasks())}if(d.style.enable3dLights()&&z&&(!S&&d.transform.projection.name!=="globe"||C)){const V=a.paint.get("fill-extrusion-opacity"),U=a.paint.get("fill-extrusion-ambient-occlusion-intensity"),H=a.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),q=a.paint.get("fill-extrusion-flood-light-intensity"),Z=a.paint.get("fill-extrusion-flood-light-color").toArray01().slice(0,3),$=U>0&&H>0,K=q>0,oe=(le,Y,ee)=>(1-ee)*le+ee*Y,se=le=>{const Y=d.depthModeForSublayer(1,jt.ReadOnly,w.LEQUAL,!0),ee=a.paint.get(le?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),me=oe(.1,3,ee),fe=d._showOverdrawInspector;if(!fe){const xe=new ei({func:w.ALWAYS,mask:255},255,255,w.KEEP,w.KEEP,w.REPLACE),ke=new pi([w.ONE,w.ONE,w.ONE,w.ONE],r.aA.transparent,[!1,!1,!1,!0],w.MIN);Go(d,n,a,f,Y,xe,ke,Yt.disabled,le,"sdf",V,U,H,q,Z,me,D,!1)}{const xe=fe?ei.disabled:new ei({func:w.EQUAL,mask:255},255,255,w.KEEP,w.DECR,w.DECR),ke=fe?d.colorModeForRenderPass():new pi([w.ONE_MINUS_DST_ALPHA,w.DST_ALPHA,w.ONE,w.ONE],r.aA.transparent,[!0,!0,!0,!0]);Go(d,n,a,f,Y,xe,ke,Yt.disabled,le,"color",V,U,H,q,Z,me,D,!1)}};if(C){const le=(Y,ee,me)=>{const fe=d.depthModeForSublayer(1,jt.ReadOnly,w.LEQUAL,!1),xe=a.paint.get(Y?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),ke=oe(.1,3,xe);{const ye=new pi([w.ONE,w.ONE,w.ONE,w.ONE],r.aA.transparent,[!1,!1,!1,!0]);Go(d,n,a,f,fe,ei.disabled,ye,Yt.disabled,Y,"clear",V,U,H,q,Z,ke,D,ee)}{const ye=new ei({func:w.ALWAYS,mask:255},255,255,w.KEEP,w.KEEP,w.REPLACE),Pe=new pi([w.ONE,w.ONE,w.ONE,w.ONE],r.aA.transparent,[!1,!1,!1,!0],w.MIN);Go(d,n,a,f,fe,ye,Pe,Yt.disabled,Y,"sdf",V,U,H,q,Z,ke,D,ee)}{const ye=Y?w.ZERO:w.ONE_MINUS_DST_ALPHA,Pe=new ei({func:w.EQUAL,mask:255},255,255,w.KEEP,w.DECR,w.DECR),ze=new pi([ye,w.DST_ALPHA,w.ONE_MINUS_DST_ALPHA,w.ZERO],r.aA.transparent,[!0,!0,!0,!0]);Go(d,n,a,f,fe,Pe,ze,Yt.disabled,Y,"color",V,U,H,q,Z,ke,D,ee)}{const ye=new pi([w.ONE,w.ONE,w.ONE,Y?w.ZERO:w.ONE],r.aA.transparent,[!1,!1,!1,!0],Y?w.FUNC_ADD:w.MAX);Go(d,n,a,f,fe,ei.disabled,ye,Yt.disabled,Y,"clear",V,U,H,q,Z,ke,D,ee,me)}};if($||K){let Y;if(d.prepareDrawTile(),S){const ee=S.drapeBufferSize[0],me=S.drapeBufferSize[1];Y=S.framebufferCopyTexture,Y&&(!Y||Y.size[0]===ee&&Y.size[1]===me)||(Y&&Y.destroy(),Y=S.framebufferCopyTexture=new r.T(x,new r.h({width:ee,height:me}),w.RGBA)),Y.bind(w.LINEAR,w.CLAMP_TO_EDGE),w.copyTexImage2D(w.TEXTURE_2D,0,w.RGBA,0,0,ee,me,0)}$&&le(!0,!1,Y),K&&le(!1,!0,Y)}}else $&&se(!0),K&&se(!1)}}},hillshade:function(d,n,a,f){if(d.renderPass!=="offscreen"&&d.renderPass!=="translucent"||d.style.disableElevatedTerrain)return;const _=d.context,x=d.terrain&&d.terrain.renderingToTexture,[w,S]=d.renderPass!=="translucent"||x?[{},f]:d.stencilConfigForOverlap(f);for(const C of S){const D=n.getTile(C);if(D.needsHillshadePrepare&&d.renderPass==="offscreen")wa(d,D,a);else if(d.renderPass==="translucent"){const z=d.depthModeForSublayer(0,jt.ReadOnly),O=a.paint.get("hillshade-emissive-strength"),V=d.colorModeForDrapableLayerRenderPass(O),U=x&&d.terrain?d.terrain.stencilModeForRTTOverlap(C):w[C.overscaledZ];Ri(d,C,D,a,z,U,V)}}_.viewport.set([0,0,d.width,d.height]),d.resetStencilClippingMasks()},raster:function(d,n,a,f,_,x){if(d.renderPass!=="translucent"||a.paint.get("raster-opacity")===0)return;const w=d.transform.projection.name==="globe",S=a.paint.get("raster-elevation")!==0,C=S&&w;if(d.renderElevatedRasterBackface&&!C)return;const D=d.context,z=D.gl,O=n.getSource(),V=function(Y,ee,me,fe){const xe=ee.paint.get("raster-color"),ke=Y.type==="raster-array",ye=[],Pe=ee.paint.get("raster-resampling"),ze=ee.paint.get("raster-color-mix");let ge=ee.paint.get("raster-color-range");const Ae=[ze[0],ze[1],ze[2],0],Ye=ze[3];let we=Pe==="nearest"?fe.NEAREST:fe.LINEAR;if(ke&&(ye.push("RASTER_ARRAY"),xe||ye.push("RASTER_COLOR"),Pe==="linear"&&ye.push("RASTER_ARRAY_LINEAR"),we=fe.NEAREST,!ge&&Y.rasterLayers)){const De=Y.rasterLayers.find(({id:Re})=>Re===ee.sourceLayer);De&&De.fields&&De.fields.range&&(ge=De.fields.range)}if(ge=ge||[0,1],xe){ye.push("RASTER_COLOR"),me.activeTexture.set(fe.TEXTURE2),ee.updateColorRamp(ge);let De=ee.colorRampTexture;De||(De=ee.colorRampTexture=new r.T(me,ee.colorRamp,fe.RGBA)),De.bind(fe.LINEAR,fe.CLAMP_TO_EDGE)}return{mix:Ae,range:ge,offset:Ye,defines:ye,resampling:we}}(O,a,D,z);if(O instanceof r.as&&!f.length&&!w)return;const U=a.paint.get("raster-emissive-strength"),H=d.colorModeForDrapableLayerRenderPass(U),q=d.terrain&&d.terrain.renderingToTexture,Z=!d.options.moving,$=a.paint.get("raster-resampling")==="nearest"?z.NEAREST:z.LINEAR;if(O instanceof r.as&&!f.length&&(O.onNorthPole||O.onSouthPole)){const Y=S?d.stencilModeFor3D():ei.disabled;return void Xs(!!O.onNorthPole,null,d,n,a,U,V,Yt.disabled,Y)}if(!f.length)return;const[K,oe]=O instanceof r.as||q?[{},f]:d.stencilConfigForOverlap(f),se=oe[oe.length-1].overscaledZ;C&&V.defines.push("PROJECTION_GLOBE_VIEW"),S&&V.defines.push("RENDER_CUTOFF");const le=(Y,ee,me)=>{for(const fe of Y){const xe=fe.toUnwrapped(),ke=n.getTile(fe);if(q&&(!ke||!ke.hasData()))continue;D.activeTexture.set(z.TEXTURE0);const ye=Ia(ke,O,a,V);if(!ye||!ye.texture)continue;const{texture:Pe,mix:ze,offset:ge,tileSize:Ae,buffer:Ye}=ye;let we,De;q?(we=jt.disabled,De=fe.projMatrix):S?(we=new jt(z.LEQUAL,jt.ReadWrite,d.depthRangeFor3D),De=w?Float32Array.from(d.transform.expandedFarZProjMatrix):d.transform.calculateProjMatrix(xe,Z)):(we=d.depthModeForSublayer(fe.overscaledZ-se,a.paint.get("raster-opacity")===1?jt.ReadWrite:jt.ReadOnly,z.LESS),De=d.transform.calculateProjMatrix(xe,Z));const Re=d.terrain&&q?d.terrain.stencilModeForRTTOverlap(fe):K[fe.overscaledZ],ae=x?0:a.paint.get("raster-fade-duration");ke.registerFadeDuration(ae);const Ue=n.findLoadedParent(fe,0),gt=Vo(ke,Ue,n,d.transform,ae);let Et,zt;d.terrain&&d.terrain.prepareDrawTile(),D.activeTexture.set(z.TEXTURE0),Pe.bind($,z.CLAMP_TO_EDGE),D.activeTexture.set(z.TEXTURE1),Ue?(Ue.texture&&Ue.texture.bind($,z.CLAMP_TO_EDGE),Et=Math.pow(2,Ue.tileID.overscaledZ-ke.tileID.overscaledZ),zt=[ke.tileID.canonical.x*Et%1,ke.tileID.canonical.y*Et%1]):Pe.bind($,z.CLAMP_TO_EDGE),Pe.useMipmap&&D.extTextureFilterAnisotropic&&d.transform.pitch>20&&z.texParameterf(z.TEXTURE_2D,D.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,D.extTextureFilterAnisotropicMax);const Pt=d.transform;let Ut;const vi=S?pu(Pt):[0,0,0,0];let Jt,Ti,bi,hn,Ni,Gn=0;if(C&&O instanceof r.as&&O.coordinates.length>3)Jt=Float32Array.from(r.aW(r.cn(new r.bv(0,0,0)))),Ti=Float32Array.from(Pt.globeMatrix),bi=Float32Array.from(r.cj(Pt)),hn=[r.a8(Pt.center.lng),r.ah(Pt.center.lat)],Ut=O.elevatedGlobePerspectiveTransform,Ni=O.elevatedGlobeGridMatrix||new Float32Array(9);else if(C){const li=r.ck(fe.canonical);Gn=r.cl(li.getCenter().lat),Jt=Float32Array.from(r.aW(r.cn(fe.canonical))),Ti=Float32Array.from(Pt.globeMatrix),bi=Float32Array.from(r.cj(Pt)),hn=[r.a8(Pt.center.lng),r.ah(Pt.center.lat)],Ut=[0,0],Ni=Float32Array.from(r.cm(fe.canonical,li,Gn,Pt.worldSize/Pt._pixelsPerMercatorPixel))}else Ut=O instanceof r.as?O.perspectiveTransform:[0,0],Jt=new Float32Array(16),Ti=new Float32Array(9),bi=new Float32Array(16),hn=[0,0],Ni=new Float32Array(9);const Dn=bp(De,Jt,Ti,bi,Ni,zt||[0,0],r.W(d.transform.zoom),hn,vi,Et||1,gt,a,Ut,S?a.paint.get("raster-elevation"):0,2,ze,ge,V.range,Ae,Ye,U),Xi=d.isTileAffectedByFog(fe),Gi=d.getOrCreateProgram("raster",{defines:V.defines,overrideFog:Xi});if(d.uploadCommonUniforms(D,Gi,xe),O instanceof r.as){const li=O.elevatedGlobeVertexBuffer,ui=O.elevatedGlobeIndexBuffer;if(q||!w)O.boundsBuffer&&O.boundsSegments&&Gi.draw(d,z.TRIANGLES,we,ei.disabled,H,Yt.disabled,Dn,a.id,O.boundsBuffer,d.quadTriangleIndexBuffer,O.boundsSegments);else if(li&&ui){const rn=Pt.zoom<=r.bJ?O.elevatedGlobeSegments:O.getSegmentsForLongitude(Pt.center.lng);rn&&Gi.draw(d,z.TRIANGLES,we,ei.disabled,H,ee,Dn,a.id,li,ui,rn)}}else if(C){we=new jt(z.LEQUAL,jt.ReadOnly,d.depthRangeFor3D);const li=d.globeSharedBuffers;if(li){const[ui,rn,Ki]=li.getGridBuffers(Gn,!1);Gi.draw(d,z.TRIANGLES,we,me||Re,d.colorModeForRenderPass(),ee,Dn,a.id,ui,rn,Ki)}}else{const{tileBoundsBuffer:li,tileBoundsIndexBuffer:ui,tileBoundsSegments:rn}=d.getTileBoundsBuffers(ke);Gi.draw(d,z.TRIANGLES,we,Re,H,Yt.disabled,Dn,a.id,li,ui,rn)}}if(!(O instanceof r.as)&&C)for(const fe of Y){const xe=fe.canonical.y===(1<<fe.canonical.z)-1;fe.canonical.y===0&&Xs(!0,fe,d,n,a,U,V,ee,me||ei.disabled),xe&&Xs(!1,fe,d,n,a,U,V,ee===Yt.frontCW?Yt.backCW:Yt.frontCW,me||ei.disabled)}};C?le(oe,d.renderElevatedRasterBackface?Yt.backCW:Yt.frontCW,d.stencilModeFor3D()):le(oe,Yt.disabled,void 0),d.resetStencilClippingMasks()},"raster-particle":function(d,n,a,f,_,x){d.renderPass==="offscreen"&&function(w,S,C,D){if(!D.length)return;const z=w.context,O=z.gl,V=S.getSource();if(!(V instanceof ut))return;const U=Math.ceil(Math.sqrt(C.paint.get("raster-particle-count")));let H=C.particleFramebuffer;H?H.width!==U&&(H.destroy(),H=C.particleFramebuffer=z.createFramebuffer(U,U,!0,null)):H=C.particleFramebuffer=z.createFramebuffer(U,U,!0,null);const q=[];for(const K of D){const oe=S.getTile(K);if(!(oe instanceof Fc))continue;const se=xg(oe,V,C);if(!se)continue;const le=[oe.tileSize,oe.tileSize];let Y=C.tileFramebuffer;Y||(Y=C.tileFramebuffer=z.createFramebuffer(le[0],le[1],!0,null));let ee=oe.rasterParticleState;ee||(ee=oe.rasterParticleState=new sp(z,K,le,U));const me=ee.update(C.lastInvalidatedAt);ee.particleTextureDimension!==U&&ee.setParticleTextureDimension(K,U);const fe=ee.targetColorTexture;ee.targetColorTexture=ee.backgroundColorTexture,ee.backgroundColorTexture=fe;const xe=ee.particleTexture0;ee.particleTexture0=ee.particleTexture1,ee.particleTexture1=xe,q.push([K,se,ee,me])}if(q.length===0)return;const Z=r.f.now(),$=C.previousDrawTimestamp?.001*(Z-C.previousDrawTimestamp):.0167;if(C.previousDrawTimestamp=Z,C.hasColorMap()){z.activeTexture.set(O.TEXTURE0+2);let K=C.colorRampTexture;K||(K=C.colorRampTexture=new r.T(z,C.colorRamp,O.RGBA)),K.bind(O.LINEAR,O.CLAMP_TO_EDGE)}z.bindFramebuffer.set(C.tileFramebuffer.framebuffer),function(K,oe,se){const le=K.context,Y=le.gl,ee=oe.tileFramebuffer;le.activeTexture.set(Y.TEXTURE0);const me={u_texture:0,u_opacity:1.05*(xe=oe.paint.get("raster-particle-fade-opacity-factor"))/(xe+.05)},fe=K.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var xe;for(const ke of se){const[,,ye,Pe]=ke;ee.colorAttachment.set(ye.targetColorTexture.texture),le.viewport.set([0,0,ee.width,ee.height]),le.clear({color:r.aA.transparent}),Pe&&(ye.backgroundColorTexture.bind(Y.NEAREST,Y.CLAMP_TO_EDGE),fe.draw(K,Y.TRIANGLES,jt.disabled,ei.disabled,pi.alphaBlended,Yt.disabled,me,oe.id,K.viewportBuffer,K.quadTriangleIndexBuffer,K.viewportSegments))}}(w,C,q),function(K,oe,se,le){const Y=K.context,ee=Y.gl,me=se.tileFramebuffer,fe=K.transform.projection.name==="globe",xe=se.paint.get("raster-particle-max-speed");for(const ke of le){const[ye,Pe,ze]=ke;Y.activeTexture.set(ee.TEXTURE0+0),Pe.texture.bind(ee.LINEAR,ee.CLAMP_TO_EDGE),me.colorAttachment.set(ze.targetColorTexture.texture);const ge=K.getOrCreateProgram("rasterParticleDraw",{defines:Pe.defines,overrideFog:!1});Y.activeTexture.set(ee.TEXTURE0+1);const Ae=Pe.scalarData?[]:[0,1,2,3].map(De=>r.cN[De](ye));Ae.push(ye);const Ye=ye.canonical.x,we=ye.canonical.y;for(const De of Ae){const Re=oe.getTile(fe?De.wrapped():De);if(!Re)continue;const ae=Re.rasterParticleState;if(!ae)continue;const Ue=De.canonical.x+(1<<De.canonical.z)*(De.wrap-ye.wrap),gt=De.canonical.y;ae.particleTexture0.bind(ee.NEAREST,ee.CLAMP_TO_EDGE);const Et=Ol(1,ae.particleTexture0.size[0],[Ue-Ye,gt-we],0,Pe.texture.size,2,xe,Pe.textureOffset,Pe.scale,Pe.offset);ge.draw(K,ee.POINTS,jt.disabled,ei.disabled,pi.alphaBlended,Yt.disabled,Et,se.id,ae.particleIndexBuffer,void 0,ae.particleSegment)}}}(w,S,C,q),z.bindFramebuffer.set(C.particleFramebuffer.framebuffer),function(K,oe,se,le){const Y=K.context,ee=Y.gl,me=oe.paint.get("raster-particle-max-speed"),fe=le*oe.paint.get("raster-particle-speed-factor")*.3,xe=function(ye){return Math.pow(ye,6)}(.01+1*oe.paint.get("raster-particle-reset-rate-factor")),ke=oe.particleFramebuffer;Y.viewport.set([0,0,ke.width,ke.height]);for(const ye of se){const[,Pe,ze]=ye;Y.activeTexture.set(ee.TEXTURE0+0),Pe.texture.bind(ee.LINEAR,ee.CLAMP_TO_EDGE),Y.activeTexture.set(ee.TEXTURE0+1);const ge=ze.particleTexture0;ge.bind(ee.NEAREST,ee.CLAMP_TO_EDGE);const Ae=_g(1,ge.size[0],0,Pe.texture.size,me,fe,xe,Pe.textureOffset,Pe.scale,Pe.offset);ke.colorAttachment.set(ze.particleTexture1.texture),Y.clear({color:r.aA.transparent}),K.getOrCreateProgram("rasterParticleUpdate",{defines:Pe.defines}).draw(K,ee.TRIANGLES,jt.disabled,ei.disabled,pi.unblended,Yt.disabled,Ae,oe.id,K.viewportBuffer,K.quadTriangleIndexBuffer,K.viewportSegments)}}(w,C,q,$)}(d,n,a,f),d.renderPass==="translucent"&&(function(w,S,C,D,z){const O=w.context,V=O.gl,U=!w.options.moving,H=w.transform.projection.name==="globe";if(!D.length)return;const[q,Z]=w.stencilConfigForOverlap(D),$=[];H&&$.push("PROJECTION_GLOBE_VIEW");const K=w.stencilModeFor3D();for(const oe of Z){const se=oe.toUnwrapped(),le=S.getTile(oe);if(!le.rasterParticleState)continue;const Y=le.rasterParticleState,ee=100;le.registerFadeDuration(ee);const me=S.findLoadedParent(oe,0),fe=Vo(le,me,S,w.transform,ee);let xe,ke;w.terrain&&w.terrain.prepareDrawTile(),O.activeTexture.set(V.TEXTURE0),Y.targetColorTexture.bind(V.LINEAR,V.CLAMP_TO_EDGE),O.activeTexture.set(V.TEXTURE1),me&&me.rasterParticleState?(me.rasterParticleState.targetColorTexture.bind(V.LINEAR,V.CLAMP_TO_EDGE),xe=Math.pow(2,me.tileID.overscaledZ-le.tileID.overscaledZ),ke=[le.tileID.canonical.x*xe%1,le.tileID.canonical.y*xe%1]):Y.targetColorTexture.bind(V.LINEAR,V.CLAMP_TO_EDGE);const ye=H?Float32Array.from(w.transform.expandedFarZProjMatrix):w.transform.calculateProjMatrix(se,U),Pe=w.transform,ze=vg(Pe),ge=r.ck(oe.canonical),Ae=r.cl(ge.getCenter().lat);let Ye,we,De,Re,ae;H?(Ye=Float32Array.from(r.aW(r.cn(oe.canonical))),we=Float32Array.from(Pe.globeMatrix),De=Float32Array.from(r.cj(Pe)),Re=[r.a8(Pe.center.lng),r.ah(Pe.center.lat)],ae=Float32Array.from(r.cm(oe.canonical,ge,Ae,Pe.worldSize/Pe._pixelsPerMercatorPixel))):(Ye=new Float32Array(16),we=new Float32Array(9),De=new Float32Array(16),Re=[0,0],ae=new Float32Array(9));const Ue=Ll(ye,Ye,we,De,ae,ke||[0,0],r.W(w.transform.zoom),Re,ze,xe||1,fe,250),gt=w.isTileAffectedByFog(oe),Et=w.getOrCreateProgram("rasterParticle",{defines:$,overrideFog:gt});if(w.uploadCommonUniforms(O,Et,se),H){const zt=new jt(V.LEQUAL,jt.ReadWrite,w.depthRangeFor3D),Pt=0,Ut=w.globeSharedBuffers;if(Ut){const[vi,Jt,Ti]=Ut.getGridBuffers(Ae,Pt!==0);Et.draw(w,V.TRIANGLES,zt,K,pi.alphaBlended,Yt.backCCW,Ue,C.id,vi,Jt,Ti)}}else{const zt=w.depthModeForSublayer(0,jt.ReadOnly),Pt=q[oe.overscaledZ],{tileBoundsBuffer:Ut,tileBoundsIndexBuffer:vi,tileBoundsSegments:Jt}=w.getTileBoundsBuffers(le);Et.draw(w,V.TRIANGLES,zt,Pt,pi.alphaBlended,Yt.disabled,Ue,C.id,Ut,vi,Jt)}}w.resetStencilClippingMasks()}(d,n,a,f),d.style.map.triggerRepaint())},background:function(d,n,a,f){const _=a.paint.get("background-color"),x=a.paint.get("background-opacity"),w=a.paint.get("background-emissive-strength");if(x===0)return;const S=d.context,C=S.gl,D=d.transform,z=D.tileSize,O=a.paint.get("background-pattern");if(d.isPatternMissing(O,a.scope))return;const V=!O&&_.a===1&&x===1&&d.opaquePassEnabledForLayer()?"opaque":"translucent";if(d.renderPass!==V)return;const U=ei.disabled,H=d.depthModeForSublayer(0,V==="opaque"?jt.ReadWrite:jt.ReadOnly),q=d.colorModeForDrapableLayerRenderPass(w),Z=O?"backgroundPattern":"background";let $,K=f;K||($=d.getBackgroundTiles(),K=Object.values($).map(oe=>oe.tileID)),O&&(S.activeTexture.set(C.TEXTURE0),d.imageManager.bind(d.context,a.scope));for(const oe of K){const se=d.isTileAffectedByFog(oe),le=d.getOrCreateProgram(Z,{overrideFog:se}),Y=oe.toUnwrapped(),ee=f?oe.projMatrix:d.transform.calculateProjMatrix(Y);d.prepareDrawTile();const me=n?n.getTile(oe):$?$[oe.key]:new ps(oe,z,D.zoom,d),fe=O?yg(ee,w,x,d,O,a.scope,{tileID:oe,tileSize:z}):gg(ee,w,x,_);d.uploadCommonUniforms(S,le,Y);const{tileBoundsBuffer:xe,tileBoundsIndexBuffer:ke,tileBoundsSegments:ye}=d.getTileBoundsBuffers(me);le.draw(d,C.TRIANGLES,H,U,q,Yt.disabled,fe,a.id,xe,ke,ye)}},sky:function(d,n,a){const f=d._atmosphere?r.W(d.transform.zoom):1,_=a.paint.get("sky-opacity")*f;if(_===0)return;const x=d.context,w=a.paint.get("sky-type"),S=new jt(x.gl.LEQUAL,jt.ReadOnly,[0,1]),C=d.frameCounter/1e3%1;w==="atmosphere"?d.renderPass==="offscreen"?a.needsSkyboxCapture(d)&&(function(D,z,O,V){const U=D.context,H=U.gl;let q=z.skyboxFbo;if(!q){q=z.skyboxFbo=U.createFramebuffer(32,32,!0,null),z.skyboxGeometry=new Pp(U),z.skyboxTexture=U.gl.createTexture(),H.bindTexture(H.TEXTURE_CUBE_MAP,z.skyboxTexture),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_WRAP_S,H.CLAMP_TO_EDGE),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_WRAP_T,H.CLAMP_TO_EDGE),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_MIN_FILTER,H.LINEAR),H.texParameteri(H.TEXTURE_CUBE_MAP,H.TEXTURE_MAG_FILTER,H.LINEAR);for(let oe=0;oe<6;++oe)H.texImage2D(H.TEXTURE_CUBE_MAP_POSITIVE_X+oe,0,H.RGBA,32,32,0,H.RGBA,H.UNSIGNED_BYTE,null)}U.bindFramebuffer.set(q.framebuffer),U.viewport.set([0,0,32,32]);const Z=z.getCenter(D,!0),$=D.getOrCreateProgram("skyboxCapture"),K=new Float64Array(16);r.a9.identity(K),r.a9.rotateY(K,K,.5*-Math.PI),Wo(D,z,$,K,Z,0),r.a9.identity(K),r.a9.rotateY(K,K,.5*Math.PI),Wo(D,z,$,K,Z,1),r.a9.identity(K),r.a9.rotateX(K,K,.5*-Math.PI),Wo(D,z,$,K,Z,2),r.a9.identity(K),r.a9.rotateX(K,K,.5*Math.PI),Wo(D,z,$,K,Z,3),r.a9.identity(K),Wo(D,z,$,K,Z,4),r.a9.identity(K),r.a9.rotateY(K,K,Math.PI),Wo(D,z,$,K,Z,5),U.viewport.set([0,0,D.width,D.height])}(d,a),a.markSkyboxValid(d)):d.renderPass==="sky"&&function(D,z,O,V,U){const H=D.context,q=H.gl,Z=D.transform,$=D.getOrCreateProgram("skybox");H.activeTexture.set(q.TEXTURE0),q.bindTexture(q.TEXTURE_CUBE_MAP,z.skyboxTexture);const K=((oe,se,le,Y,ee)=>({u_matrix:oe,u_sun_direction:se,u_cubemap:0,u_opacity:Y,u_temporal_offset:ee}))(Z.skyboxMatrix,z.getCenter(D,!1),0,V,U);D.uploadCommonUniforms(H,$),$.draw(D,q.TRIANGLES,O,ei.disabled,D.colorModeForRenderPass(),Yt.backCW,K,"skybox",z.skyboxGeometry.vertexBuffer,z.skyboxGeometry.indexBuffer,z.skyboxGeometry.segment)}(d,a,S,_,C):w==="gradient"&&d.renderPass==="sky"&&function(D,z,O,V,U){const H=D.context,q=H.gl,Z=D.transform,$=D.getOrCreateProgram("skyboxGradient");z.skyboxGeometry||(z.skyboxGeometry=new Pp(H)),H.activeTexture.set(q.TEXTURE0);let K=z.colorRampTexture;K||(K=z.colorRampTexture=new r.T(H,z.colorRamp,q.RGBA)),K.bind(q.LINEAR,q.CLAMP_TO_EDGE);const oe=((se,le,Y,ee,me)=>({u_matrix:se,u_color_ramp:0,u_center_direction:le,u_radius:r.bm(Y),u_opacity:ee,u_temporal_offset:me}))(Z.skyboxMatrix,z.getCenter(D,!1),z.paint.get("sky-gradient-radius"),V,U);D.uploadCommonUniforms(H,$),$.draw(D,q.TRIANGLES,O,ei.disabled,D.colorModeForRenderPass(),Yt.backCW,oe,"skyboxGradient",z.skyboxGeometry.vertexBuffer,z.skyboxGeometry.indexBuffer,z.skyboxGeometry.segment)}(d,a,S,_,C)},debug:function(d,n,a,f,_,x){for(let w=0;w<a.length;w++)if(_){const D=new r.aA(f.r*.8,f.g*.8,f.b*.8,1);Ca(d,n,a[w],f,-1,-1,x),Ca(d,n,a[w],f,-1,1,x),Ca(d,n,a[w],f,1,1,x),Ca(d,n,a[w],f,1,-1,x),Ca(d,n,a[w],D,0,0,x)}else Ca(d,n,a[w],f,0,0,x)},custom:function(d,n,a,f){const _=d.context,x=a.implementation;if(!d.transform.projection.unsupportedLayers||!d.transform.projection.unsupportedLayers.includes("custom")||d.terrain&&(d.terrain.renderingToTexture||d.renderPass==="offscreen")&&a.isDraped(n)){if(d.renderPass==="offscreen"){const w=x.prerender;if(w){if(d.setCustomLayerDefaults(),_.setColorMode(d.colorModeForRenderPass()),d.transform.projection.name==="globe"){const S=d.transform.pointMerc;w.call(x,_.gl,d.transform.customLayerMatrix(),d.transform.getProjection(),d.transform.globeToMercatorMatrix(),r.W(d.transform.zoom),[S.x,S.y],d.transform.pixelsPerMeterRatio)}else w.call(x,_.gl,d.transform.customLayerMatrix());_.setDirty(),d.setBaseState()}}else if(d.renderPass==="translucent"){if(d.terrain&&d.terrain.renderingToTexture){const S=x.renderToTile;if(S){const C=f[0].canonical,D=new r.O(C.x+f[0].wrap*(1<<C.z),C.y,C.z);_.setDepthMode(jt.disabled),_.setStencilMode(ei.disabled),_.setColorMode(d.colorModeForRenderPass()),d.setCustomLayerDefaults(),S.call(x,_.gl,D),_.setDirty(),d.setBaseState()}return}d.setCustomLayerDefaults(),_.setColorMode(d.colorModeForRenderPass()),_.setStencilMode(ei.disabled);const w=x.renderingMode==="3d"?new jt(d.context.gl.LEQUAL,jt.ReadWrite,d.depthRangeFor3D):d.depthModeForSublayer(0,jt.ReadOnly);if(_.setDepthMode(w),d.transform.projection.name==="globe"){const S=d.transform.pointMerc;x.render(_.gl,d.transform.customLayerMatrix(),d.transform.getProjection(),d.transform.globeToMercatorMatrix(),r.W(d.transform.zoom),[S.x,S.y],d.transform.pixelsPerMeterRatio)}else x.render(_.gl,d.transform.customLayerMatrix());_.setDirty(),d.setBaseState(),_.bindFramebuffer.set(null)}}else r.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(d,n,a,f){if(d.renderPass==="opaque")return;const _=a.paint.get("model-opacity");if(_===0)return;const x=a.paint.get("model-cast-shadows");if(d.renderPass==="shadow"&&(!x||d.terrain&&_<.65&&a._transitionablePaint._values["model-opacity"].value.expression instanceof r.Z))return;const w=d.shadowRenderer,S=a.paint.get("model-receive-shadows");w&&(w.useNormalOffset=!0,S||(w.enabled=!1));const C=()=>{w&&(w.useNormalOffset=!0,S||(w.enabled=!0))},D=n.getSource();if(d.renderPass==="light-beam"&&D.type!=="batched-model")return;if(D.type==="vector"||D.type==="geojson")return function($,K,oe,se,le){const Y=$.transform;if(Y.projection.name!=="mercator")return void r.w(`Drawing 3D models for ${Y.projection.name} projection is not yet implemented`);const ee=Y.getFreeCameraOptions().position;if(!$.modelManager)return;const me=$.modelManager;oe.modelManager=me;const fe=$.shadowRenderer;if(!oe._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const xe=oe._unevaluatedLayout._values["model-id"],ke={...oe.layout.get("model-id").parameters};for(const ye of se){const Pe=K.getTile(ye).getBucket(oe);if(!Pe||Pe.projection.name!==Y.projection.name)continue;const ze=Pe.getModelUris();ze&&!Pe.modelsRequested&&(me.addModelsFromBucket(ze,le),Pe.modelsRequested=!0);const ge=gu(ye,Y);ke.zoom=ge;const Ae=xe.possiblyEvaluate(ke);if(jl($,Pe,ye),Qr.shadowUniformsInitialized=!1,Qr.useSingleShadowCascade=!!fe&&fe.getMaxCascadeForTile(ye.toUnwrapped())===0,$.renderPass==="shadow"&&fe){if($.currentShadowCascade===1&&Pe.isInsideFirstShadowMapFrustum)continue;const De=Y.calculatePosMatrix(ye.toUnwrapped(),Y.worldSize);if(Qr.tileMatrix.set(De),Qr.shadowTileMatrix=Float32Array.from(fe.calculateShadowPassMatrixFromMatrix(De)),Qr.aabb.min.fill(0),Qr.aabb.max[0]=Qr.aabb.max[1]=r.Y,Qr.aabb.max[2]=0,Gl(Pe,Qr,$,oe.scope))continue}const Ye=1<<ye.canonical.z,we=[((ee.x-ye.wrap)*Ye-ye.canonical.x)*r.Y,(ee.y*Ye-ye.canonical.y)*r.Y,ee.z*Ye*r.Y];for(let De in Pe.instancesPerModel){const Re=Pe.instancesPerModel[De];Re.features.length>0&&(De=Ae.evaluate(Re.features[0].feature,{}));const ae=me.getModel(De,le);if(ae&&ae.uploaded)for(const Ue of ae.nodes)yu($,oe,Ue,Re,we,ye,Qr)}}}(d,n,a,f,D.type==="vector"?a.scope:""),void C();if(!D.loaded())return;if(D.type==="batched-model")return function($,K,oe,se){oe.resetLayerRenderingStats($);const le=$.context,Y=$.transform,ee=$.style.fog,me=$.shadowRenderer;if(Y.projection.name!=="mercator")return void r.w(`Drawing 3D landmark models for ${Y.projection.name} projection is not yet implemented`);const fe=$.transform.getFreeCameraOptions().position,xe=r.Q.scale([],[fe.x,fe.y,fe.z],$.transform.worldSize);r.Q.negate(xe,xe);const ke=r.a9.identity([]),ye=r.cZ(Y.center.lat,Y.zoom),Pe=r.a9.fromScaling([],[1,1,1/ye]);r.a9.translate(ke,ke,xe);const ze=oe.paint.get("model-opacity"),ge=new jt(le.gl.LEQUAL,jt.ReadWrite,$.depthRangeFor3D),Ae=new jt(le.gl.LEQUAL,jt.ReadOnly,$.depthRangeFor3D),Ye=new r.bV([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),we=$.renderPass==="shadow",De=we&&me?me.getCurrentCascadeFrustum():Y.getFrustum(Y.scaleZoom(Y.worldSize)),Re=oe.getLayerRenderingStats(),ae=function(Ue,gt){for(const Et of se){const zt=K.getTile(Et).getBucket(oe);if(!zt||!zt.uploaded)continue;let Pt=!1;me&&(Pt=me.getMaxCascadeForTile(Et.toUnwrapped())===0);const Ut=Y.calculatePosMatrix(Et.toUnwrapped(),Y.worldSize),vi=zt.modelTraits;for(const Jt of zt.getNodesInfo()){if(Jt.hiddenByReplacement||!Jt.node.meshes)continue;const Ti=Jt.evaluatedScale,bi=Jt.node;let hn=0;if($.terrain&&bi.elevation&&(hn=bi.elevation*$.terrain.exaggeration()),Ti[0]<=1&&Ti[1]<=1&&Ti[2]<=1&&(()=>{const _i=Jt.getLocalBounds();return Ye.min=[..._i.min],Ye.max=[..._i.max],Ye.min[2]+=hn,Ye.max[2]+=hn,r.Q.transformMat4(Ye.min,Ye.min,Ut),r.Q.transformMat4(Ye.max,Ye.max,Ut),Ye})().intersects(De)===0)continue;const Ni=[...Ut];r.a9.translate(Ni,Ni,[(bi.anchor?bi.anchor[0]:0)*(Ti[0]-1),(bi.anchor?bi.anchor[1]:0)*(Ti[1]-1),hn]),r.Q.exactEquals(Ti,r.c$)||r.a9.scale(Ni,Ni,Ti);const Gn=r.a9.multiply([],Ni,bi.matrix);let Dn=r.a9.multiply([],Pe,Ni);r.a9.multiply(Dn,ke,Dn);const Xi=r.a9.invert([],Dn);r.a9.transpose(Xi,Xi),r.a9.scale(Xi,Xi,xu),Dn=r.a9.multiply(Dn,Dn,bi.matrix);const Gi=$.renderPass==="light-beam",li=r.a9.multiply([],Y.expandedFarZProjMatrix,Gn),ui=r.a9.multiply([],Y.expandedFarZProjMatrix,Ni),rn=vi&r.d1.HasMapboxMeshFeatures,Ki=rn?0:Jt.evaluatedRMEA[0][2];for(let _i=0;_i<bi.meshes.length;++_i){const ni=bi.meshes[_i],Rr=_i===bi.lightMeshIndex;let gr=li;if(Rr){if(!Gi&&!$.terrain&&$.shadowRenderer){$.currentLayer<$.firstLightBeamLayer&&($.firstLightBeamLayer=$.currentLayer);continue}gr=ui}else if(Gi)continue;const Qn={defines:[]},yr=[];if(xo(Qn.defines,yr,ni,$),rn||Qn.defines.push("DIFFUSE_SHADED"),Pt&&Qn.defines.push("SHADOWS_SINGLE_CASCADE"),Re&&(we?Re.numRenderedVerticesInShadowPass+=ni.vertexArray.length:Re.numRenderedVerticesInTransparentPass+=ni.vertexArray.length),we){Ul(ni,Gn,$,oe);continue}let zr=null;if(ee){const ws=od(Gn,$.transform);if(zr=new Float32Array(ws),Y.projection.name!=="globe"){const Fs=ni.aabb.min,Bs=ni.aabb.max,[To,ts]=ee.getOpacityForBounds(ws,Fs[0],Fs[1],Bs[0],Bs[1]);Qn.overrideFog=To>=Li||ts>=Li}}const Tr=ni.material;let Xn;Tr.occlusionTexture&&Tr.occlusionTexture.offsetScale&&(Xn=Tr.occlusionTexture.offsetScale,Qn.defines.push("OCCLUSION_TEXTURE_TRANSFORM")),!we&&me&&(me.useNormalOffset=!!ni.normalBuffer);const cr=$.getOrCreateProgram("model",Qn);!we&&me&&me.setupShadowsFromMatrix(Ni,cr,me.useNormalOffset),$.uploadCommonUniforms(le,cr,null,zr);const ur=Tr.pbrMetallicRoughness;ur.metallicFactor=.9,ur.roughnessFactor=.5;const Os=cu(new Float32Array(gr),new Float32Array(Dn),new Float32Array(Xi),new Float32Array(bi.matrix),$,ze,ur.baseColorFactor,Tr.emissiveFactor,ur.metallicFactor,ur.roughnessFactor,Tr,Ki,oe,[0,0,0],Xn);cr.draw($,le.gl.TRIANGLES,gt&&!Rr?ge:Ae,ei.disabled,Ue?Rr||ze<1||Jt.hasTranslucentParts?pi.alphaBlended:pi.unblended:pi.disabled,Yt.backCCW,Os,oe.id,ni.vertexBuffer,ni.indexBuffer,ni.segments,oe.paint,$.transform.zoom,void 0,yr)}}}};(function(Ue,gt,Et,zt){const Pt=Ue.terrain?Ue.terrain.exaggeration():0,Ut=Ue.transform.zoom;for(const vi of zt){const Jt=gt.getTile(vi).getBucket(Et);Jt&&(Ue.conflationActive&&Jt.updateReplacement(vi,Ue.replacementSource),Jt.evaluateScale(Ue,Et),Ue.terrain&&Pt>0&&Jt.elevationUpdate(Ue.terrain,Pt,vi,Et.source),Jt.needsReEvaluation(Ue,Ut,Et)&&Jt.evaluate(Et))}})($,K,oe,se),ze===1?ae(!0,!0):(ae(!1,!0),ae(!0,!1))}(d,n,a,f),void C();const z=D.getModels(),O=[],V=d.transform.getFreeCameraOptions().position,U=r.Q.scale([],[V.x,V.y,V.z],d.transform.worldSize);r.Q.negate(U,U);const H=[],q=[];let Z=0;for(const $ of z){const K=a.paint.get("model-rotation").constantOr(null),oe=a.paint.get("model-scale").constantOr(null),se=a.paint.get("model-translation").constantOr(null);$.computeModelMatrix(d,K,oe,se,!0,!0,!1);const le=r.a9.identity([]),Y=r.cZ($.position.lat,d.transform.zoom),ee=r.a9.fromScaling([],[1,1,1/Y]);r.a9.translate(le,le,U),O.push({zScaleMatrix:ee,negCameraPosMatrix:le});for(const me of $.nodes)Vl(d.transform,me,$.matrix,d.transform.expandedFarZProjMatrix,Z,H,q);Z++}if(H.sort(($,K)=>K.depth-$.depth),d.renderPass!=="shadow"){if(_===1)for(const $ of q)vo($,d,a,O[$.modelIndex],ei.disabled,d.colorModeForRenderPass());else{for(const $ of q)vo($,d,a,O[$.modelIndex],ei.disabled,pi.disabled);for(const $ of q)vo($,d,a,O[$.modelIndex],d.stencilModeFor3D(),d.colorModeForRenderPass());d.resetStencilClippingMasks()}for(const $ of H)vo($,d,a,O[$.modelIndex],ei.disabled,d.colorModeForRenderPass());C()}else{for(const $ of q)Ul($.mesh,$.nodeModelMatrix,d,a);for(const $ of H)Ul($.mesh,$.nodeModelMatrix,d,a);C()}}},Ho={model:function(d,n,a){const f=n.getSource();if(!f.loaded())return;if(f.type==="vector"||f.type==="geojson")return void(a.modelManager&&a.modelManager.upload(a,f.type==="vector"?d.scope:""));if(f.type==="batched-model")return;const _=f.getModels();for(const x of _)x.upload(a.context)},raster:function(d,n,a){const f=n.getSource();if(!(f instanceof ut&&f.loaded()))return;const _=d.sourceLayer||f.rasterLayerIds&&f.rasterLayerIds[0];if(!_)return;const x=d.paint.get("raster-array-band")||f.getInitialBand(_);if(x==null)return;const w=n.getIds().map(S=>n.getTileByID(S));for(const S of w)S.updateNeeded(_,x)&&f.prepareTile(S,_,x)},"raster-particle":function(d,n,a){const f=n.getSource();if(!(f instanceof ut&&f.loaded()))return;const _=d.sourceLayer||f.rasterLayerIds&&f.rasterLayerIds[0];if(!_)return;const x=d.paint.get("raster-particle-array-band")||f.getInitialBand(_);if(x==null)return;const w=n.getIds().map(S=>n.getTileByID(S));for(const S of w)S.updateNeeded(_,x)&&f.prepareTile(S,_,x)}};class Rp{constructor(n,a,f,_){this.context=new Ds(n,a),this.transform=f,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=_,this._timeStamp=new Date().getTime(),this._averageFPS=0,this._fpsHistory=[],this._debugParams={showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const x=["fill","line","symbol","circle","heatmap","fill-extrusion","raster","raster-particle","hillshade","model","background","sky"];for(const w of x)this._debugParams.enabledLayers[w]=!0;_.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),_.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),_.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),_.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),_.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const w of x)_.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],w);this.setup(),this.numSublayers=ms.maxUnderzooming+ms.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new r.d3,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new gp(this),this._wireframeDebugCache=new kp,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0}updateTerrain(n,a){const f=!!n&&!!n.terrain&&this.transform.projection.supportsTerrain;if(!(f||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Yr(this,n));const _=this._terrain;this.transform.elevation=f?_:null,_.update(n,this.transform,a),this.transform.elevation&&!_.enabled&&(this.transform.elevation=null)}_updateFog(n){const a=n.fog;if(!a||this.transform.projection.name==="globe"||a.getOpacity(this.transform.pitch)<1||a.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[f,_]=a.getFovAdjustedRange(this.transform._fov);if(f>_)return void(this.transform.fogCullDistSq=null);const x=f+.78*(_-f);this.transform.fogCullDistSq=x*x}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(n,a){if(this.width=n*r.f.devicePixelRatio,this.height=a*r.f.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const f of this.style.order)this.style._mergedLayers[f].resize()}setup(){const n=this.context,a=new r.aQ;a.emplaceBack(0,0),a.emplaceBack(r.Y,0),a.emplaceBack(0,r.Y),a.emplaceBack(r.Y,r.Y),this.tileExtentBuffer=n.createVertexBuffer(a,r.aS.members),this.tileExtentSegments=r.aE.simpleSegment(0,0,4,2);const f=new r.aQ;f.emplaceBack(0,0),f.emplaceBack(r.Y,0),f.emplaceBack(0,r.Y),f.emplaceBack(r.Y,r.Y),this.debugBuffer=n.createVertexBuffer(f,r.aS.members),this.debugSegments=r.aE.simpleSegment(0,0,4,5);const _=new r.aQ;_.emplaceBack(-1,-1),_.emplaceBack(1,-1),_.emplaceBack(-1,1),_.emplaceBack(1,1),this.viewportBuffer=n.createVertexBuffer(_,r.aS.members),this.viewportSegments=r.aE.simpleSegment(0,0,4,2);const x=new r.ay;x.emplaceBack(0,0,0,0),x.emplaceBack(r.Y,0,r.Y,0),x.emplaceBack(0,r.Y,0,r.Y),x.emplaceBack(r.Y,r.Y,r.Y,r.Y),this.mercatorBoundsBuffer=n.createVertexBuffer(x,r.aU.members),this.mercatorBoundsSegments=r.aE.simpleSegment(0,0,4,2);const w=new r.az;w.emplaceBack(0,1,2),w.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=n.createIndexBuffer(w);const S=new r.aR;for(const D of[0,1,3,2,0])S.emplaceBack(D);this.debugIndexBuffer=n.createIndexBuffer(S),this.emptyTexture=new r.T(n,new r.h({width:1,height:1},Uint8Array.of(0,0,0,0)),n.gl.RGBA),this.identityMat=r.a9.create();const C=this.context.gl;this.stencilClearMode=new ei({func:C.ALWAYS,mask:0},0,255,C.ZERO,C.ZERO,C.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(n){return n._makeTileBoundsBuffers(this.context,this.transform.projection),n._tileBoundsBuffer?{tileBoundsBuffer:n._tileBoundsBuffer,tileBoundsIndexBuffer:n._tileBoundsIndexBuffer,tileBoundsSegments:n._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const n=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,n.TRIANGLES,jt.disabled,this.stencilClearMode,pi.disabled,Yt.disabled,kl(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(n,a,f){if(!a||this.currentStencilSource===a.id||!n.isTileClipped()||!f||f.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let S=!1;for(const C of f)if(this._tileClippingMaskIDs[C.key]===void 0){S=!0;break}if(!S)return}this.currentStencilSource=a.id;const _=this.context,x=_.gl;this.nextStencilID+f.length>256&&this.clearStencil(),_.setColorMode(pi.disabled),_.setDepthMode(jt.disabled);const w=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const S of f){const C=a.getTile(S),D=this._tileClippingMaskIDs[S.key]=this.nextStencilID++,{tileBoundsBuffer:z,tileBoundsIndexBuffer:O,tileBoundsSegments:V}=this.getTileBoundsBuffers(C);w.draw(this,x.TRIANGLES,jt.disabled,new ei({func:x.ALWAYS,mask:0},D,255,x.KEEP,x.KEEP,x.REPLACE),pi.disabled,Yt.disabled,kl(S.projMatrix),"$clipping",z,O,V)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const n=this.nextStencilID++,a=this.context.gl;return new ei({func:a.NOTEQUAL,mask:255},n,255,a.KEEP,a.KEEP,a.REPLACE)}stencilModeForClipping(n){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(n);const a=this.context.gl;return new ei({func:a.EQUAL,mask:255},this._tileClippingMaskIDs[n.key],0,a.KEEP,a.KEEP,a.REPLACE)}stencilConfigForOverlap(n){const a=this.context.gl,f=n.sort((w,S)=>S.overscaledZ-w.overscaledZ),_=f[f.length-1].overscaledZ,x=f[0].overscaledZ-_+1;if(x>1){this.currentStencilSource=void 0,this.nextStencilID+x>256&&this.clearStencil();const w={};for(let S=0;S<x;S++)w[S+_]=new ei({func:a.GEQUAL,mask:255},S+this.nextStencilID,255,a.KEEP,a.KEEP,a.REPLACE);return this.nextStencilID+=x,[w,f]}return[{[_]:ei.disabled},f]}colorModeForRenderPass(){const n=this.context.gl;return this._showOverdrawInspector?new pi([n.CONSTANT_COLOR,n.ONE,n.CONSTANT_COLOR,n.ONE],new r.aA(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?pi.unblended:pi.alphaBlended}colorModeForDrapableLayerRenderPass(n){const a=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new pi([a.ONE,a.ONE_MINUS_SRC_ALPHA,a.CONSTANT_ALPHA,a.ONE_MINUS_SRC_ALPHA],new r.aA(0,0,0,n===void 0?0:n),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(n,a,f,_=!1){if(!this.opaquePassEnabledForLayer()&&!_)return jt.disabled;const x=1-((1+this.currentLayer)*this.numSublayers+n)*this.depthEpsilon;return new jt(f||this.context.gl.LEQUAL,a,[x,x])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}updateAverageFPS(){const n=new Date().getTime(),a=n-this._timeStamp;this._timeStamp=n,this._fpsHistory.push(a===0?0:1e3/a),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((f,_)=>f+_/this._fpsHistory.length,0))}render(n,a){this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=n.map.repaint,this.style=n,this.options=a;const f=this.style._mergedLayers,_=this.style.order.filter(Y=>{const ee=f[Y];return!(ee.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[ee.type]}),x=_.map(Y=>f[Y]),w=this.style._mergedSourceCaches;this.imageManager=n.imageManager,this.modelManager=n.modelManager,this.symbolFadeChange=n.placement.symbolFadeChange(r.f.now()),this.imageManager.beginFrame();let S=0,C=!1;for(const Y in w){const ee=w[Y];ee.used&&(ee.prepare(this.context),ee.getSource().usedInConflation&&++S)}for(const Y of x)Y.isHidden(this.transform.zoom)||this.prepareLayer(Y);const D={},z={},O={},V={},U={};for(const Y in w){const ee=w[Y];D[Y]=ee.getVisibleCoordinates(),z[Y]=D[Y].slice().reverse(),O[Y]=ee.getVisibleCoordinates(!0).reverse(),V[Y]=ee.getShadowCasterCoordinates(),U[Y]=ee.sortCoordinatesByDistance(D[Y])}const H=Y=>{const ee=this.style.getLayerSourceCache(Y);return ee&&ee.used?ee.getSource():null};if(S){const Y=[];for(const ee of x)this.layerUsedInConflation(ee,H(ee))&&Y.push(ee);if(Y&&Y.length>1){const ee=[];for(const me of Y){const fe=this.style.getLayerSourceCache(me);fe&&fe.used&&fe.getSource().usedInConflation&&ee.push({layer:me.fqid,cache:fe})}this.replacementSource.setSources(ee),C=!0}}C||this.replacementSource.clear(),this.conflationActive=C,this.minCutoffZoom=0,this.longestCutoffRange=0;for(const Y of x){const ee=Y.cutoffRange();if(this.longestCutoffRange=Math.max(ee,this.longestCutoffRange),ee>0){const me=H(Y);me&&(this.minCutoffZoom=Math.max(me.minzoom,this.minCutoffZoom)),Y.minzoom&&(this.minCutoffZoom=Math.max(Y.minzoom,this.minCutoffZoom))}}this.opaquePassCutoff=1/0;for(let Y=0;Y<x.length;Y++)if(x[Y].is3D()){this.opaquePassCutoff=Y;break}const q=this.style&&this.style.fog;q?(this._fogVisible=q.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=q.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(O),this.opaquePassCutoff=0);const Z=this._shadowRenderer;if(Z){Z.updateShadowParameters(this.transform,this.style.directionalLight);for(const Y in w)for(const ee of D[Y]){let me={min:0,max:0};this.terrain&&(me=this.terrain.getMinMaxForTile(ee)||me),Z.addShadowReceiver(ee.toUnwrapped(),me.min,me.max)}}if(this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new r.d4(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new sd(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),!r.d5(this.context.gl))return;this.renderPass="offscreen";for(const Y of x){const ee=n.getLayerSourceCache(Y);if(!Y.hasOffscreenPass()||Y.isHidden(this.transform.zoom))continue;const me=ee?z[ee.id]:void 0;(Y.type==="custom"||Y.type==="raster"||Y.type==="raster-particle"||Y.isSky()||me&&me.length)&&this.renderLayer(this,ee,Y,me)}this.depthRangeFor3D=[0,1-(x.length+2)*this.numSublayers*this.depthEpsilon];const $=this.terrain;$&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&!this.transform.isOrthographic&&$.drawDepth(),this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,V)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const K=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),oe=(()=>{if(a.showOverdrawInspector)return r.aA.black;if(this.style.fog&&this.transform.projection.supportsFog&&!K){const Y=this.style.fog.properties.get("color").toArray01();return new r.aA(...Y)}if(this.style.fog&&this.transform.projection.supportsFog&&K){const Y=this.style.fog.properties.get("space-color").toArray01();return new r.aA(...Y)}return r.aA.transparent})();if(this.context.clear({color:oe,depth:1}),this.clearStencil(),this._showOverdrawInspector=a.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&K&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=_.length-1;this.currentLayer>=0;this.currentLayer--){const Y=x[this.currentLayer],ee=n.getLayerSourceCache(Y);if(Y.isSky())continue;const me=ee?(Y.is3D()?U:z)[ee.id]:void 0;this._renderTileClippingMasks(Y,ee,me),this.renderLayer(this,ee,Y,me)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&K&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||r.W(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<_.length;this.currentLayer++){const Y=x[this.currentLayer],ee=n.getLayerSourceCache(Y);Y.isSky()&&this.renderLayer(this,ee,Y,ee?z[ee.id]:void 0)}function se(Y,ee){let me;return ee&&(me=(Y.type==="symbol"?O:Y.is3D()?U:z)[ee.id]),me}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<_.length;){const Y=x[this.currentLayer];if(Y.type==="raster"){const ee=n.getLayerSourceCache(Y);this.renderLayer(this,ee,Y,se(Y,ee))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let le=0;for(Z&&(le=Z.getShadowCastingLayerCount());this.currentLayer<_.length;){const Y=x[this.currentLayer],ee=n.getLayerSourceCache(Y);if(Y.isSky())++this.currentLayer;else if($&&this.style.isLayerDraped(Y)){if(Y.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=$.renderBatch(this.currentLayer)}else{if(this._renderTileClippingMasks(Y,ee,ee?D[ee.id]:void 0),this.renderLayer(this,ee,Y,se(Y,ee)),!$&&Z&&le>0&&Y.hasShadowPass()&&--le==0&&(Z.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const me=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=me;this.currentLayer++){const fe=x[this.currentLayer];if(!fe.hasLightBeamPass())continue;const xe=n.getLayerSourceCache(fe);this.renderLayer(this,xe,fe,xe?z[xe.id]:void 0)}this.currentLayer=me,this.renderPass="translucent"}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let Y=null;x.forEach(ee=>{const me=n.getLayerSourceCache(ee);me&&!ee.isHidden(this.transform.zoom)&&me.getVisibleCoordinates().length&&(!Y||Y.getSource().maxzoom<me.getSource().maxzoom)&&(Y=me)}),Y&&this.options.showTileBoundaries&&vu.debug(this,Y,Y.getVisibleCoordinates(),r.aA.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&vu.debug(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new r.aA(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(Y){const ee=Y.transform.padding;Ap(Y,Y.transform.height-(ee.top||0),3,td),Ap(Y,ee.bottom||0,3,bg),Ip(Y,ee.left||0,3,Sp),Ip(Y,Y.transform.width-(ee.right||0),3,Ep);const me=Y.transform.centerPoint;(function(fe,xe,ke,ye){mu(fe,xe-1,ke-10,2,20,ye),mu(fe,xe-10,ke-1,20,2,ye)})(Y,me.x,Y.transform.height-me.y,id)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),C||(this.conflationActive=!1)}prepareLayer(n){this.gpuTimingStart(n);const{unsupportedLayers:a}=this.transform.projection,f=!a||!a.includes(n.type);if(Ho[n.type]&&(f||this.terrain&&n.type==="custom")){const _=this.style.getLayerSourceCache(n);Ho[n.type](n,_,this)}this.gpuTimingEnd()}renderLayer(n,a,f,_){f.isHidden(this.transform.zoom)||(f.type==="background"||f.type==="sky"||f.type==="custom"||f.type==="model"||f.type==="raster"||f.type==="raster-particle"||_&&_.length)&&(this.id=f.id,this.gpuTimingStart(f),(!n.transform.projection.unsupportedLayers||!n.transform.projection.unsupportedLayers.includes(f.type)||n.terrain&&f.type==="custom")&&vu[f.type](n,a,f,_,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(n){if(!this.options.gpuTiming)return;const a=this.context.extTimerQuery,f=this.context.gl;let _=this.gpuTimers[n.id];_||(_=this.gpuTimers[n.id]={calls:0,cpuTime:0,query:f.createQuery()}),_.calls++,f.beginQuery(a.TIME_ELAPSED_EXT,_.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const n=this.context.extTimerQuery,a=this.context.gl,f=a.createQuery();this.deferredRenderGpuTimeQueries.push(f),a.beginQuery(n.TIME_ELAPSED_EXT,f)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const n=this.gpuTimers;return this.gpuTimers={},n}collectDeferredRenderGpuQueries(){const n=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],n}queryGpuTimers(n){const a={};for(const f in n){const _=n[f],x=this.context.extTimerQuery,w=x.getQueryParameter(_.query,this.context.gl.QUERY_RESULT)/1e6;x.deleteQueryEXT(_.query),a[f]=w}return a}queryGpuTimeDeferredRender(n){if(!this.options.gpuTimingDeferredRender)return 0;const a=this.context.extTimerQuery,f=this.context.gl;let _=0;for(const x of n)_+=a.getQueryParameter(x,f.QUERY_RESULT)/1e6,a.deleteQueryEXT(x);return _}translatePosMatrix(n,a,f,_,x){if(!f[0]&&!f[1])return n;const w=x?_==="map"?this.transform.angle:0:_==="viewport"?-this.transform.angle:0;if(w){const D=Math.sin(w),z=Math.cos(w);f=[f[0]*z-f[1]*D,f[0]*D+f[1]*z]}const S=[x?f[0]:r.a6(a,f[0],this.transform.zoom),x?f[1]:r.a6(a,f[1],this.transform.zoom),0],C=new Float32Array(16);return r.a9.translate(C,n,S),C}saveTileTexture(n){const a=n.size[0],f=this._tileTextures[a];f?f.push(n):this._tileTextures[a]=[n]}getTileTexture(n){const a=this._tileTextures[n];return a&&a.length>0?a.pop():null}isPatternMissing(n,a){return n===null||n!==void 0&&!this.imageManager.getPattern(n.toString(),a)}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(n,a,f){const _=f===void 0?this.terrain&&this.terrain.renderingToTexture:f,x=this.terrain&&this.terrain.exaggeration()===0,w=[];return this.style&&this.style.enable3dLights()&&(n==="globeRaster"||n==="terrainRaster"?(w.push("LIGHTING_3D_MODE"),w.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):_||w.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"?this._shadowMapDebug||w.push("DEPTH_TEXTURE"):this.shadowRenderer&&(this.shadowRenderer.useNormalOffset?w.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"):w.push("RENDER_SHADOWS","DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(w.push("TERRAIN"),this.linearFloatFilteringSupported()&&w.push("TERRAIN_DEM_FLOAT_FORMAT"),x&&w.push("ZERO_EXAGGERATION")),this.transform.projection.name==="globe"&&w.push("GLOBE"),!this._fogVisible||_||a!==void 0&&!a||w.push("FOG","FOG_DITHERING"),_&&w.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&w.push("OVERDRAW_INSPECTOR"),w}getOrCreateProgram(n,a){this.cache=this.cache||{};const f=a&&a.defines||[],_=a&&a.config,x=this.currentGlobalDefines(n,a&&a.overrideFog,a&&a.overrideRtt).concat(f),w=es.cacheKey(xs[n],n,x,_);return this.cache[w]||(this.cache[w]=new es(this.context,n,xs[n],_,Qh[n],x)),this.cache[w]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const n=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(n.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new r.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(n,a){if(this.style.enable3dLights()){const f=this.style.directionalLight,_=this.style.ambientLight;if(f&&_){const x=((w,S)=>{const C=w.properties.get("direction"),D=w.properties.get("color").toArray01(),z=w.properties.get("intensity"),O=S.properties.get("color").toArray01(),V=S.properties.get("intensity"),U=[C.x,C.y,C.z],H=r.cs(O,V),q=r.cs(D,z);return{u_lighting_ambient_color:H,u_lighting_directional_dir:U,u_lighting_directional_color:q,u_ground_radiance:vp(U,q,H)}})(f,_);a.setLightsUniformValues(n,x)}}}uploadCommonUniforms(n,a,f,_,x){if(this.uploadCommonLightUniforms(n,a),this.terrain&&this.terrain.renderingToTexture)return;const w=this.style.fog;if(w){const S=w.getOpacity(this.transform.pitch),C=((D,z,O,V,U,H,q,Z,$,K,oe,se)=>{const le=D.transform,Y=z.properties.get("color").toArray01();Y[3]=V;const ee=D.frameCounter/1e3%1,[me,fe]=z.properties.get("vertical-range");return{u_fog_matrix:O?le.calculateFogTileMatrix(O):se||D.identityMat,u_fog_range:z.getFovAdjustedRange(le._fov),u_fog_color:Y,u_fog_horizon_blend:z.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(me,fe),fe],u_fog_temporal_offset:ee,u_frustum_tl:U,u_frustum_tr:H,u_frustum_br:q,u_frustum_bl:Z,u_globe_pos:$,u_globe_radius:K,u_viewport:oe,u_globe_transition:r.W(le.zoom),u_is_globe:+(le.projection.name==="globe")}})(this,w,f,S,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*r.f.devicePixelRatio,this.transform.height*r.f.devicePixelRatio],_);a.setFogUniformValues(n,C)}x&&a.setCutoffUniformValues(n,x.uniformValues)}setTileLoadedFlag(n){this.tileLoaded=n}saveCanvasCopy(){const n=this.canvasCopy();n&&(this.frameCopies.push(n),this.tileLoaded=!1)}canvasCopy(){const n=this.context.gl,a=n.createTexture();return n.bindTexture(n.TEXTURE_2D,a),n.copyTexImage2D(n.TEXTURE_2D,0,n.RGBA,0,0,n.drawingBufferWidth,n.drawingBufferHeight,0),a}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const n=this.style&&this.style.fog;return!!n&&n.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const n=this._backgroundTiles,a=this._backgroundTiles={},f=this.transform.coveringTiles({tileSize:512});for(const _ of f)a[_.key]=n[_.key]||new ps(_,512,this.transform.tileZoom,this);return a}clearBackgroundTiles(){this._backgroundTiles={}}layerUsedInConflation(n,a){return!(!n.is3D()||n.minzoom&&n.minzoom>this.transform.zoom||n.sourceLayer!=="building"&&(!a||a.type!=="batched-model"))}isTileAffectedByFog(n){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let a=this._cachedTileFogOpacities[n.key];return a||(this._cachedTileFogOpacities[n.key]=a=this.style.fog.getOpacityForTile(n)),a[0]>=Li||a[1]>=Li}}function zp(d,n){let a=!1,f=null;const _=()=>{f=null,a&&(d(),f=setTimeout(_,n),a=!1)};return()=>(a=!0,f||_(),f)}class Tg{constructor(n){this._hashName=n&&encodeURIComponent(n),r.a$(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=zp(this._updateHashUnthrottled.bind(this),300)}addTo(n){return this._map=n,window.addEventListener("hashchange",this._onHashChange,!1),n.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const n=this._map;if(!n)return"";const a=Lp(n);if(this._hashName){const f=this._hashName;let _=!1;const x=location.hash.slice(1).split("&").map(w=>{const S=w.split("=")[0];return S===f?(_=!0,`${S}=${a}`):w}).filter(w=>w);return _||x.push(`${f}=${a}`),`#${x.join("&")}`}return`#${a}`}_getCurrentHash(){const n=location.hash.replace("#","");if(this._hashName){let a;return n.split("&").map(f=>f.split("=")).forEach(f=>{f[0]===this._hashName&&(a=f)}),(a&&a[1]||"").split("/")}return n.split("/")}_onHashChange(){const n=this._map;if(!n)return!1;const a=this._getCurrentHash();if(a.length>=3&&!a.some(f=>isNaN(f))){const f=n.dragRotate.isEnabled()&&n.touchZoomRotate.isEnabled()?+(a[3]||0):n.getBearing();return n.jumpTo({center:[+a[2],+a[1]],zoom:+a[0],bearing:f,pitch:+(a[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function Lp(d,n){const a=d.getCenter(),f=Math.round(100*d.getZoom())/100,_=Math.ceil((f*Math.LN2+Math.log(512/360/.5))/Math.LN10),x=Math.pow(10,_),w=Math.round(a.lng*x)/x,S=Math.round(a.lat*x)/x,C=d.getBearing(),D=d.getPitch();let z=n?`/${w}/${S}/${f}`:`${f}/${S}/${w}`;return(C||D)&&(z+="/"+Math.round(10*C)/10),D&&(z+=`/${Math.round(D)}`),z}const Pa={linearity:.3,easing:r.d6(0,0,.3,1)},ad=r.e({deceleration:2500,maxSpeed:1400},Pa),ld=r.e({deceleration:20,maxSpeed:1400},Pa),cd=r.e({deceleration:1e3,maxSpeed:360},Pa),Op=r.e({deceleration:1e3,maxSpeed:90},Pa);class Fp{constructor(n){this._map=n,this.clear()}clear(){this._inertiaBuffer=[]}record(n){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:r.f.now(),settings:n})}_drainInertiaBuffer(){const n=this._inertiaBuffer,a=r.f.now();for(;n.length>0&&a-n[0].time>160;)n.shift()}_onMoveEnd(n){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const a={zoom:0,bearing:0,pitch:0,pan:new r.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:x}of this._inertiaBuffer)a.zoom+=x.zoomDelta||0,a.bearing+=x.bearingDelta||0,a.pitch+=x.pitchDelta||0,x.panDelta&&a.pan._add(x.panDelta),x.around&&(a.around=x.around),x.pinchAround&&(a.pinchAround=x.pinchAround);const f=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,_={};if(a.pan.mag()){const x=bo(a.pan.mag(),f,r.e({},ad,n||{}));_.offset=a.pan.mult(x.amount/a.pan.mag()),_.center=this._map.transform.center,bu(_,x)}if(a.zoom){const x=bo(a.zoom,f,ld);_.zoom=this._map.transform.zoom+x.amount,bu(_,x)}if(a.bearing){const x=bo(a.bearing,f,cd);_.bearing=this._map.transform.bearing+r.ad(x.amount,-179,179),bu(_,x)}if(a.pitch){const x=bo(a.pitch,f,Op);_.pitch=this._map.transform.pitch+x.amount,bu(_,x)}if(_.zoom||_.bearing){const x=a.pinchAround===void 0?a.around:a.pinchAround;_.around=x?this._map.unproject(x):this._map.getCenter()}return this.clear(),_.noMoveStart=!0,_}}function bu(d,n){(!d.duration||d.duration<n.duration)&&(d.duration=n.duration,d.easing=n.easing)}function bo(d,n,a){const{maxSpeed:f,linearity:_,deceleration:x}=a,w=r.ad(d*_/(n/1e3),-f,f),S=Math.abs(w)/(x*_);return{easing:a.easing,duration:1e3*S,amount:w*(S/2)}}class _r extends r.b{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(n,a,f,_={}){const x=qe(a.getCanvasContainer(),f),w=a.unproject(x);super(n,r.e({point:x,lngLat:w,originalEvent:f},_)),this._defaultPrevented=!1,this.target=a}}class Wl extends r.b{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(n,a,f){const _=n==="touchend"?f.changedTouches:f.touches,x=Ve(a.getCanvasContainer(),_),w=x.map(C=>a.unproject(C)),S=x.reduce((C,D,z,O)=>C.add(D.div(O.length)),new r.P(0,0));super(n,{points:x,point:S,lngLats:w,lngLat:a.unproject(S),originalEvent:f}),this._defaultPrevented=!1}}class Xr extends r.b{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(n,a,f){super(n,{originalEvent:f}),this._defaultPrevented=!1}}class ud{constructor(n,a){this._map=n,this._clickTolerance=a.clickTolerance}reset(){this._mousedownPos=void 0}wheel(n){return this._firePreventable(new Xr(n.type,this._map,n))}mousedown(n,a){return this._mousedownPos=a,this._firePreventable(new _r(n.type,this._map,n))}mouseup(n){this._map.fire(new _r(n.type,this._map,n))}preclick(n){const a=r.e({},n);a.type="preclick",this._map.fire(new _r(a.type,this._map,a))}click(n,a){this._mousedownPos&&this._mousedownPos.dist(a)>=this._clickTolerance||(this.preclick(n),this._map.fire(new _r(n.type,this._map,n)))}dblclick(n){return this._firePreventable(new _r(n.type,this._map,n))}mouseover(n){this._map.fire(new _r(n.type,this._map,n))}mouseout(n){this._map.fire(new _r(n.type,this._map,n))}touchstart(n){return this._firePreventable(new Wl(n.type,this._map,n))}touchmove(n){this._map.fire(new Wl(n.type,this._map,n))}touchend(n){this._map.fire(new Wl(n.type,this._map,n))}touchcancel(n){this._map.fire(new Wl(n.type,this._map,n))}_firePreventable(n){if(this._map.fire(n),n.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class wu{constructor(n){this._map=n}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(n){this._map.fire(new _r(n.type,this._map,n))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new _r("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(n){this._delayContextMenu?this._contextMenuEvent=n:this._map.fire(new _r(n.type,this._map,n)),this._map.listens("contextmenu")&&n.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Tu{constructor(n,a){this._map=n,this._el=n.getCanvasContainer(),this._container=n.getContainer(),this._clickTolerance=a.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(n,a){this.isEnabled()&&n.shiftKey&&n.button===0&&(Te(),this._startPos=this._lastPos=a,this._active=!0)}mousemoveWindow(n,a){if(!this._active)return;const f=a,_=this._startPos,x=this._lastPos;if(!_||!x||x.equals(f)||!this._box&&f.dist(_)<this._clickTolerance)return;this._lastPos=f,this._box||(this._box=Q("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",n));const w=Math.min(_.x,f.x),S=Math.max(_.x,f.x),C=Math.min(_.y,f.y),D=Math.max(_.y,f.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${w}px,${C}px)`,this._box.style.width=S-w+"px",this._box.style.height=D-C+"px")})}mouseupWindow(n,a){if(!this._active)return;const f=this._startPos,_=a;if(f&&n.button===0){if(this.reset(),Ie(),f.x!==_.x||f.y!==_.y)return this._map.fire(new r.b("boxzoomend",{originalEvent:n})),{cameraAnimation:x=>x.fitScreenCoordinates(f,_,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",n)}}keydown(n){this._active&&n.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",n))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),Ee(),delete this._startPos,delete this._lastPos}_fireEvent(n,a){return this._map.fire(new r.b(n,{originalEvent:a}))}}function ql(d,n){const a={};for(let f=0;f<d.length;f++)a[d[f].identifier]=n[f];return a}class hd{constructor(n){this.reset(),this.numTouches=n.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(n,a,f){(this.centroid||f.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=n.timeStamp),f.length===this.numTouches&&(this.centroid=function(_){const x=new r.P(0,0);for(const w of _)x._add(w);return x.div(_.length)}(a),this.touches=ql(f,a)))}touchmove(n,a,f){if(this.aborted||!this.centroid)return;const _=ql(f,a);for(const x in this.touches){const w=_[x];(!w||w.dist(this.touches[x])>30)&&(this.aborted=!0)}}touchend(n,a,f){if((!this.centroid||n.timeStamp-this.startTime>500)&&(this.aborted=!0),f.length===0){const _=!this.aborted&&this.centroid;if(this.reset(),_)return _}}}class Da{constructor(n){this.singleTap=new hd(n),this.numTaps=n.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(n,a,f){this.singleTap.touchstart(n,a,f)}touchmove(n,a,f){this.singleTap.touchmove(n,a,f)}touchend(n,a,f){const _=this.singleTap.touchend(n,a,f);if(_){const x=n.timeStamp-this.lastTime<500,w=!this.lastTap||this.lastTap.dist(_)<30;if(x&&w||this.reset(),this.count++,this.lastTime=n.timeStamp,this.lastTap=_,this.count===this.numTaps)return this.reset(),_}}}class dd{constructor(){this._zoomIn=new Da({numTouches:1,numTaps:2}),this._zoomOut=new Da({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(n,a,f){this._zoomIn.touchstart(n,a,f),this._zoomOut.touchstart(n,a,f)}touchmove(n,a,f){this._zoomIn.touchmove(n,a,f),this._zoomOut.touchmove(n,a,f)}touchend(n,a,f){const _=this._zoomIn.touchend(n,a,f),x=this._zoomOut.touchend(n,a,f);return _?(this._active=!0,n.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:w=>w.easeTo({duration:300,zoom:w.getZoom()+1,around:w.unproject(_)},{originalEvent:n})}):x?(this._active=!0,n.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:w=>w.easeTo({duration:300,zoom:w.getZoom()-1,around:w.unproject(x)},{originalEvent:n})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const fd={0:1,2:2};class ka{constructor(n){this.reset(),this._clickTolerance=n.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(n,a){return!1}_move(n,a){return{}}mousedown(n,a){if(this._lastPoint)return;const f=nt(n);this._correctButton(n,f)&&(this._lastPoint=a,this._eventButton=f)}mousemoveWindow(n,a){const f=this._lastPoint;if(f){if(n.preventDefault(),this._eventButton!=null&&function(_,x){const w=fd[x];return _.buttons===void 0||(_.buttons&w)!==w}(n,this._eventButton))this.reset();else if(this._moved||!(a.dist(f)<this._clickTolerance))return this._moved=!0,this._lastPoint=a,this._move(f,a)}}mouseupWindow(n){this._lastPoint&&nt(n)===this._eventButton&&(this._moved&&Ie(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Bp extends ka{mousedown(n,a){super.mousedown(n,a),this._lastPoint&&(this._active=!0)}_correctButton(n,a){return a===0&&!n.ctrlKey}_move(n,a){return{around:a,panDelta:a.sub(n)}}}class pd extends ka{_correctButton(n,a){return a===0&&n.ctrlKey||a===2}_move(n,a){const f=.8*(a.x-n.x);if(f)return this._active=!0,{bearingDelta:f}}contextmenu(n){n.preventDefault()}}class Zo extends ka{_correctButton(n,a){return a===0&&n.ctrlKey||a===2}_move(n,a){const f=-.5*(a.y-n.y);if(f)return this._active=!0,{pitchDelta:f}}contextmenu(n){n.preventDefault()}}class Mg{constructor(n,a){this._map=n,this._el=n.getCanvasContainer(),this._minTouches=1,this._clickTolerance=a.clickTolerance||1,this.reset(),r.a$(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new r.P(0,0)}touchstart(n,a,f){return this._calculateTransform(n,a,f)}touchmove(n,a,f){if(this._active&&!(f.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(f.length===1&&!r.d7())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return n.cancelable&&n.preventDefault(),this._calculateTransform(n,a,f)}}touchend(n,a,f){this._calculateTransform(n,a,f),this._active&&f.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(n,a,f){f.length>0&&(this._active=!0);const _=ql(f,a),x=new r.P(0,0),w=new r.P(0,0);let S=0;for(const D in _){const z=_[D],O=this._touches[D];O&&(x._add(z),w._add(z.sub(O)),S++,_[D]=z)}if(this._touches=_,S<this._minTouches||!w.mag())return;const C=w.div(S);return this._sum._add(C),this._sum.mag()<this._clickTolerance?void 0:{around:x.div(S),panDelta:C}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=Q("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class md{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(n){}_move(n,a,f){return{}}touchstart(n,a,f){this._firstTwoTouches||f.length<2||(this._firstTwoTouches=[f[0].identifier,f[1].identifier],this._start([a[0],a[1]]))}touchmove(n,a,f){const _=this._firstTwoTouches;if(!_)return;n.preventDefault();const[x,w]=_,S=Mu(f,a,x),C=Mu(f,a,w);if(!S||!C)return;const D=this._aroundCenter?null:S.add(C).div(2);return this._move([S,C],D,n)}touchend(n,a,f){if(!this._firstTwoTouches)return;const[_,x]=this._firstTwoTouches,w=Mu(f,a,_),S=Mu(f,a,x);w&&S||(this._active&&Ie(),this.reset())}touchcancel(){this.reset()}enable(n){this._enabled=!0,this._aroundCenter=!!n&&n.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function Mu(d,n,a){for(let f=0;f<d.length;f++)if(d[f].identifier===a)return n[f]}function Np(d,n){return Math.log(d/n)/Math.LN2}class Sg extends md{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(n){this._startDistance=this._distance=n[0].dist(n[1])}_move(n,a){const f=this._distance;if(this._distance=n[0].dist(n[1]),this._active||!(Math.abs(Np(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:Np(this._distance,f),pinchAround:a}}}function Vp(d,n){return 180*d.angleWith(n)/Math.PI}class _d extends md{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(n){this._startVector=this._vector=n[0].sub(n[1]),this._minDiameter=n[0].dist(n[1])}_move(n,a){const f=this._vector;if(this._vector=n[0].sub(n[1]),f&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:Vp(this._vector,f),pinchAround:a}}_isBelowThreshold(n){this._minDiameter=Math.min(this._minDiameter,n.mag());const a=25/(Math.PI*this._minDiameter)*360,f=this._startVector;if(!f)return!1;const _=Vp(n,f);return Math.abs(_)<a}}function Hl(d){return Math.abs(d.y)>Math.abs(d.x)}class Up extends md{constructor(n){super(),this._map=n}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(n){this._lastPoints=n,Hl(n[0].sub(n[1]))&&(this._valid=!1)}_move(n,a,f){const _=this._lastPoints;if(!_)return;const x=n[0].sub(_[0]),w=n[1].sub(_[1]);return this._map._cooperativeGestures&&!r.d7()&&f.touches.length<3||(this._valid=this.gestureBeginsVertically(x,w,f.timeStamp),!this._valid)?void 0:(this._lastPoints=n,this._active=!0,{pitchDelta:(x.y+w.y)/2*-.5})}gestureBeginsVertically(n,a,f){if(this._valid!==void 0)return this._valid;const _=n.mag()>=2,x=a.mag()>=2;if(!_&&!x)return;if(!_||!x)return this._firstMove==null&&(this._firstMove=f),f-this._firstMove<100&&void 0;const w=n.y>0==a.y>0;return Hl(n)&&Hl(a)&&w}}const Ra={panStep:100,bearingStep:15,pitchStep:10};class jp{constructor(){const n=Ra;this._panStep=n.panStep,this._bearingStep=n.bearingStep,this._pitchStep=n.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(n){if(n.altKey||n.ctrlKey||n.metaKey)return;let a=0,f=0,_=0,x=0,w=0;switch(n.keyCode){case 61:case 107:case 171:case 187:a=1;break;case 189:case 109:case 173:a=-1;break;case 37:n.shiftKey?f=-1:(n.preventDefault(),x=-1);break;case 39:n.shiftKey?f=1:(n.preventDefault(),x=1);break;case 38:n.shiftKey?_=1:(n.preventDefault(),w=-1);break;case 40:n.shiftKey?_=-1:(n.preventDefault(),w=1);break;default:return}return this._rotationDisabled&&(f=0,_=0),{cameraAnimation:S=>{const C=S.getZoom();S.easeTo({duration:300,easeId:"keyboardHandler",easing:Gp,zoom:a?Math.round(C)+a*(n.shiftKey?2:1):C,bearing:S.getBearing()+f*this._bearingStep,pitch:S.getPitch()+_*this._pitchStep,offset:[-x*this._panStep,-w*this._panStep],center:S.getCenter()},{originalEvent:n})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function Gp(d){return d*(2-d)}const gd=4.000244140625,yd=1/450;class $o{constructor(n,a){this._map=n,this._el=n.getCanvasContainer(),this._handler=a,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=yd,r.a$(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(n){this._defaultZoomRate=n}setWheelZoomRate(n){this._wheelZoomRate=n}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(n){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!n&&n.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(n){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(n.ctrlKey||n.metaKey||this.isZooming()||r.d7()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let a=n.deltaMode===WheelEvent.DOM_DELTA_LINE?40*n.deltaY:n.deltaY;const f=r.f.now(),_=f-(this._lastWheelEventTime||0);this._lastWheelEventTime=f,a!==0&&a%gd==0?this._type="wheel":a!==0&&Math.abs(a)<4?this._type="trackpad":_>400?(this._type=null,this._lastValue=a,this._timeout=setTimeout(this._onTimeout,40,n)):this._type||(this._type=Math.abs(_*a)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,a+=this._lastValue)),n.shiftKey&&a&&(a/=4),this._type&&(this._lastWheelEvent=n,this._delta-=a,this._active||this._start(n)),n.preventDefault()}_onTimeout(n){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(n)}_start(n){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const a=qe(this._el,n);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:a,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const n=this._map.transform;this._type==="wheel"&&n.projection.wrap&&(n._center.lng>=180||n._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const a=()=>n._terrainEnabled()&&this._aroundCoord?n.computeZoomRelativeTo(this._aroundCoord):n.zoom;if(this._delta!==0){const D=this._type==="wheel"&&Math.abs(this._delta)>gd?this._wheelZoomRate:this._defaultZoomRate;let z=2/(1+Math.exp(-Math.abs(this._delta*D)));this._delta<0&&z!==0&&(z=1/z);const O=a(),V=Math.pow(2,O),U=typeof this._targetZoom=="number"?n.zoomScale(this._targetZoom):V;this._targetZoom=Math.min(n.maxZoom,Math.max(n.minZoom,n.scaleZoom(U*z))),this._type==="wheel"&&(this._startZoom=O,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const f=typeof this._targetZoom=="number"?this._targetZoom:a(),_=this._startZoom,x=this._easing;let w,S=!1;if(this._type==="wheel"&&_&&x){const D=Math.min((r.f.now()-this._lastWheelEventTime)/200,1),z=x(D);w=r.X(_,f,z),D<1?this._frameId||(this._frameId=!0):S=!0}else w=f,S=!0;this._active=!0,S&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let C=w-a();return C*this._lastDelta<0&&(C=0),{noInertia:!0,needsRenderFrame:!S,zoomDelta:C,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(n){let a=r.d8;if(this._prevEase){const f=this._prevEase,_=(r.f.now()-f.start)/f.duration,x=f.easing(_+.01)-f.easing(_),w=.27/Math.sqrt(x*x+1e-4)*.01,S=Math.sqrt(.0729-w*w);a=r.d6(w,S,.25,1)}return this._prevEase={start:r.f.now(),duration:n,easing:a},a}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=Q("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class Wp{constructor(n,a){this._clickZoom=n,this._tapZoom=a}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Yo{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(n,a){return n.preventDefault(),{cameraAnimation:f=>{f.easeTo({duration:300,zoom:f.getZoom()+(n.shiftKey?-1:1),around:f.unproject(a)},{originalEvent:n})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class qp{constructor(){this._tap=new Da({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(n,a,f){this._swipePoint||(this._tapTime&&n.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?f.length>0&&(this._swipePoint=a[0],this._swipeTouch=f[0].identifier):this._tap.touchstart(n,a,f))}touchmove(n,a,f){if(this._tapTime){if(this._swipePoint){if(f[0].identifier!==this._swipeTouch)return;const _=a[0],x=_.y-this._swipePoint.y;return this._swipePoint=_,n.preventDefault(),this._active=!0,{zoomDelta:x/128}}}else this._tap.touchmove(n,a,f)}touchend(n,a,f){this._tapTime?this._swipePoint&&f.length===0&&this.reset():this._tap.touchend(n,a,f)&&(this._tapTime=n.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Su{constructor(n,a,f){this._el=n,this._mousePan=a,this._touchPan=f}enable(n){this._inertiaOptions=n||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Hp{constructor(n,a,f){this._pitchWithRotate=n.pitchWithRotate,this._mouseRotate=a,this._mousePitch=f}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class Zp{constructor(n,a,f,_){this._el=n,this._touchZoom=a,this._touchRotate=f,this._tapDragZoom=_,this._rotationDisabled=!1,this._enabled=!0}enable(n){this._touchZoom.enable(n),this._rotationDisabled||this._touchRotate.enable(n),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const za=d=>d.zoom||d.drag||d.pitch||d.rotate;class xd extends r.b{}class Eg{constructor(){this.constants=[1,1,.01],this.radius=0}setup(n,a){const f=r.Q.sub([],a,n);this.radius=r.Q.length(f[2]<0?r.Q.div([],f,this.constants):[f[0],f[1],0])}projectRay(n){r.Q.div(n,n,this.constants),r.Q.normalize(n,n),r.Q.mul(n,n,this.constants);const a=r.Q.scale([],n,this.radius);if(a[2]>0){const f=r.Q.scale([],[0,0,1],r.Q.dot(a,[0,0,1])),_=r.Q.scale([],r.Q.normalize([],[a[0],a[1],0]),this.radius),x=r.Q.add([],a,r.Q.scale([],r.Q.sub([],r.Q.add([],_,f),a),2));a[0]=x[0],a[1]=x[1]}return a}}function Zl(d){return d.panDelta&&d.panDelta.mag()||d.zoomDelta||d.bearingDelta||d.pitchDelta}class $l{constructor(n,a){this._map=n,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new Fp(n),this._bearingSnap=a.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Eg,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(a),r.a$(["handleEvent","handleWindowEvent"],this);const f=this._el;this._listeners=[[f,"touchstart",{passive:!0}],[f,"touchmove",{passive:!1}],[f,"touchend",void 0],[f,"touchcancel",void 0],[f,"mousedown",void 0],[f,"mousemove",void 0],[f,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[f,"mouseover",void 0],[f,"mouseout",void 0],[f,"dblclick",void 0],[f,"click",void 0],[f,"keydown",{capture:!1}],[f,"keyup",void 0],[f,"wheel",{passive:!1}],[f,"contextmenu",void 0],[window,"blur",void 0]];for(const[_,x,w]of this._listeners){const S=_===document?this.handleWindowEvent:this.handleEvent;_.addEventListener(x,S,w)}}destroy(){for(const[n,a,f]of this._listeners){const _=n===document?this.handleWindowEvent:this.handleEvent;n.removeEventListener(a,_,f)}}_addDefaultHandlers(n){const a=this._map,f=a.getCanvasContainer();this._add("mapEvent",new ud(a,n));const _=a.boxZoom=new Tu(a,n);this._add("boxZoom",_);const x=new dd,w=new Yo;a.doubleClickZoom=new Wp(w,x),this._add("tapZoom",x),this._add("clickZoom",w);const S=new qp;this._add("tapDragZoom",S);const C=a.touchPitch=new Up(a);this._add("touchPitch",C);const D=new pd(n),z=new Zo(n);a.dragRotate=new Hp(n,D,z),this._add("mouseRotate",D,["mousePitch"]),this._add("mousePitch",z,["mouseRotate"]);const O=new Bp(n),V=new Mg(a,n);a.dragPan=new Su(f,O,V),this._add("mousePan",O),this._add("touchPan",V,["touchZoom","touchRotate"]);const U=new _d,H=new Sg;a.touchZoomRotate=new Zp(f,H,U,S),this._add("touchRotate",U,["touchPan","touchZoom"]),this._add("touchZoom",H,["touchPan","touchRotate"]),this._add("blockableMapEvent",new wu(a));const q=a.scrollZoom=new $o(a,this);this._add("scrollZoom",q,["mousePan"]);const Z=a.keyboard=new jp;this._add("keyboard",Z);for(const $ of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])n.interactive&&n[$]&&a[$].enable(n[$])}_add(n,a,f){this._handlers.push({handlerName:n,handler:a,allowed:f}),this._handlersById[n]=a}stop(n){if(!this._updatingCamera){for(const{handler:a}of this._handlers)a.reset();this._inertia.clear(),this._fireEvents({},{},n),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:n}of this._handlers)if(n.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!za(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(n,a,f){for(const _ in n)if(_!==f&&(!a||a.indexOf(_)<0))return!0;return!1}handleWindowEvent(n){this.handleEvent(n,`${n.type}Window`)}_getMapTouches(n){const a=[];for(const f of n)this._el.contains(f.target)&&a.push(f);return a}handleEvent(n,a){this._updatingCamera=!0;const f=n.type==="renderFrame",_=f?void 0:n,x={needsRenderFrame:!1},w={},S={},C=n.touches?this._getMapTouches(n.touches):void 0,D=C?Ve(this._el,C):f?void 0:qe(this._el,n);for(const{handlerName:V,handler:U,allowed:H}of this._handlers){if(!U.isEnabled())continue;let q;this._blockedByActive(S,H,V)?U.reset():U[a||n.type]&&(q=U[a||n.type](n,D,C),this.mergeHandlerResult(x,w,q,V,_),q&&q.needsRenderFrame&&this._triggerRenderFrame()),(q||U.isActive())&&(S[V]=U)}const z={};for(const V in this._previousActiveHandlers)S[V]||(z[V]=_);this._previousActiveHandlers=S,(Object.keys(z).length||Zl(x))&&(this._changes.push([x,w,z]),this._triggerRenderFrame()),(Object.keys(S).length||Zl(x))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:O}=x;O&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],O(this._map))}mergeHandlerResult(n,a,f,_,x){if(!f)return;r.e(n,f);const w={handlerName:_,originalEvent:f.originalEvent||x};f.zoomDelta!==void 0&&(a.zoom=w),f.panDelta!==void 0&&(a.drag=w),f.pitchDelta!==void 0&&(a.pitch=w),f.bearingDelta!==void 0&&(a.rotate=w)}_applyChanges(){const n={},a={},f={};for(const[_,x,w]of this._changes)_.panDelta&&(n.panDelta=(n.panDelta||new r.P(0,0))._add(_.panDelta)),_.zoomDelta&&(n.zoomDelta=(n.zoomDelta||0)+_.zoomDelta),_.bearingDelta&&(n.bearingDelta=(n.bearingDelta||0)+_.bearingDelta),_.pitchDelta&&(n.pitchDelta=(n.pitchDelta||0)+_.pitchDelta),_.around!==void 0&&(n.around=_.around),_.aroundCoord!==void 0&&(n.aroundCoord=_.aroundCoord),_.pinchAround!==void 0&&(n.pinchAround=_.pinchAround),_.noInertia&&(n.noInertia=_.noInertia),r.e(a,x),r.e(f,w);this._updateMapTransform(n,a,f),this._changes=[]}_updateMapTransform(n,a,f){const _=this._map,x=_.transform,w=K=>[K.x,K.y,K.z];if((K=>{const oe=this._eventsInProgress.drag;return oe&&!this._handlersById[oe.handlerName].isActive()})()&&!Zl(n)){const K=x.zoom;x.cameraElevationReference="sea",this._originalZoom!=null&&x._orthographicProjectionAtLowPitch&&x.projection.name!=="globe"&&x.pitch===0?(x.cameraElevationReference="ground",x.zoom=this._originalZoom):(x.recenterOnTerrain(),x.cameraElevationReference="ground"),K!==x.zoom&&this._map._update(!0)}if(x._isCameraConstrained&&_._stop(!0),!Zl(n))return void this._fireEvents(a,f,!0);let{panDelta:S,zoomDelta:C,bearingDelta:D,pitchDelta:z,around:O,aroundCoord:V,pinchAround:U}=n;x._isCameraConstrained&&(C>0&&(C=0),x._isCameraConstrained=!1),U!==void 0&&(O=U),(C||(K=>a[K]&&!this._eventsInProgress[K])("drag"))&&O&&(this._dragOrigin=w(x.pointCoordinate3D(O)),this._originalZoom=x.zoom,this._trackingEllipsoid.setup(x._camera.position,this._dragOrigin)),x.cameraElevationReference="sea",_._stop(!0),O=O||_.transform.centerPoint,D&&(x.bearing+=D),z&&(x.pitch+=z),x._updateCameraState();const H=[0,0,0];if(S)if(x.projection.name==="mercator"){const K=this._trackingEllipsoid.projectRay(x.screenPointToMercatorRay(O).dir),oe=this._trackingEllipsoid.projectRay(x.screenPointToMercatorRay(O.sub(S)).dir);H[0]=oe[0]-K[0],H[1]=oe[1]-K[1]}else{const K=x.pointCoordinate(O);if(x.projection.name==="globe"){S=S.rotate(-x.angle);const oe=x._pixelsPerMercatorPixel/x.worldSize;H[0]=-S.x*r.d9(r.ax(K.y))*oe,H[1]=-S.y*r.d9(x.center.lat)*oe}else{const oe=x.pointCoordinate(O.sub(S));K&&oe&&(H[0]=oe.x-K.x,H[1]=oe.y-K.y)}}const q=x.zoom,Z=[0,0,0];if(C){const K=w(V||x.pointCoordinate3D(O)),oe={dir:r.Q.normalize([],r.Q.sub([],K,x._camera.position))};if(oe.dir[2]<0){const se=x.zoomDeltaToMovement(K,C);r.Q.scale(Z,oe.dir,se)}}const $=r.Q.add(H,H,Z);x._translateCameraConstrained($),C&&Math.abs(x.zoom-q)>1e-4&&x.recenterOnTerrain(),x.cameraElevationReference="ground",this._map._update(),n.noInertia||this._inertia.record(n),this._fireEvents(a,f,!0)}_fireEvents(n,a,f){const _=za(this._eventsInProgress),x=za(n),w={};for(const z in n){const{originalEvent:O}=n[z];this._eventsInProgress[z]||(w[`${z}start`]=O),this._eventsInProgress[z]=n[z]}!_&&x&&this._fireEvent("movestart",x.originalEvent);for(const z in w)this._fireEvent(z,w[z]);x&&this._fireEvent("move",x.originalEvent);for(const z in n){const{originalEvent:O}=n[z];this._fireEvent(z,O)}const S={};let C;for(const z in this._eventsInProgress){const{handlerName:O,originalEvent:V}=this._eventsInProgress[z];this._handlersById[O].isActive()||(delete this._eventsInProgress[z],C=a[O]||V,S[`${z}end`]=C)}for(const z in S)this._fireEvent(z,S[z]);const D=za(this._eventsInProgress);if(f&&(_||x)&&!D){this._updatingCamera=!0;const z=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),O=V=>V!==0&&-this._bearingSnap<V&&V<this._bearingSnap;z?(O(z.bearing||this._map.getBearing())&&(z.bearing=0),this._map.easeTo(z,{originalEvent:C})):(this._map.fire(new r.b("moveend",{originalEvent:C})),O(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(n,a){this._map.fire(new r.b(n,a?{originalEvent:a}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(n=>{this._frameId=void 0,this.handleEvent(new xd("renderFrame",{timeStamp:n})),this._applyChanges()})}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const $p="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Ag extends r.E{constructor(n,a){super(),this._moving=!1,this._zooming=!1,this.transform=n,this._bearingSnap=a.bearingSnap,this._respectPrefersReducedMotion=a.respectPrefersReducedMotion!==!1,r.a$(["_renderFrameCallback"],this)}getCenter(){return new r.bq(this.transform.center.lng,this.transform.center.lat)}setCenter(n,a){return this.jumpTo({center:n},a)}panBy(n,a,f){return n=r.P.convert(n).mult(-1),this.panTo(this.transform.center,r.e({offset:n},a),f)}panTo(n,a,f){return this.easeTo(r.e({center:n},a),f)}getZoom(){return this.transform.zoom}setZoom(n,a){return this.jumpTo({zoom:n},a),this}zoomTo(n,a,f){return this.easeTo(r.e({zoom:n},a),f)}zoomIn(n,a){return this.zoomTo(this.getZoom()+1,n,a),this}zoomOut(n,a){return this.zoomTo(this.getZoom()-1,n,a),this}getBearing(){return this.transform.bearing}setBearing(n,a){return this.jumpTo({bearing:n},a),this}getPadding(){return this.transform.padding}setPadding(n,a){return this.jumpTo({padding:n},a),this}rotateTo(n,a,f){return this.easeTo(r.e({bearing:n},a),f)}resetNorth(n,a){return this.rotateTo(0,r.e({duration:1e3},n),a),this}resetNorthPitch(n,a){return this.easeTo(r.e({bearing:0,pitch:0,duration:1e3},n),a),this}snapToNorth(n,a){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(n,a):this}getPitch(){return this.transform.pitch}setPitch(n,a){return this.jumpTo({pitch:n},a),this}cameraForBounds(n,a){n=r.ag.convert(n);const f=a&&a.bearing||0,_=a&&a.pitch||0,x=n.getNorthWest(),w=n.getSouthEast();return this._cameraForBounds(this.transform,x,w,f,_,a)}_extendPadding(n){const a={top:0,right:0,bottom:0,left:0};return n==null?r.e({},a,this.transform.padding):typeof n=="number"?{top:n,bottom:n,right:n,left:n}:r.e({},a,n)}_extendCameraOptions(n){return(n=r.e({offset:[0,0],maxZoom:this.transform.maxZoom},n)).padding=this._extendPadding(n.padding),n}_minimumAABBFrustumDistance(n,a){const f=a.max[0]-a.min[0],_=a.max[1]-a.min[1];return f/_>n.aspect?f/(2*Math.tan(.5*n.fovX)*n.aspect):_/(2*Math.tan(.5*n.fovY)*n.aspect)}_cameraForBoundsOnGlobe(n,a,f,_,x,w){const S=n.clone(),C=this._extendCameraOptions(w);S.bearing=_,S.pitch=x;const D=r.bq.convert(a),z=r.bq.convert(f),O=.5*(D.lat+z.lat),V=.5*(D.lng+z.lng),U=r.da(O,V),H=r.Q.normalize([],U),q=r.Q.normalize([],r.Q.cross([],H,[0,1,0])),Z=r.Q.cross([],q,H),$=[q[0],q[1],q[2],0,Z[0],Z[1],Z[2],0,H[0],H[1],H[2],0,0,0,0,1],K=[U,r.da(D.lat,D.lng),r.da(z.lat,D.lng),r.da(z.lat,z.lng),r.da(D.lat,z.lng),r.da(O,D.lng),r.da(O,z.lng),r.da(D.lat,V),r.da(z.lat,V)];let oe=r.bV.fromPoints(K.map(Re=>[r.Q.dot(q,Re),r.Q.dot(Z,Re),r.Q.dot(H,Re)]));const se=r.Q.transformMat4([],oe.center,$);r.Q.squaredLength(se)===0&&r.Q.set(se,0,0,1),r.Q.normalize(se,se),r.Q.scale(se,se,r.ae),S.center=r.db(se);const le=S.getWorldToCameraMatrix(),Y=r.a9.invert(new Float64Array(16),le);oe=r.bV.applyTransform(oe,r.a9.multiply([],le,$));const ee=this._extendAABB(oe,S,C,_);if(!ee)return void r.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");oe=ee,r.Q.transformMat4(se,se,le);const me=.5*(oe.max[2]-oe.min[2]),fe=this._minimumAABBFrustumDistance(S,oe),xe=r.Q.scale([],[0,0,1],me),ke=r.Q.add(xe,se,xe),ye=fe+(S.pitch===0?0:r.Q.distance(se,ke)),Pe=S.globeCenterInViewSpace,ze=r.Q.sub([],se,[Pe[0],Pe[1],Pe[2]]);r.Q.normalize(ze,ze),r.Q.scale(ze,ze,ye);const ge=r.Q.add([],se,ze);r.Q.transformMat4(ge,ge,Y);const Ae=r.dc/r.ae,Ye=r.Q.length(ge),we=r.bo(Math.max(Ye*Ae-r.dc,Number.EPSILON),0),De=Math.min(S.zoomFromMercatorZAdjusted(we),C.maxZoom);return De>.5*(r.bJ+r.bA)?(S.setProjection({name:"mercator"}),S.zoom=De,this._cameraForBounds(S,a,f,_,x,w)):{center:S.center,zoom:De,bearing:_,pitch:x}}_extendAABB(n,a,f,_){const x=.5*((f.padding.left||0)+(f.padding.right||0)),w=.5*((f.padding.top||0)+(f.padding.bottom||0)),S=w,C=x,D=x,z=w,O=a.width-(C+D),V=a.height-(S+z),U=r.Q.sub([],n.max,n.min),H=Math.min(O/U[0],V/U[1]),q=Math.min(a.scaleZoom(a.scale*H),f.maxZoom);if(isNaN(q))return null;const Z=a.scale/a.zoomScale(q),$=new r.bV([n.min[0]-C*Z,n.min[1]-z*Z,n.min[2]],[n.max[0]+D*Z,n.max[1]+S*Z,n.max[2]]),K=(typeof f.offset.x=="number"&&typeof f.offset.y=="number"?new r.P(f.offset.x,f.offset.y):r.P.convert(f.offset)).rotate(-r.bm(_));return $.center[0]-=K.x*Z,$.center[1]+=K.y*Z,$}queryTerrainElevation(n,a){const f=this.transform.elevation;return f?(a=r.e({},{exaggerated:!0},a),f.getAtPoint(r.O.fromLngLat(n),null,a.exaggerated)):null}_cameraForBounds(n,a,f,_,x,w){if(n.projection.name==="globe")return this._cameraForBoundsOnGlobe(n,a,f,_,x,w);const S=n.clone(),C=this._extendCameraOptions(w);S.bearing=_,S.pitch=x;const D=r.bq.convert(a),z=r.bq.convert(f),O=new r.bq(D.lng,z.lat),V=new r.bq(z.lng,D.lat),U=S.project(D),H=S.project(z),q=this.queryTerrainElevation(D),Z=this.queryTerrainElevation(z),$=this.queryTerrainElevation(O),K=this.queryTerrainElevation(V),oe=[[U.x,U.y,Math.min(q||0,Z||0,$||0,K||0)],[H.x,H.y,Math.max(q||0,Z||0,$||0,K||0)]];let se=r.bV.fromPoints(oe);const le=S.getWorldToCameraMatrix(),Y=r.a9.invert(new Float64Array(16),le);se=r.bV.applyTransform(se,le);const ee=this._extendAABB(se,S,C,_);if(!ee)return void r.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");se=ee;const me=.5*r.Q.sub([],se.max,se.min)[2],fe=this._minimumAABBFrustumDistance(S,se),xe=[0,0,1,0];r.aa.transformMat4(xe,xe,le),r.aa.normalize(xe,xe);const ke=r.Q.scale([],xe,fe+me),ye=r.Q.add([],se.center,ke);r.Q.transformMat4(se.center,se.center,Y),r.Q.transformMat4(ye,ye,Y);const Pe=[se.center[0],se.center[1],ye[2]*S.pixelsPerMeter];r.Q.scale(Pe,Pe,1/S.worldSize);const ze=r.aw(Pe[0]),ge=r.ax(Pe[1]),Ae=Math.min(S._zoomFromMercatorZ(Pe[2]),C.maxZoom),Ye=new r.bq(ze,ge);return S.mercatorFromTransition&&Ae<.5*(r.bJ+r.bA)?(S.setProjection({name:"globe"}),S.zoom=Ae,this._cameraForBounds(S,a,f,_,x,w)):{center:Ye,zoom:Ae,bearing:_,pitch:x}}fitBounds(n,a,f){const _=this.cameraForBounds(n,a);return this._fitInternal(_,a,f)}fitScreenCoordinates(n,a,f,_,x){const w=r.P.convert(n),S=r.P.convert(a),C=new r.P(Math.min(w.x,S.x),Math.min(w.y,S.y)),D=new r.P(Math.max(w.x,S.x),Math.max(w.y,S.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(w,S))return this;const z=this.transform.pointLocation3D(C),O=this.transform.pointLocation3D(D),V=this.transform.pointLocation3D(new r.P(C.x,D.y)),U=this.transform.pointLocation3D(new r.P(D.x,C.y)),H=[Math.min(z.lng,O.lng,V.lng,U.lng),Math.min(z.lat,O.lat,V.lat,U.lat)],q=[Math.max(z.lng,O.lng,V.lng,U.lng),Math.max(z.lat,O.lat,V.lat,U.lat)],Z=_&&_.pitch?_.pitch:this.getPitch(),$=this._cameraForBounds(this.transform,H,q,f,Z,_);return this._fitInternal($,_,x)}_fitInternal(n,a,f){return n?(a=r.e(n,a)).linear?this.easeTo(a,f):this.flyTo(a,f):this}jumpTo(n,a){this.stop();const f=n.preloadOnly?this.transform.clone():this.transform;let _=!1,x=!1,w=!1;return"zoom"in n&&f.zoom!==+n.zoom&&(_=!0,f.zoom=+n.zoom),n.center!==void 0&&(f.center=r.bq.convert(n.center)),"bearing"in n&&f.bearing!==+n.bearing&&(x=!0,f.bearing=+n.bearing),"pitch"in n&&f.pitch!==+n.pitch&&(w=!0,f.pitch=+n.pitch),n.padding==null||f.isPaddingEqual(n.padding)||(f.padding=n.padding),n.preloadOnly?(this._preloadTiles(f),this):(this.fire(new r.b("movestart",a)).fire(new r.b("move",a)),_&&this.fire(new r.b("zoomstart",a)).fire(new r.b("zoom",a)).fire(new r.b("zoomend",a)),x&&this.fire(new r.b("rotatestart",a)).fire(new r.b("rotate",a)).fire(new r.b("rotateend",a)),w&&this.fire(new r.b("pitchstart",a)).fire(new r.b("pitch",a)).fire(new r.b("pitchend",a)),this.fire(new r.b("moveend",a)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||r.w($p),this.transform.getFreeCameraOptions()}setFreeCameraOptions(n,a){const f=this.transform;if(!f.projection.supportsFreeCamera)return r.w($p),this;this.stop();const _=f.zoom,x=f.pitch,w=f.bearing;f.setFreeCameraOptions(n);const S=_!==f.zoom,C=x!==f.pitch,D=w!==f.bearing;return this.fire(new r.b("movestart",a)).fire(new r.b("move",a)),S&&this.fire(new r.b("zoomstart",a)).fire(new r.b("zoom",a)).fire(new r.b("zoomend",a)),D&&this.fire(new r.b("rotatestart",a)).fire(new r.b("rotate",a)).fire(new r.b("rotateend",a)),C&&this.fire(new r.b("pitchstart",a)).fire(new r.b("pitch",a)).fire(new r.b("pitchend",a)),this.fire(new r.b("moveend",a)),this}easeTo(n,a){this._stop(!1,n.easeId),((n=r.e({offset:[0,0],duration:500,easing:r.d8},n)).animate===!1||this._prefersReducedMotion(n))&&(n.duration=0);const f=this.transform,_=this.getZoom(),x=this.getBearing(),w=this.getPitch(),S=this.getPadding(),C="zoom"in n?+n.zoom:_,D="bearing"in n?this._normalizeBearing(n.bearing,x):x,z="pitch"in n?+n.pitch:w,O=this._extendPadding(n.padding),V=r.P.convert(n.offset);let U,H,q;if(f.projection.name==="globe"){const fe=r.O.fromLngLat(f.center),xe=V.rotate(-f.angle);fe.x+=xe.x/f.worldSize,fe.y+=xe.y/f.worldSize;const ke=fe.toLngLat(),ye=r.bq.convert(n.center||ke);this._normalizeCenter(ye),U=f.centerPoint.add(xe),H=new r.P(fe.x,fe.y).mult(f.worldSize),q=new r.P(r.a8(ye.lng),r.ah(ye.lat)).mult(f.worldSize).sub(H)}else{U=f.centerPoint.add(V);const fe=f.pointLocation(U),xe=r.bq.convert(n.center||fe);this._normalizeCenter(xe),H=f.project(fe),q=f.project(xe).sub(H)}const Z=f.zoomScale(C-_);let $,K;n.around&&($=r.bq.convert(n.around),K=f.locationPoint($));const oe=this._zooming||C!==_,se=this._rotating||x!==D,le=this._pitching||z!==w,Y=!f.isPaddingEqual(O),ee=fe=>xe=>{if(oe&&(fe.zoom=r.X(_,C,xe)),se&&(fe.bearing=r.X(x,D,xe)),le&&(fe.pitch=r.X(w,z,xe)),Y&&(fe.interpolatePadding(S,O,xe),U=fe.centerPoint.add(V)),$)fe.setLocationAtPoint($,K);else{const ke=fe.zoomScale(fe.zoom-_),ye=C>_?Math.min(2,Z):Math.max(.5,Z),Pe=Math.pow(ye,1-xe),ze=fe.unproject(H.add(q.mult(xe*Pe)).mult(ke));fe.setLocationAtPoint(fe.renderWorldCopies?ze.wrap():ze,U)}return n.preloadOnly||this._fireMoveEvents(a),fe};if(n.preloadOnly){const fe=this._emulate(ee,n.duration,f);return this._preloadTiles(fe),this}const me={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=oe,this._rotating=se,this._pitching=le,this._padding=Y,this._easeId=n.easeId,this._prepareEase(a,n.noMoveStart,me),this._ease(ee(f),fe=>{f.cameraElevationReference==="sea"&&f.recenterOnTerrain(),this._afterEase(a,fe)},n),this}_prepareEase(n,a,f={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),a||f.moving||this.fire(new r.b("movestart",n)),this._zooming&&!f.zooming&&this.fire(new r.b("zoomstart",n)),this._rotating&&!f.rotating&&this.fire(new r.b("rotatestart",n)),this._pitching&&!f.pitching&&this.fire(new r.b("pitchstart",n))}_fireMoveEvents(n){this.fire(new r.b("move",n)),this._zooming&&this.fire(new r.b("zoom",n)),this._rotating&&this.fire(new r.b("rotate",n)),this._pitching&&this.fire(new r.b("pitch",n))}_afterEase(n,a){if(this._easeId&&a&&this._easeId===a)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const f=this._zooming,_=this._rotating,x=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,f&&this.fire(new r.b("zoomend",n)),_&&this.fire(new r.b("rotateend",n)),x&&this.fire(new r.b("pitchend",n)),this.fire(new r.b("moveend",n))}flyTo(n,a){if(this._prefersReducedMotion(n)){const De=r.af(n,["center","zoom","bearing","pitch","around"]);return this.jumpTo(De,a)}this.stop(),n=r.e({offset:[0,0],speed:1.2,curve:1.42,easing:r.d8},n);const f=this.transform,_=this.getZoom(),x=this.getBearing(),w=this.getPitch(),S=this.getPadding(),C="zoom"in n?r.ad(+n.zoom,f.minZoom,f.maxZoom):_,D="bearing"in n?this._normalizeBearing(n.bearing,x):x,z="pitch"in n?+n.pitch:w,O=this._extendPadding(n.padding),V=f.zoomScale(C-_),U=r.P.convert(n.offset);let H=f.centerPoint.add(U);const q=f.pointLocation(H),Z=r.bq.convert(n.center||q);this._normalizeCenter(Z);const $=f.project(q),K=f.project(Z).sub($);let oe=n.curve;const se=Math.max(f.width,f.height),le=se/V,Y=K.mag();if("minZoom"in n){const De=r.ad(Math.min(n.minZoom,_,C),f.minZoom,f.maxZoom),Re=se/f.zoomScale(De-_);oe=Math.sqrt(Re/Y*2)}const ee=oe*oe;function me(De){const Re=(le*le-se*se+(De?-1:1)*ee*ee*Y*Y)/(2*(De?le:se)*ee*Y);return Math.log(Math.sqrt(Re*Re+1)-Re)}function fe(De){return(Math.exp(De)-Math.exp(-De))/2}function xe(De){return(Math.exp(De)+Math.exp(-De))/2}const ke=me(0);let ye=function(De){return xe(ke)/xe(ke+oe*De)},Pe=function(De){return se*((xe(ke)*(fe(Re=ke+oe*De)/xe(Re))-fe(ke))/ee)/Y;var Re},ze=(me(1)-ke)/oe;if(Math.abs(Y)<1e-6||!isFinite(ze)){if(Math.abs(se-le)<1e-6)return this.easeTo(n,a);const De=le<se?-1:1;ze=Math.abs(Math.log(le/se))/oe,Pe=function(){return 0},ye=function(Re){return Math.exp(De*oe*Re)}}n.duration="duration"in n?+n.duration:1e3*ze/("screenSpeed"in n?+n.screenSpeed/oe:+n.speed),n.maxDuration&&n.duration>n.maxDuration&&(n.duration=0);const ge=x!==D,Ae=z!==w,Ye=!f.isPaddingEqual(O),we=De=>Re=>{const ae=Re*ze,Ue=1/ye(ae);De.zoom=Re===1?C:_+De.scaleZoom(Ue),ge&&(De.bearing=r.X(x,D,Re)),Ae&&(De.pitch=r.X(w,z,Re)),Ye&&(De.interpolatePadding(S,O,Re),H=De.centerPoint.add(U));const gt=Re===1?Z:De.unproject($.add(K.mult(Pe(ae))).mult(Ue));return De.setLocationAtPoint(De.renderWorldCopies?gt.wrap():gt,H),De._updateCameraOnTerrain(),n.preloadOnly||this._fireMoveEvents(a),De};if(n.preloadOnly){const De=this._emulate(we,n.duration,f);return this._preloadTiles(De),this}return this._zooming=!0,this._rotating=ge,this._pitching=Ae,this._padding=Ye,this._prepareEase(a,!1),this._ease(we(f),()=>this._afterEase(a),n),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(n){}_cancelRenderFrame(n){}_stop(n,a){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const f=this._onEaseEnd;this._onEaseEnd=void 0,f.call(this,a)}if(!n){const f=this.handlers;f&&f.stop(!1)}return this}_ease(n,a,f){f.animate===!1||f.duration===0?(n(1),a()):(this._easeStart=r.f.now(),this._easeOptions=f,this._onEaseFrame=n,this._onEaseEnd=a,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const n=Math.min((r.f.now()-this._easeStart)/this._easeOptions.duration,1),a=this._onEaseFrame;a&&a(this._easeOptions.easing(n)),n<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(n,a){n=r.bk(n,-180,180);const f=Math.abs(n-a);return Math.abs(n-360-a)<f&&(n-=360),Math.abs(n+360-a)<f&&(n+=360),n}_normalizeCenter(n){const a=this.transform;if(a.maxBounds||a.projection.name!=="globe"&&!a.renderWorldCopies)return;const f=n.lng-a.center.lng;n.lng+=f>180?-360:f<-180?360:0}_prefersReducedMotion(n){return this._respectPrefersReducedMotion&&r.f.prefersReducedMotion&&!(n&&n.essential)}_emulate(n,a,f){const _=Math.ceil(15*a/1e3),x=[],w=n(f.clone());for(let S=0;S<=_;S++){const C=w(S/_);x.push(C.clone())}return x}_preloadTiles(n,a){}}class vd{constructor(n={}){this.options=n,r.a$(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(n){const a=this.options&&this.options.compact;return this._map=n,this._container=Q("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=Q("button","mapboxgl-ctrl-attrib-button",this._container),Q("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden","true"),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=Q("div","mapboxgl-ctrl-attrib-inner",this._container),a&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),a===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_setElementTitle(n,a){const f=this._map._getUIString(`AttributionControl.${a}`);n.removeAttribute("title"),n.firstElementChild&&n.firstElementChild.setAttribute("title",f)}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let n=this._editLink;n||(n=this._editLink=this._container.querySelector(".mapbox-improve-map"));const a=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||r.dd.ACCESS_TOKEN}];if(n){const f=a.reduce((_,x,w)=>(x.value&&(_+=`${x.key}=${x.value}${w<a.length-1?"&":""}`),_),"?");n.href=`${r.dd.FEEDBACK_URL}/${f}#${Lp(this._map,!0)}`,n.rel="noopener nofollow",this._setElementTitle(n,"MapFeedback")}}_updateData(n){!n||n.sourceDataType!=="metadata"&&n.sourceDataType!=="visibility"&&n.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let n=[];if(this._map.style.stylesheet){const _=this._map.style.stylesheet;this.styleOwner=_.owner,this.styleId=_.id}const a=this._map.style._mergedSourceCaches;for(const _ in a){const x=a[_];if(x.used){const w=x.getSource();w.attribution&&n.indexOf(w.attribution)<0&&n.push(w.attribution)}}n.sort((_,x)=>_.length-x.length),n=n.filter((_,x)=>{for(let w=x+1;w<n.length;w++)if(n[w].indexOf(_)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?n=[...this.options.customAttribution,...n]:n.unshift(this.options.customAttribution));const f=n.join(" | ");f!==this._attribHTML&&(this._attribHTML=f,n.length?(this._innerContainer.innerHTML=f,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Yp{constructor(){r.a$(["_updateLogo","_updateCompact"],this)}onAdd(n){this._map=n,this._container=Q("div","mapboxgl-ctrl");const a=Q("a","mapboxgl-ctrl-logo");return a.target="_blank",a.rel="noopener nofollow",a.href="https://www.mapbox.com/",a.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),a.setAttribute("rel","noopener nofollow"),this._container.appendChild(a),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(n){n&&n.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const n=this._map.style._sourceCaches;if(Object.entries(n).length===0)return!0;for(const a in n){const f=n[a].getSource();if(f.hasOwnProperty("mapbox_logo")&&!f.mapbox_logo)return!1}return!0}_updateCompact(){const n=this._container.children;if(n.length){const a=n[0];this._map.getCanvasContainer().offsetWidth<250?a.classList.add("mapboxgl-compact"):a.classList.remove("mapboxgl-compact")}}}class Eu{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(n){const a=++this._id;return this._queue.push({callback:n,id:a,cancelled:!1}),a}remove(n){const a=this._currentlyRunning,f=a?this._queue.concat(a):this._queue;for(const _ of f)if(_.id===n)return void(_.cancelled=!0)}run(n=0){const a=this._currentlyRunning=this._queue;this._queue=[];for(const f of a)if(!f.cancelled&&(f.callback(n),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}function Au(d,n,a){if(d=new r.bq(d.lng,d.lat),n){const f=new r.bq(d.lng-360,d.lat),_=new r.bq(d.lng+360,d.lat),x=360*Math.ceil(Math.abs(d.lng-a.center.lng)/360),w=a.locationPoint(d).distSqr(n),S=n.x<0||n.y<0||n.x>a.width||n.y>a.height;a.locationPoint(f).distSqr(n)<w&&(S||Math.abs(f.lng-a.center.lng)<x)?d=f:a.locationPoint(_).distSqr(n)<w&&(S||Math.abs(_.lng-a.center.lng)<x)&&(d=_)}for(;Math.abs(d.lng-a.center.lng)>180;){const f=a.locationPoint(d);if(f.x>=0&&f.y>=0&&f.x<=a.width&&f.y<=a.height)break;d.lng>a.center.lng?d.lng-=360:d.lng+=360}return d}const La={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class Yl extends r.E{constructor(n,a){if(super(),(n instanceof HTMLElement||a)&&(n=r.e({element:n},a)),r.a$(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=n&&n.anchor||"center",this._color=n&&n.color||"#3FB1CE",this._scale=n&&n.scale||1,this._draggable=n&&n.draggable||!1,this._clickTolerance=n&&n.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=n&&n.rotation||0,this._rotationAlignment=n&&n.rotationAlignment||"auto",this._pitchAlignment=n&&n.pitchAlignment&&n.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=n&&n.occludedOpacity||.2,n&&n.element)this._element=n.element,this._offset=r.P.convert(n&&n.offset||[0,0]);else{this._defaultMarker=!0,this._element=Q("div");const x=41,w=27,S=te("svg",{display:"block",height:x*this._scale+"px",width:w*this._scale+"px",viewBox:`0 0 ${w} ${x}`},this._element),C=te("radialGradient",{id:"shadowGradient"},te("defs",{},S));te("stop",{offset:"10%","stop-opacity":.4},C),te("stop",{offset:"100%","stop-opacity":.05},C),te("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},S),te("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},S),te("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},S),te("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},S),this._offset=r.P.convert(n&&n.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",x=>{x.preventDefault()}),this._element.addEventListener("mousedown",x=>{x.preventDefault()});const f=this._element.classList;for(const x in La)f.remove(`mapboxgl-marker-anchor-${x}`);f.add(`mapboxgl-marker-anchor-${this._anchor}`);const _=n&&n.className?n.className.trim().split(/\s+/):[];f.add(..._),this._popup=null}addTo(n){return n===this._map||(this.remove(),this._map=n,n.getCanvasContainer().appendChild(this._element),n.on("move",this._updateMoving),n.on("moveend",this._update),n.on("remove",this._clearFadeTimer),n._addMarker(this),this.setDraggable(this._draggable),this._update(),n.on("click",this._onMapClick)),this}remove(){const n=this._map;return n&&(n.off("click",this._onMapClick),n.off("move",this._updateMoving),n.off("moveend",this._update),n.off("mousedown",this._addDragHandler),n.off("touchstart",this._addDragHandler),n.off("mouseup",this._onUp),n.off("touchend",this._onUp),n.off("mousemove",this._onMove),n.off("touchmove",this._onMove),n.off("remove",this._clearFadeTimer),n._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(n){return this._lngLat=r.bq.convert(n),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(n){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),n){if(!("offset"in n.options)){const _=Math.sqrt(Math.pow(13.5,2)/2);n.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[_,-1*(38.1-13.5+_)],"bottom-right":[-_,-1*(38.1-13.5+_)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=n,n._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(n){const a=n.code,f=n.charCode||n.keyCode;a!=="Space"&&a!=="Enter"&&f!==32&&f!==13||this.togglePopup()}_onMapClick(n){const a=n.originalEvent.target,f=this._element;this._popup&&(a===f||f.contains(a))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const n=this._popup;return n?(n.isOpen()?(n.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(n.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const n=this._map,a=this._pos;if(!n||!a)return!1;const f=n.unproject(a),_=n.getFreeCameraOptions();if(!_.position)return!1;const x=_.position.toLngLat();return x.distanceTo(f)<.9*x.distanceTo(this._lngLat)}_evaluateOpacity(){const n=this._map;if(!n)return;const a=this._pos;if(!a||a.x<0||a.x>n.transform.width||a.y<0||a.y>n.transform.height)return void this._clearFadeTimer();const f=n.unproject(a);let _;n._showingGlobe()&&r.de(n.transform,this._lngLat)?_=0:(_=1-n._queryFogOpacity(f),n.transform._terrainEnabled()&&n.getTerrain()&&this._behindTerrain()&&(_*=this._occludedOpacity)),this._element.style.opacity=`${_}`,this._element.style.pointerEvents=_>0?"auto":"none",this._popup&&this._popup._setOpacity(_),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const n=this._pos;if(!n||!this._map)return;const a=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${n.x}px,${n.y}px)
            ${La[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${a.x}px,${a.y}px)
        `}_calculateXYTransform(){const n=this._pos,a=this._map,f=this.getPitchAlignment();if(!a||!n||f!=="map")return"";if(!a._showingGlobe()){const C=a.getPitch();return C?`rotateX(${C}deg)`:""}const _=r.bI(r.df(a.transform,this._lngLat)),x=n.sub(r.dg(a.transform)),w=Math.abs(x.x)+Math.abs(x.y);if(w===0)return"";const S=_/w;return`rotateX(${-x.y*S}deg) rotateY(${x.x*S}deg)`}_calculateZTransform(){const n=this._pos,a=this._map;if(!a||!n)return"";let f=0;const _=this.getRotationAlignment();if(_==="map")if(a._showingGlobe()){const x=a.project(new r.bq(this._lngLat.lng,this._lngLat.lat+.001)),w=a.project(new r.bq(this._lngLat.lng,this._lngLat.lat-.001)).sub(x);f=r.bI(Math.atan2(w.y,w.x))-90}else f=-a.getBearing();else if(_==="horizon"){const x=r.S(4,6,a.getZoom()),w=r.dg(a.transform);w.y+=x*a.transform.height;const S=n.sub(w),C=r.bI(Math.atan2(S.y,S.x));f=(C>90?C-270:C+90)*(1-x)}return f+=this._rotation,f?`rotateZ(${f}deg)`:""}_update(n){cancelAnimationFrame(this._updateFrameId);const a=this._map;a&&(a.transform.renderWorldCopies&&(this._lngLat=Au(this._lngLat,this._pos,a.transform)),this._pos=a.project(this._lngLat),n===!0?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),a._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(a._showingGlobe()||a.getTerrain()||a.getFog())&&!this._fadeTimer&&(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(n){return this._offset=r.P.convert(n),this._update(),this}addClassName(n){return this._element.classList.add(n),this}removeClassName(n){return this._element.classList.remove(n),this}toggleClassName(n){return this._element.classList.toggle(n)}_onMove(n){const a=this._map;if(!a)return;const f=this._pointerdownPos,_=this._positionDelta;if(f&&_){if(!this._isDragging){const x=this._clickTolerance||a._clickTolerance;if(n.point.dist(f)<x)return;this._isDragging=!0}this._pos=n.point.sub(_),this._lngLat=a.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new r.b("dragstart"))),this.fire(new r.b("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const n=this._map;n&&(n.off("mousemove",this._onMove),n.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new r.b("dragend")),this._state="inactive"}_addDragHandler(n){const a=this._map,f=this._pos;a&&f&&this._element.contains(n.originalEvent.target)&&(n.preventDefault(),this._positionDelta=n.point.sub(f),this._pointerdownPos=n.point,this._state="pending",a.on("mousemove",this._onMove),a.on("touchmove",this._onMove),a.once("mouseup",this._onUp),a.once("touchend",this._onUp))}setDraggable(n){this._draggable=!!n;const a=this._map;return a&&(n?(a.on("mousedown",this._addDragHandler),a.on("touchstart",this._addDragHandler)):(a.off("mousedown",this._addDragHandler),a.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(n){return this._rotation=n||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(n){return this._rotationAlignment=n||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(n){return this._pitchAlignment=n||"auto",this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(n){return this._occludedOpacity=n||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const Ql={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},Qp=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Xl(d=new r.P(0,0),n="bottom"){if(typeof d=="number"){const a=Math.round(Math.sqrt(.5*Math.pow(d,2)));switch(n){case"top":return new r.P(0,d);case"top-left":return new r.P(a,a);case"top-right":return new r.P(-a,a);case"bottom":return new r.P(0,-d);case"bottom-left":return new r.P(a,-a);case"bottom-right":return new r.P(-a,-a);case"left":return new r.P(d,0);case"right":return new r.P(-d,0)}return new r.P(0,0)}return d instanceof r.P||Array.isArray(d)?r.P.convert(d):r.P.convert(d[n]||[0,0])}class Iu{constructor(n){this.jumpTo(n)}getValue(n){if(n<=this._startTime)return this._start;if(n>=this._endTime)return this._end;const a=r.ch((n-this._startTime)/(this._endTime-this._startTime));return this._start*(1-a)+this._end*a}isEasing(n){return n>=this._startTime&&n<=this._endTime}jumpTo(n){this._startTime=-1/0,this._endTime=-1/0,this._start=n,this._end=n}easeTo(n,a,f){this._start=this.getValue(a),this._end=n,this._startTime=a,this._endTime=a+f}}class Xp{registerParameter(n,a,f,_,x){}registerButton(n,a,f){}registerBinding(n,a,f,_){}refreshUI(){}}const wo={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use  + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},Ls={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1},Oa={showCompass:!0,showZoom:!0,visualizePitch:!1};class Cu{constructor(n,a,f=!1){this._clickTolerance=10,this.element=a,this.mouseRotate=new pd({clickTolerance:n.dragRotate._mouseRotate._clickTolerance}),this.map=n,f&&(this.mousePitch=new Zo({clickTolerance:n.dragRotate._mousePitch._clickTolerance})),r.a$(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),a.addEventListener("mousedown",this.mousedown),a.addEventListener("touchstart",this.touchstart,{passive:!1}),a.addEventListener("touchmove",this.touchmove),a.addEventListener("touchend",this.touchend),a.addEventListener("touchcancel",this.reset)}down(n,a){this.mouseRotate.mousedown(n,a),this.mousePitch&&this.mousePitch.mousedown(n,a),Te()}move(n,a){const f=this.map,_=this.mouseRotate.mousemoveWindow(n,a),x=_&&_.bearingDelta;if(x&&f.setBearing(f.getBearing()+x),this.mousePitch){const w=this.mousePitch.mousemoveWindow(n,a),S=w&&w.pitchDelta;S&&f.setPitch(f.getPitch()+S)}}off(){const n=this.element;n.removeEventListener("mousedown",this.mousedown),n.removeEventListener("touchstart",this.touchstart,{passive:!1}),n.removeEventListener("touchmove",this.touchmove),n.removeEventListener("touchend",this.touchend),n.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){Ee(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(n){this.down(r.e({},n,{ctrlKey:!0,preventDefault:()=>n.preventDefault()}),qe(this.element,n)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(n){this.move(n,qe(this.element,n))}mouseup(n){this.mouseRotate.mouseupWindow(n),this.mousePitch&&this.mousePitch.mouseupWindow(n),this.offTemp()}touchstart(n){n.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=Ve(this.element,n.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>n.preventDefault()},this._startPos))}touchmove(n){n.targetTouches.length!==1?this.reset():(this._lastPos=Ve(this.element,n.targetTouches)[0],this.move({preventDefault:()=>n.preventDefault()},this._lastPos))}touchend(n){n.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}const Mt={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},Kp={maxWidth:100,unit:"metric"},Jp={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"};return{version:r.du,supported:F,setRTLTextPlugin:r.dw,getRTLTextPluginStatus:r.dx,Map:class extends Ag{constructor(d){const n=d;if((d=r.e({},Ls,d)).minZoom!=null&&d.maxZoom!=null&&d.minZoom>d.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(d.minPitch!=null&&d.maxPitch!=null&&d.minPitch>d.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(d.minPitch!=null&&d.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(d.maxPitch!=null&&d.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(d.antialias&&r.dh(window)&&(d.antialias=!1,r.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Kc(d.minZoom,d.maxZoom,d.minPitch,d.maxPitch,d.renderWorldCopies),d),this._repaint=!!d.repaint,this._interactive=d.interactive,this._minTileCacheSize=d.minTileCacheSize,this._maxTileCacheSize=d.maxTileCacheSize,this._failIfMajorPerformanceCaveat=d.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=d.preserveDrawingBuffer,this._antialias=d.antialias,this._trackResize=d.trackResize,this._bearingSnap=d.bearingSnap,this._refreshExpiredTiles=d.refreshExpiredTiles,this._fadeDuration=d.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=d.crossSourceCollisions,this._collectResourceTiming=d.collectResourceTiming,this._language=this._parseLanguage(d.language),this._worldview=d.worldview,this._renderTaskQueue=new Eu,this._domRenderTaskQueue=new Eu,this._controls=[],this._markers=[],this._popups=[],this._mapId=r.aF(),this._locale=r.e({},wo,d.locale),this._clickTolerance=d.clickTolerance,this._cooperativeGestures=d.cooperativeGestures,this._performanceMetricsCollection=d.performanceMetricsCollection,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new Iu(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._requestManager=new r.di(d.transformRequest,d.accessToken,d.testMode),this._silenceAuthErrors=!!d.testMode,this._contextCreateOptions=d.contextCreateOptions?{...d.contextCreateOptions}:{},typeof d.container=="string"){const a=document.getElementById(d.container);if(!a)throw new Error(`Container '${d.container.toString()}' not found.`);this._container=a}else{if(!(d.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=d.container}if(this._container.childNodes.length>0&&r.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),d.maxBounds&&this.setMaxBounds(d.maxBounds),r.a$(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp=d.devtools?new Xp(this):new Xp,this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new $l(this,d),this._localFontFamily=d.localFontFamily,this._localIdeographFontFamily=d.localIdeographFontFamily,(d.style||!d.testMode)&&this.setStyle(d.style||r.dd.DEFAULT_STYLE,{config:d.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),d.projection&&this.setProjection(d.projection),d.hash&&(this._hash=new Tg(typeof d.hash=="string"&&d.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){n.center==null&&n.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:d.center,zoom:d.zoom,bearing:d.bearing,pitch:d.pitch});const a=d.bounds;a&&(this.resize(),this.fitBounds(a,r.e({},d.fitBoundsOptions,{duration:0})))}this.resize(),d.attributionControl&&this.addControl(new vd({customAttribution:d.customAttribution})),this._logoControl=new Yp,this.addControl(this._logoControl,d.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()}),this.on("data",a=>{this._update(a.dataType==="style"),this.fire(new r.b(`${a.dataType}data`,a))}),this.on("dataloading",a=>{this.fire(new r.b(`${a.dataType}dataloading`,a))})}_getMapId(){return this._mapId}addControl(d,n){if(n===void 0&&(n=d.getDefaultPosition?d.getDefaultPosition():"top-right"),!d||!d.onAdd)return this.fire(new r.a(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const a=d.onAdd(this);this._controls.push(d);const f=this._controlPositions[n];return n.indexOf("bottom")!==-1?f.insertBefore(a,f.firstChild):f.appendChild(a),this}removeControl(d){if(!d||!d.onRemove)return this.fire(new r.a(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const n=this._controls.indexOf(d);return n>-1&&this._controls.splice(n,1),d.onRemove(this),this}hasControl(d){return this._controls.indexOf(d)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(d){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const n=!this._moving;return n&&this.fire(new r.b("movestart",d)).fire(new r.b("move",d)),this.fire(new r.b("resize",d)),n&&this.fire(new r.b("moveend",d)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(d){return this.transform.setMaxBounds(r.ag.convert(d)),this._update()}setMinZoom(d){if((d=d??-2)>=-2&&d<=this.transform.maxZoom)return this.transform.minZoom=d,this._update(),this.getZoom()<d?this.setZoom(d):this.fire(new r.b("zoomstart")).fire(new r.b("zoom")).fire(new r.b("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(d){if((d=d??22)>=this.transform.minZoom)return this.transform.maxZoom=d,this._update(),this.getZoom()>d?this.setZoom(d):this.fire(new r.b("zoomstart")).fire(new r.b("zoom")).fire(new r.b("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(d){if((d=d??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(d>=0&&d<=this.transform.maxPitch)return this.transform.minPitch=d,this._update(),this.getPitch()<d?this.setPitch(d):this.fire(new r.b("pitchstart")).fire(new r.b("pitch")).fire(new r.b("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(d){if((d=d??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(d>=this.transform.minPitch)return this.transform.maxPitch=d,this._update(),this.getPitch()>d?this.setPitch(d):this.fire(new r.b("pitchstart")).fire(new r.b("pitch")).fire(new r.b("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(d){return this.transform.renderWorldCopies=d,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(d){return d==="auto"?navigator.language:Array.isArray(d)?d.length===0?void 0:d.map(n=>n==="auto"?navigator.language:n):d}setLanguage(d){const n=this._parseLanguage(d);if(!this.style||n===this._language)return this;this._language=n,this.style.reloadSources();for(const a of this._controls)a._setLanguage&&a._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(d){return this.style&&d!==this._worldview?(this._worldview=d,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(d){return this._lazyInitEmptyStyle(),d?typeof d=="string"&&(d={name:d}):d=null,this._useExplicitProjection=!!d,this._prioritizeAndUpdateProjection(d,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const d=this.transform,n=d.projection.name;let a;n==="globe"&&d.zoom>=r.bA?(d.setMercatorFromTransition(),a=!0):n==="mercator"&&d.zoom<r.bA&&(d.setProjection({name:"globe"}),a=!0),a&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(d,n){return this._updateProjection(d||n||{name:"mercator"})}_updateProjection(d){let n;return n=d.name==="globe"&&this.transform.zoom>=r.bA?this.transform.setMercatorFromTransition():this.transform.setProjection(d),this.style.applyProjectionUpdate(),n&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(d){return this.transform.locationPoint3D(r.bq.convert(d))}unproject(d){return this.transform.pointLocation3D(r.P.convert(d))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(d,n,a){if(d==="mouseenter"||d==="mouseover"){let f=!1;const _=w=>{const S=n.filter(D=>this.getLayer(D)),C=S.length?this.queryRenderedFeatures(w.point,{layers:S}):[];C.length?f||(f=!0,a.call(this,new _r(d,this,w.originalEvent,{features:C}))):f=!1},x=()=>{f=!1};return{layers:new Set(n),listener:a,delegates:{mousemove:_,mouseout:x}}}if(d==="mouseleave"||d==="mouseout"){let f=!1;const _=w=>{const S=n.filter(C=>this.getLayer(C));(S.length?this.queryRenderedFeatures(w.point,{layers:S}):[]).length?f=!0:f&&(f=!1,a.call(this,new _r(d,this,w.originalEvent)))},x=w=>{f&&(f=!1,a.call(this,new _r(d,this,w.originalEvent)))};return{layers:new Set(n),listener:a,delegates:{mousemove:_,mouseout:x}}}{const f=_=>{const x=n.filter(S=>this.getLayer(S)),w=x.length?this.queryRenderedFeatures(_.point,{layers:x}):[];w.length&&(_.features=w,a.call(this,_),delete _.features)};return{layers:new Set(n),listener:a,delegates:{[d]:f}}}}on(d,n,a){if(a===void 0)return super.on(d,n);if(Array.isArray(n)||(n=[n]),n){for(const _ of n)if(!this._isValidId(_))return this}const f=this._createDelegatedListener(d,n,a);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[d]=this._delegatedListeners[d]||[],this._delegatedListeners[d].push(f);for(const _ in f.delegates)this.on(_,f.delegates[_]);return this}once(d,n,a){if(a===void 0)return super.once(d,n);if(Array.isArray(n)||(n=[n]),n){for(const _ of n)if(!this._isValidId(_))return this}const f=this._createDelegatedListener(d,n,a);for(const _ in f.delegates)this.once(_,f.delegates[_]);return this}off(d,n,a){if(a===void 0)return super.off(d,n);n=new Set(Array.isArray(n)?n:[n]);for(const x of n)if(!this._isValidId(x))return this;const f=(x,w)=>{if(x.size!==w.size)return!1;for(const S of x)if(!w.has(S))return!1;return!0},_=this._delegatedListeners?this._delegatedListeners[d]:void 0;return _&&(x=>{for(let w=0;w<x.length;w++){const S=x[w];if(S.listener===a&&f(S.layers,n)){for(const C in S.delegates)this.off(C,S.delegates[C]);return x.splice(w,1),this}}})(_),this}queryRenderedFeatures(d,n){if(!this.style)return[];if(n!==void 0||d===void 0||d instanceof r.P||Array.isArray(d)||(n=d,d=void 0),d=d||[[0,0],[this.transform.width,this.transform.height]],(n=n||{}).layers&&Array.isArray(n.layers)){for(const a of n.layers)if(!this._isValidId(a))return[]}return this.style.queryRenderedFeatures(d,n,this.transform)}querySourceFeatures(d,n){return this._isValidId(d)?this.style.querySourceFeatures(d,n):[]}isPointOnSurface(d){const{name:n}=this.transform.projection;return n!=="globe"&&n!=="mercator"&&r.w(`${n} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(r.P.convert(d))}setStyle(d,n){return n=r.e({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},n),this.style&&d&&n.diff!==!1&&n.localFontFamily===this._localFontFamily&&n.localIdeographFontFamily===this._localIdeographFontFamily&&!n.config?(this.style._diffStyle(d,(a,f)=>{a?(r.w(`Unable to perform style diff: ${String(a.message||a.error||a)}. Rebuilding the style from scratch.`),this._updateStyle(d,n)):f&&this._update(!0)},()=>{this._postStyleLoadEvent()}),this):(this._localIdeographFontFamily=n.localIdeographFontFamily,this._localFontFamily=n.localFontFamily,this._updateStyle(d,n))}_getUIString(d){const n=this._locale[d];if(n==null)throw new Error(`Missing UI string '${d}'`);return n}_updateStyle(d,n){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),d){const a=r.e({},n);n&&n.config&&(a.initialConfig=n.config,delete a.config),this.style=new ys(this,a).setEventedParent(this,{style:this.style}).load(d)}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new ys(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(r.w("There is no style added to the map."),!1)}_isValidId(d){return d==null?(this.fire(new r.a(new Error("IDs can't be empty."))),!1):!r.c9(d)||(this.fire(new r.a(new Error(`IDs can't contain special symbols: "${d}".`))),!1)}addSource(d,n){return this._isValidId(d)?(this._lazyInitEmptyStyle(),this.style.addSource(d,n),this._update(!0)):this}isSourceLoaded(d){return!!this._isValidId(d)&&!!this.style&&this.style._isSourceCacheLoaded(d)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(d,n,a){this._lazyInitEmptyStyle(),this.style.addSourceType(d,n,a)}removeSource(d){return this._isValidId(d)?(this.style.removeSource(d),this._updateTerrain(),this._update(!0)):this}getSource(d){return this._isValidId(d)?this.style.getOwnSource(d):null}addImage(d,n,{pixelRatio:a=1,sdf:f=!1,stretchX:_,stretchY:x,content:w}={}){if(this._lazyInitEmptyStyle(),n instanceof HTMLImageElement||ImageBitmap&&n instanceof ImageBitmap){const{width:S,height:C,data:D}=r.f.getImageData(n);this.style.addImage(d,{data:new r.h({width:S,height:C},D),pixelRatio:a,stretchX:_,stretchY:x,content:w,sdf:f,version:0})}else if(n.width===void 0||n.height===void 0)this.fire(new r.a(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:S,height:C}=n,D=n;this.style.addImage(d,{data:new r.h({width:S,height:C},new Uint8Array(D.data)),pixelRatio:a,stretchX:_,stretchY:x,content:w,sdf:f,version:0,userImage:D}),D.onAdd&&D.onAdd(this,d)}}updateImage(d,n){this._lazyInitEmptyStyle();const a=this.style.getImage(d);if(!a)return void this.fire(new r.a(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const f=n instanceof HTMLImageElement||ImageBitmap&&n instanceof ImageBitmap?r.f.getImageData(n):n,{width:_,height:x}=f,w=f.data;if(_===void 0||x===void 0)return void this.fire(new r.a(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(_!==a.data.width||x!==a.data.height)return void this.fire(new r.a(new Error(`The width and height of the updated image (${_}, ${x})
                must be that same as the previous version of the image
                (${a.data.width}, ${a.data.height})`)));const S=!(n instanceof HTMLImageElement||ImageBitmap&&n instanceof ImageBitmap);a.data.replace(w,S),this.style.updateImage(d,a)}hasImage(d){return d?!!this.style&&!!this.style.getImage(d):(this.fire(new r.a(new Error("Missing required image id"))),!1)}removeImage(d){this.style.removeImage(d)}loadImage(d,n){r.d(this._requestManager.transformRequest(d,r.R.Image),(a,f)=>{n(a,f instanceof HTMLImageElement?r.f.getImageData(f):f)})}listImages(){return this.style.listImages()}addModel(d,n){this._lazyInitEmptyStyle(),this.style.addModel(d,n)}hasModel(d){return d?this.style.hasModel(d):(this.fire(new r.a(new Error("Missing required model id"))),!1)}removeModel(d){this.style.removeModel(d)}listModels(){return this.style.listModels()}addLayer(d,n){return this._isValidId(d.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(d,n),this._update(!0)):this}getSlot(d){const n=this.getLayer(d);return n&&n.slot||null}setSlot(d,n){return this.style.setSlot(d,n),this.style.mergeLayers(),this._update(!0)}addImport(d,n){return this.style.addImport(d,n),this}updateImport(d,n){return typeof n!="string"&&n.id!==d?(this.removeImport(d),this.addImport(n)):(this.style.updateImport(d,n),this._update(!0))}removeImport(d){return this.style.removeImport(d),this}moveImport(d,n){return this.style.moveImport(d,n),this._update(!0)}moveLayer(d,n){return this._isValidId(d)?(this.style.moveLayer(d,n),this._update(!0)):this}removeLayer(d){return this._isValidId(d)?(this.style.removeLayer(d),this._update(!0)):this}getLayer(d){return this._isValidId(d)?this.style.getOwnLayer(d):null}setLayerZoomRange(d,n,a){return this._isValidId(d)?(this.style.setLayerZoomRange(d,n,a),this._update(!0)):this}setFilter(d,n,a={}){return this._isValidId(d)?(this.style.setFilter(d,n,a),this._update(!0)):this}getFilter(d){return this._isValidId(d)?this.style.getFilter(d):null}setPaintProperty(d,n,a,f={}){return this._isValidId(d)?(this.style.setPaintProperty(d,n,a,f),this._update(!0)):this}getPaintProperty(d,n){return this._isValidId(d)?this.style.getPaintProperty(d,n):null}setLayoutProperty(d,n,a,f={}){return this._isValidId(d)?(this.style.setLayoutProperty(d,n,a,f),this._update(!0)):this}getLayoutProperty(d,n){return this._isValidId(d)?this.style.getLayoutProperty(d,n):null}getSchema(d){return this.style.getSchema(d)}setSchema(d,n){return this.style.setSchema(d,n),this._update(!0)}getConfig(d){return this.style.getConfig(d)}setConfig(d,n){return this.style.setConfig(d,n),this._update(!0)}getConfigProperty(d,n){return this.style.getConfigProperty(d,n)}setConfigProperty(d,n,a){return this.style.setConfigProperty(d,n,a),this._update(!0)}setLights(d){if(this._lazyInitEmptyStyle(),d&&d.length===1&&d[0].type==="flat"){const n=d[0];n.properties?this.style.setFlatLight(n.properties,n.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(d),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const d=this.style.getLights()||[];return d.length===0&&d.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),d}setLight(d,n={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:d}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(d){return this._lazyInitEmptyStyle(),!d&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(d),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(d){return this._lazyInitEmptyStyle(),this.style.setFog(d),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setCamera(d){return this.style.setCamera(d),this._triggerCameraUpdate(d)}_triggerCameraUpdate(d){return this._update(this.transform.setOrthographicProjectionAtLowPitch(d["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(d){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(r.bq.convert(d),this.transform):0}setFeatureState(d,n){return this._isValidId(d.source)?(this.style.setFeatureState(d,n),this._update()):this}removeFeatureState(d,n){return this._isValidId(d.source)?(this.style.removeFeatureState(d,n),this._update()):this}getFeatureState(d){return this._isValidId(d.source)?this.style.getFeatureState(d):null}_updateContainerDimensions(){if(!this._container)return;const d=this._container.getBoundingClientRect().width||400,n=this._container.getBoundingClientRect().height||300;let a,f,_,x=this._container;for(;x&&(!f||!_);){const w=window.getComputedStyle(x).transform;w&&w!=="none"&&(a=w.match(/matrix.*\((.+)\)/)[1].split(", "),a[0]&&a[0]!=="0"&&a[0]!=="1"&&(f=a[0]),a[3]&&a[3]!=="0"&&a[3]!=="1"&&(_=a[3])),x=x.parentElement}this._containerWidth=f?Math.abs(d/f):d,this._containerHeight=_?Math.abs(n/_):n}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&r.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const d=this._container;d.classList.add("mapboxgl-map"),(this._missingCSSCanary=Q("div","mapboxgl-canary",d)).style.visibility="hidden",this._detectMissingCSS();const n=this._canvasContainer=Q("div","mapboxgl-canvas-container",d);this._canvas=Q("canvas","mapboxgl-canvas",n),this._interactive&&(n.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const a=this._controlContainer=Q("div","mapboxgl-control-container",d),f=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(_=>{f[_]=Q("div",`mapboxgl-ctrl-${_}`,a)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(d,n){const a=r.f.devicePixelRatio||1;this._canvas.width=a*Math.ceil(d),this._canvas.height=a*Math.ceil(n),this._canvas.style.width=`${d}px`,this._canvas.style.height=`${n}px`}_addMarker(d){this._markers.push(d)}_removeMarker(d){const n=this._markers.indexOf(d);n!==-1&&this._markers.splice(n,1)}_addPopup(d){this._popups.push(d)}_removePopup(d){const n=this._popups.indexOf(d);n!==-1&&this._popups.splice(n,1)}_setupPainter(){const d=r.e({},F.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),n=this._canvas.getContext("webgl2",d);n?(r.dj(n,!0),this.painter=new Rp(n,this._contextCreateOptions,this.transform,this._tp),this.on("data",a=>{a.dataType==="source"&&this.painter.setTileLoadedFlag(!0)}),r.dk.testSupport(n)):this.fire(new r.a(new Error("Failed to initialize WebGL")))}_contextLost(d){d.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new r.b("webglcontextlost",{originalEvent:d}))}_contextRestored(d){this._setupPainter(),this.resize(),this._update(),this.fire(new r.b("webglcontextrestored",{originalEvent:d}))}_onMapScroll(d){if(d.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(d){return this.style?(this._styleDirty=this._styleDirty||d,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(d){return this._update(),this._renderTaskQueue.add(d)}_cancelRenderFrame(d){this._renderTaskQueue.remove(d)}_requestDomTask(d){!this.loaded()||this.loaded()&&!this.isMoving()?d():this._domRenderTaskQueue.add(d)}_render(d){let n;this.fire(new r.b("renderstart"));const a=this.painter.context.extTimerQuery,f=r.f.now(),_=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(n=_.createQuery(),_.beginQuery(a.TIME_ELAPSED_EXT,n)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(d),this._domRenderTaskQueue.run(d),this._removed)return;this._updateProjectionTransition();const x=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const C=this.transform.zoom,D=this.transform.pitch,z=r.f.now(),O=new r.N(C,{now:z,fadeDuration:x,pitch:D,transition:this.style.transition});this.style.update(O)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let w=!1;if(this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),w=this._updateAverageElevation(f),this.style.updateSources(this.transform),this._forceMarkerAndPopupUpdate()):w=this._updateAverageElevation(f),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,x,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:x,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new r.b("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new r.b("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),n){const C=r.f.now()-f;_.endQuery(a.TIME_ELAPSED_EXT),setTimeout(()=>{const D=_.getQueryParameter(n,_.QUERY_RESULT)/1e6;_.deleteQuery(n),this.fire(new r.b("gpu-timing-frame",{cpuTime:C,gpuTime:D}))},50)}if(this.listens("gpu-timing-layer")){const C=this.painter.collectGpuTimers();setTimeout(()=>{const D=this.painter.queryGpuTimers(C);this.fire(new r.b("gpu-timing-layer",{layerTimes:D}))},50)}if(this.listens("gpu-timing-deferred-render")){const C=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const D=this.painter.queryGpuTimeDeferredRender(C);this.fire(new r.b("gpu-timing-deferred-render",{gpuTime:D}))},50)}const S=this._sourcesDirty||this._styleDirty||this._placementDirty||w;if(S||this._repaint)this.triggerRepaint();else{const C=!this.isMoving()&&this.loaded();if(C&&(w=this._updateAverageElevation(f,!0)),w)this.triggerRepaint();else if(this._triggerFrame(!1),C&&(this.fire(new r.b("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const D=this._calculateSpeedIndex();this.fire(new r.b("speedindexcompleted",{speedIndex:D})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||S||(this._fullyLoaded=!0,this._performanceMetricsCollection&&r.dl(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(d){for(const n of this._markers)d&&!this.getRenderWorldCopies()&&(n._lngLat=n._lngLat.wrap()),n._update();for(const n of this._popups)!d||this.getRenderWorldCopies()||n._trackPointer||(n._lngLat=n._lngLat.wrap()),n._update()}_updateAverageElevation(d,n=!1){const a=_=>(this.transform.averageElevation=_,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&a(0);const f=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(f||(n||d-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(d)){const _=this.transform.averageElevation;let x=this.transform.sampleAverageElevation();this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(x)?x=0:this._averageElevationLastSampledAt=d;const w=Math.abs(_-x);if(w>1){if(this._isInitialLoad||f)return this._averageElevation.jumpTo(x),a(x);this._averageElevation.easeTo(x,d,300)}else if(w>1e-4)return this._averageElevation.jumpTo(x),a(x)}return!!this._averageElevation.isEasing(d)&&a(this._averageElevation.getValue(d))}_authenticate(){r.dm(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,d=>{if(d&&(d.message===r.dn||d.status===401)){const n=this.painter.context.gl;r.dj(n,!1),this._logoControl instanceof Yp&&this._logoControl._updateLogo(),n&&n.clear(n.DEPTH_BUFFER_BIT|n.COLOR_BUFFER_BIT|n.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new r.a(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),r.dp(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&r.dq(this._requestManager._customAccessToken,{map:this,skuToken:this._requestManager._skuToken,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){const d=this._isDragging();this.painter.updateTerrain(this.style,d)}_calculateSpeedIndex(){const d=this.painter.canvasCopy(),n=this.painter.getCanvasCopiesAndTimestamps();n.timeStamps.push(performance.now());const a=this.painter.context.gl,f=a.createFramebuffer();function _(x){a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,x,0);const w=new Uint8Array(a.drawingBufferWidth*a.drawingBufferHeight*4);return a.readPixels(0,0,a.drawingBufferWidth,a.drawingBufferHeight,a.RGBA,a.UNSIGNED_BYTE,w),w}return a.bindFramebuffer(a.FRAMEBUFFER,f),this._canvasPixelComparison(_(d),n.canvasCopies.map(_),n.timeStamps)}_canvasPixelComparison(d,n,a){let f=a[1]-a[0];const _=d.length/4;for(let x=0;x<n.length;x++){const w=n[x];let S=0;for(let C=0;C<w.length;C+=4)w[C]===d[C]&&w[C+1]===d[C+1]&&w[C+2]===d[C+2]&&w[C+3]===d[C+3]&&(S+=1);f+=(a[x+2]-a[x+1])*(1-S/_)}return f}remove(){this._hash&&this._hash.remove();for(const n of this._controls)n.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const d=this.painter.context.gl.getExtension("WEBGL_lose_context");d&&d.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),r.dr(this.painter.context.gl),r.ds.remove(),r.dt.remove(),this._removed=!0,this.fire(new r.b("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(d){this._renderNextFrame=this._renderNextFrame||d,this.style&&!this._frame&&(this._frame=r.f.frame(n=>{const a=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,a&&this._render(n)}))}_preloadTiles(d){const n=this.style?this.style.getSourceCaches():[];return r.b4(n,(a,f)=>a._preloadTiles(d,f),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(d){this._trackResize&&this.resize({originalEvent:d})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(d){this._showTileBoundaries!==d&&(this._showTileBoundaries=d,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(d){this._showParseStatus!==d&&(this._showParseStatus=d,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(d){this._showTerrainWireframe!==d&&(this._showTerrainWireframe=d,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(d){this._showLayers2DWireframe!==d&&(this._showLayers2DWireframe=d,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(d){this._showLayers3DWireframe!==d&&(this._showLayers3DWireframe=d,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(d){this._speedIndexTiming!==d&&(this._speedIndexTiming=d,this._update())}get showPadding(){return!!this._showPadding}set showPadding(d){this._showPadding!==d&&(this._showPadding=d,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(d){this._showCollisionBoxes!==d&&(this._showCollisionBoxes=d,this._tp.refreshUI(),d?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(d){this._showOverdrawInspector!==d&&(this._showOverdrawInspector=d,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(d){this._repaint!==d&&(this._repaint=d,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(d){this._vertices=d,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(d){this._showTileAABBs!==d&&(this._showTileAABBs=d,this._tp.refreshUI(),d&&this._update())}_setCacheLimits(d,n){r.dv(d,n)}get version(){return r.du}},NavigationControl:class{constructor(d){this.options=r.e({},Oa,d),this._container=Q("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",n=>n.preventDefault()),this.options.showZoom&&(r.a$(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",n=>{this._map&&this._map.zoomIn({},{originalEvent:n})}),Q("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",n=>{this._map&&this._map.zoomOut({},{originalEvent:n})}),Q("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(r.a$(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",n=>{const a=this._map;a&&(this.options.visualizePitch?a.resetNorthPitch({},{originalEvent:n}):a.resetNorth({},{originalEvent:n}))}),this._compassIcon=Q("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const d=this._map;if(!d)return;const n=d.getZoom(),a=n===d.getMaxZoom(),f=n===d.getMinZoom();this._zoomInButton.disabled=a,this._zoomOutButton.disabled=f,this._zoomInButton.setAttribute("aria-disabled",a.toString()),this._zoomOutButton.setAttribute("aria-disabled",f.toString())}_rotateCompassArrow(){const d=this._map;if(!d)return;const n=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(d.transform.pitch*(Math.PI/180)),.5)}) rotateX(${d.transform.pitch}deg) rotateZ(${d.transform.angle*(180/Math.PI)}deg)`:`rotate(${d.transform.angle*(180/Math.PI)}deg)`;d._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=n)})}onAdd(d){return this._map=d,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),d.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&d.on("pitch",this._rotateCompassArrow),d.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Cu(d,this._compass,this.options.visualizePitch)),this._container}onRemove(){const d=this._map;d&&(this._container.remove(),this.options.showZoom&&d.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&d.off("pitch",this._rotateCompassArrow),d.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(d,n){const a=Q("button",d,this._container);return a.type="button",a.addEventListener("click",n),a}_setButtonTitle(d,n){if(!this._map)return;const a=this._map._getUIString(`NavigationControl.${n}`);d.setAttribute("aria-label",a),d.firstElementChild&&d.firstElementChild.setAttribute("title",a)}},GeolocateControl:class extends r.E{constructor(d){super();const n=navigator.geolocation;this.options=r.e({geolocation:n},Mt,d),r.a$(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=zp(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(d){return this._map=d,this._container=Q("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(d){const n=(a=!!this.options.geolocation)=>{this._supportsGeolocation=a,d(a)};this._supportsGeolocation!==void 0?d(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then(a=>n(a.state!=="denied")).catch(()=>n()):n()}_isOutOfMapMaxBounds(d){const n=this._map.getMaxBounds(),a=d.coords;return!!n&&(a.longitude<n.getWest()||a.longitude>n.getEast()||a.latitude<n.getSouth()||a.latitude>n.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(d){if(this._map){if(this._isOutOfMapMaxBounds(d))return this._setErrorState(),this.fire(new r.b("outofmaxbounds",d)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=d,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(d),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(d),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new r.b("geolocate",d)),this._finish()}}_updateCamera(d){const n=new r.bq(d.coords.longitude,d.coords.latitude),a=d.coords.accuracy,f=this._map.getBearing(),_=r.e({bearing:f},this.options.fitBoundsOptions);this._map.fitBounds(n.toBounds(a),_,{geolocateSource:!0})}_updateMarker(d){if(d){const n=new r.bq(d.coords.longitude,d.coords.latitude);this._accuracyCircleMarker.setLngLat(n).addTo(this._map),this._userLocationDotMarker.setLngLat(n).addTo(this._map),this._accuracy=d.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const d=this._map.transform,n=r.bo(1,d._center.lat)*d.worldSize,a=Math.ceil(2*this._accuracy*n);this._circleElement.style.width=`${a}px`,this._circleElement.style.height=`${a}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(d){if(this._map){if(this.options.trackUserLocation)if(d.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const n=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",n),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",n),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(d.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new r.b("error",d)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(d){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",n=>n.preventDefault()),this._geolocateButton=Q("button","mapboxgl-ctrl-geolocate",this._container),Q("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",d===!1){r.w("Geolocation support is not available so the GeolocateControl will be disabled.");const n=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",n),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",n)}else{const n=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",n),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",n)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=Q("div","mapboxgl-user-location"),this._dotElement.appendChild(Q("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(Q("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Yl({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=Q("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Yl({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",n=>{n.geolocateSource||this._watchState!=="ACTIVE_LOCK"||n.originalEvent&&n.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new r.b("trackuserlocationend")))})}}_onDeviceOrientation(d){this._userLocationDotMarker&&(d.webkitCompassHeading?this._heading=d.webkitCompassHeading:d.absolute===!0&&(this._heading=-1*d.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return r.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new r.b("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new r.b("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new r.b("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let d;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(d={maximumAge:6e5,timeout:0},this._noTimeout=!0):(d=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,d),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const d=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(n=>{n==="granted"&&d()}).catch(console.error):d()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:vd,ScaleControl:class{constructor(d){this.options=r.e({},Kp,d),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),r.a$(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const d=this.options.maxWidth||100,n=this._map,a=n._containerHeight/2,f=n._containerWidth/2-d/2,_=n.unproject([f,a]),x=n.unproject([f+d,a]),w=_.distanceTo(x);if(this.options.unit==="imperial"){const S=3.2808*w;S>5280?this._setScale(d,S/5280,"mile"):this._setScale(d,S,"foot")}else this.options.unit==="nautical"?this._setScale(d,w/1852,"nautical-mile"):w>=1e3?this._setScale(d,w/1e3,"kilometer"):this._setScale(d,w,"meter")}_setScale(d,n,a){this._map._requestDomTask(()=>{const f=function(x){const w=Math.pow(10,`${Math.floor(x)}`.length-1);let S=x/w;return S=S>=10?10:S>=5?5:S>=3?3:S>=2?2:S>=1?1:function(C){const D=Math.pow(10,Math.ceil(-Math.log(C)/Math.LN10));return Math.round(C*D)/D}(S),w*S}(n),_=f/n;this._container.innerHTML=this._isNumberFormatSupported&&a!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:a}).format(f):`${f}&nbsp;${Jp[a]}`,this._container.style.width=d*_+"px"})}onAdd(d){return this._map=d,this._language=d.getLanguage(),this._container=Q("div","mapboxgl-ctrl mapboxgl-ctrl-scale",d.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(d){this._language=d,this._update()}setUnit(d){this.options.unit=d,this._update()}},FullscreenControl:class{constructor(d){this._fullscreen=!1,d&&d.container&&(d.container instanceof HTMLElement?this._container=d.container:r.w("Full screen control 'container' must be a DOM element.")),r.a$(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(d){return this._map=d,this._container||(this._container=this._map.getContainer()),this._controlContainer=Q("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",r.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const d=this._fullscreenButton=Q("button","mapboxgl-ctrl-fullscreen",this._controlContainer);Q("span","mapboxgl-ctrl-icon",d).setAttribute("aria-hidden","true"),d.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const d=this._getTitle();this._fullscreenButton.setAttribute("aria-label",d),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",d)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends r.E{constructor(d){super(),this.options=r.e(Object.create(Ql),d),r.a$(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(d&&d.className?d.className.trim().split(/\s+/):[])}addTo(d){return this._map&&this.remove(),this._map=d,this.options.closeOnClick&&d.on("preclick",this._onClose),this.options.closeOnMove&&d.on("move",this._onClose),d.on("remove",this.remove),this._update(),d._addPopup(this),this._focusFirstElement(),this._trackPointer?(d.on("mousemove",this._onMouseEvent),d.on("mouseup",this._onMouseEvent),d._canvasContainer.classList.add("mapboxgl-track-pointer")):d.on("move",this._update),this.fire(new r.b("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const d=this._map;return d&&(d.off("move",this._update),d.off("move",this._onClose),d.off("preclick",this._onClose),d.off("click",this._onClose),d.off("remove",this.remove),d.off("mousemove",this._onMouseEvent),d.off("mouseup",this._onMouseEvent),d.off("drag",this._onMouseEvent),d._canvasContainer&&d._canvasContainer.classList.remove("mapboxgl-track-pointer"),d._removePopup(this),this._map=void 0),this.fire(new r.b("close")),this}getLngLat(){return this._lngLat}setLngLat(d){this._lngLat=r.bq.convert(d),this._pos=null,this._trackPointer=!1,this._update();const n=this._map;return n&&(n.on("move",this._update),n.off("mousemove",this._onMouseEvent),n._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const d=this._map;return d&&(d.off("move",this._update),d.on("mousemove",this._onMouseEvent),d.on("drag",this._onMouseEvent),d._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(d){return this.setDOMContent(document.createTextNode(d))}setHTML(d){const n=document.createDocumentFragment(),a=document.createElement("body");let f;for(a.innerHTML=d;f=a.firstChild,f;)n.appendChild(f);return this.setDOMContent(n)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(d){return this.options.maxWidth=d,this._update(),this}setDOMContent(d){let n=this._content;if(n)for(;n.hasChildNodes();)n.firstChild&&n.removeChild(n.firstChild);else n=this._content=Q("div","mapboxgl-popup-content",this._container||void 0);if(n.appendChild(d),this.options.closeButton){const a=this._closeButton=Q("button","mapboxgl-popup-close-button",n);a.type="button",a.setAttribute("aria-label","Close popup"),a.setAttribute("aria-hidden","true"),a.innerHTML="&#215;",a.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(d){return this._classList.add(d),this._updateClassList(),this}removeClassName(d){return this._classList.delete(d),this._updateClassList(),this}setOffset(d){return this.options.offset=d,this._update(),this}toggleClassName(d){let n;return this._classList.delete(d)?n=!1:(this._classList.add(d),n=!0),this._updateClassList(),n}_onMouseEvent(d){this._update(d.point)}_getAnchor(d){if(this.options.anchor)return this.options.anchor;const n=this._map,a=this._container,f=this._pos;if(!n||!a||!f)return"bottom";const _=a.offsetWidth,x=a.offsetHeight,w=f.x<_/2,S=f.x>n.transform.width-_/2;if(f.y+d<x)return w?"top-left":S?"top-right":"top";if(f.y>n.transform.height-x){if(w)return"bottom-left";if(S)return"bottom-right"}return w?"left":S?"right":"bottom"}_updateClassList(){const d=this._container;if(!d)return;const n=[...this._classList];n.push("mapboxgl-popup"),this._anchor&&n.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&n.push("mapboxgl-popup-track-pointer"),d.className=n.join(" ")}_update(d){const n=this._map,a=this._content;if(!n||!this._lngLat&&!this._trackPointer||!a)return;let f=this._container;if(f||(f=this._container=Q("div","mapboxgl-popup",n.getContainer()),this._tip=Q("div","mapboxgl-popup-tip",f),f.appendChild(a)),this.options.maxWidth&&f.style.maxWidth!==this.options.maxWidth&&(f.style.maxWidth=this.options.maxWidth),n.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Au(this._lngLat,this._pos,n.transform)),!this._trackPointer||d){const _=this._pos=this._trackPointer&&d?d:n.project(this._lngLat),x=Xl(this.options.offset),w=this._anchor=this._getAnchor(x.y),S=Xl(this.options.offset,w),C=_.add(S).round();n._requestDomTask(()=>{this._container&&w&&(this._container.style.transform=`${La[w]} translate(${C.x}px,${C.y}px)`)})}if(!this._marker&&n._showingGlobe()){const _=r.de(n.transform,this._lngLat)?0:1;this._setOpacity(_)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const d=this._container.querySelector(Qp);d&&d.focus()}_onClose(){this.remove()}_setOpacity(d){this._container&&(this._container.style.opacity=`${d}`),this._content&&(this._content.style.pointerEvents=d?"auto":"none")}},Marker:Yl,Style:ys,LngLat:r.bq,LngLatBounds:r.ag,Point:r.P,MercatorCoordinate:r.O,FreeCameraOptions:va,Evented:r.E,config:r.dd,prewarm:r.dy,clearPrewarmedResources:r.dz,get accessToken(){return r.dd.ACCESS_TOKEN},set accessToken(d){r.dd.ACCESS_TOKEN=d},get baseApiUrl(){return r.dd.API_URL},set baseApiUrl(d){r.dd.API_URL=d},get workerCount(){return r.dA.workerCount},set workerCount(d){r.dA.workerCount=d},get maxParallelImageRequests(){return r.dd.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(d){r.dd.MAX_PARALLEL_IMAGE_REQUESTS=d},clearStorage(d){r.dB(d)},get workerUrl(){return r.dC.workerUrl},set workerUrl(d){r.dC.workerUrl=d},get workerClass(){return r.dC.workerClass},set workerClass(d){r.dC.workerClass=d},get workerParams(){return r.dC.workerParams},set workerParams(d){r.dC.workerParams=d},get dracoUrl(){return r.dD()},set dracoUrl(d){r.dE(d)},get meshoptUrl(){return r.dF()},set meshoptUrl(d){r.dG(d)},setNow:r.f.setNow,restoreNow:r.f.restoreNow}});var A=b;return A})})(fM);var VC=fM.exports;const Jm=NC(VC);function UC(l){let o,u,m,g,b,M,A,r;return{c(){o=on("link"),u=Lr(),m=on("div"),g=on("div"),b=Lr(),M=on("div"),A=Lr(),r=on("div"),Sn(o,"rel","stylesheet"),Sn(o,"href","https://api.mapbox.com/mapbox-gl-js/v2.14.0/mapbox-gl.css"),Sn(g,"class","map svelte-m3bbj5"),bC(g,"visible",jC),Sn(M,"class","inset-map alaska svelte-m3bbj5"),Sn(r,"class","inset-map hawaii svelte-m3bbj5"),Sn(m,"class","map-container svelte-m3bbj5")},m(k,F){Vi(document.head,o),Po(k,u,F),Po(k,m,F),Vi(m,g),l[6](g),Vi(m,b),Vi(m,M),l[7](M),Vi(m,A),Vi(m,r),l[8](r)},p:Cs,i:Cs,o:Cs,d(k){k&&(hs(u),hs(m)),hs(o),l[6](null),l[7](null),l[8](null)}}}let jC=!0;function GC(l,o,u){let{data2020:m}=o,{index:g}=o,{geoJsonToFit:b}=o;Jm.accessToken="pk.eyJ1IjoiMjU0OTQ4NjM3MyIsImEiOiJjbHcyc2pvdnMwcHRyMmp0aTF2Zm9uMG1jIn0.5jMEYh4ZzoZT0-SDWUfVqA";let M,A,r,k,F,N,W;function Q(){W=window.innerWidth<=600?3:4}function te(){Q(),k.setZoom(W)}Q0(()=>{Q(),k=new Jm.Map({container:M,style:"mapbox://styles/mapbox/light-v11",center:[-98.583333,39.833333],zoom:W,attributionControl:!0}),F=new Jm.Map({container:A,style:"mapbox://styles/mapbox/light-v11",center:[-152.4044,61.3707],zoom:1.2,attributionControl:!1}),N=new Jm.Map({container:r,style:"mapbox://styles/mapbox/light-v11",center:[-157.5828,19.8968],zoom:4.1,attributionControl:!1}),window.addEventListener("resize",te);function Ee(Ie){const qe=Ie.getStyle().layers.filter(Ve=>Ve.type==="symbol"&&/label|text|place/.test(Ve.id)).map(Ve=>Ve.id);for(const Ve of qe)Ie.setLayoutProperty(Ve,"visibility","none")}function Me(Ie){Ie.addSource("county-boundaries",{type:"geojson",data:"https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json"}),Ie.addLayer({id:"county-boundaries",type:"line",source:"county-boundaries",layout:{},paint:{"line-color":"#000000","line-width":.1}})}k.on("load",()=>{Ee(k),k.addSource("state-boundaries",{type:"geojson",data:"https://docs.mapbox.com/mapbox-gl-js/assets/us_states.geojson"}),k.addLayer({id:"state-boundaries",type:"line",source:"state-boundaries",layout:{},paint:{"line-color":"#000000","line-width":1}}),Me(k),ce(),k.on("zoom",ce),k.on("drag",ce),k.on("move",ce)}),F.on("load",()=>{Ee(F),Me(F)}),N.on("load",()=>{Ee(N),Me(N)})});function ce(){const Ee=k.getBounds();u(3,b.features[0].geometry.coordinates=[Ee._ne.lng,Ee._ne.lat],b),u(3,b.features[1].geometry.coordinates=[Ee._sw.lng,Ee._sw.lat],b)}function de(Ee){ls[Ee?"unshift":"push"](()=>{M=Ee,u(0,M)})}function ve(Ee){ls[Ee?"unshift":"push"](()=>{A=Ee,u(1,A)})}function Te(Ee){ls[Ee?"unshift":"push"](()=>{r=Ee,u(2,r)})}return l.$$set=Ee=>{"data2020"in Ee&&u(4,m=Ee.data2020),"index"in Ee&&u(5,g=Ee.index),"geoJsonToFit"in Ee&&u(3,b=Ee.geoJsonToFit)},[M,A,r,b,m,g,de,ve,Te]}let WC=class extends X_{constructor(o){super(),Q_(this,o,GC,UC,Y_,{data2020:4,index:5,geoJsonToFit:3})}};/*!
 * @kurkle/color v0.3.2
 * https://github.com/kurkle/color#readme
 * (c) 2023 Jukka Kurkela
 * Released under the MIT License
 */function Uf(l){return l+.5|0}const rl=(l,o,u)=>Math.max(Math.min(l,u),o);function ff(l){return rl(Uf(l*2.55),0,255)}function ll(l){return rl(Uf(l*255),0,255)}function aa(l){return rl(Uf(l/2.55)/100,0,1)}function K1(l){return rl(Uf(l*100),0,100)}const js={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,A:10,B:11,C:12,D:13,E:14,F:15,a:10,b:11,c:12,d:13,e:14,f:15},E0=[..."0123456789ABCDEF"],qC=l=>E0[l&15],HC=l=>E0[(l&240)>>4]+E0[l&15],e_=l=>(l&240)>>4===(l&15),ZC=l=>e_(l.r)&&e_(l.g)&&e_(l.b)&&e_(l.a);function $C(l){var o=l.length,u;return l[0]==="#"&&(o===4||o===5?u={r:255&js[l[1]]*17,g:255&js[l[2]]*17,b:255&js[l[3]]*17,a:o===5?js[l[4]]*17:255}:(o===7||o===9)&&(u={r:js[l[1]]<<4|js[l[2]],g:js[l[3]]<<4|js[l[4]],b:js[l[5]]<<4|js[l[6]],a:o===9?js[l[7]]<<4|js[l[8]]:255})),u}const YC=(l,o)=>l<255?o(l):"";function QC(l){var o=ZC(l)?qC:HC;return l?"#"+o(l.r)+o(l.g)+o(l.b)+YC(l.a,o):void 0}const XC=/^(hsla?|hwb|hsv)\(\s*([-+.e\d]+)(?:deg)?[\s,]+([-+.e\d]+)%[\s,]+([-+.e\d]+)%(?:[\s,]+([-+.e\d]+)(%)?)?\s*\)$/;function mM(l,o,u){const m=o*Math.min(u,1-u),g=(b,M=(b+l/30)%12)=>u-m*Math.max(Math.min(M-3,9-M,1),-1);return[g(0),g(8),g(4)]}function KC(l,o,u){const m=(g,b=(g+l/60)%6)=>u-u*o*Math.max(Math.min(b,4-b,1),0);return[m(5),m(3),m(1)]}function JC(l,o,u){const m=mM(l,1,.5);let g;for(o+u>1&&(g=1/(o+u),o*=g,u*=g),g=0;g<3;g++)m[g]*=1-o-u,m[g]+=o;return m}function eP(l,o,u,m,g){return l===g?(o-u)/m+(o<u?6:0):o===g?(u-l)/m+2:(l-o)/m+4}function X0(l){const u=l.r/255,m=l.g/255,g=l.b/255,b=Math.max(u,m,g),M=Math.min(u,m,g),A=(b+M)/2;let r,k,F;return b!==M&&(F=b-M,k=A>.5?F/(2-b-M):F/(b+M),r=eP(u,m,g,F,b),r=r*60+.5),[r|0,k||0,A]}function K0(l,o,u,m){return(Array.isArray(o)?l(o[0],o[1],o[2]):l(o,u,m)).map(ll)}function J0(l,o,u){return K0(mM,l,o,u)}function tP(l,o,u){return K0(JC,l,o,u)}function iP(l,o,u){return K0(KC,l,o,u)}function _M(l){return(l%360+360)%360}function nP(l){const o=XC.exec(l);let u=255,m;if(!o)return;o[5]!==m&&(u=o[6]?ff(+o[5]):ll(+o[5]));const g=_M(+o[2]),b=+o[3]/100,M=+o[4]/100;return o[1]==="hwb"?m=tP(g,b,M):o[1]==="hsv"?m=iP(g,b,M):m=J0(g,b,M),{r:m[0],g:m[1],b:m[2],a:u}}function rP(l,o){var u=X0(l);u[0]=_M(u[0]+o),u=J0(u),l.r=u[0],l.g=u[1],l.b=u[2]}function sP(l){if(!l)return;const o=X0(l),u=o[0],m=K1(o[1]),g=K1(o[2]);return l.a<255?`hsla(${u}, ${m}%, ${g}%, ${aa(l.a)})`:`hsl(${u}, ${m}%, ${g}%)`}const J1={x:"dark",Z:"light",Y:"re",X:"blu",W:"gr",V:"medium",U:"slate",A:"ee",T:"ol",S:"or",B:"ra",C:"lateg",D:"ights",R:"in",Q:"turquois",E:"hi",P:"ro",O:"al",N:"le",M:"de",L:"yello",F:"en",K:"ch",G:"arks",H:"ea",I:"ightg",J:"wh"},ew={OiceXe:"f0f8ff",antiquewEte:"faebd7",aqua:"ffff",aquamarRe:"7fffd4",azuY:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"0",blanKedOmond:"ffebcd",Xe:"ff",XeviTet:"8a2be2",bPwn:"a52a2a",burlywood:"deb887",caMtXe:"5f9ea0",KartYuse:"7fff00",KocTate:"d2691e",cSO:"ff7f50",cSnflowerXe:"6495ed",cSnsilk:"fff8dc",crimson:"dc143c",cyan:"ffff",xXe:"8b",xcyan:"8b8b",xgTMnPd:"b8860b",xWay:"a9a9a9",xgYF:"6400",xgYy:"a9a9a9",xkhaki:"bdb76b",xmagFta:"8b008b",xTivegYF:"556b2f",xSange:"ff8c00",xScEd:"9932cc",xYd:"8b0000",xsOmon:"e9967a",xsHgYF:"8fbc8f",xUXe:"483d8b",xUWay:"2f4f4f",xUgYy:"2f4f4f",xQe:"ced1",xviTet:"9400d3",dAppRk:"ff1493",dApskyXe:"bfff",dimWay:"696969",dimgYy:"696969",dodgerXe:"1e90ff",fiYbrick:"b22222",flSOwEte:"fffaf0",foYstWAn:"228b22",fuKsia:"ff00ff",gaRsbSo:"dcdcdc",ghostwEte:"f8f8ff",gTd:"ffd700",gTMnPd:"daa520",Way:"808080",gYF:"8000",gYFLw:"adff2f",gYy:"808080",honeyMw:"f0fff0",hotpRk:"ff69b4",RdianYd:"cd5c5c",Rdigo:"4b0082",ivSy:"fffff0",khaki:"f0e68c",lavFMr:"e6e6fa",lavFMrXsh:"fff0f5",lawngYF:"7cfc00",NmoncEffon:"fffacd",ZXe:"add8e6",ZcSO:"f08080",Zcyan:"e0ffff",ZgTMnPdLw:"fafad2",ZWay:"d3d3d3",ZgYF:"90ee90",ZgYy:"d3d3d3",ZpRk:"ffb6c1",ZsOmon:"ffa07a",ZsHgYF:"20b2aa",ZskyXe:"87cefa",ZUWay:"778899",ZUgYy:"778899",ZstAlXe:"b0c4de",ZLw:"ffffe0",lime:"ff00",limegYF:"32cd32",lRF:"faf0e6",magFta:"ff00ff",maPon:"800000",VaquamarRe:"66cdaa",VXe:"cd",VScEd:"ba55d3",VpurpN:"9370db",VsHgYF:"3cb371",VUXe:"7b68ee",VsprRggYF:"fa9a",VQe:"48d1cc",VviTetYd:"c71585",midnightXe:"191970",mRtcYam:"f5fffa",mistyPse:"ffe4e1",moccasR:"ffe4b5",navajowEte:"ffdead",navy:"80",Tdlace:"fdf5e6",Tive:"808000",TivedBb:"6b8e23",Sange:"ffa500",SangeYd:"ff4500",ScEd:"da70d6",pOegTMnPd:"eee8aa",pOegYF:"98fb98",pOeQe:"afeeee",pOeviTetYd:"db7093",papayawEp:"ffefd5",pHKpuff:"ffdab9",peru:"cd853f",pRk:"ffc0cb",plum:"dda0dd",powMrXe:"b0e0e6",purpN:"800080",YbeccapurpN:"663399",Yd:"ff0000",Psybrown:"bc8f8f",PyOXe:"4169e1",saddNbPwn:"8b4513",sOmon:"fa8072",sandybPwn:"f4a460",sHgYF:"2e8b57",sHshell:"fff5ee",siFna:"a0522d",silver:"c0c0c0",skyXe:"87ceeb",UXe:"6a5acd",UWay:"708090",UgYy:"708090",snow:"fffafa",sprRggYF:"ff7f",stAlXe:"4682b4",tan:"d2b48c",teO:"8080",tEstN:"d8bfd8",tomato:"ff6347",Qe:"40e0d0",viTet:"ee82ee",JHt:"f5deb3",wEte:"ffffff",wEtesmoke:"f5f5f5",Lw:"ffff00",LwgYF:"9acd32"};function oP(){const l={},o=Object.keys(ew),u=Object.keys(J1);let m,g,b,M,A;for(m=0;m<o.length;m++){for(M=A=o[m],g=0;g<u.length;g++)b=u[g],A=A.replace(b,J1[b]);b=parseInt(ew[M],16),l[A]=[b>>16&255,b>>8&255,b&255]}return l}let t_;function aP(l){t_||(t_=oP(),t_.transparent=[0,0,0,0]);const o=t_[l.toLowerCase()];return o&&{r:o[0],g:o[1],b:o[2],a:o.length===4?o[3]:255}}const lP=/^rgba?\(\s*([-+.\d]+)(%)?[\s,]+([-+.e\d]+)(%)?[\s,]+([-+.e\d]+)(%)?(?:[\s,/]+([-+.e\d]+)(%)?)?\s*\)$/;function cP(l){const o=lP.exec(l);let u=255,m,g,b;if(o){if(o[7]!==m){const M=+o[7];u=o[8]?ff(M):rl(M*255,0,255)}return m=+o[1],g=+o[3],b=+o[5],m=255&(o[2]?ff(m):rl(m,0,255)),g=255&(o[4]?ff(g):rl(g,0,255)),b=255&(o[6]?ff(b):rl(b,0,255)),{r:m,g,b,a:u}}}function uP(l){return l&&(l.a<255?`rgba(${l.r}, ${l.g}, ${l.b}, ${aa(l.a)})`:`rgb(${l.r}, ${l.g}, ${l.b})`)}const t0=l=>l<=.0031308?l*12.92:Math.pow(l,1/2.4)*1.055-.055,ih=l=>l<=.04045?l/12.92:Math.pow((l+.055)/1.055,2.4);function hP(l,o,u){const m=ih(aa(l.r)),g=ih(aa(l.g)),b=ih(aa(l.b));return{r:ll(t0(m+u*(ih(aa(o.r))-m))),g:ll(t0(g+u*(ih(aa(o.g))-g))),b:ll(t0(b+u*(ih(aa(o.b))-b))),a:l.a+u*(o.a-l.a)}}function i_(l,o,u){if(l){let m=X0(l);m[o]=Math.max(0,Math.min(m[o]+m[o]*u,o===0?360:1)),m=J0(m),l.r=m[0],l.g=m[1],l.b=m[2]}}function gM(l,o){return l&&Object.assign(o||{},l)}function tw(l){var o={r:0,g:0,b:0,a:255};return Array.isArray(l)?l.length>=3&&(o={r:l[0],g:l[1],b:l[2],a:255},l.length>3&&(o.a=ll(l[3]))):(o=gM(l,{r:0,g:0,b:0,a:1}),o.a=ll(o.a)),o}function dP(l){return l.charAt(0)==="r"?cP(l):nP(l)}class Pf{constructor(o){if(o instanceof Pf)return o;const u=typeof o;let m;u==="object"?m=tw(o):u==="string"&&(m=$C(o)||aP(o)||dP(o)),this._rgb=m,this._valid=!!m}get valid(){return this._valid}get rgb(){var o=gM(this._rgb);return o&&(o.a=aa(o.a)),o}set rgb(o){this._rgb=tw(o)}rgbString(){return this._valid?uP(this._rgb):void 0}hexString(){return this._valid?QC(this._rgb):void 0}hslString(){return this._valid?sP(this._rgb):void 0}mix(o,u){if(o){const m=this.rgb,g=o.rgb;let b;const M=u===b?.5:u,A=2*M-1,r=m.a-g.a,k=((A*r===-1?A:(A+r)/(1+A*r))+1)/2;b=1-k,m.r=255&k*m.r+b*g.r+.5,m.g=255&k*m.g+b*g.g+.5,m.b=255&k*m.b+b*g.b+.5,m.a=M*m.a+(1-M)*g.a,this.rgb=m}return this}interpolate(o,u){return o&&(this._rgb=hP(this._rgb,o._rgb,u)),this}clone(){return new Pf(this.rgb)}alpha(o){return this._rgb.a=ll(o),this}clearer(o){const u=this._rgb;return u.a*=1-o,this}greyscale(){const o=this._rgb,u=Uf(o.r*.3+o.g*.59+o.b*.11);return o.r=o.g=o.b=u,this}opaquer(o){const u=this._rgb;return u.a*=1+o,this}negate(){const o=this._rgb;return o.r=255-o.r,o.g=255-o.g,o.b=255-o.b,this}lighten(o){return i_(this._rgb,2,o),this}darken(o){return i_(this._rgb,2,-o),this}saturate(o){return i_(this._rgb,1,o),this}desaturate(o){return i_(this._rgb,1,-o),this}rotate(o){return rP(this._rgb,o),this}}/*!
 * Chart.js v4.4.3
 * https://www.chartjs.org
 * (c) 2024 Chart.js Contributors
 * Released under the MIT License
 */function ra(){}const fP=(()=>{let l=0;return()=>l++})();function cn(l){return l===null||typeof l>"u"}function qn(l){if(Array.isArray&&Array.isArray(l))return!0;const o=Object.prototype.toString.call(l);return o.slice(0,7)==="[object"&&o.slice(-6)==="Array]"}function en(l){return l!==null&&Object.prototype.toString.call(l)==="[object Object]"}function Jn(l){return(typeof l=="number"||l instanceof Number)&&isFinite(+l)}function Es(l,o){return Jn(l)?l:o}function Fi(l,o){return typeof l>"u"?o:l}const pP=(l,o)=>typeof l=="string"&&l.endsWith("%")?parseFloat(l)/100:+l/o,yM=(l,o)=>typeof l=="string"&&l.endsWith("%")?parseFloat(l)/100*o:+l;function zn(l,o,u){if(l&&typeof l.call=="function")return l.apply(u,o)}function Mn(l,o,u,m){let g,b,M;if(qn(l))for(b=l.length,g=0;g<b;g++)o.call(u,l[g],g);else if(en(l))for(M=Object.keys(l),b=M.length,g=0;g<b;g++)o.call(u,l[M[g]],M[g])}function R_(l,o){let u,m,g,b;if(!l||!o||l.length!==o.length)return!1;for(u=0,m=l.length;u<m;++u)if(g=l[u],b=o[u],g.datasetIndex!==b.datasetIndex||g.index!==b.index)return!1;return!0}function z_(l){if(qn(l))return l.map(z_);if(en(l)){const o=Object.create(null),u=Object.keys(l),m=u.length;let g=0;for(;g<m;++g)o[u[g]]=z_(l[u[g]]);return o}return l}function xM(l){return["__proto__","prototype","constructor"].indexOf(l)===-1}function mP(l,o,u,m){if(!xM(l))return;const g=o[l],b=u[l];en(g)&&en(b)?Df(g,b,m):o[l]=z_(b)}function Df(l,o,u){const m=qn(o)?o:[o],g=m.length;if(!en(l))return l;u=u||{};const b=u.merger||mP;let M;for(let A=0;A<g;++A){if(M=m[A],!en(M))continue;const r=Object.keys(M);for(let k=0,F=r.length;k<F;++k)b(r[k],l,M,u)}return l}function Tf(l,o){return Df(l,o,{merger:_P})}function _P(l,o,u){if(!xM(l))return;const m=o[l],g=u[l];en(m)&&en(g)?Tf(m,g):Object.prototype.hasOwnProperty.call(o,l)||(o[l]=z_(g))}const iw={"":l=>l,x:l=>l.x,y:l=>l.y};function gP(l){const o=l.split("."),u=[];let m="";for(const g of o)m+=g,m.endsWith("\\")?m=m.slice(0,-1)+".":(u.push(m),m="");return u}function yP(l){const o=gP(l);return u=>{for(const m of o){if(m==="")break;u=u&&u[m]}return u}}function cl(l,o){return(iw[o]||(iw[o]=yP(o)))(l)}function ex(l){return l.charAt(0).toUpperCase()+l.slice(1)}const kf=l=>typeof l<"u",ul=l=>typeof l=="function",nw=(l,o)=>{if(l.size!==o.size)return!1;for(const u of l)if(!o.has(u))return!1;return!0};function xP(l){return l.type==="mouseup"||l.type==="click"||l.type==="contextmenu"}const Vn=Math.PI,Nn=2*Vn,vP=Nn+Vn,L_=Number.POSITIVE_INFINITY,bP=Vn/180,ar=Vn/2,_c=Vn/4,rw=Vn*2/3,sl=Math.log10,Co=Math.sign;function Mf(l,o,u){return Math.abs(l-o)<u}function sw(l){const o=Math.round(l);l=Mf(l,o,l/1e3)?o:l;const u=Math.pow(10,Math.floor(sl(l))),m=l/u;return(m<=1?1:m<=2?2:m<=5?5:10)*u}function wP(l){const o=[],u=Math.sqrt(l);let m;for(m=1;m<u;m++)l%m===0&&(o.push(m),o.push(l/m));return u===(u|0)&&o.push(u),o.sort((g,b)=>g-b).pop(),o}function hh(l){return!isNaN(parseFloat(l))&&isFinite(l)}function TP(l,o){const u=Math.round(l);return u-o<=l&&u+o>=l}function vM(l,o,u){let m,g,b;for(m=0,g=l.length;m<g;m++)b=l[m][u],isNaN(b)||(o.min=Math.min(o.min,b),o.max=Math.max(o.max,b))}function ao(l){return l*(Vn/180)}function tx(l){return l*(180/Vn)}function ow(l){if(!Jn(l))return;let o=1,u=0;for(;Math.round(l*o)/o!==l;)o*=10,u++;return u}function bM(l,o){const u=o.x-l.x,m=o.y-l.y,g=Math.sqrt(u*u+m*m);let b=Math.atan2(m,u);return b<-.5*Vn&&(b+=Nn),{angle:b,distance:g}}function A0(l,o){return Math.sqrt(Math.pow(o.x-l.x,2)+Math.pow(o.y-l.y,2))}function MP(l,o){return(l-o+vP)%Nn-Vn}function Is(l){return(l%Nn+Nn)%Nn}function Rf(l,o,u,m){const g=Is(l),b=Is(o),M=Is(u),A=Is(b-g),r=Is(M-g),k=Is(g-b),F=Is(g-M);return g===b||g===M||m&&b===M||A>r&&k<F}function Ar(l,o,u){return Math.max(o,Math.min(u,l))}function SP(l){return Ar(l,-32768,32767)}function ca(l,o,u,m=1e-6){return l>=Math.min(o,u)-m&&l<=Math.max(o,u)+m}function ix(l,o,u){u=u||(M=>l[M]<o);let m=l.length-1,g=0,b;for(;m-g>1;)b=g+m>>1,u(b)?g=b:m=b;return{lo:g,hi:m}}const ua=(l,o,u,m)=>ix(l,u,m?g=>{const b=l[g][o];return b<u||b===u&&l[g+1][o]===u}:g=>l[g][o]<u),EP=(l,o,u)=>ix(l,u,m=>l[m][o]>=u);function AP(l,o,u){let m=0,g=l.length;for(;m<g&&l[m]<o;)m++;for(;g>m&&l[g-1]>u;)g--;return m>0||g<l.length?l.slice(m,g):l}const wM=["push","pop","shift","splice","unshift"];function IP(l,o){if(l._chartjs){l._chartjs.listeners.push(o);return}Object.defineProperty(l,"_chartjs",{configurable:!0,enumerable:!1,value:{listeners:[o]}}),wM.forEach(u=>{const m="_onData"+ex(u),g=l[u];Object.defineProperty(l,u,{configurable:!0,enumerable:!1,value(...b){const M=g.apply(this,b);return l._chartjs.listeners.forEach(A=>{typeof A[m]=="function"&&A[m](...b)}),M}})})}function aw(l,o){const u=l._chartjs;if(!u)return;const m=u.listeners,g=m.indexOf(o);g!==-1&&m.splice(g,1),!(m.length>0)&&(wM.forEach(b=>{delete l[b]}),delete l._chartjs)}function TM(l){const o=new Set(l);return o.size===l.length?l:Array.from(o)}const MM=function(){return typeof window>"u"?function(l){return l()}:window.requestAnimationFrame}();function SM(l,o){let u=[],m=!1;return function(...g){u=g,m||(m=!0,MM.call(window,()=>{m=!1,l.apply(o,u)}))}}function CP(l,o){let u;return function(...m){return o?(clearTimeout(u),u=setTimeout(l,o,m)):l.apply(this,m),o}}const nx=l=>l==="start"?"left":l==="end"?"right":"center",Gr=(l,o,u)=>l==="start"?o:l==="end"?u:(o+u)/2,PP=(l,o,u,m)=>l===(m?"left":"right")?u:l==="center"?(o+u)/2:o;function EM(l,o,u){const m=o.length;let g=0,b=m;if(l._sorted){const{iScale:M,_parsed:A}=l,r=M.axis,{min:k,max:F,minDefined:N,maxDefined:W}=M.getUserBounds();N&&(g=Ar(Math.min(ua(A,r,k).lo,u?m:ua(o,r,M.getPixelForValue(k)).lo),0,m-1)),W?b=Ar(Math.max(ua(A,M.axis,F,!0).hi+1,u?0:ua(o,r,M.getPixelForValue(F),!0).hi+1),g,m)-g:b=m-g}return{start:g,count:b}}function AM(l){const{xScale:o,yScale:u,_scaleRanges:m}=l,g={xmin:o.min,xmax:o.max,ymin:u.min,ymax:u.max};if(!m)return l._scaleRanges=g,!0;const b=m.xmin!==o.min||m.xmax!==o.max||m.ymin!==u.min||m.ymax!==u.max;return Object.assign(m,g),b}const n_=l=>l===0||l===1,lw=(l,o,u)=>-(Math.pow(2,10*(l-=1))*Math.sin((l-o)*Nn/u)),cw=(l,o,u)=>Math.pow(2,-10*l)*Math.sin((l-o)*Nn/u)+1,Sf={linear:l=>l,easeInQuad:l=>l*l,easeOutQuad:l=>-l*(l-2),easeInOutQuad:l=>(l/=.5)<1?.5*l*l:-.5*(--l*(l-2)-1),easeInCubic:l=>l*l*l,easeOutCubic:l=>(l-=1)*l*l+1,easeInOutCubic:l=>(l/=.5)<1?.5*l*l*l:.5*((l-=2)*l*l+2),easeInQuart:l=>l*l*l*l,easeOutQuart:l=>-((l-=1)*l*l*l-1),easeInOutQuart:l=>(l/=.5)<1?.5*l*l*l*l:-.5*((l-=2)*l*l*l-2),easeInQuint:l=>l*l*l*l*l,easeOutQuint:l=>(l-=1)*l*l*l*l+1,easeInOutQuint:l=>(l/=.5)<1?.5*l*l*l*l*l:.5*((l-=2)*l*l*l*l+2),easeInSine:l=>-Math.cos(l*ar)+1,easeOutSine:l=>Math.sin(l*ar),easeInOutSine:l=>-.5*(Math.cos(Vn*l)-1),easeInExpo:l=>l===0?0:Math.pow(2,10*(l-1)),easeOutExpo:l=>l===1?1:-Math.pow(2,-10*l)+1,easeInOutExpo:l=>n_(l)?l:l<.5?.5*Math.pow(2,10*(l*2-1)):.5*(-Math.pow(2,-10*(l*2-1))+2),easeInCirc:l=>l>=1?l:-(Math.sqrt(1-l*l)-1),easeOutCirc:l=>Math.sqrt(1-(l-=1)*l),easeInOutCirc:l=>(l/=.5)<1?-.5*(Math.sqrt(1-l*l)-1):.5*(Math.sqrt(1-(l-=2)*l)+1),easeInElastic:l=>n_(l)?l:lw(l,.075,.3),easeOutElastic:l=>n_(l)?l:cw(l,.075,.3),easeInOutElastic(l){return n_(l)?l:l<.5?.5*lw(l*2,.1125,.45):.5+.5*cw(l*2-1,.1125,.45)},easeInBack(l){return l*l*((1.70158+1)*l-1.70158)},easeOutBack(l){return(l-=1)*l*((1.70158+1)*l+1.70158)+1},easeInOutBack(l){let o=1.70158;return(l/=.5)<1?.5*(l*l*(((o*=1.525)+1)*l-o)):.5*((l-=2)*l*(((o*=1.525)+1)*l+o)+2)},easeInBounce:l=>1-Sf.easeOutBounce(1-l),easeOutBounce(l){return l<1/2.75?7.5625*l*l:l<2/2.75?7.5625*(l-=1.5/2.75)*l+.75:l<2.5/2.75?7.5625*(l-=2.25/2.75)*l+.9375:7.5625*(l-=2.625/2.75)*l+.984375},easeInOutBounce:l=>l<.5?Sf.easeInBounce(l*2)*.5:Sf.easeOutBounce(l*2-1)*.5+.5};function rx(l){if(l&&typeof l=="object"){const o=l.toString();return o==="[object CanvasPattern]"||o==="[object CanvasGradient]"}return!1}function uw(l){return rx(l)?l:new Pf(l)}function i0(l){return rx(l)?l:new Pf(l).saturate(.5).darken(.1).hexString()}const DP=["x","y","borderWidth","radius","tension"],kP=["color","borderColor","backgroundColor"];function RP(l){l.set("animation",{delay:void 0,duration:1e3,easing:"easeOutQuart",fn:void 0,from:void 0,loop:void 0,to:void 0,type:void 0}),l.describe("animation",{_fallback:!1,_indexable:!1,_scriptable:o=>o!=="onProgress"&&o!=="onComplete"&&o!=="fn"}),l.set("animations",{colors:{type:"color",properties:kP},numbers:{type:"number",properties:DP}}),l.describe("animations",{_fallback:"animation"}),l.set("transitions",{active:{animation:{duration:400}},resize:{animation:{duration:0}},show:{animations:{colors:{from:"transparent"},visible:{type:"boolean",duration:0}}},hide:{animations:{colors:{to:"transparent"},visible:{type:"boolean",easing:"linear",fn:o=>o|0}}}})}function zP(l){l.set("layout",{autoPadding:!0,padding:{top:0,right:0,bottom:0,left:0}})}const hw=new Map;function LP(l,o){o=o||{};const u=l+JSON.stringify(o);let m=hw.get(u);return m||(m=new Intl.NumberFormat(l,o),hw.set(u,m)),m}function jf(l,o,u){return LP(o,u).format(l)}const IM={values(l){return qn(l)?l:""+l},numeric(l,o,u){if(l===0)return"0";const m=this.chart.options.locale;let g,b=l;if(u.length>1){const k=Math.max(Math.abs(u[0].value),Math.abs(u[u.length-1].value));(k<1e-4||k>1e15)&&(g="scientific"),b=OP(l,u)}const M=sl(Math.abs(b)),A=isNaN(M)?1:Math.max(Math.min(-1*Math.floor(M),20),0),r={notation:g,minimumFractionDigits:A,maximumFractionDigits:A};return Object.assign(r,this.options.ticks.format),jf(l,m,r)},logarithmic(l,o,u){if(l===0)return"0";const m=u[o].significand||l/Math.pow(10,Math.floor(sl(l)));return[1,2,3,5,10,15].includes(m)||o>.8*u.length?IM.numeric.call(this,l,o,u):""}};function OP(l,o){let u=o.length>3?o[2].value-o[1].value:o[1].value-o[0].value;return Math.abs(u)>=1&&l!==Math.floor(l)&&(u=l-Math.floor(l)),u}var K_={formatters:IM};function FP(l){l.set("scale",{display:!0,offset:!1,reverse:!1,beginAtZero:!1,bounds:"ticks",clip:!0,grace:0,grid:{display:!0,lineWidth:1,drawOnChartArea:!0,drawTicks:!0,tickLength:8,tickWidth:(o,u)=>u.lineWidth,tickColor:(o,u)=>u.color,offset:!1},border:{display:!0,dash:[],dashOffset:0,width:1},title:{display:!1,text:"",padding:{top:4,bottom:4}},ticks:{minRotation:0,maxRotation:50,mirror:!1,textStrokeWidth:0,textStrokeColor:"",padding:3,display:!0,autoSkip:!0,autoSkipPadding:3,labelOffset:0,callback:K_.formatters.values,minor:{},major:{},align:"center",crossAlign:"near",showLabelBackdrop:!1,backdropColor:"rgba(255, 255, 255, 0.75)",backdropPadding:2}}),l.route("scale.ticks","color","","color"),l.route("scale.grid","color","","borderColor"),l.route("scale.border","color","","borderColor"),l.route("scale.title","color","","color"),l.describe("scale",{_fallback:!1,_scriptable:o=>!o.startsWith("before")&&!o.startsWith("after")&&o!=="callback"&&o!=="parser",_indexable:o=>o!=="borderDash"&&o!=="tickBorderDash"&&o!=="dash"}),l.describe("scales",{_fallback:"scale"}),l.describe("scale.ticks",{_scriptable:o=>o!=="backdropPadding"&&o!=="callback",_indexable:o=>o!=="backdropPadding"})}const Sc=Object.create(null),I0=Object.create(null);function Ef(l,o){if(!o)return l;const u=o.split(".");for(let m=0,g=u.length;m<g;++m){const b=u[m];l=l[b]||(l[b]=Object.create(null))}return l}function n0(l,o,u){return typeof o=="string"?Df(Ef(l,o),u):Df(Ef(l,""),o)}class BP{constructor(o,u){this.animation=void 0,this.backgroundColor="rgba(0,0,0,0.1)",this.borderColor="rgba(0,0,0,0.1)",this.color="#666",this.datasets={},this.devicePixelRatio=m=>m.chart.platform.getDevicePixelRatio(),this.elements={},this.events=["mousemove","mouseout","click","touchstart","touchmove"],this.font={family:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",size:12,style:"normal",lineHeight:1.2,weight:null},this.hover={},this.hoverBackgroundColor=(m,g)=>i0(g.backgroundColor),this.hoverBorderColor=(m,g)=>i0(g.borderColor),this.hoverColor=(m,g)=>i0(g.color),this.indexAxis="x",this.interaction={mode:"nearest",intersect:!0,includeInvisible:!1},this.maintainAspectRatio=!0,this.onHover=null,this.onClick=null,this.parsing=!0,this.plugins={},this.responsive=!0,this.scale=void 0,this.scales={},this.showLine=!0,this.drawActiveElementsOnTop=!0,this.describe(o),this.apply(u)}set(o,u){return n0(this,o,u)}get(o){return Ef(this,o)}describe(o,u){return n0(I0,o,u)}override(o,u){return n0(Sc,o,u)}route(o,u,m,g){const b=Ef(this,o),M=Ef(this,m),A="_"+u;Object.defineProperties(b,{[A]:{value:b[u],writable:!0},[u]:{enumerable:!0,get(){const r=this[A],k=M[g];return en(r)?Object.assign({},k,r):Fi(r,k)},set(r){this[A]=r}}})}apply(o){o.forEach(u=>u(this))}}var er=new BP({_scriptable:l=>!l.startsWith("on"),_indexable:l=>l!=="events",hover:{_fallback:"interaction"},interaction:{_scriptable:!1,_indexable:!1}},[RP,zP,FP]);function NP(l){return!l||cn(l.size)||cn(l.family)?null:(l.style?l.style+" ":"")+(l.weight?l.weight+" ":"")+l.size+"px "+l.family}function O_(l,o,u,m,g){let b=o[g];return b||(b=o[g]=l.measureText(g).width,u.push(g)),b>m&&(m=b),m}function VP(l,o,u,m){m=m||{};let g=m.data=m.data||{},b=m.garbageCollect=m.garbageCollect||[];m.font!==o&&(g=m.data={},b=m.garbageCollect=[],m.font=o),l.save(),l.font=o;let M=0;const A=u.length;let r,k,F,N,W;for(r=0;r<A;r++)if(N=u[r],N!=null&&!qn(N))M=O_(l,g,b,M,N);else if(qn(N))for(k=0,F=N.length;k<F;k++)W=N[k],W!=null&&!qn(W)&&(M=O_(l,g,b,M,W));l.restore();const Q=b.length/2;if(Q>u.length){for(r=0;r<Q;r++)delete g[b[r]];b.splice(0,Q)}return M}function gc(l,o,u){const m=l.currentDevicePixelRatio,g=u!==0?Math.max(u/2,.5):0;return Math.round((o-g)*m)/m+g}function dw(l,o){!o&&!l||(o=o||l.getContext("2d"),o.save(),o.resetTransform(),o.clearRect(0,0,l.width,l.height),o.restore())}function C0(l,o,u,m){CM(l,o,u,m,null)}function CM(l,o,u,m,g){let b,M,A,r,k,F,N,W;const Q=o.pointStyle,te=o.rotation,ce=o.radius;let de=(te||0)*bP;if(Q&&typeof Q=="object"&&(b=Q.toString(),b==="[object HTMLImageElement]"||b==="[object HTMLCanvasElement]")){l.save(),l.translate(u,m),l.rotate(de),l.drawImage(Q,-Q.width/2,-Q.height/2,Q.width,Q.height),l.restore();return}if(!(isNaN(ce)||ce<=0)){switch(l.beginPath(),Q){default:g?l.ellipse(u,m,g/2,ce,0,0,Nn):l.arc(u,m,ce,0,Nn),l.closePath();break;case"triangle":F=g?g/2:ce,l.moveTo(u+Math.sin(de)*F,m-Math.cos(de)*ce),de+=rw,l.lineTo(u+Math.sin(de)*F,m-Math.cos(de)*ce),de+=rw,l.lineTo(u+Math.sin(de)*F,m-Math.cos(de)*ce),l.closePath();break;case"rectRounded":k=ce*.516,r=ce-k,M=Math.cos(de+_c)*r,N=Math.cos(de+_c)*(g?g/2-k:r),A=Math.sin(de+_c)*r,W=Math.sin(de+_c)*(g?g/2-k:r),l.arc(u-N,m-A,k,de-Vn,de-ar),l.arc(u+W,m-M,k,de-ar,de),l.arc(u+N,m+A,k,de,de+ar),l.arc(u-W,m+M,k,de+ar,de+Vn),l.closePath();break;case"rect":if(!te){r=Math.SQRT1_2*ce,F=g?g/2:r,l.rect(u-F,m-r,2*F,2*r);break}de+=_c;case"rectRot":N=Math.cos(de)*(g?g/2:ce),M=Math.cos(de)*ce,A=Math.sin(de)*ce,W=Math.sin(de)*(g?g/2:ce),l.moveTo(u-N,m-A),l.lineTo(u+W,m-M),l.lineTo(u+N,m+A),l.lineTo(u-W,m+M),l.closePath();break;case"crossRot":de+=_c;case"cross":N=Math.cos(de)*(g?g/2:ce),M=Math.cos(de)*ce,A=Math.sin(de)*ce,W=Math.sin(de)*(g?g/2:ce),l.moveTo(u-N,m-A),l.lineTo(u+N,m+A),l.moveTo(u+W,m-M),l.lineTo(u-W,m+M);break;case"star":N=Math.cos(de)*(g?g/2:ce),M=Math.cos(de)*ce,A=Math.sin(de)*ce,W=Math.sin(de)*(g?g/2:ce),l.moveTo(u-N,m-A),l.lineTo(u+N,m+A),l.moveTo(u+W,m-M),l.lineTo(u-W,m+M),de+=_c,N=Math.cos(de)*(g?g/2:ce),M=Math.cos(de)*ce,A=Math.sin(de)*ce,W=Math.sin(de)*(g?g/2:ce),l.moveTo(u-N,m-A),l.lineTo(u+N,m+A),l.moveTo(u+W,m-M),l.lineTo(u-W,m+M);break;case"line":M=g?g/2:Math.cos(de)*ce,A=Math.sin(de)*ce,l.moveTo(u-M,m-A),l.lineTo(u+M,m+A);break;case"dash":l.moveTo(u,m),l.lineTo(u+Math.cos(de)*(g?g/2:ce),m+Math.sin(de)*ce);break;case!1:l.closePath();break}l.fill(),o.borderWidth>0&&l.stroke()}}function ha(l,o,u){return u=u||.5,!o||l&&l.x>o.left-u&&l.x<o.right+u&&l.y>o.top-u&&l.y<o.bottom+u}function J_(l,o){l.save(),l.beginPath(),l.rect(o.left,o.top,o.right-o.left,o.bottom-o.top),l.clip()}function eg(l){l.restore()}function UP(l,o,u,m,g){if(!o)return l.lineTo(u.x,u.y);if(g==="middle"){const b=(o.x+u.x)/2;l.lineTo(b,o.y),l.lineTo(b,u.y)}else g==="after"!=!!m?l.lineTo(o.x,u.y):l.lineTo(u.x,o.y);l.lineTo(u.x,u.y)}function jP(l,o,u,m){if(!o)return l.lineTo(u.x,u.y);l.bezierCurveTo(m?o.cp1x:o.cp2x,m?o.cp1y:o.cp2y,m?u.cp2x:u.cp1x,m?u.cp2y:u.cp1y,u.x,u.y)}function GP(l,o){o.translation&&l.translate(o.translation[0],o.translation[1]),cn(o.rotation)||l.rotate(o.rotation),o.color&&(l.fillStyle=o.color),o.textAlign&&(l.textAlign=o.textAlign),o.textBaseline&&(l.textBaseline=o.textBaseline)}function WP(l,o,u,m,g){if(g.strikethrough||g.underline){const b=l.measureText(m),M=o-b.actualBoundingBoxLeft,A=o+b.actualBoundingBoxRight,r=u-b.actualBoundingBoxAscent,k=u+b.actualBoundingBoxDescent,F=g.strikethrough?(r+k)/2:k;l.strokeStyle=l.fillStyle,l.beginPath(),l.lineWidth=g.decorationWidth||2,l.moveTo(M,F),l.lineTo(A,F),l.stroke()}}function qP(l,o){const u=l.fillStyle;l.fillStyle=o.color,l.fillRect(o.left,o.top,o.width,o.height),l.fillStyle=u}function Ec(l,o,u,m,g,b={}){const M=qn(o)?o:[o],A=b.strokeWidth>0&&b.strokeColor!=="";let r,k;for(l.save(),l.font=g.string,GP(l,b),r=0;r<M.length;++r)k=M[r],b.backdrop&&qP(l,b.backdrop),A&&(b.strokeColor&&(l.strokeStyle=b.strokeColor),cn(b.strokeWidth)||(l.lineWidth=b.strokeWidth),l.strokeText(k,u,m,b.maxWidth)),l.fillText(k,u,m,b.maxWidth),WP(l,u,m,k,b),m+=Number(g.lineHeight);l.restore()}function zf(l,o){const{x:u,y:m,w:g,h:b,radius:M}=o;l.arc(u+M.topLeft,m+M.topLeft,M.topLeft,1.5*Vn,Vn,!0),l.lineTo(u,m+b-M.bottomLeft),l.arc(u+M.bottomLeft,m+b-M.bottomLeft,M.bottomLeft,Vn,ar,!0),l.lineTo(u+g-M.bottomRight,m+b),l.arc(u+g-M.bottomRight,m+b-M.bottomRight,M.bottomRight,ar,0,!0),l.lineTo(u+g,m+M.topRight),l.arc(u+g-M.topRight,m+M.topRight,M.topRight,0,-ar,!0),l.lineTo(u+M.topLeft,m)}const HP=/^(normal|(\d+(?:\.\d+)?)(px|em|%)?)$/,ZP=/^(normal|italic|initial|inherit|unset|(oblique( -?[0-9]?[0-9]deg)?))$/;function $P(l,o){const u=(""+l).match(HP);if(!u||u[1]==="normal")return o*1.2;switch(l=+u[2],u[3]){case"px":return l;case"%":l/=100;break}return o*l}const YP=l=>+l||0;function sx(l,o){const u={},m=en(o),g=m?Object.keys(o):o,b=en(l)?m?M=>Fi(l[M],l[o[M]]):M=>l[M]:()=>l;for(const M of g)u[M]=YP(b(M));return u}function PM(l){return sx(l,{top:"y",right:"x",bottom:"y",left:"x"})}function Tc(l){return sx(l,["topLeft","topRight","bottomLeft","bottomRight"])}function qr(l){const o=PM(l);return o.width=o.left+o.right,o.height=o.top+o.bottom,o}function br(l,o){l=l||{},o=o||er.font;let u=Fi(l.size,o.size);typeof u=="string"&&(u=parseInt(u,10));let m=Fi(l.style,o.style);m&&!(""+m).match(ZP)&&(console.warn('Invalid font style specified: "'+m+'"'),m=void 0);const g={family:Fi(l.family,o.family),lineHeight:$P(Fi(l.lineHeight,o.lineHeight),u),size:u,style:m,weight:Fi(l.weight,o.weight),string:""};return g.string=NP(g),g}function pf(l,o,u,m){let g,b,M;for(g=0,b=l.length;g<b;++g)if(M=l[g],M!==void 0&&M!==void 0)return M}function QP(l,o,u){const{min:m,max:g}=l,b=yM(o,(g-m)/2),M=(A,r)=>u&&A===0?0:A+r;return{min:M(m,-Math.abs(b)),max:M(g,b)}}function hl(l,o){return Object.assign(Object.create(l),o)}function ox(l,o=[""],u,m,g=()=>l[0]){const b=u||l;typeof m>"u"&&(m=zM("_fallback",l));const M={[Symbol.toStringTag]:"Object",_cacheable:!0,_scopes:l,_rootScopes:b,_fallback:m,_getTarget:g,override:A=>ox([A,...l],o,b,m)};return new Proxy(M,{deleteProperty(A,r){return delete A[r],delete A._keys,delete l[0][r],!0},get(A,r){return kM(A,r,()=>rD(r,o,l,A))},getOwnPropertyDescriptor(A,r){return Reflect.getOwnPropertyDescriptor(A._scopes[0],r)},getPrototypeOf(){return Reflect.getPrototypeOf(l[0])},has(A,r){return pw(A).includes(r)},ownKeys(A){return pw(A)},set(A,r,k){const F=A._storage||(A._storage=g());return A[r]=F[r]=k,delete A._keys,!0}})}function dh(l,o,u,m){const g={_cacheable:!1,_proxy:l,_context:o,_subProxy:u,_stack:new Set,_descriptors:DM(l,m),setContext:b=>dh(l,b,u,m),override:b=>dh(l.override(b),o,u,m)};return new Proxy(g,{deleteProperty(b,M){return delete b[M],delete l[M],!0},get(b,M,A){return kM(b,M,()=>KP(b,M,A))},getOwnPropertyDescriptor(b,M){return b._descriptors.allKeys?Reflect.has(l,M)?{enumerable:!0,configurable:!0}:void 0:Reflect.getOwnPropertyDescriptor(l,M)},getPrototypeOf(){return Reflect.getPrototypeOf(l)},has(b,M){return Reflect.has(l,M)},ownKeys(){return Reflect.ownKeys(l)},set(b,M,A){return l[M]=A,delete b[M],!0}})}function DM(l,o={scriptable:!0,indexable:!0}){const{_scriptable:u=o.scriptable,_indexable:m=o.indexable,_allKeys:g=o.allKeys}=l;return{allKeys:g,scriptable:u,indexable:m,isScriptable:ul(u)?u:()=>u,isIndexable:ul(m)?m:()=>m}}const XP=(l,o)=>l?l+ex(o):o,ax=(l,o)=>en(o)&&l!=="adapters"&&(Object.getPrototypeOf(o)===null||o.constructor===Object);function kM(l,o,u){if(Object.prototype.hasOwnProperty.call(l,o)||o==="constructor")return l[o];const m=u();return l[o]=m,m}function KP(l,o,u){const{_proxy:m,_context:g,_subProxy:b,_descriptors:M}=l;let A=m[o];return ul(A)&&M.isScriptable(o)&&(A=JP(o,A,l,u)),qn(A)&&A.length&&(A=eD(o,A,l,M.isIndexable)),ax(o,A)&&(A=dh(A,g,b&&b[o],M)),A}function JP(l,o,u,m){const{_proxy:g,_context:b,_subProxy:M,_stack:A}=u;if(A.has(l))throw new Error("Recursion detected: "+Array.from(A).join("->")+"->"+l);A.add(l);let r=o(b,M||m);return A.delete(l),ax(l,r)&&(r=lx(g._scopes,g,l,r)),r}function eD(l,o,u,m){const{_proxy:g,_context:b,_subProxy:M,_descriptors:A}=u;if(typeof b.index<"u"&&m(l))return o[b.index%o.length];if(en(o[0])){const r=o,k=g._scopes.filter(F=>F!==r);o=[];for(const F of r){const N=lx(k,g,l,F);o.push(dh(N,b,M&&M[l],A))}}return o}function RM(l,o,u){return ul(l)?l(o,u):l}const tD=(l,o)=>l===!0?o:typeof l=="string"?cl(o,l):void 0;function iD(l,o,u,m,g){for(const b of o){const M=tD(u,b);if(M){l.add(M);const A=RM(M._fallback,u,g);if(typeof A<"u"&&A!==u&&A!==m)return A}else if(M===!1&&typeof m<"u"&&u!==m)return null}return!1}function lx(l,o,u,m){const g=o._rootScopes,b=RM(o._fallback,u,m),M=[...l,...g],A=new Set;A.add(m);let r=fw(A,M,u,b||u,m);return r===null||typeof b<"u"&&b!==u&&(r=fw(A,M,b,r,m),r===null)?!1:ox(Array.from(A),[""],g,b,()=>nD(o,u,m))}function fw(l,o,u,m,g){for(;u;)u=iD(l,o,u,m,g);return u}function nD(l,o,u){const m=l._getTarget();o in m||(m[o]={});const g=m[o];return qn(g)&&en(u)?u:g||{}}function rD(l,o,u,m){let g;for(const b of o)if(g=zM(XP(b,l),u),typeof g<"u")return ax(l,g)?lx(u,m,l,g):g}function zM(l,o){for(const u of o){if(!u)continue;const m=u[l];if(typeof m<"u")return m}}function pw(l){let o=l._keys;return o||(o=l._keys=sD(l._scopes)),o}function sD(l){const o=new Set;for(const u of l)for(const m of Object.keys(u).filter(g=>!g.startsWith("_")))o.add(m);return Array.from(o)}function LM(l,o,u,m){const{iScale:g}=l,{key:b="r"}=this._parsing,M=new Array(m);let A,r,k,F;for(A=0,r=m;A<r;++A)k=A+u,F=o[k],M[A]={r:g.parse(cl(F,b),k)};return M}const oD=Number.EPSILON||1e-14,fh=(l,o)=>o<l.length&&!l[o].skip&&l[o],OM=l=>l==="x"?"y":"x";function aD(l,o,u,m){const g=l.skip?o:l,b=o,M=u.skip?o:u,A=A0(b,g),r=A0(M,b);let k=A/(A+r),F=r/(A+r);k=isNaN(k)?0:k,F=isNaN(F)?0:F;const N=m*k,W=m*F;return{previous:{x:b.x-N*(M.x-g.x),y:b.y-N*(M.y-g.y)},next:{x:b.x+W*(M.x-g.x),y:b.y+W*(M.y-g.y)}}}function lD(l,o,u){const m=l.length;let g,b,M,A,r,k=fh(l,0);for(let F=0;F<m-1;++F)if(r=k,k=fh(l,F+1),!(!r||!k)){if(Mf(o[F],0,oD)){u[F]=u[F+1]=0;continue}g=u[F]/o[F],b=u[F+1]/o[F],A=Math.pow(g,2)+Math.pow(b,2),!(A<=9)&&(M=3/Math.sqrt(A),u[F]=g*M*o[F],u[F+1]=b*M*o[F])}}function cD(l,o,u="x"){const m=OM(u),g=l.length;let b,M,A,r=fh(l,0);for(let k=0;k<g;++k){if(M=A,A=r,r=fh(l,k+1),!A)continue;const F=A[u],N=A[m];M&&(b=(F-M[u])/3,A[`cp1${u}`]=F-b,A[`cp1${m}`]=N-b*o[k]),r&&(b=(r[u]-F)/3,A[`cp2${u}`]=F+b,A[`cp2${m}`]=N+b*o[k])}}function uD(l,o="x"){const u=OM(o),m=l.length,g=Array(m).fill(0),b=Array(m);let M,A,r,k=fh(l,0);for(M=0;M<m;++M)if(A=r,r=k,k=fh(l,M+1),!!r){if(k){const F=k[o]-r[o];g[M]=F!==0?(k[u]-r[u])/F:0}b[M]=A?k?Co(g[M-1])!==Co(g[M])?0:(g[M-1]+g[M])/2:g[M-1]:g[M]}lD(l,g,b),cD(l,b,o)}function r_(l,o,u){return Math.max(Math.min(l,u),o)}function hD(l,o){let u,m,g,b,M,A=ha(l[0],o);for(u=0,m=l.length;u<m;++u)M=b,b=A,A=u<m-1&&ha(l[u+1],o),b&&(g=l[u],M&&(g.cp1x=r_(g.cp1x,o.left,o.right),g.cp1y=r_(g.cp1y,o.top,o.bottom)),A&&(g.cp2x=r_(g.cp2x,o.left,o.right),g.cp2y=r_(g.cp2y,o.top,o.bottom)))}function dD(l,o,u,m,g){let b,M,A,r;if(o.spanGaps&&(l=l.filter(k=>!k.skip)),o.cubicInterpolationMode==="monotone")uD(l,g);else{let k=m?l[l.length-1]:l[0];for(b=0,M=l.length;b<M;++b)A=l[b],r=aD(k,A,l[Math.min(b+1,M-(m?0:1))%M],o.tension),A.cp1x=r.previous.x,A.cp1y=r.previous.y,A.cp2x=r.next.x,A.cp2y=r.next.y,k=A}o.capBezierPoints&&hD(l,u)}function cx(){return typeof window<"u"&&typeof document<"u"}function ux(l){let o=l.parentNode;return o&&o.toString()==="[object ShadowRoot]"&&(o=o.host),o}function F_(l,o,u){let m;return typeof l=="string"?(m=parseInt(l,10),l.indexOf("%")!==-1&&(m=m/100*o.parentNode[u])):m=l,m}const tg=l=>l.ownerDocument.defaultView.getComputedStyle(l,null);function fD(l,o){return tg(l).getPropertyValue(o)}const pD=["top","right","bottom","left"];function Mc(l,o,u){const m={};u=u?"-"+u:"";for(let g=0;g<4;g++){const b=pD[g];m[b]=parseFloat(l[o+"-"+b+u])||0}return m.width=m.left+m.right,m.height=m.top+m.bottom,m}const mD=(l,o,u)=>(l>0||o>0)&&(!u||!u.shadowRoot);function _D(l,o){const u=l.touches,m=u&&u.length?u[0]:l,{offsetX:g,offsetY:b}=m;let M=!1,A,r;if(mD(g,b,l.target))A=g,r=b;else{const k=o.getBoundingClientRect();A=m.clientX-k.left,r=m.clientY-k.top,M=!0}return{x:A,y:r,box:M}}function vc(l,o){if("native"in l)return l;const{canvas:u,currentDevicePixelRatio:m}=o,g=tg(u),b=g.boxSizing==="border-box",M=Mc(g,"padding"),A=Mc(g,"border","width"),{x:r,y:k,box:F}=_D(l,u),N=M.left+(F&&A.left),W=M.top+(F&&A.top);let{width:Q,height:te}=o;return b&&(Q-=M.width+A.width,te-=M.height+A.height),{x:Math.round((r-N)/Q*u.width/m),y:Math.round((k-W)/te*u.height/m)}}function gD(l,o,u){let m,g;if(o===void 0||u===void 0){const b=l&&ux(l);if(!b)o=l.clientWidth,u=l.clientHeight;else{const M=b.getBoundingClientRect(),A=tg(b),r=Mc(A,"border","width"),k=Mc(A,"padding");o=M.width-k.width-r.width,u=M.height-k.height-r.height,m=F_(A.maxWidth,b,"clientWidth"),g=F_(A.maxHeight,b,"clientHeight")}}return{width:o,height:u,maxWidth:m||L_,maxHeight:g||L_}}const s_=l=>Math.round(l*10)/10;function yD(l,o,u,m){const g=tg(l),b=Mc(g,"margin"),M=F_(g.maxWidth,l,"clientWidth")||L_,A=F_(g.maxHeight,l,"clientHeight")||L_,r=gD(l,o,u);let{width:k,height:F}=r;if(g.boxSizing==="content-box"){const W=Mc(g,"border","width"),Q=Mc(g,"padding");k-=Q.width+W.width,F-=Q.height+W.height}return k=Math.max(0,k-b.width),F=Math.max(0,m?k/m:F-b.height),k=s_(Math.min(k,M,r.maxWidth)),F=s_(Math.min(F,A,r.maxHeight)),k&&!F&&(F=s_(k/2)),(o!==void 0||u!==void 0)&&m&&r.height&&F>r.height&&(F=r.height,k=s_(Math.floor(F*m))),{width:k,height:F}}function mw(l,o,u){const m=o||1,g=Math.floor(l.height*m),b=Math.floor(l.width*m);l.height=Math.floor(l.height),l.width=Math.floor(l.width);const M=l.canvas;return M.style&&(u||!M.style.height&&!M.style.width)&&(M.style.height=`${l.height}px`,M.style.width=`${l.width}px`),l.currentDevicePixelRatio!==m||M.height!==g||M.width!==b?(l.currentDevicePixelRatio=m,M.height=g,M.width=b,l.ctx.setTransform(m,0,0,m,0,0),!0):!1}const xD=function(){let l=!1;try{const o={get passive(){return l=!0,!1}};cx()&&(window.addEventListener("test",null,o),window.removeEventListener("test",null,o))}catch{}return l}();function _w(l,o){const u=fD(l,o),m=u&&u.match(/^(\d+)(\.\d+)?px$/);return m?+m[1]:void 0}function bc(l,o,u,m){return{x:l.x+u*(o.x-l.x),y:l.y+u*(o.y-l.y)}}function vD(l,o,u,m){return{x:l.x+u*(o.x-l.x),y:m==="middle"?u<.5?l.y:o.y:m==="after"?u<1?l.y:o.y:u>0?o.y:l.y}}function bD(l,o,u,m){const g={x:l.cp2x,y:l.cp2y},b={x:o.cp1x,y:o.cp1y},M=bc(l,g,u),A=bc(g,b,u),r=bc(b,o,u),k=bc(M,A,u),F=bc(A,r,u);return bc(k,F,u)}const wD=function(l,o){return{x(u){return l+l+o-u},setWidth(u){o=u},textAlign(u){return u==="center"?u:u==="right"?"left":"right"},xPlus(u,m){return u-m},leftForLtr(u,m){return u-m}}},TD=function(){return{x(l){return l},setWidth(l){},textAlign(l){return l},xPlus(l,o){return l+o},leftForLtr(l,o){return l}}};function uh(l,o,u){return l?wD(o,u):TD()}function FM(l,o){let u,m;(o==="ltr"||o==="rtl")&&(u=l.canvas.style,m=[u.getPropertyValue("direction"),u.getPropertyPriority("direction")],u.setProperty("direction",o,"important"),l.prevTextDirection=m)}function BM(l,o){o!==void 0&&(delete l.prevTextDirection,l.canvas.style.setProperty("direction",o[0],o[1]))}function NM(l){return l==="angle"?{between:Rf,compare:MP,normalize:Is}:{between:ca,compare:(o,u)=>o-u,normalize:o=>o}}function gw({start:l,end:o,count:u,loop:m,style:g}){return{start:l%u,end:o%u,loop:m&&(o-l+1)%u===0,style:g}}function MD(l,o,u){const{property:m,start:g,end:b}=u,{between:M,normalize:A}=NM(m),r=o.length;let{start:k,end:F,loop:N}=l,W,Q;if(N){for(k+=r,F+=r,W=0,Q=r;W<Q&&M(A(o[k%r][m]),g,b);++W)k--,F--;k%=r,F%=r}return F<k&&(F+=r),{start:k,end:F,loop:N,style:l.style}}function VM(l,o,u){if(!u)return[l];const{property:m,start:g,end:b}=u,M=o.length,{compare:A,between:r,normalize:k}=NM(m),{start:F,end:N,loop:W,style:Q}=MD(l,o,u),te=[];let ce=!1,de=null,ve,Te,Ee;const Me=()=>r(g,Ee,ve)&&A(g,Ee)!==0,Ie=()=>A(b,ve)===0||r(b,Ee,ve),qe=()=>ce||Me(),Ve=()=>!ce||Ie();for(let nt=F,lt=F;nt<=N;++nt)Te=o[nt%M],!Te.skip&&(ve=k(Te[m]),ve!==Ee&&(ce=r(ve,g,b),de===null&&qe()&&(de=A(ve,g)===0?nt:lt),de!==null&&Ve()&&(te.push(gw({start:de,end:nt,loop:W,count:M,style:Q})),de=null),lt=nt,Ee=ve));return de!==null&&te.push(gw({start:de,end:N,loop:W,count:M,style:Q})),te}function UM(l,o){const u=[],m=l.segments;for(let g=0;g<m.length;g++){const b=VM(m[g],l.points,o);b.length&&u.push(...b)}return u}function SD(l,o,u,m){let g=0,b=o-1;if(u&&!m)for(;g<o&&!l[g].skip;)g++;for(;g<o&&l[g].skip;)g++;for(g%=o,u&&(b+=g);b>g&&l[b%o].skip;)b--;return b%=o,{start:g,end:b}}function ED(l,o,u,m){const g=l.length,b=[];let M=o,A=l[o],r;for(r=o+1;r<=u;++r){const k=l[r%g];k.skip||k.stop?A.skip||(m=!1,b.push({start:o%g,end:(r-1)%g,loop:m}),o=M=k.stop?r:null):(M=r,A.skip&&(o=r)),A=k}return M!==null&&b.push({start:o%g,end:M%g,loop:m}),b}function AD(l,o){const u=l.points,m=l.options.spanGaps,g=u.length;if(!g)return[];const b=!!l._loop,{start:M,end:A}=SD(u,g,b,m);if(m===!0)return yw(l,[{start:M,end:A,loop:b}],u,o);const r=A<M?A+g:A,k=!!l._fullLoop&&M===0&&A===g-1;return yw(l,ED(u,M,r,k),u,o)}function yw(l,o,u,m){return!m||!m.setContext||!u?o:ID(l,o,u,m)}function ID(l,o,u,m){const g=l._chart.getContext(),b=xw(l.options),{_datasetIndex:M,options:{spanGaps:A}}=l,r=u.length,k=[];let F=b,N=o[0].start,W=N;function Q(te,ce,de,ve){const Te=A?-1:1;if(te!==ce){for(te+=r;u[te%r].skip;)te-=Te;for(;u[ce%r].skip;)ce+=Te;te%r!==ce%r&&(k.push({start:te%r,end:ce%r,loop:de,style:ve}),F=ve,N=ce%r)}}for(const te of o){N=A?N:te.start;let ce=u[N%r],de;for(W=N+1;W<=te.end;W++){const ve=u[W%r];de=xw(m.setContext(hl(g,{type:"segment",p0:ce,p1:ve,p0DataIndex:(W-1)%r,p1DataIndex:W%r,datasetIndex:M}))),CD(de,F)&&Q(N,W-1,te.loop,F),ce=ve,F=de}N<W-1&&Q(N,W-1,te.loop,F)}return k}function xw(l){return{backgroundColor:l.backgroundColor,borderCapStyle:l.borderCapStyle,borderDash:l.borderDash,borderDashOffset:l.borderDashOffset,borderJoinStyle:l.borderJoinStyle,borderWidth:l.borderWidth,borderColor:l.borderColor}}function CD(l,o){if(!o)return!1;const u=[],m=function(g,b){return rx(b)?(u.includes(b)||u.push(b),u.indexOf(b)):b};return JSON.stringify(l,m)!==JSON.stringify(o,m)}/*!
 * Chart.js v4.4.3
 * https://www.chartjs.org
 * (c) 2024 Chart.js Contributors
 * Released under the MIT License
 */class PD{constructor(){this._request=null,this._charts=new Map,this._running=!1,this._lastDate=void 0}_notify(o,u,m,g){const b=u.listeners[g],M=u.duration;b.forEach(A=>A({chart:o,initial:u.initial,numSteps:M,currentStep:Math.min(m-u.start,M)}))}_refresh(){this._request||(this._running=!0,this._request=MM.call(window,()=>{this._update(),this._request=null,this._running&&this._refresh()}))}_update(o=Date.now()){let u=0;this._charts.forEach((m,g)=>{if(!m.running||!m.items.length)return;const b=m.items;let M=b.length-1,A=!1,r;for(;M>=0;--M)r=b[M],r._active?(r._total>m.duration&&(m.duration=r._total),r.tick(o),A=!0):(b[M]=b[b.length-1],b.pop());A&&(g.draw(),this._notify(g,m,o,"progress")),b.length||(m.running=!1,this._notify(g,m,o,"complete"),m.initial=!1),u+=b.length}),this._lastDate=o,u===0&&(this._running=!1)}_getAnims(o){const u=this._charts;let m=u.get(o);return m||(m={running:!1,initial:!0,items:[],listeners:{complete:[],progress:[]}},u.set(o,m)),m}listen(o,u,m){this._getAnims(o).listeners[u].push(m)}add(o,u){!u||!u.length||this._getAnims(o).items.push(...u)}has(o){return this._getAnims(o).items.length>0}start(o){const u=this._charts.get(o);u&&(u.running=!0,u.start=Date.now(),u.duration=u.items.reduce((m,g)=>Math.max(m,g._duration),0),this._refresh())}running(o){if(!this._running)return!1;const u=this._charts.get(o);return!(!u||!u.running||!u.items.length)}stop(o){const u=this._charts.get(o);if(!u||!u.items.length)return;const m=u.items;let g=m.length-1;for(;g>=0;--g)m[g].cancel();u.items=[],this._notify(o,u,Date.now(),"complete")}remove(o){return this._charts.delete(o)}}var sa=new PD;const vw="transparent",DD={boolean(l,o,u){return u>.5?o:l},color(l,o,u){const m=uw(l||vw),g=m.valid&&uw(o||vw);return g&&g.valid?g.mix(m,u).hexString():o},number(l,o,u){return l+(o-l)*u}};class kD{constructor(o,u,m,g){const b=u[m];g=pf([o.to,g,b,o.from]);const M=pf([o.from,b,g]);this._active=!0,this._fn=o.fn||DD[o.type||typeof M],this._easing=Sf[o.easing]||Sf.linear,this._start=Math.floor(Date.now()+(o.delay||0)),this._duration=this._total=Math.floor(o.duration),this._loop=!!o.loop,this._target=u,this._prop=m,this._from=M,this._to=g,this._promises=void 0}active(){return this._active}update(o,u,m){if(this._active){this._notify(!1);const g=this._target[this._prop],b=m-this._start,M=this._duration-b;this._start=m,this._duration=Math.floor(Math.max(M,o.duration)),this._total+=b,this._loop=!!o.loop,this._to=pf([o.to,u,g,o.from]),this._from=pf([o.from,g,u])}}cancel(){this._active&&(this.tick(Date.now()),this._active=!1,this._notify(!1))}tick(o){const u=o-this._start,m=this._duration,g=this._prop,b=this._from,M=this._loop,A=this._to;let r;if(this._active=b!==A&&(M||u<m),!this._active){this._target[g]=A,this._notify(!0);return}if(u<0){this._target[g]=b;return}r=u/m%2,r=M&&r>1?2-r:r,r=this._easing(Math.min(1,Math.max(0,r))),this._target[g]=this._fn(b,A,r)}wait(){const o=this._promises||(this._promises=[]);return new Promise((u,m)=>{o.push({res:u,rej:m})})}_notify(o){const u=o?"res":"rej",m=this._promises||[];for(let g=0;g<m.length;g++)m[g][u]()}}class jM{constructor(o,u){this._chart=o,this._properties=new Map,this.configure(u)}configure(o){if(!en(o))return;const u=Object.keys(er.animation),m=this._properties;Object.getOwnPropertyNames(o).forEach(g=>{const b=o[g];if(!en(b))return;const M={};for(const A of u)M[A]=b[A];(qn(b.properties)&&b.properties||[g]).forEach(A=>{(A===g||!m.has(A))&&m.set(A,M)})})}_animateOptions(o,u){const m=u.options,g=zD(o,m);if(!g)return[];const b=this._createAnimations(g,m);return m.$shared&&RD(o.options.$animations,m).then(()=>{o.options=m},()=>{}),b}_createAnimations(o,u){const m=this._properties,g=[],b=o.$animations||(o.$animations={}),M=Object.keys(u),A=Date.now();let r;for(r=M.length-1;r>=0;--r){const k=M[r];if(k.charAt(0)==="$")continue;if(k==="options"){g.push(...this._animateOptions(o,u));continue}const F=u[k];let N=b[k];const W=m.get(k);if(N)if(W&&N.active()){N.update(W,F,A);continue}else N.cancel();if(!W||!W.duration){o[k]=F;continue}b[k]=N=new kD(W,o,k,F),g.push(N)}return g}update(o,u){if(this._properties.size===0){Object.assign(o,u);return}const m=this._createAnimations(o,u);if(m.length)return sa.add(this._chart,m),!0}}function RD(l,o){const u=[],m=Object.keys(o);for(let g=0;g<m.length;g++){const b=l[m[g]];b&&b.active()&&u.push(b.wait())}return Promise.all(u)}function zD(l,o){if(!o)return;let u=l.options;if(!u){l.options=o;return}return u.$shared&&(l.options=u=Object.assign({},u,{$shared:!1,$animations:{}})),u}function bw(l,o){const u=l&&l.options||{},m=u.reverse,g=u.min===void 0?o:0,b=u.max===void 0?o:0;return{start:m?b:g,end:m?g:b}}function LD(l,o,u){if(u===!1)return!1;const m=bw(l,u),g=bw(o,u);return{top:g.end,right:m.end,bottom:g.start,left:m.start}}function OD(l){let o,u,m,g;return en(l)?(o=l.top,u=l.right,m=l.bottom,g=l.left):o=u=m=g=l,{top:o,right:u,bottom:m,left:g,disabled:l===!1}}function GM(l,o){const u=[],m=l._getSortedDatasetMetas(o);let g,b;for(g=0,b=m.length;g<b;++g)u.push(m[g].index);return u}function ww(l,o,u,m={}){const g=l.keys,b=m.mode==="single";let M,A,r,k;if(o!==null){for(M=0,A=g.length;M<A;++M){if(r=+g[M],r===u){if(m.all)continue;break}k=l.values[r],Jn(k)&&(b||o===0||Co(o)===Co(k))&&(o+=k)}return o}}function FD(l,o){const{iScale:u,vScale:m}=o,g=u.axis==="x"?"x":"y",b=m.axis==="x"?"x":"y",M=Object.keys(l),A=new Array(M.length);let r,k,F;for(r=0,k=M.length;r<k;++r)F=M[r],A[r]={[g]:F,[b]:l[F]};return A}function Tw(l,o){const u=l&&l.options.stacked;return u||u===void 0&&o.stack!==void 0}function BD(l,o,u){return`${l.id}.${o.id}.${u.stack||u.type}`}function ND(l){const{min:o,max:u,minDefined:m,maxDefined:g}=l.getUserBounds();return{min:m?o:Number.NEGATIVE_INFINITY,max:g?u:Number.POSITIVE_INFINITY}}function VD(l,o,u){const m=l[o]||(l[o]={});return m[u]||(m[u]={})}function Mw(l,o,u,m){for(const g of o.getMatchingVisibleMetas(m).reverse()){const b=l[g.index];if(u&&b>0||!u&&b<0)return g.index}return null}function Sw(l,o){const{chart:u,_cachedMeta:m}=l,g=u._stacks||(u._stacks={}),{iScale:b,vScale:M,index:A}=m,r=b.axis,k=M.axis,F=BD(b,M,m),N=o.length;let W;for(let Q=0;Q<N;++Q){const te=o[Q],{[r]:ce,[k]:de}=te,ve=te._stacks||(te._stacks={});W=ve[k]=VD(g,F,ce),W[A]=de,W._top=Mw(W,M,!0,m.type),W._bottom=Mw(W,M,!1,m.type);const Te=W._visualValues||(W._visualValues={});Te[A]=de}}function r0(l,o){const u=l.scales;return Object.keys(u).filter(m=>u[m].axis===o).shift()}function UD(l,o){return hl(l,{active:!1,dataset:void 0,datasetIndex:o,index:o,mode:"default",type:"dataset"})}function jD(l,o,u){return hl(l,{active:!1,dataIndex:o,parsed:void 0,raw:void 0,element:u,index:o,mode:"default",type:"data"})}function rf(l,o){const u=l.controller.index,m=l.vScale&&l.vScale.axis;if(m){o=o||l._parsed;for(const g of o){const b=g._stacks;if(!b||b[m]===void 0||b[m][u]===void 0)return;delete b[m][u],b[m]._visualValues!==void 0&&b[m]._visualValues[u]!==void 0&&delete b[m]._visualValues[u]}}}const s0=l=>l==="reset"||l==="none",Ew=(l,o)=>o?l:Object.assign({},l),GD=(l,o,u)=>l&&!o.hidden&&o._stacked&&{keys:GM(u,!0),values:null};class co{constructor(o,u){this.chart=o,this._ctx=o.ctx,this.index=u,this._cachedDataOpts={},this._cachedMeta=this.getMeta(),this._type=this._cachedMeta.type,this.options=void 0,this._parsing=!1,this._data=void 0,this._objectData=void 0,this._sharedOptions=void 0,this._drawStart=void 0,this._drawCount=void 0,this.enableOptionSharing=!1,this.supportsDecimation=!1,this.$context=void 0,this._syncList=[],this.datasetElementType=new.target.datasetElementType,this.dataElementType=new.target.dataElementType,this.initialize()}initialize(){const o=this._cachedMeta;this.configure(),this.linkScales(),o._stacked=Tw(o.vScale,o),this.addElements(),this.options.fill&&!this.chart.isPluginEnabled("filler")&&console.warn("Tried to use the 'fill' option without the 'Filler' plugin enabled. Please import and register the 'Filler' plugin and make sure it is not disabled in the options")}updateIndex(o){this.index!==o&&rf(this._cachedMeta),this.index=o}linkScales(){const o=this.chart,u=this._cachedMeta,m=this.getDataset(),g=(N,W,Q,te)=>N==="x"?W:N==="r"?te:Q,b=u.xAxisID=Fi(m.xAxisID,r0(o,"x")),M=u.yAxisID=Fi(m.yAxisID,r0(o,"y")),A=u.rAxisID=Fi(m.rAxisID,r0(o,"r")),r=u.indexAxis,k=u.iAxisID=g(r,b,M,A),F=u.vAxisID=g(r,M,b,A);u.xScale=this.getScaleForId(b),u.yScale=this.getScaleForId(M),u.rScale=this.getScaleForId(A),u.iScale=this.getScaleForId(k),u.vScale=this.getScaleForId(F)}getDataset(){return this.chart.data.datasets[this.index]}getMeta(){return this.chart.getDatasetMeta(this.index)}getScaleForId(o){return this.chart.scales[o]}_getOtherScale(o){const u=this._cachedMeta;return o===u.iScale?u.vScale:u.iScale}reset(){this._update("reset")}_destroy(){const o=this._cachedMeta;this._data&&aw(this._data,this),o._stacked&&rf(o)}_dataCheck(){const o=this.getDataset(),u=o.data||(o.data=[]),m=this._data;if(en(u)){const g=this._cachedMeta;this._data=FD(u,g)}else if(m!==u){if(m){aw(m,this);const g=this._cachedMeta;rf(g),g._parsed=[]}u&&Object.isExtensible(u)&&IP(u,this),this._syncList=[],this._data=u}}addElements(){const o=this._cachedMeta;this._dataCheck(),this.datasetElementType&&(o.dataset=new this.datasetElementType)}buildOrUpdateElements(o){const u=this._cachedMeta,m=this.getDataset();let g=!1;this._dataCheck();const b=u._stacked;u._stacked=Tw(u.vScale,u),u.stack!==m.stack&&(g=!0,rf(u),u.stack=m.stack),this._resyncElements(o),(g||b!==u._stacked)&&Sw(this,u._parsed)}configure(){const o=this.chart.config,u=o.datasetScopeKeys(this._type),m=o.getOptionScopes(this.getDataset(),u,!0);this.options=o.createResolver(m,this.getContext()),this._parsing=this.options.parsing,this._cachedDataOpts={}}parse(o,u){const{_cachedMeta:m,_data:g}=this,{iScale:b,_stacked:M}=m,A=b.axis;let r=o===0&&u===g.length?!0:m._sorted,k=o>0&&m._parsed[o-1],F,N,W;if(this._parsing===!1)m._parsed=g,m._sorted=!0,W=g;else{qn(g[o])?W=this.parseArrayData(m,g,o,u):en(g[o])?W=this.parseObjectData(m,g,o,u):W=this.parsePrimitiveData(m,g,o,u);const Q=()=>N[A]===null||k&&N[A]<k[A];for(F=0;F<u;++F)m._parsed[F+o]=N=W[F],r&&(Q()&&(r=!1),k=N);m._sorted=r}M&&Sw(this,W)}parsePrimitiveData(o,u,m,g){const{iScale:b,vScale:M}=o,A=b.axis,r=M.axis,k=b.getLabels(),F=b===M,N=new Array(g);let W,Q,te;for(W=0,Q=g;W<Q;++W)te=W+m,N[W]={[A]:F||b.parse(k[te],te),[r]:M.parse(u[te],te)};return N}parseArrayData(o,u,m,g){const{xScale:b,yScale:M}=o,A=new Array(g);let r,k,F,N;for(r=0,k=g;r<k;++r)F=r+m,N=u[F],A[r]={x:b.parse(N[0],F),y:M.parse(N[1],F)};return A}parseObjectData(o,u,m,g){const{xScale:b,yScale:M}=o,{xAxisKey:A="x",yAxisKey:r="y"}=this._parsing,k=new Array(g);let F,N,W,Q;for(F=0,N=g;F<N;++F)W=F+m,Q=u[W],k[F]={x:b.parse(cl(Q,A),W),y:M.parse(cl(Q,r),W)};return k}getParsed(o){return this._cachedMeta._parsed[o]}getDataElement(o){return this._cachedMeta.data[o]}applyStack(o,u,m){const g=this.chart,b=this._cachedMeta,M=u[o.axis],A={keys:GM(g,!0),values:u._stacks[o.axis]._visualValues};return ww(A,M,b.index,{mode:m})}updateRangeFromParsed(o,u,m,g){const b=m[u.axis];let M=b===null?NaN:b;const A=g&&m._stacks[u.axis];g&&A&&(g.values=A,M=ww(g,b,this._cachedMeta.index)),o.min=Math.min(o.min,M),o.max=Math.max(o.max,M)}getMinMax(o,u){const m=this._cachedMeta,g=m._parsed,b=m._sorted&&o===m.iScale,M=g.length,A=this._getOtherScale(o),r=GD(u,m,this.chart),k={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY},{min:F,max:N}=ND(A);let W,Q;function te(){Q=g[W];const ce=Q[A.axis];return!Jn(Q[o.axis])||F>ce||N<ce}for(W=0;W<M&&!(!te()&&(this.updateRangeFromParsed(k,o,Q,r),b));++W);if(b){for(W=M-1;W>=0;--W)if(!te()){this.updateRangeFromParsed(k,o,Q,r);break}}return k}getAllParsedValues(o){const u=this._cachedMeta._parsed,m=[];let g,b,M;for(g=0,b=u.length;g<b;++g)M=u[g][o.axis],Jn(M)&&m.push(M);return m}getMaxOverflow(){return!1}getLabelAndValue(o){const u=this._cachedMeta,m=u.iScale,g=u.vScale,b=this.getParsed(o);return{label:m?""+m.getLabelForValue(b[m.axis]):"",value:g?""+g.getLabelForValue(b[g.axis]):""}}_update(o){const u=this._cachedMeta;this.update(o||"default"),u._clip=OD(Fi(this.options.clip,LD(u.xScale,u.yScale,this.getMaxOverflow())))}update(o){}draw(){const o=this._ctx,u=this.chart,m=this._cachedMeta,g=m.data||[],b=u.chartArea,M=[],A=this._drawStart||0,r=this._drawCount||g.length-A,k=this.options.drawActiveElementsOnTop;let F;for(m.dataset&&m.dataset.draw(o,b,A,r),F=A;F<A+r;++F){const N=g[F];N.hidden||(N.active&&k?M.push(N):N.draw(o,b))}for(F=0;F<M.length;++F)M[F].draw(o,b)}getStyle(o,u){const m=u?"active":"default";return o===void 0&&this._cachedMeta.dataset?this.resolveDatasetElementOptions(m):this.resolveDataElementOptions(o||0,m)}getContext(o,u,m){const g=this.getDataset();let b;if(o>=0&&o<this._cachedMeta.data.length){const M=this._cachedMeta.data[o];b=M.$context||(M.$context=jD(this.getContext(),o,M)),b.parsed=this.getParsed(o),b.raw=g.data[o],b.index=b.dataIndex=o}else b=this.$context||(this.$context=UD(this.chart.getContext(),this.index)),b.dataset=g,b.index=b.datasetIndex=this.index;return b.active=!!u,b.mode=m,b}resolveDatasetElementOptions(o){return this._resolveElementOptions(this.datasetElementType.id,o)}resolveDataElementOptions(o,u){return this._resolveElementOptions(this.dataElementType.id,u,o)}_resolveElementOptions(o,u="default",m){const g=u==="active",b=this._cachedDataOpts,M=o+"-"+u,A=b[M],r=this.enableOptionSharing&&kf(m);if(A)return Ew(A,r);const k=this.chart.config,F=k.datasetElementScopeKeys(this._type,o),N=g?[`${o}Hover`,"hover",o,""]:[o,""],W=k.getOptionScopes(this.getDataset(),F),Q=Object.keys(er.elements[o]),te=()=>this.getContext(m,g,u),ce=k.resolveNamedOptions(W,Q,te,N);return ce.$shared&&(ce.$shared=r,b[M]=Object.freeze(Ew(ce,r))),ce}_resolveAnimations(o,u,m){const g=this.chart,b=this._cachedDataOpts,M=`animation-${u}`,A=b[M];if(A)return A;let r;if(g.options.animation!==!1){const F=this.chart.config,N=F.datasetAnimationScopeKeys(this._type,u),W=F.getOptionScopes(this.getDataset(),N);r=F.createResolver(W,this.getContext(o,m,u))}const k=new jM(g,r&&r.animations);return r&&r._cacheable&&(b[M]=Object.freeze(k)),k}getSharedOptions(o){if(o.$shared)return this._sharedOptions||(this._sharedOptions=Object.assign({},o))}includeOptions(o,u){return!u||s0(o)||this.chart._animationsDisabled}_getSharedOptions(o,u){const m=this.resolveDataElementOptions(o,u),g=this._sharedOptions,b=this.getSharedOptions(m),M=this.includeOptions(u,b)||b!==g;return this.updateSharedOptions(b,u,m),{sharedOptions:b,includeOptions:M}}updateElement(o,u,m,g){s0(g)?Object.assign(o,m):this._resolveAnimations(u,g).update(o,m)}updateSharedOptions(o,u,m){o&&!s0(u)&&this._resolveAnimations(void 0,u).update(o,m)}_setStyle(o,u,m,g){o.active=g;const b=this.getStyle(u,g);this._resolveAnimations(u,m,g).update(o,{options:!g&&this.getSharedOptions(b)||b})}removeHoverStyle(o,u,m){this._setStyle(o,m,"active",!1)}setHoverStyle(o,u,m){this._setStyle(o,m,"active",!0)}_removeDatasetHoverStyle(){const o=this._cachedMeta.dataset;o&&this._setStyle(o,void 0,"active",!1)}_setDatasetHoverStyle(){const o=this._cachedMeta.dataset;o&&this._setStyle(o,void 0,"active",!0)}_resyncElements(o){const u=this._data,m=this._cachedMeta.data;for(const[A,r,k]of this._syncList)this[A](r,k);this._syncList=[];const g=m.length,b=u.length,M=Math.min(b,g);M&&this.parse(0,M),b>g?this._insertElements(g,b-g,o):b<g&&this._removeElements(b,g-b)}_insertElements(o,u,m=!0){const g=this._cachedMeta,b=g.data,M=o+u;let A;const r=k=>{for(k.length+=u,A=k.length-1;A>=M;A--)k[A]=k[A-u]};for(r(b),A=o;A<M;++A)b[A]=new this.dataElementType;this._parsing&&r(g._parsed),this.parse(o,u),m&&this.updateElements(b,o,u,"reset")}updateElements(o,u,m,g){}_removeElements(o,u){const m=this._cachedMeta;if(this._parsing){const g=m._parsed.splice(o,u);m._stacked&&rf(m,g)}m.data.splice(o,u)}_sync(o){if(this._parsing)this._syncList.push(o);else{const[u,m,g]=o;this[u](m,g)}this.chart._dataChanges.push([this.index,...o])}_onDataPush(){const o=arguments.length;this._sync(["_insertElements",this.getDataset().data.length-o,o])}_onDataPop(){this._sync(["_removeElements",this._cachedMeta.data.length-1,1])}_onDataShift(){this._sync(["_removeElements",0,1])}_onDataSplice(o,u){u&&this._sync(["_removeElements",o,u]);const m=arguments.length-2;m&&this._sync(["_insertElements",o,m])}_onDataUnshift(){this._sync(["_insertElements",0,arguments.length])}}Ft(co,"defaults",{}),Ft(co,"datasetElementType",null),Ft(co,"dataElementType",null);function WD(l,o){if(!l._cache.$bar){const u=l.getMatchingVisibleMetas(o);let m=[];for(let g=0,b=u.length;g<b;g++)m=m.concat(u[g].controller.getAllParsedValues(l));l._cache.$bar=TM(m.sort((g,b)=>g-b))}return l._cache.$bar}function qD(l){const o=l.iScale,u=WD(o,l.type);let m=o._length,g,b,M,A;const r=()=>{M===32767||M===-32768||(kf(A)&&(m=Math.min(m,Math.abs(M-A)||m)),A=M)};for(g=0,b=u.length;g<b;++g)M=o.getPixelForValue(u[g]),r();for(A=void 0,g=0,b=o.ticks.length;g<b;++g)M=o.getPixelForTick(g),r();return m}function HD(l,o,u,m){const g=u.barThickness;let b,M;return cn(g)?(b=o.min*u.categoryPercentage,M=u.barPercentage):(b=g*m,M=1),{chunk:b/m,ratio:M,start:o.pixels[l]-b/2}}function ZD(l,o,u,m){const g=o.pixels,b=g[l];let M=l>0?g[l-1]:null,A=l<g.length-1?g[l+1]:null;const r=u.categoryPercentage;M===null&&(M=b-(A===null?o.end-o.start:A-b)),A===null&&(A=b+b-M);const k=b-(b-Math.min(M,A))/2*r;return{chunk:Math.abs(A-M)/2*r/m,ratio:u.barPercentage,start:k}}function $D(l,o,u,m){const g=u.parse(l[0],m),b=u.parse(l[1],m),M=Math.min(g,b),A=Math.max(g,b);let r=M,k=A;Math.abs(M)>Math.abs(A)&&(r=A,k=M),o[u.axis]=k,o._custom={barStart:r,barEnd:k,start:g,end:b,min:M,max:A}}function WM(l,o,u,m){return qn(l)?$D(l,o,u,m):o[u.axis]=u.parse(l,m),o}function Aw(l,o,u,m){const g=l.iScale,b=l.vScale,M=g.getLabels(),A=g===b,r=[];let k,F,N,W;for(k=u,F=u+m;k<F;++k)W=o[k],N={},N[g.axis]=A||g.parse(M[k],k),r.push(WM(W,N,b,k));return r}function o0(l){return l&&l.barStart!==void 0&&l.barEnd!==void 0}function YD(l,o,u){return l!==0?Co(l):(o.isHorizontal()?1:-1)*(o.min>=u?1:-1)}function QD(l){let o,u,m,g,b;return l.horizontal?(o=l.base>l.x,u="left",m="right"):(o=l.base<l.y,u="bottom",m="top"),o?(g="end",b="start"):(g="start",b="end"),{start:u,end:m,reverse:o,top:g,bottom:b}}function XD(l,o,u,m){let g=o.borderSkipped;const b={};if(!g){l.borderSkipped=b;return}if(g===!0){l.borderSkipped={top:!0,right:!0,bottom:!0,left:!0};return}const{start:M,end:A,reverse:r,top:k,bottom:F}=QD(l);g==="middle"&&u&&(l.enableBorderRadius=!0,(u._top||0)===m?g=k:(u._bottom||0)===m?g=F:(b[Iw(F,M,A,r)]=!0,g=k)),b[Iw(g,M,A,r)]=!0,l.borderSkipped=b}function Iw(l,o,u,m){return m?(l=KD(l,o,u),l=Cw(l,u,o)):l=Cw(l,o,u),l}function KD(l,o,u){return l===o?u:l===u?o:l}function Cw(l,o,u){return l==="start"?o:l==="end"?u:l}function JD(l,{inflateAmount:o},u){l.inflateAmount=o==="auto"?u===1?.33:0:o}class x_ extends co{parsePrimitiveData(o,u,m,g){return Aw(o,u,m,g)}parseArrayData(o,u,m,g){return Aw(o,u,m,g)}parseObjectData(o,u,m,g){const{iScale:b,vScale:M}=o,{xAxisKey:A="x",yAxisKey:r="y"}=this._parsing,k=b.axis==="x"?A:r,F=M.axis==="x"?A:r,N=[];let W,Q,te,ce;for(W=m,Q=m+g;W<Q;++W)ce=u[W],te={},te[b.axis]=b.parse(cl(ce,k),W),N.push(WM(cl(ce,F),te,M,W));return N}updateRangeFromParsed(o,u,m,g){super.updateRangeFromParsed(o,u,m,g);const b=m._custom;b&&u===this._cachedMeta.vScale&&(o.min=Math.min(o.min,b.min),o.max=Math.max(o.max,b.max))}getMaxOverflow(){return 0}getLabelAndValue(o){const u=this._cachedMeta,{iScale:m,vScale:g}=u,b=this.getParsed(o),M=b._custom,A=o0(M)?"["+M.start+", "+M.end+"]":""+g.getLabelForValue(b[g.axis]);return{label:""+m.getLabelForValue(b[m.axis]),value:A}}initialize(){this.enableOptionSharing=!0,super.initialize();const o=this._cachedMeta;o.stack=this.getDataset().stack}update(o){const u=this._cachedMeta;this.updateElements(u.data,0,u.data.length,o)}updateElements(o,u,m,g){const b=g==="reset",{index:M,_cachedMeta:{vScale:A}}=this,r=A.getBasePixel(),k=A.isHorizontal(),F=this._getRuler(),{sharedOptions:N,includeOptions:W}=this._getSharedOptions(u,g);for(let Q=u;Q<u+m;Q++){const te=this.getParsed(Q),ce=b||cn(te[A.axis])?{base:r,head:r}:this._calculateBarValuePixels(Q),de=this._calculateBarIndexPixels(Q,F),ve=(te._stacks||{})[A.axis],Te={horizontal:k,base:ce.base,enableBorderRadius:!ve||o0(te._custom)||M===ve._top||M===ve._bottom,x:k?ce.head:de.center,y:k?de.center:ce.head,height:k?de.size:Math.abs(ce.size),width:k?Math.abs(ce.size):de.size};W&&(Te.options=N||this.resolveDataElementOptions(Q,o[Q].active?"active":g));const Ee=Te.options||o[Q].options;XD(Te,Ee,ve,M),JD(Te,Ee,F.ratio),this.updateElement(o[Q],Q,Te,g)}}_getStacks(o,u){const{iScale:m}=this._cachedMeta,g=m.getMatchingVisibleMetas(this._type).filter(r=>r.controller.options.grouped),b=m.options.stacked,M=[],A=r=>{const k=r.controller.getParsed(u),F=k&&k[r.vScale.axis];if(cn(F)||isNaN(F))return!0};for(const r of g)if(!(u!==void 0&&A(r))&&((b===!1||M.indexOf(r.stack)===-1||b===void 0&&r.stack===void 0)&&M.push(r.stack),r.index===o))break;return M.length||M.push(void 0),M}_getStackCount(o){return this._getStacks(void 0,o).length}_getStackIndex(o,u,m){const g=this._getStacks(o,m),b=u!==void 0?g.indexOf(u):-1;return b===-1?g.length-1:b}_getRuler(){const o=this.options,u=this._cachedMeta,m=u.iScale,g=[];let b,M;for(b=0,M=u.data.length;b<M;++b)g.push(m.getPixelForValue(this.getParsed(b)[m.axis],b));const A=o.barThickness;return{min:A||qD(u),pixels:g,start:m._startPixel,end:m._endPixel,stackCount:this._getStackCount(),scale:m,grouped:o.grouped,ratio:A?1:o.categoryPercentage*o.barPercentage}}_calculateBarValuePixels(o){const{_cachedMeta:{vScale:u,_stacked:m,index:g},options:{base:b,minBarLength:M}}=this,A=b||0,r=this.getParsed(o),k=r._custom,F=o0(k);let N=r[u.axis],W=0,Q=m?this.applyStack(u,r,m):N,te,ce;Q!==N&&(W=Q-N,Q=N),F&&(N=k.barStart,Q=k.barEnd-k.barStart,N!==0&&Co(N)!==Co(k.barEnd)&&(W=0),W+=N);const de=!cn(b)&&!F?b:W;let ve=u.getPixelForValue(de);if(this.chart.getDataVisibility(o)?te=u.getPixelForValue(W+Q):te=ve,ce=te-ve,Math.abs(ce)<M){ce=YD(ce,u,A)*M,N===A&&(ve-=ce/2);const Te=u.getPixelForDecimal(0),Ee=u.getPixelForDecimal(1),Me=Math.min(Te,Ee),Ie=Math.max(Te,Ee);ve=Math.max(Math.min(ve,Ie),Me),te=ve+ce,m&&!F&&(r._stacks[u.axis]._visualValues[g]=u.getValueForPixel(te)-u.getValueForPixel(ve))}if(ve===u.getPixelForValue(A)){const Te=Co(ce)*u.getLineWidthForValue(A)/2;ve+=Te,ce-=Te}return{size:ce,base:ve,head:te,center:te+ce/2}}_calculateBarIndexPixels(o,u){const m=u.scale,g=this.options,b=g.skipNull,M=Fi(g.maxBarThickness,1/0);let A,r;if(u.grouped){const k=b?this._getStackCount(o):u.stackCount,F=g.barThickness==="flex"?ZD(o,u,g,k):HD(o,u,g,k),N=this._getStackIndex(this.index,this._cachedMeta.stack,b?o:void 0);A=F.start+F.chunk*N+F.chunk/2,r=Math.min(M,F.chunk*F.ratio)}else A=m.getPixelForValue(this.getParsed(o)[m.axis],o),r=Math.min(M,u.min*u.ratio);return{base:A-r/2,head:A+r/2,center:A,size:r}}draw(){const o=this._cachedMeta,u=o.vScale,m=o.data,g=m.length;let b=0;for(;b<g;++b)this.getParsed(b)[u.axis]!==null&&!m[b].hidden&&m[b].draw(this._ctx)}}Ft(x_,"id","bar"),Ft(x_,"defaults",{datasetElementType:!1,dataElementType:"bar",categoryPercentage:.8,barPercentage:.9,grouped:!0,animations:{numbers:{type:"number",properties:["x","y","base","width","height"]}}}),Ft(x_,"overrides",{scales:{_index_:{type:"category",offset:!0,grid:{offset:!0}},_value_:{type:"linear",beginAtZero:!0}}});class v_ extends co{initialize(){this.enableOptionSharing=!0,super.initialize()}parsePrimitiveData(o,u,m,g){const b=super.parsePrimitiveData(o,u,m,g);for(let M=0;M<b.length;M++)b[M]._custom=this.resolveDataElementOptions(M+m).radius;return b}parseArrayData(o,u,m,g){const b=super.parseArrayData(o,u,m,g);for(let M=0;M<b.length;M++){const A=u[m+M];b[M]._custom=Fi(A[2],this.resolveDataElementOptions(M+m).radius)}return b}parseObjectData(o,u,m,g){const b=super.parseObjectData(o,u,m,g);for(let M=0;M<b.length;M++){const A=u[m+M];b[M]._custom=Fi(A&&A.r&&+A.r,this.resolveDataElementOptions(M+m).radius)}return b}getMaxOverflow(){const o=this._cachedMeta.data;let u=0;for(let m=o.length-1;m>=0;--m)u=Math.max(u,o[m].size(this.resolveDataElementOptions(m))/2);return u>0&&u}getLabelAndValue(o){const u=this._cachedMeta,m=this.chart.data.labels||[],{xScale:g,yScale:b}=u,M=this.getParsed(o),A=g.getLabelForValue(M.x),r=b.getLabelForValue(M.y),k=M._custom;return{label:m[o]||"",value:"("+A+", "+r+(k?", "+k:"")+")"}}update(o){const u=this._cachedMeta.data;this.updateElements(u,0,u.length,o)}updateElements(o,u,m,g){const b=g==="reset",{iScale:M,vScale:A}=this._cachedMeta,{sharedOptions:r,includeOptions:k}=this._getSharedOptions(u,g),F=M.axis,N=A.axis;for(let W=u;W<u+m;W++){const Q=o[W],te=!b&&this.getParsed(W),ce={},de=ce[F]=b?M.getPixelForDecimal(.5):M.getPixelForValue(te[F]),ve=ce[N]=b?A.getBasePixel():A.getPixelForValue(te[N]);ce.skip=isNaN(de)||isNaN(ve),k&&(ce.options=r||this.resolveDataElementOptions(W,Q.active?"active":g),b&&(ce.options.radius=0)),this.updateElement(Q,W,ce,g)}}resolveDataElementOptions(o,u){const m=this.getParsed(o);let g=super.resolveDataElementOptions(o,u);g.$shared&&(g=Object.assign({},g,{$shared:!1}));const b=g.radius;return u!=="active"&&(g.radius=0),g.radius+=Fi(m&&m._custom,b),g}}Ft(v_,"id","bubble"),Ft(v_,"defaults",{datasetElementType:!1,dataElementType:"point",animations:{numbers:{type:"number",properties:["x","y","borderWidth","radius"]}}}),Ft(v_,"overrides",{scales:{x:{type:"linear"},y:{type:"linear"}}});function ek(l,o,u){let m=1,g=1,b=0,M=0;if(o<Nn){const A=l,r=A+o,k=Math.cos(A),F=Math.sin(A),N=Math.cos(r),W=Math.sin(r),Q=(Ee,Me,Ie)=>Rf(Ee,A,r,!0)?1:Math.max(Me,Me*u,Ie,Ie*u),te=(Ee,Me,Ie)=>Rf(Ee,A,r,!0)?-1:Math.min(Me,Me*u,Ie,Ie*u),ce=Q(0,k,N),de=Q(ar,F,W),ve=te(Vn,k,N),Te=te(Vn+ar,F,W);m=(ce-ve)/2,g=(de-Te)/2,b=-(ce+ve)/2,M=-(de+Te)/2}return{ratioX:m,ratioY:g,offsetX:b,offsetY:M}}class wc extends co{constructor(o,u){super(o,u),this.enableOptionSharing=!0,this.innerRadius=void 0,this.outerRadius=void 0,this.offsetX=void 0,this.offsetY=void 0}linkScales(){}parse(o,u){const m=this.getDataset().data,g=this._cachedMeta;if(this._parsing===!1)g._parsed=m;else{let b=r=>+m[r];if(en(m[o])){const{key:r="value"}=this._parsing;b=k=>+cl(m[k],r)}let M,A;for(M=o,A=o+u;M<A;++M)g._parsed[M]=b(M)}}_getRotation(){return ao(this.options.rotation-90)}_getCircumference(){return ao(this.options.circumference)}_getRotationExtents(){let o=Nn,u=-Nn;for(let m=0;m<this.chart.data.datasets.length;++m)if(this.chart.isDatasetVisible(m)&&this.chart.getDatasetMeta(m).type===this._type){const g=this.chart.getDatasetMeta(m).controller,b=g._getRotation(),M=g._getCircumference();o=Math.min(o,b),u=Math.max(u,b+M)}return{rotation:o,circumference:u-o}}update(o){const u=this.chart,{chartArea:m}=u,g=this._cachedMeta,b=g.data,M=this.getMaxBorderWidth()+this.getMaxOffset(b)+this.options.spacing,A=Math.max((Math.min(m.width,m.height)-M)/2,0),r=Math.min(pP(this.options.cutout,A),1),k=this._getRingWeight(this.index),{circumference:F,rotation:N}=this._getRotationExtents(),{ratioX:W,ratioY:Q,offsetX:te,offsetY:ce}=ek(N,F,r),de=(m.width-M)/W,ve=(m.height-M)/Q,Te=Math.max(Math.min(de,ve)/2,0),Ee=yM(this.options.radius,Te),Me=Math.max(Ee*r,0),Ie=(Ee-Me)/this._getVisibleDatasetWeightTotal();this.offsetX=te*Ee,this.offsetY=ce*Ee,g.total=this.calculateTotal(),this.outerRadius=Ee-Ie*this._getRingWeightOffset(this.index),this.innerRadius=Math.max(this.outerRadius-Ie*k,0),this.updateElements(b,0,b.length,o)}_circumference(o,u){const m=this.options,g=this._cachedMeta,b=this._getCircumference();return u&&m.animation.animateRotate||!this.chart.getDataVisibility(o)||g._parsed[o]===null||g.data[o].hidden?0:this.calculateCircumference(g._parsed[o]*b/Nn)}updateElements(o,u,m,g){const b=g==="reset",M=this.chart,A=M.chartArea,k=M.options.animation,F=(A.left+A.right)/2,N=(A.top+A.bottom)/2,W=b&&k.animateScale,Q=W?0:this.innerRadius,te=W?0:this.outerRadius,{sharedOptions:ce,includeOptions:de}=this._getSharedOptions(u,g);let ve=this._getRotation(),Te;for(Te=0;Te<u;++Te)ve+=this._circumference(Te,b);for(Te=u;Te<u+m;++Te){const Ee=this._circumference(Te,b),Me=o[Te],Ie={x:F+this.offsetX,y:N+this.offsetY,startAngle:ve,endAngle:ve+Ee,circumference:Ee,outerRadius:te,innerRadius:Q};de&&(Ie.options=ce||this.resolveDataElementOptions(Te,Me.active?"active":g)),ve+=Ee,this.updateElement(Me,Te,Ie,g)}}calculateTotal(){const o=this._cachedMeta,u=o.data;let m=0,g;for(g=0;g<u.length;g++){const b=o._parsed[g];b!==null&&!isNaN(b)&&this.chart.getDataVisibility(g)&&!u[g].hidden&&(m+=Math.abs(b))}return m}calculateCircumference(o){const u=this._cachedMeta.total;return u>0&&!isNaN(o)?Nn*(Math.abs(o)/u):0}getLabelAndValue(o){const u=this._cachedMeta,m=this.chart,g=m.data.labels||[],b=jf(u._parsed[o],m.options.locale);return{label:g[o]||"",value:b}}getMaxBorderWidth(o){let u=0;const m=this.chart;let g,b,M,A,r;if(!o){for(g=0,b=m.data.datasets.length;g<b;++g)if(m.isDatasetVisible(g)){M=m.getDatasetMeta(g),o=M.data,A=M.controller;break}}if(!o)return 0;for(g=0,b=o.length;g<b;++g)r=A.resolveDataElementOptions(g),r.borderAlign!=="inner"&&(u=Math.max(u,r.borderWidth||0,r.hoverBorderWidth||0));return u}getMaxOffset(o){let u=0;for(let m=0,g=o.length;m<g;++m){const b=this.resolveDataElementOptions(m);u=Math.max(u,b.offset||0,b.hoverOffset||0)}return u}_getRingWeightOffset(o){let u=0;for(let m=0;m<o;++m)this.chart.isDatasetVisible(m)&&(u+=this._getRingWeight(m));return u}_getRingWeight(o){return Math.max(Fi(this.chart.data.datasets[o].weight,1),0)}_getVisibleDatasetWeightTotal(){return this._getRingWeightOffset(this.chart.data.datasets.length)||1}}Ft(wc,"id","doughnut"),Ft(wc,"defaults",{datasetElementType:!1,dataElementType:"arc",animation:{animateRotate:!0,animateScale:!1},animations:{numbers:{type:"number",properties:["circumference","endAngle","innerRadius","outerRadius","startAngle","x","y","offset","borderWidth","spacing"]}},cutout:"50%",rotation:0,circumference:360,radius:"100%",spacing:0,indexAxis:"r"}),Ft(wc,"descriptors",{_scriptable:o=>o!=="spacing",_indexable:o=>o!=="spacing"&&!o.startsWith("borderDash")&&!o.startsWith("hoverBorderDash")}),Ft(wc,"overrides",{aspectRatio:1,plugins:{legend:{labels:{generateLabels(o){const u=o.data;if(u.labels.length&&u.datasets.length){const{labels:{pointStyle:m,color:g}}=o.legend.options;return u.labels.map((b,M)=>{const r=o.getDatasetMeta(0).controller.getStyle(M);return{text:b,fillStyle:r.backgroundColor,strokeStyle:r.borderColor,fontColor:g,lineWidth:r.borderWidth,pointStyle:m,hidden:!o.getDataVisibility(M),index:M}})}return[]}},onClick(o,u,m){m.chart.toggleDataVisibility(u.index),m.chart.update()}}}});class b_ extends co{initialize(){this.enableOptionSharing=!0,this.supportsDecimation=!0,super.initialize()}update(o){const u=this._cachedMeta,{dataset:m,data:g=[],_dataset:b}=u,M=this.chart._animationsDisabled;let{start:A,count:r}=EM(u,g,M);this._drawStart=A,this._drawCount=r,AM(u)&&(A=0,r=g.length),m._chart=this.chart,m._datasetIndex=this.index,m._decimated=!!b._decimated,m.points=g;const k=this.resolveDatasetElementOptions(o);this.options.showLine||(k.borderWidth=0),k.segment=this.options.segment,this.updateElement(m,void 0,{animated:!M,options:k},o),this.updateElements(g,A,r,o)}updateElements(o,u,m,g){const b=g==="reset",{iScale:M,vScale:A,_stacked:r,_dataset:k}=this._cachedMeta,{sharedOptions:F,includeOptions:N}=this._getSharedOptions(u,g),W=M.axis,Q=A.axis,{spanGaps:te,segment:ce}=this.options,de=hh(te)?te:Number.POSITIVE_INFINITY,ve=this.chart._animationsDisabled||b||g==="none",Te=u+m,Ee=o.length;let Me=u>0&&this.getParsed(u-1);for(let Ie=0;Ie<Ee;++Ie){const qe=o[Ie],Ve=ve?qe:{};if(Ie<u||Ie>=Te){Ve.skip=!0;continue}const nt=this.getParsed(Ie),lt=cn(nt[Q]),ht=Ve[W]=M.getPixelForValue(nt[W],Ie),st=Ve[Q]=b||lt?A.getBasePixel():A.getPixelForValue(r?this.applyStack(A,nt,r):nt[Q],Ie);Ve.skip=isNaN(ht)||isNaN(st)||lt,Ve.stop=Ie>0&&Math.abs(nt[W]-Me[W])>de,ce&&(Ve.parsed=nt,Ve.raw=k.data[Ie]),N&&(Ve.options=F||this.resolveDataElementOptions(Ie,qe.active?"active":g)),ve||this.updateElement(qe,Ie,Ve,g),Me=nt}}getMaxOverflow(){const o=this._cachedMeta,u=o.dataset,m=u.options&&u.options.borderWidth||0,g=o.data||[];if(!g.length)return m;const b=g[0].size(this.resolveDataElementOptions(0)),M=g[g.length-1].size(this.resolveDataElementOptions(g.length-1));return Math.max(m,b,M)/2}draw(){const o=this._cachedMeta;o.dataset.updateControlPoints(this.chart.chartArea,o.iScale.axis),super.draw()}}Ft(b_,"id","line"),Ft(b_,"defaults",{datasetElementType:"line",dataElementType:"point",showLine:!0,spanGaps:!1}),Ft(b_,"overrides",{scales:{_index_:{type:"category"},_value_:{type:"linear"}}});class Af extends co{constructor(o,u){super(o,u),this.innerRadius=void 0,this.outerRadius=void 0}getLabelAndValue(o){const u=this._cachedMeta,m=this.chart,g=m.data.labels||[],b=jf(u._parsed[o].r,m.options.locale);return{label:g[o]||"",value:b}}parseObjectData(o,u,m,g){return LM.bind(this)(o,u,m,g)}update(o){const u=this._cachedMeta.data;this._updateRadius(),this.updateElements(u,0,u.length,o)}getMinMax(){const o=this._cachedMeta,u={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};return o.data.forEach((m,g)=>{const b=this.getParsed(g).r;!isNaN(b)&&this.chart.getDataVisibility(g)&&(b<u.min&&(u.min=b),b>u.max&&(u.max=b))}),u}_updateRadius(){const o=this.chart,u=o.chartArea,m=o.options,g=Math.min(u.right-u.left,u.bottom-u.top),b=Math.max(g/2,0),M=Math.max(m.cutoutPercentage?b/100*m.cutoutPercentage:1,0),A=(b-M)/o.getVisibleDatasetCount();this.outerRadius=b-A*this.index,this.innerRadius=this.outerRadius-A}updateElements(o,u,m,g){const b=g==="reset",M=this.chart,r=M.options.animation,k=this._cachedMeta.rScale,F=k.xCenter,N=k.yCenter,W=k.getIndexAngle(0)-.5*Vn;let Q=W,te;const ce=360/this.countVisibleElements();for(te=0;te<u;++te)Q+=this._computeAngle(te,g,ce);for(te=u;te<u+m;te++){const de=o[te];let ve=Q,Te=Q+this._computeAngle(te,g,ce),Ee=M.getDataVisibility(te)?k.getDistanceFromCenterForValue(this.getParsed(te).r):0;Q=Te,b&&(r.animateScale&&(Ee=0),r.animateRotate&&(ve=Te=W));const Me={x:F,y:N,innerRadius:0,outerRadius:Ee,startAngle:ve,endAngle:Te,options:this.resolveDataElementOptions(te,de.active?"active":g)};this.updateElement(de,te,Me,g)}}countVisibleElements(){const o=this._cachedMeta;let u=0;return o.data.forEach((m,g)=>{!isNaN(this.getParsed(g).r)&&this.chart.getDataVisibility(g)&&u++}),u}_computeAngle(o,u,m){return this.chart.getDataVisibility(o)?ao(this.resolveDataElementOptions(o,u).angle||m):0}}Ft(Af,"id","polarArea"),Ft(Af,"defaults",{dataElementType:"arc",animation:{animateRotate:!0,animateScale:!0},animations:{numbers:{type:"number",properties:["x","y","startAngle","endAngle","innerRadius","outerRadius"]}},indexAxis:"r",startAngle:0}),Ft(Af,"overrides",{aspectRatio:1,plugins:{legend:{labels:{generateLabels(o){const u=o.data;if(u.labels.length&&u.datasets.length){const{labels:{pointStyle:m,color:g}}=o.legend.options;return u.labels.map((b,M)=>{const r=o.getDatasetMeta(0).controller.getStyle(M);return{text:b,fillStyle:r.backgroundColor,strokeStyle:r.borderColor,fontColor:g,lineWidth:r.borderWidth,pointStyle:m,hidden:!o.getDataVisibility(M),index:M}})}return[]}},onClick(o,u,m){m.chart.toggleDataVisibility(u.index),m.chart.update()}}},scales:{r:{type:"radialLinear",angleLines:{display:!1},beginAtZero:!0,grid:{circular:!0},pointLabels:{display:!1},startAngle:0}}});class P0 extends wc{}Ft(P0,"id","pie"),Ft(P0,"defaults",{cutout:0,rotation:0,circumference:360,radius:"100%"});class w_ extends co{getLabelAndValue(o){const u=this._cachedMeta.vScale,m=this.getParsed(o);return{label:u.getLabels()[o],value:""+u.getLabelForValue(m[u.axis])}}parseObjectData(o,u,m,g){return LM.bind(this)(o,u,m,g)}update(o){const u=this._cachedMeta,m=u.dataset,g=u.data||[],b=u.iScale.getLabels();if(m.points=g,o!=="resize"){const M=this.resolveDatasetElementOptions(o);this.options.showLine||(M.borderWidth=0);const A={_loop:!0,_fullLoop:b.length===g.length,options:M};this.updateElement(m,void 0,A,o)}this.updateElements(g,0,g.length,o)}updateElements(o,u,m,g){const b=this._cachedMeta.rScale,M=g==="reset";for(let A=u;A<u+m;A++){const r=o[A],k=this.resolveDataElementOptions(A,r.active?"active":g),F=b.getPointPositionForValue(A,this.getParsed(A).r),N=M?b.xCenter:F.x,W=M?b.yCenter:F.y,Q={x:N,y:W,angle:F.angle,skip:isNaN(N)||isNaN(W),options:k};this.updateElement(r,A,Q,g)}}}Ft(w_,"id","radar"),Ft(w_,"defaults",{datasetElementType:"line",dataElementType:"point",indexAxis:"r",showLine:!0,elements:{line:{fill:"start"}}}),Ft(w_,"overrides",{aspectRatio:1,scales:{r:{type:"radialLinear"}}});class T_ extends co{getLabelAndValue(o){const u=this._cachedMeta,m=this.chart.data.labels||[],{xScale:g,yScale:b}=u,M=this.getParsed(o),A=g.getLabelForValue(M.x),r=b.getLabelForValue(M.y);return{label:m[o]||"",value:"("+A+", "+r+")"}}update(o){const u=this._cachedMeta,{data:m=[]}=u,g=this.chart._animationsDisabled;let{start:b,count:M}=EM(u,m,g);if(this._drawStart=b,this._drawCount=M,AM(u)&&(b=0,M=m.length),this.options.showLine){this.datasetElementType||this.addElements();const{dataset:A,_dataset:r}=u;A._chart=this.chart,A._datasetIndex=this.index,A._decimated=!!r._decimated,A.points=m;const k=this.resolveDatasetElementOptions(o);k.segment=this.options.segment,this.updateElement(A,void 0,{animated:!g,options:k},o)}else this.datasetElementType&&(delete u.dataset,this.datasetElementType=!1);this.updateElements(m,b,M,o)}addElements(){const{showLine:o}=this.options;!this.datasetElementType&&o&&(this.datasetElementType=this.chart.registry.getElement("line")),super.addElements()}updateElements(o,u,m,g){const b=g==="reset",{iScale:M,vScale:A,_stacked:r,_dataset:k}=this._cachedMeta,F=this.resolveDataElementOptions(u,g),N=this.getSharedOptions(F),W=this.includeOptions(g,N),Q=M.axis,te=A.axis,{spanGaps:ce,segment:de}=this.options,ve=hh(ce)?ce:Number.POSITIVE_INFINITY,Te=this.chart._animationsDisabled||b||g==="none";let Ee=u>0&&this.getParsed(u-1);for(let Me=u;Me<u+m;++Me){const Ie=o[Me],qe=this.getParsed(Me),Ve=Te?Ie:{},nt=cn(qe[te]),lt=Ve[Q]=M.getPixelForValue(qe[Q],Me),ht=Ve[te]=b||nt?A.getBasePixel():A.getPixelForValue(r?this.applyStack(A,qe,r):qe[te],Me);Ve.skip=isNaN(lt)||isNaN(ht)||nt,Ve.stop=Me>0&&Math.abs(qe[Q]-Ee[Q])>ve,de&&(Ve.parsed=qe,Ve.raw=k.data[Me]),W&&(Ve.options=N||this.resolveDataElementOptions(Me,Ie.active?"active":g)),Te||this.updateElement(Ie,Me,Ve,g),Ee=qe}this.updateSharedOptions(N,g,F)}getMaxOverflow(){const o=this._cachedMeta,u=o.data||[];if(!this.options.showLine){let A=0;for(let r=u.length-1;r>=0;--r)A=Math.max(A,u[r].size(this.resolveDataElementOptions(r))/2);return A>0&&A}const m=o.dataset,g=m.options&&m.options.borderWidth||0;if(!u.length)return g;const b=u[0].size(this.resolveDataElementOptions(0)),M=u[u.length-1].size(this.resolveDataElementOptions(u.length-1));return Math.max(g,b,M)/2}}Ft(T_,"id","scatter"),Ft(T_,"defaults",{datasetElementType:!1,dataElementType:"point",showLine:!1,fill:!1}),Ft(T_,"overrides",{interaction:{mode:"point"},scales:{x:{type:"linear"},y:{type:"linear"}}});var tk=Object.freeze({__proto__:null,BarController:x_,BubbleController:v_,DoughnutController:wc,LineController:b_,PieController:P0,PolarAreaController:Af,RadarController:w_,ScatterController:T_});function yc(){throw new Error("This method is not implemented: Check that a complete date adapter is provided.")}class hx{constructor(o){Ft(this,"options");this.options=o||{}}static override(o){Object.assign(hx.prototype,o)}init(){}formats(){return yc()}parse(){return yc()}format(){return yc()}add(){return yc()}diff(){return yc()}startOf(){return yc()}endOf(){return yc()}}var ik={_date:hx};function nk(l,o,u,m){const{controller:g,data:b,_sorted:M}=l,A=g._cachedMeta.iScale;if(A&&o===A.axis&&o!=="r"&&M&&b.length){const r=A._reversePixels?EP:ua;if(m){if(g._sharedOptions){const k=b[0],F=typeof k.getRange=="function"&&k.getRange(o);if(F){const N=r(b,o,u-F),W=r(b,o,u+F);return{lo:N.lo,hi:W.hi}}}}else return r(b,o,u)}return{lo:0,hi:b.length-1}}function Gf(l,o,u,m,g){const b=l.getSortedVisibleDatasetMetas(),M=u[o];for(let A=0,r=b.length;A<r;++A){const{index:k,data:F}=b[A],{lo:N,hi:W}=nk(b[A],o,M,g);for(let Q=N;Q<=W;++Q){const te=F[Q];te.skip||m(te,k,Q)}}}function rk(l){const o=l.indexOf("x")!==-1,u=l.indexOf("y")!==-1;return function(m,g){const b=o?Math.abs(m.x-g.x):0,M=u?Math.abs(m.y-g.y):0;return Math.sqrt(Math.pow(b,2)+Math.pow(M,2))}}function a0(l,o,u,m,g){const b=[];return!g&&!l.isPointInArea(o)||Gf(l,u,o,function(A,r,k){!g&&!ha(A,l.chartArea,0)||A.inRange(o.x,o.y,m)&&b.push({element:A,datasetIndex:r,index:k})},!0),b}function sk(l,o,u,m){let g=[];function b(M,A,r){const{startAngle:k,endAngle:F}=M.getProps(["startAngle","endAngle"],m),{angle:N}=bM(M,{x:o.x,y:o.y});Rf(N,k,F)&&g.push({element:M,datasetIndex:A,index:r})}return Gf(l,u,o,b),g}function ok(l,o,u,m,g,b){let M=[];const A=rk(u);let r=Number.POSITIVE_INFINITY;function k(F,N,W){const Q=F.inRange(o.x,o.y,g);if(m&&!Q)return;const te=F.getCenterPoint(g);if(!(!!b||l.isPointInArea(te))&&!Q)return;const de=A(o,te);de<r?(M=[{element:F,datasetIndex:N,index:W}],r=de):de===r&&M.push({element:F,datasetIndex:N,index:W})}return Gf(l,u,o,k),M}function l0(l,o,u,m,g,b){return!b&&!l.isPointInArea(o)?[]:u==="r"&&!m?sk(l,o,u,g):ok(l,o,u,m,g,b)}function Pw(l,o,u,m,g){const b=[],M=u==="x"?"inXRange":"inYRange";let A=!1;return Gf(l,u,o,(r,k,F)=>{r[M](o[u],g)&&(b.push({element:r,datasetIndex:k,index:F}),A=A||r.inRange(o.x,o.y,g))}),m&&!A?[]:b}var ak={evaluateInteractionItems:Gf,modes:{index(l,o,u,m){const g=vc(o,l),b=u.axis||"x",M=u.includeInvisible||!1,A=u.intersect?a0(l,g,b,m,M):l0(l,g,b,!1,m,M),r=[];return A.length?(l.getSortedVisibleDatasetMetas().forEach(k=>{const F=A[0].index,N=k.data[F];N&&!N.skip&&r.push({element:N,datasetIndex:k.index,index:F})}),r):[]},dataset(l,o,u,m){const g=vc(o,l),b=u.axis||"xy",M=u.includeInvisible||!1;let A=u.intersect?a0(l,g,b,m,M):l0(l,g,b,!1,m,M);if(A.length>0){const r=A[0].datasetIndex,k=l.getDatasetMeta(r).data;A=[];for(let F=0;F<k.length;++F)A.push({element:k[F],datasetIndex:r,index:F})}return A},point(l,o,u,m){const g=vc(o,l),b=u.axis||"xy",M=u.includeInvisible||!1;return a0(l,g,b,m,M)},nearest(l,o,u,m){const g=vc(o,l),b=u.axis||"xy",M=u.includeInvisible||!1;return l0(l,g,b,u.intersect,m,M)},x(l,o,u,m){const g=vc(o,l);return Pw(l,g,"x",u.intersect,m)},y(l,o,u,m){const g=vc(o,l);return Pw(l,g,"y",u.intersect,m)}}};const qM=["left","top","right","bottom"];function sf(l,o){return l.filter(u=>u.pos===o)}function Dw(l,o){return l.filter(u=>qM.indexOf(u.pos)===-1&&u.box.axis===o)}function of(l,o){return l.sort((u,m)=>{const g=o?m:u,b=o?u:m;return g.weight===b.weight?g.index-b.index:g.weight-b.weight})}function lk(l){const o=[];let u,m,g,b,M,A;for(u=0,m=(l||[]).length;u<m;++u)g=l[u],{position:b,options:{stack:M,stackWeight:A=1}}=g,o.push({index:u,box:g,pos:b,horizontal:g.isHorizontal(),weight:g.weight,stack:M&&b+M,stackWeight:A});return o}function ck(l){const o={};for(const u of l){const{stack:m,pos:g,stackWeight:b}=u;if(!m||!qM.includes(g))continue;const M=o[m]||(o[m]={count:0,placed:0,weight:0,size:0});M.count++,M.weight+=b}return o}function uk(l,o){const u=ck(l),{vBoxMaxWidth:m,hBoxMaxHeight:g}=o;let b,M,A;for(b=0,M=l.length;b<M;++b){A=l[b];const{fullSize:r}=A.box,k=u[A.stack],F=k&&A.stackWeight/k.weight;A.horizontal?(A.width=F?F*m:r&&o.availableWidth,A.height=g):(A.width=m,A.height=F?F*g:r&&o.availableHeight)}return u}function hk(l){const o=lk(l),u=of(o.filter(k=>k.box.fullSize),!0),m=of(sf(o,"left"),!0),g=of(sf(o,"right")),b=of(sf(o,"top"),!0),M=of(sf(o,"bottom")),A=Dw(o,"x"),r=Dw(o,"y");return{fullSize:u,leftAndTop:m.concat(b),rightAndBottom:g.concat(r).concat(M).concat(A),chartArea:sf(o,"chartArea"),vertical:m.concat(g).concat(r),horizontal:b.concat(M).concat(A)}}function kw(l,o,u,m){return Math.max(l[u],o[u])+Math.max(l[m],o[m])}function HM(l,o){l.top=Math.max(l.top,o.top),l.left=Math.max(l.left,o.left),l.bottom=Math.max(l.bottom,o.bottom),l.right=Math.max(l.right,o.right)}function dk(l,o,u,m){const{pos:g,box:b}=u,M=l.maxPadding;if(!en(g)){u.size&&(l[g]-=u.size);const N=m[u.stack]||{size:0,count:1};N.size=Math.max(N.size,u.horizontal?b.height:b.width),u.size=N.size/N.count,l[g]+=u.size}b.getPadding&&HM(M,b.getPadding());const A=Math.max(0,o.outerWidth-kw(M,l,"left","right")),r=Math.max(0,o.outerHeight-kw(M,l,"top","bottom")),k=A!==l.w,F=r!==l.h;return l.w=A,l.h=r,u.horizontal?{same:k,other:F}:{same:F,other:k}}function fk(l){const o=l.maxPadding;function u(m){const g=Math.max(o[m]-l[m],0);return l[m]+=g,g}l.y+=u("top"),l.x+=u("left"),u("right"),u("bottom")}function pk(l,o){const u=o.maxPadding;function m(g){const b={left:0,top:0,right:0,bottom:0};return g.forEach(M=>{b[M]=Math.max(o[M],u[M])}),b}return m(l?["left","right"]:["top","bottom"])}function mf(l,o,u,m){const g=[];let b,M,A,r,k,F;for(b=0,M=l.length,k=0;b<M;++b){A=l[b],r=A.box,r.update(A.width||o.w,A.height||o.h,pk(A.horizontal,o));const{same:N,other:W}=dk(o,u,A,m);k|=N&&g.length,F=F||W,r.fullSize||g.push(A)}return k&&mf(g,o,u,m)||F}function o_(l,o,u,m,g){l.top=u,l.left=o,l.right=o+m,l.bottom=u+g,l.width=m,l.height=g}function Rw(l,o,u,m){const g=u.padding;let{x:b,y:M}=o;for(const A of l){const r=A.box,k=m[A.stack]||{count:1,placed:0,weight:1},F=A.stackWeight/k.weight||1;if(A.horizontal){const N=o.w*F,W=k.size||r.height;kf(k.start)&&(M=k.start),r.fullSize?o_(r,g.left,M,u.outerWidth-g.right-g.left,W):o_(r,o.left+k.placed,M,N,W),k.start=M,k.placed+=N,M=r.bottom}else{const N=o.h*F,W=k.size||r.width;kf(k.start)&&(b=k.start),r.fullSize?o_(r,b,g.top,W,u.outerHeight-g.bottom-g.top):o_(r,b,o.top+k.placed,W,N),k.start=b,k.placed+=N,b=r.right}}o.x=b,o.y=M}var Wr={addBox(l,o){l.boxes||(l.boxes=[]),o.fullSize=o.fullSize||!1,o.position=o.position||"top",o.weight=o.weight||0,o._layers=o._layers||function(){return[{z:0,draw(u){o.draw(u)}}]},l.boxes.push(o)},removeBox(l,o){const u=l.boxes?l.boxes.indexOf(o):-1;u!==-1&&l.boxes.splice(u,1)},configure(l,o,u){o.fullSize=u.fullSize,o.position=u.position,o.weight=u.weight},update(l,o,u,m){if(!l)return;const g=qr(l.options.layout.padding),b=Math.max(o-g.width,0),M=Math.max(u-g.height,0),A=hk(l.boxes),r=A.vertical,k=A.horizontal;Mn(l.boxes,ce=>{typeof ce.beforeLayout=="function"&&ce.beforeLayout()});const F=r.reduce((ce,de)=>de.box.options&&de.box.options.display===!1?ce:ce+1,0)||1,N=Object.freeze({outerWidth:o,outerHeight:u,padding:g,availableWidth:b,availableHeight:M,vBoxMaxWidth:b/2/F,hBoxMaxHeight:M/2}),W=Object.assign({},g);HM(W,qr(m));const Q=Object.assign({maxPadding:W,w:b,h:M,x:g.left,y:g.top},g),te=uk(r.concat(k),N);mf(A.fullSize,Q,N,te),mf(r,Q,N,te),mf(k,Q,N,te)&&mf(r,Q,N,te),fk(Q),Rw(A.leftAndTop,Q,N,te),Q.x+=Q.w,Q.y+=Q.h,Rw(A.rightAndBottom,Q,N,te),l.chartArea={left:Q.left,top:Q.top,right:Q.left+Q.w,bottom:Q.top+Q.h,height:Q.h,width:Q.w},Mn(A.chartArea,ce=>{const de=ce.box;Object.assign(de,l.chartArea),de.update(Q.w,Q.h,{left:0,top:0,right:0,bottom:0})})}};class ZM{acquireContext(o,u){}releaseContext(o){return!1}addEventListener(o,u,m){}removeEventListener(o,u,m){}getDevicePixelRatio(){return 1}getMaximumSize(o,u,m,g){return u=Math.max(0,u||o.width),m=m||o.height,{width:u,height:Math.max(0,g?Math.floor(u/g):m)}}isAttached(o){return!0}updateConfig(o){}}class mk extends ZM{acquireContext(o){return o&&o.getContext&&o.getContext("2d")||null}updateConfig(o){o.options.animation=!1}}const M_="$chartjs",_k={touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup",pointerenter:"mouseenter",pointerdown:"mousedown",pointermove:"mousemove",pointerup:"mouseup",pointerleave:"mouseout",pointerout:"mouseout"},zw=l=>l===null||l==="";function gk(l,o){const u=l.style,m=l.getAttribute("height"),g=l.getAttribute("width");if(l[M_]={initial:{height:m,width:g,style:{display:u.display,height:u.height,width:u.width}}},u.display=u.display||"block",u.boxSizing=u.boxSizing||"border-box",zw(g)){const b=_w(l,"width");b!==void 0&&(l.width=b)}if(zw(m))if(l.style.height==="")l.height=l.width/(o||2);else{const b=_w(l,"height");b!==void 0&&(l.height=b)}return l}const $M=xD?{passive:!0}:!1;function yk(l,o,u){l&&l.addEventListener(o,u,$M)}function xk(l,o,u){l&&l.canvas&&l.canvas.removeEventListener(o,u,$M)}function vk(l,o){const u=_k[l.type]||l.type,{x:m,y:g}=vc(l,o);return{type:u,chart:o,native:l,x:m!==void 0?m:null,y:g!==void 0?g:null}}function B_(l,o){for(const u of l)if(u===o||u.contains(o))return!0}function bk(l,o,u){const m=l.canvas,g=new MutationObserver(b=>{let M=!1;for(const A of b)M=M||B_(A.addedNodes,m),M=M&&!B_(A.removedNodes,m);M&&u()});return g.observe(document,{childList:!0,subtree:!0}),g}function wk(l,o,u){const m=l.canvas,g=new MutationObserver(b=>{let M=!1;for(const A of b)M=M||B_(A.removedNodes,m),M=M&&!B_(A.addedNodes,m);M&&u()});return g.observe(document,{childList:!0,subtree:!0}),g}const Lf=new Map;let Lw=0;function YM(){const l=window.devicePixelRatio;l!==Lw&&(Lw=l,Lf.forEach((o,u)=>{u.currentDevicePixelRatio!==l&&o()}))}function Tk(l,o){Lf.size||window.addEventListener("resize",YM),Lf.set(l,o)}function Mk(l){Lf.delete(l),Lf.size||window.removeEventListener("resize",YM)}function Sk(l,o,u){const m=l.canvas,g=m&&ux(m);if(!g)return;const b=SM((A,r)=>{const k=g.clientWidth;u(A,r),k<g.clientWidth&&u()},window),M=new ResizeObserver(A=>{const r=A[0],k=r.contentRect.width,F=r.contentRect.height;k===0&&F===0||b(k,F)});return M.observe(g),Tk(l,b),M}function c0(l,o,u){u&&u.disconnect(),o==="resize"&&Mk(l)}function Ek(l,o,u){const m=l.canvas,g=SM(b=>{l.ctx!==null&&u(vk(b,l))},l);return yk(m,o,g),g}class Ak extends ZM{acquireContext(o,u){const m=o&&o.getContext&&o.getContext("2d");return m&&m.canvas===o?(gk(o,u),m):null}releaseContext(o){const u=o.canvas;if(!u[M_])return!1;const m=u[M_].initial;["height","width"].forEach(b=>{const M=m[b];cn(M)?u.removeAttribute(b):u.setAttribute(b,M)});const g=m.style||{};return Object.keys(g).forEach(b=>{u.style[b]=g[b]}),u.width=u.width,delete u[M_],!0}addEventListener(o,u,m){this.removeEventListener(o,u);const g=o.$proxies||(o.$proxies={}),M={attach:bk,detach:wk,resize:Sk}[u]||Ek;g[u]=M(o,u,m)}removeEventListener(o,u){const m=o.$proxies||(o.$proxies={}),g=m[u];if(!g)return;({attach:c0,detach:c0,resize:c0}[u]||xk)(o,u,g),m[u]=void 0}getDevicePixelRatio(){return window.devicePixelRatio}getMaximumSize(o,u,m,g){return yD(o,u,m,g)}isAttached(o){const u=o&&ux(o);return!!(u&&u.isConnected)}}function Ik(l){return!cx()||typeof OffscreenCanvas<"u"&&l instanceof OffscreenCanvas?mk:Ak}class uo{constructor(){Ft(this,"x");Ft(this,"y");Ft(this,"active",!1);Ft(this,"options");Ft(this,"$animations")}tooltipPosition(o){const{x:u,y:m}=this.getProps(["x","y"],o);return{x:u,y:m}}hasValue(){return hh(this.x)&&hh(this.y)}getProps(o,u){const m=this.$animations;if(!u||!m)return this;const g={};return o.forEach(b=>{g[b]=m[b]&&m[b].active()?m[b]._to:this[b]}),g}}Ft(uo,"defaults",{}),Ft(uo,"defaultRoutes");function Ck(l,o){const u=l.options.ticks,m=Pk(l),g=Math.min(u.maxTicksLimit||m,m),b=u.major.enabled?kk(o):[],M=b.length,A=b[0],r=b[M-1],k=[];if(M>g)return Rk(o,k,b,M/g),k;const F=Dk(b,o,g);if(M>0){let N,W;const Q=M>1?Math.round((r-A)/(M-1)):null;for(a_(o,k,F,cn(Q)?0:A-Q,A),N=0,W=M-1;N<W;N++)a_(o,k,F,b[N],b[N+1]);return a_(o,k,F,r,cn(Q)?o.length:r+Q),k}return a_(o,k,F),k}function Pk(l){const o=l.options.offset,u=l._tickSize(),m=l._length/u+(o?0:1),g=l._maxLength/u;return Math.floor(Math.min(m,g))}function Dk(l,o,u){const m=zk(l),g=o.length/u;if(!m)return Math.max(g,1);const b=wP(m);for(let M=0,A=b.length-1;M<A;M++){const r=b[M];if(r>g)return r}return Math.max(g,1)}function kk(l){const o=[];let u,m;for(u=0,m=l.length;u<m;u++)l[u].major&&o.push(u);return o}function Rk(l,o,u,m){let g=0,b=u[0],M;for(m=Math.ceil(m),M=0;M<l.length;M++)M===b&&(o.push(l[M]),g++,b=u[g*m])}function a_(l,o,u,m,g){const b=Fi(m,0),M=Math.min(Fi(g,l.length),l.length);let A=0,r,k,F;for(u=Math.ceil(u),g&&(r=g-m,u=r/Math.floor(r/u)),F=b;F<0;)A++,F=Math.round(b+A*u);for(k=Math.max(b,0);k<M;k++)k===F&&(o.push(l[k]),A++,F=Math.round(b+A*u))}function zk(l){const o=l.length;let u,m;if(o<2)return!1;for(m=l[0],u=1;u<o;++u)if(l[u]-l[u-1]!==m)return!1;return m}const Lk=l=>l==="left"?"right":l==="right"?"left":l,Ow=(l,o,u)=>o==="top"||o==="left"?l[o]+u:l[o]-u,Fw=(l,o)=>Math.min(o||l,l);function Bw(l,o){const u=[],m=l.length/o,g=l.length;let b=0;for(;b<g;b+=m)u.push(l[Math.floor(b)]);return u}function Ok(l,o,u){const m=l.ticks.length,g=Math.min(o,m-1),b=l._startPixel,M=l._endPixel,A=1e-6;let r=l.getPixelForTick(g),k;if(!(u&&(m===1?k=Math.max(r-b,M-r):o===0?k=(l.getPixelForTick(1)-r)/2:k=(r-l.getPixelForTick(g-1))/2,r+=g<o?k:-k,r<b-A||r>M+A)))return r}function Fk(l,o){Mn(l,u=>{const m=u.gc,g=m.length/2;let b;if(g>o){for(b=0;b<g;++b)delete u.data[m[b]];m.splice(0,g)}})}function af(l){return l.drawTicks?l.tickLength:0}function Nw(l,o){if(!l.display)return 0;const u=br(l.font,o),m=qr(l.padding);return(qn(l.text)?l.text.length:1)*u.lineHeight+m.height}function Bk(l,o){return hl(l,{scale:o,type:"scale"})}function Nk(l,o,u){return hl(l,{tick:u,index:o,type:"tick"})}function Vk(l,o,u){let m=nx(l);return(u&&o!=="right"||!u&&o==="right")&&(m=Lk(m)),m}function Uk(l,o,u,m){const{top:g,left:b,bottom:M,right:A,chart:r}=l,{chartArea:k,scales:F}=r;let N=0,W,Q,te;const ce=M-g,de=A-b;if(l.isHorizontal()){if(Q=Gr(m,b,A),en(u)){const ve=Object.keys(u)[0],Te=u[ve];te=F[ve].getPixelForValue(Te)+ce-o}else u==="center"?te=(k.bottom+k.top)/2+ce-o:te=Ow(l,u,o);W=A-b}else{if(en(u)){const ve=Object.keys(u)[0],Te=u[ve];Q=F[ve].getPixelForValue(Te)-de+o}else u==="center"?Q=(k.left+k.right)/2-de+o:Q=Ow(l,u,o);te=Gr(m,M,g),N=u==="left"?-ar:ar}return{titleX:Q,titleY:te,maxWidth:W,rotation:N}}class Cc extends uo{constructor(o){super(),this.id=o.id,this.type=o.type,this.options=void 0,this.ctx=o.ctx,this.chart=o.chart,this.top=void 0,this.bottom=void 0,this.left=void 0,this.right=void 0,this.width=void 0,this.height=void 0,this._margins={left:0,right:0,top:0,bottom:0},this.maxWidth=void 0,this.maxHeight=void 0,this.paddingTop=void 0,this.paddingBottom=void 0,this.paddingLeft=void 0,this.paddingRight=void 0,this.axis=void 0,this.labelRotation=void 0,this.min=void 0,this.max=void 0,this._range=void 0,this.ticks=[],this._gridLineItems=null,this._labelItems=null,this._labelSizes=null,this._length=0,this._maxLength=0,this._longestTextCache={},this._startPixel=void 0,this._endPixel=void 0,this._reversePixels=!1,this._userMax=void 0,this._userMin=void 0,this._suggestedMax=void 0,this._suggestedMin=void 0,this._ticksLength=0,this._borderValue=0,this._cache={},this._dataLimitsCached=!1,this.$context=void 0}init(o){this.options=o.setContext(this.getContext()),this.axis=o.axis,this._userMin=this.parse(o.min),this._userMax=this.parse(o.max),this._suggestedMin=this.parse(o.suggestedMin),this._suggestedMax=this.parse(o.suggestedMax)}parse(o,u){return o}getUserBounds(){let{_userMin:o,_userMax:u,_suggestedMin:m,_suggestedMax:g}=this;return o=Es(o,Number.POSITIVE_INFINITY),u=Es(u,Number.NEGATIVE_INFINITY),m=Es(m,Number.POSITIVE_INFINITY),g=Es(g,Number.NEGATIVE_INFINITY),{min:Es(o,m),max:Es(u,g),minDefined:Jn(o),maxDefined:Jn(u)}}getMinMax(o){let{min:u,max:m,minDefined:g,maxDefined:b}=this.getUserBounds(),M;if(g&&b)return{min:u,max:m};const A=this.getMatchingVisibleMetas();for(let r=0,k=A.length;r<k;++r)M=A[r].controller.getMinMax(this,o),g||(u=Math.min(u,M.min)),b||(m=Math.max(m,M.max));return u=b&&u>m?m:u,m=g&&u>m?u:m,{min:Es(u,Es(m,u)),max:Es(m,Es(u,m))}}getPadding(){return{left:this.paddingLeft||0,top:this.paddingTop||0,right:this.paddingRight||0,bottom:this.paddingBottom||0}}getTicks(){return this.ticks}getLabels(){const o=this.chart.data;return this.options.labels||(this.isHorizontal()?o.xLabels:o.yLabels)||o.labels||[]}getLabelItems(o=this.chart.chartArea){return this._labelItems||(this._labelItems=this._computeLabelItems(o))}beforeLayout(){this._cache={},this._dataLimitsCached=!1}beforeUpdate(){zn(this.options.beforeUpdate,[this])}update(o,u,m){const{beginAtZero:g,grace:b,ticks:M}=this.options,A=M.sampleSize;this.beforeUpdate(),this.maxWidth=o,this.maxHeight=u,this._margins=m=Object.assign({left:0,right:0,top:0,bottom:0},m),this.ticks=null,this._labelSizes=null,this._gridLineItems=null,this._labelItems=null,this.beforeSetDimensions(),this.setDimensions(),this.afterSetDimensions(),this._maxLength=this.isHorizontal()?this.width+m.left+m.right:this.height+m.top+m.bottom,this._dataLimitsCached||(this.beforeDataLimits(),this.determineDataLimits(),this.afterDataLimits(),this._range=QP(this,b,g),this._dataLimitsCached=!0),this.beforeBuildTicks(),this.ticks=this.buildTicks()||[],this.afterBuildTicks();const r=A<this.ticks.length;this._convertTicksToLabels(r?Bw(this.ticks,A):this.ticks),this.configure(),this.beforeCalculateLabelRotation(),this.calculateLabelRotation(),this.afterCalculateLabelRotation(),M.display&&(M.autoSkip||M.source==="auto")&&(this.ticks=Ck(this,this.ticks),this._labelSizes=null,this.afterAutoSkip()),r&&this._convertTicksToLabels(this.ticks),this.beforeFit(),this.fit(),this.afterFit(),this.afterUpdate()}configure(){let o=this.options.reverse,u,m;this.isHorizontal()?(u=this.left,m=this.right):(u=this.top,m=this.bottom,o=!o),this._startPixel=u,this._endPixel=m,this._reversePixels=o,this._length=m-u,this._alignToPixels=this.options.alignToPixels}afterUpdate(){zn(this.options.afterUpdate,[this])}beforeSetDimensions(){zn(this.options.beforeSetDimensions,[this])}setDimensions(){this.isHorizontal()?(this.width=this.maxWidth,this.left=0,this.right=this.width):(this.height=this.maxHeight,this.top=0,this.bottom=this.height),this.paddingLeft=0,this.paddingTop=0,this.paddingRight=0,this.paddingBottom=0}afterSetDimensions(){zn(this.options.afterSetDimensions,[this])}_callHooks(o){this.chart.notifyPlugins(o,this.getContext()),zn(this.options[o],[this])}beforeDataLimits(){this._callHooks("beforeDataLimits")}determineDataLimits(){}afterDataLimits(){this._callHooks("afterDataLimits")}beforeBuildTicks(){this._callHooks("beforeBuildTicks")}buildTicks(){return[]}afterBuildTicks(){this._callHooks("afterBuildTicks")}beforeTickToLabelConversion(){zn(this.options.beforeTickToLabelConversion,[this])}generateTickLabels(o){const u=this.options.ticks;let m,g,b;for(m=0,g=o.length;m<g;m++)b=o[m],b.label=zn(u.callback,[b.value,m,o],this)}afterTickToLabelConversion(){zn(this.options.afterTickToLabelConversion,[this])}beforeCalculateLabelRotation(){zn(this.options.beforeCalculateLabelRotation,[this])}calculateLabelRotation(){const o=this.options,u=o.ticks,m=Fw(this.ticks.length,o.ticks.maxTicksLimit),g=u.minRotation||0,b=u.maxRotation;let M=g,A,r,k;if(!this._isVisible()||!u.display||g>=b||m<=1||!this.isHorizontal()){this.labelRotation=g;return}const F=this._getLabelSizes(),N=F.widest.width,W=F.highest.height,Q=Ar(this.chart.width-N,0,this.maxWidth);A=o.offset?this.maxWidth/m:Q/(m-1),N+6>A&&(A=Q/(m-(o.offset?.5:1)),r=this.maxHeight-af(o.grid)-u.padding-Nw(o.title,this.chart.options.font),k=Math.sqrt(N*N+W*W),M=tx(Math.min(Math.asin(Ar((F.highest.height+6)/A,-1,1)),Math.asin(Ar(r/k,-1,1))-Math.asin(Ar(W/k,-1,1)))),M=Math.max(g,Math.min(b,M))),this.labelRotation=M}afterCalculateLabelRotation(){zn(this.options.afterCalculateLabelRotation,[this])}afterAutoSkip(){}beforeFit(){zn(this.options.beforeFit,[this])}fit(){const o={width:0,height:0},{chart:u,options:{ticks:m,title:g,grid:b}}=this,M=this._isVisible(),A=this.isHorizontal();if(M){const r=Nw(g,u.options.font);if(A?(o.width=this.maxWidth,o.height=af(b)+r):(o.height=this.maxHeight,o.width=af(b)+r),m.display&&this.ticks.length){const{first:k,last:F,widest:N,highest:W}=this._getLabelSizes(),Q=m.padding*2,te=ao(this.labelRotation),ce=Math.cos(te),de=Math.sin(te);if(A){const ve=m.mirror?0:de*N.width+ce*W.height;o.height=Math.min(this.maxHeight,o.height+ve+Q)}else{const ve=m.mirror?0:ce*N.width+de*W.height;o.width=Math.min(this.maxWidth,o.width+ve+Q)}this._calculatePadding(k,F,de,ce)}}this._handleMargins(),A?(this.width=this._length=u.width-this._margins.left-this._margins.right,this.height=o.height):(this.width=o.width,this.height=this._length=u.height-this._margins.top-this._margins.bottom)}_calculatePadding(o,u,m,g){const{ticks:{align:b,padding:M},position:A}=this.options,r=this.labelRotation!==0,k=A!=="top"&&this.axis==="x";if(this.isHorizontal()){const F=this.getPixelForTick(0)-this.left,N=this.right-this.getPixelForTick(this.ticks.length-1);let W=0,Q=0;r?k?(W=g*o.width,Q=m*u.height):(W=m*o.height,Q=g*u.width):b==="start"?Q=u.width:b==="end"?W=o.width:b!=="inner"&&(W=o.width/2,Q=u.width/2),this.paddingLeft=Math.max((W-F+M)*this.width/(this.width-F),0),this.paddingRight=Math.max((Q-N+M)*this.width/(this.width-N),0)}else{let F=u.height/2,N=o.height/2;b==="start"?(F=0,N=o.height):b==="end"&&(F=u.height,N=0),this.paddingTop=F+M,this.paddingBottom=N+M}}_handleMargins(){this._margins&&(this._margins.left=Math.max(this.paddingLeft,this._margins.left),this._margins.top=Math.max(this.paddingTop,this._margins.top),this._margins.right=Math.max(this.paddingRight,this._margins.right),this._margins.bottom=Math.max(this.paddingBottom,this._margins.bottom))}afterFit(){zn(this.options.afterFit,[this])}isHorizontal(){const{axis:o,position:u}=this.options;return u==="top"||u==="bottom"||o==="x"}isFullSize(){return this.options.fullSize}_convertTicksToLabels(o){this.beforeTickToLabelConversion(),this.generateTickLabels(o);let u,m;for(u=0,m=o.length;u<m;u++)cn(o[u].label)&&(o.splice(u,1),m--,u--);this.afterTickToLabelConversion()}_getLabelSizes(){let o=this._labelSizes;if(!o){const u=this.options.ticks.sampleSize;let m=this.ticks;u<m.length&&(m=Bw(m,u)),this._labelSizes=o=this._computeLabelSizes(m,m.length,this.options.ticks.maxTicksLimit)}return o}_computeLabelSizes(o,u,m){const{ctx:g,_longestTextCache:b}=this,M=[],A=[],r=Math.floor(u/Fw(u,m));let k=0,F=0,N,W,Q,te,ce,de,ve,Te,Ee,Me,Ie;for(N=0;N<u;N+=r){if(te=o[N].label,ce=this._resolveTickFontOptions(N),g.font=de=ce.string,ve=b[de]=b[de]||{data:{},gc:[]},Te=ce.lineHeight,Ee=Me=0,!cn(te)&&!qn(te))Ee=O_(g,ve.data,ve.gc,Ee,te),Me=Te;else if(qn(te))for(W=0,Q=te.length;W<Q;++W)Ie=te[W],!cn(Ie)&&!qn(Ie)&&(Ee=O_(g,ve.data,ve.gc,Ee,Ie),Me+=Te);M.push(Ee),A.push(Me),k=Math.max(Ee,k),F=Math.max(Me,F)}Fk(b,u);const qe=M.indexOf(k),Ve=A.indexOf(F),nt=lt=>({width:M[lt]||0,height:A[lt]||0});return{first:nt(0),last:nt(u-1),widest:nt(qe),highest:nt(Ve),widths:M,heights:A}}getLabelForValue(o){return o}getPixelForValue(o,u){return NaN}getValueForPixel(o){}getPixelForTick(o){const u=this.ticks;return o<0||o>u.length-1?null:this.getPixelForValue(u[o].value)}getPixelForDecimal(o){this._reversePixels&&(o=1-o);const u=this._startPixel+o*this._length;return SP(this._alignToPixels?gc(this.chart,u,0):u)}getDecimalForPixel(o){const u=(o-this._startPixel)/this._length;return this._reversePixels?1-u:u}getBasePixel(){return this.getPixelForValue(this.getBaseValue())}getBaseValue(){const{min:o,max:u}=this;return o<0&&u<0?u:o>0&&u>0?o:0}getContext(o){const u=this.ticks||[];if(o>=0&&o<u.length){const m=u[o];return m.$context||(m.$context=Nk(this.getContext(),o,m))}return this.$context||(this.$context=Bk(this.chart.getContext(),this))}_tickSize(){const o=this.options.ticks,u=ao(this.labelRotation),m=Math.abs(Math.cos(u)),g=Math.abs(Math.sin(u)),b=this._getLabelSizes(),M=o.autoSkipPadding||0,A=b?b.widest.width+M:0,r=b?b.highest.height+M:0;return this.isHorizontal()?r*m>A*g?A/m:r/g:r*g<A*m?r/m:A/g}_isVisible(){const o=this.options.display;return o!=="auto"?!!o:this.getMatchingVisibleMetas().length>0}_computeGridLineItems(o){const u=this.axis,m=this.chart,g=this.options,{grid:b,position:M,border:A}=g,r=b.offset,k=this.isHorizontal(),N=this.ticks.length+(r?1:0),W=af(b),Q=[],te=A.setContext(this.getContext()),ce=te.display?te.width:0,de=ce/2,ve=function(wt){return gc(m,wt,ce)};let Te,Ee,Me,Ie,qe,Ve,nt,lt,ht,st,Ot,oi;if(M==="top")Te=ve(this.bottom),Ve=this.bottom-W,lt=Te-de,st=ve(o.top)+de,oi=o.bottom;else if(M==="bottom")Te=ve(this.top),st=o.top,oi=ve(o.bottom)-de,Ve=Te+de,lt=this.top+W;else if(M==="left")Te=ve(this.right),qe=this.right-W,nt=Te-de,ht=ve(o.left)+de,Ot=o.right;else if(M==="right")Te=ve(this.left),ht=o.left,Ot=ve(o.right)-de,qe=Te+de,nt=this.left+W;else if(u==="x"){if(M==="center")Te=ve((o.top+o.bottom)/2+.5);else if(en(M)){const wt=Object.keys(M)[0],di=M[wt];Te=ve(this.chart.scales[wt].getPixelForValue(di))}st=o.top,oi=o.bottom,Ve=Te+de,lt=Ve+W}else if(u==="y"){if(M==="center")Te=ve((o.left+o.right)/2);else if(en(M)){const wt=Object.keys(M)[0],di=M[wt];Te=ve(this.chart.scales[wt].getPixelForValue(di))}qe=Te-de,nt=qe-W,ht=o.left,Ot=o.right}const ii=Fi(g.ticks.maxTicksLimit,N),Xe=Math.max(1,Math.ceil(N/ii));for(Ee=0;Ee<N;Ee+=Xe){const wt=this.getContext(Ee),di=b.setContext(wt),Bt=A.setContext(wt),fi=di.lineWidth,Cn=di.color,_n=Bt.dash||[],Kt=Bt.dashOffset,gn=di.tickWidth,ji=di.tickColor,On=di.tickBorderDash||[],Zn=di.tickBorderDashOffset;Me=Ok(this,Ee,r),Me!==void 0&&(Ie=gc(m,Me,fi),k?qe=nt=ht=Ot=Ie:Ve=lt=st=oi=Ie,Q.push({tx1:qe,ty1:Ve,tx2:nt,ty2:lt,x1:ht,y1:st,x2:Ot,y2:oi,width:fi,color:Cn,borderDash:_n,borderDashOffset:Kt,tickWidth:gn,tickColor:ji,tickBorderDash:On,tickBorderDashOffset:Zn}))}return this._ticksLength=N,this._borderValue=Te,Q}_computeLabelItems(o){const u=this.axis,m=this.options,{position:g,ticks:b}=m,M=this.isHorizontal(),A=this.ticks,{align:r,crossAlign:k,padding:F,mirror:N}=b,W=af(m.grid),Q=W+F,te=N?-F:Q,ce=-ao(this.labelRotation),de=[];let ve,Te,Ee,Me,Ie,qe,Ve,nt,lt,ht,st,Ot,oi="middle";if(g==="top")qe=this.bottom-te,Ve=this._getXAxisLabelAlignment();else if(g==="bottom")qe=this.top+te,Ve=this._getXAxisLabelAlignment();else if(g==="left"){const Xe=this._getYAxisLabelAlignment(W);Ve=Xe.textAlign,Ie=Xe.x}else if(g==="right"){const Xe=this._getYAxisLabelAlignment(W);Ve=Xe.textAlign,Ie=Xe.x}else if(u==="x"){if(g==="center")qe=(o.top+o.bottom)/2+Q;else if(en(g)){const Xe=Object.keys(g)[0],wt=g[Xe];qe=this.chart.scales[Xe].getPixelForValue(wt)+Q}Ve=this._getXAxisLabelAlignment()}else if(u==="y"){if(g==="center")Ie=(o.left+o.right)/2-Q;else if(en(g)){const Xe=Object.keys(g)[0],wt=g[Xe];Ie=this.chart.scales[Xe].getPixelForValue(wt)}Ve=this._getYAxisLabelAlignment(W).textAlign}u==="y"&&(r==="start"?oi="top":r==="end"&&(oi="bottom"));const ii=this._getLabelSizes();for(ve=0,Te=A.length;ve<Te;++ve){Ee=A[ve],Me=Ee.label;const Xe=b.setContext(this.getContext(ve));nt=this.getPixelForTick(ve)+b.labelOffset,lt=this._resolveTickFontOptions(ve),ht=lt.lineHeight,st=qn(Me)?Me.length:1;const wt=st/2,di=Xe.color,Bt=Xe.textStrokeColor,fi=Xe.textStrokeWidth;let Cn=Ve;M?(Ie=nt,Ve==="inner"&&(ve===Te-1?Cn=this.options.reverse?"left":"right":ve===0?Cn=this.options.reverse?"right":"left":Cn="center"),g==="top"?k==="near"||ce!==0?Ot=-st*ht+ht/2:k==="center"?Ot=-ii.highest.height/2-wt*ht+ht:Ot=-ii.highest.height+ht/2:k==="near"||ce!==0?Ot=ht/2:k==="center"?Ot=ii.highest.height/2-wt*ht:Ot=ii.highest.height-st*ht,N&&(Ot*=-1),ce!==0&&!Xe.showLabelBackdrop&&(Ie+=ht/2*Math.sin(ce))):(qe=nt,Ot=(1-st)*ht/2);let _n;if(Xe.showLabelBackdrop){const Kt=qr(Xe.backdropPadding),gn=ii.heights[ve],ji=ii.widths[ve];let On=Ot-Kt.top,Zn=0-Kt.left;switch(oi){case"middle":On-=gn/2;break;case"bottom":On-=gn;break}switch(Ve){case"center":Zn-=ji/2;break;case"right":Zn-=ji;break;case"inner":ve===Te-1?Zn-=ji:ve>0&&(Zn-=ji/2);break}_n={left:Zn,top:On,width:ji+Kt.width,height:gn+Kt.height,color:Xe.backdropColor}}de.push({label:Me,font:lt,textOffset:Ot,options:{rotation:ce,color:di,strokeColor:Bt,strokeWidth:fi,textAlign:Cn,textBaseline:oi,translation:[Ie,qe],backdrop:_n}})}return de}_getXAxisLabelAlignment(){const{position:o,ticks:u}=this.options;if(-ao(this.labelRotation))return o==="top"?"left":"right";let g="center";return u.align==="start"?g="left":u.align==="end"?g="right":u.align==="inner"&&(g="inner"),g}_getYAxisLabelAlignment(o){const{position:u,ticks:{crossAlign:m,mirror:g,padding:b}}=this.options,M=this._getLabelSizes(),A=o+b,r=M.widest.width;let k,F;return u==="left"?g?(F=this.right+b,m==="near"?k="left":m==="center"?(k="center",F+=r/2):(k="right",F+=r)):(F=this.right-A,m==="near"?k="right":m==="center"?(k="center",F-=r/2):(k="left",F=this.left)):u==="right"?g?(F=this.left+b,m==="near"?k="right":m==="center"?(k="center",F-=r/2):(k="left",F-=r)):(F=this.left+A,m==="near"?k="left":m==="center"?(k="center",F+=r/2):(k="right",F=this.right)):k="right",{textAlign:k,x:F}}_computeLabelArea(){if(this.options.ticks.mirror)return;const o=this.chart,u=this.options.position;if(u==="left"||u==="right")return{top:0,left:this.left,bottom:o.height,right:this.right};if(u==="top"||u==="bottom")return{top:this.top,left:0,bottom:this.bottom,right:o.width}}drawBackground(){const{ctx:o,options:{backgroundColor:u},left:m,top:g,width:b,height:M}=this;u&&(o.save(),o.fillStyle=u,o.fillRect(m,g,b,M),o.restore())}getLineWidthForValue(o){const u=this.options.grid;if(!this._isVisible()||!u.display)return 0;const g=this.ticks.findIndex(b=>b.value===o);return g>=0?u.setContext(this.getContext(g)).lineWidth:0}drawGrid(o){const u=this.options.grid,m=this.ctx,g=this._gridLineItems||(this._gridLineItems=this._computeGridLineItems(o));let b,M;const A=(r,k,F)=>{!F.width||!F.color||(m.save(),m.lineWidth=F.width,m.strokeStyle=F.color,m.setLineDash(F.borderDash||[]),m.lineDashOffset=F.borderDashOffset,m.beginPath(),m.moveTo(r.x,r.y),m.lineTo(k.x,k.y),m.stroke(),m.restore())};if(u.display)for(b=0,M=g.length;b<M;++b){const r=g[b];u.drawOnChartArea&&A({x:r.x1,y:r.y1},{x:r.x2,y:r.y2},r),u.drawTicks&&A({x:r.tx1,y:r.ty1},{x:r.tx2,y:r.ty2},{color:r.tickColor,width:r.tickWidth,borderDash:r.tickBorderDash,borderDashOffset:r.tickBorderDashOffset})}}drawBorder(){const{chart:o,ctx:u,options:{border:m,grid:g}}=this,b=m.setContext(this.getContext()),M=m.display?b.width:0;if(!M)return;const A=g.setContext(this.getContext(0)).lineWidth,r=this._borderValue;let k,F,N,W;this.isHorizontal()?(k=gc(o,this.left,M)-M/2,F=gc(o,this.right,A)+A/2,N=W=r):(N=gc(o,this.top,M)-M/2,W=gc(o,this.bottom,A)+A/2,k=F=r),u.save(),u.lineWidth=b.width,u.strokeStyle=b.color,u.beginPath(),u.moveTo(k,N),u.lineTo(F,W),u.stroke(),u.restore()}drawLabels(o){if(!this.options.ticks.display)return;const m=this.ctx,g=this._computeLabelArea();g&&J_(m,g);const b=this.getLabelItems(o);for(const M of b){const A=M.options,r=M.font,k=M.label,F=M.textOffset;Ec(m,k,0,F,r,A)}g&&eg(m)}drawTitle(){const{ctx:o,options:{position:u,title:m,reverse:g}}=this;if(!m.display)return;const b=br(m.font),M=qr(m.padding),A=m.align;let r=b.lineHeight/2;u==="bottom"||u==="center"||en(u)?(r+=M.bottom,qn(m.text)&&(r+=b.lineHeight*(m.text.length-1))):r+=M.top;const{titleX:k,titleY:F,maxWidth:N,rotation:W}=Uk(this,r,u,A);Ec(o,m.text,0,0,b,{color:m.color,maxWidth:N,rotation:W,textAlign:Vk(A,u,g),textBaseline:"middle",translation:[k,F]})}draw(o){this._isVisible()&&(this.drawBackground(),this.drawGrid(o),this.drawBorder(),this.drawTitle(),this.drawLabels(o))}_layers(){const o=this.options,u=o.ticks&&o.ticks.z||0,m=Fi(o.grid&&o.grid.z,-1),g=Fi(o.border&&o.border.z,0);return!this._isVisible()||this.draw!==Cc.prototype.draw?[{z:u,draw:b=>{this.draw(b)}}]:[{z:m,draw:b=>{this.drawBackground(),this.drawGrid(b),this.drawTitle()}},{z:g,draw:()=>{this.drawBorder()}},{z:u,draw:b=>{this.drawLabels(b)}}]}getMatchingVisibleMetas(o){const u=this.chart.getSortedVisibleDatasetMetas(),m=this.axis+"AxisID",g=[];let b,M;for(b=0,M=u.length;b<M;++b){const A=u[b];A[m]===this.id&&(!o||A.type===o)&&g.push(A)}return g}_resolveTickFontOptions(o){const u=this.options.ticks.setContext(this.getContext(o));return br(u.font)}_maxDigits(){const o=this._resolveTickFontOptions(0).lineHeight;return(this.isHorizontal()?this.width:this.height)/o}}class l_{constructor(o,u,m){this.type=o,this.scope=u,this.override=m,this.items=Object.create(null)}isForType(o){return Object.prototype.isPrototypeOf.call(this.type.prototype,o.prototype)}register(o){const u=Object.getPrototypeOf(o);let m;Wk(u)&&(m=this.register(u));const g=this.items,b=o.id,M=this.scope+"."+b;if(!b)throw new Error("class does not have id: "+o);return b in g||(g[b]=o,jk(o,M,m),this.override&&er.override(o.id,o.overrides)),M}get(o){return this.items[o]}unregister(o){const u=this.items,m=o.id,g=this.scope;m in u&&delete u[m],g&&m in er[g]&&(delete er[g][m],this.override&&delete Sc[m])}}function jk(l,o,u){const m=Df(Object.create(null),[u?er.get(u):{},er.get(o),l.defaults]);er.set(o,m),l.defaultRoutes&&Gk(o,l.defaultRoutes),l.descriptors&&er.describe(o,l.descriptors)}function Gk(l,o){Object.keys(o).forEach(u=>{const m=u.split("."),g=m.pop(),b=[l].concat(m).join("."),M=o[u].split("."),A=M.pop(),r=M.join(".");er.route(b,g,r,A)})}function Wk(l){return"id"in l&&"defaults"in l}class qk{constructor(){this.controllers=new l_(co,"datasets",!0),this.elements=new l_(uo,"elements"),this.plugins=new l_(Object,"plugins"),this.scales=new l_(Cc,"scales"),this._typedRegistries=[this.controllers,this.scales,this.elements]}add(...o){this._each("register",o)}remove(...o){this._each("unregister",o)}addControllers(...o){this._each("register",o,this.controllers)}addElements(...o){this._each("register",o,this.elements)}addPlugins(...o){this._each("register",o,this.plugins)}addScales(...o){this._each("register",o,this.scales)}getController(o){return this._get(o,this.controllers,"controller")}getElement(o){return this._get(o,this.elements,"element")}getPlugin(o){return this._get(o,this.plugins,"plugin")}getScale(o){return this._get(o,this.scales,"scale")}removeControllers(...o){this._each("unregister",o,this.controllers)}removeElements(...o){this._each("unregister",o,this.elements)}removePlugins(...o){this._each("unregister",o,this.plugins)}removeScales(...o){this._each("unregister",o,this.scales)}_each(o,u,m){[...u].forEach(g=>{const b=m||this._getRegistryForType(g);m||b.isForType(g)||b===this.plugins&&g.id?this._exec(o,b,g):Mn(g,M=>{const A=m||this._getRegistryForType(M);this._exec(o,A,M)})})}_exec(o,u,m){const g=ex(o);zn(m["before"+g],[],m),u[o](m),zn(m["after"+g],[],m)}_getRegistryForType(o){for(let u=0;u<this._typedRegistries.length;u++){const m=this._typedRegistries[u];if(m.isForType(o))return m}return this.plugins}_get(o,u,m){const g=u.get(o);if(g===void 0)throw new Error('"'+o+'" is not a registered '+m+".");return g}}var Io=new qk;class Hk{constructor(){this._init=[]}notify(o,u,m,g){u==="beforeInit"&&(this._init=this._createDescriptors(o,!0),this._notify(this._init,o,"install"));const b=g?this._descriptors(o).filter(g):this._descriptors(o),M=this._notify(b,o,u,m);return u==="afterDestroy"&&(this._notify(b,o,"stop"),this._notify(this._init,o,"uninstall")),M}_notify(o,u,m,g){g=g||{};for(const b of o){const M=b.plugin,A=M[m],r=[u,g,b.options];if(zn(A,r,M)===!1&&g.cancelable)return!1}return!0}invalidate(){cn(this._cache)||(this._oldCache=this._cache,this._cache=void 0)}_descriptors(o){if(this._cache)return this._cache;const u=this._cache=this._createDescriptors(o);return this._notifyStateChanges(o),u}_createDescriptors(o,u){const m=o&&o.config,g=Fi(m.options&&m.options.plugins,{}),b=Zk(m);return g===!1&&!u?[]:Yk(o,b,g,u)}_notifyStateChanges(o){const u=this._oldCache||[],m=this._cache,g=(b,M)=>b.filter(A=>!M.some(r=>A.plugin.id===r.plugin.id));this._notify(g(u,m),o,"stop"),this._notify(g(m,u),o,"start")}}function Zk(l){const o={},u=[],m=Object.keys(Io.plugins.items);for(let b=0;b<m.length;b++)u.push(Io.getPlugin(m[b]));const g=l.plugins||[];for(let b=0;b<g.length;b++){const M=g[b];u.indexOf(M)===-1&&(u.push(M),o[M.id]=!0)}return{plugins:u,localIds:o}}function $k(l,o){return!o&&l===!1?null:l===!0?{}:l}function Yk(l,{plugins:o,localIds:u},m,g){const b=[],M=l.getContext();for(const A of o){const r=A.id,k=$k(m[r],g);k!==null&&b.push({plugin:A,options:Qk(l.config,{plugin:A,local:u[r]},k,M)})}return b}function Qk(l,{plugin:o,local:u},m,g){const b=l.pluginScopeKeys(o),M=l.getOptionScopes(m,b);return u&&o.defaults&&M.push(o.defaults),l.createResolver(M,g,[""],{scriptable:!1,indexable:!1,allKeys:!0})}function D0(l,o){const u=er.datasets[l]||{};return((o.datasets||{})[l]||{}).indexAxis||o.indexAxis||u.indexAxis||"x"}function Xk(l,o){let u=l;return l==="_index_"?u=o:l==="_value_"&&(u=o==="x"?"y":"x"),u}function Kk(l,o){return l===o?"_index_":"_value_"}function Vw(l){if(l==="x"||l==="y"||l==="r")return l}function Jk(l){if(l==="top"||l==="bottom")return"x";if(l==="left"||l==="right")return"y"}function k0(l,...o){if(Vw(l))return l;for(const u of o){const m=u.axis||Jk(u.position)||l.length>1&&Vw(l[0].toLowerCase());if(m)return m}throw new Error(`Cannot determine type of '${l}' axis. Please provide 'axis' or 'position' option.`)}function Uw(l,o,u){if(u[o+"AxisID"]===l)return{axis:o}}function eR(l,o){if(o.data&&o.data.datasets){const u=o.data.datasets.filter(m=>m.xAxisID===l||m.yAxisID===l);if(u.length)return Uw(l,"x",u[0])||Uw(l,"y",u[0])}return{}}function tR(l,o){const u=Sc[l.type]||{scales:{}},m=o.scales||{},g=D0(l.type,o),b=Object.create(null);return Object.keys(m).forEach(M=>{const A=m[M];if(!en(A))return console.error(`Invalid scale configuration for scale: ${M}`);if(A._proxy)return console.warn(`Ignoring resolver passed as options for scale: ${M}`);const r=k0(M,A,eR(M,l),er.scales[A.type]),k=Kk(r,g),F=u.scales||{};b[M]=Tf(Object.create(null),[{axis:r},A,F[r],F[k]])}),l.data.datasets.forEach(M=>{const A=M.type||l.type,r=M.indexAxis||D0(A,o),F=(Sc[A]||{}).scales||{};Object.keys(F).forEach(N=>{const W=Xk(N,r),Q=M[W+"AxisID"]||W;b[Q]=b[Q]||Object.create(null),Tf(b[Q],[{axis:W},m[Q],F[N]])})}),Object.keys(b).forEach(M=>{const A=b[M];Tf(A,[er.scales[A.type],er.scale])}),b}function QM(l){const o=l.options||(l.options={});o.plugins=Fi(o.plugins,{}),o.scales=tR(l,o)}function XM(l){return l=l||{},l.datasets=l.datasets||[],l.labels=l.labels||[],l}function iR(l){return l=l||{},l.data=XM(l.data),QM(l),l}const jw=new Map,KM=new Set;function c_(l,o){let u=jw.get(l);return u||(u=o(),jw.set(l,u),KM.add(u)),u}const lf=(l,o,u)=>{const m=cl(o,u);m!==void 0&&l.add(m)};class nR{constructor(o){this._config=iR(o),this._scopeCache=new Map,this._resolverCache=new Map}get platform(){return this._config.platform}get type(){return this._config.type}set type(o){this._config.type=o}get data(){return this._config.data}set data(o){this._config.data=XM(o)}get options(){return this._config.options}set options(o){this._config.options=o}get plugins(){return this._config.plugins}update(){const o=this._config;this.clearCache(),QM(o)}clearCache(){this._scopeCache.clear(),this._resolverCache.clear()}datasetScopeKeys(o){return c_(o,()=>[[`datasets.${o}`,""]])}datasetAnimationScopeKeys(o,u){return c_(`${o}.transition.${u}`,()=>[[`datasets.${o}.transitions.${u}`,`transitions.${u}`],[`datasets.${o}`,""]])}datasetElementScopeKeys(o,u){return c_(`${o}-${u}`,()=>[[`datasets.${o}.elements.${u}`,`datasets.${o}`,`elements.${u}`,""]])}pluginScopeKeys(o){const u=o.id,m=this.type;return c_(`${m}-plugin-${u}`,()=>[[`plugins.${u}`,...o.additionalOptionScopes||[]]])}_cachedScopes(o,u){const m=this._scopeCache;let g=m.get(o);return(!g||u)&&(g=new Map,m.set(o,g)),g}getOptionScopes(o,u,m){const{options:g,type:b}=this,M=this._cachedScopes(o,m),A=M.get(u);if(A)return A;const r=new Set;u.forEach(F=>{o&&(r.add(o),F.forEach(N=>lf(r,o,N))),F.forEach(N=>lf(r,g,N)),F.forEach(N=>lf(r,Sc[b]||{},N)),F.forEach(N=>lf(r,er,N)),F.forEach(N=>lf(r,I0,N))});const k=Array.from(r);return k.length===0&&k.push(Object.create(null)),KM.has(u)&&M.set(u,k),k}chartOptionScopes(){const{options:o,type:u}=this;return[o,Sc[u]||{},er.datasets[u]||{},{type:u},er,I0]}resolveNamedOptions(o,u,m,g=[""]){const b={$shared:!0},{resolver:M,subPrefixes:A}=Gw(this._resolverCache,o,g);let r=M;if(sR(M,u)){b.$shared=!1,m=ul(m)?m():m;const k=this.createResolver(o,m,A);r=dh(M,m,k)}for(const k of u)b[k]=r[k];return b}createResolver(o,u,m=[""],g){const{resolver:b}=Gw(this._resolverCache,o,m);return en(u)?dh(b,u,void 0,g):b}}function Gw(l,o,u){let m=l.get(o);m||(m=new Map,l.set(o,m));const g=u.join();let b=m.get(g);return b||(b={resolver:ox(o,u),subPrefixes:u.filter(A=>!A.toLowerCase().includes("hover"))},m.set(g,b)),b}const rR=l=>en(l)&&Object.getOwnPropertyNames(l).some(o=>ul(l[o]));function sR(l,o){const{isScriptable:u,isIndexable:m}=DM(l);for(const g of o){const b=u(g),M=m(g),A=(M||b)&&l[g];if(b&&(ul(A)||rR(A))||M&&qn(A))return!0}return!1}var oR="4.4.3";const aR=["top","bottom","left","right","chartArea"];function Ww(l,o){return l==="top"||l==="bottom"||aR.indexOf(l)===-1&&o==="x"}function qw(l,o){return function(u,m){return u[l]===m[l]?u[o]-m[o]:u[l]-m[l]}}function Hw(l){const o=l.chart,u=o.options.animation;o.notifyPlugins("afterRender"),zn(u&&u.onComplete,[l],o)}function lR(l){const o=l.chart,u=o.options.animation;zn(u&&u.onProgress,[l],o)}function JM(l){return cx()&&typeof l=="string"?l=document.getElementById(l):l&&l.length&&(l=l[0]),l&&l.canvas&&(l=l.canvas),l}const S_={},Zw=l=>{const o=JM(l);return Object.values(S_).filter(u=>u.canvas===o).pop()};function cR(l,o,u){const m=Object.keys(l);for(const g of m){const b=+g;if(b>=o){const M=l[g];delete l[g],(u>0||b>o)&&(l[b+u]=M)}}}function uR(l,o,u,m){return!u||l.type==="mouseout"?null:m?o:l}function u_(l,o,u){return l.options.clip?l[u]:o[u]}function hR(l,o){const{xScale:u,yScale:m}=l;return u&&m?{left:u_(u,o,"left"),right:u_(u,o,"right"),top:u_(m,o,"top"),bottom:u_(m,o,"bottom")}:o}class la{static register(...o){Io.add(...o),$w()}static unregister(...o){Io.remove(...o),$w()}constructor(o,u){const m=this.config=new nR(u),g=JM(o),b=Zw(g);if(b)throw new Error("Canvas is already in use. Chart with ID '"+b.id+"' must be destroyed before the canvas with ID '"+b.canvas.id+"' can be reused.");const M=m.createResolver(m.chartOptionScopes(),this.getContext());this.platform=new(m.platform||Ik(g)),this.platform.updateConfig(m);const A=this.platform.acquireContext(g,M.aspectRatio),r=A&&A.canvas,k=r&&r.height,F=r&&r.width;if(this.id=fP(),this.ctx=A,this.canvas=r,this.width=F,this.height=k,this._options=M,this._aspectRatio=this.aspectRatio,this._layers=[],this._metasets=[],this._stacks=void 0,this.boxes=[],this.currentDevicePixelRatio=void 0,this.chartArea=void 0,this._active=[],this._lastEvent=void 0,this._listeners={},this._responsiveListeners=void 0,this._sortedMetasets=[],this.scales={},this._plugins=new Hk,this.$proxies={},this._hiddenIndices={},this.attached=!1,this._animationsDisabled=void 0,this.$context=void 0,this._doResize=CP(N=>this.update(N),M.resizeDelay||0),this._dataChanges=[],S_[this.id]=this,!A||!r){console.error("Failed to create chart: can't acquire context from the given item");return}sa.listen(this,"complete",Hw),sa.listen(this,"progress",lR),this._initialize(),this.attached&&this.update()}get aspectRatio(){const{options:{aspectRatio:o,maintainAspectRatio:u},width:m,height:g,_aspectRatio:b}=this;return cn(o)?u&&b?b:g?m/g:null:o}get data(){return this.config.data}set data(o){this.config.data=o}get options(){return this._options}set options(o){this.config.options=o}get registry(){return Io}_initialize(){return this.notifyPlugins("beforeInit"),this.options.responsive?this.resize():mw(this,this.options.devicePixelRatio),this.bindEvents(),this.notifyPlugins("afterInit"),this}clear(){return dw(this.canvas,this.ctx),this}stop(){return sa.stop(this),this}resize(o,u){sa.running(this)?this._resizeBeforeDraw={width:o,height:u}:this._resize(o,u)}_resize(o,u){const m=this.options,g=this.canvas,b=m.maintainAspectRatio&&this.aspectRatio,M=this.platform.getMaximumSize(g,o,u,b),A=m.devicePixelRatio||this.platform.getDevicePixelRatio(),r=this.width?"resize":"attach";this.width=M.width,this.height=M.height,this._aspectRatio=this.aspectRatio,mw(this,A,!0)&&(this.notifyPlugins("resize",{size:M}),zn(m.onResize,[this,M],this),this.attached&&this._doResize(r)&&this.render())}ensureScalesHaveIDs(){const u=this.options.scales||{};Mn(u,(m,g)=>{m.id=g})}buildOrUpdateScales(){const o=this.options,u=o.scales,m=this.scales,g=Object.keys(m).reduce((M,A)=>(M[A]=!1,M),{});let b=[];u&&(b=b.concat(Object.keys(u).map(M=>{const A=u[M],r=k0(M,A),k=r==="r",F=r==="x";return{options:A,dposition:k?"chartArea":F?"bottom":"left",dtype:k?"radialLinear":F?"category":"linear"}}))),Mn(b,M=>{const A=M.options,r=A.id,k=k0(r,A),F=Fi(A.type,M.dtype);(A.position===void 0||Ww(A.position,k)!==Ww(M.dposition))&&(A.position=M.dposition),g[r]=!0;let N=null;if(r in m&&m[r].type===F)N=m[r];else{const W=Io.getScale(F);N=new W({id:r,type:F,ctx:this.ctx,chart:this}),m[N.id]=N}N.init(A,o)}),Mn(g,(M,A)=>{M||delete m[A]}),Mn(m,M=>{Wr.configure(this,M,M.options),Wr.addBox(this,M)})}_updateMetasets(){const o=this._metasets,u=this.data.datasets.length,m=o.length;if(o.sort((g,b)=>g.index-b.index),m>u){for(let g=u;g<m;++g)this._destroyDatasetMeta(g);o.splice(u,m-u)}this._sortedMetasets=o.slice(0).sort(qw("order","index"))}_removeUnreferencedMetasets(){const{_metasets:o,data:{datasets:u}}=this;o.length>u.length&&delete this._stacks,o.forEach((m,g)=>{u.filter(b=>b===m._dataset).length===0&&this._destroyDatasetMeta(g)})}buildOrUpdateControllers(){const o=[],u=this.data.datasets;let m,g;for(this._removeUnreferencedMetasets(),m=0,g=u.length;m<g;m++){const b=u[m];let M=this.getDatasetMeta(m);const A=b.type||this.config.type;if(M.type&&M.type!==A&&(this._destroyDatasetMeta(m),M=this.getDatasetMeta(m)),M.type=A,M.indexAxis=b.indexAxis||D0(A,this.options),M.order=b.order||0,M.index=m,M.label=""+b.label,M.visible=this.isDatasetVisible(m),M.controller)M.controller.updateIndex(m),M.controller.linkScales();else{const r=Io.getController(A),{datasetElementType:k,dataElementType:F}=er.datasets[A];Object.assign(r,{dataElementType:Io.getElement(F),datasetElementType:k&&Io.getElement(k)}),M.controller=new r(this,m),o.push(M.controller)}}return this._updateMetasets(),o}_resetElements(){Mn(this.data.datasets,(o,u)=>{this.getDatasetMeta(u).controller.reset()},this)}reset(){this._resetElements(),this.notifyPlugins("reset")}update(o){const u=this.config;u.update();const m=this._options=u.createResolver(u.chartOptionScopes(),this.getContext()),g=this._animationsDisabled=!m.animation;if(this._updateScales(),this._checkEventBindings(),this._updateHiddenIndices(),this._plugins.invalidate(),this.notifyPlugins("beforeUpdate",{mode:o,cancelable:!0})===!1)return;const b=this.buildOrUpdateControllers();this.notifyPlugins("beforeElementsUpdate");let M=0;for(let k=0,F=this.data.datasets.length;k<F;k++){const{controller:N}=this.getDatasetMeta(k),W=!g&&b.indexOf(N)===-1;N.buildOrUpdateElements(W),M=Math.max(+N.getMaxOverflow(),M)}M=this._minPadding=m.layout.autoPadding?M:0,this._updateLayout(M),g||Mn(b,k=>{k.reset()}),this._updateDatasets(o),this.notifyPlugins("afterUpdate",{mode:o}),this._layers.sort(qw("z","_idx"));const{_active:A,_lastEvent:r}=this;r?this._eventHandler(r,!0):A.length&&this._updateHoverStyles(A,A,!0),this.render()}_updateScales(){Mn(this.scales,o=>{Wr.removeBox(this,o)}),this.ensureScalesHaveIDs(),this.buildOrUpdateScales()}_checkEventBindings(){const o=this.options,u=new Set(Object.keys(this._listeners)),m=new Set(o.events);(!nw(u,m)||!!this._responsiveListeners!==o.responsive)&&(this.unbindEvents(),this.bindEvents())}_updateHiddenIndices(){const{_hiddenIndices:o}=this,u=this._getUniformDataChanges()||[];for(const{method:m,start:g,count:b}of u){const M=m==="_removeElements"?-b:b;cR(o,g,M)}}_getUniformDataChanges(){const o=this._dataChanges;if(!o||!o.length)return;this._dataChanges=[];const u=this.data.datasets.length,m=b=>new Set(o.filter(M=>M[0]===b).map((M,A)=>A+","+M.splice(1).join(","))),g=m(0);for(let b=1;b<u;b++)if(!nw(g,m(b)))return;return Array.from(g).map(b=>b.split(",")).map(b=>({method:b[1],start:+b[2],count:+b[3]}))}_updateLayout(o){if(this.notifyPlugins("beforeLayout",{cancelable:!0})===!1)return;Wr.update(this,this.width,this.height,o);const u=this.chartArea,m=u.width<=0||u.height<=0;this._layers=[],Mn(this.boxes,g=>{m&&g.position==="chartArea"||(g.configure&&g.configure(),this._layers.push(...g._layers()))},this),this._layers.forEach((g,b)=>{g._idx=b}),this.notifyPlugins("afterLayout")}_updateDatasets(o){if(this.notifyPlugins("beforeDatasetsUpdate",{mode:o,cancelable:!0})!==!1){for(let u=0,m=this.data.datasets.length;u<m;++u)this.getDatasetMeta(u).controller.configure();for(let u=0,m=this.data.datasets.length;u<m;++u)this._updateDataset(u,ul(o)?o({datasetIndex:u}):o);this.notifyPlugins("afterDatasetsUpdate",{mode:o})}}_updateDataset(o,u){const m=this.getDatasetMeta(o),g={meta:m,index:o,mode:u,cancelable:!0};this.notifyPlugins("beforeDatasetUpdate",g)!==!1&&(m.controller._update(u),g.cancelable=!1,this.notifyPlugins("afterDatasetUpdate",g))}render(){this.notifyPlugins("beforeRender",{cancelable:!0})!==!1&&(sa.has(this)?this.attached&&!sa.running(this)&&sa.start(this):(this.draw(),Hw({chart:this})))}draw(){let o;if(this._resizeBeforeDraw){const{width:m,height:g}=this._resizeBeforeDraw;this._resize(m,g),this._resizeBeforeDraw=null}if(this.clear(),this.width<=0||this.height<=0||this.notifyPlugins("beforeDraw",{cancelable:!0})===!1)return;const u=this._layers;for(o=0;o<u.length&&u[o].z<=0;++o)u[o].draw(this.chartArea);for(this._drawDatasets();o<u.length;++o)u[o].draw(this.chartArea);this.notifyPlugins("afterDraw")}_getSortedDatasetMetas(o){const u=this._sortedMetasets,m=[];let g,b;for(g=0,b=u.length;g<b;++g){const M=u[g];(!o||M.visible)&&m.push(M)}return m}getSortedVisibleDatasetMetas(){return this._getSortedDatasetMetas(!0)}_drawDatasets(){if(this.notifyPlugins("beforeDatasetsDraw",{cancelable:!0})===!1)return;const o=this.getSortedVisibleDatasetMetas();for(let u=o.length-1;u>=0;--u)this._drawDataset(o[u]);this.notifyPlugins("afterDatasetsDraw")}_drawDataset(o){const u=this.ctx,m=o._clip,g=!m.disabled,b=hR(o,this.chartArea),M={meta:o,index:o.index,cancelable:!0};this.notifyPlugins("beforeDatasetDraw",M)!==!1&&(g&&J_(u,{left:m.left===!1?0:b.left-m.left,right:m.right===!1?this.width:b.right+m.right,top:m.top===!1?0:b.top-m.top,bottom:m.bottom===!1?this.height:b.bottom+m.bottom}),o.controller.draw(),g&&eg(u),M.cancelable=!1,this.notifyPlugins("afterDatasetDraw",M))}isPointInArea(o){return ha(o,this.chartArea,this._minPadding)}getElementsAtEventForMode(o,u,m,g){const b=ak.modes[u];return typeof b=="function"?b(this,o,m,g):[]}getDatasetMeta(o){const u=this.data.datasets[o],m=this._metasets;let g=m.filter(b=>b&&b._dataset===u).pop();return g||(g={type:null,data:[],dataset:null,controller:null,hidden:null,xAxisID:null,yAxisID:null,order:u&&u.order||0,index:o,_dataset:u,_parsed:[],_sorted:!1},m.push(g)),g}getContext(){return this.$context||(this.$context=hl(null,{chart:this,type:"chart"}))}getVisibleDatasetCount(){return this.getSortedVisibleDatasetMetas().length}isDatasetVisible(o){const u=this.data.datasets[o];if(!u)return!1;const m=this.getDatasetMeta(o);return typeof m.hidden=="boolean"?!m.hidden:!u.hidden}setDatasetVisibility(o,u){const m=this.getDatasetMeta(o);m.hidden=!u}toggleDataVisibility(o){this._hiddenIndices[o]=!this._hiddenIndices[o]}getDataVisibility(o){return!this._hiddenIndices[o]}_updateVisibility(o,u,m){const g=m?"show":"hide",b=this.getDatasetMeta(o),M=b.controller._resolveAnimations(void 0,g);kf(u)?(b.data[u].hidden=!m,this.update()):(this.setDatasetVisibility(o,m),M.update(b,{visible:m}),this.update(A=>A.datasetIndex===o?g:void 0))}hide(o,u){this._updateVisibility(o,u,!1)}show(o,u){this._updateVisibility(o,u,!0)}_destroyDatasetMeta(o){const u=this._metasets[o];u&&u.controller&&u.controller._destroy(),delete this._metasets[o]}_stop(){let o,u;for(this.stop(),sa.remove(this),o=0,u=this.data.datasets.length;o<u;++o)this._destroyDatasetMeta(o)}destroy(){this.notifyPlugins("beforeDestroy");const{canvas:o,ctx:u}=this;this._stop(),this.config.clearCache(),o&&(this.unbindEvents(),dw(o,u),this.platform.releaseContext(u),this.canvas=null,this.ctx=null),delete S_[this.id],this.notifyPlugins("afterDestroy")}toBase64Image(...o){return this.canvas.toDataURL(...o)}bindEvents(){this.bindUserEvents(),this.options.responsive?this.bindResponsiveEvents():this.attached=!0}bindUserEvents(){const o=this._listeners,u=this.platform,m=(b,M)=>{u.addEventListener(this,b,M),o[b]=M},g=(b,M,A)=>{b.offsetX=M,b.offsetY=A,this._eventHandler(b)};Mn(this.options.events,b=>m(b,g))}bindResponsiveEvents(){this._responsiveListeners||(this._responsiveListeners={});const o=this._responsiveListeners,u=this.platform,m=(r,k)=>{u.addEventListener(this,r,k),o[r]=k},g=(r,k)=>{o[r]&&(u.removeEventListener(this,r,k),delete o[r])},b=(r,k)=>{this.canvas&&this.resize(r,k)};let M;const A=()=>{g("attach",A),this.attached=!0,this.resize(),m("resize",b),m("detach",M)};M=()=>{this.attached=!1,g("resize",b),this._stop(),this._resize(0,0),m("attach",A)},u.isAttached(this.canvas)?A():M()}unbindEvents(){Mn(this._listeners,(o,u)=>{this.platform.removeEventListener(this,u,o)}),this._listeners={},Mn(this._responsiveListeners,(o,u)=>{this.platform.removeEventListener(this,u,o)}),this._responsiveListeners=void 0}updateHoverStyle(o,u,m){const g=m?"set":"remove";let b,M,A,r;for(u==="dataset"&&(b=this.getDatasetMeta(o[0].datasetIndex),b.controller["_"+g+"DatasetHoverStyle"]()),A=0,r=o.length;A<r;++A){M=o[A];const k=M&&this.getDatasetMeta(M.datasetIndex).controller;k&&k[g+"HoverStyle"](M.element,M.datasetIndex,M.index)}}getActiveElements(){return this._active||[]}setActiveElements(o){const u=this._active||[],m=o.map(({datasetIndex:b,index:M})=>{const A=this.getDatasetMeta(b);if(!A)throw new Error("No dataset found at index "+b);return{datasetIndex:b,element:A.data[M],index:M}});!R_(m,u)&&(this._active=m,this._lastEvent=null,this._updateHoverStyles(m,u))}notifyPlugins(o,u,m){return this._plugins.notify(this,o,u,m)}isPluginEnabled(o){return this._plugins._cache.filter(u=>u.plugin.id===o).length===1}_updateHoverStyles(o,u,m){const g=this.options.hover,b=(r,k)=>r.filter(F=>!k.some(N=>F.datasetIndex===N.datasetIndex&&F.index===N.index)),M=b(u,o),A=m?o:b(o,u);M.length&&this.updateHoverStyle(M,g.mode,!1),A.length&&g.mode&&this.updateHoverStyle(A,g.mode,!0)}_eventHandler(o,u){const m={event:o,replay:u,cancelable:!0,inChartArea:this.isPointInArea(o)},g=M=>(M.options.events||this.options.events).includes(o.native.type);if(this.notifyPlugins("beforeEvent",m,g)===!1)return;const b=this._handleEvent(o,u,m.inChartArea);return m.cancelable=!1,this.notifyPlugins("afterEvent",m,g),(b||m.changed)&&this.render(),this}_handleEvent(o,u,m){const{_active:g=[],options:b}=this,M=u,A=this._getActiveElements(o,g,m,M),r=xP(o),k=uR(o,this._lastEvent,m,r);m&&(this._lastEvent=null,zn(b.onHover,[o,A,this],this),r&&zn(b.onClick,[o,A,this],this));const F=!R_(A,g);return(F||u)&&(this._active=A,this._updateHoverStyles(A,g,u)),this._lastEvent=k,F}_getActiveElements(o,u,m,g){if(o.type==="mouseout")return[];if(!m)return u;const b=this.options.hover;return this.getElementsAtEventForMode(o,b.mode,b,g)}}Ft(la,"defaults",er),Ft(la,"instances",S_),Ft(la,"overrides",Sc),Ft(la,"registry",Io),Ft(la,"version",oR),Ft(la,"getChart",Zw);function $w(){return Mn(la.instances,l=>l._plugins.invalidate())}function dR(l,o,u){const{startAngle:m,pixelMargin:g,x:b,y:M,outerRadius:A,innerRadius:r}=o;let k=g/A;l.beginPath(),l.arc(b,M,A,m-k,u+k),r>g?(k=g/r,l.arc(b,M,r,u+k,m-k,!0)):l.arc(b,M,g,u+ar,m-ar),l.closePath(),l.clip()}function fR(l){return sx(l,["outerStart","outerEnd","innerStart","innerEnd"])}function pR(l,o,u,m){const g=fR(l.options.borderRadius),b=(u-o)/2,M=Math.min(b,m*o/2),A=r=>{const k=(u-Math.min(b,r))*m/2;return Ar(r,0,Math.min(b,k))};return{outerStart:A(g.outerStart),outerEnd:A(g.outerEnd),innerStart:Ar(g.innerStart,0,M),innerEnd:Ar(g.innerEnd,0,M)}}function nh(l,o,u,m){return{x:u+l*Math.cos(o),y:m+l*Math.sin(o)}}function N_(l,o,u,m,g,b){const{x:M,y:A,startAngle:r,pixelMargin:k,innerRadius:F}=o,N=Math.max(o.outerRadius+m+u-k,0),W=F>0?F+m+u+k:0;let Q=0;const te=g-r;if(m){const Xe=F>0?F-m:0,wt=N>0?N-m:0,di=(Xe+wt)/2,Bt=di!==0?te*di/(di+m):te;Q=(te-Bt)/2}const ce=Math.max(.001,te*N-u/Vn)/N,de=(te-ce)/2,ve=r+de+Q,Te=g-de-Q,{outerStart:Ee,outerEnd:Me,innerStart:Ie,innerEnd:qe}=pR(o,W,N,Te-ve),Ve=N-Ee,nt=N-Me,lt=ve+Ee/Ve,ht=Te-Me/nt,st=W+Ie,Ot=W+qe,oi=ve+Ie/st,ii=Te-qe/Ot;if(l.beginPath(),b){const Xe=(lt+ht)/2;if(l.arc(M,A,N,lt,Xe),l.arc(M,A,N,Xe,ht),Me>0){const fi=nh(nt,ht,M,A);l.arc(fi.x,fi.y,Me,ht,Te+ar)}const wt=nh(Ot,Te,M,A);if(l.lineTo(wt.x,wt.y),qe>0){const fi=nh(Ot,ii,M,A);l.arc(fi.x,fi.y,qe,Te+ar,ii+Math.PI)}const di=(Te-qe/W+(ve+Ie/W))/2;if(l.arc(M,A,W,Te-qe/W,di,!0),l.arc(M,A,W,di,ve+Ie/W,!0),Ie>0){const fi=nh(st,oi,M,A);l.arc(fi.x,fi.y,Ie,oi+Math.PI,ve-ar)}const Bt=nh(Ve,ve,M,A);if(l.lineTo(Bt.x,Bt.y),Ee>0){const fi=nh(Ve,lt,M,A);l.arc(fi.x,fi.y,Ee,ve-ar,lt)}}else{l.moveTo(M,A);const Xe=Math.cos(lt)*N+M,wt=Math.sin(lt)*N+A;l.lineTo(Xe,wt);const di=Math.cos(ht)*N+M,Bt=Math.sin(ht)*N+A;l.lineTo(di,Bt)}l.closePath()}function mR(l,o,u,m,g){const{fullCircles:b,startAngle:M,circumference:A}=o;let r=o.endAngle;if(b){N_(l,o,u,m,r,g);for(let k=0;k<b;++k)l.fill();isNaN(A)||(r=M+(A%Nn||Nn))}return N_(l,o,u,m,r,g),l.fill(),r}function _R(l,o,u,m,g){const{fullCircles:b,startAngle:M,circumference:A,options:r}=o,{borderWidth:k,borderJoinStyle:F,borderDash:N,borderDashOffset:W}=r,Q=r.borderAlign==="inner";if(!k)return;l.setLineDash(N||[]),l.lineDashOffset=W,Q?(l.lineWidth=k*2,l.lineJoin=F||"round"):(l.lineWidth=k,l.lineJoin=F||"bevel");let te=o.endAngle;if(b){N_(l,o,u,m,te,g);for(let ce=0;ce<b;++ce)l.stroke();isNaN(A)||(te=M+(A%Nn||Nn))}Q&&dR(l,o,te),b||(N_(l,o,u,m,te,g),l.stroke())}class _f extends uo{constructor(u){super();Ft(this,"circumference");Ft(this,"endAngle");Ft(this,"fullCircles");Ft(this,"innerRadius");Ft(this,"outerRadius");Ft(this,"pixelMargin");Ft(this,"startAngle");this.options=void 0,this.circumference=void 0,this.startAngle=void 0,this.endAngle=void 0,this.innerRadius=void 0,this.outerRadius=void 0,this.pixelMargin=0,this.fullCircles=0,u&&Object.assign(this,u)}inRange(u,m,g){const b=this.getProps(["x","y"],g),{angle:M,distance:A}=bM(b,{x:u,y:m}),{startAngle:r,endAngle:k,innerRadius:F,outerRadius:N,circumference:W}=this.getProps(["startAngle","endAngle","innerRadius","outerRadius","circumference"],g),Q=(this.options.spacing+this.options.borderWidth)/2,ce=Fi(W,k-r)>=Nn||Rf(M,r,k),de=ca(A,F+Q,N+Q);return ce&&de}getCenterPoint(u){const{x:m,y:g,startAngle:b,endAngle:M,innerRadius:A,outerRadius:r}=this.getProps(["x","y","startAngle","endAngle","innerRadius","outerRadius"],u),{offset:k,spacing:F}=this.options,N=(b+M)/2,W=(A+r+F+k)/2;return{x:m+Math.cos(N)*W,y:g+Math.sin(N)*W}}tooltipPosition(u){return this.getCenterPoint(u)}draw(u){const{options:m,circumference:g}=this,b=(m.offset||0)/4,M=(m.spacing||0)/2,A=m.circular;if(this.pixelMargin=m.borderAlign==="inner"?.33:0,this.fullCircles=g>Nn?Math.floor(g/Nn):0,g===0||this.innerRadius<0||this.outerRadius<0)return;u.save();const r=(this.startAngle+this.endAngle)/2;u.translate(Math.cos(r)*b,Math.sin(r)*b);const k=1-Math.sin(Math.min(Vn,g||0)),F=b*k;u.fillStyle=m.backgroundColor,u.strokeStyle=m.borderColor,mR(u,this,F,M,A),_R(u,this,F,M,A),u.restore()}}Ft(_f,"id","arc"),Ft(_f,"defaults",{borderAlign:"center",borderColor:"#fff",borderDash:[],borderDashOffset:0,borderJoinStyle:void 0,borderRadius:0,borderWidth:2,offset:0,spacing:0,angle:void 0,circular:!0}),Ft(_f,"defaultRoutes",{backgroundColor:"backgroundColor"}),Ft(_f,"descriptors",{_scriptable:!0,_indexable:u=>u!=="borderDash"});function eS(l,o,u=o){l.lineCap=Fi(u.borderCapStyle,o.borderCapStyle),l.setLineDash(Fi(u.borderDash,o.borderDash)),l.lineDashOffset=Fi(u.borderDashOffset,o.borderDashOffset),l.lineJoin=Fi(u.borderJoinStyle,o.borderJoinStyle),l.lineWidth=Fi(u.borderWidth,o.borderWidth),l.strokeStyle=Fi(u.borderColor,o.borderColor)}function gR(l,o,u){l.lineTo(u.x,u.y)}function yR(l){return l.stepped?UP:l.tension||l.cubicInterpolationMode==="monotone"?jP:gR}function tS(l,o,u={}){const m=l.length,{start:g=0,end:b=m-1}=u,{start:M,end:A}=o,r=Math.max(g,M),k=Math.min(b,A),F=g<M&&b<M||g>A&&b>A;return{count:m,start:r,loop:o.loop,ilen:k<r&&!F?m+k-r:k-r}}function xR(l,o,u,m){const{points:g,options:b}=o,{count:M,start:A,loop:r,ilen:k}=tS(g,u,m),F=yR(b);let{move:N=!0,reverse:W}=m||{},Q,te,ce;for(Q=0;Q<=k;++Q)te=g[(A+(W?k-Q:Q))%M],!te.skip&&(N?(l.moveTo(te.x,te.y),N=!1):F(l,ce,te,W,b.stepped),ce=te);return r&&(te=g[(A+(W?k:0))%M],F(l,ce,te,W,b.stepped)),!!r}function vR(l,o,u,m){const g=o.points,{count:b,start:M,ilen:A}=tS(g,u,m),{move:r=!0,reverse:k}=m||{};let F=0,N=0,W,Q,te,ce,de,ve;const Te=Me=>(M+(k?A-Me:Me))%b,Ee=()=>{ce!==de&&(l.lineTo(F,de),l.lineTo(F,ce),l.lineTo(F,ve))};for(r&&(Q=g[Te(0)],l.moveTo(Q.x,Q.y)),W=0;W<=A;++W){if(Q=g[Te(W)],Q.skip)continue;const Me=Q.x,Ie=Q.y,qe=Me|0;qe===te?(Ie<ce?ce=Ie:Ie>de&&(de=Ie),F=(N*F+Me)/++N):(Ee(),l.lineTo(Me,Ie),te=qe,N=0,ce=de=Ie),ve=Ie}Ee()}function R0(l){const o=l.options,u=o.borderDash&&o.borderDash.length;return!l._decimated&&!l._loop&&!o.tension&&o.cubicInterpolationMode!=="monotone"&&!o.stepped&&!u?vR:xR}function bR(l){return l.stepped?vD:l.tension||l.cubicInterpolationMode==="monotone"?bD:bc}function wR(l,o,u,m){let g=o._path;g||(g=o._path=new Path2D,o.path(g,u,m)&&g.closePath()),eS(l,o.options),l.stroke(g)}function TR(l,o,u,m){const{segments:g,options:b}=o,M=R0(o);for(const A of g)eS(l,b,A.style),l.beginPath(),M(l,o,A,{start:u,end:u+m-1})&&l.closePath(),l.stroke()}const MR=typeof Path2D=="function";function SR(l,o,u,m){MR&&!o.options.segment?wR(l,o,u,m):TR(l,o,u,m)}class ol extends uo{constructor(o){super(),this.animated=!0,this.options=void 0,this._chart=void 0,this._loop=void 0,this._fullLoop=void 0,this._path=void 0,this._points=void 0,this._segments=void 0,this._decimated=!1,this._pointsUpdated=!1,this._datasetIndex=void 0,o&&Object.assign(this,o)}updateControlPoints(o,u){const m=this.options;if((m.tension||m.cubicInterpolationMode==="monotone")&&!m.stepped&&!this._pointsUpdated){const g=m.spanGaps?this._loop:this._fullLoop;dD(this._points,m,o,g,u),this._pointsUpdated=!0}}set points(o){this._points=o,delete this._segments,delete this._path,this._pointsUpdated=!1}get points(){return this._points}get segments(){return this._segments||(this._segments=AD(this,this.options.segment))}first(){const o=this.segments,u=this.points;return o.length&&u[o[0].start]}last(){const o=this.segments,u=this.points,m=o.length;return m&&u[o[m-1].end]}interpolate(o,u){const m=this.options,g=o[u],b=this.points,M=UM(this,{property:u,start:g,end:g});if(!M.length)return;const A=[],r=bR(m);let k,F;for(k=0,F=M.length;k<F;++k){const{start:N,end:W}=M[k],Q=b[N],te=b[W];if(Q===te){A.push(Q);continue}const ce=Math.abs((g-Q[u])/(te[u]-Q[u])),de=r(Q,te,ce,m.stepped);de[u]=o[u],A.push(de)}return A.length===1?A[0]:A}pathSegment(o,u,m){return R0(this)(o,this,u,m)}path(o,u,m){const g=this.segments,b=R0(this);let M=this._loop;u=u||0,m=m||this.points.length-u;for(const A of g)M&=b(o,this,A,{start:u,end:u+m-1});return!!M}draw(o,u,m,g){const b=this.options||{};(this.points||[]).length&&b.borderWidth&&(o.save(),SR(o,this,m,g),o.restore()),this.animated&&(this._pointsUpdated=!1,this._path=void 0)}}Ft(ol,"id","line"),Ft(ol,"defaults",{borderCapStyle:"butt",borderDash:[],borderDashOffset:0,borderJoinStyle:"miter",borderWidth:3,capBezierPoints:!0,cubicInterpolationMode:"default",fill:!1,spanGaps:!1,stepped:!1,tension:0}),Ft(ol,"defaultRoutes",{backgroundColor:"backgroundColor",borderColor:"borderColor"}),Ft(ol,"descriptors",{_scriptable:!0,_indexable:o=>o!=="borderDash"&&o!=="fill"});function Yw(l,o,u,m){const g=l.options,{[u]:b}=l.getProps([u],m);return Math.abs(o-b)<g.radius+g.hitRadius}class E_ extends uo{constructor(u){super();Ft(this,"parsed");Ft(this,"skip");Ft(this,"stop");this.options=void 0,this.parsed=void 0,this.skip=void 0,this.stop=void 0,u&&Object.assign(this,u)}inRange(u,m,g){const b=this.options,{x:M,y:A}=this.getProps(["x","y"],g);return Math.pow(u-M,2)+Math.pow(m-A,2)<Math.pow(b.hitRadius+b.radius,2)}inXRange(u,m){return Yw(this,u,"x",m)}inYRange(u,m){return Yw(this,u,"y",m)}getCenterPoint(u){const{x:m,y:g}=this.getProps(["x","y"],u);return{x:m,y:g}}size(u){u=u||this.options||{};let m=u.radius||0;m=Math.max(m,m&&u.hoverRadius||0);const g=m&&u.borderWidth||0;return(m+g)*2}draw(u,m){const g=this.options;this.skip||g.radius<.1||!ha(this,m,this.size(g)/2)||(u.strokeStyle=g.borderColor,u.lineWidth=g.borderWidth,u.fillStyle=g.backgroundColor,C0(u,g,this.x,this.y))}getRange(){const u=this.options||{};return u.radius+u.hitRadius}}Ft(E_,"id","point"),Ft(E_,"defaults",{borderWidth:1,hitRadius:1,hoverBorderWidth:1,hoverRadius:4,pointStyle:"circle",radius:3,rotation:0}),Ft(E_,"defaultRoutes",{backgroundColor:"backgroundColor",borderColor:"borderColor"});function iS(l,o){const{x:u,y:m,base:g,width:b,height:M}=l.getProps(["x","y","base","width","height"],o);let A,r,k,F,N;return l.horizontal?(N=M/2,A=Math.min(u,g),r=Math.max(u,g),k=m-N,F=m+N):(N=b/2,A=u-N,r=u+N,k=Math.min(m,g),F=Math.max(m,g)),{left:A,top:k,right:r,bottom:F}}function al(l,o,u,m){return l?0:Ar(o,u,m)}function ER(l,o,u){const m=l.options.borderWidth,g=l.borderSkipped,b=PM(m);return{t:al(g.top,b.top,0,u),r:al(g.right,b.right,0,o),b:al(g.bottom,b.bottom,0,u),l:al(g.left,b.left,0,o)}}function AR(l,o,u){const{enableBorderRadius:m}=l.getProps(["enableBorderRadius"]),g=l.options.borderRadius,b=Tc(g),M=Math.min(o,u),A=l.borderSkipped,r=m||en(g);return{topLeft:al(!r||A.top||A.left,b.topLeft,0,M),topRight:al(!r||A.top||A.right,b.topRight,0,M),bottomLeft:al(!r||A.bottom||A.left,b.bottomLeft,0,M),bottomRight:al(!r||A.bottom||A.right,b.bottomRight,0,M)}}function IR(l){const o=iS(l),u=o.right-o.left,m=o.bottom-o.top,g=ER(l,u/2,m/2),b=AR(l,u/2,m/2);return{outer:{x:o.left,y:o.top,w:u,h:m,radius:b},inner:{x:o.left+g.l,y:o.top+g.t,w:u-g.l-g.r,h:m-g.t-g.b,radius:{topLeft:Math.max(0,b.topLeft-Math.max(g.t,g.l)),topRight:Math.max(0,b.topRight-Math.max(g.t,g.r)),bottomLeft:Math.max(0,b.bottomLeft-Math.max(g.b,g.l)),bottomRight:Math.max(0,b.bottomRight-Math.max(g.b,g.r))}}}}function u0(l,o,u,m){const g=o===null,b=u===null,A=l&&!(g&&b)&&iS(l,m);return A&&(g||ca(o,A.left,A.right))&&(b||ca(u,A.top,A.bottom))}function CR(l){return l.topLeft||l.topRight||l.bottomLeft||l.bottomRight}function PR(l,o){l.rect(o.x,o.y,o.w,o.h)}function h0(l,o,u={}){const m=l.x!==u.x?-o:0,g=l.y!==u.y?-o:0,b=(l.x+l.w!==u.x+u.w?o:0)-m,M=(l.y+l.h!==u.y+u.h?o:0)-g;return{x:l.x+m,y:l.y+g,w:l.w+b,h:l.h+M,radius:l.radius}}class A_ extends uo{constructor(o){super(),this.options=void 0,this.horizontal=void 0,this.base=void 0,this.width=void 0,this.height=void 0,this.inflateAmount=void 0,o&&Object.assign(this,o)}draw(o){const{inflateAmount:u,options:{borderColor:m,backgroundColor:g}}=this,{inner:b,outer:M}=IR(this),A=CR(M.radius)?zf:PR;o.save(),(M.w!==b.w||M.h!==b.h)&&(o.beginPath(),A(o,h0(M,u,b)),o.clip(),A(o,h0(b,-u,M)),o.fillStyle=m,o.fill("evenodd")),o.beginPath(),A(o,h0(b,u)),o.fillStyle=g,o.fill(),o.restore()}inRange(o,u,m){return u0(this,o,u,m)}inXRange(o,u){return u0(this,o,null,u)}inYRange(o,u){return u0(this,null,o,u)}getCenterPoint(o){const{x:u,y:m,base:g,horizontal:b}=this.getProps(["x","y","base","horizontal"],o);return{x:b?(u+g)/2:u,y:b?m:(m+g)/2}}getRange(o){return o==="x"?this.width/2:this.height/2}}Ft(A_,"id","bar"),Ft(A_,"defaults",{borderSkipped:"start",borderWidth:0,borderRadius:0,inflateAmount:"auto",pointStyle:void 0}),Ft(A_,"defaultRoutes",{backgroundColor:"backgroundColor",borderColor:"borderColor"});var DR=Object.freeze({__proto__:null,ArcElement:_f,BarElement:A_,LineElement:ol,PointElement:E_});const z0=["rgb(54, 162, 235)","rgb(255, 99, 132)","rgb(255, 159, 64)","rgb(255, 205, 86)","rgb(75, 192, 192)","rgb(153, 102, 255)","rgb(201, 203, 207)"],Qw=z0.map(l=>l.replace("rgb(","rgba(").replace(")",", 0.5)"));function nS(l){return z0[l%z0.length]}function rS(l){return Qw[l%Qw.length]}function kR(l,o){return l.borderColor=nS(o),l.backgroundColor=rS(o),++o}function RR(l,o){return l.backgroundColor=l.data.map(()=>nS(o++)),o}function zR(l,o){return l.backgroundColor=l.data.map(()=>rS(o++)),o}function LR(l){let o=0;return(u,m)=>{const g=l.getDatasetMeta(m).controller;g instanceof wc?o=RR(u,o):g instanceof Af?o=zR(u,o):g&&(o=kR(u,o))}}function Xw(l){let o;for(o in l)if(l[o].borderColor||l[o].backgroundColor)return!0;return!1}function OR(l){return l&&(l.borderColor||l.backgroundColor)}var FR={id:"colors",defaults:{enabled:!0,forceOverride:!1},beforeLayout(l,o,u){if(!u.enabled)return;const{data:{datasets:m},options:g}=l.config,{elements:b}=g;if(!u.forceOverride&&(Xw(m)||OR(g)||b&&Xw(b)))return;const M=LR(l);m.forEach(M)}};function BR(l,o,u,m,g){const b=g.samples||m;if(b>=u)return l.slice(o,o+u);const M=[],A=(u-2)/(b-2);let r=0;const k=o+u-1;let F=o,N,W,Q,te,ce;for(M[r++]=l[F],N=0;N<b-2;N++){let de=0,ve=0,Te;const Ee=Math.floor((N+1)*A)+1+o,Me=Math.min(Math.floor((N+2)*A)+1,u)+o,Ie=Me-Ee;for(Te=Ee;Te<Me;Te++)de+=l[Te].x,ve+=l[Te].y;de/=Ie,ve/=Ie;const qe=Math.floor(N*A)+1+o,Ve=Math.min(Math.floor((N+1)*A)+1,u)+o,{x:nt,y:lt}=l[F];for(Q=te=-1,Te=qe;Te<Ve;Te++)te=.5*Math.abs((nt-de)*(l[Te].y-lt)-(nt-l[Te].x)*(ve-lt)),te>Q&&(Q=te,W=l[Te],ce=Te);M[r++]=W,F=ce}return M[r++]=l[k],M}function NR(l,o,u,m){let g=0,b=0,M,A,r,k,F,N,W,Q,te,ce;const de=[],ve=o+u-1,Te=l[o].x,Me=l[ve].x-Te;for(M=o;M<o+u;++M){A=l[M],r=(A.x-Te)/Me*m,k=A.y;const Ie=r|0;if(Ie===F)k<te?(te=k,N=M):k>ce&&(ce=k,W=M),g=(b*g+A.x)/++b;else{const qe=M-1;if(!cn(N)&&!cn(W)){const Ve=Math.min(N,W),nt=Math.max(N,W);Ve!==Q&&Ve!==qe&&de.push({...l[Ve],x:g}),nt!==Q&&nt!==qe&&de.push({...l[nt],x:g})}M>0&&qe!==Q&&de.push(l[qe]),de.push(A),F=Ie,b=0,te=ce=k,N=W=Q=M}}return de}function sS(l){if(l._decimated){const o=l._data;delete l._decimated,delete l._data,Object.defineProperty(l,"data",{configurable:!0,enumerable:!0,writable:!0,value:o})}}function Kw(l){l.data.datasets.forEach(o=>{sS(o)})}function VR(l,o){const u=o.length;let m=0,g;const{iScale:b}=l,{min:M,max:A,minDefined:r,maxDefined:k}=b.getUserBounds();return r&&(m=Ar(ua(o,b.axis,M).lo,0,u-1)),k?g=Ar(ua(o,b.axis,A).hi+1,m,u)-m:g=u-m,{start:m,count:g}}var UR={id:"decimation",defaults:{algorithm:"min-max",enabled:!1},beforeElementsUpdate:(l,o,u)=>{if(!u.enabled){Kw(l);return}const m=l.width;l.data.datasets.forEach((g,b)=>{const{_data:M,indexAxis:A}=g,r=l.getDatasetMeta(b),k=M||g.data;if(pf([A,l.options.indexAxis])==="y"||!r.controller.supportsDecimation)return;const F=l.scales[r.xAxisID];if(F.type!=="linear"&&F.type!=="time"||l.options.parsing)return;let{start:N,count:W}=VR(r,k);const Q=u.threshold||4*m;if(W<=Q){sS(g);return}cn(M)&&(g._data=k,delete g.data,Object.defineProperty(g,"data",{configurable:!0,enumerable:!0,get:function(){return this._decimated},set:function(ce){this._data=ce}}));let te;switch(u.algorithm){case"lttb":te=BR(k,N,W,m,u);break;case"min-max":te=NR(k,N,W,m);break;default:throw new Error(`Unsupported decimation algorithm '${u.algorithm}'`)}g._decimated=te})},destroy(l){Kw(l)}};function jR(l,o,u){const m=l.segments,g=l.points,b=o.points,M=[];for(const A of m){let{start:r,end:k}=A;k=dx(r,k,g);const F=L0(u,g[r],g[k],A.loop);if(!o.segments){M.push({source:A,target:F,start:g[r],end:g[k]});continue}const N=UM(o,F);for(const W of N){const Q=L0(u,b[W.start],b[W.end],W.loop),te=VM(A,g,Q);for(const ce of te)M.push({source:ce,target:W,start:{[u]:Jw(F,Q,"start",Math.max)},end:{[u]:Jw(F,Q,"end",Math.min)}})}}return M}function L0(l,o,u,m){if(m)return;let g=o[l],b=u[l];return l==="angle"&&(g=Is(g),b=Is(b)),{property:l,start:g,end:b}}function GR(l,o){const{x:u=null,y:m=null}=l||{},g=o.points,b=[];return o.segments.forEach(({start:M,end:A})=>{A=dx(M,A,g);const r=g[M],k=g[A];m!==null?(b.push({x:r.x,y:m}),b.push({x:k.x,y:m})):u!==null&&(b.push({x:u,y:r.y}),b.push({x:u,y:k.y}))}),b}function dx(l,o,u){for(;o>l;o--){const m=u[o];if(!isNaN(m.x)&&!isNaN(m.y))break}return o}function Jw(l,o,u,m){return l&&o?m(l[u],o[u]):l?l[u]:o?o[u]:0}function oS(l,o){let u=[],m=!1;return qn(l)?(m=!0,u=l):u=GR(l,o),u.length?new ol({points:u,options:{tension:0},_loop:m,_fullLoop:m}):null}function eT(l){return l&&l.fill!==!1}function WR(l,o,u){let g=l[o].fill;const b=[o];let M;if(!u)return g;for(;g!==!1&&b.indexOf(g)===-1;){if(!Jn(g))return g;if(M=l[g],!M)return!1;if(M.visible)return g;b.push(g),g=M.fill}return!1}function qR(l,o,u){const m=YR(l);if(en(m))return isNaN(m.value)?!1:m;let g=parseFloat(m);return Jn(g)&&Math.floor(g)===g?HR(m[0],o,g,u):["origin","start","end","stack","shape"].indexOf(m)>=0&&m}function HR(l,o,u,m){return(l==="-"||l==="+")&&(u=o+u),u===o||u<0||u>=m?!1:u}function ZR(l,o){let u=null;return l==="start"?u=o.bottom:l==="end"?u=o.top:en(l)?u=o.getPixelForValue(l.value):o.getBasePixel&&(u=o.getBasePixel()),u}function $R(l,o,u){let m;return l==="start"?m=u:l==="end"?m=o.options.reverse?o.min:o.max:en(l)?m=l.value:m=o.getBaseValue(),m}function YR(l){const o=l.options,u=o.fill;let m=Fi(u&&u.target,u);return m===void 0&&(m=!!o.backgroundColor),m===!1||m===null?!1:m===!0?"origin":m}function QR(l){const{scale:o,index:u,line:m}=l,g=[],b=m.segments,M=m.points,A=XR(o,u);A.push(oS({x:null,y:o.bottom},m));for(let r=0;r<b.length;r++){const k=b[r];for(let F=k.start;F<=k.end;F++)KR(g,M[F],A)}return new ol({points:g,options:{}})}function XR(l,o){const u=[],m=l.getMatchingVisibleMetas("line");for(let g=0;g<m.length;g++){const b=m[g];if(b.index===o)break;b.hidden||u.unshift(b.dataset)}return u}function KR(l,o,u){const m=[];for(let g=0;g<u.length;g++){const b=u[g],{first:M,last:A,point:r}=JR(b,o,"x");if(!(!r||M&&A)){if(M)m.unshift(r);else if(l.push(r),!A)break}}l.push(...m)}function JR(l,o,u){const m=l.interpolate(o,u);if(!m)return{};const g=m[u],b=l.segments,M=l.points;let A=!1,r=!1;for(let k=0;k<b.length;k++){const F=b[k],N=M[F.start][u],W=M[F.end][u];if(ca(g,N,W)){A=g===N,r=g===W;break}}return{first:A,last:r,point:m}}class aS{constructor(o){this.x=o.x,this.y=o.y,this.radius=o.radius}pathSegment(o,u,m){const{x:g,y:b,radius:M}=this;return u=u||{start:0,end:Nn},o.arc(g,b,M,u.end,u.start,!0),!m.bounds}interpolate(o){const{x:u,y:m,radius:g}=this,b=o.angle;return{x:u+Math.cos(b)*g,y:m+Math.sin(b)*g,angle:b}}}function ez(l){const{chart:o,fill:u,line:m}=l;if(Jn(u))return tz(o,u);if(u==="stack")return QR(l);if(u==="shape")return!0;const g=iz(l);return g instanceof aS?g:oS(g,m)}function tz(l,o){const u=l.getDatasetMeta(o);return u&&l.isDatasetVisible(o)?u.dataset:null}function iz(l){return(l.scale||{}).getPointPositionForValue?rz(l):nz(l)}function nz(l){const{scale:o={},fill:u}=l,m=ZR(u,o);if(Jn(m)){const g=o.isHorizontal();return{x:g?m:null,y:g?null:m}}return null}function rz(l){const{scale:o,fill:u}=l,m=o.options,g=o.getLabels().length,b=m.reverse?o.max:o.min,M=$R(u,o,b),A=[];if(m.grid.circular){const r=o.getPointPositionForValue(0,b);return new aS({x:r.x,y:r.y,radius:o.getDistanceFromCenterForValue(M)})}for(let r=0;r<g;++r)A.push(o.getPointPositionForValue(r,M));return A}function d0(l,o,u){const m=ez(o),{line:g,scale:b,axis:M}=o,A=g.options,r=A.fill,k=A.backgroundColor,{above:F=k,below:N=k}=r||{};m&&g.points.length&&(J_(l,u),sz(l,{line:g,target:m,above:F,below:N,area:u,scale:b,axis:M}),eg(l))}function sz(l,o){const{line:u,target:m,above:g,below:b,area:M,scale:A}=o,r=u._loop?"angle":o.axis;l.save(),r==="x"&&b!==g&&(tT(l,m,M.top),iT(l,{line:u,target:m,color:g,scale:A,property:r}),l.restore(),l.save(),tT(l,m,M.bottom)),iT(l,{line:u,target:m,color:b,scale:A,property:r}),l.restore()}function tT(l,o,u){const{segments:m,points:g}=o;let b=!0,M=!1;l.beginPath();for(const A of m){const{start:r,end:k}=A,F=g[r],N=g[dx(r,k,g)];b?(l.moveTo(F.x,F.y),b=!1):(l.lineTo(F.x,u),l.lineTo(F.x,F.y)),M=!!o.pathSegment(l,A,{move:M}),M?l.closePath():l.lineTo(N.x,u)}l.lineTo(o.first().x,u),l.closePath(),l.clip()}function iT(l,o){const{line:u,target:m,property:g,color:b,scale:M}=o,A=jR(u,m,g);for(const{source:r,target:k,start:F,end:N}of A){const{style:{backgroundColor:W=b}={}}=r,Q=m!==!0;l.save(),l.fillStyle=W,oz(l,M,Q&&L0(g,F,N)),l.beginPath();const te=!!u.pathSegment(l,r);let ce;if(Q){te?l.closePath():nT(l,m,N,g);const de=!!m.pathSegment(l,k,{move:te,reverse:!0});ce=te&&de,ce||nT(l,m,F,g)}l.closePath(),l.fill(ce?"evenodd":"nonzero"),l.restore()}}function oz(l,o,u){const{top:m,bottom:g}=o.chart.chartArea,{property:b,start:M,end:A}=u||{};b==="x"&&(l.beginPath(),l.rect(M,m,A-M,g-m),l.clip())}function nT(l,o,u,m){const g=o.interpolate(u,m);g&&l.lineTo(g.x,g.y)}var az={id:"filler",afterDatasetsUpdate(l,o,u){const m=(l.data.datasets||[]).length,g=[];let b,M,A,r;for(M=0;M<m;++M)b=l.getDatasetMeta(M),A=b.dataset,r=null,A&&A.options&&A instanceof ol&&(r={visible:l.isDatasetVisible(M),index:M,fill:qR(A,M,m),chart:l,axis:b.controller.options.indexAxis,scale:b.vScale,line:A}),b.$filler=r,g.push(r);for(M=0;M<m;++M)r=g[M],!(!r||r.fill===!1)&&(r.fill=WR(g,M,u.propagate))},beforeDraw(l,o,u){const m=u.drawTime==="beforeDraw",g=l.getSortedVisibleDatasetMetas(),b=l.chartArea;for(let M=g.length-1;M>=0;--M){const A=g[M].$filler;A&&(A.line.updateControlPoints(b,A.axis),m&&A.fill&&d0(l.ctx,A,b))}},beforeDatasetsDraw(l,o,u){if(u.drawTime!=="beforeDatasetsDraw")return;const m=l.getSortedVisibleDatasetMetas();for(let g=m.length-1;g>=0;--g){const b=m[g].$filler;eT(b)&&d0(l.ctx,b,l.chartArea)}},beforeDatasetDraw(l,o,u){const m=o.meta.$filler;!eT(m)||u.drawTime!=="beforeDatasetDraw"||d0(l.ctx,m,l.chartArea)},defaults:{propagate:!0,drawTime:"beforeDatasetDraw"}};const rT=(l,o)=>{let{boxHeight:u=o,boxWidth:m=o}=l;return l.usePointStyle&&(u=Math.min(u,o),m=l.pointStyleWidth||Math.min(m,o)),{boxWidth:m,boxHeight:u,itemHeight:Math.max(o,u)}},lz=(l,o)=>l!==null&&o!==null&&l.datasetIndex===o.datasetIndex&&l.index===o.index;class sT extends uo{constructor(o){super(),this._added=!1,this.legendHitBoxes=[],this._hoveredItem=null,this.doughnutMode=!1,this.chart=o.chart,this.options=o.options,this.ctx=o.ctx,this.legendItems=void 0,this.columnSizes=void 0,this.lineWidths=void 0,this.maxHeight=void 0,this.maxWidth=void 0,this.top=void 0,this.bottom=void 0,this.left=void 0,this.right=void 0,this.height=void 0,this.width=void 0,this._margins=void 0,this.position=void 0,this.weight=void 0,this.fullSize=void 0}update(o,u,m){this.maxWidth=o,this.maxHeight=u,this._margins=m,this.setDimensions(),this.buildLabels(),this.fit()}setDimensions(){this.isHorizontal()?(this.width=this.maxWidth,this.left=this._margins.left,this.right=this.width):(this.height=this.maxHeight,this.top=this._margins.top,this.bottom=this.height)}buildLabels(){const o=this.options.labels||{};let u=zn(o.generateLabels,[this.chart],this)||[];o.filter&&(u=u.filter(m=>o.filter(m,this.chart.data))),o.sort&&(u=u.sort((m,g)=>o.sort(m,g,this.chart.data))),this.options.reverse&&u.reverse(),this.legendItems=u}fit(){const{options:o,ctx:u}=this;if(!o.display){this.width=this.height=0;return}const m=o.labels,g=br(m.font),b=g.size,M=this._computeTitleHeight(),{boxWidth:A,itemHeight:r}=rT(m,b);let k,F;u.font=g.string,this.isHorizontal()?(k=this.maxWidth,F=this._fitRows(M,b,A,r)+10):(F=this.maxHeight,k=this._fitCols(M,g,A,r)+10),this.width=Math.min(k,o.maxWidth||this.maxWidth),this.height=Math.min(F,o.maxHeight||this.maxHeight)}_fitRows(o,u,m,g){const{ctx:b,maxWidth:M,options:{labels:{padding:A}}}=this,r=this.legendHitBoxes=[],k=this.lineWidths=[0],F=g+A;let N=o;b.textAlign="left",b.textBaseline="middle";let W=-1,Q=-F;return this.legendItems.forEach((te,ce)=>{const de=m+u/2+b.measureText(te.text).width;(ce===0||k[k.length-1]+de+2*A>M)&&(N+=F,k[k.length-(ce>0?0:1)]=0,Q+=F,W++),r[ce]={left:0,top:Q,row:W,width:de,height:g},k[k.length-1]+=de+A}),N}_fitCols(o,u,m,g){const{ctx:b,maxHeight:M,options:{labels:{padding:A}}}=this,r=this.legendHitBoxes=[],k=this.columnSizes=[],F=M-o;let N=A,W=0,Q=0,te=0,ce=0;return this.legendItems.forEach((de,ve)=>{const{itemWidth:Te,itemHeight:Ee}=cz(m,u,b,de,g);ve>0&&Q+Ee+2*A>F&&(N+=W+A,k.push({width:W,height:Q}),te+=W+A,ce++,W=Q=0),r[ve]={left:te,top:Q,col:ce,width:Te,height:Ee},W=Math.max(W,Te),Q+=Ee+A}),N+=W,k.push({width:W,height:Q}),N}adjustHitBoxes(){if(!this.options.display)return;const o=this._computeTitleHeight(),{legendHitBoxes:u,options:{align:m,labels:{padding:g},rtl:b}}=this,M=uh(b,this.left,this.width);if(this.isHorizontal()){let A=0,r=Gr(m,this.left+g,this.right-this.lineWidths[A]);for(const k of u)A!==k.row&&(A=k.row,r=Gr(m,this.left+g,this.right-this.lineWidths[A])),k.top+=this.top+o+g,k.left=M.leftForLtr(M.x(r),k.width),r+=k.width+g}else{let A=0,r=Gr(m,this.top+o+g,this.bottom-this.columnSizes[A].height);for(const k of u)k.col!==A&&(A=k.col,r=Gr(m,this.top+o+g,this.bottom-this.columnSizes[A].height)),k.top=r,k.left+=this.left+g,k.left=M.leftForLtr(M.x(k.left),k.width),r+=k.height+g}}isHorizontal(){return this.options.position==="top"||this.options.position==="bottom"}draw(){if(this.options.display){const o=this.ctx;J_(o,this),this._draw(),eg(o)}}_draw(){const{options:o,columnSizes:u,lineWidths:m,ctx:g}=this,{align:b,labels:M}=o,A=er.color,r=uh(o.rtl,this.left,this.width),k=br(M.font),{padding:F}=M,N=k.size,W=N/2;let Q;this.drawTitle(),g.textAlign=r.textAlign("left"),g.textBaseline="middle",g.lineWidth=.5,g.font=k.string;const{boxWidth:te,boxHeight:ce,itemHeight:de}=rT(M,N),ve=function(qe,Ve,nt){if(isNaN(te)||te<=0||isNaN(ce)||ce<0)return;g.save();const lt=Fi(nt.lineWidth,1);if(g.fillStyle=Fi(nt.fillStyle,A),g.lineCap=Fi(nt.lineCap,"butt"),g.lineDashOffset=Fi(nt.lineDashOffset,0),g.lineJoin=Fi(nt.lineJoin,"miter"),g.lineWidth=lt,g.strokeStyle=Fi(nt.strokeStyle,A),g.setLineDash(Fi(nt.lineDash,[])),M.usePointStyle){const ht={radius:ce*Math.SQRT2/2,pointStyle:nt.pointStyle,rotation:nt.rotation,borderWidth:lt},st=r.xPlus(qe,te/2),Ot=Ve+W;CM(g,ht,st,Ot,M.pointStyleWidth&&te)}else{const ht=Ve+Math.max((N-ce)/2,0),st=r.leftForLtr(qe,te),Ot=Tc(nt.borderRadius);g.beginPath(),Object.values(Ot).some(oi=>oi!==0)?zf(g,{x:st,y:ht,w:te,h:ce,radius:Ot}):g.rect(st,ht,te,ce),g.fill(),lt!==0&&g.stroke()}g.restore()},Te=function(qe,Ve,nt){Ec(g,nt.text,qe,Ve+de/2,k,{strikethrough:nt.hidden,textAlign:r.textAlign(nt.textAlign)})},Ee=this.isHorizontal(),Me=this._computeTitleHeight();Ee?Q={x:Gr(b,this.left+F,this.right-m[0]),y:this.top+F+Me,line:0}:Q={x:this.left+F,y:Gr(b,this.top+Me+F,this.bottom-u[0].height),line:0},FM(this.ctx,o.textDirection);const Ie=de+F;this.legendItems.forEach((qe,Ve)=>{g.strokeStyle=qe.fontColor,g.fillStyle=qe.fontColor;const nt=g.measureText(qe.text).width,lt=r.textAlign(qe.textAlign||(qe.textAlign=M.textAlign)),ht=te+W+nt;let st=Q.x,Ot=Q.y;r.setWidth(this.width),Ee?Ve>0&&st+ht+F>this.right&&(Ot=Q.y+=Ie,Q.line++,st=Q.x=Gr(b,this.left+F,this.right-m[Q.line])):Ve>0&&Ot+Ie>this.bottom&&(st=Q.x=st+u[Q.line].width+F,Q.line++,Ot=Q.y=Gr(b,this.top+Me+F,this.bottom-u[Q.line].height));const oi=r.x(st);if(ve(oi,Ot,qe),st=PP(lt,st+te+W,Ee?st+ht:this.right,o.rtl),Te(r.x(st),Ot,qe),Ee)Q.x+=ht+F;else if(typeof qe.text!="string"){const ii=k.lineHeight;Q.y+=lS(qe,ii)+F}else Q.y+=Ie}),BM(this.ctx,o.textDirection)}drawTitle(){const o=this.options,u=o.title,m=br(u.font),g=qr(u.padding);if(!u.display)return;const b=uh(o.rtl,this.left,this.width),M=this.ctx,A=u.position,r=m.size/2,k=g.top+r;let F,N=this.left,W=this.width;if(this.isHorizontal())W=Math.max(...this.lineWidths),F=this.top+k,N=Gr(o.align,N,this.right-W);else{const te=this.columnSizes.reduce((ce,de)=>Math.max(ce,de.height),0);F=k+Gr(o.align,this.top,this.bottom-te-o.labels.padding-this._computeTitleHeight())}const Q=Gr(A,N,N+W);M.textAlign=b.textAlign(nx(A)),M.textBaseline="middle",M.strokeStyle=u.color,M.fillStyle=u.color,M.font=m.string,Ec(M,u.text,Q,F,m)}_computeTitleHeight(){const o=this.options.title,u=br(o.font),m=qr(o.padding);return o.display?u.lineHeight+m.height:0}_getLegendItemAt(o,u){let m,g,b;if(ca(o,this.left,this.right)&&ca(u,this.top,this.bottom)){for(b=this.legendHitBoxes,m=0;m<b.length;++m)if(g=b[m],ca(o,g.left,g.left+g.width)&&ca(u,g.top,g.top+g.height))return this.legendItems[m]}return null}handleEvent(o){const u=this.options;if(!dz(o.type,u))return;const m=this._getLegendItemAt(o.x,o.y);if(o.type==="mousemove"||o.type==="mouseout"){const g=this._hoveredItem,b=lz(g,m);g&&!b&&zn(u.onLeave,[o,g,this],this),this._hoveredItem=m,m&&!b&&zn(u.onHover,[o,m,this],this)}else m&&zn(u.onClick,[o,m,this],this)}}function cz(l,o,u,m,g){const b=uz(m,l,o,u),M=hz(g,m,o.lineHeight);return{itemWidth:b,itemHeight:M}}function uz(l,o,u,m){let g=l.text;return g&&typeof g!="string"&&(g=g.reduce((b,M)=>b.length>M.length?b:M)),o+u.size/2+m.measureText(g).width}function hz(l,o,u){let m=l;return typeof o.text!="string"&&(m=lS(o,u)),m}function lS(l,o){const u=l.text?l.text.length:0;return o*u}function dz(l,o){return!!((l==="mousemove"||l==="mouseout")&&(o.onHover||o.onLeave)||o.onClick&&(l==="click"||l==="mouseup"))}var fz={id:"legend",_element:sT,start(l,o,u){const m=l.legend=new sT({ctx:l.ctx,options:u,chart:l});Wr.configure(l,m,u),Wr.addBox(l,m)},stop(l){Wr.removeBox(l,l.legend),delete l.legend},beforeUpdate(l,o,u){const m=l.legend;Wr.configure(l,m,u),m.options=u},afterUpdate(l){const o=l.legend;o.buildLabels(),o.adjustHitBoxes()},afterEvent(l,o){o.replay||l.legend.handleEvent(o.event)},defaults:{display:!0,position:"top",align:"center",fullSize:!0,reverse:!1,weight:1e3,onClick(l,o,u){const m=o.datasetIndex,g=u.chart;g.isDatasetVisible(m)?(g.hide(m),o.hidden=!0):(g.show(m),o.hidden=!1)},onHover:null,onLeave:null,labels:{color:l=>l.chart.options.color,boxWidth:40,padding:10,generateLabels(l){const o=l.data.datasets,{labels:{usePointStyle:u,pointStyle:m,textAlign:g,color:b,useBorderRadius:M,borderRadius:A}}=l.legend.options;return l._getSortedDatasetMetas().map(r=>{const k=r.controller.getStyle(u?0:void 0),F=qr(k.borderWidth);return{text:o[r.index].label,fillStyle:k.backgroundColor,fontColor:b,hidden:!r.visible,lineCap:k.borderCapStyle,lineDash:k.borderDash,lineDashOffset:k.borderDashOffset,lineJoin:k.borderJoinStyle,lineWidth:(F.width+F.height)/4,strokeStyle:k.borderColor,pointStyle:m||k.pointStyle,rotation:k.rotation,textAlign:g||k.textAlign,borderRadius:M&&(A||k.borderRadius),datasetIndex:r.index}},this)}},title:{color:l=>l.chart.options.color,display:!1,position:"center",text:""}},descriptors:{_scriptable:l=>!l.startsWith("on"),labels:{_scriptable:l=>!["generateLabels","filter","sort"].includes(l)}}};class fx extends uo{constructor(o){super(),this.chart=o.chart,this.options=o.options,this.ctx=o.ctx,this._padding=void 0,this.top=void 0,this.bottom=void 0,this.left=void 0,this.right=void 0,this.width=void 0,this.height=void 0,this.position=void 0,this.weight=void 0,this.fullSize=void 0}update(o,u){const m=this.options;if(this.left=0,this.top=0,!m.display){this.width=this.height=this.right=this.bottom=0;return}this.width=this.right=o,this.height=this.bottom=u;const g=qn(m.text)?m.text.length:1;this._padding=qr(m.padding);const b=g*br(m.font).lineHeight+this._padding.height;this.isHorizontal()?this.height=b:this.width=b}isHorizontal(){const o=this.options.position;return o==="top"||o==="bottom"}_drawArgs(o){const{top:u,left:m,bottom:g,right:b,options:M}=this,A=M.align;let r=0,k,F,N;return this.isHorizontal()?(F=Gr(A,m,b),N=u+o,k=b-m):(M.position==="left"?(F=m+o,N=Gr(A,g,u),r=Vn*-.5):(F=b-o,N=Gr(A,u,g),r=Vn*.5),k=g-u),{titleX:F,titleY:N,maxWidth:k,rotation:r}}draw(){const o=this.ctx,u=this.options;if(!u.display)return;const m=br(u.font),b=m.lineHeight/2+this._padding.top,{titleX:M,titleY:A,maxWidth:r,rotation:k}=this._drawArgs(b);Ec(o,u.text,0,0,m,{color:u.color,maxWidth:r,rotation:k,textAlign:nx(u.align),textBaseline:"middle",translation:[M,A]})}}function pz(l,o){const u=new fx({ctx:l.ctx,options:o,chart:l});Wr.configure(l,u,o),Wr.addBox(l,u),l.titleBlock=u}var mz={id:"title",_element:fx,start(l,o,u){pz(l,u)},stop(l){const o=l.titleBlock;Wr.removeBox(l,o),delete l.titleBlock},beforeUpdate(l,o,u){const m=l.titleBlock;Wr.configure(l,m,u),m.options=u},defaults:{align:"center",display:!1,font:{weight:"bold"},fullSize:!0,padding:10,position:"top",text:"",weight:2e3},defaultRoutes:{color:"color"},descriptors:{_scriptable:!0,_indexable:!1}};const h_=new WeakMap;var _z={id:"subtitle",start(l,o,u){const m=new fx({ctx:l.ctx,options:u,chart:l});Wr.configure(l,m,u),Wr.addBox(l,m),h_.set(l,m)},stop(l){Wr.removeBox(l,h_.get(l)),h_.delete(l)},beforeUpdate(l,o,u){const m=h_.get(l);Wr.configure(l,m,u),m.options=u},defaults:{align:"center",display:!1,font:{weight:"normal"},fullSize:!0,padding:0,position:"top",text:"",weight:1500},defaultRoutes:{color:"color"},descriptors:{_scriptable:!0,_indexable:!1}};const gf={average(l){if(!l.length)return!1;let o,u,m=new Set,g=0,b=0;for(o=0,u=l.length;o<u;++o){const A=l[o].element;if(A&&A.hasValue()){const r=A.tooltipPosition();m.add(r.x),g+=r.y,++b}}return{x:[...m].reduce((A,r)=>A+r)/m.size,y:g/b}},nearest(l,o){if(!l.length)return!1;let u=o.x,m=o.y,g=Number.POSITIVE_INFINITY,b,M,A;for(b=0,M=l.length;b<M;++b){const r=l[b].element;if(r&&r.hasValue()){const k=r.getCenterPoint(),F=A0(o,k);F<g&&(g=F,A=r)}}if(A){const r=A.tooltipPosition();u=r.x,m=r.y}return{x:u,y:m}}};function Ao(l,o){return o&&(qn(o)?Array.prototype.push.apply(l,o):l.push(o)),l}function oa(l){return(typeof l=="string"||l instanceof String)&&l.indexOf(`
`)>-1?l.split(`
`):l}function gz(l,o){const{element:u,datasetIndex:m,index:g}=o,b=l.getDatasetMeta(m).controller,{label:M,value:A}=b.getLabelAndValue(g);return{chart:l,label:M,parsed:b.getParsed(g),raw:l.data.datasets[m].data[g],formattedValue:A,dataset:b.getDataset(),dataIndex:g,datasetIndex:m,element:u}}function oT(l,o){const u=l.chart.ctx,{body:m,footer:g,title:b}=l,{boxWidth:M,boxHeight:A}=o,r=br(o.bodyFont),k=br(o.titleFont),F=br(o.footerFont),N=b.length,W=g.length,Q=m.length,te=qr(o.padding);let ce=te.height,de=0,ve=m.reduce((Me,Ie)=>Me+Ie.before.length+Ie.lines.length+Ie.after.length,0);if(ve+=l.beforeBody.length+l.afterBody.length,N&&(ce+=N*k.lineHeight+(N-1)*o.titleSpacing+o.titleMarginBottom),ve){const Me=o.displayColors?Math.max(A,r.lineHeight):r.lineHeight;ce+=Q*Me+(ve-Q)*r.lineHeight+(ve-1)*o.bodySpacing}W&&(ce+=o.footerMarginTop+W*F.lineHeight+(W-1)*o.footerSpacing);let Te=0;const Ee=function(Me){de=Math.max(de,u.measureText(Me).width+Te)};return u.save(),u.font=k.string,Mn(l.title,Ee),u.font=r.string,Mn(l.beforeBody.concat(l.afterBody),Ee),Te=o.displayColors?M+2+o.boxPadding:0,Mn(m,Me=>{Mn(Me.before,Ee),Mn(Me.lines,Ee),Mn(Me.after,Ee)}),Te=0,u.font=F.string,Mn(l.footer,Ee),u.restore(),de+=te.width,{width:de,height:ce}}function yz(l,o){const{y:u,height:m}=o;return u<m/2?"top":u>l.height-m/2?"bottom":"center"}function xz(l,o,u,m){const{x:g,width:b}=m,M=u.caretSize+u.caretPadding;if(l==="left"&&g+b+M>o.width||l==="right"&&g-b-M<0)return!0}function vz(l,o,u,m){const{x:g,width:b}=u,{width:M,chartArea:{left:A,right:r}}=l;let k="center";return m==="center"?k=g<=(A+r)/2?"left":"right":g<=b/2?k="left":g>=M-b/2&&(k="right"),xz(k,l,o,u)&&(k="center"),k}function aT(l,o,u){const m=u.yAlign||o.yAlign||yz(l,u);return{xAlign:u.xAlign||o.xAlign||vz(l,o,u,m),yAlign:m}}function bz(l,o){let{x:u,width:m}=l;return o==="right"?u-=m:o==="center"&&(u-=m/2),u}function wz(l,o,u){let{y:m,height:g}=l;return o==="top"?m+=u:o==="bottom"?m-=g+u:m-=g/2,m}function lT(l,o,u,m){const{caretSize:g,caretPadding:b,cornerRadius:M}=l,{xAlign:A,yAlign:r}=u,k=g+b,{topLeft:F,topRight:N,bottomLeft:W,bottomRight:Q}=Tc(M);let te=bz(o,A);const ce=wz(o,r,k);return r==="center"?A==="left"?te+=k:A==="right"&&(te-=k):A==="left"?te-=Math.max(F,W)+g:A==="right"&&(te+=Math.max(N,Q)+g),{x:Ar(te,0,m.width-o.width),y:Ar(ce,0,m.height-o.height)}}function d_(l,o,u){const m=qr(u.padding);return o==="center"?l.x+l.width/2:o==="right"?l.x+l.width-m.right:l.x+m.left}function cT(l){return Ao([],oa(l))}function Tz(l,o,u){return hl(l,{tooltip:o,tooltipItems:u,type:"tooltip"})}function uT(l,o){const u=o&&o.dataset&&o.dataset.tooltip&&o.dataset.tooltip.callbacks;return u?l.override(u):l}const cS={beforeTitle:ra,title(l){if(l.length>0){const o=l[0],u=o.chart.data.labels,m=u?u.length:0;if(this&&this.options&&this.options.mode==="dataset")return o.dataset.label||"";if(o.label)return o.label;if(m>0&&o.dataIndex<m)return u[o.dataIndex]}return""},afterTitle:ra,beforeBody:ra,beforeLabel:ra,label(l){if(this&&this.options&&this.options.mode==="dataset")return l.label+": "+l.formattedValue||l.formattedValue;let o=l.dataset.label||"";o&&(o+=": ");const u=l.formattedValue;return cn(u)||(o+=u),o},labelColor(l){const u=l.chart.getDatasetMeta(l.datasetIndex).controller.getStyle(l.dataIndex);return{borderColor:u.borderColor,backgroundColor:u.backgroundColor,borderWidth:u.borderWidth,borderDash:u.borderDash,borderDashOffset:u.borderDashOffset,borderRadius:0}},labelTextColor(){return this.options.bodyColor},labelPointStyle(l){const u=l.chart.getDatasetMeta(l.datasetIndex).controller.getStyle(l.dataIndex);return{pointStyle:u.pointStyle,rotation:u.rotation}},afterLabel:ra,afterBody:ra,beforeFooter:ra,footer:ra,afterFooter:ra};function os(l,o,u,m){const g=l[o].call(u,m);return typeof g>"u"?cS[o].call(u,m):g}class O0 extends uo{constructor(o){super(),this.opacity=0,this._active=[],this._eventPosition=void 0,this._size=void 0,this._cachedAnimations=void 0,this._tooltipItems=[],this.$animations=void 0,this.$context=void 0,this.chart=o.chart,this.options=o.options,this.dataPoints=void 0,this.title=void 0,this.beforeBody=void 0,this.body=void 0,this.afterBody=void 0,this.footer=void 0,this.xAlign=void 0,this.yAlign=void 0,this.x=void 0,this.y=void 0,this.height=void 0,this.width=void 0,this.caretX=void 0,this.caretY=void 0,this.labelColors=void 0,this.labelPointStyles=void 0,this.labelTextColors=void 0}initialize(o){this.options=o,this._cachedAnimations=void 0,this.$context=void 0}_resolveAnimations(){const o=this._cachedAnimations;if(o)return o;const u=this.chart,m=this.options.setContext(this.getContext()),g=m.enabled&&u.options.animation&&m.animations,b=new jM(this.chart,g);return g._cacheable&&(this._cachedAnimations=Object.freeze(b)),b}getContext(){return this.$context||(this.$context=Tz(this.chart.getContext(),this,this._tooltipItems))}getTitle(o,u){const{callbacks:m}=u,g=os(m,"beforeTitle",this,o),b=os(m,"title",this,o),M=os(m,"afterTitle",this,o);let A=[];return A=Ao(A,oa(g)),A=Ao(A,oa(b)),A=Ao(A,oa(M)),A}getBeforeBody(o,u){return cT(os(u.callbacks,"beforeBody",this,o))}getBody(o,u){const{callbacks:m}=u,g=[];return Mn(o,b=>{const M={before:[],lines:[],after:[]},A=uT(m,b);Ao(M.before,oa(os(A,"beforeLabel",this,b))),Ao(M.lines,os(A,"label",this,b)),Ao(M.after,oa(os(A,"afterLabel",this,b))),g.push(M)}),g}getAfterBody(o,u){return cT(os(u.callbacks,"afterBody",this,o))}getFooter(o,u){const{callbacks:m}=u,g=os(m,"beforeFooter",this,o),b=os(m,"footer",this,o),M=os(m,"afterFooter",this,o);let A=[];return A=Ao(A,oa(g)),A=Ao(A,oa(b)),A=Ao(A,oa(M)),A}_createItems(o){const u=this._active,m=this.chart.data,g=[],b=[],M=[];let A=[],r,k;for(r=0,k=u.length;r<k;++r)A.push(gz(this.chart,u[r]));return o.filter&&(A=A.filter((F,N,W)=>o.filter(F,N,W,m))),o.itemSort&&(A=A.sort((F,N)=>o.itemSort(F,N,m))),Mn(A,F=>{const N=uT(o.callbacks,F);g.push(os(N,"labelColor",this,F)),b.push(os(N,"labelPointStyle",this,F)),M.push(os(N,"labelTextColor",this,F))}),this.labelColors=g,this.labelPointStyles=b,this.labelTextColors=M,this.dataPoints=A,A}update(o,u){const m=this.options.setContext(this.getContext()),g=this._active;let b,M=[];if(!g.length)this.opacity!==0&&(b={opacity:0});else{const A=gf[m.position].call(this,g,this._eventPosition);M=this._createItems(m),this.title=this.getTitle(M,m),this.beforeBody=this.getBeforeBody(M,m),this.body=this.getBody(M,m),this.afterBody=this.getAfterBody(M,m),this.footer=this.getFooter(M,m);const r=this._size=oT(this,m),k=Object.assign({},A,r),F=aT(this.chart,m,k),N=lT(m,k,F,this.chart);this.xAlign=F.xAlign,this.yAlign=F.yAlign,b={opacity:1,x:N.x,y:N.y,width:r.width,height:r.height,caretX:A.x,caretY:A.y}}this._tooltipItems=M,this.$context=void 0,b&&this._resolveAnimations().update(this,b),o&&m.external&&m.external.call(this,{chart:this.chart,tooltip:this,replay:u})}drawCaret(o,u,m,g){const b=this.getCaretPosition(o,m,g);u.lineTo(b.x1,b.y1),u.lineTo(b.x2,b.y2),u.lineTo(b.x3,b.y3)}getCaretPosition(o,u,m){const{xAlign:g,yAlign:b}=this,{caretSize:M,cornerRadius:A}=m,{topLeft:r,topRight:k,bottomLeft:F,bottomRight:N}=Tc(A),{x:W,y:Q}=o,{width:te,height:ce}=u;let de,ve,Te,Ee,Me,Ie;return b==="center"?(Me=Q+ce/2,g==="left"?(de=W,ve=de-M,Ee=Me+M,Ie=Me-M):(de=W+te,ve=de+M,Ee=Me-M,Ie=Me+M),Te=de):(g==="left"?ve=W+Math.max(r,F)+M:g==="right"?ve=W+te-Math.max(k,N)-M:ve=this.caretX,b==="top"?(Ee=Q,Me=Ee-M,de=ve-M,Te=ve+M):(Ee=Q+ce,Me=Ee+M,de=ve+M,Te=ve-M),Ie=Ee),{x1:de,x2:ve,x3:Te,y1:Ee,y2:Me,y3:Ie}}drawTitle(o,u,m){const g=this.title,b=g.length;let M,A,r;if(b){const k=uh(m.rtl,this.x,this.width);for(o.x=d_(this,m.titleAlign,m),u.textAlign=k.textAlign(m.titleAlign),u.textBaseline="middle",M=br(m.titleFont),A=m.titleSpacing,u.fillStyle=m.titleColor,u.font=M.string,r=0;r<b;++r)u.fillText(g[r],k.x(o.x),o.y+M.lineHeight/2),o.y+=M.lineHeight+A,r+1===b&&(o.y+=m.titleMarginBottom-A)}}_drawColorBox(o,u,m,g,b){const M=this.labelColors[m],A=this.labelPointStyles[m],{boxHeight:r,boxWidth:k}=b,F=br(b.bodyFont),N=d_(this,"left",b),W=g.x(N),Q=r<F.lineHeight?(F.lineHeight-r)/2:0,te=u.y+Q;if(b.usePointStyle){const ce={radius:Math.min(k,r)/2,pointStyle:A.pointStyle,rotation:A.rotation,borderWidth:1},de=g.leftForLtr(W,k)+k/2,ve=te+r/2;o.strokeStyle=b.multiKeyBackground,o.fillStyle=b.multiKeyBackground,C0(o,ce,de,ve),o.strokeStyle=M.borderColor,o.fillStyle=M.backgroundColor,C0(o,ce,de,ve)}else{o.lineWidth=en(M.borderWidth)?Math.max(...Object.values(M.borderWidth)):M.borderWidth||1,o.strokeStyle=M.borderColor,o.setLineDash(M.borderDash||[]),o.lineDashOffset=M.borderDashOffset||0;const ce=g.leftForLtr(W,k),de=g.leftForLtr(g.xPlus(W,1),k-2),ve=Tc(M.borderRadius);Object.values(ve).some(Te=>Te!==0)?(o.beginPath(),o.fillStyle=b.multiKeyBackground,zf(o,{x:ce,y:te,w:k,h:r,radius:ve}),o.fill(),o.stroke(),o.fillStyle=M.backgroundColor,o.beginPath(),zf(o,{x:de,y:te+1,w:k-2,h:r-2,radius:ve}),o.fill()):(o.fillStyle=b.multiKeyBackground,o.fillRect(ce,te,k,r),o.strokeRect(ce,te,k,r),o.fillStyle=M.backgroundColor,o.fillRect(de,te+1,k-2,r-2))}o.fillStyle=this.labelTextColors[m]}drawBody(o,u,m){const{body:g}=this,{bodySpacing:b,bodyAlign:M,displayColors:A,boxHeight:r,boxWidth:k,boxPadding:F}=m,N=br(m.bodyFont);let W=N.lineHeight,Q=0;const te=uh(m.rtl,this.x,this.width),ce=function(nt){u.fillText(nt,te.x(o.x+Q),o.y+W/2),o.y+=W+b},de=te.textAlign(M);let ve,Te,Ee,Me,Ie,qe,Ve;for(u.textAlign=M,u.textBaseline="middle",u.font=N.string,o.x=d_(this,de,m),u.fillStyle=m.bodyColor,Mn(this.beforeBody,ce),Q=A&&de!=="right"?M==="center"?k/2+F:k+2+F:0,Me=0,qe=g.length;Me<qe;++Me){for(ve=g[Me],Te=this.labelTextColors[Me],u.fillStyle=Te,Mn(ve.before,ce),Ee=ve.lines,A&&Ee.length&&(this._drawColorBox(u,o,Me,te,m),W=Math.max(N.lineHeight,r)),Ie=0,Ve=Ee.length;Ie<Ve;++Ie)ce(Ee[Ie]),W=N.lineHeight;Mn(ve.after,ce)}Q=0,W=N.lineHeight,Mn(this.afterBody,ce),o.y-=b}drawFooter(o,u,m){const g=this.footer,b=g.length;let M,A;if(b){const r=uh(m.rtl,this.x,this.width);for(o.x=d_(this,m.footerAlign,m),o.y+=m.footerMarginTop,u.textAlign=r.textAlign(m.footerAlign),u.textBaseline="middle",M=br(m.footerFont),u.fillStyle=m.footerColor,u.font=M.string,A=0;A<b;++A)u.fillText(g[A],r.x(o.x),o.y+M.lineHeight/2),o.y+=M.lineHeight+m.footerSpacing}}drawBackground(o,u,m,g){const{xAlign:b,yAlign:M}=this,{x:A,y:r}=o,{width:k,height:F}=m,{topLeft:N,topRight:W,bottomLeft:Q,bottomRight:te}=Tc(g.cornerRadius);u.fillStyle=g.backgroundColor,u.strokeStyle=g.borderColor,u.lineWidth=g.borderWidth,u.beginPath(),u.moveTo(A+N,r),M==="top"&&this.drawCaret(o,u,m,g),u.lineTo(A+k-W,r),u.quadraticCurveTo(A+k,r,A+k,r+W),M==="center"&&b==="right"&&this.drawCaret(o,u,m,g),u.lineTo(A+k,r+F-te),u.quadraticCurveTo(A+k,r+F,A+k-te,r+F),M==="bottom"&&this.drawCaret(o,u,m,g),u.lineTo(A+Q,r+F),u.quadraticCurveTo(A,r+F,A,r+F-Q),M==="center"&&b==="left"&&this.drawCaret(o,u,m,g),u.lineTo(A,r+N),u.quadraticCurveTo(A,r,A+N,r),u.closePath(),u.fill(),g.borderWidth>0&&u.stroke()}_updateAnimationTarget(o){const u=this.chart,m=this.$animations,g=m&&m.x,b=m&&m.y;if(g||b){const M=gf[o.position].call(this,this._active,this._eventPosition);if(!M)return;const A=this._size=oT(this,o),r=Object.assign({},M,this._size),k=aT(u,o,r),F=lT(o,r,k,u);(g._to!==F.x||b._to!==F.y)&&(this.xAlign=k.xAlign,this.yAlign=k.yAlign,this.width=A.width,this.height=A.height,this.caretX=M.x,this.caretY=M.y,this._resolveAnimations().update(this,F))}}_willRender(){return!!this.opacity}draw(o){const u=this.options.setContext(this.getContext());let m=this.opacity;if(!m)return;this._updateAnimationTarget(u);const g={width:this.width,height:this.height},b={x:this.x,y:this.y};m=Math.abs(m)<.001?0:m;const M=qr(u.padding),A=this.title.length||this.beforeBody.length||this.body.length||this.afterBody.length||this.footer.length;u.enabled&&A&&(o.save(),o.globalAlpha=m,this.drawBackground(b,o,g,u),FM(o,u.textDirection),b.y+=M.top,this.drawTitle(b,o,u),this.drawBody(b,o,u),this.drawFooter(b,o,u),BM(o,u.textDirection),o.restore())}getActiveElements(){return this._active||[]}setActiveElements(o,u){const m=this._active,g=o.map(({datasetIndex:A,index:r})=>{const k=this.chart.getDatasetMeta(A);if(!k)throw new Error("Cannot find a dataset at index "+A);return{datasetIndex:A,element:k.data[r],index:r}}),b=!R_(m,g),M=this._positionChanged(g,u);(b||M)&&(this._active=g,this._eventPosition=u,this._ignoreReplayEvents=!0,this.update(!0))}handleEvent(o,u,m=!0){if(u&&this._ignoreReplayEvents)return!1;this._ignoreReplayEvents=!1;const g=this.options,b=this._active||[],M=this._getActiveElements(o,b,u,m),A=this._positionChanged(M,o),r=u||!R_(M,b)||A;return r&&(this._active=M,(g.enabled||g.external)&&(this._eventPosition={x:o.x,y:o.y},this.update(!0,u))),r}_getActiveElements(o,u,m,g){const b=this.options;if(o.type==="mouseout")return[];if(!g)return u.filter(A=>this.chart.data.datasets[A.datasetIndex]&&this.chart.getDatasetMeta(A.datasetIndex).controller.getParsed(A.index)!==void 0);const M=this.chart.getElementsAtEventForMode(o,b.mode,b,m);return b.reverse&&M.reverse(),M}_positionChanged(o,u){const{caretX:m,caretY:g,options:b}=this,M=gf[b.position].call(this,o,u);return M!==!1&&(m!==M.x||g!==M.y)}}Ft(O0,"positioners",gf);var Mz={id:"tooltip",_element:O0,positioners:gf,afterInit(l,o,u){u&&(l.tooltip=new O0({chart:l,options:u}))},beforeUpdate(l,o,u){l.tooltip&&l.tooltip.initialize(u)},reset(l,o,u){l.tooltip&&l.tooltip.initialize(u)},afterDraw(l){const o=l.tooltip;if(o&&o._willRender()){const u={tooltip:o};if(l.notifyPlugins("beforeTooltipDraw",{...u,cancelable:!0})===!1)return;o.draw(l.ctx),l.notifyPlugins("afterTooltipDraw",u)}},afterEvent(l,o){if(l.tooltip){const u=o.replay;l.tooltip.handleEvent(o.event,u,o.inChartArea)&&(o.changed=!0)}},defaults:{enabled:!0,external:null,position:"average",backgroundColor:"rgba(0,0,0,0.8)",titleColor:"#fff",titleFont:{weight:"bold"},titleSpacing:2,titleMarginBottom:6,titleAlign:"left",bodyColor:"#fff",bodySpacing:2,bodyFont:{},bodyAlign:"left",footerColor:"#fff",footerSpacing:2,footerMarginTop:6,footerFont:{weight:"bold"},footerAlign:"left",padding:6,caretPadding:2,caretSize:5,cornerRadius:6,boxHeight:(l,o)=>o.bodyFont.size,boxWidth:(l,o)=>o.bodyFont.size,multiKeyBackground:"#fff",displayColors:!0,boxPadding:0,borderColor:"rgba(0,0,0,0)",borderWidth:0,animation:{duration:400,easing:"easeOutQuart"},animations:{numbers:{type:"number",properties:["x","y","width","height","caretX","caretY"]},opacity:{easing:"linear",duration:200}},callbacks:cS},defaultRoutes:{bodyFont:"font",footerFont:"font",titleFont:"font"},descriptors:{_scriptable:l=>l!=="filter"&&l!=="itemSort"&&l!=="external",_indexable:!1,callbacks:{_scriptable:!1,_indexable:!1},animation:{_fallback:!1},animations:{_fallback:"animation"}},additionalOptionScopes:["interaction"]},Sz=Object.freeze({__proto__:null,Colors:FR,Decimation:UR,Filler:az,Legend:fz,SubTitle:_z,Title:mz,Tooltip:Mz});const Ez=(l,o,u,m)=>(typeof o=="string"?(u=l.push(o)-1,m.unshift({index:u,label:o})):isNaN(o)&&(u=null),u);function Az(l,o,u,m){const g=l.indexOf(o);if(g===-1)return Ez(l,o,u,m);const b=l.lastIndexOf(o);return g!==b?u:g}const Iz=(l,o)=>l===null?null:Ar(Math.round(l),0,o);function hT(l){const o=this.getLabels();return l>=0&&l<o.length?o[l]:l}class F0 extends Cc{constructor(o){super(o),this._startValue=void 0,this._valueRange=0,this._addedLabels=[]}init(o){const u=this._addedLabels;if(u.length){const m=this.getLabels();for(const{index:g,label:b}of u)m[g]===b&&m.splice(g,1);this._addedLabels=[]}super.init(o)}parse(o,u){if(cn(o))return null;const m=this.getLabels();return u=isFinite(u)&&m[u]===o?u:Az(m,o,Fi(u,o),this._addedLabels),Iz(u,m.length-1)}determineDataLimits(){const{minDefined:o,maxDefined:u}=this.getUserBounds();let{min:m,max:g}=this.getMinMax(!0);this.options.bounds==="ticks"&&(o||(m=0),u||(g=this.getLabels().length-1)),this.min=m,this.max=g}buildTicks(){const o=this.min,u=this.max,m=this.options.offset,g=[];let b=this.getLabels();b=o===0&&u===b.length-1?b:b.slice(o,u+1),this._valueRange=Math.max(b.length-(m?0:1),1),this._startValue=this.min-(m?.5:0);for(let M=o;M<=u;M++)g.push({value:M});return g}getLabelForValue(o){return hT.call(this,o)}configure(){super.configure(),this.isHorizontal()||(this._reversePixels=!this._reversePixels)}getPixelForValue(o){return typeof o!="number"&&(o=this.parse(o)),o===null?NaN:this.getPixelForDecimal((o-this._startValue)/this._valueRange)}getPixelForTick(o){const u=this.ticks;return o<0||o>u.length-1?null:this.getPixelForValue(u[o].value)}getValueForPixel(o){return Math.round(this._startValue+this.getDecimalForPixel(o)*this._valueRange)}getBasePixel(){return this.bottom}}Ft(F0,"id","category"),Ft(F0,"defaults",{ticks:{callback:hT}});function Cz(l,o){const u=[],{bounds:g,step:b,min:M,max:A,precision:r,count:k,maxTicks:F,maxDigits:N,includeBounds:W}=l,Q=b||1,te=F-1,{min:ce,max:de}=o,ve=!cn(M),Te=!cn(A),Ee=!cn(k),Me=(de-ce)/(N+1);let Ie=sw((de-ce)/te/Q)*Q,qe,Ve,nt,lt;if(Ie<1e-14&&!ve&&!Te)return[{value:ce},{value:de}];lt=Math.ceil(de/Ie)-Math.floor(ce/Ie),lt>te&&(Ie=sw(lt*Ie/te/Q)*Q),cn(r)||(qe=Math.pow(10,r),Ie=Math.ceil(Ie*qe)/qe),g==="ticks"?(Ve=Math.floor(ce/Ie)*Ie,nt=Math.ceil(de/Ie)*Ie):(Ve=ce,nt=de),ve&&Te&&b&&TP((A-M)/b,Ie/1e3)?(lt=Math.round(Math.min((A-M)/Ie,F)),Ie=(A-M)/lt,Ve=M,nt=A):Ee?(Ve=ve?M:Ve,nt=Te?A:nt,lt=k-1,Ie=(nt-Ve)/lt):(lt=(nt-Ve)/Ie,Mf(lt,Math.round(lt),Ie/1e3)?lt=Math.round(lt):lt=Math.ceil(lt));const ht=Math.max(ow(Ie),ow(Ve));qe=Math.pow(10,cn(r)?ht:r),Ve=Math.round(Ve*qe)/qe,nt=Math.round(nt*qe)/qe;let st=0;for(ve&&(W&&Ve!==M?(u.push({value:M}),Ve<M&&st++,Mf(Math.round((Ve+st*Ie)*qe)/qe,M,dT(M,Me,l))&&st++):Ve<M&&st++);st<lt;++st){const Ot=Math.round((Ve+st*Ie)*qe)/qe;if(Te&&Ot>A)break;u.push({value:Ot})}return Te&&W&&nt!==A?u.length&&Mf(u[u.length-1].value,A,dT(A,Me,l))?u[u.length-1].value=A:u.push({value:A}):(!Te||nt===A)&&u.push({value:nt}),u}function dT(l,o,{horizontal:u,minRotation:m}){const g=ao(m),b=(u?Math.sin(g):Math.cos(g))||.001,M=.75*o*(""+l).length;return Math.min(o/b,M)}class V_ extends Cc{constructor(o){super(o),this.start=void 0,this.end=void 0,this._startValue=void 0,this._endValue=void 0,this._valueRange=0}parse(o,u){return cn(o)||(typeof o=="number"||o instanceof Number)&&!isFinite(+o)?null:+o}handleTickRangeOptions(){const{beginAtZero:o}=this.options,{minDefined:u,maxDefined:m}=this.getUserBounds();let{min:g,max:b}=this;const M=r=>g=u?g:r,A=r=>b=m?b:r;if(o){const r=Co(g),k=Co(b);r<0&&k<0?A(0):r>0&&k>0&&M(0)}if(g===b){let r=b===0?1:Math.abs(b*.05);A(b+r),o||M(g-r)}this.min=g,this.max=b}getTickLimit(){const o=this.options.ticks;let{maxTicksLimit:u,stepSize:m}=o,g;return m?(g=Math.ceil(this.max/m)-Math.floor(this.min/m)+1,g>1e3&&(console.warn(`scales.${this.id}.ticks.stepSize: ${m} would result generating up to ${g} ticks. Limiting to 1000.`),g=1e3)):(g=this.computeTickLimit(),u=u||11),u&&(g=Math.min(u,g)),g}computeTickLimit(){return Number.POSITIVE_INFINITY}buildTicks(){const o=this.options,u=o.ticks;let m=this.getTickLimit();m=Math.max(2,m);const g={maxTicks:m,bounds:o.bounds,min:o.min,max:o.max,precision:u.precision,step:u.stepSize,count:u.count,maxDigits:this._maxDigits(),horizontal:this.isHorizontal(),minRotation:u.minRotation||0,includeBounds:u.includeBounds!==!1},b=this._range||this,M=Cz(g,b);return o.bounds==="ticks"&&vM(M,this,"value"),o.reverse?(M.reverse(),this.start=this.max,this.end=this.min):(this.start=this.min,this.end=this.max),M}configure(){const o=this.ticks;let u=this.min,m=this.max;if(super.configure(),this.options.offset&&o.length){const g=(m-u)/Math.max(o.length-1,1)/2;u-=g,m+=g}this._startValue=u,this._endValue=m,this._valueRange=m-u}getLabelForValue(o){return jf(o,this.chart.options.locale,this.options.ticks.format)}}class B0 extends V_{determineDataLimits(){const{min:o,max:u}=this.getMinMax(!0);this.min=Jn(o)?o:0,this.max=Jn(u)?u:1,this.handleTickRangeOptions()}computeTickLimit(){const o=this.isHorizontal(),u=o?this.width:this.height,m=ao(this.options.ticks.minRotation),g=(o?Math.sin(m):Math.cos(m))||.001,b=this._resolveTickFontOptions(0);return Math.ceil(u/Math.min(40,b.lineHeight/g))}getPixelForValue(o){return o===null?NaN:this.getPixelForDecimal((o-this._startValue)/this._valueRange)}getValueForPixel(o){return this._startValue+this.getDecimalForPixel(o)*this._valueRange}}Ft(B0,"id","linear"),Ft(B0,"defaults",{ticks:{callback:K_.formatters.numeric}});const Of=l=>Math.floor(sl(l)),xc=(l,o)=>Math.pow(10,Of(l)+o);function fT(l){return l/Math.pow(10,Of(l))===1}function pT(l,o,u){const m=Math.pow(10,u),g=Math.floor(l/m);return Math.ceil(o/m)-g}function Pz(l,o){const u=o-l;let m=Of(u);for(;pT(l,o,m)>10;)m++;for(;pT(l,o,m)<10;)m--;return Math.min(m,Of(l))}function Dz(l,{min:o,max:u}){o=Es(l.min,o);const m=[],g=Of(o);let b=Pz(o,u),M=b<0?Math.pow(10,Math.abs(b)):1;const A=Math.pow(10,b),r=g>b?Math.pow(10,g):0,k=Math.round((o-r)*M)/M,F=Math.floor((o-r)/A/10)*A*10;let N=Math.floor((k-F)/Math.pow(10,b)),W=Es(l.min,Math.round((r+F+N*Math.pow(10,b))*M)/M);for(;W<u;)m.push({value:W,major:fT(W),significand:N}),N>=10?N=N<15?15:20:N++,N>=20&&(b++,N=2,M=b>=0?1:M),W=Math.round((r+F+N*Math.pow(10,b))*M)/M;const Q=Es(l.max,W);return m.push({value:Q,major:fT(Q),significand:N}),m}class N0 extends Cc{constructor(o){super(o),this.start=void 0,this.end=void 0,this._startValue=void 0,this._valueRange=0}parse(o,u){const m=V_.prototype.parse.apply(this,[o,u]);if(m===0){this._zero=!0;return}return Jn(m)&&m>0?m:null}determineDataLimits(){const{min:o,max:u}=this.getMinMax(!0);this.min=Jn(o)?Math.max(0,o):null,this.max=Jn(u)?Math.max(0,u):null,this.options.beginAtZero&&(this._zero=!0),this._zero&&this.min!==this._suggestedMin&&!Jn(this._userMin)&&(this.min=o===xc(this.min,0)?xc(this.min,-1):xc(this.min,0)),this.handleTickRangeOptions()}handleTickRangeOptions(){const{minDefined:o,maxDefined:u}=this.getUserBounds();let m=this.min,g=this.max;const b=A=>m=o?m:A,M=A=>g=u?g:A;m===g&&(m<=0?(b(1),M(10)):(b(xc(m,-1)),M(xc(g,1)))),m<=0&&b(xc(g,-1)),g<=0&&M(xc(m,1)),this.min=m,this.max=g}buildTicks(){const o=this.options,u={min:this._userMin,max:this._userMax},m=Dz(u,this);return o.bounds==="ticks"&&vM(m,this,"value"),o.reverse?(m.reverse(),this.start=this.max,this.end=this.min):(this.start=this.min,this.end=this.max),m}getLabelForValue(o){return o===void 0?"0":jf(o,this.chart.options.locale,this.options.ticks.format)}configure(){const o=this.min;super.configure(),this._startValue=sl(o),this._valueRange=sl(this.max)-sl(o)}getPixelForValue(o){return(o===void 0||o===0)&&(o=this.min),o===null||isNaN(o)?NaN:this.getPixelForDecimal(o===this.min?0:(sl(o)-this._startValue)/this._valueRange)}getValueForPixel(o){const u=this.getDecimalForPixel(o);return Math.pow(10,this._startValue+u*this._valueRange)}}Ft(N0,"id","logarithmic"),Ft(N0,"defaults",{ticks:{callback:K_.formatters.logarithmic,major:{enabled:!0}}});function V0(l){const o=l.ticks;if(o.display&&l.display){const u=qr(o.backdropPadding);return Fi(o.font&&o.font.size,er.font.size)+u.height}return 0}function kz(l,o,u){return u=qn(u)?u:[u],{w:VP(l,o.string,u),h:u.length*o.lineHeight}}function mT(l,o,u,m,g){return l===m||l===g?{start:o-u/2,end:o+u/2}:l<m||l>g?{start:o-u,end:o}:{start:o,end:o+u}}function Rz(l){const o={l:l.left+l._padding.left,r:l.right-l._padding.right,t:l.top+l._padding.top,b:l.bottom-l._padding.bottom},u=Object.assign({},o),m=[],g=[],b=l._pointLabels.length,M=l.options.pointLabels,A=M.centerPointLabels?Vn/b:0;for(let r=0;r<b;r++){const k=M.setContext(l.getPointLabelContext(r));g[r]=k.padding;const F=l.getPointPosition(r,l.drawingArea+g[r],A),N=br(k.font),W=kz(l.ctx,N,l._pointLabels[r]);m[r]=W;const Q=Is(l.getIndexAngle(r)+A),te=Math.round(tx(Q)),ce=mT(te,F.x,W.w,0,180),de=mT(te,F.y,W.h,90,270);zz(u,o,Q,ce,de)}l.setCenterPoint(o.l-u.l,u.r-o.r,o.t-u.t,u.b-o.b),l._pointLabelItems=Fz(l,m,g)}function zz(l,o,u,m,g){const b=Math.abs(Math.sin(u)),M=Math.abs(Math.cos(u));let A=0,r=0;m.start<o.l?(A=(o.l-m.start)/b,l.l=Math.min(l.l,o.l-A)):m.end>o.r&&(A=(m.end-o.r)/b,l.r=Math.max(l.r,o.r+A)),g.start<o.t?(r=(o.t-g.start)/M,l.t=Math.min(l.t,o.t-r)):g.end>o.b&&(r=(g.end-o.b)/M,l.b=Math.max(l.b,o.b+r))}function Lz(l,o,u){const m=l.drawingArea,{extra:g,additionalAngle:b,padding:M,size:A}=u,r=l.getPointPosition(o,m+g+M,b),k=Math.round(tx(Is(r.angle+ar))),F=Vz(r.y,A.h,k),N=Bz(k),W=Nz(r.x,A.w,N);return{visible:!0,x:r.x,y:F,textAlign:N,left:W,top:F,right:W+A.w,bottom:F+A.h}}function Oz(l,o){if(!o)return!0;const{left:u,top:m,right:g,bottom:b}=l;return!(ha({x:u,y:m},o)||ha({x:u,y:b},o)||ha({x:g,y:m},o)||ha({x:g,y:b},o))}function Fz(l,o,u){const m=[],g=l._pointLabels.length,b=l.options,{centerPointLabels:M,display:A}=b.pointLabels,r={extra:V0(b)/2,additionalAngle:M?Vn/g:0};let k;for(let F=0;F<g;F++){r.padding=u[F],r.size=o[F];const N=Lz(l,F,r);m.push(N),A==="auto"&&(N.visible=Oz(N,k),N.visible&&(k=N))}return m}function Bz(l){return l===0||l===180?"center":l<180?"left":"right"}function Nz(l,o,u){return u==="right"?l-=o:u==="center"&&(l-=o/2),l}function Vz(l,o,u){return u===90||u===270?l-=o/2:(u>270||u<90)&&(l-=o),l}function Uz(l,o,u){const{left:m,top:g,right:b,bottom:M}=u,{backdropColor:A}=o;if(!cn(A)){const r=Tc(o.borderRadius),k=qr(o.backdropPadding);l.fillStyle=A;const F=m-k.left,N=g-k.top,W=b-m+k.width,Q=M-g+k.height;Object.values(r).some(te=>te!==0)?(l.beginPath(),zf(l,{x:F,y:N,w:W,h:Q,radius:r}),l.fill()):l.fillRect(F,N,W,Q)}}function jz(l,o){const{ctx:u,options:{pointLabels:m}}=l;for(let g=o-1;g>=0;g--){const b=l._pointLabelItems[g];if(!b.visible)continue;const M=m.setContext(l.getPointLabelContext(g));Uz(u,M,b);const A=br(M.font),{x:r,y:k,textAlign:F}=b;Ec(u,l._pointLabels[g],r,k+A.lineHeight/2,A,{color:M.color,textAlign:F,textBaseline:"middle"})}}function uS(l,o,u,m){const{ctx:g}=l;if(u)g.arc(l.xCenter,l.yCenter,o,0,Nn);else{let b=l.getPointPosition(0,o);g.moveTo(b.x,b.y);for(let M=1;M<m;M++)b=l.getPointPosition(M,o),g.lineTo(b.x,b.y)}}function Gz(l,o,u,m,g){const b=l.ctx,M=o.circular,{color:A,lineWidth:r}=o;!M&&!m||!A||!r||u<0||(b.save(),b.strokeStyle=A,b.lineWidth=r,b.setLineDash(g.dash),b.lineDashOffset=g.dashOffset,b.beginPath(),uS(l,u,M,m),b.closePath(),b.stroke(),b.restore())}function Wz(l,o,u){return hl(l,{label:u,index:o,type:"pointLabel"})}class yf extends V_{constructor(o){super(o),this.xCenter=void 0,this.yCenter=void 0,this.drawingArea=void 0,this._pointLabels=[],this._pointLabelItems=[]}setDimensions(){const o=this._padding=qr(V0(this.options)/2),u=this.width=this.maxWidth-o.width,m=this.height=this.maxHeight-o.height;this.xCenter=Math.floor(this.left+u/2+o.left),this.yCenter=Math.floor(this.top+m/2+o.top),this.drawingArea=Math.floor(Math.min(u,m)/2)}determineDataLimits(){const{min:o,max:u}=this.getMinMax(!1);this.min=Jn(o)&&!isNaN(o)?o:0,this.max=Jn(u)&&!isNaN(u)?u:0,this.handleTickRangeOptions()}computeTickLimit(){return Math.ceil(this.drawingArea/V0(this.options))}generateTickLabels(o){V_.prototype.generateTickLabels.call(this,o),this._pointLabels=this.getLabels().map((u,m)=>{const g=zn(this.options.pointLabels.callback,[u,m],this);return g||g===0?g:""}).filter((u,m)=>this.chart.getDataVisibility(m))}fit(){const o=this.options;o.display&&o.pointLabels.display?Rz(this):this.setCenterPoint(0,0,0,0)}setCenterPoint(o,u,m,g){this.xCenter+=Math.floor((o-u)/2),this.yCenter+=Math.floor((m-g)/2),this.drawingArea-=Math.min(this.drawingArea/2,Math.max(o,u,m,g))}getIndexAngle(o){const u=Nn/(this._pointLabels.length||1),m=this.options.startAngle||0;return Is(o*u+ao(m))}getDistanceFromCenterForValue(o){if(cn(o))return NaN;const u=this.drawingArea/(this.max-this.min);return this.options.reverse?(this.max-o)*u:(o-this.min)*u}getValueForDistanceFromCenter(o){if(cn(o))return NaN;const u=o/(this.drawingArea/(this.max-this.min));return this.options.reverse?this.max-u:this.min+u}getPointLabelContext(o){const u=this._pointLabels||[];if(o>=0&&o<u.length){const m=u[o];return Wz(this.getContext(),o,m)}}getPointPosition(o,u,m=0){const g=this.getIndexAngle(o)-ar+m;return{x:Math.cos(g)*u+this.xCenter,y:Math.sin(g)*u+this.yCenter,angle:g}}getPointPositionForValue(o,u){return this.getPointPosition(o,this.getDistanceFromCenterForValue(u))}getBasePosition(o){return this.getPointPositionForValue(o||0,this.getBaseValue())}getPointLabelPosition(o){const{left:u,top:m,right:g,bottom:b}=this._pointLabelItems[o];return{left:u,top:m,right:g,bottom:b}}drawBackground(){const{backgroundColor:o,grid:{circular:u}}=this.options;if(o){const m=this.ctx;m.save(),m.beginPath(),uS(this,this.getDistanceFromCenterForValue(this._endValue),u,this._pointLabels.length),m.closePath(),m.fillStyle=o,m.fill(),m.restore()}}drawGrid(){const o=this.ctx,u=this.options,{angleLines:m,grid:g,border:b}=u,M=this._pointLabels.length;let A,r,k;if(u.pointLabels.display&&jz(this,M),g.display&&this.ticks.forEach((F,N)=>{if(N!==0||N===0&&this.min<0){r=this.getDistanceFromCenterForValue(F.value);const W=this.getContext(N),Q=g.setContext(W),te=b.setContext(W);Gz(this,Q,r,M,te)}}),m.display){for(o.save(),A=M-1;A>=0;A--){const F=m.setContext(this.getPointLabelContext(A)),{color:N,lineWidth:W}=F;!W||!N||(o.lineWidth=W,o.strokeStyle=N,o.setLineDash(F.borderDash),o.lineDashOffset=F.borderDashOffset,r=this.getDistanceFromCenterForValue(u.ticks.reverse?this.min:this.max),k=this.getPointPosition(A,r),o.beginPath(),o.moveTo(this.xCenter,this.yCenter),o.lineTo(k.x,k.y),o.stroke())}o.restore()}}drawBorder(){}drawLabels(){const o=this.ctx,u=this.options,m=u.ticks;if(!m.display)return;const g=this.getIndexAngle(0);let b,M;o.save(),o.translate(this.xCenter,this.yCenter),o.rotate(g),o.textAlign="center",o.textBaseline="middle",this.ticks.forEach((A,r)=>{if(r===0&&this.min>=0&&!u.reverse)return;const k=m.setContext(this.getContext(r)),F=br(k.font);if(b=this.getDistanceFromCenterForValue(this.ticks[r].value),k.showLabelBackdrop){o.font=F.string,M=o.measureText(A.label).width,o.fillStyle=k.backdropColor;const N=qr(k.backdropPadding);o.fillRect(-M/2-N.left,-b-F.size/2-N.top,M+N.width,F.size+N.height)}Ec(o,A.label,0,-b,F,{color:k.color,strokeColor:k.textStrokeColor,strokeWidth:k.textStrokeWidth})}),o.restore()}drawTitle(){}}Ft(yf,"id","radialLinear"),Ft(yf,"defaults",{display:!0,animate:!0,position:"chartArea",angleLines:{display:!0,lineWidth:1,borderDash:[],borderDashOffset:0},grid:{circular:!1},startAngle:0,ticks:{showLabelBackdrop:!0,callback:K_.formatters.numeric},pointLabels:{backdropColor:void 0,backdropPadding:2,display:!0,font:{size:10},callback(o){return o},padding:5,centerPointLabels:!1}}),Ft(yf,"defaultRoutes",{"angleLines.color":"borderColor","pointLabels.color":"color","ticks.color":"color"}),Ft(yf,"descriptors",{angleLines:{_fallback:"grid"}});const ig={millisecond:{common:!0,size:1,steps:1e3},second:{common:!0,size:1e3,steps:60},minute:{common:!0,size:6e4,steps:60},hour:{common:!0,size:36e5,steps:24},day:{common:!0,size:864e5,steps:30},week:{common:!1,size:6048e5,steps:4},month:{common:!0,size:2628e6,steps:12},quarter:{common:!1,size:7884e6,steps:4},year:{common:!0,size:3154e7}},cs=Object.keys(ig);function _T(l,o){return l-o}function gT(l,o){if(cn(o))return null;const u=l._adapter,{parser:m,round:g,isoWeekday:b}=l._parseOpts;let M=o;return typeof m=="function"&&(M=m(M)),Jn(M)||(M=typeof m=="string"?u.parse(M,m):u.parse(M)),M===null?null:(g&&(M=g==="week"&&(hh(b)||b===!0)?u.startOf(M,"isoWeek",b):u.startOf(M,g)),+M)}function yT(l,o,u,m){const g=cs.length;for(let b=cs.indexOf(l);b<g-1;++b){const M=ig[cs[b]],A=M.steps?M.steps:Number.MAX_SAFE_INTEGER;if(M.common&&Math.ceil((u-o)/(A*M.size))<=m)return cs[b]}return cs[g-1]}function qz(l,o,u,m,g){for(let b=cs.length-1;b>=cs.indexOf(u);b--){const M=cs[b];if(ig[M].common&&l._adapter.diff(g,m,M)>=o-1)return M}return cs[u?cs.indexOf(u):0]}function Hz(l){for(let o=cs.indexOf(l)+1,u=cs.length;o<u;++o)if(ig[cs[o]].common)return cs[o]}function xT(l,o,u){if(!u)l[o]=!0;else if(u.length){const{lo:m,hi:g}=ix(u,o),b=u[m]>=o?u[m]:u[g];l[b]=!0}}function Zz(l,o,u,m){const g=l._adapter,b=+g.startOf(o[0].value,m),M=o[o.length-1].value;let A,r;for(A=b;A<=M;A=+g.add(A,1,m))r=u[A],r>=0&&(o[r].major=!0);return o}function vT(l,o,u){const m=[],g={},b=o.length;let M,A;for(M=0;M<b;++M)A=o[M],g[A]=M,m.push({value:A,major:!1});return b===0||!u?m:Zz(l,m,g,u)}class Ff extends Cc{constructor(o){super(o),this._cache={data:[],labels:[],all:[]},this._unit="day",this._majorUnit=void 0,this._offsets={},this._normalized=!1,this._parseOpts=void 0}init(o,u={}){const m=o.time||(o.time={}),g=this._adapter=new ik._date(o.adapters.date);g.init(u),Tf(m.displayFormats,g.formats()),this._parseOpts={parser:m.parser,round:m.round,isoWeekday:m.isoWeekday},super.init(o),this._normalized=u.normalized}parse(o,u){return o===void 0?null:gT(this,o)}beforeLayout(){super.beforeLayout(),this._cache={data:[],labels:[],all:[]}}determineDataLimits(){const o=this.options,u=this._adapter,m=o.time.unit||"day";let{min:g,max:b,minDefined:M,maxDefined:A}=this.getUserBounds();function r(k){!M&&!isNaN(k.min)&&(g=Math.min(g,k.min)),!A&&!isNaN(k.max)&&(b=Math.max(b,k.max))}(!M||!A)&&(r(this._getLabelBounds()),(o.bounds!=="ticks"||o.ticks.source!=="labels")&&r(this.getMinMax(!1))),g=Jn(g)&&!isNaN(g)?g:+u.startOf(Date.now(),m),b=Jn(b)&&!isNaN(b)?b:+u.endOf(Date.now(),m)+1,this.min=Math.min(g,b-1),this.max=Math.max(g+1,b)}_getLabelBounds(){const o=this.getLabelTimestamps();let u=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY;return o.length&&(u=o[0],m=o[o.length-1]),{min:u,max:m}}buildTicks(){const o=this.options,u=o.time,m=o.ticks,g=m.source==="labels"?this.getLabelTimestamps():this._generate();o.bounds==="ticks"&&g.length&&(this.min=this._userMin||g[0],this.max=this._userMax||g[g.length-1]);const b=this.min,M=this.max,A=AP(g,b,M);return this._unit=u.unit||(m.autoSkip?yT(u.minUnit,this.min,this.max,this._getLabelCapacity(b)):qz(this,A.length,u.minUnit,this.min,this.max)),this._majorUnit=!m.major.enabled||this._unit==="year"?void 0:Hz(this._unit),this.initOffsets(g),o.reverse&&A.reverse(),vT(this,A,this._majorUnit)}afterAutoSkip(){this.options.offsetAfterAutoskip&&this.initOffsets(this.ticks.map(o=>+o.value))}initOffsets(o=[]){let u=0,m=0,g,b;this.options.offset&&o.length&&(g=this.getDecimalForValue(o[0]),o.length===1?u=1-g:u=(this.getDecimalForValue(o[1])-g)/2,b=this.getDecimalForValue(o[o.length-1]),o.length===1?m=b:m=(b-this.getDecimalForValue(o[o.length-2]))/2);const M=o.length<3?.5:.25;u=Ar(u,0,M),m=Ar(m,0,M),this._offsets={start:u,end:m,factor:1/(u+1+m)}}_generate(){const o=this._adapter,u=this.min,m=this.max,g=this.options,b=g.time,M=b.unit||yT(b.minUnit,u,m,this._getLabelCapacity(u)),A=Fi(g.ticks.stepSize,1),r=M==="week"?b.isoWeekday:!1,k=hh(r)||r===!0,F={};let N=u,W,Q;if(k&&(N=+o.startOf(N,"isoWeek",r)),N=+o.startOf(N,k?"day":M),o.diff(m,u,M)>1e5*A)throw new Error(u+" and "+m+" are too far apart with stepSize of "+A+" "+M);const te=g.ticks.source==="data"&&this.getDataTimestamps();for(W=N,Q=0;W<m;W=+o.add(W,A,M),Q++)xT(F,W,te);return(W===m||g.bounds==="ticks"||Q===1)&&xT(F,W,te),Object.keys(F).sort(_T).map(ce=>+ce)}getLabelForValue(o){const u=this._adapter,m=this.options.time;return m.tooltipFormat?u.format(o,m.tooltipFormat):u.format(o,m.displayFormats.datetime)}format(o,u){const g=this.options.time.displayFormats,b=this._unit,M=u||g[b];return this._adapter.format(o,M)}_tickFormatFunction(o,u,m,g){const b=this.options,M=b.ticks.callback;if(M)return zn(M,[o,u,m],this);const A=b.time.displayFormats,r=this._unit,k=this._majorUnit,F=r&&A[r],N=k&&A[k],W=m[u],Q=k&&N&&W&&W.major;return this._adapter.format(o,g||(Q?N:F))}generateTickLabels(o){let u,m,g;for(u=0,m=o.length;u<m;++u)g=o[u],g.label=this._tickFormatFunction(g.value,u,o)}getDecimalForValue(o){return o===null?NaN:(o-this.min)/(this.max-this.min)}getPixelForValue(o){const u=this._offsets,m=this.getDecimalForValue(o);return this.getPixelForDecimal((u.start+m)*u.factor)}getValueForPixel(o){const u=this._offsets,m=this.getDecimalForPixel(o)/u.factor-u.end;return this.min+m*(this.max-this.min)}_getLabelSize(o){const u=this.options.ticks,m=this.ctx.measureText(o).width,g=ao(this.isHorizontal()?u.maxRotation:u.minRotation),b=Math.cos(g),M=Math.sin(g),A=this._resolveTickFontOptions(0).size;return{w:m*b+A*M,h:m*M+A*b}}_getLabelCapacity(o){const u=this.options.time,m=u.displayFormats,g=m[u.unit]||m.millisecond,b=this._tickFormatFunction(o,0,vT(this,[o],this._majorUnit),g),M=this._getLabelSize(b),A=Math.floor(this.isHorizontal()?this.width/M.w:this.height/M.h)-1;return A>0?A:1}getDataTimestamps(){let o=this._cache.data||[],u,m;if(o.length)return o;const g=this.getMatchingVisibleMetas();if(this._normalized&&g.length)return this._cache.data=g[0].controller.getAllParsedValues(this);for(u=0,m=g.length;u<m;++u)o=o.concat(g[u].controller.getAllParsedValues(this));return this._cache.data=this.normalize(o)}getLabelTimestamps(){const o=this._cache.labels||[];let u,m;if(o.length)return o;const g=this.getLabels();for(u=0,m=g.length;u<m;++u)o.push(gT(this,g[u]));return this._cache.labels=this._normalized?o:this.normalize(o)}normalize(o){return TM(o.sort(_T))}}Ft(Ff,"id","time"),Ft(Ff,"defaults",{bounds:"data",adapters:{},time:{parser:!1,unit:!1,round:!1,isoWeekday:!1,minUnit:"millisecond",displayFormats:{}},ticks:{source:"auto",callback:!1,major:{enabled:!1}}});function f_(l,o,u){let m=0,g=l.length-1,b,M,A,r;u?(o>=l[m].pos&&o<=l[g].pos&&({lo:m,hi:g}=ua(l,"pos",o)),{pos:b,time:A}=l[m],{pos:M,time:r}=l[g]):(o>=l[m].time&&o<=l[g].time&&({lo:m,hi:g}=ua(l,"time",o)),{time:b,pos:A}=l[m],{time:M,pos:r}=l[g]);const k=M-b;return k?A+(r-A)*(o-b)/k:A}class U0 extends Ff{constructor(o){super(o),this._table=[],this._minPos=void 0,this._tableRange=void 0}initOffsets(){const o=this._getTimestampsForTable(),u=this._table=this.buildLookupTable(o);this._minPos=f_(u,this.min),this._tableRange=f_(u,this.max)-this._minPos,super.initOffsets(o)}buildLookupTable(o){const{min:u,max:m}=this,g=[],b=[];let M,A,r,k,F;for(M=0,A=o.length;M<A;++M)k=o[M],k>=u&&k<=m&&g.push(k);if(g.length<2)return[{time:u,pos:0},{time:m,pos:1}];for(M=0,A=g.length;M<A;++M)F=g[M+1],r=g[M-1],k=g[M],Math.round((F+r)/2)!==k&&b.push({time:k,pos:M/(A-1)});return b}_generate(){const o=this.min,u=this.max;let m=super.getDataTimestamps();return(!m.includes(o)||!m.length)&&m.splice(0,0,o),(!m.includes(u)||m.length===1)&&m.push(u),m.sort((g,b)=>g-b)}_getTimestampsForTable(){let o=this._cache.all||[];if(o.length)return o;const u=this.getDataTimestamps(),m=this.getLabelTimestamps();return u.length&&m.length?o=this.normalize(u.concat(m)):o=u.length?u:m,o=this._cache.all=o,o}getDecimalForValue(o){return(f_(this._table,o)-this._minPos)/this._tableRange}getValueForPixel(o){const u=this._offsets,m=this.getDecimalForPixel(o)/u.factor-u.end;return f_(this._table,m*this._tableRange+this._minPos,!0)}}Ft(U0,"id","timeseries"),Ft(U0,"defaults",Ff.defaults);var $z=Object.freeze({__proto__:null,CategoryScale:F0,LinearScale:B0,LogarithmicScale:N0,RadialLinearScale:yf,TimeScale:Ff,TimeSeriesScale:U0});const Yz=[tk,DR,Sz,$z];var bT={},f0={},p0=34,cf=10,m0=13;function hS(l){return new Function("d","return {"+l.map(function(o,u){return JSON.stringify(o)+": d["+u+'] || ""'}).join(",")+"}")}function Qz(l,o){var u=hS(l);return function(m,g){return o(u(m),g,l)}}function wT(l){var o=Object.create(null),u=[];return l.forEach(function(m){for(var g in m)g in o||u.push(o[g]=g)}),u}function as(l,o){var u=l+"",m=u.length;return m<o?new Array(o-m+1).join(0)+u:u}function Xz(l){return l<0?"-"+as(-l,6):l>9999?"+"+as(l,6):as(l,4)}function Kz(l){var o=l.getUTCHours(),u=l.getUTCMinutes(),m=l.getUTCSeconds(),g=l.getUTCMilliseconds();return isNaN(l)?"Invalid Date":Xz(l.getUTCFullYear())+"-"+as(l.getUTCMonth()+1,2)+"-"+as(l.getUTCDate(),2)+(g?"T"+as(o,2)+":"+as(u,2)+":"+as(m,2)+"."+as(g,3)+"Z":m?"T"+as(o,2)+":"+as(u,2)+":"+as(m,2)+"Z":u||o?"T"+as(o,2)+":"+as(u,2)+"Z":"")}function Jz(l){var o=new RegExp('["'+l+`
\r]`),u=l.charCodeAt(0);function m(N,W){var Q,te,ce=g(N,function(de,ve){if(Q)return Q(de,ve-1);te=de,Q=W?Qz(de,W):hS(de)});return ce.columns=te||[],ce}function g(N,W){var Q=[],te=N.length,ce=0,de=0,ve,Te=te<=0,Ee=!1;N.charCodeAt(te-1)===cf&&--te,N.charCodeAt(te-1)===m0&&--te;function Me(){if(Te)return f0;if(Ee)return Ee=!1,bT;var qe,Ve=ce,nt;if(N.charCodeAt(Ve)===p0){for(;ce++<te&&N.charCodeAt(ce)!==p0||N.charCodeAt(++ce)===p0;);return(qe=ce)>=te?Te=!0:(nt=N.charCodeAt(ce++))===cf?Ee=!0:nt===m0&&(Ee=!0,N.charCodeAt(ce)===cf&&++ce),N.slice(Ve+1,qe-1).replace(/""/g,'"')}for(;ce<te;){if((nt=N.charCodeAt(qe=ce++))===cf)Ee=!0;else if(nt===m0)Ee=!0,N.charCodeAt(ce)===cf&&++ce;else if(nt!==u)continue;return N.slice(Ve,qe)}return Te=!0,N.slice(Ve,te)}for(;(ve=Me())!==f0;){for(var Ie=[];ve!==bT&&ve!==f0;)Ie.push(ve),ve=Me();W&&(Ie=W(Ie,de++))==null||Q.push(Ie)}return Q}function b(N,W){return N.map(function(Q){return W.map(function(te){return F(Q[te])}).join(l)})}function M(N,W){return W==null&&(W=wT(N)),[W.map(F).join(l)].concat(b(N,W)).join(`
`)}function A(N,W){return W==null&&(W=wT(N)),b(N,W).join(`
`)}function r(N){return N.map(k).join(`
`)}function k(N){return N.map(F).join(l)}function F(N){return N==null?"":N instanceof Date?Kz(N):o.test(N+="")?'"'+N.replace(/"/g,'""')+'"':N}return{parse:m,parseRows:g,format:M,formatBody:A,formatRows:r,formatRow:k,formatValue:F}}var eL=Jz(","),tL=eL.parse;function iL(l){if(!l.ok)throw new Error(l.status+" "+l.statusText);return l.text()}function nL(l,o){return fetch(l,o).then(iL)}function rL(l){return function(o,u,m){return arguments.length===2&&typeof u=="function"&&(m=u,u=void 0),nL(o,u).then(function(g){return l(g,m)})}}var sL=rL(tL),_0=new Date,g0=new Date;function fa(l,o,u,m){function g(b){return l(b=arguments.length===0?new Date:new Date(+b)),b}return g.floor=function(b){return l(b=new Date(+b)),b},g.ceil=function(b){return l(b=new Date(b-1)),o(b,1),l(b),b},g.round=function(b){var M=g(b),A=g.ceil(b);return b-M<A-b?M:A},g.offset=function(b,M){return o(b=new Date(+b),M==null?1:Math.floor(M)),b},g.range=function(b,M,A){var r=[],k;if(b=g.ceil(b),A=A==null?1:Math.floor(A),!(b<M)||!(A>0))return r;do r.push(k=new Date(+b)),o(b,A),l(b);while(k<b&&b<M);return r},g.filter=function(b){return fa(function(M){if(M>=M)for(;l(M),!b(M);)M.setTime(M-1)},function(M,A){if(M>=M)if(A<0)for(;++A<=0;)for(;o(M,-1),!b(M););else for(;--A>=0;)for(;o(M,1),!b(M););})},u&&(g.count=function(b,M){return _0.setTime(+b),g0.setTime(+M),l(_0),l(g0),Math.floor(u(_0,g0))},g.every=function(b){return b=Math.floor(b),!isFinite(b)||!(b>0)?null:b>1?g.filter(m?function(M){return m(M)%b===0}:function(M){return g.count(0,M)%b===0}):g}),g}const oL=1e3,px=oL*60,aL=px*60,mx=aL*24,dS=mx*7;var _x=fa(l=>l.setHours(0,0,0,0),(l,o)=>l.setDate(l.getDate()+o),(l,o)=>(o-l-(o.getTimezoneOffset()-l.getTimezoneOffset())*px)/mx,l=>l.getDate()-1);_x.range;function Pc(l){return fa(function(o){o.setDate(o.getDate()-(o.getDay()+7-l)%7),o.setHours(0,0,0,0)},function(o,u){o.setDate(o.getDate()+u*7)},function(o,u){return(u-o-(u.getTimezoneOffset()-o.getTimezoneOffset())*px)/dS})}var fS=Pc(0),U_=Pc(1),lL=Pc(2),cL=Pc(3),ph=Pc(4),uL=Pc(5),hL=Pc(6);fS.range;U_.range;lL.range;cL.range;ph.range;uL.range;hL.range;var Ac=fa(function(l){l.setMonth(0,1),l.setHours(0,0,0,0)},function(l,o){l.setFullYear(l.getFullYear()+o)},function(l,o){return o.getFullYear()-l.getFullYear()},function(l){return l.getFullYear()});Ac.every=function(l){return!isFinite(l=Math.floor(l))||!(l>0)?null:fa(function(o){o.setFullYear(Math.floor(o.getFullYear()/l)*l),o.setMonth(0,1),o.setHours(0,0,0,0)},function(o,u){o.setFullYear(o.getFullYear()+u*l)})};Ac.range;var gx=fa(function(l){l.setUTCHours(0,0,0,0)},function(l,o){l.setUTCDate(l.getUTCDate()+o)},function(l,o){return(o-l)/mx},function(l){return l.getUTCDate()-1});gx.range;function Dc(l){return fa(function(o){o.setUTCDate(o.getUTCDate()-(o.getUTCDay()+7-l)%7),o.setUTCHours(0,0,0,0)},function(o,u){o.setUTCDate(o.getUTCDate()+u*7)},function(o,u){return(u-o)/dS})}var pS=Dc(0),j_=Dc(1),dL=Dc(2),fL=Dc(3),mh=Dc(4),pL=Dc(5),mL=Dc(6);pS.range;j_.range;dL.range;fL.range;mh.range;pL.range;mL.range;var Ic=fa(function(l){l.setUTCMonth(0,1),l.setUTCHours(0,0,0,0)},function(l,o){l.setUTCFullYear(l.getUTCFullYear()+o)},function(l,o){return o.getUTCFullYear()-l.getUTCFullYear()},function(l){return l.getUTCFullYear()});Ic.every=function(l){return!isFinite(l=Math.floor(l))||!(l>0)?null:fa(function(o){o.setUTCFullYear(Math.floor(o.getUTCFullYear()/l)*l),o.setUTCMonth(0,1),o.setUTCHours(0,0,0,0)},function(o,u){o.setUTCFullYear(o.getUTCFullYear()+u*l)})};Ic.range;class _L{constructor(){this._partials=new Float64Array(32),this._n=0}add(o){const u=this._partials;let m=0;for(let g=0;g<this._n&&g<32;g++){const b=u[g],M=o+b,A=Math.abs(o)<Math.abs(b)?o-(M-b):b-(M-o);A&&(u[m++]=A),o=M}return u[m]=o,this._n=m+1,this}valueOf(){const o=this._partials;let u=this._n,m,g,b,M=0;if(u>0){for(M=o[--u];u>0&&(m=M,g=o[--u],M=m+g,b=g-(M-m),!b););u>0&&(b<0&&o[u-1]<0||b>0&&o[u-1]>0)&&(g=b*2,m=M+g,g==m-M&&(M=m))}return M}}function*gL(l){for(const o of l)yield*o}function mS(l){return Array.from(gL(l))}function y0(l){if(0<=l.y&&l.y<100){var o=new Date(-1,l.m,l.d,l.H,l.M,l.S,l.L);return o.setFullYear(l.y),o}return new Date(l.y,l.m,l.d,l.H,l.M,l.S,l.L)}function x0(l){if(0<=l.y&&l.y<100){var o=new Date(Date.UTC(-1,l.m,l.d,l.H,l.M,l.S,l.L));return o.setUTCFullYear(l.y),o}return new Date(Date.UTC(l.y,l.m,l.d,l.H,l.M,l.S,l.L))}function uf(l,o,u){return{y:l,m:o,d:u,H:0,M:0,S:0,L:0}}function yL(l){var o=l.dateTime,u=l.date,m=l.time,g=l.periods,b=l.days,M=l.shortDays,A=l.months,r=l.shortMonths,k=hf(g),F=df(g),N=hf(b),W=df(b),Q=hf(M),te=df(M),ce=hf(A),de=df(A),ve=hf(r),Te=df(r),Ee={a:di,A:Bt,b:fi,B:Cn,c:null,d:IT,e:IT,f:UL,g:XL,G:JL,H:BL,I:NL,j:VL,L:_S,m:jL,M:GL,p:_n,q:Kt,Q:DT,s:kT,S:WL,u:qL,U:HL,V:ZL,w:$L,W:YL,x:null,X:null,y:QL,Y:KL,Z:e3,"%":PT},Me={a:gn,A:ji,b:On,B:Zn,c:null,d:CT,e:CT,f:r3,g:p3,G:_3,H:t3,I:i3,j:n3,L:yS,m:s3,M:o3,p:pr,q:Vt,Q:DT,s:kT,S:a3,u:l3,U:c3,V:u3,w:h3,W:d3,x:null,X:null,y:f3,Y:m3,Z:g3,"%":PT},Ie={a:ht,A:st,b:Ot,B:oi,c:ii,d:ET,e:ET,f:zL,g:ST,G:MT,H:AT,I:AT,j:PL,L:RL,m:CL,M:DL,p:lt,q:IL,Q:OL,s:FL,S:kL,u:TL,U:ML,V:SL,w:wL,W:EL,x:Xe,X:wt,y:ST,Y:MT,Z:AL,"%":LL};Ee.x=qe(u,Ee),Ee.X=qe(m,Ee),Ee.c=qe(o,Ee),Me.x=qe(u,Me),Me.X=qe(m,Me),Me.c=qe(o,Me);function qe(Wt,Ht){return function(Ui){var Tt=[],Fn=-1,Zi=0,ir=Wt.length,$n,un,Do;for(Ui instanceof Date||(Ui=new Date(+Ui));++Fn<ir;)Wt.charCodeAt(Fn)===37&&(Tt.push(Wt.slice(Zi,Fn)),(un=TT[$n=Wt.charAt(++Fn)])!=null?$n=Wt.charAt(++Fn):un=$n==="e"?" ":"0",(Do=Ht[$n])&&($n=Do(Ui,un)),Tt.push($n),Zi=Fn+1);return Tt.push(Wt.slice(Zi,Fn)),Tt.join("")}}function Ve(Wt,Ht){return function(Ui){var Tt=uf(1900,void 0,1),Fn=nt(Tt,Wt,Ui+="",0),Zi,ir;if(Fn!=Ui.length)return null;if("Q"in Tt)return new Date(Tt.Q);if("s"in Tt)return new Date(Tt.s*1e3+("L"in Tt?Tt.L:0));if(Ht&&!("Z"in Tt)&&(Tt.Z=0),"p"in Tt&&(Tt.H=Tt.H%12+Tt.p*12),Tt.m===void 0&&(Tt.m="q"in Tt?Tt.q:0),"V"in Tt){if(Tt.V<1||Tt.V>53)return null;"w"in Tt||(Tt.w=1),"Z"in Tt?(Zi=x0(uf(Tt.y,0,1)),ir=Zi.getUTCDay(),Zi=ir>4||ir===0?j_.ceil(Zi):j_(Zi),Zi=gx.offset(Zi,(Tt.V-1)*7),Tt.y=Zi.getUTCFullYear(),Tt.m=Zi.getUTCMonth(),Tt.d=Zi.getUTCDate()+(Tt.w+6)%7):(Zi=y0(uf(Tt.y,0,1)),ir=Zi.getDay(),Zi=ir>4||ir===0?U_.ceil(Zi):U_(Zi),Zi=_x.offset(Zi,(Tt.V-1)*7),Tt.y=Zi.getFullYear(),Tt.m=Zi.getMonth(),Tt.d=Zi.getDate()+(Tt.w+6)%7)}else("W"in Tt||"U"in Tt)&&("w"in Tt||(Tt.w="u"in Tt?Tt.u%7:"W"in Tt?1:0),ir="Z"in Tt?x0(uf(Tt.y,0,1)).getUTCDay():y0(uf(Tt.y,0,1)).getDay(),Tt.m=0,Tt.d="W"in Tt?(Tt.w+6)%7+Tt.W*7-(ir+5)%7:Tt.w+Tt.U*7-(ir+6)%7);return"Z"in Tt?(Tt.H+=Tt.Z/100|0,Tt.M+=Tt.Z%100,x0(Tt)):y0(Tt)}}function nt(Wt,Ht,Ui,Tt){for(var Fn=0,Zi=Ht.length,ir=Ui.length,$n,un;Fn<Zi;){if(Tt>=ir)return-1;if($n=Ht.charCodeAt(Fn++),$n===37){if($n=Ht.charAt(Fn++),un=Ie[$n in TT?Ht.charAt(Fn++):$n],!un||(Tt=un(Wt,Ui,Tt))<0)return-1}else if($n!=Ui.charCodeAt(Tt++))return-1}return Tt}function lt(Wt,Ht,Ui){var Tt=k.exec(Ht.slice(Ui));return Tt?(Wt.p=F.get(Tt[0].toLowerCase()),Ui+Tt[0].length):-1}function ht(Wt,Ht,Ui){var Tt=Q.exec(Ht.slice(Ui));return Tt?(Wt.w=te.get(Tt[0].toLowerCase()),Ui+Tt[0].length):-1}function st(Wt,Ht,Ui){var Tt=N.exec(Ht.slice(Ui));return Tt?(Wt.w=W.get(Tt[0].toLowerCase()),Ui+Tt[0].length):-1}function Ot(Wt,Ht,Ui){var Tt=ve.exec(Ht.slice(Ui));return Tt?(Wt.m=Te.get(Tt[0].toLowerCase()),Ui+Tt[0].length):-1}function oi(Wt,Ht,Ui){var Tt=ce.exec(Ht.slice(Ui));return Tt?(Wt.m=de.get(Tt[0].toLowerCase()),Ui+Tt[0].length):-1}function ii(Wt,Ht,Ui){return nt(Wt,o,Ht,Ui)}function Xe(Wt,Ht,Ui){return nt(Wt,u,Ht,Ui)}function wt(Wt,Ht,Ui){return nt(Wt,m,Ht,Ui)}function di(Wt){return M[Wt.getDay()]}function Bt(Wt){return b[Wt.getDay()]}function fi(Wt){return r[Wt.getMonth()]}function Cn(Wt){return A[Wt.getMonth()]}function _n(Wt){return g[+(Wt.getHours()>=12)]}function Kt(Wt){return 1+~~(Wt.getMonth()/3)}function gn(Wt){return M[Wt.getUTCDay()]}function ji(Wt){return b[Wt.getUTCDay()]}function On(Wt){return r[Wt.getUTCMonth()]}function Zn(Wt){return A[Wt.getUTCMonth()]}function pr(Wt){return g[+(Wt.getUTCHours()>=12)]}function Vt(Wt){return 1+~~(Wt.getUTCMonth()/3)}return{format:function(Wt){var Ht=qe(Wt+="",Ee);return Ht.toString=function(){return Wt},Ht},parse:function(Wt){var Ht=Ve(Wt+="",!1);return Ht.toString=function(){return Wt},Ht},utcFormat:function(Wt){var Ht=qe(Wt+="",Me);return Ht.toString=function(){return Wt},Ht},utcParse:function(Wt){var Ht=Ve(Wt+="",!0);return Ht.toString=function(){return Wt},Ht}}}var TT={"-":"",_:" ",0:"0"},Ir=/^\s*\d+/,xL=/^%/,vL=/[\\^$*+?|[\]().{}]/g;function dn(l,o,u){var m=l<0?"-":"",g=(m?-l:l)+"",b=g.length;return m+(b<u?new Array(u-b+1).join(o)+g:g)}function bL(l){return l.replace(vL,"\\$&")}function hf(l){return new RegExp("^(?:"+l.map(bL).join("|")+")","i")}function df(l){return new Map(l.map((o,u)=>[o.toLowerCase(),u]))}function wL(l,o,u){var m=Ir.exec(o.slice(u,u+1));return m?(l.w=+m[0],u+m[0].length):-1}function TL(l,o,u){var m=Ir.exec(o.slice(u,u+1));return m?(l.u=+m[0],u+m[0].length):-1}function ML(l,o,u){var m=Ir.exec(o.slice(u,u+2));return m?(l.U=+m[0],u+m[0].length):-1}function SL(l,o,u){var m=Ir.exec(o.slice(u,u+2));return m?(l.V=+m[0],u+m[0].length):-1}function EL(l,o,u){var m=Ir.exec(o.slice(u,u+2));return m?(l.W=+m[0],u+m[0].length):-1}function MT(l,o,u){var m=Ir.exec(o.slice(u,u+4));return m?(l.y=+m[0],u+m[0].length):-1}function ST(l,o,u){var m=Ir.exec(o.slice(u,u+2));return m?(l.y=+m[0]+(+m[0]>68?1900:2e3),u+m[0].length):-1}function AL(l,o,u){var m=/^(Z)|([+-]\d\d)(?::?(\d\d))?/.exec(o.slice(u,u+6));return m?(l.Z=m[1]?0:-(m[2]+(m[3]||"00")),u+m[0].length):-1}function IL(l,o,u){var m=Ir.exec(o.slice(u,u+1));return m?(l.q=m[0]*3-3,u+m[0].length):-1}function CL(l,o,u){var m=Ir.exec(o.slice(u,u+2));return m?(l.m=m[0]-1,u+m[0].length):-1}function ET(l,o,u){var m=Ir.exec(o.slice(u,u+2));return m?(l.d=+m[0],u+m[0].length):-1}function PL(l,o,u){var m=Ir.exec(o.slice(u,u+3));return m?(l.m=0,l.d=+m[0],u+m[0].length):-1}function AT(l,o,u){var m=Ir.exec(o.slice(u,u+2));return m?(l.H=+m[0],u+m[0].length):-1}function DL(l,o,u){var m=Ir.exec(o.slice(u,u+2));return m?(l.M=+m[0],u+m[0].length):-1}function kL(l,o,u){var m=Ir.exec(o.slice(u,u+2));return m?(l.S=+m[0],u+m[0].length):-1}function RL(l,o,u){var m=Ir.exec(o.slice(u,u+3));return m?(l.L=+m[0],u+m[0].length):-1}function zL(l,o,u){var m=Ir.exec(o.slice(u,u+6));return m?(l.L=Math.floor(m[0]/1e3),u+m[0].length):-1}function LL(l,o,u){var m=xL.exec(o.slice(u,u+1));return m?u+m[0].length:-1}function OL(l,o,u){var m=Ir.exec(o.slice(u));return m?(l.Q=+m[0],u+m[0].length):-1}function FL(l,o,u){var m=Ir.exec(o.slice(u));return m?(l.s=+m[0],u+m[0].length):-1}function IT(l,o){return dn(l.getDate(),o,2)}function BL(l,o){return dn(l.getHours(),o,2)}function NL(l,o){return dn(l.getHours()%12||12,o,2)}function VL(l,o){return dn(1+_x.count(Ac(l),l),o,3)}function _S(l,o){return dn(l.getMilliseconds(),o,3)}function UL(l,o){return _S(l,o)+"000"}function jL(l,o){return dn(l.getMonth()+1,o,2)}function GL(l,o){return dn(l.getMinutes(),o,2)}function WL(l,o){return dn(l.getSeconds(),o,2)}function qL(l){var o=l.getDay();return o===0?7:o}function HL(l,o){return dn(fS.count(Ac(l)-1,l),o,2)}function gS(l){var o=l.getDay();return o>=4||o===0?ph(l):ph.ceil(l)}function ZL(l,o){return l=gS(l),dn(ph.count(Ac(l),l)+(Ac(l).getDay()===4),o,2)}function $L(l){return l.getDay()}function YL(l,o){return dn(U_.count(Ac(l)-1,l),o,2)}function QL(l,o){return dn(l.getFullYear()%100,o,2)}function XL(l,o){return l=gS(l),dn(l.getFullYear()%100,o,2)}function KL(l,o){return dn(l.getFullYear()%1e4,o,4)}function JL(l,o){var u=l.getDay();return l=u>=4||u===0?ph(l):ph.ceil(l),dn(l.getFullYear()%1e4,o,4)}function e3(l){var o=l.getTimezoneOffset();return(o>0?"-":(o*=-1,"+"))+dn(o/60|0,"0",2)+dn(o%60,"0",2)}function CT(l,o){return dn(l.getUTCDate(),o,2)}function t3(l,o){return dn(l.getUTCHours(),o,2)}function i3(l,o){return dn(l.getUTCHours()%12||12,o,2)}function n3(l,o){return dn(1+gx.count(Ic(l),l),o,3)}function yS(l,o){return dn(l.getUTCMilliseconds(),o,3)}function r3(l,o){return yS(l,o)+"000"}function s3(l,o){return dn(l.getUTCMonth()+1,o,2)}function o3(l,o){return dn(l.getUTCMinutes(),o,2)}function a3(l,o){return dn(l.getUTCSeconds(),o,2)}function l3(l){var o=l.getUTCDay();return o===0?7:o}function c3(l,o){return dn(pS.count(Ic(l)-1,l),o,2)}function xS(l){var o=l.getUTCDay();return o>=4||o===0?mh(l):mh.ceil(l)}function u3(l,o){return l=xS(l),dn(mh.count(Ic(l),l)+(Ic(l).getUTCDay()===4),o,2)}function h3(l){return l.getUTCDay()}function d3(l,o){return dn(j_.count(Ic(l)-1,l),o,2)}function f3(l,o){return dn(l.getUTCFullYear()%100,o,2)}function p3(l,o){return l=xS(l),dn(l.getUTCFullYear()%100,o,2)}function m3(l,o){return dn(l.getUTCFullYear()%1e4,o,4)}function _3(l,o){var u=l.getUTCDay();return l=u>=4||u===0?mh(l):mh.ceil(l),dn(l.getUTCFullYear()%1e4,o,4)}function g3(){return"+0000"}function PT(){return"%"}function DT(l){return+l}function kT(l){return Math.floor(+l/1e3)}var rh,vS,bS;y3({dateTime:"%x, %X",date:"%-m/%-d/%Y",time:"%-I:%M:%S %p",periods:["AM","PM"],days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]});function y3(l){return rh=yL(l),vS=rh.format,bS=rh.parse,rh.utcFormat,rh.utcParse,rh}function x3(l){let o;return{c(){o=on("canvas"),$1(o,"width","100%"),$1(o,"height","200px"),Sn(o,"class","svelte-1q75ftw")},m(u,m){Po(u,o,m),l[6](o)},p:Cs,i:Cs,o:Cs,d(u){u&&hs(o),l[6](null)}}}function v3(l,o,u){la.register(...Yz);let{dataUrls:m=[]}=o,{graphType:g}=o,{startDate:b}=o,{endDate:M}=o,{graphLabel:A}=o,r,k;const F=bS("%Y-%m-%d");vS("%Y-%m-%d"),Q0(()=>(sL(m[0]).then(W=>{const Q=W.filter(Me=>{const Ie=F(Me.date);return Ie>=F(b)&&Ie<=F(M)}),te=Q.map(Me=>Me.date),ce=Q.map(Me=>Me.cases),de=Q.map(Me=>Me.cases_diff),ve=Q.map(Me=>Me.deaths);let Te=[],Ee=A||"";g==="accumulated"?(Te=ce,Ee=A||"Accumulated Cases"):g==="cases"?(Te=de,Ee=A||"Monthly Cases Increasement"):g==="accumulatedDeaths"&&(Te=ve,Ee=A||"Accumulated Deaths"),k=new la(r,{type:"line",data:{labels:te,datasets:[{label:Ee,data:Te,borderColor:g==="accumulated"?"rgba(75, 192, 192, 1)":g==="cases"?"rgba(192, 75, 75, 1)":"rgba(75, 75, 192, 1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,animation:{duration:2e3,easing:"easeInOutQuad"},plugins:{legend:{labels:{boxHeight:8,font:{size:10},padding:8}}}}})}),()=>{k&&k.destroy()}));function N(W){ls[W?"unshift":"push"](()=>{r=W,u(0,r)})}return l.$$set=W=>{"dataUrls"in W&&u(1,m=W.dataUrls),"graphType"in W&&u(2,g=W.graphType),"startDate"in W&&u(3,b=W.startDate),"endDate"in W&&u(4,M=W.endDate),"graphLabel"in W&&u(5,A=W.graphLabel)},[r,m,g,b,M,A,N]}class v0 extends X_{constructor(o){super(),Q_(this,o,v3,x3,Y_,{dataUrls:1,graphType:2,startDate:3,endDate:4,graphLabel:5})}}var Ln=1e-6,b3=1e-12,an=Math.PI,us=an/2,RT=an/4,Gs=an*2,As=180/an,fr=an/180,tr=Math.abs,wS=Math.atan,Bf=Math.atan2,sr=Math.cos,w3=Math.exp,T3=Math.log,or=Math.sin,M3=Math.sign||function(l){return l>0?1:l<0?-1:0},ng=Math.sqrt,S3=Math.tan;function E3(l){return l>1?0:l<-1?an:Math.acos(l)}function Nf(l){return l>1?us:l<-1?-us:Math.asin(l)}function xf(){}function G_(l,o){l&&LT.hasOwnProperty(l.type)&&LT[l.type](l,o)}var zT={Feature:function(l,o){G_(l.geometry,o)},FeatureCollection:function(l,o){for(var u=l.features,m=-1,g=u.length;++m<g;)G_(u[m].geometry,o)}},LT={Sphere:function(l,o){o.sphere()},Point:function(l,o){l=l.coordinates,o.point(l[0],l[1],l[2])},MultiPoint:function(l,o){for(var u=l.coordinates,m=-1,g=u.length;++m<g;)l=u[m],o.point(l[0],l[1],l[2])},LineString:function(l,o){j0(l.coordinates,o,0)},MultiLineString:function(l,o){for(var u=l.coordinates,m=-1,g=u.length;++m<g;)j0(u[m],o,0)},Polygon:function(l,o){OT(l.coordinates,o)},MultiPolygon:function(l,o){for(var u=l.coordinates,m=-1,g=u.length;++m<g;)OT(u[m],o)},GeometryCollection:function(l,o){for(var u=l.geometries,m=-1,g=u.length;++m<g;)G_(u[m],o)}};function j0(l,o,u){var m=-1,g=l.length-u,b;for(o.lineStart();++m<g;)b=l[m],o.point(b[0],b[1],b[2]);o.lineEnd()}function OT(l,o){var u=-1,m=l.length;for(o.polygonStart();++u<m;)j0(l[u],o,1);o.polygonEnd()}function A3(l,o){l&&zT.hasOwnProperty(l.type)?zT[l.type](l,o):G_(l,o)}function G0(l){return[Bf(l[1],l[0]),Nf(l[2])]}function _h(l){var o=l[0],u=l[1],m=sr(u);return[m*sr(o),m*or(o),or(u)]}function p_(l,o){return l[0]*o[0]+l[1]*o[1]+l[2]*o[2]}function W_(l,o){return[l[1]*o[2]-l[2]*o[1],l[2]*o[0]-l[0]*o[2],l[0]*o[1]-l[1]*o[0]]}function b0(l,o){l[0]+=o[0],l[1]+=o[1],l[2]+=o[2]}function m_(l,o){return[l[0]*o,l[1]*o,l[2]*o]}function W0(l){var o=ng(l[0]*l[0]+l[1]*l[1]+l[2]*l[2]);l[0]/=o,l[1]/=o,l[2]/=o}function q0(l,o){function u(m,g){return m=l(m,g),o(m[0],m[1])}return l.invert&&o.invert&&(u.invert=function(m,g){return m=o.invert(m,g),m&&l.invert(m[0],m[1])}),u}function H0(l,o){return tr(l)>an&&(l-=Math.round(l/Gs)*Gs),[l,o]}H0.invert=H0;function TS(l,o,u){return(l%=Gs)?o||u?q0(BT(l),NT(o,u)):BT(l):o||u?NT(o,u):H0}function FT(l){return function(o,u){return o+=l,tr(o)>an&&(o-=Math.round(o/Gs)*Gs),[o,u]}}function BT(l){var o=FT(l);return o.invert=FT(-l),o}function NT(l,o){var u=sr(l),m=or(l),g=sr(o),b=or(o);function M(A,r){var k=sr(r),F=sr(A)*k,N=or(A)*k,W=or(r),Q=W*u+F*m;return[Bf(N*g-Q*b,F*u-W*m),Nf(Q*g+N*b)]}return M.invert=function(A,r){var k=sr(r),F=sr(A)*k,N=or(A)*k,W=or(r),Q=W*g-N*b;return[Bf(N*g+W*b,F*u+Q*m),Nf(Q*u-F*m)]},M}function I3(l){l=TS(l[0]*fr,l[1]*fr,l.length>2?l[2]*fr:0);function o(u){return u=l(u[0]*fr,u[1]*fr),u[0]*=As,u[1]*=As,u}return o.invert=function(u){return u=l.invert(u[0]*fr,u[1]*fr),u[0]*=As,u[1]*=As,u},o}function C3(l,o,u,m,g,b){if(u){var M=sr(o),A=or(o),r=m*u;g==null?(g=o+m*Gs,b=o-r/2):(g=VT(M,g),b=VT(M,b),(m>0?g<b:g>b)&&(g+=m*Gs));for(var k,F=g;m>0?F>b:F<b;F-=r)k=G0([M,-A*sr(F),-A*or(F)]),l.point(k[0],k[1])}}function VT(l,o){o=_h(o),o[0]-=l,W0(o);var u=E3(-o[1]);return((-o[2]<0?-u:u)+Gs-Ln)%Gs}function MS(){var l=[],o;return{point:function(u,m,g){o.push([u,m,g])},lineStart:function(){l.push(o=[])},lineEnd:xf,rejoin:function(){l.length>1&&l.push(l.pop().concat(l.shift()))},result:function(){var u=l;return l=[],o=null,u}}}function I_(l,o){return tr(l[0]-o[0])<Ln&&tr(l[1]-o[1])<Ln}function __(l,o,u,m){this.x=l,this.z=o,this.o=u,this.e=m,this.v=!1,this.n=this.p=null}function SS(l,o,u,m,g){var b=[],M=[],A,r;if(l.forEach(function(te){if(!((ce=te.length-1)<=0)){var ce,de=te[0],ve=te[ce],Te;if(I_(de,ve)){if(!de[2]&&!ve[2]){for(g.lineStart(),A=0;A<ce;++A)g.point((de=te[A])[0],de[1]);g.lineEnd();return}ve[0]+=2*Ln}b.push(Te=new __(de,te,null,!0)),M.push(Te.o=new __(de,null,Te,!1)),b.push(Te=new __(ve,te,null,!1)),M.push(Te.o=new __(ve,null,Te,!0))}}),!!b.length){for(M.sort(o),UT(b),UT(M),A=0,r=M.length;A<r;++A)M[A].e=u=!u;for(var k=b[0],F,N;;){for(var W=k,Q=!0;W.v;)if((W=W.n)===k)return;F=W.z,g.lineStart();do{if(W.v=W.o.v=!0,W.e){if(Q)for(A=0,r=F.length;A<r;++A)g.point((N=F[A])[0],N[1]);else m(W.x,W.n.x,1,g);W=W.n}else{if(Q)for(F=W.p.z,A=F.length-1;A>=0;--A)g.point((N=F[A])[0],N[1]);else m(W.x,W.p.x,-1,g);W=W.p}W=W.o,F=W.z,Q=!Q}while(!W.v);g.lineEnd()}}}function UT(l){if(o=l.length){for(var o,u=0,m=l[0],g;++u<o;)m.n=g=l[u],g.p=m,m=g;m.n=g=l[0],g.p=m}}function w0(l){return tr(l[0])<=an?l[0]:M3(l[0])*((tr(l[0])+an)%Gs-an)}function P3(l,o){var u=w0(o),m=o[1],g=or(m),b=[or(u),-sr(u),0],M=0,A=0,r=new _L;g===1?m=us+Ln:g===-1&&(m=-us-Ln);for(var k=0,F=l.length;k<F;++k)if(W=(N=l[k]).length)for(var N,W,Q=N[W-1],te=w0(Q),ce=Q[1]/2+RT,de=or(ce),ve=sr(ce),Te=0;Te<W;++Te,te=Me,de=qe,ve=Ve,Q=Ee){var Ee=N[Te],Me=w0(Ee),Ie=Ee[1]/2+RT,qe=or(Ie),Ve=sr(Ie),nt=Me-te,lt=nt>=0?1:-1,ht=lt*nt,st=ht>an,Ot=de*qe;if(r.add(Bf(Ot*lt*or(ht),ve*Ve+Ot*sr(ht))),M+=st?nt+lt*Gs:nt,st^te>=u^Me>=u){var oi=W_(_h(Q),_h(Ee));W0(oi);var ii=W_(b,oi);W0(ii);var Xe=(st^nt>=0?-1:1)*Nf(ii[2]);(m>Xe||m===Xe&&(oi[0]||oi[1]))&&(A+=st^nt>=0?1:-1)}}return(M<-Ln||M<Ln&&r<-b3)^A&1}function ES(l,o,u,m){return function(g){var b=o(g),M=MS(),A=o(M),r=!1,k,F,N,W={point:Q,lineStart:ce,lineEnd:de,polygonStart:function(){W.point=ve,W.lineStart=Te,W.lineEnd=Ee,F=[],k=[]},polygonEnd:function(){W.point=Q,W.lineStart=ce,W.lineEnd=de,F=mS(F);var Me=P3(k,m);F.length?(r||(g.polygonStart(),r=!0),SS(F,k3,Me,u,g)):Me&&(r||(g.polygonStart(),r=!0),g.lineStart(),u(null,null,1,g),g.lineEnd()),r&&(g.polygonEnd(),r=!1),F=k=null},sphere:function(){g.polygonStart(),g.lineStart(),u(null,null,1,g),g.lineEnd(),g.polygonEnd()}};function Q(Me,Ie){l(Me,Ie)&&g.point(Me,Ie)}function te(Me,Ie){b.point(Me,Ie)}function ce(){W.point=te,b.lineStart()}function de(){W.point=Q,b.lineEnd()}function ve(Me,Ie){N.push([Me,Ie]),A.point(Me,Ie)}function Te(){A.lineStart(),N=[]}function Ee(){ve(N[0][0],N[0][1]),A.lineEnd();var Me=A.clean(),Ie=M.result(),qe,Ve=Ie.length,nt,lt,ht;if(N.pop(),k.push(N),N=null,!!Ve){if(Me&1){if(lt=Ie[0],(nt=lt.length-1)>0){for(r||(g.polygonStart(),r=!0),g.lineStart(),qe=0;qe<nt;++qe)g.point((ht=lt[qe])[0],ht[1]);g.lineEnd()}return}Ve>1&&Me&2&&Ie.push(Ie.pop().concat(Ie.shift())),F.push(Ie.filter(D3))}}return W}}function D3(l){return l.length>1}function k3(l,o){return((l=l.x)[0]<0?l[1]-us-Ln:us-l[1])-((o=o.x)[0]<0?o[1]-us-Ln:us-o[1])}const jT=ES(function(){return!0},R3,L3,[-an,-us]);function R3(l){var o=NaN,u=NaN,m=NaN,g;return{lineStart:function(){l.lineStart(),g=1},point:function(b,M){var A=b>0?an:-an,r=tr(b-o);tr(r-an)<Ln?(l.point(o,u=(u+M)/2>0?us:-us),l.point(m,u),l.lineEnd(),l.lineStart(),l.point(A,u),l.point(b,u),g=0):m!==A&&r>=an&&(tr(o-m)<Ln&&(o-=m*Ln),tr(b-A)<Ln&&(b-=A*Ln),u=z3(o,u,b,M),l.point(m,u),l.lineEnd(),l.lineStart(),l.point(A,u),g=0),l.point(o=b,u=M),m=A},lineEnd:function(){l.lineEnd(),o=u=NaN},clean:function(){return 2-g}}}function z3(l,o,u,m){var g,b,M=or(l-u);return tr(M)>Ln?wS((or(o)*(b=sr(m))*or(u)-or(m)*(g=sr(o))*or(l))/(g*b*M)):(o+m)/2}function L3(l,o,u,m){var g;if(l==null)g=u*us,m.point(-an,g),m.point(0,g),m.point(an,g),m.point(an,0),m.point(an,-g),m.point(0,-g),m.point(-an,-g),m.point(-an,0),m.point(-an,g);else if(tr(l[0]-o[0])>Ln){var b=l[0]<o[0]?an:-an;g=u*b/2,m.point(-b,g),m.point(0,g),m.point(b,g)}else m.point(o[0],o[1])}function O3(l){var o=sr(l),u=2*fr,m=o>0,g=tr(o)>Ln;function b(F,N,W,Q){C3(Q,l,u,W,F,N)}function M(F,N){return sr(F)*sr(N)>o}function A(F){var N,W,Q,te,ce;return{lineStart:function(){te=Q=!1,ce=1},point:function(de,ve){var Te=[de,ve],Ee,Me=M(de,ve),Ie=m?Me?0:k(de,ve):Me?k(de+(de<0?an:-an),ve):0;if(!N&&(te=Q=Me)&&F.lineStart(),Me!==Q&&(Ee=r(N,Te),(!Ee||I_(N,Ee)||I_(Te,Ee))&&(Te[2]=1)),Me!==Q)ce=0,Me?(F.lineStart(),Ee=r(Te,N),F.point(Ee[0],Ee[1])):(Ee=r(N,Te),F.point(Ee[0],Ee[1],2),F.lineEnd()),N=Ee;else if(g&&N&&m^Me){var qe;!(Ie&W)&&(qe=r(Te,N,!0))&&(ce=0,m?(F.lineStart(),F.point(qe[0][0],qe[0][1]),F.point(qe[1][0],qe[1][1]),F.lineEnd()):(F.point(qe[1][0],qe[1][1]),F.lineEnd(),F.lineStart(),F.point(qe[0][0],qe[0][1],3)))}Me&&(!N||!I_(N,Te))&&F.point(Te[0],Te[1]),N=Te,Q=Me,W=Ie},lineEnd:function(){Q&&F.lineEnd(),N=null},clean:function(){return ce|(te&&Q)<<1}}}function r(F,N,W){var Q=_h(F),te=_h(N),ce=[1,0,0],de=W_(Q,te),ve=p_(de,de),Te=de[0],Ee=ve-Te*Te;if(!Ee)return!W&&F;var Me=o*ve/Ee,Ie=-o*Te/Ee,qe=W_(ce,de),Ve=m_(ce,Me),nt=m_(de,Ie);b0(Ve,nt);var lt=qe,ht=p_(Ve,lt),st=p_(lt,lt),Ot=ht*ht-st*(p_(Ve,Ve)-1);if(!(Ot<0)){var oi=ng(Ot),ii=m_(lt,(-ht-oi)/st);if(b0(ii,Ve),ii=G0(ii),!W)return ii;var Xe=F[0],wt=N[0],di=F[1],Bt=N[1],fi;wt<Xe&&(fi=Xe,Xe=wt,wt=fi);var Cn=wt-Xe,_n=tr(Cn-an)<Ln,Kt=_n||Cn<Ln;if(!_n&&Bt<di&&(fi=di,di=Bt,Bt=fi),Kt?_n?di+Bt>0^ii[1]<(tr(ii[0]-Xe)<Ln?di:Bt):di<=ii[1]&&ii[1]<=Bt:Cn>an^(Xe<=ii[0]&&ii[0]<=wt)){var gn=m_(lt,(-ht+oi)/st);return b0(gn,Ve),[ii,G0(gn)]}}}function k(F,N){var W=m?l:an-l,Q=0;return F<-W?Q|=1:F>W&&(Q|=2),N<-W?Q|=4:N>W&&(Q|=8),Q}return ES(M,A,b,m?[0,-l]:[-an,l-an])}function F3(l,o,u,m,g,b){var M=l[0],A=l[1],r=o[0],k=o[1],F=0,N=1,W=r-M,Q=k-A,te;if(te=u-M,!(!W&&te>0)){if(te/=W,W<0){if(te<F)return;te<N&&(N=te)}else if(W>0){if(te>N)return;te>F&&(F=te)}if(te=g-M,!(!W&&te<0)){if(te/=W,W<0){if(te>N)return;te>F&&(F=te)}else if(W>0){if(te<F)return;te<N&&(N=te)}if(te=m-A,!(!Q&&te>0)){if(te/=Q,Q<0){if(te<F)return;te<N&&(N=te)}else if(Q>0){if(te>N)return;te>F&&(F=te)}if(te=b-A,!(!Q&&te<0)){if(te/=Q,Q<0){if(te>N)return;te>F&&(F=te)}else if(Q>0){if(te<F)return;te<N&&(N=te)}return F>0&&(l[0]=M+F*W,l[1]=A+F*Q),N<1&&(o[0]=M+N*W,o[1]=A+N*Q),!0}}}}}var vf=1e9,g_=-vf;function B3(l,o,u,m){function g(k,F){return l<=k&&k<=u&&o<=F&&F<=m}function b(k,F,N,W){var Q=0,te=0;if(k==null||(Q=M(k,N))!==(te=M(F,N))||r(k,F)<0^N>0)do W.point(Q===0||Q===3?l:u,Q>1?m:o);while((Q=(Q+N+4)%4)!==te);else W.point(F[0],F[1])}function M(k,F){return tr(k[0]-l)<Ln?F>0?0:3:tr(k[0]-u)<Ln?F>0?2:1:tr(k[1]-o)<Ln?F>0?1:0:F>0?3:2}function A(k,F){return r(k.x,F.x)}function r(k,F){var N=M(k,1),W=M(F,1);return N!==W?N-W:N===0?F[1]-k[1]:N===1?k[0]-F[0]:N===2?k[1]-F[1]:F[0]-k[0]}return function(k){var F=k,N=MS(),W,Q,te,ce,de,ve,Te,Ee,Me,Ie,qe,Ve={point:nt,lineStart:Ot,lineEnd:oi,polygonStart:ht,polygonEnd:st};function nt(Xe,wt){g(Xe,wt)&&F.point(Xe,wt)}function lt(){for(var Xe=0,wt=0,di=Q.length;wt<di;++wt)for(var Bt=Q[wt],fi=1,Cn=Bt.length,_n=Bt[0],Kt,gn,ji=_n[0],On=_n[1];fi<Cn;++fi)Kt=ji,gn=On,_n=Bt[fi],ji=_n[0],On=_n[1],gn<=m?On>m&&(ji-Kt)*(m-gn)>(On-gn)*(l-Kt)&&++Xe:On<=m&&(ji-Kt)*(m-gn)<(On-gn)*(l-Kt)&&--Xe;return Xe}function ht(){F=N,W=[],Q=[],qe=!0}function st(){var Xe=lt(),wt=qe&&Xe,di=(W=mS(W)).length;(wt||di)&&(k.polygonStart(),wt&&(k.lineStart(),b(null,null,1,k),k.lineEnd()),di&&SS(W,A,Xe,b,k),k.polygonEnd()),F=k,W=Q=te=null}function Ot(){Ve.point=ii,Q&&Q.push(te=[]),Ie=!0,Me=!1,Te=Ee=NaN}function oi(){W&&(ii(ce,de),ve&&Me&&N.rejoin(),W.push(N.result())),Ve.point=nt,Me&&F.lineEnd()}function ii(Xe,wt){var di=g(Xe,wt);if(Q&&te.push([Xe,wt]),Ie)ce=Xe,de=wt,ve=di,Ie=!1,di&&(F.lineStart(),F.point(Xe,wt));else if(di&&Me)F.point(Xe,wt);else{var Bt=[Te=Math.max(g_,Math.min(vf,Te)),Ee=Math.max(g_,Math.min(vf,Ee))],fi=[Xe=Math.max(g_,Math.min(vf,Xe)),wt=Math.max(g_,Math.min(vf,wt))];F3(Bt,fi,l,o,u,m)?(Me||(F.lineStart(),F.point(Bt[0],Bt[1])),F.point(fi[0],fi[1]),di||F.lineEnd(),qe=!1):di&&(F.lineStart(),F.point(Xe,wt),qe=!1)}Te=Xe,Ee=wt,Me=di}return Ve}}const GT=l=>l;var gh=1/0,q_=gh,Vf=-gh,H_=Vf,WT={point:N3,lineStart:xf,lineEnd:xf,polygonStart:xf,polygonEnd:xf,result:function(){var l=[[gh,q_],[Vf,H_]];return Vf=H_=-(q_=gh=1/0),l}};function N3(l,o){l<gh&&(gh=l),l>Vf&&(Vf=l),o<q_&&(q_=o),o>H_&&(H_=o)}function yx(l){return function(o){var u=new Z0;for(var m in l)u[m]=l[m];return u.stream=o,u}}function Z0(){}Z0.prototype={constructor:Z0,point:function(l,o){this.stream.point(l,o)},sphere:function(){this.stream.sphere()},lineStart:function(){this.stream.lineStart()},lineEnd:function(){this.stream.lineEnd()},polygonStart:function(){this.stream.polygonStart()},polygonEnd:function(){this.stream.polygonEnd()}};function xx(l,o,u){var m=l.clipExtent&&l.clipExtent();return l.scale(150).translate([0,0]),m!=null&&l.clipExtent(null),A3(u,l.stream(WT)),o(WT.result()),m!=null&&l.clipExtent(m),l}function AS(l,o,u){return xx(l,function(m){var g=o[1][0]-o[0][0],b=o[1][1]-o[0][1],M=Math.min(g/(m[1][0]-m[0][0]),b/(m[1][1]-m[0][1])),A=+o[0][0]+(g-M*(m[1][0]+m[0][0]))/2,r=+o[0][1]+(b-M*(m[1][1]+m[0][1]))/2;l.scale(150*M).translate([A,r])},u)}function V3(l,o,u){return AS(l,[[0,0],o],u)}function U3(l,o,u){return xx(l,function(m){var g=+o,b=g/(m[1][0]-m[0][0]),M=(g-b*(m[1][0]+m[0][0]))/2,A=-b*m[0][1];l.scale(150*b).translate([M,A])},u)}function j3(l,o,u){return xx(l,function(m){var g=+o,b=g/(m[1][1]-m[0][1]),M=-b*m[0][0],A=(g-b*(m[1][1]+m[0][1]))/2;l.scale(150*b).translate([M,A])},u)}var qT=16,G3=sr(30*fr);function HT(l,o){return+o?q3(l,o):W3(l)}function W3(l){return yx({point:function(o,u){o=l(o,u),this.stream.point(o[0],o[1])}})}function q3(l,o){function u(m,g,b,M,A,r,k,F,N,W,Q,te,ce,de){var ve=k-m,Te=F-g,Ee=ve*ve+Te*Te;if(Ee>4*o&&ce--){var Me=M+W,Ie=A+Q,qe=r+te,Ve=ng(Me*Me+Ie*Ie+qe*qe),nt=Nf(qe/=Ve),lt=tr(tr(qe)-1)<Ln||tr(b-N)<Ln?(b+N)/2:Bf(Ie,Me),ht=l(lt,nt),st=ht[0],Ot=ht[1],oi=st-m,ii=Ot-g,Xe=Te*oi-ve*ii;(Xe*Xe/Ee>o||tr((ve*oi+Te*ii)/Ee-.5)>.3||M*W+A*Q+r*te<G3)&&(u(m,g,b,M,A,r,st,Ot,lt,Me/=Ve,Ie/=Ve,qe,ce,de),de.point(st,Ot),u(st,Ot,lt,Me,Ie,qe,k,F,N,W,Q,te,ce,de))}}return function(m){var g,b,M,A,r,k,F,N,W,Q,te,ce,de={point:ve,lineStart:Te,lineEnd:Me,polygonStart:function(){m.polygonStart(),de.lineStart=Ie},polygonEnd:function(){m.polygonEnd(),de.lineStart=Te}};function ve(nt,lt){nt=l(nt,lt),m.point(nt[0],nt[1])}function Te(){N=NaN,de.point=Ee,m.lineStart()}function Ee(nt,lt){var ht=_h([nt,lt]),st=l(nt,lt);u(N,W,F,Q,te,ce,N=st[0],W=st[1],F=nt,Q=ht[0],te=ht[1],ce=ht[2],qT,m),m.point(N,W)}function Me(){de.point=ve,m.lineEnd()}function Ie(){Te(),de.point=qe,de.lineEnd=Ve}function qe(nt,lt){Ee(g=nt,lt),b=N,M=W,A=Q,r=te,k=ce,de.point=Ee}function Ve(){u(N,W,F,Q,te,ce,b,M,g,A,r,k,qT,m),de.lineEnd=Me,Me()}return de}}var H3=yx({point:function(l,o){this.stream.point(l*fr,o*fr)}});function Z3(l){return yx({point:function(o,u){var m=l(o,u);return this.stream.point(m[0],m[1])}})}function $3(l,o,u,m,g){function b(M,A){return M*=m,A*=g,[o+l*M,u-l*A]}return b.invert=function(M,A){return[(M-o)/l*m,(u-A)/l*g]},b}function ZT(l,o,u,m,g,b){if(!b)return $3(l,o,u,m,g);var M=sr(b),A=or(b),r=M*l,k=A*l,F=M/l,N=A/l,W=(A*u-M*o)/l,Q=(A*o+M*u)/l;function te(ce,de){return ce*=m,de*=g,[r*ce-k*de+o,u-k*ce-r*de]}return te.invert=function(ce,de){return[m*(F*ce-N*de+W),g*(Q-N*ce-F*de)]},te}function Y3(l){return Q3(function(){return l})()}function Q3(l){var o,u=150,m=480,g=250,b=0,M=0,A=0,r=0,k=0,F,N=0,W=1,Q=1,te=null,ce=jT,de=null,ve,Te,Ee,Me=GT,Ie=.5,qe,Ve,nt,lt,ht;function st(Xe){return nt(Xe[0]*fr,Xe[1]*fr)}function Ot(Xe){return Xe=nt.invert(Xe[0],Xe[1]),Xe&&[Xe[0]*As,Xe[1]*As]}st.stream=function(Xe){return lt&&ht===Xe?lt:lt=H3(Z3(F)(ce(qe(Me(ht=Xe)))))},st.preclip=function(Xe){return arguments.length?(ce=Xe,te=void 0,ii()):ce},st.postclip=function(Xe){return arguments.length?(Me=Xe,de=ve=Te=Ee=null,ii()):Me},st.clipAngle=function(Xe){return arguments.length?(ce=+Xe?O3(te=Xe*fr):(te=null,jT),ii()):te*As},st.clipExtent=function(Xe){return arguments.length?(Me=Xe==null?(de=ve=Te=Ee=null,GT):B3(de=+Xe[0][0],ve=+Xe[0][1],Te=+Xe[1][0],Ee=+Xe[1][1]),ii()):de==null?null:[[de,ve],[Te,Ee]]},st.scale=function(Xe){return arguments.length?(u=+Xe,oi()):u},st.translate=function(Xe){return arguments.length?(m=+Xe[0],g=+Xe[1],oi()):[m,g]},st.center=function(Xe){return arguments.length?(b=Xe[0]%360*fr,M=Xe[1]%360*fr,oi()):[b*As,M*As]},st.rotate=function(Xe){return arguments.length?(A=Xe[0]%360*fr,r=Xe[1]%360*fr,k=Xe.length>2?Xe[2]%360*fr:0,oi()):[A*As,r*As,k*As]},st.angle=function(Xe){return arguments.length?(N=Xe%360*fr,oi()):N*As},st.reflectX=function(Xe){return arguments.length?(W=Xe?-1:1,oi()):W<0},st.reflectY=function(Xe){return arguments.length?(Q=Xe?-1:1,oi()):Q<0},st.precision=function(Xe){return arguments.length?(qe=HT(Ve,Ie=Xe*Xe),ii()):ng(Ie)},st.fitExtent=function(Xe,wt){return AS(st,Xe,wt)},st.fitSize=function(Xe,wt){return V3(st,Xe,wt)},st.fitWidth=function(Xe,wt){return U3(st,Xe,wt)},st.fitHeight=function(Xe,wt){return j3(st,Xe,wt)};function oi(){var Xe=ZT(u,0,0,W,Q,N).apply(null,o(b,M)),wt=ZT(u,m-Xe[0],g-Xe[1],W,Q,N);return F=TS(A,r,k),Ve=q0(o,wt),nt=q0(F,Ve),qe=HT(Ve,Ie),ii()}function ii(){return lt=ht=null,st}return function(){return o=l.apply(this,arguments),st.invert=o.invert&&Ot,oi()}}function vx(l,o){return[l,T3(S3((us+o)/2))]}vx.invert=function(l,o){return[l,2*wS(w3(o))-us]};function X3(){return K3(vx).scale(961/Gs)}function K3(l){var o=Y3(l),u=o.center,m=o.scale,g=o.translate,b=o.clipExtent,M=null,A,r,k;o.scale=function(N){return arguments.length?(m(N),F()):m()},o.translate=function(N){return arguments.length?(g(N),F()):g()},o.center=function(N){return arguments.length?(u(N),F()):u()},o.clipExtent=function(N){return arguments.length?(N==null?M=A=r=k=null:(M=+N[0][0],A=+N[0][1],r=+N[1][0],k=+N[1][1]),F()):M==null?null:[[M,A],[r,k]]};function F(){var N=an*m(),W=o(I3(o.rotate()).invert([0,0]));return b(M==null?[[W[0]-N,W[1]-N],[W[0]+N,W[1]+N]]:l===vx?[[Math.max(W[0]-N,M),A],[Math.min(W[0]+N,r),k]]:[[M,Math.max(W[1]-N,A)],[r,Math.min(W[1]+N,k)]])}return F()}function Z_(l,{delay:o=0,duration:u=400,easing:m=$0}={}){const g=+getComputedStyle(l).opacity;return{delay:o,duration:u,easing:m,css:b=>`opacity: ${b*g}`}}function $T(l,o,u){const m=l.slice();return m[21]=o[u],m[23]=u,m}function YT(l){let o,u,m,g,b,M,A;function r(){return l[14](l[23])}return{c(){o=on("div"),u=on("div"),u.textContent=`${l[21].text}`,m=Lr(),g=on("div"),b=on("button"),b.textContent="Show Plots",Sn(b,"class","show-plots-button svelte-1vuo2r6"),Sn(g,"class","button-container svelte-1vuo2r6")},m(k,F){Po(k,o,F),Vi(o,u),Vi(o,m),Vi(o,g),Vi(g,b),M||(A=If(b,"click",r),M=!0)},p(k,F){l=k},d(k){k&&hs(o),M=!1,A()}}}function J3(l){let o,u,m,g;return{c(){o=on("div"),o.textContent=`${l[21].text}`,Sn(o,"class","text-section")},m(b,M){Po(b,o,M),g=!0},p:Cs,i(b){g||(b&&da(()=>{g&&(m&&m.end(1),u=uM(o,Z_,{duration:1e3}),u.start())}),g=!0)},o(b){u&&u.invalidate(),b&&(m=hM(o,Z_,{duration:1e3})),g=!1},d(b){b&&hs(o),b&&m&&m.end()}}}function eO(l){let o,u,m,g,b,M,A,r,k,F,N,W,Q,te,ce,de,ve,Te,Ee,Me,Ie,qe,Ve;function nt(){return l[15](l[23])}return r=new v0({props:{dataUrls:l[10],graphType:"accumulated",startDate:l[21].startDate,endDate:l[21].endDate,graphLabel:"Accumulated Cases"}}),Q=new v0({props:{dataUrls:l[10],graphType:"cases",startDate:l[21].startDate,endDate:l[21].endDate,graphLabel:"Monthly Cases Increasement"}}),Te=new v0({props:{dataUrls:l[10],graphType:"accumulatedDeaths",startDate:l[21].startDate,endDate:l[21].endDate,graphLabel:"Accumulated Deaths"}}),{c(){o=on("div"),u=on("div"),m=on("button"),m.textContent="Hide Plots",g=Lr(),b=on("div"),b.textContent="Accumulated Monthly Cases",M=Lr(),A=on("div"),wf(r.$$.fragment),k=Lr(),F=on("div"),F.textContent="Monthly Cases Increasement",N=Lr(),W=on("div"),wf(Q.$$.fragment),te=Lr(),ce=on("div"),ce.textContent="Accumulated Monthly Deaths",de=Lr(),ve=on("div"),wf(Te.$$.fragment),Sn(m,"class","hide-plots-button svelte-1vuo2r6"),Sn(u,"class","button-container svelte-1vuo2r6"),Sn(b,"class","graph-title svelte-1vuo2r6"),Sn(A,"class","graph-container svelte-1vuo2r6"),Sn(F,"class","graph-title svelte-1vuo2r6"),Sn(W,"class","graph-container svelte-1vuo2r6"),Sn(ce,"class","graph-title svelte-1vuo2r6"),Sn(ve,"class","graph-container svelte-1vuo2r6"),Sn(o,"class","graph-section svelte-1vuo2r6")},m(lt,ht){Po(lt,o,ht),Vi(o,u),Vi(u,m),Vi(o,g),Vi(o,b),Vi(o,M),Vi(o,A),lh(r,A,null),Vi(o,k),Vi(o,F),Vi(o,N),Vi(o,W),lh(Q,W,null),Vi(o,te),Vi(o,ce),Vi(o,de),Vi(o,ve),lh(Te,ve,null),Ie=!0,qe||(Ve=If(m,"click",nt),qe=!0)},p(lt,ht){l=lt},i(lt){Ie||(Ps(r.$$.fragment,lt),Ps(Q.$$.fragment,lt),Ps(Te.$$.fragment,lt),lt&&da(()=>{Ie&&(Me&&Me.end(1),Ee=uM(o,Z_,{duration:1e3}),Ee.start())}),Ie=!0)},o(lt){lo(r.$$.fragment,lt),lo(Q.$$.fragment,lt),lo(Te.$$.fragment,lt),Ee&&Ee.invalidate(),lt&&(Me=hM(o,Z_,{duration:1e3})),Ie=!1},d(lt){lt&&hs(o),ch(r),ch(Q),ch(Te),lt&&Me&&Me.end(),qe=!1,Ve()}}}function QT(l){let o,u,m,g,b,M,A=l[21].showButton&&!l[7][l[23]]&&YT(l);const r=[eO,J3],k=[];function F(N,W){return N[21].showGraphs&&N[7][N[23]]?0:N[21].showButton?-1:1}return~(m=F(l))&&(g=k[m]=r[m](l)),{c(){o=on("section"),A&&A.c(),u=Lr(),g&&g.c(),b=Lr(),Sn(o,"class","svelte-1vuo2r6")},m(N,W){Po(N,o,W),A&&A.m(o,null),Vi(o,u),~m&&k[m].m(o,null),Vi(o,b),M=!0},p(N,W){N[21].showButton&&!N[7][N[23]]?A?A.p(N,W):(A=YT(N),A.c(),A.m(o,u)):A&&(A.d(1),A=null);let Q=m;m=F(N),m===Q?~m&&k[m].p(N,W):(g&&(aM(),lo(k[Q],1,1,()=>{k[Q]=null}),lM()),~m?(g=k[m],g?g.p(N,W):(g=k[m]=r[m](N),g.c()),Ps(g,1),g.m(o,b)):g=null)},i(N){M||(Ps(g),M=!0)},o(N){lo(g),M=!1},d(N){N&&hs(o),A&&A.d(),~m&&k[m].d()}}}function tO(l){let o,u,m=Y1(l[9]),g=[];for(let M=0;M<m.length;M+=1)g[M]=QT($T(l,m,M));const b=M=>lo(g[M],1,1,()=>{g[M]=null});return{c(){o=on("div");for(let M=0;M<g.length;M+=1)g[M].c();Sn(o,"class","foreground"),Sn(o,"slot","foreground")},m(M,A){Po(M,o,A);for(let r=0;r<g.length;r+=1)g[r]&&g[r].m(o,null);u=!0},p(M,A){if(A&3712){m=Y1(M[9]);let r;for(r=0;r<m.length;r+=1){const k=$T(M,m,r);g[r]?(g[r].p(k,A),Ps(g[r],1)):(g[r]=QT(k),g[r].c(),Ps(g[r],1),g[r].m(o,null))}for(aM(),r=m.length;r<g.length;r+=1)b(r);lM()}},i(M){if(!u){for(let A=0;A<m.length;A+=1)Ps(g[A]);u=!0}},o(M){g=g.filter(Boolean);for(let A=0;A<g.length;A+=1)lo(g[A]);u=!1},d(M){M&&hs(o),_C(g,M)}}}function iO(l){let o,u,m,g,b,M,A,r,k,F,N,W,Q,te,ce,de,ve,Te,Ee;function Me(st){l[12](st)}let Ie={index:l[4],data2020:l[8]};l[2]!==void 0&&(Ie.geoJsonToFit=l[2]),m=new WC({props:Ie}),ls.push(()=>nf(m,"geoJsonToFit",Me));function qe(st){l[16](st)}function Ve(st){l[17](st)}function nt(st){l[18](st)}function lt(st){l[19](st)}let ht={top:0,bottom:1,threshold:.5,$$slots:{foreground:[tO]},$$scope:{ctx:l}};return l[3]!==void 0&&(ht.count=l[3]),l[4]!==void 0&&(ht.index=l[4]),l[5]!==void 0&&(ht.offset=l[5]),l[6]!==void 0&&(ht.progress=l[6]),te=new FC({props:ht}),ls.push(()=>nf(te,"count",qe)),ls.push(()=>nf(te,"index",Ve)),ls.push(()=>nf(te,"offset",nt)),ls.push(()=>nf(te,"progress",lt)),{c(){o=on("div"),u=on("div"),wf(m.$$.fragment),b=Lr(),M=on("div"),M.textContent="US Mainland",A=Lr(),r=on("div"),r.textContent="Hawaii",k=Lr(),F=on("div"),F.textContent="Alaska",W=Lr(),Q=on("div"),wf(te.$$.fragment),Sn(M,"class","title mainland-title svelte-1vuo2r6"),Sn(r,"class","title hawaii-title svelte-1vuo2r6"),Sn(F,"class","title alaska-title svelte-1vuo2r6"),Sn(u,"class","map-container svelte-1vuo2r6"),da(()=>l[13].call(u)),Sn(Q,"class","sections-container svelte-1vuo2r6"),Sn(o,"class","container svelte-1vuo2r6")},m(st,Ot){Po(st,o,Ot),Vi(o,u),lh(m,u,null),Vi(u,b),Vi(u,M),Vi(u,A),Vi(u,r),Vi(u,k),Vi(u,F),N=vC(u,l[13].bind(u)),Vi(o,W),Vi(o,Q),lh(te,Q,null),Ee=!0},p(st,[Ot]){const oi={};Ot&16&&(oi.index=st[4]),Ot&256&&(oi.data2020=st[8]),!g&&Ot&4&&(g=!0,oi.geoJsonToFit=st[2],ef(()=>g=!1)),m.$set(oi);const ii={};Ot&16777344&&(ii.$$scope={dirty:Ot,ctx:st}),!ce&&Ot&8&&(ce=!0,ii.count=st[3],ef(()=>ce=!1)),!de&&Ot&16&&(de=!0,ii.index=st[4],ef(()=>de=!1)),!ve&&Ot&32&&(ve=!0,ii.offset=st[5],ef(()=>ve=!1)),!Te&&Ot&64&&(Te=!0,ii.progress=st[6],ef(()=>Te=!1)),te.$set(ii)},i(st){Ee||(Ps(m.$$.fragment,st),Ps(te.$$.fragment,st),Ee=!0)},o(st){lo(m.$$.fragment,st),lo(te.$$.fragment,st),Ee=!1},d(st){st&&hs(o),ch(m),N(),ch(te)}}}function nO(l,o,u){let m,g,b,M,A,r,k=[!1,!1,!1,!1,!1],F=[];fetch("public/data/average_cases_per_day_2020.json").then(Ve=>Ve.json()).then(Ve=>{u(8,F=Ve)}),console.log(F);let N={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Point",coordinates:[1,0]}},{type:"Feature",geometry:{type:"Point",coordinates:[0,1]}}]};const W=[{text:"First case of Covid 19 happens on 2020-01-21",showGraphs:!1,showButton:!1},{text:"Year 2020",startDate:"2020-01-01",endDate:"2020-12-31",showGraphs:!0,showButton:!0},{text:"Year 2021",startDate:"2021-01-01",endDate:"2021-12-31",showGraphs:!0,showButton:!0},{text:"Year 2022",startDate:"2022-01-01",endDate:"2022-12-31",showGraphs:!0,showButton:!0},{text:"Things become better after 2023",showGraphs:!1,showButton:!1}],Q=["public/data/us.csv"];function te(Ve){u(7,k[Ve]=!k[Ve],k)}function ce(Ve){N=Ve,u(2,N)}function de(){A=this.clientWidth,r=this.clientHeight,u(0,A),u(1,r)}const ve=Ve=>te(Ve),Te=Ve=>te(Ve);function Ee(Ve){m=Ve,u(3,m)}function Me(Ve){g=Ve,u(4,g)}function Ie(Ve){b=Ve,u(5,b)}function qe(Ve){M=Ve,u(6,M)}return l.$$.update=()=>{l.$$.dirty&7&&X3().fitSize([A,r],N)},[A,r,N,m,g,b,M,k,F,W,Q,te,ce,de,ve,Te,Ee,Me,Ie,qe]}class rO extends X_{constructor(o){super(),Q_(this,o,nO,iO,Y_,{})}}new rO({target:document.getElementById("app")});
